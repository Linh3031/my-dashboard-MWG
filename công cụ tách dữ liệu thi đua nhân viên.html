<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ Tái cấu trúc Dữ liệu BI</title>
    <!-- Tích hợp Tailwind CSS để làm đẹp giao diện -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tùy chỉnh thêm để giao diện thân thiện hơn */
        body {
            font-family: 'Inter', sans-serif;
        }
        .table-container {
            max-height: 70vh; /* Giới hạn chiều cao và cho phép cuộn */
            overflow: auto;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        th, td {
            border: 1px solid #e2e8f0;
            white-space: nowrap; /* Ngăn không cho chữ xuống dòng */
        }
        th {
            position: sticky; /* "Dính" tiêu đề khi cuộn */
            top: 0;
            background-color: #f1f5f9;
            z-index: 10;
        }
        /* Dính cột đầu tiên bên trái khi cuộn ngang */
        td:first-child, th:first-child {
            position: sticky;
            left: 0;
            background-color: #f8fafc;
            z-index: 5;
        }
        th:first-child {
            z-index: 15;
        }
        /* Hiệu ứng thông báo */
        #notification {
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
    <!-- Tích hợp font Inter từ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Công cụ Tái cấu trúc Dữ liệu BI</h1>
            <p class="mt-2 text-slate-600">Dán dữ liệu thô từ BI vào ô bên dưới và công cụ sẽ tự động tạo ma trận dữ liệu cho bạn.</p>
        </header>

        <main>
            <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
                <!-- Khu vực nhập liệu -->
                <div>
                    <label for="rawDataInput" class="block text-lg font-semibold mb-2 text-slate-700">Dữ liệu thô:</label>
                    <textarea id="rawDataInput" rows="10" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Dán toàn bộ dữ liệu bạn đã sao chép từ trang BI vào đây..."></textarea>
                </div>

                <!-- Nút điều khiển -->
                <div class="mt-6 flex flex-col sm:flex-row gap-4">
                    <button id="processButton" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Xử lý & Tạo Bảng
                    </button>
                    <button id="copyButton" class="w-full sm:w-auto bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition shadow-md hidden focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Sao chép Bảng (dán vào Excel)
                    </button>
                     <button id="clearButton" class="w-full sm:w-auto bg-slate-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-slate-600 transition shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">
                        Xóa & Làm lại
                    </button>
                </div>
            </div>

            <!-- Khu vực hiển thị kết quả -->
            <div id="resultContainer" class="mt-8 bg-white rounded-xl shadow-lg border border-slate-200 p-6 hidden">
                <h2 class="text-2xl font-bold mb-4 text-slate-800">Ma trận Dữ liệu</h2>
                <div id="tableWrapper" class="table-container border border-slate-200 rounded-lg">
                    <!-- Bảng dữ liệu sẽ được chèn vào đây bởi JavaScript -->
                </div>
            </div>
             <!-- Vùng trống để hiển thị khi chưa có dữ liệu -->
            <div id="placeholder" class="mt-8 text-center text-slate-500">
                <p>Kết quả sẽ được hiển thị ở đây sau khi xử lý.</p>
            </div>
        </main>
    </div>
    
    <!-- Thông báo nhỏ ở góc màn hình -->
    <div id="notification" class="fixed bottom-5 right-5 bg-slate-900 text-white py-2 px-4 rounded-lg shadow-xl opacity-0 transform translate-y-2">
        Đã sao chép vào clipboard!
    </div>


    <script>
        // Lấy các đối tượng DOM cần thiết
        const rawDataInput = document.getElementById('rawDataInput');
        const processButton = document.getElementById('processButton');
        const copyButton = document.getElementById('copyButton');
        const clearButton = document.getElementById('clearButton');
        const resultContainer = document.getElementById('resultContainer');
        const tableWrapper = document.getElementById('tableWrapper');
        const notification = document.getElementById('notification');
        const placeholder = document.getElementById('placeholder');

        // Gắn sự kiện click cho nút Xử lý
        processButton.addEventListener('click', () => {
            const rawText = rawDataInput.value;
            if (!rawText.trim()) {
                alert('Vui lòng dán dữ liệu vào ô nhập liệu.');
                return;
            }
            parseAndRenderData(rawText);
        });

        // Gắn sự kiện click cho nút Xóa
        clearButton.addEventListener('click', () => {
            rawDataInput.value = '';
            tableWrapper.innerHTML = '';
            resultContainer.classList.add('hidden');
            copyButton.classList.add('hidden');
            placeholder.classList.remove('hidden');
            rawDataInput.focus();
        });


        /**
         * Hàm chính để phân tích dữ liệu thô và hiển thị thành bảng
         * @param {string} rawText - Chuỗi dữ liệu thô từ textarea
         */
        function parseAndRenderData(rawText) {
            const lines = rawText.split('\n').map(line => line.trim()).filter(line => line);

            // --- Bước 1: Trích xuất tiêu đề chính (Ngành hàng) ---
            const mainHeaders = [];
            let startHeaderIndex = lines.findIndex(line => line.includes('Phòng ban'));
            if (startHeaderIndex === -1) {
                alert('Lỗi: Không tìm thấy dòng "Phòng ban". Vui lòng kiểm tra lại dữ liệu đầu vào.');
                return;
            }

            for (let i = startHeaderIndex + 1; i < lines.length; i++) {
                const currentLine = lines[i];
                if (currentLine.startsWith('SLLK') || currentLine.startsWith('DTQĐ')) {
                    break; // Dừng lại khi gặp dòng tiêu đề phụ
                }
                mainHeaders.push(currentLine);
            }
            
            // --- Bước 2: Trích xuất tiêu đề phụ (SLLK, DTQĐ, ...) ---
            // Ghép tất cả các dòng bắt đầu bằng SLLK hoặc DTQĐ lại với nhau
            let subHeaderLine = lines
                .filter(line => line.startsWith('SLLK') || line.startsWith('DTQĐ'))
                .join('\t'); // Dùng tab để nối các dòng
            
            // Tách chuỗi đã ghép thành mảng các tiêu đề phụ
            const subHeaders = subHeaderLine.split(/\s+/); // Tách bằng một hoặc nhiều khoảng trắng


            // --- Bước 3: Trích xuất các dòng dữ liệu của nhân viên/bộ phận ---
            const dataRows = [];
            for (const line of lines) {
                // Một dòng được coi là dòng dữ liệu nếu nó không phải là các dòng tiêu đề/rác
                // và chứa các giá trị được ngăn cách bởi ít nhất 2 khoảng trắng hoặc tab
                const parts = line.split(/\s{2,}|\t/); // Tách bằng 2+ khoảng trắng hoặc tab

                // Kiểm tra xem dòng có phải là dòng dữ liệu hợp lệ không
                // Điều kiện: có ít nhất 2 phần, và phần thứ 2 có vẻ là một con số
                if (parts.length > 1 && /^-?[\d,.]+$/.test(parts[1].trim())) {
                    const name = parts[0];
                    const values = parts.slice(1);
                    dataRows.push({ name, values });
                }
            }
            
            // --- Bước 4: Tạo và hiển thị bảng HTML ---
            if (mainHeaders.length === 0 || dataRows.length === 0) {
                 alert('Không thể xử lý dữ liệu. Vui lòng kiểm tra định dạng dữ liệu đầu vào.');
                 return;
            }

            let tableHTML = '<table class="min-w-full text-sm">';
            
            // Tạo phần đầu của bảng (thead)
            tableHTML += '<thead class="font-semibold text-slate-700">';
            
            // Hàng tiêu đề chính
            tableHTML += '<tr>';
            tableHTML += '<th class="p-3 text-left">Nhân viên / Bộ phận</th>';
            mainHeaders.forEach(header => {
                tableHTML += `<th class="p-3 text-center">${header}</th>`;
            });
            tableHTML += '</tr>';

            // Hàng tiêu đề phụ
            if (subHeaders.length > 0) {
                tableHTML += '<tr>';
                tableHTML += '<th class="p-3"></th>'; // Ô trống đầu tiên
                subHeaders.forEach(subHeader => {
                    tableHTML += `<th class="p-3 text-center">${subHeader}</th>`;
                });
                // Nếu số lượng tiêu đề phụ ít hơn, thêm ô trống
                for(let i=0; i < mainHeaders.length - subHeaders.length; i++){
                    tableHTML += '<th class="p-3"></th>';
                }
                tableHTML += '</tr>';
            }

            tableHTML += '</thead>';

            // Tạo phần thân của bảng (tbody)
            tableHTML += '<tbody class="bg-white">';
            dataRows.forEach(row => {
                tableHTML += '<tr>';
                tableHTML += `<td class="p-3 font-semibold text-slate-800">${row.name}</td>`;
                row.values.forEach(value => {
                    // Căn phải cho các ô số liệu
                    tableHTML += `<td class="p-3 text-right">${value}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';

            // Hiển thị kết quả
            tableWrapper.innerHTML = tableHTML;
            resultContainer.classList.remove('hidden');
            copyButton.classList.remove('hidden');
            placeholder.classList.add('hidden');
        }

        // --- Chức năng sao chép bảng ---
        copyButton.addEventListener('click', () => {
            const table = tableWrapper.querySelector('table');
            if (!table) return;

            // Tạo một range và chọn toàn bộ bảng
            const range = document.createRange();
            range.selectNode(table);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            
            try {
                // Thực hiện lệnh sao chép
                const successful = document.execCommand('copy');
                const msg = successful ? 'Đã sao chép thành công!' : 'Sao chép thất bại.';
                showNotification(msg);
            } catch (err) {
                showNotification('Lỗi khi sao chép!');
                console.error('Lỗi sao chép: ', err);
            }

            // Bỏ chọn sau khi đã sao chép
            window.getSelection().removeAllRanges();
        });

        /**
         * Hiển thị thông báo nhỏ
         * @param {string} message - Nội dung thông báo
         */
        function showNotification(message) {
            notification.textContent = message;
            notification.classList.remove('opacity-0', 'translate-y-2');
            notification.classList.add('opacity-100', 'transform-none');

            setTimeout(() => {
                notification.classList.remove('opacity-100', 'transform-none');
                notification.classList.add('opacity-0', 'translate-y-2');
            }, 2000); // Ẩn sau 2 giây
        }
    </script>

</body>
</html>
