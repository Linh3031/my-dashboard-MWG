--- START FILE: ./.vscode/settings.json ---
{
    "liveServer.settings.port": 5504
}
--- END FILE: ./.vscode/settings.json ---

--- START FILE: ./Firebase.js ---
// Version 1.7 - Add function to get QR code URL from Storage
// MODULE: FIREBASE
// Ch·ªãu tr√°ch nhi·ªám k·∫øt n·ªëi, thi·∫øt l·∫≠p listener v·ªõi Firebase.
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, arrayUnion, serverTimestamp, query, orderBy, setDoc, increment, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
import { appState } from './state.js';
import { ui } from './ui.js';

const firebase = {
    async init() {
       // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyAQ3TWcpa4AnTN-32igGseYDlXrCf1BVew",
          authDomain: "qlst-9e6bd.firebaseapp.com",
          projectId: "qlst-9e6bd",
          storageBucket: "qlst-9e6bd.firebasestorage.app",
          messagingSenderId: "2316705291",
          appId: "1:2316705291:web:ebec2963816aea7585b10e",
          measurementId: "G-M0SM0XHCEK"
        };

        try {
            if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                throw new Error("Th√¥ng tin c·∫•u h√¨nh Firebase ch∆∞a ƒë∆∞·ª£c c·∫≠p nh·∫≠t.");
            }
            const firebaseApp = initializeApp(firebaseConfig);
            appState.auth = getAuth(firebaseApp);
            appState.db = getFirestore(firebaseApp);
            appState.storage = getStorage(firebaseApp);

            console.log("Firebase connected successfully!");
            this.setupListeners();
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            ui.showNotification(error.message || "Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi c∆° s·ªü d·ªØ li·ªáu.", "error");
        }
    },

    setupListeners() {
        if (!appState.db) return;

        const feedbackQuery = query(collection(appState.db, "feedback"), orderBy("timestamp", "desc"));
        onSnapshot(feedbackQuery, (querySnapshot) => {
            appState.feedbackList = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                appState.feedbackList.push({ id: doc.id, ...data, timestamp: data.timestamp?.toDate() });
            });
            if (document.getElementById('home-section')?.classList.contains('hidden') === false) {
                ui.renderFeedbackSection();
            }
        }, (error) => {
            console.error("Error listening to feedback collection: ", error);
            ui.showNotification("L·ªói khi t·∫£i danh s√°ch g√≥p √Ω.", "error");
        });

        const helpContentRef = collection(appState.db, "help_content");
        onSnapshot(helpContentRef, (querySnapshot) => {
             let contentUpdated = false;
            querySnapshot.forEach((doc) => {
                if (appState.helpContent.hasOwnProperty(doc.id)) {
                    appState.helpContent[doc.id] = doc.data().content;
                    contentUpdated = true;
                }
            });
            if (contentUpdated && appState.isAdmin && document.getElementById('declaration-section')?.classList.contains('hidden') === false) {
                ui.renderAdminHelpEditors();
            }
        }, (error) => {
            console.error("Error listening to help_content collection: ", error);
            ui.showNotification("L·ªói khi t·∫£i n·ªôi dung h∆∞·ªõng d·∫´n.", "error");
        });

        const statsRef = doc(appState.db, "analytics", "site_stats");
        onSnapshot(statsRef, (docSnap) => {
            if (docSnap.exists()) {
                const statsData = docSnap.data();
                ui.updateUsageCounter(statsData);
            } else {
                console.log("Kh√¥ng t√¨m th·∫•y document th·ªëng k√™.");
            }
        });
    },

    async incrementCounter(fieldName) {
        if (!appState.db || !fieldName) return;
        const statsRef = doc(appState.db, "analytics", "site_stats");
        try {
            await setDoc(statsRef, { [fieldName]: increment(1) }, { merge: true });
        } catch (error) {
            console.error(`L·ªói khi tƒÉng b·ªô ƒë·∫øm cho '${fieldName}':`, error);
        }
    },

    async submitFeedback(content) {
        if (!content || !appState.db || !appState.currentUser) {
             ui.showNotification("Kh√¥ng th·ªÉ g·ª≠i g√≥p √Ω: Ng∆∞·ªùi d√πng ch∆∞a ƒë∆∞·ª£c x√°c th·ª±c.", "error");
            return;
        }
        try {
            await addDoc(collection(appState.db, "feedback"), {
                user: {
                    uid: appState.currentUser.uid,
                    isAnonymous: appState.currentUser.isAnonymous,
                },
                content: content,
                timestamp: serverTimestamp(),
                replies: []
            });
            ui.showNotification("G√≥p √Ω c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i!", "success");
            return true;
        } catch (error) {
            console.error("Error adding feedback: ", error);
            ui.showNotification("L·ªói khi g·ª≠i g√≥p √Ω.", "error");
            return false;
        }
    },

    async submitReply(docId, content) {
        if (!docId || !content || !appState.db) return false;
        try {
            const feedbackRef = doc(appState.db, "feedback", docId);
            await updateDoc(feedbackRef, {
                replies: arrayUnion({
                    content: content,
                    timestamp: new Date()
                })
            });
            return true;
        } catch (error) {
            console.error("Error submitting reply:", error);
            ui.showNotification("L·ªói khi g·ª≠i tr·∫£ l·ªùi.", "error");
            return false;
        }
    },

    async saveHelpContent(contents) {
        if (!appState.db || !appState.isAdmin) return;
        ui.showNotification('ƒêang l∆∞u n·ªôi dung h∆∞·ªõng d·∫´n...', 'success');
        try {
            await Promise.all([
                setDoc(doc(appState.db, "help_content", "data"), { content: contents.data }),
                setDoc(doc(appState.db, "help_content", "luyke"), { content: contents.luyke }),
                setDoc(doc(appState.db, "help_content", "sknv"), { content: contents.sknv }),
                setDoc(doc(appState.db, "help_content", "realtime"), { content: contents.realtime })
            ]);
            ui.showNotification('ƒê√£ c·∫≠p nh·∫≠t n·ªôi dung h∆∞·ªõng d·∫´n th√†nh c√¥ng!', 'success');
        } catch (error) {
            console.error("Error saving help content:", error);
            ui.showNotification('L·ªói khi l∆∞u n·ªôi dung.', 'error');
        }
    },

    async saveCategoryDataToFirestore(data) {
        if (!appState.db || !appState.isAdmin) return;
        ui.showNotification('ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu khai b√°o l√™n cloud...', 'success');
        try {
            const categoryRef = doc(appState.db, "declarations", "categoryStructure");
            await setDoc(categoryRef, { data: data.categories || [] });

            const brandRef = doc(appState.db, "declarations", "brandList");
            await setDoc(brandRef, { data: data.brands || [] });

            ui.showNotification('ƒê·ªìng b·ªô d·ªØ li·ªáu khai b√°o th√†nh c√¥ng!', 'success');
        } catch (error) {
            console.error("L·ªói khi l∆∞u d·ªØ li·ªáu khai b√°o l√™n Firestore:", error);
            ui.showNotification('L·ªói khi ƒë·ªìng b·ªô d·ªØ li·ªáu l√™n cloud.', 'error');
        }
    },

    async loadCategoryDataFromFirestore() {
        if (!appState.db) return { categories: [], brands: [] };
        try {
            const declarationsCollection = collection(appState.db, "declarations");
            const querySnapshot = await getDocs(declarationsCollection);

            let categories = [];
            let brands = [];

            querySnapshot.forEach((doc) => {
                if (doc.id === "categoryStructure") {
                    categories = doc.data().data || [];
                } else if (doc.id === "brandList") {
                    brands = doc.data().data || [];
                }
            });

            console.log(`Loaded ${categories.length} categories and ${brands.length} brands from Firestore.`);
            return { categories, brands };
        } catch (error) {
            console.error("L·ªói khi t·∫£i d·ªØ li·ªáu khai b√°o t·ª´ Firestore:", error);
            ui.showNotification('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ng√†nh h√†ng t·ª´ cloud.', 'error');
            return { categories: [], brands: [] };
        }
    },

    // --- START: C√ÅC H√ÄM M·ªöI ƒê·ªÇ QU·∫¢N L√ù D·ªÆ LI·ªÜU KHAI B√ÅO T√çNH TO√ÅN ---
    async loadDeclarationsFromFirestore() {
        if (!appState.db) return {};
        console.log("Loading calculation declarations from Firestore...");
        try {
            const declarationIds = ['hinhThucXuat', 'hinhThucXuatGop', 'heSoQuyDoi'];
            const declarations = {};
            for (const id of declarationIds) {
                const docRef = doc(appState.db, "declarations", id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    // D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u d∆∞·ªõi d·∫°ng m·ªôt chu·ªói d√†i, ph√¢n t√°ch b·∫±ng \n
                    declarations[id] = docSnap.data().content || '';
                } else {
                    declarations[id] = '';
                }
            }
            console.log("Successfully loaded calculation declarations.");
            return declarations;
        } catch (error) {
            console.error("L·ªói khi t·∫£i d·ªØ li·ªáu khai b√°o t√≠nh to√°n t·ª´ Firestore:", error);
            ui.showNotification('L·ªói: Kh√¥ng th·ªÉ t·∫£i c√°c khai b√°o t√≠nh to√°n t·ª´ cloud.', 'error');
            return {};
        }
    },

    async saveDeclarationsToFirestore(declarations) {
        if (!appState.db || !appState.isAdmin) return;
        ui.showNotification('ƒêang ƒë·ªìng b·ªô khai b√°o t√≠nh to√°n l√™n cloud...', 'success');
        try {
            await Promise.all([
                setDoc(doc(appState.db, "declarations", "hinhThucXuat"), { content: declarations.ycx }),
                setDoc(doc(appState.db, "declarations", "hinhThucXuatGop"), { content: declarations.ycxGop }),
                 setDoc(doc(appState.db, "declarations", "heSoQuyDoi"), { content: declarations.heSo })
            ]);
            ui.showNotification('ƒê·ªìng b·ªô khai b√°o t√≠nh to√°n th√†nh c√¥ng!', 'success');
        } catch (error) {
            console.error("L·ªói khi l∆∞u d·ªØ li·ªáu khai b√°o t√≠nh to√°n:", error);
            ui.showNotification('L·ªói khi ƒë·ªìng b·ªô khai b√°o t√≠nh to√°n.', 'error');
        }
    },
    // --- END: C√ÅC H√ÄM M·ªöI ---

    async getTemplateDownloadURL() {
        if (!appState.storage) {
            throw new Error("Firebase Storage ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o.");
        }
        const filePath = 'templates/danh_sach_nhan_vien_mau.xlsx';
        const storageRef = ref(appState.storage, filePath);
        try {
            const url = await getDownloadURL(storageRef);
            return url;
        } catch (error) {
            console.error("L·ªói khi l·∫•y URL t·∫£i file m·∫´u: ", error);
            throw error;
        }
    },

    async getBookmarkDownloadURL() {
        if (!appState.storage) {
            throw new Error("Firebase Storage ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o.");
        }
        const filePath = 'templates/Share_QLST.zip';
        const storageRef = ref(appState.storage, filePath);

        try {
            const url = await getDownloadURL(storageRef);
            return url;
        } catch (error) {
            console.error("L·ªói khi l·∫•y URL t·∫£i file bookmark: ", error);
            throw error;
        }
    },

    // === START: H√ÄM M·ªöI ƒê·ªÇ L·∫§Y URL M√É QR ===
    async getQrCodeDownloadURL() {
        if (!appState.storage) {
            throw new Error("Firebase Storage ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o.");
        }
        // --- L∆ØU √ù: File ·∫£nh QR c·ªßa b·∫°n PH·∫¢I ƒë∆∞·ª£c t·∫£i l√™n ƒë√∫ng ƒë∆∞·ªùng d·∫´n n√†y ---
        const filePath = 'qrcodes/main-qr.jpg'; 
        const storageRef = ref(appState.storage, filePath);
        try {
            const url = await getDownloadURL(storageRef);
            return url;
        } catch (error) {
            console.error("L·ªói khi l·∫•y URL c·ªßa m√£ QR: ", error);
            // X·ª≠ l√Ω l·ªói c·ª• th·ªÉ khi kh√¥ng t√¨m th·∫•y file
            if (error.code === 'storage/object-not-found') {
                throw new Error(`Kh√¥ng t√¨m th·∫•y file m√£ QR t·∫°i ƒë∆∞·ªùng d·∫´n '${filePath}'. Vui l√≤ng ki·ªÉm tra l·∫°i Firebase Storage.`);
            }
            throw new Error("Kh√¥ng th·ªÉ t·∫£i ƒë∆∞·ª£c m√£ QR t·ª´ server.");
        }
    }
    // === END: H√ÄM M·ªöI ===
};

export { firebase };
--- END FILE: ./Firebase.js ---

--- START FILE: ./auth.js ---
// Version 1.1 - Add totalUsers counter on new user creation
// MODULE: AUTH
// Ch·ªãu tr√°ch nhi·ªám x·ª≠ l√Ω t·∫•t c·∫£ logic li√™n quan ƒë·∫øn x√°c th·ª±c ng∆∞·ªùi d√πng.

import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
// === START: TH√äM IMPORT M·ªöI ===
import { doc, setDoc, serverTimestamp, getDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
// === END: TH√äM IMPORT M·ªöI ===
import { appState } from './state.js';

export const auth = {
    /**
     * Kh·ªüi t·∫°o module x√°c th·ª±c.
     * Thi·∫øt l·∫≠p m·ªôt listener ƒë·ªÉ theo d√µi tr·∫°ng th√°i ƒëƒÉng nh·∫≠p v√† t·ª± ƒë·ªông ƒëƒÉng nh·∫≠p ·∫©n danh n·∫øu c·∫ßn.
     */
    init() {
        const authInstance = getAuth();
        
        onAuthStateChanged(authInstance, (user) => {
            if (user) {
                appState.currentUser = user;
                console.log("Ng∆∞·ªùi d√πng ƒë√£ x√°c th·ª±c v·ªõi UID:", user.uid);
                
                // T·∫°o m·ªôt b·∫£n ghi trong Firestore cho ng∆∞·ªùi d√πng n√†y n·∫øu ch∆∞a c√≥
                this.createUserRecord(user);
            } else {
                console.log("Ch∆∞a c√≥ ng∆∞·ªùi d√πng, ƒëang ti·∫øn h√†nh ƒëƒÉng nh·∫≠p ·∫©n danh...");
                signInAnonymously(authInstance).catch((error) => {
                    console.error("L·ªói ƒëƒÉng nh·∫≠p ·∫©n danh:", error);
                });
            }
        });
    },

    /**
     * T·∫°o m·ªôt b·∫£n ghi trong collection 'users' V√Ä tƒÉng b·ªô ƒë·∫øm ng∆∞·ªùi d√πng.
     * Ch·ªâ th·ª±c hi·ªán n·∫øu b·∫£n ghi ng∆∞·ªùi d√πng ch∆∞a t·ªìn t·∫°i.
     * @param {object} user - ƒê·ªëi t∆∞·ª£ng user tr·∫£ v·ªÅ t·ª´ Firebase Auth.
     */
    async createUserRecord(user) {
        if (!appState.db || !user) return;

        const userRef = doc(appState.db, "users", user.uid);

        try {
            const userDoc = await getDoc(userRef);

            // === START: LOGIC M·ªöI - CH·ªà TH·ª∞C HI·ªÜN KHI L√Ä NG∆Ø·ªúI D√ôNG M·ªöI ===
            if (!userDoc.exists()) {
                console.log(`Ph√°t hi·ªán ng∆∞·ªùi d√πng m·ªõi (${user.uid}). ƒêang t·∫°o h·ªì s∆° v√† c·∫≠p nh·∫≠t b·ªô ƒë·∫øm...`);
                
                // 1. T·∫°o h·ªì s∆° ng∆∞·ªùi d√πng
                const userData = {
                    uid: user.uid,
                    email: user.email || null,
                    createdAt: serverTimestamp(),
                    role: 'free_user'
                };
                await setDoc(userRef, userData);

                // 2. TƒÉng b·ªô ƒë·∫øm t·ªïng s·ªë ng∆∞·ªùi d√πng
                const statsRef = doc(appState.db, "analytics", "site_stats");
                await setDoc(statsRef, {
                    totalUsers: increment(1)
                }, { merge: true });
                
                console.log("-> ƒê√£ tƒÉng b·ªô ƒë·∫øm totalUsers.");
            }
            // === END: LOGIC M·ªöI ===
        } catch (error) {
            console.error("L·ªói khi ki·ªÉm tra ho·∫∑c t·∫°o b·∫£n ghi ng∆∞·ªùi d√πng:", error);
        }
    }
};
--- END FILE: ./auth.js ---

--- START FILE: ./changelog.json ---
[
   {
    "version": "3.5",
    "date": "23/10/2025",
    "notes": [
      "N√¢ng c·∫•p giao di·ªán tab SKNV cho ƒë·∫πp h∆°n"
    ]
  },  
   {
    "version": "3.4",
    "date": "17/10/2025",
    "notes": [
      "C√≥ th·ªÉ b·∫•m tr·ª±c ti·∫øp t√™n nh√¢n vi√™n ƒë·ªÉ xem chi ti·∫øt",
      "Th√™m icon v√†o menu cho sinh ƒë·ªông"
    ]
  },  
  {
    "version": "3.3",
    "date": "13/10/2025",
    "notes": [
      "Th√™m ch·ª©c nƒÉng t√πy ch·ªânh c·ªôt cho tab Hi·ªáu qu·∫£ khai th√°c nh√¢n vi√™n : c√≥ th·ªÉ ch·ªçn ·∫©n ho·∫∑c hi·ªán c·ªôt d·ªØ li·ªáu kh√¥ng li√™n quan ƒë·∫øn TGDD",
      "Cho ph√©p k√©o th·∫£ ƒë·ªÉ s·∫Øp x·∫øp c√°c c·ªôt trong b·∫£ng k·∫øt qu·∫£ hi·ªáu qu·∫£ khai th√°c nh√¢n vi√™n"
    ]
  },  
   {
    "version": "3.2",
    "date": "10/10/2025",
    "notes": [
      "Th√™m b·ªô l·ªçc ( h√¨nh rƒÉng c∆∞a ) v√†o 3 b·∫£ng Hi·ªáu qu·∫£ khai th√°c, Nh√≥m h√†ng quy ƒë·ªïi cao, Ng√†nh h√†ng chi ti·∫øt trong Si√™u th·ªã l≈©y k·∫ø v√† realtime",
      "S·ª≠a l·∫°i giao di·ªán khu v·ª±c c·∫≠p nh·∫≠t d·ªØ li·ªáu cho g·ªçn h∆°n"
    ]
  },  
  {
    "version": "3.1",
    "date": "09/10/2025",
    "notes": [
      "Th√™m 2 th·∫ª KPI m·ªõi cho tab si√™u th·ªã l≈©y k·∫ø",
      "Th√™m ch·ª©c nƒÉng c√†i ƒë·∫∑t m√†u ch·ªØ th·∫ª KPI trong c√†i ƒë·∫∑t giao di·ªán"
    ]
  },  
   {
    "version": "3.0",
    "date": "06/10/2025",
    "notes": [
      "N√¢ng c·∫•p t√≠nh nƒÉng t·∫°o ch∆∞∆°ng tr√¨nh thi ƒëua v√† theo d√µi hi·ªáu qu·∫£ thi ƒëua : C√≥ th·ªÉ theo d√µi c√πng l√∫c nhi·ªÅu h√£ng trong c√πng 1 nh√≥m h√†ng.",
      "N√¢ng c·∫•p t√≠nh nƒÉng nh·∫≠n x√©t:cho ph√©p t·∫°o nh·∫≠n x√©t cho nhi·ªÅu tab ph·ª•.",
      "N√¢ng c·∫•p t√≠nh nƒÉng nh·∫≠n x√©t: Th√™m b·ªô l·ªçc t·∫•t c·∫£ nh√¢n vi√™n d∆∞·ªõi m·ª•c ti√™u khai b√°o"
    ]
  },  
  {
    "version": "2.8",
    "date": "01/10/2025",
    "notes": [
      "Th√™m t√≠nh nƒÉng t·∫°o ch∆∞∆°ng tr√¨nh thi ƒëua v√† theo d√µi hi·ªáu qu·∫£ thi ƒëua."
    ]
  },
    {
    "version": "2.7",
    "date": "26/09/2025",
    "notes": [
      "Th√™m t√≠nh nƒÉng th√¥ng b√°o c√≥ phi√™n b·∫£n m·ªõi.",
      "Th√™m t√≠nh nƒÉng video h∆∞·ªõng d·∫´n ngo√†i trang ch·ªß.",
      "Th√™m b·ªô ƒë·∫øm l∆∞·ª£t truy c·∫≠p v√† s·ª≠ d·ª•ng."
    ]
  },
{
    "version": "2.6",
    "date": "25/09/2025",
    "notes": [
      "S·ª≠a l·ªói t√≠nh nƒÉng s·∫Øp x·∫øp tr√™n t·∫•t c·∫£ c√°c b·∫£ng.",
      "Ph·ª•c h·ªìi b√°o c√°o 'Thi ƒëua NV' v√† 'Hi·ªáu qu·∫£ khai th√°c LK'.",
      "S·ª≠a l·ªói 'Thi·∫øt l·∫≠p m·ª•c ti√™u' c·∫≠p nh·∫≠t kh√¥ng t·ª©c th·ªùi.",
      "S·ª≠a l·ªói b·ªô l·ªçc n√¢ng cao kh√¥ng hi·ªÉn th·ªã d·ªØ li·ªáu."
    ]
  },
  {
    "version": "2.5",
    "date": "24/09/2025",
    "notes": [
      "Th√™m t√≠nh nƒÉng x·ª≠ l√Ω file thi ƒëua theo v√πng trong 'S·ª©c kh·ªèe si√™u th·ªã.",
      "N√¢ng c·∫•p t√≠nh nƒÉng 'Nh·∫≠n x√©t' : th√™m icon, th√™m c√°c th·∫ª t√πy ch·ªçn"
    ]
  },
    {
    "version": "2.2",
    "date": "23/09/2025",
    "notes": [
      "S·ª≠a l·ªói nghi√™m tr·ªçng: T√≠nh to√°n sai gi√° tr·ªã doanh thu sau khi c·∫≠p nh·∫≠t b·ªô l·ªçc.",
      "C·∫•u tr√∫c l·∫°i h·ªá th·ªëng qu·∫£n l√Ω phi√™n b·∫£n v√† l·ªãch s·ª≠ c·∫≠p nh·∫≠t."
    ]
  },
  {
    "version": "2.1",
    "date": "23/09/2025",
    "notes": [
      "S·ª≠a l·ªói b·ªô l·ªçc n√¢ng cao kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ch·ªçn.",
      "S·ª≠a l·ªói t√¥ m√†u ti√™u ƒë·ªÅ b·∫£ng kh√¥ng ho·∫°t ƒë·ªông do sai CSS Selector."
    ]
  },
  {
    "version": "2.0",
    "date": "16/09/2025",
    "notes": [
      "Phi√™n b·∫£n ph√°t h√†nh ƒë·∫ßu ti√™n.",
      "Bao g·ªìm c√°c ch·ª©c nƒÉng c·ªët l√µi: SKNV, SKST L≈©y k·∫ø, Doanh thu Realtime."
    ]
  }
]
--- END FILE: ./changelog.json ---

--- START FILE: ./components/drawer-goal.js ---
// Version 1.0 - Component: Goal Drawer
// Ch·ª©a m√£ HTML cho drawer thi·∫øt l·∫≠p m·ª•c ti√™u.

const drawerGoalHTML = `
<div id="goal-drawer" class="settings-drawer fixed top-0 left-0 h-full bg-white shadow-2xl z-50 p-6 overflow-y-auto hidden">
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800">Thi·∫øt l·∫≠p m·ª•c ti√™u</h3>
        <button class="close-drawer-btn text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
    </div>
    
    <div class="border-b border-gray-200 mb-4">
        <nav id="goal-drawer-tabs" class="-mb-px flex space-x-6" aria-label="Tabs" data-content-container="goal-drawer-content">
             <button class="sub-tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="goal-tab-monthly">M·ª•c ti√™u Th√°ng (L≈©y k·∫ø)</button>
             <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="goal-tab-daily">M·ª•c ti√™u Ng√†y (Realtime)</button>
        </nav>
    </div>

    <div id="goal-drawer-content">
        <div id="goal-tab-monthly" class="sub-tab-content space-y-4">
            <div>
                <label for="luyke-goal-warehouse-select" class="block text-sm font-medium text-gray-700 mb-1">Thi·∫øt l·∫≠p cho kho</label>
                <select id="luyke-goal-warehouse-select" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-2 gap-x-4 gap-y-3">
                <div>
                    <label for="luyke-goal-dtt" class="block text-sm font-medium text-gray-700">Target DT Th·ª±c</label>
                    <input type="number" id="luyke-goal-dtt" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="doanhThuThuc">
                </div>
                <div>
                    <label for="luyke-goal-dtqd" class="block text-sm font-medium text-gray-700">Target DT Qƒê</label>
                    <input type="number" id="luyke-goal-dtqd" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="doanhThuQD">
                </div>
                <div>
                    <label for="luyke-goal-ptqd" class="block text-sm font-medium text-gray-700">% Quy ƒë·ªïi</label>
                    <input type="number" id="luyke-goal-ptqd" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramQD">
                </div>
                <div>
                    <label for="luyke-goal-pttc" class="block text-sm font-medium text-gray-700">% Tr·∫£ ch·∫≠m</label>
                    <input type="number" id="luyke-goal-pttc" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramTC">
                </div>
                <div>
                    <label for="luyke-goal-giadung" class="block text-sm font-medium text-gray-700">% Gia d·ª•ng</label>
                    <input type="number" id="luyke-goal-giadung" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramGiaDung">
                </div>
                <div>
                    <label for="luyke-goal-mln" class="block text-sm font-medium text-gray-700">% MLN</label>
                    <input type="number" id="luyke-goal-mln" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramMLN">
                </div>
                <div>
                    <label for="luyke-goal-phukien" class="block text-sm font-medium text-gray-700">% Ph·ª• ki·ªán</label>
                    <input type="number" id="luyke-goal-phukien" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramPhuKien">
                </div>
                 <div>
                    <label for="luyke-goal-baohiem" class="block text-sm font-medium text-gray-700">% B·∫£o hi·ªÉm</label>
                    <input type="number" id="luyke-goal-baohiem" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramBaoHiem">
                </div>
                <div>
                    <label for="luyke-goal-sim" class="block text-sm font-medium text-gray-700">% Sim</label>
                    <input type="number" id="luyke-goal-sim" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramSim">
                </div>
                <div>
                    <label for="luyke-goal-vas" class="block text-sm font-medium text-gray-700">% VAS</label>
                    <input type="number" id="luyke-goal-vas" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramVAS">
                </div>
            </div>
        </div>
        <div id="goal-tab-daily" class="sub-tab-content hidden space-y-4">
            <div>
                <label for="rt-goal-warehouse-select" class="block text-sm font-medium text-gray-700 mb-1">Thi·∫øt l·∫≠p cho kho</label>
                <select id="rt-goal-warehouse-select" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select>
            </div>
            <div class="grid grid-cols-2 gap-4 items-end">
                <div class="flex items-center gap-x-2">
                    <label for="rt-open-hour" class="font-medium text-gray-700 text-sm">M·ªü c·ª≠a:</label>
                    <input type="time" id="rt-open-hour" class="rt-setting-input p-1 border border-gray-300 rounded-md shadow-sm w-24">
                </div>
                <div class="flex items-center gap-x-2">
                    <label for="rt-close-hour" class="font-medium text-gray-700 text-sm">ƒê√≥ng c·ª≠a:</label>
                    <input type="time" id="rt-close-hour" class="rt-setting-input p-1 border border-gray-300 rounded-md shadow-sm w-24">
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-2 gap-x-4 gap-y-3">
                <div>
                    <label for="rt-goal-dtt" class="block text-sm font-medium text-gray-700">DT Th·ª±c (tri·ªáu)</label>
                    <input type="number" id="rt-goal-dtt" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="doanhThuThuc">
                </div>
                <div>
                    <label for="rt-goal-dtqd" class="block text-sm font-medium text-gray-700">DT Qƒê (tri·ªáu)</label>
                    <input type="number" id="rt-goal-dtqd" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="doanhThuQD">
                </div>
                <div>
                    <label for="rt-goal-ptqd" class="block text-sm font-medium text-gray-700">% Quy ƒë·ªïi</label>
                    <input type="number" id="rt-goal-ptqd" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramQD">
                </div>
                <div>
                    <label for="rt-goal-pttc" class="block text-sm font-medium text-gray-700">% Tr·∫£ ch·∫≠m</label>
                    <input type="number" id="rt-goal-pttc" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramTC">
                </div>
                <div>
                    <label for="rt-goal-giadung" class="block text-sm font-medium text-gray-700">% Gia d·ª•ng</label>
                    <input type="number" id="rt-goal-giadung" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramGiaDung">
                </div>
                <div>
                    <label for="rt-goal-mln" class="block text-sm font-medium text-gray-700">% MLN</label>
                    <input type="number" id="rt-goal-mln" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramMLN">
                </div>
                <div>
                    <label for="rt-goal-phukien" class="block text-sm font-medium text-gray-700">% Ph·ª• ki·ªán</label>
                    <input type="number" id="rt-goal-phukien" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramPhuKien">
                </div>
                <div>
                    <label for="rt-goal-sim" class="block text-sm font-medium text-gray-700">% Sim</label>
                    <input type="number" id="rt-goal-sim" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramSim">
                </div>
                <div>
                    <label for="rt-goal-vas" class="block text-sm font-medium text-gray-700">% VAS</label>
                    <input type="number" id="rt-goal-vas" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramVAS">
                </div>
                 <div>
                    <label for="rt-goal-baohiem" class="block text-sm font-medium text-gray-700">% B·∫£o hi·ªÉm</label>
                    <input type="number" id="rt-goal-baohiem" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramBaoHiem">
                </div>
            </div>
        </div>
    </div>

    <div class="border-t pt-6 mt-6">
         <div id="goal-tab-competition" class="space-y-4">
            <h4 class="text-md font-bold text-gray-800 mb-3">Qu·∫£n l√Ω Ch∆∞∆°ng tr√¨nh Thi ƒëua</h4>
            <div id="competition-list-container" class="space-y-2 mb-4">
            </div>
            <form id="competition-form" class="p-4 bg-slate-50 border rounded-lg space-y-3 hidden">
                <input type="hidden" id="competition-id">
                <div>
                    <label for="competition-name" class="block text-sm font-medium text-gray-700">T√™n ch∆∞∆°ng tr√¨nh</label>
                    <input type="text" id="competition-name" class="mt-1 block w-full p-2 border rounded-md" placeholder="VD: Thi ƒëua TV Sony T9">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="competition-brand" class="block text-sm font-medium text-gray-700">H√£ng s·∫£n xu·∫•t</label>
                        <select id="competition-brand" multiple class="mt-1 block w-full"></select>
                    </div>
                    <div>
                        <label for="competition-group" class="block text-sm font-medium text-gray-700">Nh√≥m h√†ng</label>
                        <select id="competition-group" multiple class="mt-1 block w-full"></select>
                    </div>
                </div>
                <div>
                    <label for="competition-type" class="block text-sm font-medium text-gray-700">Lo·∫°i ƒëo l∆∞·ªùng</label>
                    <select id="competition-type" class="mt-1 block w-full p-2 border rounded-md">
                        <option value="doanhthu">Theo Doanh thu</option>
                        <option value="soluong">Theo S·ªë l∆∞·ª£ng</option>
                    </select>
                </div>
                <div id="price-segment" class="hidden grid grid-cols-2 gap-4">
                    <div>
                        <label for="competition-min-price" class="block text-sm font-medium text-gray-700">Gi√° t·ª´ (tri·ªáu)</label>
                        <input type="number" id="competition-min-price" class="mt-1 block w-full p-2 border rounded-md" placeholder="VD: 3 (cho 3 tri·ªáu)">
                    </div>
                     <div>
                        <label for="competition-max-price" class="block text-sm font-medium text-gray-700">Gi√° ƒë·∫øn (tri·ªáu)</label>
                        <input type="number" id="competition-max-price" class="mt-1 block w-full p-2 border rounded-md" placeholder="VD: 5 (cho 5 tri·ªáu)">
                    </div>
                </div>
                <div class="flex items-center">
                    <input id="competition-exclude-apple" type="checkbox" class="h-4 w-4 rounded border-gray-300">
                    <label for="competition-exclude-apple" class="ml-2 block text-sm text-gray-900">Tr·ª´ h√£ng Apple kh·ªèi d·ªØ li·ªáu so s√°nh</label>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="cancel-competition-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">H·ªßy</button>
                    <button type="submit" id="save-competition-btn" class="px-4 py-2 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700">L∆∞u</button>
                </div>
            </form>
            <button id="add-competition-btn" class="mt-2 w-full text-sm py-2 px-4 border-2 border-dashed rounded-lg hover:bg-slate-50">
                + Th√™m ch∆∞∆°ng tr√¨nh m·ªõi
            </button>
        </div>
    </div>
</div>
`;

export const drawerGoal = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = drawerGoalHTML;
        }
    }
};
--- END FILE: ./components/drawer-goal.js ---

--- START FILE: ./components/drawer-interface.js ---
// Version 1.1 - Update font size slider range and default value
// Ch·ª©a m√£ HTML cho drawer c√†i ƒë·∫∑t giao di·ªán.

const drawerInterfaceHTML = `
<div id="interface-drawer" class="settings-drawer fixed top-0 left-0 h-full bg-white shadow-2xl z-50 p-6 overflow-y-auto hidden">
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800">C√†i ƒë·∫∑t giao di·ªán</h3>
        <button class="close-drawer-btn text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
    </div>
    <div class="space-y-6">
        <div>
            <label for="contrast-selector-drawer" class="block text-sm font-medium text-gray-700 mb-2">ƒê·ªô t∆∞∆°ng ph·∫£n</label>
            <select id="contrast-selector-drawer" class="contrast-selector w-full p-2 border rounded-lg text-sm bg-white shadow-sm">
                <option value="1">R·∫•t nh·∫π</option>
                <option value="2">Nh·∫π</option>
                <option value="3" selected>B√¨nh th∆∞·ªùng</option>
                <option value="4">Cao</option>
                <option value="5">R·∫•t cao</option>
                <option value="6">Cao nh·∫•t</option>
            </select>
        </div>
        <div>
            <label for="global-font-size-slider" class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                <span>C·ª° ch·ªØ to√†n trang</span>
                <span id="global-font-size-value" class="font-bold text-blue-600">18px</span>
            </label>
            <input type="range" id="global-font-size-slider" min="12" max="25" step="1" value="18" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
        </div>
        <div>
             <label for="kpi-font-size-slider" class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                <span>C·ª° ch·ªØ th·∫ª KPI</span>
                <span id="kpi-font-size-value" class="font-bold text-blue-600">36px</span>
            </label>
            <input type="range" id="kpi-font-size-slider" min="24" max="48" step="2" value="36" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
        </div>
        <div>
            <h4 class="text-sm font-medium text-gray-700 mb-2">M√†u s·∫Øc th·∫ª KPI</h4>
            <div class="grid grid-cols-2 gap-4">
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-1" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#38bdf8">
                    <label for="kpi-color-1" class="text-sm">Th·∫ª 1</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-2" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#34d399">
                    <label for="kpi-color-2" class="text-sm">Th·∫ª 2</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-3" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#fbbf24">
                    <label for="kpi-color-3" class="text-sm">Th·∫ª 3</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-4" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#2dd4bf">
                    <label for="kpi-color-4" class="text-sm">Th·∫ª 4</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-5" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#a78bfa">
                    <label for="kpi-color-5" class="text-sm">Th·∫ª 5</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-6" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#f472b6">
                    <label for="kpi-color-6" class="text-sm">Th·∫ª 6</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-7" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#818cf8">
                    <label for="kpi-color-7" class="text-sm">Th·∫ª 7</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-8" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#f87171">
                    <label for="kpi-color-8" class="text-sm">Th·∫ª 8</label>
                </div>
            </div>
        </div>
         <div>
            <h4 class="text-sm font-medium text-gray-700 mb-2">M√†u ch·ªØ th·∫ª KPI</h4>
             <div class="space-y-2">
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-title-color" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#ffffff">
                    <label for="kpi-title-color" class="text-sm">Ti√™u ƒë·ªÅ th·∫ª</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-main-color" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#ffffff">
                    <label for="kpi-main-color" class="text-sm">Gi√° tr·ªã ch√≠nh</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-sub-color" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#ffffff">
                    <label for="kpi-sub-color" class="text-sm">Gi√° tr·ªã ph·ª•</label>
                </div>
            </div>
        </div>
    </div>
</div>
`;

export const drawerInterface = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = drawerInterfaceHTML;
        }
    }
};
--- END FILE: ./components/drawer-interface.js ---

--- START FILE: ./components/modal-admin.js ---
// Version 1.0 - Component: Admin Modal
// Ch·ª©a m√£ HTML cho modal y√™u c·∫ßu m·∫≠t kh·∫©u admin.

const modalAdminHTML = `
<div id="admin-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-4">
        <h3 class="text-lg font-bold mb-4">Truy c·∫≠p khu v·ª±c Admin</h3>
        <p class="text-sm text-gray-600 mb-4">Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ xem v√† ch·ªânh s·ª≠a ph·∫ßn Khai b√°o.</p>
        <input type="password" id="admin-password-input" class="w-full p-2 border rounded-lg mb-2" placeholder="M·∫≠t kh·∫©u...">
        <p id="admin-error-msg" class="text-red-500 text-sm mb-4 hidden">M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng. Vui l√≤ng th·ª≠ l·∫°i.</p>
        <div class="flex justify-end space-x-3">
            <button id="admin-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">H·ªßy</button>
            <button id="admin-submit-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">X√°c nh·∫≠n</button>
        </div>
    </div>
</div>
`;

export const modalAdmin = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalAdminHTML;
        }
    }
};
--- END FILE: ./components/modal-admin.js ---

--- START FILE: ./components/modal-chart.js ---
// Version 1.0 - Component: Chart Modal
// Ch·ª©a m√£ HTML cho modal hi·ªÉn th·ªã bi·ªÉu ƒë·ªì chi ti·∫øt.

const modalChartHTML = `
<div id="chart-modal" class="modal hidden">
    <div class="modal__overlay" data-close-modal></div>
    <div class="modal__container modal__container--large">
         <div class="modal__header">
            <h3 id="chart-modal-title" class="modal__title"></h3>
            <button class="modal__close-btn" data-close-modal>&times;</button>
        </div>
        <div class="modal__content">
            <canvas id="top10-chart"></canvas>
        </div>
    </div>
</div>
`;

export const modalChart = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalChartHTML;
        }
    }
};
--- END FILE: ./components/modal-chart.js ---

--- START FILE: ./components/modal-composer.js ---
// Version 1.0 - Component: Composer Modal
// Ch·ª©a m√£ HTML cho modal Tr√¨nh t·∫°o Nh·∫≠n x√©t.

const modalComposerHTML = `
<div id="composer-modal" class="modal hidden">
    <div class="modal__overlay" data-close-modal></div>
    <div class="modal__container modal__container--large">
        <div class="modal__header">
            <h3 id="composer-modal-title" class="modal__title">Tr√¨nh t·∫°o Nh·∫≠n x√©t</h3>
            <button class="modal__close-btn" data-close-modal>&times;</button>
        </div>
        <div id="composer-modal-content" class="modal__content">
            <div class="composer">
                <div class="composer__editor">
                    <label class="composer__label">N·ªôi dung nh·∫≠n x√©t</label>
                    <nav id="composer-context-tabs" class="composer__nav mb-2"></nav>
                    <div id="composer-context-content">
                        </div>
                </div>
                <div class="composer__tags">
                    <div class="composer__nav">
                        <button class="composer__tab-btn active" data-tab="tab-general">Chung & Icons</button>
                        <button class="composer__tab-btn" data-tab="tab-kpi">KPIs Si√™u Th·ªã</button>
                        <button class="composer__tab-btn" data-tab="tab-ranking">X·∫øp H·∫°ng NV</button>
                        <button class="composer__tab-btn" data-tab="tab-details">Thi ƒêua & Chi Ti·∫øt</button>
                    </div>

                    <div class="composer__content">
                        <div class="composer__tab-pane active" id="tab-general">
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">Chung</h5>
                                <button class="composer__tag-btn" data-tag="[NGAY]">Ng√†y</button>
                                <button class="composer__tag-btn" data-tag="[GIO]">Gi·ªù</button>
                            </div>
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">Bi·ªÉu t∆∞·ª£ng (Icons)</h5>
                                <button class="composer__icon-btn">üìä</button>
                                <button class="composer__icon-btn">üí∞</button>
                                <button class="composer__icon-btn">üí•</button>
                                <button class="composer__icon-btn">üéØ</button>
                                <button class="composer__icon-btn">üìà</button>
                                <button class="composer__icon-btn">üì¶</button>
                                <button class="composer__icon-btn">‚ö†Ô∏è</button>
                                <button class="composer__icon-btn">üî•</button>
                                <button class="composer__icon-btn">‚úÖ</button>
                            </div>
                        </div>

                        <div class="composer__tab-pane" id="tab-kpi">
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">KPIs Ch√≠nh</h5>
                                <button class="composer__tag-btn" data-tag="[DT_THUC]">DT Th·ª±c</button>
                                <button class="composer__tag-btn" data-tag="[DTQD]">DT Quy ƒë·ªïi</button>
                                <button class="composer__tag-btn" data-tag="[%HT_DTT]">%HT DT Th·ª±c</button>
                                <button class="composer__tag-btn" data-tag="[%HT_DTQD]">%HT DT Qƒê</button>
                                <button class="composer__tag-btn" data-tag="[TLQD]">T·ª∑ l·ªá Quy ƒë·ªïi</button>
                                <button class="composer__tag-btn" data-tag="[DT_CHUAXUAT]">DTQƒê Ch∆∞a Xu·∫•t</button>
                                <button class="composer__tag-btn" data-tag="[SS_CUNGKY]">TƒÉng/gi·∫£m C√πng k·ª≥</button>
                            </div>
                        </div>

                        <div class="composer__tab-pane" id="tab-ranking">
                            <div class="composer__filter-group">
                                <label for="composer-dept-filter" class="composer__label">L·ªçc theo b·ªô ph·∫≠n:</label>
                                <select id="composer-dept-filter" class="composer__select">
                                    <option value="ALL">To√†n si√™u th·ªã</option>
                                </select>
                            </div>
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">X·∫øp h·∫°ng DT Quy ƒê·ªïi</h5>
                                <button class="composer__tag-btn" data-tag-template="[TOP3_DTQD_{dept}@msnv]">Top 3</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT3_DTQD_{dept}@msnv]">Bot 3</button>
                            </div>
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">X·∫øp h·∫°ng Thu Nh·∫≠p</h5>
                                <button class="composer__tag-btn" data-tag-template="[TOP3_THUNHAP_{dept}@msnv]">Top 3</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT3_THUNHAP_{dept}@msnv]">Bot 3</button>
                            </div>
                             <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">X·∫øp h·∫°ng T·ª∑ l·ªá Quy ƒë·ªïi</h5>
                                <button class="composer__tag-btn" data-tag-template="[TOP3_TLQD_{dept}@msnv]">Top 3</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT3_TLQD_{dept}@msnv]">Bot 3</button>
                            </div>
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">NV D∆∞·ªõi M·ª•c Ti√™u Khai B√°o</h5>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_TLQD_{dept}@msnv]">% Quy ƒë·ªïi</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_TLTC_{dept}@msnv]">% Tr·∫£ ch·∫≠m</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_PK_{dept}@msnv]">% Ph·ª• ki·ªán</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_GD_{dept}@msnv]">% Gia d·ª•ng</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_MLN_{dept}@msnv]">% MLN</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_SIM_{dept}@msnv]">% Sim</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_VAS_{dept}@msnv]">% VAS</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_BH_{dept}@msnv]">% B·∫£o hi·ªÉm</button>
                            </div>
                            </div>
                        
                        <div class="composer__tab-pane" id="tab-details">
                            <div class="composer__sub-nav">
                                <button class="composer__sub-tab-btn active" data-sub-tab="sub-tab-thidua">Thi ƒêua</button>
                                <button class="composer__sub-tab-btn" data-sub-tab="sub-tab-qdc">Nh√≥m QƒêC</button>
                                <button class="composer__sub-tab-btn" data-sub-tab="sub-tab-nganhhang">Ng√†nh H√†ng</button>
                            </div>
                            <div class="composer__sub-content">
                                <div class="composer__sub-tab-pane active" id="sub-tab-thidua">
                                    <div class="composer__tag-group">
                                        <h5 class="composer__tag-group-title">Thi ƒêua Ng√†nh H√†ng</h5>
                                        <button class="composer__tag-btn" data-tag="[TD_TONG_CT]">T·ªïng CT</button>
                                        <button class="composer__tag-btn" data-tag="[TD_CT_DAT]">>100%</button>
                                        <button class="composer__tag-btn" data-tag="[TD_CT_CHUADAT]"><100%</button>
                                        <button class="composer__tag-btn" data-tag="[TD_TYLE_DAT]">% ƒê·∫°t</button>
                                    </div>
                                </div>
                                <div class="composer__sub-tab-pane" id="sub-tab-qdc">
                                    <div id="composer-qdc-tags-container" class="composer__tag-group">
                                        <h5 class="composer__tag-group-title">Ch·ªçn Nh√≥m H√†ng QƒêC</h5>
                                    </div>
                                </div>
                                <div class="composer__sub-tab-pane" id="sub-tab-nganhhang">
                                    <div id="composer-nganhhang-tags-container" class="composer__tag-group">
                                        <h5 class="composer__tag-group-title">Ch·ªçn Ng√†nh H√†ng Chi Ti·∫øt</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal__footer">
            <button id="save-composer-template-btn" class="action-btn action-btn--save">L∆∞u m·∫´u</button>
            <button id="copy-composed-notification-btn" class="action-btn action-btn--copy">Xem tr∆∞·ªõc & Sao ch√©p</button>
        </div>
    </div>
</div>
`;

export const modalComposer = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalComposerHTML;
        }
    }
};
--- END FILE: ./components/modal-composer.js ---

--- START FILE: ./components/modal-force-update.js ---
// Version 1.1 - Add container for update notes
// MODULE: COMPONENTS - FORCE UPDATE MODAL
// Ch·ª©a m√£ HTML cho modal y√™u c·∫ßu ng∆∞·ªùi d√πng c·∫≠p nh·∫≠t phi√™n b·∫£n.

const modalForceUpdateHTML = `
<div id="force-update-modal" class="modal hidden">
    <div class="modal__overlay" style="cursor: not-allowed;"></div>
    <div class="modal__container" style="max-width: 500px;">
        <div class="modal__header">
            <h3 id="force-update-title" class="modal__title">üì¢ ƒê√£ c√≥ phi√™n b·∫£n m·ªõi!</h3>
        </div>
        <div class="modal__content">
            <p class="text-gray-600 mb-4">M·ªôt phi√™n b·∫£n m·ªõi v·ªõi c√°c b·∫£n s·ª≠a l·ªói v√† c·∫£i ti·∫øn ƒë√£ s·∫µn s√†ng. Vui l√≤ng t·∫£i l·∫°i trang ƒë·ªÉ ti·∫øp t·ª•c.</p>
            
            <div id="update-notes-container" class="my-4 p-3 bg-gray-50 border border-gray-200 rounded-lg max-h-48 overflow-y-auto">
                <p class="text-sm text-gray-500">ƒêang t·∫£i chi ti·∫øt...</p>
            </div>
            <button id="force-reload-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition text-lg">
                C·∫≠p nh·∫≠t ngay
            </button>
        </div>
    </div>
</div>
`;

export const modalForceUpdate = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalForceUpdateHTML;
        }
    }
};
--- END FILE: ./components/modal-force-update.js ---

--- START FILE: ./components/modal-help.js ---
// Version 1.0 - Component: Help Modal
// Ch·ª©a m√£ HTML cho modal hi·ªÉn th·ªã n·ªôi dung h∆∞·ªõng d·∫´n.

const modalHelpHTML = `
<div id="help-modal" class="modal hidden">
    <div class="modal__overlay" data-close-modal></div>
    <div class="modal__container">
        <div class="modal__header">
            <h3 id="help-modal-title" class="modal__title"></h3>
            <button class="modal__close-btn" data-close-modal>&times;</button>
        </div>
        <div id="help-modal-content" class="modal__content">
        </div>
    </div>
</div>
`;

export const modalHelp = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalHelpHTML;
        }
    }
};
--- END FILE: ./components/modal-help.js ---

--- START FILE: ./components/modal-preview.js ---
// Version 1.0 - Component: Preview Modal
// Ch·ª©a m√£ HTML cho modal xem tr∆∞·ªõc n·ªôi dung nh·∫≠n x√©t.

const modalPreviewHTML = `
<div id="preview-modal" class="modal hidden">
    <div class="modal__overlay" data-close-modal></div>
    <div class="modal__container">
        <div class="modal__header">
            <h3 id="preview-modal-title" class="modal__title">Xem tr∆∞·ªõc n·ªôi dung</h3>
            <button class="modal__close-btn" data-close-modal>&times;</button>
        </div>
        <div class="modal__content">
            <pre id="preview-modal-content" class="preview-content"></pre>
        </div>
        <div class="modal__footer">
            <button id="copy-from-preview-btn" class="action-btn action-btn--copy">Sao ch√©p n·ªôi dung</button>
        </div>
    </div>
</div>
`;

export const modalPreview = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalPreviewHTML;
        }
    }
};
--- END FILE: ./components/modal-preview.js ---

--- START FILE: ./components/modal-selection.js ---
// Version 1.0 - Component: Selection Modal
// Ch·ª©a m√£ HTML cho modal t√πy ch·ªânh hi·ªÉn th·ªã chung.

const modalSelectionHTML = `
<div id="selection-modal" class="modal hidden">
    <div class="modal__overlay" data-close-modal></div>
    <div class="modal__container">
        <div class="modal__header">
            <h3 id="selection-modal-title" class="modal__title">T√πy ch·ªânh hi·ªÉn th·ªã</h3>
            <button class="modal__close-btn" data-close-modal>&times;</button>
        </div>
        <div class="modal__content">
            <input type="text" id="selection-modal-search" class="w-full p-2 border rounded-md mb-4" placeholder="T√¨m ki·∫øm m·ª•c...">
            <div id="selection-modal-list" class="space-y-2 max-h-64 overflow-y-auto">
                </div>
        </div>
        <div class="modal__footer">
            <button id="selection-modal-save-btn" class="action-btn action-btn--save">L∆∞u C√†i ƒê·∫∑t</button>
        </div>
    </div>
</div>
`;

export const modalSelection = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalSelectionHTML;
        }
    }
};
--- END FILE: ./components/modal-selection.js ---

--- START FILE: ./components/sidebar.js ---
// Version 1.4 - Add font-semibold to all nav links for consistency
// Version 1.3 - Optimize HTML for better icon/text alignment
// Ch·ª©a m√£ HTML v√† logic cho thanh ƒëi·ªÅu h∆∞·ªõng b√™n.

const sidebarHTML = `
<nav id="sidebar" class="bg-white/80 backdrop-blur-sm shadow-lg fixed top-0 left-0 h-full z-30 p-3 flex flex-col justify-between">
    <div>
         <a href="#home-section" class="nav-link flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold mb-4">
            <i data-feather="home"></i>
            <span class="menu-text">H∆∞·ªõng D·∫´n & G√≥p √ù</span>
        </a>
        <ul class="space-y-2">
            <li>
                <a href="#data-section" class="nav-link flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="file-text"></i>
                    <span class="menu-text">C·∫≠p nh·∫≠t d·ªØ li·ªáu</span>
                </a>
            </li>
            <li>
                <a href="#health-section" class="nav-link flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="activity"></i>
                    <span class="menu-text">S·ª©c kh·ªèe si√™u th·ªã</span>
                </a>
            </li>
            <li>
                <a href="#health-employee-section" class="nav-link flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="users"></i>
                    <span class="menu-text">S·ª©c kh·ªèe nh√¢n vi√™n</span>
                </a>
            </li>
            <li>
                <a href="#realtime-section" class="nav-link flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="trending-up"></i>
                    <span class="menu-text">Doanh thu realtime</span>
                </a>
            </li>
        </ul>
    </div>
    <div>
        <ul class="space-y-2">
            <li>
                <button id="interface-settings-btn" class="w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="settings"></i>
                    <span class="menu-text">C√†i ƒë·∫∑t giao di·ªán</span>
                </button>
            </li>
            <li>
                <button id="goal-settings-btn" class="w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="target"></i>
                    <span class="menu-text">Thi·∫øt l·∫≠p m·ª•c ti√™u</span>
                </button>
            </li>
            <li>
                <button id="admin-access-btn" class="w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="edit"></i>
                    <span class="menu-text">Khai b√°o</span>
                </button>
            </li>
        </ul>
    </div>
</nav>
`;

export const sidebar = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = sidebarHTML;
        }
    }
};
--- END FILE: ./components/sidebar.js ---

--- START FILE: ./config.js ---
// Version 2.2 - New Features & Refinements
// MODULE 1: T·ª¶ C·∫§U H√åNH (CONFIG)
// File n√†y ch·ª©a t·∫•t c·∫£ c√°c c·∫•u h√¨nh tƒ©nh c·ªßa ·ª©ng d·ª•ng.

const config = {
    ADMIN_PASSWORD: "Linh3031",
    COLUMN_MAPPINGS: {
        danhsachnv: {
            maKho: { required: true, displayName: 'M√£ Kho', aliases: ['m√£ kho', 'makho', 'kho'] },
            maNV: { required: true, displayName: 'M√£ Nh√¢n Vi√™n', aliases: ['m√£ nv', 'msnv', 'm√£ nh√¢n vi√™n', 'manv', 'm√£ s·ªë nh√¢n vi√™n'] },
            hoTen: { required: true, displayName: 'H·ªç v√† T√™n', aliases: ['h·ªç v√† t√™n', 't√™n nh√¢n vi√™n', 't√™n nv', 'h·ªç t√™n'] },
            boPhan: { required: true, displayName: 'B·ªô ph·∫≠n', aliases: ['b·ªô ph·∫≠n'] }
        },
        ycx: { // D√πng chung cho c·∫£ YCX l≈©y k·∫ø v√† YCX realtime
            ngayTao: { required: true, displayName: 'Ng√†y t·∫°o', aliases: ['ng√†y t·∫°o'] },
            ngayHenGiao: { required: false, displayName: 'Ng√†y h·∫πn giao', aliases: ['ng√†y h·∫πn giao'] },
            nguoiTao: { required: true, displayName: 'Ng∆∞·ªùi t·∫°o', aliases: ['ng∆∞·ªùi t·∫°o'] },
            thanhTien: { required: true, displayName: 'Gi√° b√°n', aliases: ['gi√° b√°n_1', 'gi√° b√°n'] },
            soLuong: { required: true, displayName: 'S·ªë l∆∞·ª£ng', aliases: ['sl b√°n', 's·ªë l∆∞·ª£ng'] },
            nhomHang: { required: true, displayName: 'Nh√≥m h√†ng', aliases: ['nh√≥m h√†ng'] },
            tenSanPham: { required: true, displayName: 'T√™n s·∫£n ph·∫©m', aliases: ['t√™n s·∫£n ph·∫©m'] },
            tenKhachHang: { required: true, displayName: 'T√™n kh√°ch h√†ng', aliases: ['t√™n kh√°ch h√†ng', 'tenkhachhang'] },
            nhaSanXuat: { required: true, displayName: 'Nh√† s·∫£n xu·∫•t', aliases: ['nh√† s·∫£n xu·∫•t', 'nhasanxuat'] },
            nganhHang: { required: true, displayName: 'Ng√†nh h√†ng', aliases: ['ng√†nh h√†ng'] },
            hinhThucXuat: { required: true, displayName: 'H√¨nh th·ª©c xu·∫•t', aliases: ['h√¨nh th·ª©c xu·∫•t'] },
            trangThaiThuTien: { required: true, displayName: 'Tr·∫°ng th√°i thu ti·ªÅn', aliases: ['tr·∫°ng th√°i thu ti·ªÅn'] },
            trangThaiHuy: { required: true, displayName: 'Tr·∫°ng th√°i h·ªßy', aliases: ['tr·∫°ng th√°i h·ªßy'] },
            tinhTrangTra: { required: true, displayName: 'T√¨nh tr·∫°ng tr·∫£', aliases: ['t√¨nh tr·∫°ng nh·∫≠p tr·∫£ c·ªßa s·∫£n ph·∫©m ƒë·ªïi v·ªõi s·∫£n ph·∫©m ch√≠nh', 't√¨nh tr·∫°ng tr·∫£'] },
            trangThaiXuat: { required: true, displayName: 'Tr·∫°ng th√°i xu·∫•t', aliases: ['tr·∫°ng th√°i xu·∫•t'] }
        },
        giocong: {
            maNV: { required: false, displayName: 'M√£ NV', aliases: ['m√£ nv', 'msnv'] },
            hoTen: { required: false, displayName: 'T√™n NV', aliases: ['t√™n nv', 'tennv'] },
            tongGioCong: { required: true, displayName: 'T·ªïng gi·ªù c√¥ng', aliases: ['t·ªïng gi·ªù c√¥ng (x.nh·∫≠n) total', 't·ªïng gi·ªù c√¥ng'] }
        },
        thuongnong: {
            maNV: { required: false, displayName: 'M√£ NV', aliases: ['manv', 'm√£ nv'] },
            hoTen: { required: false, displayName: 'T√™n NV', aliases: ['tennv', 't√™n nv'] },
            diemThuong: { required: true, displayName: 'ƒêi·ªÉm th∆∞·ªüng', aliases: ['diemthuong', 'ƒëi·ªÉm th∆∞·ªüng'] }
        }
    },
    PRODUCT_GROUPS: {
        ICT: ['1491', '931', '42'],
        CE: ['1097', '1098', '1099', '1094', '894'],
        PHU_KIEN: ['16', '1394', '184', '764'], // 16 - Ph·ª• ki·ªán ti·ªán √≠ch, 1394 - Ph·ª• ki·ªán l·∫Øp ƒë·∫∑t, 184 - Ph·ª• ki·ªán trang tr√≠, 764 - Loa vi t√≠nh
        GIA_DUNG: ['484', '1214'], // M√£ ng√†nh h√†ng Gia D·ª•ng
        MAY_LOC_NUOC: ['4171', '4172'], // M√£ nh√≥m h√†ng M√°y L·ªçc N∆∞·ªõc
        PIN_SDP: '12',
        CAMERA_TRONG_NHA: '6479',
        CAMERA_NGOAI_TROi: '4219',
        TAI_NGHE_BLT: '4540',
        NOI_CHIEN: '4099',
        ROBOT_HB: '4439',
        TIVI: '1094',
        TU_LANH: '1097',
        MAY_GIAT: '1099',
        MAY_LANH: '1098',
        DIEN_THOAI: ['13', '1491', '18'],
        LAPTOP: '42',
        SIM: ['1891', '664'],
        VAS: ['164', '571'],
        BAO_HIEM_VAS: ['4479', '4499'],
        SMARTPHONE: ['1491', '18', '13'],
        BAO_HIEM_DENOMINATOR: ['1491', '1097', '894', '1099', '1098', '42', '1094', '3859', '911', '893', '3659'],
        QDC_GROUPS: {
            PIN_SDP: { codes: ['12'], name: 'Pin SDP' },
            TAI_NGHE_BLT: { codes: ['3346', '4540'], name: 'Tai nghe BLT' },
            DONG_HO: { codes: ['4059', '4060', '4061', '4062', '4063', '4064', '4070'], name: 'ƒê·ªìng h·ªì' },
            CAMERA: { codes: ['4219', '6479'], name: 'Camera' },
            LOA: { codes: ['1031', '1351', '4779'], name: 'Loa' },
            UDDD: { codes: ['571', '611'], name: 'UDDƒê' },
            BAO_HIEM: { codes: ['4479', '4499'], name: 'B·∫£o hi·ªÉm' },
            NOI_COM: { codes: ['4157', '4158'], name: 'N·ªìi c∆°m ƒëi·ªán t·ª≠ + cao t·∫ßn' },
            NOI_CHIEN: { codes: ['4099'], name: 'N·ªìi chi√™n' },
            MAY_LOC_NUOC: { codes: ['4171', '4172'], name: 'M√°y l·ªçc n∆∞·ªõc' },
            ROBOT_HB: { codes: ['4439'], name: 'Robot h√∫t b·ª•i' },
            SIM_ONLINE: { codes: ['1891'], name: 'SIM' }
        }
    },
    DEPARTMENT_GROUPS: [
        'BP T∆∞ V·∫•n - ƒêM',
        'BP Trang Tr√≠ ki√™m Thu ng√¢n - Sim S·ªë - ƒêM',
        'BP Kho Ki√™m H·ªó Tr·ª£ K·ªπ Thu·∫≠t Xe ƒê·∫°p - ƒêM'
    ],
    DEFAULT_DATA: {
        HINH_THUC_XUAT_TINH_DOANH_THU: [
            'Xu·∫•t b√°n h√†ng t·∫°i si√™u th·ªã', 'Xu·∫•t cung ·ª©ng d·ªãch v·ª•',
            'Xu·∫•t b√°n pre-order t·∫°i si√™u th·ªã', 'Xu·∫•t SIM tr·∫Øng k√®m theo SIM',
            'Xu·∫•t b√°n h√†ng ∆∞u ƒë√£i cho nh√¢n vi√™n', 'Xu·∫•t b√°n h√†ng t·∫°i si√™u th·ªã (TCƒêM)',
            'Xu·∫•t d·ªãch v·ª• b·∫£o h√†nh tr·ªçn ƒë·ªùi', 'Xu·∫•t d·ªãch v·ª• b·∫£o d∆∞·ª°ng tr·ªçn ƒë·ªùi',
            'Xu·∫•t b√°n h√†ng tr·∫£ g√≥p t·∫°i si√™u th·ªã', 'Xu·∫•t b√°n tr·∫£ g√≥p ∆∞u ƒë√£i cho nh√¢n vi√™n',
            'Xu·∫•t b√°n tr·∫£ g√≥p cho NV ph·ª•c v·ª• c√¥ng vi·ªác', 'Xu·∫•t b√°n pre-order tr·∫£ g√≥p t·∫°i si√™u th·ªã',
            'Xu·∫•t b√°n pre-order tr·∫£ g√≥p t·∫°i si√™u th·ªã (TCƒêM)',
            'Xu·∫•t d·ªãch v·ª• thu h·ªô b·∫£o hi·ªÉm'
        ],
        HINH_THUC_XUAT_TRA_GOP: ['Xu·∫•t b√°n h√†ng tr·∫£ g√≥p t·∫°i si√™u th·ªã', 'Xu·∫•t b√°n tr·∫£ g√≥p ∆∞u ƒë√£i cho nh√¢n vi√™n', 'Xu·∫•t b√°n tr·∫£ g√≥p cho NV ph·ª•c v·ª• c√¥ng vi·ªác', 'Xu·∫•t b√°n pre-order tr·∫£ g√≥p t·∫°i si√™u th·ªã', 'Xu·∫•t b√°n pre-order tr·∫£ g√≥p t·∫°i si√™u th·ªã (TCƒêM)'],
        HE_SO_QUY_DOI: { '1098 - M√°y l·∫°nh (IMEI)': 1, '2011 - Khuy·∫øn m√£i - SP ·∫¢o': 1, '2511 - N·∫°p ti·ªÅn AirTime M_Service': 1, '2151 - Phi·∫øu mua h√†ng/Pre Order': 1, '971 - Th·∫ª c√†o ƒëi·ªán t·ª≠': 1, '431 - ·ªêp L∆∞ng - Flip Cover': 3.37, '2571 - Thu h·ªô c∆∞·ªõc Viettel': 1, '4519 - Thu H·ªô Ti·ªÅn Tr·∫£ G√≥p': 1, '2513 - Thu h·ªô Payoo': 1, '4302 - N√≥n b·∫£o hi·ªÉm c√°c lo·∫°i': 1.92, '2291 - Sim tr·∫Øng (Seri)': 1, '18 - ƒêi·ªán Tho·∫°i Di ƒê·ªông': 1, '4599 - Thu H·ªô Ti·ªÅn M·∫∑t': 1, '12 - Pin s·∫°c d·ª± ph√≤ng': 3.37, '571 - UDDƒê': 1, '58 - Mi·∫øng d√°n m·∫∑t sau': 3.37, '1231 - Mi·∫øng d√°n m·∫∑t tr∆∞·ªõc': 3.37, '1491 - Smartphone': 1, '1891 - Sim Online': 5.45, '4479 - D·ªãch V·ª• B·∫£o Hi·ªÉm': 4.18, '3359 - Ph·ª• ki·ªán ƒë·ªìng h·ªì': 3, '2391 - Smartwatch': 3, '911 - M√°y n∆∞·ªõc n√≥ng': 1, '4499 - Thu H·ªô Ph√≠ B·∫£o Hi·ªÉm': 4.18, '4142 - B√¨nh ƒëun si√™u t·ªëc': 1.85, '4153 - Xay Sinh t·ªë': 1.85, '15 - Tai nghe d√¢y': 3.37, '1412 - D·ªãch v·ª• b·∫£o tr√¨': 1, '3345 - C√°p': 3.37, '2312 - M√£ n·∫°p th·∫ª game': 1, '4900 - B√†n ph√≠m': 3.37, '4141 - B√†n ·ªßi kh√¥': 1.85, '4156 - N·ªìi c∆°m n·∫Øp g√†i/n·∫Øp r·ªùi': 1.85, '14 - S·∫°c/ Adapter': 3.37, '42 - Laptop': 1.2, '751 - Khuy·∫øn m√£i ba l√¥, t√∫i x√°ch': 1, '1031 - Loa di ƒë·ªông': 3.37, '4199 - Mi·∫øng D√°n K√≠nh': 3.37, '3346 - Tai Nghe Bluetooth': 3.37, '931 - M√°y t√≠nh b·∫£ng': 1.2, '19 - Khuy·∫øn m√£i ƒêTDƒê': 1, '10 - Chu·ªôt': 3.37, '4060 - ƒê·ªìng h·ªì Nam D√¢y da': 3, '880 - Loa Karaoke': 1.29, '851 - Khuy·∫øn m√£i ƒêi·ªán T·ª≠': 1, '4169 - L√µi l·ªçc': 1.85, '4540 - Tai Nghe Bluetooth - imei': 3.37, '4062 - ƒê·ªìng h·ªì N·ªØ D√¢y kim lo·∫°i': 3, '2831 - Ph·ª• ki·ªán Apple': 3.37, '2691 - B·ªô S·∫°c/C√°p/Adaptor (Gi√° R·∫ª)': 3.37, '1351 - Loa vi t√≠nh (imei)': 3.37, '1094 - Tivi LED (IMEI)': 1, '4324 - Khung treo, gi√° ƒë·ª°': 3.37, '1099 - M√°y gi·∫∑t (IMEI)': 1, '1097 - T·ªß l·∫°nh (IMEI)': 1, '4099 - N·ªìi chi√™n': 1.85, '4070 - ƒê·ªìng h·ªì Tr·∫ª em': 3, '967 - S·∫•y t√≥c': 1.85, '957 - L√≤ n∆∞·ªõng': 1.85, '958 - L√≤ vi s√≥ng': 1.85, '4158 - N·ªìi c∆°m ƒëi·ªán t·ª≠': 1.85, '3241 - Dao/K√©o/Th·ªõt': 1.92, '3240 - H·ªôp/H≈©': 1.92, '3265 - N·ªìi': 1.92, '4139 - ƒê√®n b√†n/ƒê√®n S·∫°c/ƒê√®n b·∫Øt mu·ªói': 1.85, '73 - Ph·ª• ki·ªán ƒëi·ªán m√°y': 3.37, '4171 - L·ªçc n∆∞·ªõc d·∫°ng t·ªß ƒë·ª©ng': 1.85, '3384 - ƒê·ªì ngh·ªÅ s·ª≠ d·ª•ng ƒëi·ªán': 1, '4147 - B·∫øp ƒëi·ªán ƒë∆°n': 1.85, '4063 - ƒê·ªìng h·ªì N·ªØ D√¢y da': 3, '3263 - Ch·∫£o': 1.92, '3185 - V·ªá sinh nh√† c·ª≠a': 1.92, '4143 - B√†n ·ªßi h∆°i n∆∞·ªõc ƒë·ª©ng': 1.85, '4146 - B·∫øp gas ƒë√¥i': 1.85, '1052 - Khuy·∫øn m√£i ƒêi·ªán L·∫°nh': 1, '3799 - Qu·∫°t ƒëi·ªÅu h√≤a': 1.85, '1951 - Software (s·ªë L∆∞·ª£ng)': 1, '6000 - M√°y √©p tr√°i c√¢y': 1.85, '4059 - ƒê·ªìng h·ªì Nam D√¢y kim lo·∫°i': 3, '4160 - Qu·∫°t b√†n/h·ªôp/s·∫°c': 1.85, '4162 - B√¨nh/Ca ƒë·ª±ng n∆∞·ªõc': 1.92, '4660 - Qu·∫°t l·ª≠ng': 1.85, '17 - Ph·ª• ki·ªán IT kh√°c': 3.37, '4145 - B·∫øp gas ƒë∆°n': 1.85, '875 - D√†n m√°y': 1, '1071 - Ph·ª• ki·ªán ƒëi·ªán t·ª≠': 3.37, '891 - Micro': 1, '4152 - ·ªî c·∫Øm ƒëi·ªán/v·ª£t mu·ªói': 1.85, '4154 - Xay √©p/Kh√°c': 1.85, '5975 - Balo T√∫i Ch·ªëng S·ªëc': 3.37, '893 - T·ªß ƒë√¥ng': 1, '2531 - Thu h·ªô Mservice': 1, '4019 - Sim tr·∫Øng ƒëi·ªán t·ª≠': 1, '4320 - ƒê·ªìng h·ªì - Khuy·∫øn m√£i mua': 1, '3187 - B√¨nh/Ly/Ca gi·ªØ nhi·ªát': 1.92, '4159 - Qu·∫°t ƒë·ª©ng': 1.85, '4157 - N·ªìi c∆°m cao t·∫ßn': 1.85, '16 - Th·∫ª Nh·ªõ': 3.37, '4140 - B√†n ·ªßi h∆°i n∆∞·ªõc': 1.85, '4150 - M√°y n∆∞·ªõc n√≥ng l·∫°nh': 1.85, '591 - Thay sim': 1, '2999 - D·ª•ng c·ª• nh√† b·∫øp kh√°c': 1.92, '4779 - Loa di ƒë·ªông - imei': 3.37, '4440 - G√≥i C∆∞·ªõc V√† D·ªãch V·ª• GTGT': 1, '4121 - M√°y B∆°m N∆∞·ªõc': 1, '4161 - Qu·∫°t treo': 1.85, '4961 - Qu·∫ßn b√≥ & legging n·ªØ Th·ªÉ Thao': 1, '4151 - √Åp su·∫•t/l·∫©u/chi√™n/n∆∞·ªõng': 1.85, '4144 - B·∫øp gas √¢m': 1.85, '871 - USB': 3.37, '6479 - Camera IP Trong nh√†': 3.37, '4219 - Camera IP Ngo√†i tr·ªùi': 3.37, '4659 - Ph·ª• ki·ªán ti·ªán √≠ch Apple': 3.37, '531 - Pin, 4095 - C√°p (Gi√° R·∫ª)': 3.37, '2791 - Kinh doanh m√πa v·ª•': 3.37, '2771 - Gi√° treo m√†n h√¨nh m√°y t√≠nh': 3.37, '80 - Khuy·∫øn m√£i Kh√°c': 1, '1131 - M√°y in, Fax': 2, '4125 - Smartband': 3, '743 - Qu·∫°t s∆∞·ªüi': 1.85, '4659 - Ph·ª• ki·ªán Apple - Imei': 3.37, '4064 - ƒê·ªìng h·ªì N·ªØ D√¢y kh√°c': 3, '956 - H√∫t b·ª•i': 1.85, '4172 - L·ªçc n∆∞·ªõc √¢m t·ªß/tr√™n b√†n': 1.85, '3779 - B·∫øp ƒëi·ªán √¢m': 1.85, '4061 - ƒê·ªìng h·ªì Nam D√¢y kh√°c': 3, '4067 - ƒê·ªìng h·ªì Unisex D√¢y kh√°c': 3, '1411 - D·ªãch v·ª• l·∫Øp ƒë·∫∑t': 1, '4149 - B√¨nh th·ªßy ƒëi·ªán': 1.85, '4148 - B·∫øp ƒëi·ªán ƒë√¥i': 1.85, '955 - H√∫t m√πi/ h√∫t kh√≥i': 1.85, '4699 - Gia d·ª•ng kh√¥ng ƒëi·ªán kh√°c': 1.92, '4859 - Xe ƒë·∫°p ƒë∆∞·ªùng ph·ªë c·ªï ƒëi·ªÉn': 1, '4759 - Ph·ª• Ki·ªán Xe ƒê·∫°p': 1, '2471 - Thu h·ªô c∆∞·ªõc VinaPhone': 1, '3719 - Qu·∫ßn d√†i n·ªØ Th·ªÉ Thao': 1, '1051 - Khuy·∫øn m√£i ƒêi·ªán gia d·ª•ng': 1, '3721 - Qu·∫ßn ng·∫Øn & v√°y n·ªØ Th·ªÉ Thao': 1, '410 - Ph·ª• ki·ªán TT kh√°c': 3.37, '4155 - H√∫t b·ª•i c√¢y': 1.85, '3563 - M√°y t√≠nh nguy√™n b·ªô': 1, '894 - T·ªß m√°t': 1, '3639 - M√°y l·ªçc kh√¥ng kh√≠': 1.85, '611 - ·ª®ng d·ª•ng PC & Laptop': 1, '4089 - ƒê·ªìng h·ªì Unisex D√¢y kim lo·∫°i': 3, '4439 - H√∫t B·ª•i Robot': 1.85, '3740 - √Åo T-shirt nam Th·ªÉ Thao': 1, '4339 - ·ªîn √Åp': 1, '4459 - Qu·∫°t Tr·∫ßn': 1.85, '2351 - Router - Imei': 3.37, '3159 - DV Internet v√† Truy·ªÅn h√¨nh thu ti·ªÅn': 1, '3659 - M√°y s·∫•y l·ªìng ngang': 1, '3519 - √Åo Bra Th·ªÉ Thao': 1, '3479 - Thi·∫øt b·ªã m·∫°ng kh√°c': 3.37, '3859 - M√°y r·ª≠a ch√©n': 1 }
        }
    };

// D√≤ng cu·ªëi c√πng n√†y r·∫•t quan tr·ªçng. N√≥ "xu·∫•t kh·∫©u" ƒë·ªëi t∆∞·ª£ng config 
// ƒë·ªÉ c√°c file JavaScript kh√°c c√≥ th·ªÉ "nh·∫≠p kh·∫©u" v√† s·ª≠ d·ª•ng.
export { config };

--- END FILE: ./config.js ---

--- START FILE: ./create_snapshot.js ---
// K·ªãch b·∫£n Node.js chuy√™n d·ª•ng ƒë·ªÉ t·∫°o snapshot to√†n di·ªán cho d·ª± √°n
// Phi√™n b·∫£n 1.1 - M·ªü r·ªông c√°c lo·∫°i file ƒë∆∞·ª£c h·ªó tr·ª£

const fs = require('fs');
const path = require('path');

// --- C·∫§U H√åNH ---
const config = {
    // Th∆∞ m·ª•c g·ªëc ƒë·ªÉ b·∫Øt ƒë·∫ßu qu√©t
    rootDirectory: '.', 
    // T√™n file output
    outputFile: 'project_snapshot.txt',
    // ====> THAY ƒê·ªîI QUAN TR·ªåNG <====
    // C√°c ƒëu√¥i file c·∫ßn l·∫•y n·ªôi dung. ƒê√£ b·ªï sung .json, .svg, .md
    includeExtensions: ['.js', '.html', '.css', '.txt', '.json', '.svg', '.md'],
    // C√°c th∆∞ m·ª•c c·∫ßn b·ªè qua
    excludeDirectories: ['node_modules', '.git', '.history'] 
};

// --- LOGIC CH√çNH ---

// H√†m ƒë·ªá quy ƒë·ªÉ duy·ªát qua c√°c th∆∞ m·ª•c
function walkDirectory(dir, filelist = []) {
    const files = fs.readdirSync(dir);
    files.forEach(file => {
        const filepath = path.join(dir, file);
        const stat = fs.statSync(filepath);

        // N·∫øu l√† th∆∞ m·ª•c v√† kh√¥ng n·∫±m trong danh s√°ch lo·∫°i tr·ª´ -> ti·∫øp t·ª•c duy·ªát
        if (stat.isDirectory() && !config.excludeDirectories.includes(file)) {
            filelist = walkDirectory(filepath, filelist);
        } 
        // N·∫øu l√† file v√† c√≥ ƒëu√¥i file n·∫±m trong danh s√°ch cho ph√©p -> th√™m v√†o danh s√°ch
        else if (stat.isFile() && config.includeExtensions.includes(path.extname(file))) {
            filelist.push(filepath);
        }
    });
    return filelist;
}

// H√†m ch√≠nh ƒë·ªÉ ch·∫°y k·ªãch b·∫£n
function createSnapshot() {
    console.log('B·∫Øt ƒë·∫ßu qu√° tr√¨nh t·∫°o snapshot (phi√™n b·∫£n n√¢ng cao)...');
    
    const allFiles = walkDirectory(config.rootDirectory);

    if (fs.existsSync(config.outputFile)) {
        fs.unlinkSync(config.outputFile);
    }

    allFiles.forEach(filepath => {
        try {
            const content = fs.readFileSync(filepath, 'utf8');
            // Chu·∫©n h√≥a ƒë∆∞·ªùng d·∫´n ƒë·ªÉ lu√¥n d√πng d·∫•u g·∫°ch ch√©o '/'
            const normalizedPath = path.normalize(filepath).replace(/\\/g, '/');
            const fileHeader = `--- START FILE: ./${normalizedPath} ---\n`;
            const fileFooter = `\n--- END FILE: ./${normalizedPath} ---\n\n`;
            
            fs.appendFileSync(config.outputFile, fileHeader);
            fs.appendFileSync(config.outputFile, content);
            fs.appendFileSync(config.outputFile, fileFooter);
        } catch (err) {
            console.error(`L·ªói khi ƒë·ªçc file ${filepath}:`, err);
        }
    });

    console.log(`\x1b[32m%s\x1b[0m`, `‚úÖ ƒê√£ t·∫°o th√†nh c√¥ng file '${config.outputFile}' v·ªõi ${allFiles.length} file.`);
}

// Ch·∫°y h√†m ch√≠nh
createSnapshot();
--- END FILE: ./create_snapshot.js ---

--- START FILE: ./dashboard.css ---
/* Version 6.6 - Compact SKNV detail view for better balance */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
    --global-font-size: 18px;
    --kpi-main-font-size: 36px;
    --bg-lightness-1: 98%; --header-lightness-1: 96%; --header-text-lightness-1: 25%; --special-header-lightness-1: 92%; --below-target-lightness-1: 96%;
    --bg-lightness-2: 96%; --header-lightness-2: 94%; --header-text-lightness-2: 22%; --special-header-lightness-2: 88%; --below-target-lightness-2: 94%;
    --bg-lightness-3: 94%; --header-lightness-3: 92%; --header-text-lightness-3: 18%; --special-header-lightness-3: 85%; --below-target-lightness-3: 92%; /* Normal */
    --bg-lightness-4: 92%; --header-lightness-4: 88%; --header-text-lightness-4: 15%; --special-header-lightness-4: 80%; --below-target-lightness-4: 88%;
    --bg-lightness-5: 90%; --header-lightness-5: 84%; --header-text-lightness-5: 12%; --special-header-lightness-5: 75%; --below-target-lightness-5: 84%;
    --bg-lightness-6: 88%; --header-lightness-6: 80%; --header-text-lightness-6: 10%; --special-header-lightness-6: 70%; --below-target-lightness-6: 80%;
    --kpi-card-1-bg: #38bdf8;
    --kpi-card-2-bg: #34d399; --kpi-card-3-bg: #fbbf24;
    --kpi-card-4-bg: #2dd4bf; --kpi-card-5-bg: #a78bfa; --kpi-card-6-bg: #f472b6;
    --kpi-card-7-bg: #818cf8;
    --kpi-card-8-bg: #f87171;
    --kpi-title-color: #ffffff;
    --kpi-main-color: #ffffff;
    --kpi-sub-color: #ffffff;
}

body {
    font-family: 'Inter', sans-serif;
    background-color: #f3f4f6;
    font-size: var(--global-font-size);
}

html[data-contrast="1"] { --bg-lightness: var(--bg-lightness-1); --header-lightness: var(--header-lightness-1); --header-text-lightness: var(--header-text-lightness-1); --special-header-lightness: var(--special-header-lightness-1); --below-target-lightness: var(--below-target-lightness-1); }
html[data-contrast="2"] { --bg-lightness: var(--bg-lightness-2); --header-lightness: var(--header-lightness-2); --header-text-lightness: var(--header-text-lightness-2); --special-header-lightness: var(--special-header-lightness-2); --below-target-lightness: var(--below-target-lightness-2); }
html[data-contrast="3"] { --bg-lightness: var(--bg-lightness-3); --header-lightness: var(--header-lightness-3); --header-text-lightness: var(--header-text-lightness-3); --special-header-lightness: var(--special-header-lightness-3); --below-target-lightness: var(--below-target-lightness-3); }
html[data-contrast="4"] { --bg-lightness: var(--bg-lightness-4); --header-lightness: var(--header-lightness-4); --header-text-lightness: var(--header-text-lightness-4); --special-header-lightness: var(--special-header-lightness-4); --below-target-lightness: var(--below-target-lightness-4); }
html[data-contrast="5"] { --bg-lightness: var(--bg-lightness-5); --header-lightness: var(--header-lightness-5); --header-text-lightness: var(--header-text-lightness-5); --special-header-lightness: var(--special-header-lightness-5); --below-target-lightness: var(--below-target-lightness-5); }
html[data-contrast="6"] { --bg-lightness: var(--bg-lightness-6); --header-lightness: var(--header-lightness-6); --header-text-lightness: var(--header-text-lightness-6); --special-header-lightness: var(--special-header-lightness-6); --below-target-lightness: var(--below-target-lightness-6); }


::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: #555; }

#sidebar { width: 68px; transition: width 0.3s ease-in-out; overflow-x: hidden; }
#sidebar:hover { width: 256px; }
#sidebar.menu-locked:hover { width: 68px; }

#sidebar .nav-link, #sidebar button {
    white-space: nowrap;
    gap: 1rem;
    justify-content: flex-start; /* FIX: Canh l·ªÅ tr√°i cho icon v√† text */
}

.menu-text {
    transition: opacity 0.2s ease-in-out, width 0.3s ease-in-out;
    opacity: 0;
    white-space: nowrap;
    width: 0;
    overflow: hidden;
}
#sidebar:hover .menu-text {
    opacity: 1;
    transition-delay: 0.1s;
    width: auto;
}
#sidebar.menu-locked:hover .menu-text {
    opacity: 0;
    width: 0;
}

#main-content { transition: margin-left 0.3s ease-in-out; margin-left: 68px; }

.nav-link,
.action-btn,
.kpi-card,
.content-card,
.tdv-item-card,
.data-input-group,
.toggle-filters-btn,
.page-header__help-btn,
.column-toggle-btn {
    transition: all 0.2s ease-in-out;
}

/* === B·∫ÆT ƒê·∫¶U: N√ÇNG C·∫§P UI CHO SUB-TAB (V5.9) === */
.sub-tab-btn {
    border-bottom: 3px solid transparent;
    padding: 0.75rem 0.5rem;
    transition: all 0.2s ease-in-out;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}
.sub-tab-btn:not(.active):hover {
    background-color: #f3f4f6;
    border-bottom-color: #d1d5db;
    transform: translateY(-2px);
}
.sub-tab-btn.active {
    border-color: #3b82f6;
    color: #2563eb;
    background-color: transparent;
}
.sub-tab-btn .feather {
    width: 1.2rem;
    height: 1.2rem;
    stroke-width: 2.5;
    transition: all 0.2s ease-in-out;
}
.sub-tab-btn.active .feather {
    color: white;
    background-color: #3b82f6;
    border-radius: 9999px;
    padding: 4px;
}
/* T√¥ m√†u icon theo t·ª´ng tab */
.sub-tab-btn[data-title*="SieuThi"].active .feather,
.sub-tab-btn[data-title*="Vung"].active .feather { background-color: #3b82f6; } /* Blue */

.sub-tab-btn[data-title*="SKNV"].active .feather,
.sub-tab-btn[data-title*="ThuNhap"].active .feather,
.sub-tab-btn[data-title*="DoanhThuLK"].active .feather,
.sub-tab-btn[data-title*="DTNVRealtime"].active .feather { background-color: #16a34a; } /* Green */

.sub-tab-btn[data-title*="ThiDua"].active .feather { background-color: #8b5cf6; } /* Violet */

.sub-tab-btn[data-title*="HieuQua"].active .feather,
.sub-tab-btn[data-title*="NganhHang"].active .feather,
.sub-tab-btn[data-title*="HangRealtime"].active .feather { background-color: #f97316; } /* Orange */
/* === K·∫æT TH√öC: N√ÇNG C·∫§P UI CHO SUB-TAB === */


.nav-link:hover,
.action-btn:hover,
.kpi-card:hover,
.content-card:hover,
.data-input-group:hover,
.toggle-filters-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.tdv-item-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}
.page-header__help-btn:hover {
    transform: scale(1.1) translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.settings-drawer { width: 400px; max-width: 90vw; transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
.settings-drawer.open { transform: translateX(0); }
.close-drawer-btn { font-size: 2rem; line-height: 1; }
input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #e5e7eb; border-radius: 5px; outline: none; transition: background 0.2s; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }

.page-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
.page-header__title { font-size: 1.75rem; font-weight: 700; color: #1f2937; }
.content-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); padding: 1rem 1.5rem; margin-bottom: 2rem; border: 1px solid #e5e7eb; }
.content-card__header { display: flex; align-items: center; justify-content: space-between; font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; }

#notification { position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; z-index: 1200; opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(100px); }
#notification.show { opacity: 1; transform: translateY(0); }
.notification-success { background-color: #28a745; }
.notification-error { background-color: #dc3545; }
.placeholder-message { border: 2px dashed #f59e0b; background-color: #fffbeb; color: #b45309; padding: 2rem; border-radius: 0.75rem; text-align: center; font-weight: 600; }

[id$='-subtabs-nav'] { flex-wrap: wrap; }
.sortable { cursor: pointer; position: relative; user-select: none; }
.sort-indicator { display: inline-flex; flex-direction: column; align-items: center; justify-content: center; width: 1em; height: 1em; margin-left: 4px; vertical-align: middle; color: #9ca3af; transition: color 0.2s ease-in-out; }
.sortable .sort-indicator::before { content: '‚ñ≤'; font-size: 0.8em; line-height: 0.5; opacity: 0.4; }
.sortable .sort-indicator::after { content: '‚ñº'; font-size: 0.8em; line-height: 0.5; opacity: 0.4; }
.sortable:hover .sort-indicator { color: #374151; }
.sortable.sorted-asc .sort-indicator::before { opacity: 1; color: #3b82f6; }
.sortable.sorted-asc .sort-indicator::after { opacity: 0.4; }
.sortable.sorted-desc .sort-indicator::after { opacity: 1; color: #3b82f6; }
.sortable.sorted-desc .sort-indicator::before { opacity: 0.4; }

.data-input-group {
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem;
    background-color: #f9fafb;
    display: flex;
    flex-direction: column;
    border-top: 4px solid #9ca3af;
}

#data-section > .content-card:nth-of-type(1) .data-input-group { border-top-color: #3b82f6; }
#data-section > .content-card:nth-of-type(3) .data-input-group { border-top-color: #8b5cf6; }
.data-input-group__label { font-weight: 600; color: #4b5563; margin-bottom: 0.75rem; }
.data-input-group__label--link { text-decoration: none; display: inline-block; }
.data-input-group__label--link:hover { text-decoration: underline; color: #2563eb; }
.data-input-group__label--link > .font-normal { font-weight: 400; }
.data-input-group__content { display: flex; flex-direction: column; gap: 0.5rem; flex-grow: 1; }
.data-input-group__file-trigger { cursor: pointer; background-color: #e5e7eb; color: #374151; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875em; font-weight: 500; white-space: nowrap; }
.data-input-group__file-trigger:hover { background-color: #d1d5db; }
.data-input-group__file-name { font-size: 0.875em; color: #6b7280; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.data-input-group__link { color: #2563eb; text-decoration: none; font-size: 0.875em; }
.data-input-group__link:hover { text-decoration: underline; }
.data-input-group__status-wrapper { min-height: 1rem; margin-top: 0.25rem; }
.data-input-group__status-text { font-size: 0.875em; font-weight: 500; }
.data-input-group__status-text--default { color: #6b7280;
}
.data-input-group__status-text--success { color: #16a34a; }
.data-input-group__status-text--error { color: #dc2626; }
.data-textarea { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875em; font-family: 'Inter', sans-serif; }
.data-textarea:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: #3b82f6; box-shadow: 0 0 0 1px #3b82f6; }
.progress-bar-container { overflow: hidden; }
.progress-bar { background-image: linear-gradient(45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent); background-size: 1rem 1rem; animation: progress-bar-stripes 1s linear infinite; }
@keyframes progress-bar-stripes { from { background-position: 1rem 0; } to { background-position: 0 0; } }

.table-bordered { border-collapse: collapse; }
.table-bordered th, .table-bordered td { border: 1px solid #e5e7eb; }
.table-striped tbody tr:nth-child(even) { background-color: #f9fafb; }
.table-footer { background-color: hsl(210, 20%, var(--header-lightness));
border-top: 2px solid #9ca3af; }
.cell-performance.is-below { background-color: hsl(0, 80%, var(--below-target-lightness)) !important; }
.header-bg-blue { background-color: hsl(217, 95%, var(--special-header-lightness)) !important; color: hsl(217, 80%, var(--header-text-lightness)) !important; }
.header-bg-green { background-color: hsl(145, 80%, var(--special-header-lightness)) !important; color: hsl(145, 70%, var(--header-text-lightness)) !important; }
.header-bg-yellow { background-color: hsl(45, 95%, var(--special-header-lightness)) !important; color: hsl(45, 80%, var(--header-text-lightness)) !important; }

.interactive-row {
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    cursor: pointer; /* Ensure interactive rows are clickable */
}
.interactive-row:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    background-color: #eff6ff;
}
.interactive-row .employee-name-cell {
    cursor: pointer;
    color: #2563eb;
    transition: color 0.2s ease-out;
}
.interactive-row:hover .employee-name-cell {
    text-decoration: underline;
    color: #1d4ed8;
}

.header-group-1 { background-color: hsl(30, 90%, var(--header-lightness)); }
.header-group-2 { background-color: hsl(90, 90%, var(--header-lightness)); }
.header-group-3 { background-color: hsl(180, 90%, var(--header-lightness)); }
.header-group-4 { background-color: hsl(240, 90%, var(--header-lightness)); }
.header-group-5 { background-color: hsl(300, 90%, var(--header-lightness)); }
.header-group-6 { background-color: hsl(0, 90%, var(--header-lightness)); }
.header-group-7 { background-color: hsl(160, 80%, var(--header-lightness)) !important; }
.header-group-8 { background-color: hsl(280, 80%, var(--header-lightness)) !important; }
.header-group-9 { background-color: hsl(70, 80%, var(--header-lightness)) !important; }
.header-group-10 { background-color: hsl(190, 80%, var(--header-lightness)) !important; }
.header-group-11 { background-color: hsl(340, 80%, var(--header-lightness)) !important; }
.header-group-12 { background-color: hsl(20, 80%, var(--header-lightness)) !important; }

.income-positive { color: #16a34a; }
.income-negative { color: #dc2626; }
.line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.department-header-tv { background-color: #e0e7ff;
color: #3730a3; }
.department-header-kho { background-color: #d1fae5; color: #065f46; }
.department-header-tt { background-color: #fef3c7; color: #92400e; }
.category-header-ict { background-color: #dbeafe; color: #1e40af; }
.category-header-phukien { background-color: #fee2e2; color: #991b1b; }
.category-header-giadung { background-color: #fef9c3; color: #854d0e; }
.category-header-ce { background-color: #e0f2fe; color: #0c4a6e; }
.category-header-baohiem { background-color: #f3e8ff; color: #6b21a8; }
.header-bg-indigo { background-color: #e0e7ff; color: #3730a3; }
.header-bg-purple { background-color: #f3e8ff; color: #6b21a8; }
.qdc-group-title { font-weight: 600; }
.qdc-group-ict { background-color: hsl(190, 80%, var(--special-header-lightness)); }
.qdc-group-vas { background-color: hsl(140, 80%, var(--special-header-lightness)); }
.qdc-group-giadung { background-color: hsl(0, 80%, var(--special-header-lightness)); }
.qdc-group-sim { background-color: hsl(40, 80%, var(--special-header-lightness)); }
.competition-header-doanhthu { border-color: #a78bfa; background-color: hsl(260, 90%, var(--bg-lightness)); }
.competition-header-soluong { border-color: #facc15; background-color: hsl(50, 90%, var(--bg-lightness)); }
.header-highlight-special { background-color: hsl(25, 90%, var(--header-lightness)) !important; }
.competition-row-below-100 td { background-color: #fee2e2; color: #991b1b; }

.header-highlight { background-color: hsl(50, 95%,
var(--special-header-lightness)) !important; }

#dtnv-realtime-employee-selector-container .choices__inner { min-width: 300px; }
#dtnv-realtime-employee-selector-container .choices__list--single { min-width: 300px; }

.kpi-card-title { color: var(--kpi-title-color); opacity: 0.8; font-size: 1em; }
.kpi-card p[id$="-main"] { color: var(--kpi-main-color); font-size: var(--kpi-main-font-size);
transition: font-size 0.2s ease-in-out; }
.kpi-card p[id$="-sub"], .kpi-card p[id$="-sub1"], .kpi-card p[id$="-sub2"] { color: var(--kpi-sub-color); font-size: 1em; }

.kpi-percentage, .kpi-percentage-value { font-weight: 700; }
.kpi-sub-value { opacity: 0.9; }
#luyke-kpi-cards-container .kpi-card:nth-child(1), #realtime-kpi-cards-container .kpi-card:nth-child(1) { background-color: var(--kpi-card-1-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(2), #realtime-kpi-cards-container .kpi-card:nth-child(2) { background-color: var(--kpi-card-2-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(3), #realtime-kpi-cards-container .kpi-card:nth-child(3) { background-color: var(--kpi-card-3-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(4), #realtime-kpi-cards-container .kpi-card:nth-child(4) { background-color: var(--kpi-card-4-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(5) { background-color: var(--kpi-card-5-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(6) { background-color: var(--kpi-card-6-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(7) { background-color: var(--kpi-card-7-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(8) { background-color: var(--kpi-card-8-bg); }

#sknv-details-container .sknv-subtable-header th { font-size: 0.875em; font-weight: 600; background-color: #f3f4f6; }
.choices__inner { min-height: 42px; }
.choices__list--multiple .choices__item { background-color: #3b82f6; border-color:
#2563eb; }
.toggle-filters-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; background-color: #f3f4f6; color: #4b5563; font-weight: 500; font-size: 0.875em; cursor: pointer; margin-bottom: 1rem; border: 1px solid #e5e7eb; }
.toggle-filters-btn .icon { width: 1rem; height: 1rem; transition: transform 0.3s ease-in-out; }
.toggle-filters-btn.active .icon { transform: rotate(180deg); }
.highlight-trigger { background: none; border: none; cursor: pointer; color: #6b7280; }
.highlight-trigger:hover { color: #1d4ed8; }
.highlighted-row td { animation: pulse-bg 2s infinite; }
@keyframes pulse-bg { 0% { background-color: var(--highlight-color, #ffff99); } 50% { background-color: var(--highlight-color-light, #ffffcc); } 100% { background-color: var(--highlight-color, #ffff99); } }

.action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 500;
    font-size: 0.875em;
    cursor: pointer;
    border: 1px solid transparent;
}
.action-btn--composer {
background-color: #ede9fe; color: #5b21b6; border-color: #c4b5fd; }
.action-btn--composer:hover { background-color: #d8b4fe; }
.action-btn--export { background-color: #dcfce7; color: #166534; border-color: #86efac; }
.action-btn--export:hover { background-color: #bbf7d0; }
.action-btn--capture { background-color: #dbeafe; color: #1e40af; border-color: #93c5fd; }
.action-btn--capture:hover { background-color: #bfdbfe; }
.action-btn--save { background-color: #16a34a; color: white; }
.action-btn--save:hover { background-color: #15803d; }
.action-btn--copy { background-color: #2563eb; color: white; }
.action-btn--copy:hover { background-color: #1d4ed8; }
.page-header__help-btn { background-color: #fee2e2; color: #991b1b; border-radius: 9999px; width: 2rem; height: 2rem; display: inline-flex; align-items: center; justify-content: center; border: none; }

.modal { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
.modal.hidden { display: none; }
.modal__overlay { position: absolute; inset: 0; background-color: rgba(17, 24, 39, 0.6); backdrop-filter: blur(4px); cursor: pointer; }
.modal__container { position: relative; z-index: 1001; background-color: white; border-radius: 0.75rem; box-shadow: 0 20px
25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); width: 90%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; }

#force-update-modal .modal__overlay { cursor: not-allowed; }

.modal__container--large { max-width: 900px; }
.modal__header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
.modal__title { font-size: 1.25rem; font-weight: 600; color: #1f2937; }
.modal__close-btn { font-size: 1.75rem; line-height: 1; color: #6b7280; background: none; border: none; cursor: pointer; }
.modal__close-btn:hover { color: #111827; }
.modal__content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
.modal__content h4 { font-size: 1.125rem; font-weight: 600; color: #1e3a8a; margin-bottom: 0.75rem; }
.modal__content p { margin-bottom: 0.75rem; color: #374151; line-height: 1.6; }
.modal__content ul { list-style-type: disc; list-style-position: inside; margin-left: 0.5rem; }
.modal__content ul > *
+ * { margin-top: 0.5rem; }
.modal__footer { padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; background-color: #f9fafb; display: flex; justify-content: flex-end; gap: 0.75rem; flex-shrink: 0; }

.composer { display: flex; flex-direction: column; gap: 1.5rem; }
.composer__editor { flex-grow: 1; }
.composer__tags { width: 100%; }
.composer__label { display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
.composer__textarea { width: 100%; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.875em; resize: vertical; }
.composer__textarea:focus { border-color: #3b82f6; box-shadow: 0 0 0 1px #3b82f6; outline: none; }
.composer__nav { display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 1rem; }
.composer__tab-btn { padding: 0.5rem 1rem; border: none; background-color: transparent; cursor: pointer; font-weight: 500; color: #6b7280; border-bottom: 2px solid transparent; margin-bottom: -1px; font-size: 0.875em; }
.composer__tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; }
.composer__tab-pane {
display: none; }
.composer__tab-pane.active { display: block; }
.composer__tag-group { margin-bottom: 1rem; }
.composer__tag-group:last-child { margin-bottom: 0; }
.composer__tag-group-title { font-weight: 600; font-size: 0.875em; color: #4b5563; margin-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; }
.composer__tag-btn { background-color: #e0e7ff; color: #3730a3; border: 1px solid #c7d2fe; border-radius: 9999px; padding: 0.25rem 0.75rem; font-size: 0.8rem; font-weight: 500; cursor: pointer; margin: 0.25rem; }
.composer__icon-btn { background-color: #f3f4f6; color: #1f2937; border: 1px solid #d1d5db; border-radius: 9999px; padding: 0.25rem 0.75rem; font-size: 1.1rem; font-weight: 500; cursor: pointer; margin: 0.25rem; line-height: 1; }
.composer__filter-group { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; }
.composer__select { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: white; }
@media (min-width: 768px) { .composer { flex-direction: row; } .composer__tags { width: 350px; flex-shrink: 0; border-left: 1px
solid #e5e7eb; padding-left: 1.5rem; } }

.view-switcher { display: flex; align-items: center; padding: 0.25rem; background-color: #e5e7eb; border-radius: 0.5rem; }
.view-switcher__btn { padding: 0.5rem 1rem; border: none; background-color: transparent; border-radius: 0.375rem; font-weight: 500; color: #4b5563; cursor: pointer; }
.view-switcher__btn.active { background-color: white; color: #3b82f6; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }
.infographic-card { border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
.infographic-card__header { padding: 0.75rem 1rem; font-weight: 700; }
.infographic-card__header--completed { background-color: #dcfce7; color: #166534; }
.infographic-card__header--pending { background-color: #fee2e2; color: #991b1b; }
.infographic-card__body { padding: 1rem; background-color: #f9fafb; }
.infographic-card__item { border-bottom: 1px dashed #d1d5db; padding: 0.75rem 0; }
.infographic-card__item:last-child { border-bottom: none; }
.infographic-card__title { font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; }
.infographic-card__metrics { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.5rem 1rem; font-size:
0.875em; }
.metric-label { color: #6b7280; }
.metric-value { font-weight: 600; color: #111827; text-align: right; }
.metric-value.is-negative { color: #ef4444; }
.metric-value.is-positive { color: #22c55e; }

.rt-infographic-container { background-color: #f9fafb; border-radius: 0.75rem; border: 1px solid #e5e7eb; padding: 1.5rem; }
.rt-infographic-header .employee-name { font-size: 1.5rem; font-weight: 800; color: #111827; }
.rt-infographic-header .employee-title { font-size: 1rem; font-weight: 500; color: #6b7280; }
.rt-infographic-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
.rt-infographic-summary-card { background-color: white; border-radius: 0.5rem; padding: 1rem; text-align: center; border: 1px solid #e5e7eb; }
.rt-infographic-summary-card .label { font-size: 0.875em; color: #4b5563; font-weight: 500; }
.rt-infographic-summary-card .value { font-size: 1.75rem; font-weight: 700; color: #3b82f6; margin-top: 0.25rem; }
.rt-infographic-summary-card .value.is-positive { color: #2563eb; }
.rt-infographic-summary-card .value.is-negative { color: #dc2626; }
.rt-infographic-grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 1.5rem; margin-top: 1.5rem; }
@media
(min-width: 1024px) { .rt-infographic-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
.rt-infographic-section h4 { font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem; }
.rt-progress-bar-item { margin-bottom: 0.75rem; }
.rt-progress-bar-label { display: flex; justify-content: space-between; font-size: 0.875em; font-weight: 500; margin-bottom: 0.25rem; }
.rt-progress-bar-container { background-color: #e5e7eb; border-radius: 9999px; height: 0.75rem; overflow: hidden; }
.rt-progress-bar { background-color: #22c55e; height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }
.rt-customer-accordion { max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; }
.rt-customer-header { background-color: white; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; list-style: none; }
.rt-customer-header::-webkit-details-marker { display: none; }
.rt-customer-header:hover { background-color: #f9fafb; }
.rt-customer-header .arrow { transition: transform 0.3s; }
.rt-customer-header .product-count { color: #dc2626; font-weight: bold; }
details[open] > summary
.arrow { transform: rotate(180deg); }
.rt-customer-details { background-color: #f9fafb; padding: 1rem; }
.rt-customer-details table { font-size: 0.8rem; }
.preview-content { background-color: #f3f4f6; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap; word-wrap: break-word; font-size: 0.875em; line-height: 1.6; color: #1f2937; font-family: 'Inter', sans-serif; }

/* === B·∫ÆT ƒê·∫¶U: B·ªê C·ª§C CHO THI ƒêUA V√ôNG & THI ƒêUA L≈®Y K·∫æ (V5.9) === */
.tdv-rows-container { display: flex; flex-direction: column; gap: 1.5rem; }
#subtab-luyke-thi-dua .tdv-row-body {
    display: grid;
    grid-template-columns: 1fr; /* M·∫∑c ƒë·ªãnh 1 c·ªôt cho mobile */
    gap: 1rem;
}
@media (min-width: 768px) { /* 2 c·ªôt cho tablet tr·ªü l√™n */
    #subtab-luyke-thi-dua .tdv-row-body {
        grid-template-columns: repeat(2, 1fr);
    }
}
/* === END: B·ªê C·ª§C M·ªöI === */

.tdv-infographic-card {
    background-color: transparent;
    border: none;
    box-shadow: none;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.tdv-header { text-align: center; margin-bottom: 2rem; }
.tdv-supermarket-name { font-size: 2em; font-weight: bold; color: #005f73; }
.tdv-total-prize-container { margin-top: 0.5rem; font-size: 1.5em; font-weight: bold; }
.tdv-total-prize-label { color: #6b7280; font-weight: normal; }
.tdv-total-prize-value { color: #d90429; margin-left: 0.5rem; }

.tdv-summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1.5rem; margin-bottom: 2rem; }
@media (min-width: 768px) { .tdv-summary-grid { grid-template-columns: repeat(5, 1fr); } }
.tdv-summary-item { background-color: #ffffff; border-radius: 8px;
padding: 1rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; }
.tdv-summary-value { display: block; font-size: 1.75em; font-weight: 700; color: #0a9396; }
.tdv-summary-label { display: block; font-size: 0.9em; color: #4a5568; margin-top: 0.25rem; }

.tdv-row { background-color: #fdfdfd; border-radius: 8px; padding: 1rem; border: 1px solid #dee2e6; }
.tdv-row-title { font-size: 1.2em; font-weight: bold; padding-bottom: 0.75rem; margin-bottom: 1rem; border-bottom: 2px solid; line-height: 1.3; }
.tdv-row-title--prize { border-color: #0d6efd; color: #0d6efd; }
.tdv-row-title--soon-prize { border-color: #e9c46a; color: #e9c46a; }
.tdv-row-title--effort { border-color: #6c757d; color: #6c757d; }
.tdv-row-subtitle { font-size: 0.8em; font-weight: normal; color: #d90429; }

#subtab-thidua-vung .tdv-row-body { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; }
.tdv-row-body--effort { display: block; }

.tdv-item-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 6px;
padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; }
.tdv-item-card__title { font-weight: bold; margin: 0 0 10px 0; color: #333; }
.tdv-progress-bar-container {
    width: 100%;
    background-color: #e9ecef;
    border-radius: 20px;
    height: 28px;
    position: relative;
    font-size: 0.85em;
    font-weight: bold;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
}
.tdv-progress-bar { height: 100%; transition: width 0.5s ease; position: absolute; top: 0; left: 0; }
.tdv-progress-bar--blue { background-color: #0d6efd; }
.tdv-progress-bar--yellow { background-color: #e9c46a; }
.tdv-progress-bar__text {
    position: relative;
    z-index: 1;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
    color: white;
}
.tdv-item-card__details { font-size: 0.85em; color: #555; margin-top: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
.tdv-item-card__details span { display: block; }
.tdv-item-card__details strong { color: #000; }
.tdv-item-card__prize { grid-column: 1 / -1; font-weight:
bold !important; color: #d90429; margin-top: 4px; }

.tdv-effort-subgroup { margin-bottom: 1rem; }
.tdv-effort-subgroup:last-child { margin-bottom: 0; }
.tdv-effort-subgroup__title { font-weight: bold; margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #dee2e6; }
.tdv-effort-subgroup__title--potential { color: #fd7e14; }
.tdv-effort-subgroup__title--major { color: #6c757d; }
.tdv-effort-list { display: flex; flex-wrap: wrap; gap: 8px; }
.tdv-effort-item { background-color: #f1f3f5; color: #495057; padding: 5px 10px; border-radius: 15px; font-size: 0.9em; }

#video-container iframe {
    aspect-ratio: 16 / 9;
    width: 100%;
    height: auto;
    border-radius: 0.5rem;
}

#feedback-list-container {
    max-height: 600px;
    overflow-y: auto;
}
#goal-drawer .choices__inner {
    min-width: 250px;
}

#goal-drawer .choices__list--dropdown,
#goal-drawer .choices__list[aria-expanded] {
    min-width: 100%;
    width: auto;
    word-break: normal;
}

#goal-drawer .choices__list--multiple .choices__item {
    display: inline-flex;
    align-items: center;
    background-color: #3b82f6;
    border: 1px
solid #2563eb;
    color: white;
    border-radius: 9999px;
    padding: 2px 8px;
    font-size: 0.8em;
    font-weight: 500;
    margin: 2px 4px 2px 0;
}
#goal-drawer .choices__inner {
    height: auto !important;
    min-height: 42px !important;
    display: flex !important;
    flex-wrap: wrap !important;
}
.header-qr-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  border: 2px solid #ef4444; /* red-500 */
  padding: 4px;
  border-radius: 8px;
  background-color: white;
}
.header-qr-container span {
  font-size: 0.75rem; /* 12px */
  font-weight: 600;
  color: #b91c1c; /* red-700 */
}
.header-qr-image {
  width: 50px;
  height: 50px;
  background-color: #f3f4f6;
  border-radius: 4px;
}
.selection-item {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out;
}
.selection-item:hover {
    background-color: #f3f4f6; /* gray-100 */
}
.selection-item input[type="checkbox"] {
    width: 1rem;
    height: 1rem;
    margin-right: 0.75rem;
}
.selection-item label {
    flex-grow: 1;
    cursor: pointer;
}
.settings-trigger-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: #9ca3af; /* gray-400 */
    transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
    padding: 2px;
}
.settings-trigger-btn:hover {
    color: #3b82f6; /* blue-500 */
    transform: rotate(45deg);
}
.settings-trigger-btn svg {
    width: 18px;
    height: 18px;
    display: block;
}

#version-marquee-container {
    flex-grow: 1;
    margin: 0 1.5rem;
    overflow: hidden;
    position: relative;
    background-color: #eef2ff;
    border: 1px solid #c7d2fe;
    border-radius: 9999px;
    cursor: pointer;
    height: 38px;
}
#version-marquee-container:hover .marquee-text {
    animation-play-state: paused;
    color: #312e81;
}
.marquee-text {
    position: absolute;
    white-space: nowrap;
    will-change: transform;
    animation: marquee-scroll 25s linear infinite;
    font-weight: 600;
    color: #4338ca;
    line-height: 36px;
}
@keyframes marquee-scroll {
    from {
        transform: translateX(100%);
    }
    to {
        transform: translateX(-100%);
    }
}

.competition-summary-counter strong {
    font-size: 1.15rem !important;
    font-weight: 800 !important;
    white-space: nowrap;
}
.competition-summary-counter .text-blue-600 {
    color: #2563eb !important;
}
.competition-summary-counter .text-red-600 {
    color: #dc2626 !important;
}

.column-toggle-btn {
    padding: 4px 12px;
    font-size: 12px;
    font-weight: 500;
    border: 1px solid;
    border-radius: 9999px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    user-select: none;
}

.column-toggle-btn.active {
    background-color: #3b82f6; /* blue-500 */
    color: white;
    border-color: #3b82f6;
}

.column-toggle-btn:not(.active) {
    background-color: #e5e7eb; /* gray-200 */
    color: #374151; /* gray-700 */
    border-color: #d1d5db; /* gray-300 */
}

.column-toggle-btn:not(.active):hover {
    background-color: #d1d5db; /* gray-300 */
}

.draggable-header {
    cursor: move;
    cursor: grab;
}
.draggable-header:active {
    cursor: grabbing;
}
.sortable-ghost {
    opacity: 0.4;
    background-color: #c7d2fe; /* indigo-200 */
}

.column-toggle-btn.draggable-tag {
    cursor: grab;
}
.column-toggle-btn.draggable-tag:active {
    cursor: grabbing;
}
.column-toggle-btn.draggable-tag:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.drag-handle-icon {
    color: #6b7280;
    transition: color 0.2s ease-in-out;
}
.column-toggle-btn.draggable-tag:hover .drag-handle-icon {
    color: #1f2937;
}
.sortable-drag {
    opacity: 0.95;
    transform: rotate(-2deg);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}

.action-btn,
.nav-link,
.view-switcher__btn,
.toggle-filters-btn,
.page-header__help-btn
{
    display: inline-flex;
    align-items: center;
    /* justify-content: center; */ /* B·ªã lo·∫°i b·ªè ƒë·ªÉ s·ª≠a l·ªói sidebar */
    gap: 0.5rem;
}

.feather {
    width: 1.1rem;
    height: 1.1rem;
    stroke-width: 1.5;
    flex-shrink: 0;
}

#sidebar .feather {
    width: 1.5rem;
    height: 1.5rem;
    stroke-width: 2;
}

.page-header__help-btn .feather {
    width: 1.25rem;
    height: 1.25rem;
}

.luyke-detail-header h3 {
    font-size: 1.75rem; font-weight: 800; color: #111827; text-align: center;
}
.luyke-detail-progress-item {
    display: flex; flex-direction: column; gap: 4px;
}
.luyke-detail-progress-label {
    display: flex; justify-content: space-between; align-items: baseline; font-size: 0.875rem;
}
.luyke-detail-progress-values {
    display: flex; justify-content: space-between; font-size: 0.75rem; color: #4b5563;
}
.luyke-detail-chart-container {
    position: relative; height: 350px; width: 100%;
}
.customer-accordion-luyke summary {
    display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; padding: 0.5rem 1rem; cursor: pointer; list-style: none;
}
.customer-accordion-luyke summary:hover {
    background-color: #f9fafb;
}
.customer-accordion-luyke .customer-name-small {
    font-weight: 600; font-size: 0.9rem; color: #1f2937; flex-grow:
1; min-width: 120px;
}
.customer-accordion-luyke .order-metrics {
    display: flex; align-items: center; gap: 1rem; flex-shrink: 0; font-size: 0.75rem;
}
.customer-accordion-luyke .order-metrics span {
    white-space: nowrap;
}
.customer-accordion-luyke .accordion-arrow {
    margin-left: auto; color: #9ca3af; transition: transform 0.2s ease-in-out;
}
.customer-accordion-luyke details[open] > summary .accordion-arrow {
    transform: rotate(180deg);
}
.customer-accordion-luyke .product-list-scrollable {
    display: block;
    max-height: 200px;
    overflow-y: auto;
}
.customer-accordion-luyke .product-list-table {
    width: 100%;
}
.customer-accordion-luyke .qd-below-target { color: #b91c1c; }
.customer-accordion-luyke .qd-above-target { color: #1d4ed8; }

/* === START: SKNV INFOGRAPHIC CARD STYLES (V6.0) === */
.sknv-summary-grid {
    display: grid;
    grid-template-columns: 1fr; /* Default to 1 column for mobile */
    gap: 1.5rem;
}

@media (min-width: 768px) { /* 2 columns for tablets */
    .sknv-summary-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 1280px) { /* 4 columns for large desktops */
    .sknv-summary-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

.sknv-card {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 1rem; /* UPDATED: Compact padding */
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* UPDATED: Softer shadow */
    display: flex;
    flex-direction: column;
    gap: 0.75rem; /* UPDATED: Reduced gap */
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    cursor: pointer;
    position: relative; /* Added for medal positioning */
}
.sknv-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
}

.sknv-card__header {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.sknv-card__avatar {
    width: 48px;
    height: 48px;
    border-radius: 9999px;
    background-color: #eef2ff;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.sknv-card__avatar svg {
    width: 24px;
    height: 24px;
    color: #4338ca;
}

.sknv-card__info {
    flex-grow: 1;
    min-width: 0;
}
.sknv-card__info .name {
    font-weight: 700;
    color: #111827;
    line-height: 1.25;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
}

.sknv-card__info .id {
    font-size: 0.875rem;
    color: #6b7280;
}

.sknv-card__main-kpi {
    text-align: center;
    margin: 0.25rem 0; /* UPDATED: Reduced margin */
}

.sknv-card__main-kpi .value {
    font-size: 2.5rem; /* UPDATED: Reduced font size */
    font-weight: 800;
    line-height: 1;
    color: #4b5563;
}

.sknv-card__main-kpi .total {
    font-size: 1.25rem; /* UPDATED */
    font-weight: 600;
    color: #9ca3af;
}

.sknv-card__main-kpi .label {
    display: block;
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.25rem;
    font-weight: 500;
}

.sknv-card-kpi-strong { border-top: 4px solid #16a34a; } /* UPDATED: Added top border */
.sknv-card-kpi-medium { border-top: 4px solid #f59e0b; } /* UPDATED: Added top border */
.sknv-card-kpi-weak { border-top: 4px solid #ef4444; } /* UPDATED: Added top border */
.sknv-card-kpi-strong .value { color: #16a34a; }
.sknv-card-kpi-medium .value { color: #f59e0b; }
.sknv-card-kpi-weak .value { color: #ef4444; }

.sknv-card__sub-kpi-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem; /* UPDATED: Reduced gap */
    border-top: 1px solid #f3f4f6;
    padding-top: 0.75rem; /* UPDATED: Reduced padding */
}

.sknv-card__sub-kpi-item {
    background-color: #f9fafb;
    border-radius: 0.5rem;
    padding: 0.5rem; /* UPDATED: Reduced padding */
    text-align: center;
    transition: background-color 0.2s ease-in-out;
}

/* === START: NEW SUB-KPI LAYOUT === */
.sknv-card__sub-kpi-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
}
.sknv-card__sub-kpi-header .feather {
    width: 1rem;
    height: 1rem;
    stroke-width: 2;
    color: #6b7280;
}
.sknv-card__sub-kpi-header .label {
    font-size: 0.7rem;
    font-weight: 600;
    color: #4b5563;
}
.sknv-card__sub-kpi-item .value {
    font-size: 0.875rem;
    font-weight: 700;
    margin-top: 2px;
    display: block; /* Ensures it's on a new line */
}
/* === END: NEW SUB-KPI LAYOUT === */

.sknv-card__sub-kpi-item.strong { border-bottom: 3px solid #22c55e; }
.sknv-card__sub-kpi-item.medium { border-bottom: 3px solid #f59e0b; }
.sknv-card__sub-kpi-item.weak { border-bottom: 3px solid #ef4444; }
/* === END: SKNV INFOGRAPHIC CARD STYLES === */

/* === START: SKNV Department Grouping Styles (V6.1) === */
.sknv-department-group {
    margin-bottom: 2.5rem; /* Space between department groups */
}

.sknv-department-group:last-child {
    margin-bottom: 1rem; /* Less space for the last group */
}

.sknv-department-header {
    font-size: 1.6rem;
    font-weight: 700;
    color: #1f2937; /* Dark gray for general headers */
    padding-bottom: 0.75rem;
    margin-bottom: 1.5rem;
    border-bottom: 3px solid #d1d5db; /* Light gray border */
    position: relative;
    padding-left: 0.5rem;
}

.sknv-department-header--priority {
    color: #2563eb; /* Blue for priority department */
    border-bottom-color: #3b82f6; /* Matching blue border */
    background-color: #e0f2fe; /* Light blue background */
    padding: 0.75rem 1rem;
    border-radius: 0.5rem 0.5rem 0 0;
    margin-bottom: 0; /* Remove bottom margin to connect with cards */
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.sknv-department-header--priority::before {
    content: '\f02e'; /* Font Awesome 'flag' icon - if Font Awesome is available */
    font-family: 'Font Awesome 5 Free'; /* Specify font family */
    font-weight: 900; /* For solid icon style */
    font-size: 1.25rem;
    color: #2563eb;
}

/* Adjust grid gap and padding for priority department to integrate better */
.sknv-department-header--priority + .sknv-summary-grid {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    margin-top: 0; /* Remove top margin */
    padding-top: 1.5rem; /* Add padding inside grid */
    border: 1px solid #c7d2fe;
    background-color: #f3f4f6; /* Slightly different background */
    padding-left: 1rem;
    padding-right: 1rem;
    padding-bottom: 1rem;
    border-top: none;
}
/* === END: SKNV Department Grouping Styles === */

/* === START: SKNV DETAIL VIEW & MEDALS (V6.4) === */
/* NEW: Wrapper for compact detail view */
#sknv-detail-capture-area {
    max-width: 1100px;
    margin: 0 auto;
}
.sknv-detail-header-card {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding: 1rem; /* UPDATED: Compact padding */
    background-color: #eff6ff; /* blue-50 */
    border: 1px solid #dbeafe; /* blue-200 */
    border-top: 4px solid #3b82f6; /* blue-500 */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
}
.sknv-detail-avatar {
    width: 64px;
    height: 64px;
    border-radius: 9999px;
    background-color: #dbeafe; /* blue-200 */
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.sknv-detail-avatar svg {
    width: 32px;
    height: 32px;
    color: #1e40af; /* blue-800 */
}
.sknv-detail-info .name {
    color: #1e40af; /* UPDATED: Dark blue color */
}
.sknv-detail-info .department,
.sknv-detail-info .kpi-summary {
    color: #1f2937; /* dark text */
}
.sknv-detail-info .kpi-summary .font-bold {
    color: #1d4ed8; /* darker blue */
}
.sknv-detail-info .name {
    font-size: 1.5rem;
    font-weight: 800;
    line-height: 1.2;
}
.sknv-detail-info .department {
    font-size: 1rem;
    font-weight: 500;
}
.sknv-detail-info .kpi-summary {
    margin-top: 0.5rem;
    font-weight: 600;
}

.sknv-detail-card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem; /* UPDATED: Compact padding */
    color: #ffffff;
}
.sknv-detail-card-header .header-icon {
    width: 20px;
    height: 20px;
}
.sknv-header-blue { background-color: #2563eb; }
.sknv-header-green { background-color: #16a34a; }
.sknv-header-orange { background-color: #f97316; }
.sknv-header-yellow { background-color: #ca8a04; }
.sknv-header-indigo { background-color: #4f46e5; }
.sknv-header-purple { background-color: #7e22ce; }

.sknv-detail-grid-body {
    padding: 0.75rem 1rem; /* UPDATED: Compact padding */
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* UPDATED */
    gap: 0.75rem; /* UPDATED */
}
.sknv-detail-metric-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 0.5rem; /* UPDATED: Compact padding */
    background-color: #f9fafb;
    border-radius: 0.5rem;
    border: 1px solid #f3f4f6;
    transition: all 0.2s ease-in-out;
}
.sknv-detail-metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
}
.sknv-detail-metric-card .label {
    font-weight: 600;
    font-size: 0.8rem; /* UPDATED */
    color: #374151;
}
.sknv-detail-metric-card .value {
    font-weight: 700; /* UPDATED */
    font-size: 1.375rem; /* UPDATED: Reduced font size */
    line-height: 1.2;
    color: #111827;
    margin: 0.25rem 0;
}
.sknv-detail-metric-card .average {
    font-size: 0.7rem; /* UPDATED */
    color: #6b7280;
    font-style: italic;
}
.sknv-detail-metric-card .evaluation-badge {
    margin-top: 0.5rem;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 9999px;
    font-size: 0.7rem; /* UPDATED */
}
.evaluation-badge.text-green-600 { background-color: #dcfce7; }
.evaluation-badge.text-yellow-600 { background-color: #fef9c3; }

.medal-container {
    position: absolute; /* Changed for positioning */
    top: -8px; /* Position it slightly outside the card */
    left: 12px;
    width: 32px; /* Reduced size */
    height: 32px;
    flex-shrink: 0;
}
.medal-container svg {
    width: 100%;
    height: 100%;
    display: block;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); /* Add a nice shadow */
}

/* NEW: Compact tables in detail view */
#sknv-details-container .sknv-subtable-header {
    font-size: 0.8rem;
}
#sknv-details-container .table-bordered td,
#sknv-details-container .table-bordered th {
    padding: 0.5rem;
}
/* === END: SKNV DETAIL VIEW & MEDALS === */
--- END FILE: ./dashboard.css ---

--- START FILE: ./event-listeners/listeners-actions.js ---
// Version 1.0 - Refactored from ui-listeners.js
// MODULE: LISTENERS - ACTIONS
// Ch·ª©a logic ƒëƒÉng k√Ω s·ª± ki·ªán cho c√°c n√∫t h√†nh ƒë·ªông chung (Ch·ª•p ·∫£nh, Xu·∫•t Excel).

import { ui } from '../ui.js';
import { utils } from '../utils.js';
import { captureService } from '../modules/capture.service.js';

export function initializeActionListeners() {
    ['luyke', 'sknv', 'realtime'].forEach(prefix => {
        const captureBtn = document.getElementById(`capture-${prefix}-btn`);
        if (captureBtn) {
            captureBtn.addEventListener('click', () => {
                const navId = prefix === 'luyke' ? 'luyke-subtabs-nav' : (prefix === 'sknv' ? 'employee-subtabs-nav' : 'realtime-subtabs-nav');
                const contentContainerId = prefix === 'luyke' ? 'luyke-subtabs-content' : (prefix === 'sknv' ? 'employee-subtabs-content' : 'realtime-subtabs-content');

                const activeTabButton = document.querySelector(`#${navId} .sub-tab-btn.active`);
                if (!activeTabButton) {
                    ui.showNotification('Kh√¥ng t√¨m th·∫•y tab ƒëang ho·∫°t ƒë·ªông.', 'error');
                    return;
                }
                
                const title = activeTabButton.dataset.title || 'BaoCao';
                let elementToCapture;

                if (prefix === 'luyke' && activeTabButton.dataset.target === 'subtab-luyke-thidua-vung') {
                    elementToCapture = document.getElementById('thidua-vung-infographic-container');
                } else {
                    elementToCapture = document.querySelector(`#${contentContainerId} .sub-tab-content:not(.hidden)`);
                }

                if (!elementToCapture || elementToCapture.children.length === 0) {
                    ui.showNotification('Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ ch·ª•p.', 'error');
                    return;
                }

                captureService.captureDashboardInParts(elementToCapture, title);
            });
        }

        const exportBtn = document.getElementById(`export-${prefix}-btn`);
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                const navId = prefix === 'sknv' ? 'employee-subtabs-nav' : `${prefix}-subtabs-nav`;
                const contentContainerId = prefix === 'sknv' ? 'employee-subtabs-content' : `${prefix}-subtabs-content`;
                
                const activeTabButton = document.querySelector(`#${navId} .sub-tab-btn.active`);
                const activeTabContent = document.querySelector(`#${contentContainerId} .sub-tab-content:not(.hidden)`);
                if (activeTabContent && activeTabButton) {
                    const title = activeTabButton.dataset.title || 'BaoCao';
                    const timestamp = new Date().toLocaleDateString('vi-VN').replace(/\//g, '-');
                    utils.exportTableToExcel(activeTabContent, `${title}_${timestamp}`);
                } else {
                     ui.showNotification('Kh√¥ng t√¨m th·∫•y tab ƒë·ªÉ xu·∫•t.', 'error');
                }
            });
        }
    });
}
--- END FILE: ./event-listeners/listeners-actions.js ---

--- START FILE: ./event-listeners/listeners-collaboration.js ---
// Version 1.0 - Refactored from ui-listeners.js
// MODULE: LISTENERS - COLLABORATION
// Ch·ª©a logic s·ª± ki·ªán cho c√°c t√≠nh nƒÉng h·ª£p t√°c (G√≥p √Ω, Nh·∫≠n x√©t).

import { ui } from '../ui.js';

export function initializeCollaborationListeners(appController) {
    document.body.addEventListener('click', async (e) => {
        const target = e.target;

        // --- Feedback System ---
        if (target.id === 'submit-feedback-btn') {
            appController.handleSubmitFeedback();
        }
        const feedbackItem = target.closest('.feedback-item');
        if (feedbackItem) {
            appController.handleFeedbackReplyActions(e, feedbackItem);
        }
        
        // --- Composer System ---
        const composerTrigger = target.closest('.action-btn--composer');
        if (composerTrigger) {
            const sectionId = composerTrigger.id.split('-')[1];
            appController.prepareAndShowComposer(sectionId);
        }
        const composerModal = target.closest('#composer-modal');
        if (composerModal) {
            appController.handleComposerActions(e, composerModal);
        }
        if (target.id === 'copy-from-preview-btn') {
            ui.copyFromPreview();
        }

        // --- Admin/Declaration System ---
        if (target.id === 'save-help-content-btn') {
            appController.saveHelpContent();
        }
    });
}
--- END FILE: ./event-listeners/listeners-collaboration.js ---

--- START FILE: ./event-listeners/listeners-competition.js ---
// Version 1.0 - Refactored from ui-listeners.js
// MODULE: LISTENERS - COMPETITION
// Ch·ª©a logic s·ª± ki·ªán cho vi·ªác qu·∫£n l√Ω c√°c ch∆∞∆°ng tr√¨nh thi ƒëua.

import { appState } from '../state.js';

export function initializeCompetitionListeners(appController) {
    const goalDrawer = document.getElementById('goal-drawer');
    if (!goalDrawer) return;

    // S·ª≠ d·ª•ng event delegation cho c√°c n√∫t trong danh s√°ch
    goalDrawer.addEventListener('click', (e) => {
        const addBtn = e.target.closest('#add-competition-btn');
        const cancelBtn = e.target.closest('#cancel-competition-btn');
        const editBtn = e.target.closest('.edit-competition-btn');
        const deleteBtn = e.target.closest('.delete-competition-btn');

        if (addBtn) appController._handleCompetitionFormShow(true);
        if (cancelBtn) appController._handleCompetitionFormShow(false);
        if (editBtn) {
            const index = parseInt(editBtn.dataset.index, 10);
            appController._handleCompetitionFormEdit(index);
        }
        if (deleteBtn) {
            const index = parseInt(deleteBtn.dataset.index, 10);
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch∆∞∆°ng tr√¨nh n√†y?')) {
                appController._handleCompetitionDelete(index);
            }
        }
    });

    // G·∫Øn s·ª± ki·ªán cho form
    const form = document.getElementById('competition-form');
    form?.addEventListener('submit', (e) => appController._handleCompetitionFormSubmit(e));
    
    // G·∫Øn s·ª± ki·ªán cho select lo·∫°i thi ƒëua
    const competitionTypeSelect = document.getElementById('competition-type');
    competitionTypeSelect?.addEventListener('change', (e) => {
        const priceSegment = document.getElementById('price-segment');
        if(priceSegment) {
            priceSegment.classList.toggle('hidden', e.target.value !== 'soluong');
        }
    });

    // S·ª≠ d·ª•ng event delegation tr√™n body cho c√°c input target ƒë∆∞·ª£c t·∫°o ƒë·ªông
    document.body.addEventListener('change', (e) => {
        if (e.target.classList.contains('competition-target-input')) {
            const competitionId = e.target.dataset.competitionId;
            const config = appState.competitionConfigs.find(c => c.id === competitionId);
            if (config) {
                config.target = e.target.value; 
            }
            appController.updateAndRenderCurrentTab(); 
        }
    });
}
--- END FILE: ./event-listeners/listeners-competition.js ---

--- START FILE: ./event-listeners/listeners-dragdrop.js ---
// Version 2.1 - Add logging to diagnose re-render issue on drop
// MODULE: LISTENERS - DRAG & DROP
// Ch·ª©a logic kh·ªüi t·∫°o v√† x·ª≠ l√Ω s·ª± ki·ªán k√©o-th·∫£ c·ªôt b·∫±ng SortableJS.

import { settingsService } from '../modules/settings.service.js';

let appController = null;

/**
 * Kh·ªüi t·∫°o SortableJS tr√™n khu v·ª±c ch·ª©a c√°c th·∫ª t√πy ch·ªânh c·ªôt.
 * @param {HTMLElement} container - Ph·∫ßn t·ª≠ DOM ch·ª©a b·∫£ng v√† c√°c n√∫t t√πy ch·ªânh.
 */
function activateSortableOnColumnToggles(container) {
    if (!container) return;

    const toggleContainer = container.querySelector('#efficiency-column-toggles');
    if (!toggleContainer) return;

    // H·ªßy b·ªè instance c≈© n·∫øu c√≥ ƒë·ªÉ tr√°nh l·ªói kh·ªüi t·∫°o nhi·ªÅu l·∫ßn
    if (toggleContainer.sortable) {
        toggleContainer.sortable.destroy();
    }

    // T·∫°o instance m·ªõi
    toggleContainer.sortable = new Sortable(toggleContainer, {
        animation: 150, // Hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªông m∆∞·ª£t m√†
        filter: '.non-draggable', // B·ªè qua c√°c ph·∫ßn t·ª≠ c√≥ class n√†y (v√≠ d·ª•: label "T√πy ch·ªânh c·ªôt:")
        handle: '.drag-handle-icon', // Ch·ªâ cho ph√©p k√©o khi b·∫•m v√†o icon
        onEnd: (evt) => {
            // L·∫•y danh s√°ch c√°c th·∫ª <button> theo th·ª© t·ª± m·ªõi
            const newButtonOrder = Array.from(evt.target.querySelectorAll('button.column-toggle-btn'));
            
            // L·∫•y ra ID c·ªßa c√°c c·ªôt theo th·ª© t·ª± m·ªõi t·ª´ thu·ªôc t√≠nh data-column-id
            const newColumnIdOrder = newButtonOrder.map(btn => btn.dataset.columnId).filter(Boolean);

            // T·∫£i c√†i ƒë·∫∑t hi·ªán t·∫°i
            const currentSettings = settingsService.loadEfficiencyViewSettings();
             
            // T·∫°o m·ªôt Map ƒë·ªÉ truy c·∫≠p nhanh c√°c ƒë·ªëi t∆∞·ª£ng c√†i ƒë·∫∑t theo ID
            const settingsMap = new Map(currentSettings.map(s => [s.id, s]));

            // T·∫°o l·∫°i m·∫£ng c√†i ƒë·∫∑t theo th·ª© t·ª± m·ªõi
            const reorderedSettings = newColumnIdOrder.map(id => settingsMap.get(id));
               
            // Th√™m l·∫°i c√°c c·ªôt ƒë√£ b·ªã ·∫©n (n·∫øu c√≥) v√†o cu·ªëi danh s√°ch ƒë·ªÉ kh√¥ng l√†m m·∫•t ch√∫ng
            currentSettings.forEach(setting => {
                if (!reorderedSettings.find(s => s.id === setting.id)) {
                    reorderedSettings.push(setting);
                }
            });

            // L∆∞u l·∫°i c·∫•u h√¨nh m·ªõi
            settingsService.saveEfficiencyViewSettings(reorderedSettings);

            // V·∫Ω l·∫°i to√†n b·ªô tab ƒë·ªÉ ƒë·ªìng b·ªô header, body, v√† footer c·ªßa b·∫£ng
            if (appController) {
                console.log("LOG: Y√™u c·∫ßu render l·∫°i tab sau khi k√©o th·∫£."); // <<< TH√äM D√íNG N√ÄY ƒê·ªÇ G·ª† L·ªñI
                appController.updateAndRenderCurrentTab();
            }
        }
    });
}


export const dragDroplisteners = {
    /**
     * H√†m kh·ªüi t·∫°o ch√≠nh, nh·∫≠n v√†o controller c·ªßa ·ª©ng d·ª•ng.
     * @param {object} mainAppController - Controller ch√≠nh c·ªßa ·ª©ng d·ª•ng.
     */
    init(mainAppController) {
        appController = mainAppController;
    },
    
    /**
     * H√†m ƒë∆∞·ª£c g·ªçi sau m·ªói l·∫ßn render ƒë·ªÉ k√≠ch ho·∫°t l·∫°i t√≠nh nƒÉng k√©o-th·∫£.
     * @param {string} containerId - ID c·ªßa container ch·ª©a b·∫£ng (v√≠ d·ª•: 'efficiency-report-container').
     */
    initializeForContainer(containerId) {
        const container = document.getElementById(containerId);
        activateSortableOnColumnToggles(container);
    }
};
--- END FILE: ./event-listeners/listeners-dragdrop.js ---

--- START FILE: ./event-listeners/listeners-highlighting.js ---
// Version 1.0 - Refactored from ui-listeners.js
// MODULE: LISTENERS - HIGHLIGHTING
// Ch·ª©a logic s·ª± ki·ªán cho t√≠nh nƒÉng t√¥ m√†u (highlight).

import { appState } from '../state.js';
import { highlightService } from '../modules/highlight.service.js';

/**
 * X·ª≠ l√Ω khi ng∆∞·ªùi d√πng thay ƒë·ªïi l·ª±a ch·ªçn trong c√°c b·ªô l·ªçc highlight.
 * @param {string} prefix - 'luyke', 'sknv', ho·∫∑c 'realtime'.
 * @param {string} type - 'nhanhang', 'nhomhang', ho·∫∑c 'employee'.
 */
function handleHighlightFilterChange(prefix, type) {
    const choicesInstance = appState.choices[`${prefix}_highlight_${type}`];
    if (!choicesInstance) return;

    const values = choicesInstance.getValue(true);
    const color = document.getElementById(`${prefix}-highlight-color`).value;
    
    appState.highlightSettings[prefix] = { type, values, color };
    localStorage.setItem('highlightSettings', JSON.stringify(appState.highlightSettings));
    
    highlightService.applyHighlights(prefix);
}

export function initializeHighlightingListeners(appController) {
    ['luyke', 'sknv', 'realtime'].forEach(prefix => {
        const nhanhangFilter = document.getElementById(`${prefix}-highlight-nhanhang`);
        if (nhanhangFilter) {
            nhanhangFilter.addEventListener('change', () => handleHighlightFilterChange(prefix, 'nhanhang'));
        }

        const nhomhangFilter = document.getElementById(`${prefix}-highlight-nhomhang`);
        if (nhomhangFilter) {
            nhomhangFilter.addEventListener('change', () => handleHighlightFilterChange(prefix, 'nhomhang'));
        }

        const employeeFilter = document.getElementById(`${prefix}-highlight-employee`);
        if (employeeFilter) {
            employeeFilter.addEventListener('change', () => handleHighlightFilterChange(prefix, 'employee'));
        }

        const colorInput = document.getElementById(`${prefix}-highlight-color`);
        if (colorInput) {
            colorInput.addEventListener('input', () => appController.handleHighlightColorChange(prefix));
        }
        
        const clearButton = document.getElementById(`${prefix}-clear-highlight`);
        if (clearButton) {
            clearButton.addEventListener('click', () => appController.handleClearHighlight(prefix));
        }
    });
}
--- END FILE: ./event-listeners/listeners-highlighting.js ---

--- START FILE: ./event-listeners/listeners-settings.js ---
// Version 1.3 - Add event listener for efficiency column toggles
// MODULE: LISTENERS - SETTINGS
// Ch·ª©a logic s·ª± ki·ªán cho c√°c drawers C√†i ƒë·∫∑t v√† c√°c Modals.

import { ui } from '../ui.js';
import { settingsService } from '../modules/settings.service.js';

export function initializeSettingsListeners(appController) {
    // --- Open/Close Modals & Drawers ---
    document.getElementById('admin-access-btn')?.addEventListener('click', () => ui.toggleModal('admin-modal', true));
    document.getElementById('admin-submit-btn')?.addEventListener('click', () => appController.handleAdminLogin());
    document.getElementById('admin-cancel-btn')?.addEventListener('click', () => ui.toggleModal('admin-modal', false));
    document.getElementById('interface-settings-btn')?.addEventListener('click', () => ui.toggleDrawer('interface-drawer', true));
    document.getElementById('goal-settings-btn')?.addEventListener('click', () => ui.toggleDrawer('goal-drawer', true));
    document.querySelectorAll('.close-drawer-btn, #drawer-overlay').forEach(el => el.addEventListener('click', () => ui.closeAllDrawers()));

    // --- Interface Settings ---
    document.querySelectorAll('.contrast-selector').forEach(sel => sel.addEventListener('change', (e) => appController.handleContrastChange(e)));
    document.getElementById('global-font-size-slider')?.addEventListener('input', (e) => settingsService.handleFontSizeChange(e, 'global'));
    document.getElementById('kpi-font-size-slider')?.addEventListener('input', (e) => settingsService.handleFontSizeChange(e, 'kpi'));
    document.querySelectorAll('.kpi-color-input').forEach(picker => picker.addEventListener('input', () => settingsService.saveInterfaceSettings()));

    // --- Goal Settings ---
    document.getElementById('rt-goal-warehouse-select')?.addEventListener('change', () => settingsService.loadAndApplyRealtimeGoalSettings());
    document.getElementById('luyke-goal-warehouse-select')?.addEventListener('change', () => settingsService.loadAndApplyLuykeGoalSettings());
    document.querySelectorAll('.rt-goal-input, .rt-setting-input').forEach(input => input.addEventListener('input', () => {
        settingsService.saveRealtimeGoalSettings();
        appController.updateAndRenderCurrentTab();
    }));
    document.querySelectorAll('.luyke-goal-input').forEach(input => input.addEventListener('input', () => {
        settingsService.saveLuykeGoalSettings();
        appController.updateAndRenderCurrentTab();
    }));
    
    // --- Declaration Settings ---
    document.getElementById('save-declaration-btn')?.addEventListener('click', () => appController.saveDeclarations());

    // --- Global Modals (Help, etc.) & Debug Tool ---
    document.getElementById('toggle-debug-btn')?.addEventListener('click', (e) => ui.toggleDebugTool(e.currentTarget));
    
    // --- Event Delegation for dynamically added elements ---
    document.body.addEventListener('click', (e) => {
        const helpTrigger = e.target.closest('.page-header__help-btn');
        if(helpTrigger) {
            ui.showHelpModal(helpTrigger.dataset.helpId);
        }

        const closeModalTrigger = e.target.closest('[data-close-modal]');
        if (closeModalTrigger) {
            const modal = closeModalTrigger.closest('.modal');
            if(modal) {
                ui.toggleModal(modal.id, false);
            }
        }
        
        const selectionSaveBtn = e.target.closest('#selection-modal-save-btn');
        if (selectionSaveBtn) {
            const modal = document.getElementById('selection-modal');
            const settingType = modal.dataset.settingType;

            const selectedItems = [];
            document.querySelectorAll('#selection-modal-list input[type="checkbox"]:checked').forEach(checkbox => {
                selectedItems.push(checkbox.value);
            });

            if (settingType === 'efficiencyView') {
                // Logic c≈© n√†y v·∫´n c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi modal, nh∆∞ng UI m·ªõi s·∫Ω d√πng logic ri√™ng
                const allItems = settingsService.loadEfficiencyViewSettings();
                const updatedItems = allItems.map(item => ({...item, visible: selectedItems.includes(item.id)}));
                settingsService.saveEfficiencyViewSettings(updatedItems);
            } else if (settingType === 'qdcView') {
                settingsService.saveQdcViewSettings(selectedItems);
            } else if (settingType === 'categoryView') {
                settingsService.saveCategoryViewSettings(selectedItems);
            }

            ui.toggleModal('selection-modal', false);
            ui.showNotification('ƒê√£ l∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã!', 'success');
            appController.updateAndRenderCurrentTab();
        }

        // === B·∫ÆT ƒê·∫¶U LOGIC M·ªöI CHO T√ôY CH·ªàNH C·ªòT ===
        const columnToggleButton = e.target.closest('.column-toggle-btn');
        if (columnToggleButton && columnToggleButton.closest('#efficiency-column-toggles')) {
            e.preventDefault();
            const columnId = columnToggleButton.dataset.columnId;
            
            // 1. T·∫£i c√†i ƒë·∫∑t hi·ªán t·∫°i
            const currentSettings = settingsService.loadEfficiencyViewSettings();
            
            // 2. Thay ƒë·ªïi tr·∫°ng th√°i c·ªßa c·ªôt ƒë∆∞·ª£c nh·∫•p
            const newSettings = currentSettings.map(col => {
                if (col.id === columnId) {
                    return { ...col, visible: !col.visible };
                }
                return col;
            });

            // 3. L∆∞u c√†i ƒë·∫∑t m·ªõi
            settingsService.saveEfficiencyViewSettings(newSettings);
            
            // 4. Render l·∫°i tab ƒë·ªÉ √°p d·ª•ng thay ƒë·ªïi
            appController.updateAndRenderCurrentTab();
        }
        // === K·∫æT TH√öC LOGIC M·ªöI ===
    });

    const searchInput = document.getElementById('selection-modal-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('#selection-modal-list .selection-item').forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                item.style.display = label.includes(searchTerm) ? '' : 'none';
            });
        });
    }
}
--- END FILE: ./event-listeners/listeners-settings.js ---

--- START FILE: ./event-listeners/listeners-sorting.js ---
// Version 1.0 - Refactored from ui-listeners.js
// MODULE: LISTENERS - SORTING
// Ch·ª©a logic s·ª± ki·ªán cho vi·ªác s·∫Øp x·∫øp c√°c b·∫£ng.

import { appState } from '../state.js';

export function initializeSortingListeners(appController) {
    document.body.addEventListener('click', (e) => {
        const header = e.target.closest('.sortable');
        if (!header) return;

        const table = header.closest('table');
        if (!table) return;
        
        const tableType = table.dataset.tableType;
        const sortKey = header.dataset.sort;

        if (!tableType || !sortKey) return;

        const currentState = appState.sortState[tableType] || { key: sortKey, direction: 'desc' };
        
        let newDirection;
        if (currentState.key === sortKey) {
            newDirection = currentState.direction === 'desc' ? 'asc' : 'desc';
        } else {
            newDirection = 'desc';
        }
        
        appState.sortState[tableType] = { key: sortKey, direction: newDirection };

        appController.updateAndRenderCurrentTab();
    });
}
--- END FILE: ./event-listeners/listeners-sorting.js ---

--- START FILE: ./event-listeners/ui-listeners.js ---
// Version 3.12 - Critical Fix: Correct all import paths and update click listener
// MODULE: EVENT LISTENERS INITIALIZER
// File n√†y ƒë√≥ng vai tr√≤ l√† ƒëi·ªÉm kh·ªüi ƒë·∫ßu, import v√† kh·ªüi ch·∫°y t·∫•t c·∫£ c√°c module listener con.

import { appState } from '../state.js';
import { ui } from '../ui.js';
import { services } from '../services.js';
import { luykeTab } from '../tab-luyke.js';
import { sknvTab } from '../tab-sknv.js';
import { uiRealtime } from '../ui-realtime.js';
import { initializeActionListeners } from './listeners-actions.js';
import { initializeCollaborationListeners } from './listeners-collaboration.js';
import { initializeCompetitionListeners } from './listeners-competition.js';
import { initializeHighlightingListeners } from './listeners-highlighting.js';
import { initializeSettingsListeners } from './listeners-settings.js';
import { initializeSortingListeners } from './listeners-sorting.js';
import { dragDroplisteners } from './listeners-dragdrop.js';
import { captureService } from '../modules/capture.service.js';

let appController = null;

// --- HELPERS / HANDLERS ---

async function handleFileInputChange(e) {
    const fileInput = e.target;
    const file = fileInput.files[0];
    const fileType = fileInput.id.replace('file-', '');
    const dataName = fileInput.dataset.name || fileType;
    const stateKey = fileInput.dataset.stateKey;
    if (!file || !stateKey) return;

    ui.updateFileStatus(fileType, file.name, 'ƒêang x·ª≠ l√Ω...', 'default');
    ui.showProgressBar(fileType);

    try {
        const workbook = await appController.handleFileRead(file);
        const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        const normalizeType = fileType.includes('thangtruoc') ? fileType.replace('-thangtruoc', '') : fileType;
        const { normalizedData, success, missingColumns } = services.normalizeData(rawData, normalizeType);
        ui.displayDebugInfo(fileType);

        if (success) {
            appState[stateKey] = normalizedData;
            if (stateKey === 'danhSachNhanVien') {
                services.updateEmployeeMaps();
                ui.populateAllFilters();
            }
            ui.updateFileStatus(fileType, file.name, `‚úì ƒê√£ t·∫£i ${normalizedData.length} d√≤ng.`, 'success');
            ui.showNotification(`T·∫£i th√†nh c√¥ng file "${dataName}"!`, 'success');
            
            if (fileInput.dataset.saveKey) {
                await appController.storage.setItem(fileInput.dataset.saveKey, rawData);
                const savedStatusSpan = document.getElementById(`${fileType}-saved-status`);
                if (savedStatusSpan) savedStatusSpan.textContent = `ƒê√£ l∆∞u ${normalizedData.length} d√≤ng.`;
                ui.showNotification(`ƒê√£ l∆∞u "${dataName}" v√†o b·ªô nh·ªõ ƒë·ªám c·ªßa tr√¨nh duy·ªát.`, 'success');
            }
            appController.updateAndRenderCurrentTab();
        } else {
            const errorMessage = `L·ªói file "${dataName}": Thi·∫øu c·ªôt: ${missingColumns.join(', ')}.`;
            ui.updateFileStatus(fileType, file.name, `L·ªói: Thi·∫øu c·ªôt d·ªØ li·ªáu.`, 'error');
            ui.showNotification(errorMessage, 'error');
            if (document.getElementById('debug-tool-container')?.classList.contains('hidden')) {
                document.getElementById('toggle-debug-btn')?.click();
            }
        }
    } catch (error) {
        console.error(`L·ªói x·ª≠ l√Ω file ${dataName}:`, error);
        ui.updateFileStatus(fileType, file.name, `L·ªói: ${error.message}`, 'error');
        ui.showNotification(`L·ªói khi x·ª≠ l√Ω file "${dataName}".`, 'error');
    } finally {
        ui.hideProgressBar(fileType);
    }
}

function handleFilterChange(prefix) {
    appState.viewingDetailFor = null;
    ui.updateEmployeeFilter(prefix);
    appController.updateAndRenderCurrentTab();
}

// --- MAIN INITIALIZER ---

export function initializeEventListeners(mainAppController) {
    appController = mainAppController;

    try {
        const multiSelectConfig = {
            removeItemButton: true,
            placeholder: true,
            placeholderValue: 'Ch·ªçn ho·∫∑c g√µ ƒë·ªÉ t√¨m...',
            searchPlaceholderValue: 'T√¨m ki·∫øm...'
        };

        const competitionMultiSelectConfig = {
            removeItemButton: true,
            placeholder: true,
            placeholderValue: 'Ch·ªçn ho·∫∑c g√µ ƒë·ªÉ t√¨m...',
            searchPlaceholderValue: 'T√¨m ki·∫øm...',
        };

        ['luyke', 'sknv', 'realtime'].forEach(prefix => {
            const employeeEl = document.getElementById(`${prefix}-filter-name`);
            if (employeeEl) appState.choices[`${prefix}_employee`] = new Choices(employeeEl, multiSelectConfig);
            
            ['warehouse', 'department'].forEach(type => {
                const el = document.getElementById(`${prefix}-filter-${type}`);
                if(el) appState.choices[`${prefix}_${type}`] = new Choices(el, { searchEnabled: true, removeItemButton: false, itemSelectText: 'Ch·ªçn' });
            });
            ['nhanhang', 'nhomhang', 'employee'].forEach(type => {
                const highlightEl = document.getElementById(`${prefix}-highlight-${type}`);
                if (highlightEl) appState.choices[`${prefix}_highlight_${type}`] = new Choices(highlightEl, multiSelectConfig);
            });
        });

        const competitionBrandEl = document.getElementById('competition-brand');
        if (competitionBrandEl) appState.choices['competition_brand'] = new Choices(competitionBrandEl, competitionMultiSelectConfig);
        
        const competitionGroupEl = document.getElementById('competition-group');
        if (competitionGroupEl) appState.choices['competition_group'] = new Choices(competitionGroupEl, competitionMultiSelectConfig);

        const singleSelectConfig = {
            searchEnabled: true,
            removeItemButton: false,
            itemSelectText: 'Ch·ªçn',
            searchPlaceholderValue: 'T√¨m ki·∫øm...'
        };
        const singleSelects = {
             'thidua-employee-filter': 'thidua_employee_detail',
            'thidua-vung-filter-supermarket': 'thiDuaVung_sieuThi',
        };
        for (const [id, key] of Object.entries(singleSelects)) {
             const el = document.getElementById(id);
             if (el) appState.choices[key] = new Choices(el, singleSelectConfig);
        }
    } catch (error) { console.error("L·ªói khi kh·ªüi t·∫°o Choices.js:", error); }

    try {
        const initDatePicker = (prefix, renderFunc) => {
            const datePickerEl = document.getElementById(`${prefix}-filter-date`);
            if (!datePickerEl) return;
            const datePicker = flatpickr(datePickerEl, {
                mode: "multiple", dateFormat: "d/m", maxDate: "today",
                onClose: (selectedDates, dateStr, instance) => {
                    if (selectedDates.length === 2) {
                        const [start, end] = selectedDates.sort((a,b) => a - b);
                        const dateRange = Array.from({length: (end - start) / 86400000 + 1}, (_, i) => new Date(start.getTime() + i * 86400000));
                        instance.setDate(dateRange, false);
                    }
                    ui.updateDateSummary(document.getElementById(`${prefix}-date-summary`), instance);
                    appState.viewingDetailFor = null;
                    renderFunc();
                }
            });
            appState.choices[`${prefix}_date_picker`] = datePicker;
            document.getElementById(`${prefix}-clear-date`)?.addEventListener('click', () => { datePicker.clear(); renderFunc(); });
        };
        initDatePicker('luyke', luykeTab.render);
        initDatePicker('sknv', sknvTab.render);
    } catch (error) { console.error("L·ªói khi kh·ªüi t·∫°o Flatpickr:", error); }

    initializeSettingsListeners(appController);
    initializeHighlightingListeners(appController);
    initializeActionListeners();
    initializeCollaborationListeners(appController);
    initializeSortingListeners(appController);
    initializeCompetitionListeners(appController);
    dragDroplisteners.init(appController);

    document.getElementById('force-reload-btn')?.addEventListener('click', () => window.location.reload());
    document.querySelectorAll('a.nav-link').forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); appController.switchTab(link.getAttribute('href').substring(1)); }));
    
    document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', (e) => {
        ui.handleSubTabClick(e.currentTarget);
        appState.viewingDetailFor = null;
        const mainTabId = e.currentTarget.closest('.page-section')?.id || e.currentTarget.closest('.settings-drawer')?.id;
        
        if (mainTabId === 'health-section') luykeTab.render();
        else if (mainTabId === 'health-employee-section') sknvTab.render();
        else if (mainTabId === 'realtime-section') uiRealtime.render(); 
    }));

    document.querySelectorAll('.toggle-filters-btn').forEach(button => button.addEventListener('click', () => ui.toggleFilterSection(button.dataset.target)));
    
    document.querySelectorAll('.file-input').forEach(input => {
        if (input.id !== 'file-thidua-vung' && input.id !== 'file-category-structure') {
            input.addEventListener('change', (e) => handleFileInputChange(e));
        }
    });
    document.getElementById('file-category-structure')?.addEventListener('change', (e) => appController.handleCategoryFile(e));
    
    document.getElementById('paste-luyke')?.addEventListener('input', () => appController.handleLuykePaste());
    document.getElementById('paste-thiduanv')?.addEventListener('input', () => appController.handleThiduaNVPaste());
    document.getElementById('paste-thuongerp')?.addEventListener('input', () => appController.handleErpPaste());
    document.getElementById('paste-thuongerp-thangtruoc')?.addEventListener('input', (e) => appController.handleErpThangTruocPaste(e));
    document.getElementById('realtime-file-input')?.addEventListener('change', (e) => appController.handleRealtimeFileInput(e));
    document.getElementById('download-danhsachnv-template-btn')?.addEventListener('click', () => appController.handleTemplateDownload());
    
    document.getElementById('file-thidua-vung')?.addEventListener('change', (e) => appController.handleThiDuaVungFileInput(e));
    document.getElementById('thidua-vung-filter-supermarket')?.addEventListener('change', () => appController.handleThiDuaVungFilterChange());
    
    document.getElementById('debug-competition-file-input')?.addEventListener('change', (e) => appController.handleCompetitionDebugFile(e));

    ['luyke', 'sknv', 'realtime'].forEach(prefix => {
        document.getElementById(`${prefix}-filter-warehouse`)?.addEventListener('change', () => handleFilterChange(prefix));
        document.getElementById(`${prefix}-filter-department`)?.addEventListener('change', () => handleFilterChange(prefix));
         document.getElementById(`${prefix}-filter-name`)?.addEventListener('change', () => handleFilterChange(prefix));
    });
    
    document.getElementById('sknv-view-selector')?.addEventListener('click', (e) => appController.handleSknvViewChange(e));
    document.getElementById('sknv-employee-filter')?.addEventListener('change', () => sknvTab.render());
    
    document.body.addEventListener('click', (e) => {
        // === START: UPDATED CLICK LOGIC (V3.12) ===
        // This now targets '.interactive-row' which is on both summary cards and table rows
        const interactiveRow = e.target.closest('.interactive-row');
        if (interactiveRow && interactiveRow.dataset.employeeId) {
            e.preventDefault();
            
            // Prevent re-triggering if already viewing the same employee's detail
            if (appState.viewingDetailFor && appState.viewingDetailFor.employeeId === interactiveRow.dataset.employeeId) {
                return;
            }
            
            appState.viewingDetailFor = {
                employeeId: interactiveRow.dataset.employeeId,
                sourceTab: interactiveRow.dataset.sourceTab
            };
            appController.updateAndRenderCurrentTab();
            return;
        }
        // === END: UPDATED CLICK LOGIC ===

        const backButton = e.target.closest('.back-to-summary-btn');
        if (backButton) {
            e.preventDefault();
            appState.viewingDetailFor = null;
            appController.updateAndRenderCurrentTab();
            return;
        }

        const captureDetailBtn = e.target.closest('#capture-sknv-detail-btn, #capture-dtnv-lk-detail-btn, #capture-dtnv-rt-detail-btn');
        if (captureDetailBtn) {
            e.preventDefault();
            const areaToCapture = captureDetailBtn.closest('.sub-tab-content')?.querySelector('[id$="-capture-area"]');
            const title = appState.viewingDetailFor?.employeeId || 'ChiTietNV';
            if (areaToCapture) {
                captureService.captureDashboardInParts(areaToCapture, title);
            }
            return;
        }
        
        const luykeViewSwitcherBtn = e.target.closest('#luyke-thidua-view-selector .view-switcher__btn');
        if (luykeViewSwitcherBtn) {
            e.preventDefault();
            appController.handleLuykeThiDuaViewChange(e);
            return;
        }

        const thiDuaViewSwitcherBtn = e.target.closest('#thidua-view-selector .view-switcher__btn');
        if (thiDuaViewSwitcherBtn) {
            e.preventDefault();
            appController.handleThiDuaViewChange(e);
            return;
        }
        
        const dtHangViewSwitcherBtn = e.target.closest('#dthang-realtime-view-selector .view-switcher__btn');
        if (dtHangViewSwitcherBtn) {
            e.preventDefault();
            appController.handleDthangRealtimeViewChange(e);
            return;
        }
    });
    
    document.getElementById('thidua-employee-filter')?.addEventListener('change', () => ui.displayCompetitionReport('employee'));
    document.getElementById('realtime-brand-category-filter')?.addEventListener('change', () => uiRealtime.handleBrandFilterChange());
    document.getElementById('realtime-brand-filter')?.addEventListener('change', () => uiRealtime.handleBrandFilterChange());
}
--- END FILE: ./event-listeners/ui-listeners.js ---

--- START FILE: ./index.html ---
<!DOCTYPE html>
<html lang="vi" data-contrast="3">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• ph√¢n t√≠ch s·ªë cho QLST MWG 4.9</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <script src="https://unpkg.com/feather-icons"></script>

    <link rel="stylesheet" href="./dashboard.css">
    
    <style>
        #luyke-category-details-content td:first-child,
        #luyke-unexported-revenue-content td:first-child {
            text-transform: capitalize;
        }
    </style>
</head>
<body class="overflow-x-hidden">

    <div id="update-notification" class="hidden fixed bottom-5 right-5 bg-blue-600 text-white py-3 px-5 rounded-lg shadow-lg z-[1001] flex items-center gap-4">
        <p class="font-semibold">ƒê√£ c√≥ phi√™n b·∫£n m·ªõi! Xem chi ti·∫øt n·ªôi dung c·∫≠p nh·∫≠t ·ªü tab "H∆∞·ªõng D·∫´n & G√≥p √ù"</p>
        <button onclick="window.location.reload()" class="bg-white text-blue-600 font-bold py-1 px-3 rounded-md hover:bg-blue-100 transition">T·∫£i l·∫°i trang</button>
    </div>

    <div id="interface-drawer-container"></div>
    <div id="goal-drawer-container"></div>
    <div id="drawer-overlay" class="hidden fixed inset-0 bg-black bg-opacity-40 z-40"></div>

    <div class="flex min-h-screen">
        <div id="sidebar-container"></div> 
         <main id="main-content" class="flex-1 p-6">
            
<div class="max-w-full mx-auto">

                <section id="home-section" class="page-section hidden">
                    <div class="page-header">
                        <h2 class="page-header__title">H∆∞·ªõng D·∫´n & G√≥p √ù</h2>
                        <div id="usage-counter-display" class="text-sm font-semibold">
                     
<span class="text-blue-600">Ng∆∞·ªùi d√πng:</span>
                            <span id="user-count" class="text-red-600 font-bold">-</span>
                            <span class="text-blue-600 ml-4">L∆∞·ª£t truy c·∫≠p:</span>
                            <span id="visitor-count" class="text-red-600 font-bold">-</span>
                
<span class="text-blue-600 ml-4">L∆∞·ª£t s·ª≠ d·ª•ng:</span>
                            <span id="action-count" class="text-red-600 font-bold">-</span>
                        </div>
                    </div>
                  
          
<div class="content-card">
                         <h3 class="content-card__header">Video H∆∞·ªõng D·∫´n S·ª≠ D·ª•ng Nhanh</h3>
                         <div id="video-container" class="bg-gray-200 rounded-lg">
                            <iframe 
                    
class="w-full h-full aspect-video" 
                                src="https://www.youtube.com/embed/bmImlht_yB4?si=iIo9NZ7wc9FvKZKf" 
                                title="YouTube video player" 
                                frameborder="0" 
   
allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen>
                            </iframe>
                        
</div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                        <div class="flex flex-col">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">G√≥p √Ω & Th·∫£o lu·∫≠n</h2>
            
<div id="feedback-composer" class="bg-white rounded-xl shadow-md p-6 border border-gray-200 flex-grow">
                                </div>
                        </div>
                        <div class="flex flex-col">
             
<h2 class="text-2xl font-bold text-gray-800 mb-6">Danh s√°ch g√≥p √Ω</h2>
                            <div id="feedback-list-container" class="bg-white rounded-xl shadow-md p-6 border border-gray-200 flex-grow">
                                <div id="feedback-list" class="space-y-6">
                           
</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-12">
                     
<h2 class="text-2xl font-bold text-gray-800 mb-6">L·ªãch s·ª≠ c·∫≠p nh·∫≠t</h2>
                         <div id="update-history-list" class="space-y-6">
                        </div>
                    </div>
                    </section>
                  
<section id="data-section" class="page-section">
                        <div class="page-header">
                        <div class="flex items-center gap-x-3">
                            <h2 class="page-header__title">C·∫≠p nh·∫≠t d·ªØ li·ªáu</h2>
                            <button class="page-header__help-btn" data-help-id="data"
title="Xem h∆∞·ªõng d·∫´n">
                                <i data-feather="help-circle"></i>
                            </button>
                        </div>
                        <div id="version-marquee-container" class="marquee-container">
      
<p class="marquee-text"></p>
                        </div>
                    
                        <div class="header-qr-container">
                           
<span>THAM GIA TH·∫¢O LU·∫¨N - G√ìP √ù</span>
                             <img id="header-qr-image" src="" alt="M√£ QR" class="header-qr-image">
                        </div>
                    </div>
                    <div class="content-card">
            
<div class="flex justify-start items-baseline gap-x-4">
                            <h3 class="content-card__header !mb-0 !border-b-0">D·ªÆ LI·ªÜU C·∫¨P NH·∫¨T H√ÄNG NG√ÄY</h3>
                            <a href="#" id="download-bookmark-link" download="QLST_Bookmark.zip" class="data-input-group__link">
                                T·∫£i Bookmark Chrome
 
                            </a>
                        </div>
                        
                        <div class="flex flex-col gap-6 pt-4">
                
<div class="grid md:grid-cols-3 gap-6">
                                <div class="data-input-group">
                                    <a href="https://report.mwgroup.vn/home/dashboard/077" target="_blank" class="data-input-group__label data-input-group__label--link">üìÑ Y√™u c·∫ßu xu·∫•t l≈©y k·∫ø:</a>
                          
<div class="data-input-group__content">
                                        <div class="flex items-center gap-2">
                                            <label for="file-ycx" class="data-input-group__file-trigger">Th√™m file</label>
                  
<span id="file-name-ycx" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                        </div>
                                        <input type="file" id="file-ycx" class="hidden file-input" data-name="Y√™u c·∫ßu xu·∫•t l≈©y
k·∫ø" data-state-key="ycxData" data-save-key="saved_ycx" accept=".xlsx, .xls, .csv">
                                        <div class="data-input-group__status-wrapper"><span id="file-status-ycx" class="data-input-group__status-text"></span></div>
                                        <div id="progress-ycx" class="progress-bar-container hidden"><div class="progress-bar"></div></div>
                           
</div>
                                </div>
                                <div class="data-input-group">
                                    <a href="https://reports.thegioididong.com/#/viewreport/168754" target="_blank" class="data-input-group__label data-input-group__label--link">üìÑ Gi·ªù c√¥ng:</a>
   
<div class="data-input-group__content">
                                        <div class="flex items-center gap-2">
                                          
<label for="file-giocong" class="data-input-group__file-trigger">Th√™m file</label>
                                            <span id="file-name-giocong" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                        </div>
                          
<input type="file" id="file-giocong" class="hidden file-input" data-name="Gi·ªù c√¥ng" data-state-key="rawGioCongData" data-save-key="saved_giocong" accept=".xlsx, .xls, .csv">
                                        <div class="data-input-group__status-wrapper">
                                            <span id="file-status-giocong" class="data-input-group__status-text"></span>
       
</div>
                                        <div id="progress-giocong" class="progress-bar-container hidden"><div class="progress-bar"></div></div>
                                    </div>
      
</div>
                                <div class="data-input-group">
                                    <a href="https://report.mwgroup.vn/home/dashboard/105" target="_blank" class="data-input-group__label data-input-group__label--link">üìÑ Th∆∞·ªüng n√≥ng:</a>
                  
<div class="data-input-group__content">
                                        <div class="flex items-center gap-2">
                                            <label for="file-thuongnong" class="data-input-group__file-trigger">Th√™m file</label>
          
<span id="file-name-thuongnong" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                        </div>
                                        <input
type="file" id="file-thuongnong" class="hidden file-input" data-name="Th∆∞·ªüng n√≥ng" data-state-key="thuongNongData" data-save-key="saved_thuongnong" accept=".xlsx, .xls, .csv">
                                        <div class="data-input-group__status-wrapper">
                                            <span id="file-status-thuongnong" class="data-input-group__status-text"></span>
                      
</div>
                                        <div id="progress-thuongnong" class="progress-bar-container hidden"><div class="progress-bar"></div></div>
                                    </div>
                     
</div>
                            </div>
                            <div class="grid md:grid-cols-3 gap-6">
                                <div class="data-input-group h-full">
               
<a href="https://bi.thegioididong.com/reward?id=-1&tab=1" target="_blank" class="data-input-group__label data-input-group__label--link">üìã Th∆∞·ªüng ERP:<br><span class="font-normal">(Copy t·ª´ BI)</span></a>
                                    <div class="data-input-group__content">
                                        <textarea id="paste-thuongerp" rows="5" class="data-textarea" placeholder="D√°n to√†n b·ªô d·ªØ li·ªáu th∆∞·ªüng ERP..."></textarea>
  
<div class="data-input-group__status-wrapper"><span id="status-thuongerp" class="data-input-group__status-text"></span></div>
                                    </div>
                                </div>
          
<div class="data-input-group h-full">
                                    <a href="https://bi.thegioididong.com/sieu-thi-con?id=16612&tab=1" target="_blank" class="data-input-group__label data-input-group__label--link">üìã Data l≈©y k·∫ø:<br><span class="font-normal">(Copy t·ª´ BI)</span></a>
                                    <div class="data-input-group__content">
            
<textarea id="paste-luyke" rows="5" class="data-textarea" placeholder="D√°n d·ªØ li·ªáu ƒë√£ sao ch√©p..."></textarea>
                                        <div class="data-input-group__status-wrapper"><span id="status-luyke" class="data-input-group__status-text"></span></div>
                                    </div>
   
</div>
                                <div class="data-input-group h-full">
                                    <a href="https://bi.thegioididong.com/sieu-thi-con?id=16758&tab=bcdtnv&rt=2&dm=1" target="_blank" class="data-input-group__label data-input-group__label--link">üìã Thi ƒëua nh√¢n vi√™n:<br><span class="font-normal">(Copy t·ª´ BI)</span></a>
         
<div class="data-input-group__content">
                                        <textarea id="paste-thiduanv" rows="5" class="data-textarea" placeholder="D√°n d·ªØ li·ªáu ƒë√£ sao ch√©p..."></textarea>
                                        <div class="data-input-group__status-wrapper"><span
id="status-thiduanv" class="data-input-group__status-text"></span></div>
                                    </div>
                                </div>
                            </div>
                      
</div>
                    </div>

                    <div class="mb-6">
                        <button id="toggle-debug-btn" class="text-sm text-blue-600 hover:underline">Hi·ªÉn th·ªã C√¥ng c·ª• G·ª° l·ªói</button>
                        <div id="debug-tool-container" class="hidden mt-4 p-4 border-2 border-dashed border-red-300 rounded-lg bg-red-50">
          
<h3 class="text-lg font-bold text-red-700 mb-2">C√¥ng c·ª• G·ª° l·ªói & Ch·∫©n ƒëo√°n</h3>
                            <p class="text-sm text-gray-600 mb-4">C√¥ng c·ª• n√†y s·∫Ω t·ª± ƒë·ªông ki·ªÉm tra c√°c file b·∫°n t·∫£i l√™n v√† d·ªØ li·ªáu b·∫°n d√°n v√†o. N·∫øu c√≥ c·ªôt b√°o <span class="font-bold text-red-600">L·ªñI</span>, vui l√≤ng ki·ªÉm tra l·∫°i file ho·∫∑c d·ªØ li·ªáu copy.</p>
                         
<div id="debug-results-container" class="space-y-4">
                                 <p class="text-gray-500">Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c t·∫£i l√™n ƒë·ªÉ ki·ªÉm tra.</p>
                            </div>
                            <div id="pasted-debug-results-container" class="space-y-4 mt-4"></div>
            
</div>
                    </div>
                    
                    <div class="content-card">
                        <h3 class="content-card__header">D·ªÆ LI·ªÜU C·∫¨P NH·∫¨T 1 TH√ÅNG 1 L·∫¶N</h3>
              
<p class="text-sm text-yellow-600 bg-yellow-50 p-3 rounded-lg mb-4">L∆∞u √Ω: D·ªØ li·ªáu trong ph·∫ßn n√†y s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o tr√¨nh duy·ªát c·ªßa b·∫°n. D·ªØ li·ªáu s·∫Ω t·ªìn t·∫°i cho ƒë·∫øn khi b·∫°n c·∫≠p nh·∫≠t l·∫°i.</p>
                        
                        <div class="grid md:grid-cols-3 gap-6">
                          
<div class="space-y-4">
                                <div class="data-input-group">
                                    <label class="data-input-group__label">üìÑ Danh s√°ch nh√¢n vi√™n:</label>
                                    <div class="data-input-group__content">
     
<div class="flex items-center gap-2">
                                            <label for="file-danhsachnv" class="data-input-group__file-trigger">Th√™m file</label>
                                  
<span id="file-name-danhsachnv" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                        </div>
                                        <button id="download-danhsachnv-template-btn" class="data-input-group__link text-left">T·∫£i file m·∫´u</button>
                    
<input type="file" id="file-danhsachnv" class="hidden file-input" data-name="Danh s√°ch nh√¢n vi√™n" data-state-key="danhSachNhanVien" data-save-key="saved_danhsachnv" accept=".xlsx, .xls, .csv">
                                        <div class="data-input-group__status-wrapper">
                                            <span
id="file-status-danhsachnv" class="data-input-group__status-text"></span>
                                        </div>
                                        <div id="progress-danhsachnv" class="progress-bar-container hidden"><div class="progress-bar"></div></div>
                                  
</div>
                                </div>
                                <div class="data-input-group">
                                    <label class="data-input-group__label">üìÑ YCX L≈©y K·∫ø th√°ng tr∆∞·ªõc:</label>
          
<div class="data-input-group__content">
                                        <div class="flex items-center gap-2">
                                            <label for="file-ycx-thangtruoc" class="data-input-group__file-trigger">Th√™m file</label>
  
<span id="file-name-ycx-thangtruoc" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                        </div>
                                 
<input type="file" id="file-ycx-thangtruoc" class="hidden file-input" data-name="YCX L≈©y K·∫ø th√°ng tr∆∞·ªõc" data-state-key="ycxDataThangTruoc" data-save-key="saved_ycx_thangtruoc" accept=".xlsx, .xls, .csv">
                                        <div class="data-input-group__status-wrapper">
                                            <span id="file-status-ycx-thangtruoc" class="data-input-group__status-text"></span>
           
</div>
                                        <div id="progress-ycx-thangtruoc" class="progress-bar-container hidden"><div class="progress-bar"></div></div>
                                    </div>
          
</div>
                            </div>
                            <div class="space-y-4">
                                <div class="data-input-group">
       
<label class="data-input-group__label">üìÑ Th∆∞·ªüng n√≥ng th√°ng tr∆∞·ªõc:</label>
                                    <div class="data-input-group__content">
                                        <div class="flex items-center gap-2">
     
<label for="file-thuongnong-thangtruoc" class="data-input-group__file-trigger">Th√™m file</label>
                                            <span id="file-name-thuongnong-thangtruoc" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                             
</div>
                                        <input type="file" id="file-thuongnong-thangtruoc" class="hidden file-input" data-name="Th∆∞·ªüng n√≥ng th√°ng tr∆∞·ªõc" data-state-key="thuongNongDataThangTruoc" data-save-key="saved_thuongnong_thangtruoc" accept=".xlsx, .xls, .csv">
                                        <div class="data-input-group__status-wrapper">
              
<span id="file-status-thuongnong-thangtruoc" class="data-input-group__status-text"></span>
                                        </div>
                                        <div id="progress-thuongnong-thangtruoc" class="progress-bar-container hidden"><div class="progress-bar"></div></div>
   
</div>
                                </div>
                            </div>
                          
<div class="space-y-4">
                                <div class="data-input-group h-full">
                                    <label class="data-input-group__label">üìã Th∆∞·ªüng ERP th√°ng tr∆∞·ªõc:</label>
                                    <div class="data-input-group__content">
   
<textarea id="paste-thuongerp-thangtruoc" rows="5" class="data-textarea" placeholder="D√°n d·ªØ li·ªáu th∆∞·ªüng ERP th√°ng tr∆∞·ªõc..."></textarea>
                                        <div class="data-input-group__status-wrapper">
                               
<span id="status-thuongerp-thangtruoc" class="data-input-group__status-text"></span>
                                        </div>
                                    </div>
                            
</div>
                            </div>
                        </div>
                    </div>
                </section>
                <section id="health-section" class="page-section hidden">
        
<div id="health-section-placeholder" class="placeholder-message hidden">Vui l√≤ng c·∫≠p nh·∫≠t danh s√°ch nh√¢n vi√™n ƒë·ªÉ xem k·∫øt qu·∫£.</div>
                    <div id="health-section-content">
                        <div class="content-card">
                            <div class="page-header border-b pb-4 mb-6">
               
<h2 class="page-header__title">S·ª©c kh·ªèe si√™u th·ªã</h2>
                                <button class="page-header__help-btn" data-help-id="luyke" title="Xem h∆∞·ªõng d·∫´n">
                                    <i data-feather="help-circle"></i>
                        
</button>
                            </div>
                            <button class="toggle-filters-btn" data-target="luyke-filter-container">
                                <span class="text">Hi·ªán b·ªô l·ªçc n√¢ng cao</span>
                
<i data-feather="chevron-down" class="icon"></i>
                            </button>
                            <div id="luyke-filter-container" class="advanced-filters hidden">
                                <div id="luyke-filter-bar" class="p-4 bg-slate-50 border border-slate-200 rounded-lg space-y-4">
   
<div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                        <div class="md:col-span-2">
                                        
<label for="luyke-filter-date" class="block text-sm font-medium text-gray-600 mb-1">Ng√†y t·∫°o</label>
                                            <div class="relative">
                                                <input type="text" id="luyke-filter-date" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full" placeholder="Ch·ªçn ng√†y...">
    
<button id="luyke-clear-date" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-500 text-xs">B·ªè ch·ªçn</button>
                                            </div>
                      
<span id="luyke-date-summary" class="text-xs text-red-500 mt-1 block"></span>
                                        </div>
                                        <div class="md:col-span-2"><label for="luyke-filter-warehouse" class="block text-sm font-medium text-gray-600 mb-1">M√£ Kho</label><select id="luyke-filter-warehouse" class="p-2 border
rounded-lg text-sm bg-white shadow-sm w-full"></select></div>
                                        <div class="md:col-span-2"><label for="luyke-filter-department" class="block text-sm font-medium text-gray-600 mb-1">B·ªô Ph·∫≠n</label><select id="luyke-filter-department" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select></div>
                                        <div class="md:col-span-6"><label for="luyke-filter-name" class="block text-sm font-medium text-gray-600 mb-1">Nh√¢n Vi√™n</label><select id="luyke-filter-name" multiple></select></div>
         
</div>
                                    <div class="border-t pt-4 grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                        <div class="md:col-span-3"><label for="luyke-highlight-nhanhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u
ng√†nh h√†ng</label><select id="luyke-highlight-nhanhang" multiple></select></div>
                                        <div class="md:col-span-3"><label for="luyke-highlight-nhomhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√≥m h√†ng</label><select id="luyke-highlight-nhomhang" multiple></select></div>
                                        <div class="md:col-span-3"><label for="luyke-highlight-employee" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√¢n vi√™n</label><select id="luyke-highlight-employee" multiple></select></div>
            
<div class="md:col-span-3 flex items-end gap-2">
                                            <div><label for="luyke-highlight-color" class="block text-sm font-medium text-gray-600 mb-1">Ch·ªçn m√†u</label><input type="color" id="luyke-highlight-color" value="#ffff00" class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"></div>
                        
<button id="luyke-clear-highlight" class="bg-red-500 text-white px-4 h-10 rounded-lg hover:bg-red-600 transition text-sm">X√≥a m√†u</button>
                                        </div>
                                    </div>
             
</div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-8">
                    
<nav id="luyke-subtabs-nav" class="border-b border-gray-200 -mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" data-content-container="luyke-subtabs-content">
                                <button class="sub-tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-luyke-sieu-thi" data-title="SieuThiLuyKe">
                                    <i data-feather="home"></i>
                       
<span>Si√™u th·ªã L≈©y k·∫ø</span>
                                </button>
                                <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-luyke-thi-dua" data-title="ThiDuaLuyKe">
                              
<i data-feather="award"></i>
                                    <span>Thi ƒëua L≈©y k·∫ø</span>
                                </button>
                                <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-luyke-thidua-vung"
data-title="ThiDuaVung">
                                    <i data-feather="map"></i>
                                    <span>Thi ƒëua V√πng</span>
                                </button>
            
</nav>
                             <div class="flex items-center gap-x-2">
                                <button id="compose-luyke-notification-btn" class="action-btn action-btn--composer" title="Nh·∫≠n x√©t">
                                  
<i data-feather="pen-tool"></i>
                                    <span>Nh·∫≠n x√©t</span>
                                </button>
                                <button id="export-luyke-btn" class="action-btn action-btn--export" title="Xu·∫•t Excel tab hi·ªán t·∫°i">
       
<i data-feather="download"></i>
                                    <span>Xu·∫•t Excel</span>
                                </button>
                    
<button id="capture-luyke-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh tab hi·ªán t·∫°i">
                                    <i data-feather="camera"></i>
                                    <span>Ch·ª•p m√†n h√¨nh</span>
                        
</button>
                            </div>
                        </div>

                        <div id="luyke-subtabs-content">
                            <div id="subtab-luyke-sieu-thi" class="sub-tab-content space-y-8">
   
<h2 id="luyke-supermarket-title" class="text-2xl font-bold text-center text-gray-700"></h2>
                                
                                <div id="luyke-kpi-cards-container" data-capture-group="kpi" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              
<div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title">Doanh thu th·ª±c</h4>
                                        <p id="luyke-kpi-dt-thuc-main" class="font-bold mt-2 mb-3">0</p>
      
<p id="luyke-kpi-dt-thuc-sub1" class="text-sm">DK: 0 / Target: 0</p>
                                    </div>
                                    
       
<div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title">Doanh thu Quy ƒë·ªïi</h4>
                                        <p id="luyke-kpi-dt-qd-main"
class="font-bold mt-2 mb-3">0</p>
                                        <p id="luyke-kpi-dt-qd-sub1" class="text-sm">DK: 0 / Target: 0</p>
                                    </div>
                                
   
<div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title">T·ª∑ l·ªá ho√†n th√†nh Target</h4>
                                     
<p id="luyke-kpi-ht-target-qd-main" class="font-bold mt-2 mb-3">0%</p>
                                        <p id="luyke-kpi-ht-target-thuc-sub" class="text-sm">DT Th·ª±c: 0%</p>
                                    </div>
                                
    
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title">T·ª∑ l·ªá quy ƒë·ªïi</h4>
                               
<p id="luyke-kpi-tl-qd-main" class="font-bold mt-2 mb-3">0%</p>
                                        <p id="luyke-kpi-tl-qd-sub" class="text-sm">M·ª•c ti√™u: 0%</p>
                                    </div>
                          
           
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title">Doanh thu tr·∫£ ch·∫≠m</h4>
                         
<p id="luyke-kpi-dt-tc-main" class="font-bold mt-2 mb-3">0</p>
                                        <p id="luyke-kpi-dt-tc-sub" class="text-sm">% th·ª±c tr·∫£ ch·∫≠m: 0%</p>
                                    </div>
                  
                   
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title">DTQƒê Ch∆∞a xu·∫•t</h4>
                  
<p id="luyke-kpi-dtqd-chua-xuat-main" class="font-bold mt-2 mb-3">0</p>
                                    </div>
                                
                         
<div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title">Thi ƒëua ng√†nh h√†ng</h4>
                                        <p id="luyke-kpi-thidua-main" class="font-bold mt-2 mb-3">0%</p>
                
<p id="luyke-kpi-thidua-sub" class="text-sm">0/0 Ng√†nh</p>
                                    </div>
                                    
                    
<div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title">TƒÉng/gi·∫£m c√πng k·ª≥</h4>
                                        <p id="luyke-kpi-dtck-main" class="font-bold mt-2 mb-3">N/A</p>
            
<p id="luyke-kpi-dtck-sub" class="text-sm">Doanh thu: 0 | 0%</p>
                                        <p id="luyke-kpi-lkck-sub" class="text-sm">L∆∞·ª£t kh√°ch: 0 | 0%</p>
                                    </div>
   
</div>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                                    <div data-capture-group="1" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200"><h3 class="text-xl font-bold text-gray-700 mb-4 uppercase">Hi·ªáu qu·∫£ khai th√°c</h3><div
id="luyke-efficiency-content"></div></div>
                                    <div data-capture-group="1" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200"><h3 class="text-xl font-bold text-gray-700 mb-4 uppercase">Nh√≥m h√†ng quy ƒë·ªïi cao</h3><div id="luyke-qdc-content"></div></div>
                                </div>
                                <div
class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                                    <div data-capture-group="2" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200"><h3 class="text-xl font-bold text-gray-700 mb-4 uppercase">Ng√†nh h√†ng chi ti·∫øt</h3><div id="luyke-category-details-content"></div></div>
                                    <div data-capture-group="2" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200"><h3 class="text-xl font-bold uppercase mb-4">Doanh thu ch∆∞a xu·∫•t</h3><div id="luyke-unexported-revenue-content"></div></div>
          
</div>
                            </div>
                            <div id="subtab-luyke-thi-dua" class="sub-tab-content hidden space-y-4">
                                <div class="flex flex-wrap items-center justify-between
gap-4">
                                <div class="flex flex-wrap items-center gap-4">
                                    <h3 class="text-xl font-bold text-gray-800 uppercase">Thi ƒëua l≈©y k·∫ø <span id="luyke-competition-summary" class="text-sm font-normal"></span></h3>
                                    
<div id="luyke-thidua-view-selector-placeholder"></div> </div>
                                <div id="luyke-competition-content"></div>
                             </div>
                            
                           
<div id="subtab-luyke-thidua-vung" class="sub-tab-content hidden">
                                <div class="content-card">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                                        <div
class="data-input-group">
                                            <div class="flex flex-col sm:flex-row sm:items-center sm:gap-4">
                                                <label class="data-input-group__label !mb-2 sm:!mb-0 flex-shrink-0">File Thi ƒêua V√πng:</label>
               
<div class="flex items-center gap-2">
                                                    <label for="file-thidua-vung" class="data-input-group__file-trigger">Th√™m file</label>
                            
<span id="file-name-thidua-vung" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                                </div>
                                           
</div>
                                            <input type="file" id="file-thidua-vung" class="hidden file-input" data-name="Thi ƒëua v√πng" accept=".xlsx, .xls, .csv">
                                            <div class="data-input-group__status-wrapper mt-2"><span id="file-status-thidua-vung" class="data-input-group__status-text"></span></div>
                
</div>
                                        <div>
                                            <label for="thidua-vung-filter-supermarket" class="block text-sm font-medium text-gray-600 mb-1">Ch·ªçn Si√™u th·ªã</label>
   
<select id="thidua-vung-filter-supermarket"></select>
                                        </div>
                                    </div>
 
</div>
                                <div id="thidua-vung-infographic-container">
                                     <div class="placeholder-message">Vui l√≤ng t·∫£i file v√† ch·ªçn m·ªôt si√™u th·ªã ƒë·ªÉ xem b√°o c√°o.</div>
     
</div>
                            </div>
                        </div>
                    </div>
                </section>
    
<section id="health-employee-section" class="page-section hidden">
                    <div id="health-employee-section-placeholder" class="placeholder-message hidden">Vui l√≤ng c·∫≠p nh·∫≠t danh s√°ch nh√¢n vi√™n ƒë·ªÉ xem k·∫øt qu·∫£.</div>
                    <div id="health-employee-section-content">
                        <div class="content-card">
                        
<div class="page-header border-b pb-4 mb-6">
                                <h2 class="page-header__title">S·ª©c kh·ªèe nh√¢n vi√™n</h2>
                                <button class="page-header__help-btn" data-help-id="sknv" title="Xem h∆∞·ªõng d·∫´n">
                                    <i data-feather="help-circle"></i>
 
</button>
                            </div>

                            <button class="toggle-filters-btn" data-target="sknv-filter-container">
                              
<span class="text">Hi·ªán b·ªô l·ªçc n√¢ng cao</span>
                                <i data-feather="chevron-down" class="icon"></i>
                            </button>
                            <div id="sknv-filter-container" class="advanced-filters hidden">
                   
<div id="sknv-filter-bar" class="p-4 bg-slate-50 border border-slate-200 rounded-lg space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                        <div class="md:col-span-2">
                 
<label for="sknv-filter-date" class="block text-sm font-medium text-gray-600 mb-1">Ng√†y t·∫°o</label>
                                            <div class="relative">
                                        
<input type="text" id="sknv-filter-date" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full" placeholder="Ch·ªçn ng√†y...">
                                                <button id="sknv-clear-date" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-500 text-xs">B·ªè ch·ªçn</button>
                                           
</div>
                                            <span id="sknv-date-summary" class="text-xs text-red-500 mt-1 block"></span>
                                        </div>
                             
<div class="md:col-span-2"><label for="sknv-filter-warehouse" class="block text-sm font-medium text-gray-600 mb-1">M√£ Kho</label><select id="sknv-filter-warehouse" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select></div>
                                        <div class="md:col-span-2"><label for="sknv-filter-department" class="block text-sm font-medium text-gray-600 mb-1">B·ªô Ph·∫≠n</label><select id="sknv-filter-department" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select></div>
                                    
<div class="md:col-span-6"><label for="sknv-filter-name" class="block text-sm font-medium text-gray-600 mb-1">Nh√¢n Vi√™n</label><select id="sknv-filter-name" multiple></select></div>
                                    </div>
                                    <div class="border-t pt-4 grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                          
<div class="md:col-span-3"><label for="sknv-highlight-nhanhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u ng√†nh h√†ng</label><select id="sknv-highlight-nhanhang" multiple></select></div>
                                        <div class="md:col-span-3"><label for="sknv-highlight-nhomhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√≥m h√†ng</label><select id="sknv-highlight-nhomhang" multiple></select></div>
                                        <div
class="md:col-span-3"><label for="sknv-highlight-employee" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√¢n vi√™n</label><select id="sknv-highlight-employee" multiple></select></div>
                                        <div class="md:col-span-3 flex items-end gap-2">
                                            <div><label for="sknv-highlight-color" class="block text-sm font-medium text-gray-600 mb-1">Ch·ªçn m√†u</label><input type="color" id="sknv-highlight-color" value="#ffff00" class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"></div>
 
<button id="sknv-clear-highlight" class="bg-red-500 text-white px-4 h-10 rounded-lg hover:bg-red-600 transition text-sm">X√≥a m√†u</button>
                                        </div>
                          
</div>
                                </div>
                            </div>
                        </div>
                        
 
<div class="content-card">
                            <div class="flex justify-between items-center mb-8">
                                <nav id="employee-subtabs-nav" class="border-b border-gray-200 -mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" data-content-container="employee-subtabs-content">
                                    <button class="sub-tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-sknv" data-title="SKNV">
                                        <i data-feather="users"></i>
                                        <span>SKNV</span>
                                    </button>
                                    <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-doanhthu-lk" data-title="DoanhThuLK">
                                        <i data-feather="dollar-sign"></i>
                                        <span>Doanh thu LK</span>
                                    </button>
                                    <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-thunhap" data-title="ThuNhap">
                                        <i data-feather="briefcase"></i>
                                        <span>Thu nh·∫≠p</span>
                                    </button>
                                    <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-hieu-qua-khai-thac-luy-ke" data-title="HieuQuaKhaiThacLuyKe">
                                        <i data-feather="bar-chart-2"></i>
                                        <span>Hi·ªáu qu·∫£ NV LK</span>
                                    </button>
                                    <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-doanhthu-nganhhang" data-title="DTNganhHang">
                                        <i data-feather="layers"></i>
                                        <span>DT ng√†nh h√†ng</span>
                                    </button>
                                    <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-hieu-qua-thi-dua-lk" data-title="HieuQuaThiDuaLK">
                                        <i data-feather="award"></i>
                                        <span>Thi ƒëua NV LK</span>
                                    </button>
                                </nav>
                                 <div class="flex items-center gap-x-2">
                                     <button id="compose-sknv-notification-btn" class="action-btn action-btn--composer" title="Nh·∫≠n x√©t">
                                        <i data-feather="pen-tool"></i>
                                        <span>Nh·∫≠n x√©t</span>
                                    </button>
                                    <button id="export-sknv-btn" class="action-btn action-btn--export" title="Xu·∫•t Excel tab hi·ªán t·∫°i">
                                        <i data-feather="download"></i>
                                        <span>Xu·∫•t Excel</span>
                                    </button>
                                    <button id="capture-sknv-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh tab hi·ªán t·∫°i">
                                        <i data-feather="camera"></i>
                                        <span>Ch·ª•p m√†n h√¨nh</span>
                                    </button>
                                </div>
                            </div>
    
<div id="employee-subtabs-content">
                                <div id="subtab-sknv" class="sub-tab-content">
                                    <div id="sknv-summary-container"></div>
                       
<div id="sknv-details-container" class="mt-6 hidden">
                                        <p class="text-gray-500">Vui l√≤ng ch·ªçn m·ªôt nh√¢n vi√™n ƒë·ªÉ xem chi ti·∫øt.</p>
                                    </div>
                 
</div>
                                <div id="subtab-doanhthu-lk" class="sub-tab-content hidden space-y-6" data-capture-preset="landscape-table">
                                    <div id="revenue-report-container-lk"></div>
                              
<div id="dtnv-lk-details-container"></div>
                                </div>
                                <div id="subtab-thunhap" class="sub-tab-content hidden space-y-6" data-capture-preset="landscape-table">
                                    <div id="income-report-placeholder">
     
<p class="text-gray-500 mb-4">Vui l√≤ng t·∫£i ƒë·ªß c√°c file: <b>Danh s√°ch nh√¢n vi√™n, Y√™u c·∫ßu xu·∫•t l≈©y k·∫ø, Gi·ªù c√¥ng, Th∆∞·ªüng n√≥ng</b> v√† x·ª≠ l√Ω <b>Th∆∞·ªüng ERP</b> ·ªü tab Data ƒë·ªÉ xem b√°o c√°o thu nh·∫≠p.</p>
                                    </div>
              
<div id="income-report-container"></div>
                                </div>
                                <div id="subtab-hieu-qua-khai-thac-luy-ke" class="sub-tab-content hidden space-y-6" data-capture-preset="landscape-table">
                           
<div id="efficiency-report-container"></div>
                                </div>
                                <div id="subtab-doanhthu-nganhhang" class="sub-tab-content hidden space-y-6" data-capture-preset="mobile-portrait">
                                    <div id="category-revenue-report-container"></div>
  
</div>
                                <div id="subtab-hieu-qua-thi-dua-lk" class="sub-tab-content hidden space-y-6">
                                    <div id="competition-report-container-lk" class="mt-4">
               
<p class="text-gray-500">Vui l√≤ng khai b√°o ch∆∞∆°ng tr√¨nh thi ƒëua trong "Thi·∫øt l·∫≠p m·ª•c ti√™u" ƒë·ªÉ xem b√°o c√°o.</p>
                                    </div>
                                </div>
         
</div>
                        </div>
                    </div>
                </section>
                <section id="realtime-section" class="page-section hidden">
                    <div
id="realtime-section-placeholder" class="placeholder-message hidden">Vui l√≤ng c·∫≠p nh·∫≠t danh s√°ch nh√¢n vi√™n ƒë·ªÉ xem k·∫øt qu·∫£.</div>
                    <div id="realtime-section-content">
                        <div class="content-card">
                            <div class="page-header border-b pb-4 mb-6">
                            
<div class="flex items-center gap-x-3">
                                    <h2 class="page-header__title">Ph√¢n T√≠ch Doanh Thu Realtime</h2>
                                    <button class="page-header__help-btn" data-help-id="realtime" title="Xem h∆∞·ªõng d·∫´n">
                              
<i data-feather="help-circle"></i>
                                    </button>
                                </div>
                                <div class="flex-shrink-0 flex items-center gap-x-4 ml-auto">
   
<label for="realtime-file-input" class="cursor-pointer bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm font-medium whitespace-nowrap">Th√™m file Realtime</label>
                                    <input type="file" id="realtime-file-input" class="hidden" accept=".xlsx, .xls, .csv">
                              
<a href="https://report.mwgroup.vn/home/dashboard/077" target="_blank" class="text-blue-600 hover:underline whitespace-nowrap text-sm">L·∫•y file t·∫°i ƒë√¢y</a>
                                </div>
                            </div>

                            <button class="toggle-filters-btn" data-target="realtime-filter-container">
              
<span class="text">Hi·ªán b·ªô l·ªçc n√¢ng cao</span>
                                <i data-feather="chevron-down" class="icon"></i>
                            </button>
                            <div id="realtime-filter-container" class="advanced-filters hidden">
   
<div id="realtime-filter-bar" class="p-4 bg-slate-50 border border-slate-200 rounded-lg space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                        <div class="md:col-span-3"><label
for="realtime-filter-warehouse" class="block text-sm font-medium text-gray-600 mb-1">M√£ Kho</label><select id="realtime-filter-warehouse" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select></div>
                                        <div class="md:col-span-3"><label for="realtime-filter-department" class="block text-sm font-medium text-gray-600 mb-1">B·ªô Ph·∫≠n</label><select id="realtime-filter-department" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select></div>
                                        <div class="md:col-span-6"><label for="realtime-filter-name" class="block text-sm font-medium text-gray-600 mb-1">Nh√¢n Vi√™n</label><select
id="realtime-filter-name" multiple></select></div>
                                    </div>
                                    <div class="border-t pt-4 grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                       
<div class="md:col-span-3"><label for="realtime-highlight-nhanhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u ng√†nh h√†ng</label><select id="realtime-highlight-nhanhang" multiple></select></div>
                                        <div class="md:col-span-3"><label for="realtime-highlight-nhomhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√≥m h√†ng</label><select id="realtime-highlight-nhomhang" multiple></select></div>
                                        <div class="md:col-span-3"><label for="realtime-highlight-employee" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√¢n vi√™n</label><select id="realtime-highlight-employee" multiple></select></div>
  
<div class="md:col-span-3 flex items-end gap-2">
                                            <div><label for="realtime-highlight-color" class="block text-sm font-medium text-gray-600 mb-1">Ch·ªçn m√†u</label><input type="color" id="realtime-highlight-color" value="#ffff00" class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"></div>
              
<button id="realtime-clear-highlight" class="bg-red-500 text-white px-4 h-10 rounded-lg hover:bg-red-600 transition text-sm">X√≥a m√†u</button>
                                        </div>
                                    </div>
   
</div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-8">
          
<nav id="realtime-subtabs-nav" class="border-b border-gray-200 -mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" data-content-container="realtime-subtabs-content">
                                <button class="sub-tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-realtime-sieu-thi" data-title="SieuThiRealtime">
                                    <i data-feather="zap"></i>
             
<span>Si√™u th·ªã Realtime</span>
                                </button>
                                <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-realtime-nhan-vien" data-title="DTNVRealtime">
                     
<i data-feather="pie-chart"></i>
                                    <span>DT NV Realtime</span>
                                </button>
                                <button
class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-realtime-hieu-qua" data-title="HieuQuaKhaiThacRealtime">
                                    <i data-feather="bar-chart-2"></i>
                                    <span>Hi·ªáu qu·∫£ NV Realtime</span>
                                </button>
   
<button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-realtime-nganh-hang" data-title="NganhHangRealtime">
                                    <i data-feather="tag"></i>
                                    <span>Ng√†nh h√†ng Realtime</span>
      
</button>
                                <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-realtime-hang" data-title="HangRealtime">
                                    <i data-feather="globe"></i>
               
<span>DT H√£ng Realtime</span>
                                </button>
                                <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-hieu-qua-thi-dua-realtime" data-title="HieuQuaThiDuaRealtime">
                       
<i data-feather="award"></i>
                                    <span>Thi ƒëua NV Realtime</span>
                                </button>
                            </nav>
      
<div class="flex items-center gap-x-2">
                                <button id="compose-realtime-notification-btn" class="action-btn action-btn--composer" title="Nh·∫≠n x√©t">
                                    <i data-feather="pen-tool"></i>
                    
<span>Nh·∫≠n x√©t</span>
                                </button>
                                <button id="export-realtime-btn" class="action-btn action-btn--export" title="Xu·∫•t Excel tab hi·ªán t·∫°i">
                              
<i data-feather="download"></i>
                                    <span>Xu·∫•t Excel</span>
                                </button>
                                <button id="capture-realtime-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh tab hi·ªán t·∫°i">
   
<i data-feather="camera"></i>
                                    <span>Ch·ª•p m√†n h√¨nh</span>
                                </button>
               
</div>
                        </div>

                        <div id="realtime-subtabs-content">
                            <div id="subtab-realtime-sieu-thi" class="sub-tab-content space-y-8">
                          
<h2 id="realtime-supermarket-title" class="text-2xl font-bold text-center text-gray-700"></h2>
                                <div id="realtime-kpi-cards-container" data-capture-group="kpi" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg">
                             
<h4 class="kpi-card-title font-semibold uppercase tracking-wider">Doanh thu th·ª±c</h4>
                                        <p id="rt-kpi-dt-thuc-main" class="font-bold mt-2 mb-3">0</p>
                                        <p id="rt-kpi-dt-thuc-sub1" class="text-sm">% HT: <span class="kpi-percentage-value">0%</span> / Target: 0</p>
          
<p id="rt-kpi-dt-thuc-sub2" class="text-sm mt-1">DT Ch∆∞a xu·∫•t: 0</p>
                                    </div>
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg">
       
<h4 class="kpi-card-title font-semibold uppercase tracking-wider">Doanh thu Quy ƒë·ªïi</h4>
                                        <p id="rt-kpi-dt-qd-main" class="font-bold mt-2 mb-3">0</p>
                                   
<p id="rt-kpi-dt-qd-sub1" class="text-sm">% HT: <span class="kpi-percentage-value">0%</span> / Target: 0</p>
                                        <p id="rt-kpi-dt-qd-sub2" class="text-sm mt-1">DTQƒê Ch∆∞a xu·∫•t: 0</p>
                                    </div>
                        
<div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title font-semibold uppercase tracking-wider">T·ª∑ l·ªá quy ƒë·ªïi</h4>
                                        <p id="rt-kpi-tl-qd-main" class="font-bold mt-2 mb-3 kpi-percentage-value">0%</p>
           
<p id="rt-kpi-tl-qd-sub" class="text-sm">M·ª•c ti√™u: 0%</p>
                                    </div>
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg">
          
<h4 class="kpi-card-title font-semibold uppercase tracking-wider">Doanh thu tr·∫£ ch·∫≠m</h4>
                                        <p id="rt-kpi-dt-tc-main" class="font-bold mt-2 mb-3">0</p>
                                      
<p id="rt-kpi-dt-tc-sub" class="text-sm">% th·ª±c tr·∫£ ch·∫≠m: <span class="kpi-percentage-value">0%</span></p>
                                    </div>
                                </div>
                                
          
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                                    <div id="realtime-qdc-panel" data-capture-group="1" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200">
                                        <h3 id="realtime-qdc-title" class="text-xl font-bold text-gray-700 mb-4 uppercase
flex items-center gap-2"><span>NH√ìM H√ÄNG QUY ƒê·ªîI CAO</span></h3>
                                        <div id="realtime-qdc-content"><p class="text-gray-500 font-bold">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p></div>
                                    </div>
                          
<div id="realtime-category-panel" data-capture-group="1" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200">
                                        <h3 id="realtime-category-title" class="text-xl font-bold text-gray-700 mb-4 uppercase flex items-center gap-2">
                                            <span>NG√ÄNH H√ÄNG CHI TI·∫æT</span>
    
</h3>
                                        <div id="realtime-category-details-content"><p class="text-gray-500 font-bold">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p></div>
                                
</div>
                                </div>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                                    <div id="realtime-efficiency-panel" data-capture-group="2" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200">
 
<h3 id="realtime-efficiency-title" class="text-xl font-bold text-gray-700 mb-4 uppercase bg-yellow-100 text-yellow-800 p-2 rounded-md">HI·ªÜU QU·∫¢ KHAI TH√ÅC</h3>
                                        <div id="realtime-efficiency-content"><p class="text-gray-500 font-bold">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p></div>
                
</div>
                                    <div id="realtime-unexported-revenue-panel" data-capture-group="2" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200 flex flex-col">
                                         <h3 class="text-xl font-bold uppercase mb-4 bg-red-100 text-red-800 p-2 rounded-md">DOANH THU CH∆ØA
XU·∫§T</h3>
                                        <div id="realtime-unexported-revenue-content" class="flex-grow"><p class="text-gray-500 font-bold text-center">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p></div>
                                    </div>
                              
</div>
                            </div>

                            <div id="subtab-realtime-nhan-vien" class="sub-tab-content hidden space-y-4" data-capture-preset="large-font-report">
                                <div id="realtime-employee-detail-container"></div>
                       
<div id="realtime-revenue-report-container"></div>
                            </div>
                            <div id="subtab-realtime-hieu-qua" class="sub-tab-content hidden space-y-4" data-capture-preset="landscape-table">
                                <div id="realtime-efficiency-report-container"></div>
               
</div>
                            <div id="subtab-realtime-nganh-hang" class="sub-tab-content hidden space-y-4" data-capture-preset="mobile-portrait">
                                <div id="realtime-category-revenue-report-container"></div>
                            </div>
            
<div id="subtab-realtime-hang" class="sub-tab-content hidden space-y-4">
                                <div class="content-card" data-capture-group="1">
                                     <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                      
<h3 class="text-xl font-bold text-gray-700 uppercase">Th·ªëng k√™ theo H√£ng</h3>
                                        <div id="dthang-realtime-view-selector" class="view-switcher">
                                            <button data-view="brand" class="view-switcher__btn active">Theo H√£ng</button>
    
<button data-view="employee" class="view-switcher__btn">Theo Nh√¢n vi√™n</button>
                                        </div>
                                   
</div>
                                    <div class="flex flex-wrap items-center gap-4 mb-4">
                                        <div>
                                     
<label for="realtime-brand-category-filter" class="font-semibold text-sm text-gray-600">Ng√†nh h√†ng:</label>
                                            <select id="realtime-brand-category-filter" class="p-2 border rounded-lg text-sm bg-white shadow-sm mt-1"></select>
                                        </div>
               
<div>
                                            <label for="realtime-brand-filter" class="font-semibold text-sm text-gray-600">H√£ng:</label>
                                            <select id="realtime-brand-filter"
class="p-2 border rounded-lg text-sm bg-white shadow-sm mt-1"></select>
                                        </div>
                                    </div>
                                    
 
<div id="realtime-brand-report-container">
                                        <div id="realtime-brand-table-container"></div>
                                        <div id="realtime-employee-table-container"
class="hidden"></div>
                                    </div>
                                </div>
                            </div>
                       
<div id="subtab-hieu-qua-thi-dua-realtime" class="sub-tab-content hidden space-y-6">
                                <div id="competition-report-container-rt">
                                    <p class="text-gray-500">Vui l√≤ng khai b√°o ch∆∞∆°ng tr√¨nh thi ƒëua trong "Thi·∫øt l·∫≠p m·ª•c ti√™u" ƒë·ªÉ xem b√°o c√°o.</p>
                        
</div>
                            </div>
                            </div>
                    </div>
                </section>

                <section id="declaration-section" class="page-section
hidden">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">Khai b√°o d·ªØ li·ªáu</h2>
                    <div class="content-card">
                        <p class="text-sm text-yellow-600 bg-yellow-50 p-3 rounded-lg mb-4">L∆∞u √Ω: D·ªØ li·ªáu khai b√°o t·∫°i ƒë√¢y s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o tr√¨nh duy·ªát v√† s·ª≠ d·ª•ng cho c√°c logic t√≠nh to√°n. Ch·ªânh s·ª≠a v√† nh·∫•n "L∆∞u" ƒë·ªÉ c·∫≠p nh·∫≠t.</p>
           
                        <div class="space-y-8">
                            <div>
                                <h3 class="text-lg font-bold text-gray-700 mb-2 border-b pb-2">Khai b√°o Danh m·ª•c & C·∫•u tr√∫c</h3>
         
<div class="grid md:grid-cols-2 gap-6 mt-4">
                                    <div class="data-input-group">
                                        <label class="data-input-group__label">Danh m·ª•c Ng√†nh h√†ng - Nh√≥m h√†ng - H√£ng:</label>
      
<div class="data-input-group__content">
                                            <div class="flex items-center gap-2">
                                     
<label for="file-category-structure" class="data-input-group__file-trigger">Th√™m file Excel</label>
                                                <span id="file-name-category-structure" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                            </div>
        
<p class="text-xs text-gray-500">File Excel c√≥ 2 sheet: sheet ƒë·∫ßu ti√™n c√≥ c·ªôt "Ng√†nh h√†ng", "Nh√≥m h√†ng"; sheet th·ª© hai t√™n l√† "H√£ng" c√≥ 1 c·ªôt ch·ª©a t√™n c√°c h√£ng.</p>
                                            <input type="file" id="file-category-structure" class="hidden file-input" data-name="Danh m·ª•c Ng√†nh/Nh√≥m h√†ng" data-state-key="categoryStructure" data-save-key="saved_category_structure"
accept=".xlsx, .xls, .csv">
                                            <div class="data-input-group__status-wrapper">
                                                <span id="file-status-category-structure" class="data-input-group__status-text"></span>
                      
<span id="category-structure-saved-status" class="data-input-group__status-text"></span>
                                            </div>
                                            <div id="progress-category-structure" class="progress-bar-container
hidden"><div class="progress-bar"></div></div>
                                        </div>
                                    </div>
                                </div>
          
</div>

                            <div class="border-t pt-8">
                                <h3 class="text-lg font-bold text-gray-700 mb-2 border-b pb-2">D·ªØ li·ªáu t√≠nh to√°n</h3>
                              
<div class="grid md:grid-cols-2 gap-6 mt-4">
                                    <div>
                                        <label for="declaration-ycx" class="block text-md font-semibold text-gray-700 mb-2">H√¨nh th·ª©c xu·∫•t (T√≠nh doanh thu)</label>
                          
<textarea id="declaration-ycx" rows="8" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm" placeholder="D√°n danh s√°ch c√°c lo·∫°i YCX v√†o ƒë√¢y, m·ªói lo·∫°i m·ªôt d√≤ng..."></textarea>
                                    </div>
                                    <div>
          
<label for="declaration-ycx-gop" class="block text-md font-semibold text-gray-700 mb-2">H√¨nh th·ª©c xu·∫•t (Tr·∫£ g√≥p)</label>
                                        <textarea id="declaration-ycx-gop" rows="8" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm" placeholder="D√°n danh s√°ch c√°c lo·∫°i YCX G√≥p v√†o ƒë√¢y, m·ªói lo·∫°i m·ªôt d√≤ng..."></textarea>
               
</div>
                                    <div class="md:col-span-2">
                                        <label for="declaration-heso" class="block text-md font-semibold text-gray-700 mb-2">H·ªá s·ªë quy ƒë·ªïi</label>
            
<textarea id="declaration-heso" rows="8" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm" placeholder="D√°n danh s√°ch h·ªá s·ªë quy ƒë·ªïi v√†o ƒë√¢y, ƒë·ªãnh d·∫°ng: T√™n nh√≥m h√†ng,H·ªá s·ªë"></textarea>
                                    </div>
                             
</div>
                                <div class="mt-4">
                                    <button id="save-declaration-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition">L∆∞u D·ªØ li·ªáu t√≠nh to√°n</button>
                                </div>
   
</div>

                            <div class="border-t pt-8">
                                <h3 class="text-lg font-bold text-gray-700 mb-2 border-b pb-2">N·ªôi dung H∆∞·ªõng d·∫´n</h3>
                       
<div class="grid md:grid-cols-1 gap-6 mt-4">
                                    <div>
                                        <label for="edit-help-data" class="block text-md font-semibold text-gray-700 mb-2">H∆∞·ªõng d·∫´n Tab C·∫≠p nh·∫≠t d·ªØ li·ªáu</label>
                  
<textarea id="edit-help-data" rows="6" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Nh·∫≠p n·ªôi dung h∆∞·ªõng d·∫´n cho tab C·∫≠p nh·∫≠t d·ªØ li·ªáu..."></textarea>
                                    </div>
                                     <div>
   
<label for="edit-help-luyke" class="block text-md font-semibold text-gray-700 mb-2">H∆∞·ªõng d·∫´n Tab L≈©y k·∫ø</label>
                                        <textarea id="edit-help-luyke" rows="6" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Nh·∫≠p n·ªôi dung h∆∞·ªõng d·∫´n cho tab L≈©y k·∫ø..."></textarea>
             
</div>
                                    <div>
                                        <label for="edit-help-sknv" class="block text-md font-semibold text-gray-700 mb-2">H∆∞·ªõng d·∫´n Tab S·ª©c kh·ªèe NV</label>
         
<textarea id="edit-help-sknv" rows="6" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Nh·∫≠p n·ªôi dung h∆∞·ªõng d·∫´n cho tab S·ª©c kh·ªèe NV..."></textarea>
                                    </div>
                                
<div>
                                        <label for="edit-help-realtime" class="block text-md font-semibold text-gray-700 mb-2">H∆∞·ªõng d·∫´n Tab Realtime</label>
                                        <textarea id="edit-help-realtime" rows="6" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Nh·∫≠p n·ªôi dung h∆∞·ªõng d·∫´n cho tab Realtime..."></textarea>
        
</div>
                                </div>
                                <div class="mt-4">
                          
<button id="save-help-content-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">L∆∞u H∆∞·ªõng d·∫´n</button>
                                </div>
                            </div>
                        </div>
               
</div>
                </section>

            </div>
        </main>
    </div>

    <div id="modal-force-update-container"></div>
    <div id="notification"></div>
    <div id="modal-admin-container"></div>
    <div id="modal-help-container"></div>
    <div id="modal-chart-container"></div>
    <div id="modal-composer-container"></div>
    <div id="modal-preview-container"></div>
    <div id="modal-selection-container"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tailwindScript = document.querySelector('script[src="https://cdn.tailwindcss.com"]');
if (tailwindScript && window.location.protocol !== "file:") {
                console.warn("cdn.tailwindcss.com should not be used in production. To use Tailwind CSS in production, install it as a PostCSS plugin or use the Tailwind CLI: https://tailwindcss.com/docs/installation");
            }
        });
    </script>
    <script type="module" src="./main.js?v=3.5"></script>

</body>
</html>
--- END FILE: ./index.html ---

--- START FILE: ./main.js ---
// Version 3.6 - Refactor: Update imports to use uiRealtime module directly
// MODULE 5: B·ªò ƒêI·ªÄU KHI·ªÇN TRUNG T√ÇM (MAIN)
// File n√†y ƒë√≥ng vai tr√≤ ƒëi·ªÅu ph·ªëi, nh·∫≠p kh·∫©u c√°c module kh√°c v√† kh·ªüi ch·∫°y ·ª©ng d·ª•ng.

import { config } from './config.js';
import { appState } from './state.js';
import { services } from './services.js';
import { ui } from './ui.js';
import { firebase } from './firebase.js';
import { auth } from './auth.js';
import { luykeTab } from './tab-luyke.js';
import { sknvTab } from './tab-sknv.js';
import { uiRealtime } from './ui-realtime.js'; // <<< FIX: IMPORT MODULE M·ªöI
import { initializeEventListeners } from './event-listeners/ui-listeners.js';
import { sidebar } from './components/sidebar.js';
import { storage } from './modules/storage.js';
import { drawerInterface } from './components/drawer-interface.js';
import { drawerGoal } from './components/drawer-goal.js';
import { modalForceUpdate } from './components/modal-force-update.js';
import { modalAdmin } from './components/modal-admin.js';
import { modalHelp } from './components/modal-help.js';
import { modalChart } from './components/modal-chart.js';
import { modalComposer } from './components/modal-composer.js';
import { modalPreview } from './components/modal-preview.js';
import { modalSelection } from './components/modal-selection.js';
import { settingsService } from './modules/settings.service.js';
import { highlightService } from './modules/highlight.service.js';

const app = {
    currentVersion: '3.5',
    storage: storage,

    async init() {
        try {
            appState.competitionConfigs = [];
            appState.viewingDetailFor = null;

            await firebase.init();
            auth.init();

            // Render static UI components
            sidebar.render('#sidebar-container');
            drawerInterface.render('#interface-drawer-container');
            drawerGoal.render('#goal-drawer-container');
            modalForceUpdate.render('#modal-force-update-container');
            modalAdmin.render('#modal-admin-container');
            modalHelp.render('#modal-help-container');
            modalChart.render('#modal-chart-container');
            modalComposer.render('#modal-composer-container');
            modalPreview.render('#modal-preview-container');
            modalSelection.render('#modal-selection-container');

            // === G·ªåI L·ªÜNH V·∫º ICON SAU KHI RENDER COMPONENT ===
            feather.replace();

            this.loadAndApplyBookmarkLink();
            this.loadAndDisplayQrCode(); 
            this.setupMarquee();

            await this.storage.openDB();

            // === START: T·∫¢I T·∫§T C·∫¢ D·ªÆ LI·ªÜU T·ª™ FIRESTORE ===
            console.log("Loading category data from Firestore...");
            const { categories, brands } = await firebase.loadCategoryDataFromFirestore();
            appState.categoryStructure = categories;
            appState.brandList = brands;
            console.log(`Successfully populated ${appState.categoryStructure.length} categories and ${appState.brandList.length} brands from Firestore.`);
            
            console.log("Loading calculation declarations from Firestore...");
            const declarations = await firebase.loadDeclarationsFromFirestore();
            appState.declarations = declarations;
            document.getElementById('declaration-ycx').value = declarations.hinhThucXuat || config.DEFAULT_DATA.HINH_THUC_XUAT_TINH_DOANH_THU.join('\n');
            document.getElementById('declaration-ycx-gop').value = declarations.hinhThucXuatGop || config.DEFAULT_DATA.HINH_THUC_XUAT_TRA_GOP.join('\n');
            document.getElementById('declaration-heso').value = declarations.heSoQuyDoi || Object.entries(config.DEFAULT_DATA.HE_SO_QUY_DOI).map(([k, v]) => `${k},${v}`).join('\n');
            // === END: T·∫¢I T·∫§T C·∫¢ D·ªÆ LI·ªÜU T·ª™ FIRESTORE ===

            initializeEventListeners(this);
            await this.loadDataFromStorage();

            settingsService.loadInterfaceSettings();
            settingsService.applyContrastSetting();
            settingsService.loadHighlightSettings();

            ui.populateAllFilters();

            settingsService.loadAndApplyLuykeGoalSettings();
            settingsService.loadAndApplyRealtimeGoalSettings();

            this.loadPastedDataFromStorage();

            this.switchTab('data-section');
            this.checkForUpdates();
            setInterval(() => this.checkForUpdates(), 15 * 60 * 1000);
        } catch (error) {
            console.error("L·ªói nghi√™m tr·ªçng trong qu√° tr√¨nh kh·ªüi t·∫°o ·ª©ng d·ª•ng:", error);
        }
    },

    async setupMarquee() {
        const marqueeContainer = document.getElementById('version-marquee-container');
        const marqueeText = marqueeContainer?.querySelector('.marquee-text');

        if (!marqueeContainer || !marqueeText) return;

        try {
            const versionRes = await fetch(`./version.json?v=${new Date().getTime()}`);
            const versionInfo = await versionRes.json();
            const currentVersion = versionInfo.version || this.currentVersion;
            marqueeText.textContent = `üî• Chi ti·∫øt b·∫£n c·∫≠p nh·∫≠t - Phi√™n b·∫£n ${currentVersion}`;

            marqueeContainer.addEventListener('click', async () => {
                try {
                     const changelogRes = await fetch(`./changelog.json?v=${new Date().getTime()}`);
                    const changelogData = await changelogRes.json();
                    
                    const modalTitle = document.getElementById('help-modal-title');
                    const modalContent = document.getElementById('help-modal-content');

                     if (modalTitle) modalTitle.textContent = "L·ªãch S·ª≠ C·∫≠p Nh·∫≠t";
                    if (modalContent) {
                        modalContent.innerHTML = this._formatChangelogForModal(changelogData);
                    }
                   
                     ui.toggleModal('help-modal', true);

                } catch (error) {
                    console.error("L·ªói khi t·∫£i ho·∫∑c hi·ªÉn th·ªã changelog:", error);
                    ui.showNotification("Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt c·∫≠p nh·∫≠t.", "error");
                }
            });

        } catch (error) {
             console.error("L·ªói khi thi·∫øt l·∫≠p marquee:", error);
            marqueeText.textContent = "Kh√¥ng th·ªÉ t·∫£i th√¥ng tin phi√™n b·∫£n.";
        }
    },

    _formatChangelogForModal(changelogData) {
        if (!changelogData || changelogData.length === 0) {
            return '<p>Kh√¥ng c√≥ l·ªãch s·ª≠ c·∫≠p nh·∫≠t.</p>';
        }
        return changelogData.map(item => `
            <div class="mb-4 pb-4 border-b last:border-b-0">
                <h4 class="font-bold text-blue-600 mb-2">Phi√™n b·∫£n ${item.version} (${item.date})</h4>
                <ul class="list-disc list-inside text-gray-700 space-y-1 text-sm">
                    ${item.notes.map(note => `<li>${note}</li>`).join('')}
                </ul>
            </div>
        `).join('');
    },
    
    async checkForUpdates() {
        try {
            const response = await fetch(`./version.json?v=${new Date().getTime()}`);
            if (!response.ok) return;
            const serverConfig = await response.json();
            
            if (serverConfig.version && serverConfig.version !== this.currentVersion) {
                console.log(`Phi√™n b·∫£n m·ªõi ${serverConfig.version} ƒë√£ s·∫µn s√†ng!`);

                const changelogRes = await fetch(`./changelog.json?v=${new Date().getTime()}`);
                const changelogData = await changelogRes.json();
                const newVersionDetails = changelogData.find(log => log.version === serverConfig.version);

                const titleEl = document.getElementById('force-update-title');
                const notesContainer = document.getElementById('update-notes-container');

                if (titleEl) {
                    titleEl.textContent = `üì¢ ƒê√£ c√≥ phi√™n b·∫£n m·ªõi ${serverConfig.version}!`;
                }

                if (notesContainer && newVersionDetails && newVersionDetails.notes) {
                    notesContainer.innerHTML = `
                        <p class="text-sm font-semibold text-gray-700 mb-2">N·ªôi dung c·∫≠p nh·∫≠t:</p>
                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            ${newVersionDetails.notes.map(note => `<li>${note}</li>`).join('')}
                        </ul>
                    `;
                } else if (notesContainer) {
                    notesContainer.innerHTML = '<p class="text-sm text-gray-500">Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt c·∫≠p nh·∫≠t.</p>';
                }
                
                ui.toggleModal('force-update-modal', true);
            }
        } catch (error) {
            console.error('Kh√¥ng th·ªÉ ki·ªÉm tra phi√™n b·∫£n m·ªõi:', error);
        }
    },

    async loadDataFromStorage() {
        const loadSavedFile = async (saveKey, stateKey, fileType, uiId) => {
            if (saveKey === 'saved_category_structure') {
                if (appState.categoryStructure.length > 0 || appState.brandList.length > 0) {
                     ui.updateFileStatus('category-structure', 'T·∫£i t·ª´ Cloud', `‚úì ƒê√£ t·∫£i ${appState.categoryStructure.length} nh√≥m & ${appState.brandList.length} h√£ng.`, 'success');
                }
                return;
            }

            const savedData = await this.storage.getItem(saveKey);
            if (!savedData) return;

            try {
                const { normalizedData, success } = services.normalizeData(savedData, fileType);
                if (success) {
                    appState[stateKey] = normalizedData;
                    ui.updateFileStatus(uiId, '', `‚úì ƒê√£ t·∫£i ${normalizedData.length} d√≤ng.`, 'success');
                }
             } catch (e) { console.error(`L·ªói ƒë·ªçc ${uiId} t·ª´ IndexedDB:`, e); }
        };

        await loadSavedFile('saved_danhsachnv', 'danhSachNhanVien', 'danhsachnv', 'danhsachnv');
        if (appState.danhSachNhanVien.length > 0) {
            services.updateEmployeeMaps();
        }
        await loadSavedFile('saved_category_structure', null, null, null);
        await loadSavedFile('saved_ycx_thangtruoc', 'ycxDataThangTruoc', 'ycx', 'ycx-thangtruoc');
        await loadSavedFile('saved_thuongnong_thangtruoc', 'thuongNongDataThangTruoc', 'thuongnong', 'thuongnong-thangtruoc');
        await loadSavedFile('saved_ycx', 'ycxData', 'ycx', 'ycx');
        await loadSavedFile('saved_giocong', 'rawGioCongData', 'giocong', 'giocong');
        await loadSavedFile('saved_thuongnong', 'thuongNongData', 'thuongnong', 'thuongnong');

        try {
            const savedLuykeGoals = localStorage.getItem('luykeGoalSettings');
            if(savedLuykeGoals) appState.luykeGoalSettings = JSON.parse(savedLuykeGoals);

            const savedRealtimeGoals = localStorage.getItem('realtimeGoalSettings');
            if (savedRealtimeGoals) appState.realtimeGoalSettings = JSON.parse(savedRealtimeGoals);

            const savedTemplates = localStorage.getItem('composerTemplates');
            if (savedTemplates) {
                let parsedTemplates = JSON.parse(savedTemplates);
                for (const key in parsedTemplates) {
                    if (typeof parsedTemplates[key] === 'string') {
                        const oldString = parsedTemplates[key];
                        parsedTemplates[key] = {};
                        if (key === 'luyke') parsedTemplates[key]['subtab-luyke-sieu-thi'] = oldString;
                        else if (key === 'sknv') parsedTemplates[key]['subtab-sknv'] = oldString;
                        else if (key === 'realtime') parsedTemplates[key]['subtab-realtime-sieu-thi'] = oldString;
                    }
                 }
                appState.composerTemplates = parsedTemplates;
            } else {
                appState.composerTemplates = { luyke: {}, sknv: {}, realtime: {} };
            }

            const savedCompetition = localStorage.getItem('competitionConfigs');
            if (savedCompetition) appState.competitionConfigs = JSON.parse(savedCompetition);

        } catch (e) { console.error("L·ªói ƒë·ªçc c√†i ƒë·∫∑t t·ª´ localStorage:", e); }
    },

    loadPastedDataFromStorage() {
        const pasteThuongERPThangTruoc = localStorage.getItem('saved_thuongerp_thangtruoc');
        if (pasteThuongERPThangTruoc) {
             const el = document.getElementById('paste-thuongerp-thangtruoc');
            if(el) {
                el.value = pasteThuongERPThangTruoc;
                this.handleErpThangTruocPaste({ target: el });
            }
        }
        const pasteLuyke = localStorage.getItem('daily_paste_luyke');
        if (pasteLuyke) {
            document.getElementById('paste-luyke').value = pasteLuyke;
            this.handleLuykePaste();
        }

        const pasteThiduaNV = localStorage.getItem('daily_paste_thiduanv');
        if (pasteThiduaNV) {
            document.getElementById('paste-thiduanv').value = pasteThiduaNV;
            this.handleThiduaNVPaste();
        }

         const pasteThuongERP = localStorage.getItem('daily_paste_thuongerp');
        if (pasteThuongERP) {
             const el = document.getElementById('paste-thuongerp');
            if(el) {
                el.value = pasteThuongERP;
                this.handleErpPaste();
            }
        }
    },

    handleFileRead(file) {
        return new Promise((resolve, reject) => {
            if (!file) return reject(new Error("No file provided."));
            const reader = new FileReader();
             reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    resolve(workbook);
                } catch (err) { reject(err); }
             };
            reader.onerror = (err) => reject(new Error("Could not read the file: " + err));
            reader.readAsArrayBuffer(file);
        });
    },

    updateAndRenderCurrentTab() {
        if (appState.danhSachNhanVien.length === 0) return;

        ui.renderCompetitionConfigUI();

        const activeTab = document.querySelector('.page-section:not(.hidden)');
        if (!activeTab) return;

        switch (activeTab.id) {
            case 'health-section':
                 luykeTab.render();
                break;
            case 'health-employee-section':
                sknvTab.render();
                break;
            case 'realtime-section':
                // <<< FIX: Call render from the correct module >>>
                uiRealtime.render();
                break;
        }
        // === G·ªåI L·ªÜNH V·∫º ICON SAU KHI RENDER L·∫†I TAB ===
        feather.replace();
    },

    switchTab(targetId) {
        document.querySelectorAll('.page-section').forEach(section => section.classList.toggle('hidden', section.id !== targetId));
        document.querySelectorAll('.nav-link').forEach(link => {
            const isActive = link.getAttribute('href') === `#${targetId}`;
             link.classList.toggle('bg-blue-100', isActive);
            link.classList.toggle('text-blue-700', isActive);
        });

        if (targetId === 'home-section') ui.renderHomePage();
        else if (targetId === 'health-section') luykeTab.render();
        else if (targetId === 'health-employee-section') sknvTab.render();
        else if (targetId === 'realtime-section') uiRealtime.render(); // <<< FIX: Call render from the correct module >>>
        else if (targetId === 'declaration-section' && appState.isAdmin) ui.renderAdminHelpEditors();

        // === G·ªåI L·ªÜNH V·∫º ICON SAU KHI CHUY·ªÇN TAB ===
        feather.replace();
    },

    async loadAndApplyBookmarkLink() {
        try {
            const bookmarkUrl = await firebase.getBookmarkDownloadURL();
            const linkElement = document.getElementById('download-bookmark-link');
            if (linkElement) {
                 linkElement.href = bookmarkUrl;
            }
        } catch (error) {
            console.error("Kh√¥ng th·ªÉ t·∫£i link bookmark:", error);
            const linkElement = document.getElementById('download-bookmark-link');
            if (linkElement) {
                linkElement.style.display = 'none';
            }
        }
    },

    handleLuykePaste() {
        const pastedText = document.getElementById('paste-luyke')?.value || '';
        localStorage.setItem('daily_paste_luyke', pastedText);
        ui.updatePasteStatus('status-luyke');
        this.updateAndRenderCurrentTab();
    },

    handleThiduaNVPaste() {
        const pastedText = document.getElementById('paste-thiduanv')?.value || '';
        localStorage.setItem('daily_paste_thiduanv', pastedText);
        sknvTab.render();
        ui.updatePasteStatus('status-thiduanv', '‚úì ƒê√£ x·ª≠ l√Ω v√† hi·ªÉn th·ªã b√°o c√°o.');
    },

    handleErpPaste() {
        const pastedText = document.getElementById('paste-thuongerp')?.value || '';
        localStorage.setItem('daily_paste_thuongerp', pastedText);
        appState.thuongERPData = services.processThuongERP(pastedText);
        ui.updatePasteStatus('status-thuongerp', `‚úì ƒê√£ x·ª≠ l√Ω ${appState.thuongERPData.length} nh√¢n vi√™n.`);
        this.updateAndRenderCurrentTab();
    },

    handleErpThangTruocPaste(e) {
         const pastedText = e.target.value;
         localStorage.setItem('saved_thuongerp_thangtruoc', pastedText);
         appState.thuongERPDataThangTruoc = services.processThuongERP(pastedText);
         ui.updatePasteStatus('status-thuongerp-thangtruoc', `‚úì ƒê√£ x·ª≠ l√Ω ${appState.thuongERPDataThangTruoc.length} nh√¢n vi√™n.`);
         sknvTab.render();
    },

    async handleRealtimeFileInput(e) {
        const file = e.target.files[0];
        if (!file) return;
        ui.showNotification('ƒêang x·ª≠ l√Ω file realtime...', 'success');
        appState.realtimeYCXData = [];
        e.target.value = '';
        try {
            const workbook = await this.handleFileRead(file);
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const { normalizedData, success, missingColumns } = services.normalizeData(rawData, 'ycx');
            ui.displayDebugInfo('ycx-realtime');
            if (success) {
                appState.realtimeYCXData = normalizedData;
                ui.populateRealtimeBrandCategoryFilter();
                ui.showNotification(`T·∫£i th√†nh c√¥ng ${normalizedData.length} d√≤ng realtime!`, 'success');
                this.updateAndRenderCurrentTab();
            } else {
                 ui.showNotification(`File realtime l·ªói: Thi·∫øu c·ªôt ${missingColumns.join(', ')}.`, 'error');
                 if (document.getElementById('debug-tool-container')?.classList.contains('hidden')) {
                     document.getElementById('toggle-debug-btn')?.click();
                 }
            }
        } catch (err) { ui.showNotification(`C√≥ l·ªói khi ƒë·ªçc file: ${err.message}`, 'error'); console.error(err); }
    },
    
    async handleCategoryFile(e) {
        const fileInput = e.target;
        const file = fileInput.files[0];
        if (!file) return;
        ui.updateFileStatus('category-structure', file.name, 'ƒêang x·ª≠ l√Ω...', 'default');
        ui.showProgressBar('category-structure');
        try {
            const workbook = await this.handleFileRead(file);
            const categorySheet = workbook.Sheets[workbook.SheetNames[0]];
            const categoryRawData = XLSX.utils.sheet_to_json(categorySheet);
            const categoryResult = services.normalizeCategoryStructureData(categoryRawData);
            let brandResult = { success: true, normalizedData: [] };
            const brandSheetName = workbook.SheetNames.find(name => name.toLowerCase().trim() === 'h√£ng');
            if (brandSheetName) {
                const brandSheet = workbook.Sheets[brandSheetName];
                const brandRawData = XLSX.utils.sheet_to_json(brandSheet);
                brandResult = services.normalizeBrandData(brandRawData);
            }
            if(categoryResult.success) {
                appState.categoryStructure = categoryResult.normalizedData;
                appState.brandList = brandResult.normalizedData;
                await firebase.saveCategoryDataToFirestore({ categories: categoryResult.normalizedData, brands: brandResult.normalizedData });
                ui.updateFileStatus('category-structure', file.name, `‚úì ƒê√£ x·ª≠ l√Ω v√† ƒë·ªìng b·ªô ${categoryResult.normalizedData.length} nh√≥m & ${brandResult.normalizedData.length} h√£ng.`, 'success');
            } else {
                ui.showNotification(`L·ªói x·ª≠ l√Ω file khai b√°o: ${categoryResult.error}`, 'error');
            }
        } catch (error) {
            ui.updateFileStatus('category-structure', file.name, `L·ªói: ${error.message}`, 'error');
        } finally {
            ui.hideProgressBar('category-structure');
            fileInput.value = '';
        }
    },
    
    async handleThiDuaVungFileInput(e) {
        const fileInput = e.target;
        const file = fileInput.files[0];
        if (!file) return;
        ui.updateFileStatus('thidua-vung', file.name, 'ƒêang x·ª≠ l√Ω...', 'default');
        try {
            const workbook = await this.handleFileRead(file);
            const { chiTietData, tongData } = services.processThiDuaVungFile(workbook);
            if (!tongData || tongData.length === 0) throw new Error('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá trong sheet "TONG".');
            appState.thiDuaVungChiTiet = chiTietData;
            appState.thiDuaVungTong = tongData;
            const supermarketKey = Object.keys(tongData[0]).find(k => k.trim().toLowerCase().includes('si√™u th·ªã'));
            const supermarketNames = [...new Set(tongData.map(row => row[supermarketKey]).filter(Boolean))].sort();
            const choicesInstance = appState.choices.thiDuaVung_sieuThi;
            if (choicesInstance) {
                choicesInstance.clearStore();
                choicesInstance.setChoices(supermarketNames.map(name => ({ value: name, label: name })), 'value', 'label', true);
            }
            ui.updateFileStatus('thidua-vung', file.name, `‚úì ƒê√£ x·ª≠ l√Ω ${supermarketNames.length} si√™u th·ªã.`, 'success');
        } catch (error) {
            ui.updateFileStatus('thidua-vung', file.name, `L·ªói: ${error.message}`, 'error');
        }
    },

    handleThiDuaVungFilterChange() {
        const choicesInstance = appState.choices.thiDuaVung_sieuThi;
        if (!choicesInstance) return;
        const selectedValue = choicesInstance.getValue(true);
        if (selectedValue) {
            const reportData = services.generateThiDuaVungReport(selectedValue);
            ui.renderThiDuaVungInfographic(reportData);
        } else {
            const container = document.getElementById('thidua-vung-infographic-container');
            if(container) container.innerHTML = `<div class="placeholder-message">Vui l√≤ng ch·ªçn m·ªôt si√™u th·ªã ƒë·ªÉ xem b√°o c√°o.</div>`;
        }
    },

    handleDthangRealtimeViewChange(e) {
        const button = e.target.closest('.view-switcher__btn');
        if (button) {
            document.querySelectorAll('#dthang-realtime-view-selector .view-switcher__btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            uiRealtime.render();
        }
    },

    handleLuykeThiDuaViewChange(e) {
        const button = e.target.closest('.view-switcher__btn');
        if (button) {
            document.querySelectorAll('#luyke-thidua-view-selector .view-switcher__btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            luykeTab.render();
        }
    },

    handleThiDuaViewChange(e) {
        const button = e.target.closest('.view-switcher__btn');
        if (button) {
             document.querySelectorAll('#thidua-view-selector .view-switcher__btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            const view = button.dataset.view;
            document.getElementById('thidua-employee-selector-container').classList.toggle('hidden', view !== 'employee');
            ui.displayCompetitionReport(view);
        }
    },

    async handleCompetitionDebugFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        ui.showNotification('ƒêang ph√¢n t√≠ch file g·ª° l·ªói...', 'success');
        try {
            const workbook = await this.handleFileRead(file);
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const debugResults = services.debugCompetitionFiltering(rawData);
            ui.renderCompetitionDebugReport(debugResults);
        } catch (err) {
            ui.showNotification(`L·ªói khi ƒë·ªçc file g·ª° l·ªói: ${err.message}`, 'error');
        }
    },

    _handleCompetitionFormShow(show = true, isEdit = false) {
        const form = document.getElementById('competition-form');
        const addBtn = document.getElementById('add-competition-btn');
        if (!form || !addBtn) return;

        if (show) {
            ui.populateCompetitionFilters();
            ui.populateCompetitionBrandFilter();
        }

        form.classList.toggle('hidden', !show);
        addBtn.classList.toggle('hidden', show);

        if (show && !isEdit) {
            form.reset();
            document.getElementById('competition-id').value = '';
            appState.choices['competition_group']?.removeActiveItems();
            appState.choices['competition_brand']?.removeActiveItems();
            document.getElementById('price-segment').classList.add('hidden');
        }
    },

    _handleCompetitionFormEdit(index) {
        const config = appState.competitionConfigs[index];
        if (!config) return;

        this._handleCompetitionFormShow(true, true);
        
        document.getElementById('competition-id').value = index;
        document.getElementById('competition-name').value = config.name;
        
        const brandChoices = appState.choices['competition_brand'];
        if(brandChoices) {
            brandChoices.removeActiveItems();
            brandChoices.setChoiceByValue(config.brands || []);
        }

        document.getElementById('competition-type').value = config.type;
        document.getElementById('competition-exclude-apple').checked = config.excludeApple;
        
        const priceSegment = document.getElementById('price-segment');
        priceSegment.classList.toggle('hidden', config.type !== 'soluong');

        document.getElementById('competition-min-price').value = config.minPrice ? config.minPrice / 1000000 : '';
        document.getElementById('competition-max-price').value = config.maxPrice ? config.maxPrice / 1000000 : '';

        const groupChoices = appState.choices['competition_group'];
        if (groupChoices) {
            groupChoices.removeActiveItems();
            groupChoices.setChoiceByValue(config.groups);
        }
    },

    _handleCompetitionDelete(index) {
        appState.competitionConfigs.splice(index, 1);
        this._saveCompetitionConfigs();
        this.updateAndRenderCurrentTab();
        ui.showNotification('ƒê√£ x√≥a ch∆∞∆°ng tr√¨nh thi ƒëua.', 'success');
    },

    _handleCompetitionFormSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('competition-id').value;
        const name = document.getElementById('competition-name').value.trim();
        if (!name) {
             ui.showNotification('T√™n ch∆∞∆°ng tr√¨nh kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.', 'error');
            return;
        }

        const groupChoices = appState.choices['competition_group'];
        const groups = groupChoices ? groupChoices.getValue(true) : [];

        const brandChoices = appState.choices['competition_brand'];
        const brands = brandChoices ? brandChoices.getValue(true) : [];
        if (brands.length === 0) {
            ui.showNotification('L·ªói: Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h√£ng s·∫£n xu·∫•t.', 'error');
            return;
        }
        
        const newConfig = {
            id: id ? appState.competitionConfigs[parseInt(id, 10)].id : `comp_${new Date().getTime()}`,
            name: name,
            brands: brands,
            groups: groups,
            type: document.getElementById('competition-type').value,
            minPrice: (parseFloat(document.getElementById('competition-min-price').value) || 0) * 1000000,
            maxPrice: (parseFloat(document.getElementById('competition-max-price').value) || 0) * 1000000,
            excludeApple: document.getElementById('competition-exclude-apple').checked,
        };

        if (id !== '') {
             appState.competitionConfigs[parseInt(id, 10)] = newConfig;
        } else {
            appState.competitionConfigs.push(newConfig);
        }

        this._saveCompetitionConfigs();
        this._handleCompetitionFormShow(false);
        this.updateAndRenderCurrentTab();
        ui.showNotification('ƒê√£ l∆∞u ch∆∞∆°ng tr√¨nh thi ƒëua th√†nh c√¥ng!', 'success');
    },

     _saveCompetitionConfigs() {
        localStorage.setItem('competitionConfigs', JSON.stringify(appState.competitionConfigs));
    },
    
    async handleTemplateDownload() {
        ui.showNotification('ƒêang chu·∫©n b·ªã file m·∫´u...', 'success');
        try {
            const url = await firebase.getTemplateDownloadURL();
            const link = document.createElement('a');
            link.href = url;
            link.download = 'Danh_Sach_Nhan_Vien_Mau.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error("L·ªói khi t·∫£i file m·∫´u:", error);
            ui.showNotification('Kh√¥ng th·ªÉ t·∫£i file m·∫´u. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
        }
    },

    handleAdminLogin() {
        if (document.getElementById('admin-password-input').value === config.ADMIN_PASSWORD) {
            appState.isAdmin = true;
            ui.renderFeedbackSection();
            ui.renderAdminHelpEditors();
            this.switchTab('declaration-section');
            ui.toggleModal('admin-modal', false);
            document.getElementById('admin-password-input').value = '';
            document.getElementById('admin-error-msg').classList.add('hidden');
        } else {
            document.getElementById('admin-error-msg').classList.remove('hidden');
        }
    },
    
    handleContrastChange(e) {
         const level = e.target.value;
        localStorage.setItem('contrastLevel', level);
        document.documentElement.dataset.contrast = level;
    },

    handleHighlightColorChange(prefix) {
        const activeType = appState.highlightSettings[prefix]?.type;
        if (activeType) {
             const choicesInstance = appState.choices[`${prefix}_highlight_${activeType}`];
             if(choicesInstance) {
                const values = choicesInstance.getValue(true);
                const color = document.getElementById(`${prefix}-highlight-color`).value;
                appState.highlightSettings[prefix] = { type: activeType, values, color };
                localStorage.setItem('highlightSettings', JSON.stringify(appState.highlightSettings));
                highlightService.applyHighlights(prefix);
             }
        }
    },

    handleClearHighlight(prefix) {
        appState.highlightSettings[prefix] = {};
        localStorage.setItem('highlightSettings', JSON.stringify(appState.highlightSettings));
        ['nhanhang', 'nhomhang', 'employee'].forEach(type => {
             appState.choices[`${prefix}_highlight_${type}`]?.removeActiveItemsByValue(appState.choices[`${prefix}_highlight_${type}`]?.getValue(true) || []);
        });
        highlightService.applyHighlights(prefix);
    },

    async saveDeclarations() {
        const declarationsToSave = {
            ycx: document.getElementById('declaration-ycx').value,
            ycxGop: document.getElementById('declaration-ycx-gop').value,
            heSo: document.getElementById('declaration-heso').value
        };
        // Ghi l√™n Firebase
        await firebase.saveDeclarationsToFirestore(declarationsToSave);
        // C·∫≠p nh·∫≠t state c·ª•c b·ªô ngay l·∫≠p t·ª©c
         appState.declarations.hinhThucXuat = declarationsToSave.ycx;
        appState.declarations.hinhThucXuatGop = declarationsToSave.ycxGop;
        appState.declarations.heSoQuyDoi = declarationsToSave.heSo;
        // Render l·∫°i tab hi·ªán t·∫°i ƒë·ªÉ √°p d·ª•ng thay ƒë·ªïi
        this.updateAndRenderCurrentTab();
    },
    
    saveHelpContent() {
        const contents = {
            data: document.getElementById('edit-help-data').value,
            luyke: document.getElementById('edit-help-luyke').value,
            sknv: document.getElementById('edit-help-sknv').value,
            realtime: document.getElementById('edit-help-realtime').value
        };
        firebase.saveHelpContent(contents);
    },
    
    async handleSubmitFeedback() {
        const textarea = document.getElementById('feedback-textarea');
        const success = await firebase.submitFeedback(textarea.value.trim());
        if (success) textarea.value = '';
    },
    
    async handleFeedbackReplyActions(e, feedbackItem) {
        const docId = feedbackItem.dataset.id;
        const replyForm = feedbackItem.querySelector('.reply-form-container');
        if (e.target.classList.contains('reply-btn')) {
            replyForm.classList.remove('hidden');
        }
        if (e.target.classList.contains('cancel-reply-btn')) {
            replyForm.classList.add('hidden');
        }
        if (e.target.classList.contains('submit-reply-btn')) {
             const textarea = replyForm.querySelector('textarea');
            const success = await firebase.submitReply(docId, textarea.value.trim());
            if (success) {
                textarea.value = '';
                replyForm.classList.add('hidden');
            }
        }
    },

    _getFilteredReportData(sectionId) {
        const masterData = appState.masterReportData[sectionId] || [];
        if (masterData.length === 0) return [];

        const selectedWarehouse = document.getElementById(`${sectionId}-filter-warehouse`).value;
        const selectedDept = document.getElementById(`${sectionId}-filter-department`).value;
        const selectedNames = appState.choices[`${sectionId}_employee`] ? appState.choices[`${sectionId}_employee`].getValue(true) : [];
        
        let filteredReport = masterData;
        if (selectedWarehouse) filteredReport = filteredReport.filter(nv => nv.maKho == selectedWarehouse);
        if (selectedDept) filteredReport = filteredReport.filter(nv => nv.boPhan === selectedDept);
        if (selectedNames && selectedNames.length > 0) filteredReport = filteredReport.filter(nv => selectedNames.includes(String(nv.maNV)));

        return filteredReport;
    },

    async prepareAndShowComposer(sectionId) {
        const modal = document.getElementById('composer-modal');
        if (!modal) return;
        modal.dataset.sectionId = sectionId;

        const deptFilter = document.getElementById('composer-dept-filter');
        if (deptFilter) {
            const uniqueDepartments = [...new Set(appState.danhSachNhanVien.map(nv => nv.boPhan).filter(Boolean))].sort();
            deptFilter.innerHTML = '<option value="ALL">To√†n si√™u th·ªã</option>' + uniqueDepartments.map(dept => `<option value="${dept}">${dept}</option>`).join('');
        }
        
        const navIdMap = { luyke: 'luyke-subtabs-nav', sknv: 'employee-subtabs-nav', realtime: 'realtime-subtabs-nav' };
        const mainViewNav = document.getElementById(navIdMap[sectionId]);
        const contextTabsContainer = document.getElementById('composer-context-tabs');
        const contextContentContainer = document.getElementById('composer-context-content');
        contextTabsContainer.innerHTML = '';
        contextContentContainer.innerHTML = '';

        if (mainViewNav) {
            const subTabButtons = mainViewNav.querySelectorAll('.sub-tab-btn');
            subTabButtons.forEach(btn => {
                const subTabId = btn.dataset.target;
                const isActive = btn.classList.contains('active');

                const newTabBtn = document.createElement('button');
                newTabBtn.className = `composer__tab-btn ${isActive ? 'active' : ''}`;
             
                newTabBtn.dataset.target = `context-pane-${subTabId}`;
                newTabBtn.textContent = btn.textContent.trim();
                newTabBtn.addEventListener('click', () => {
                    contextTabsContainer.querySelectorAll('.composer__tab-btn').forEach(t => t.classList.remove('active'));
                    contextContentContainer.querySelectorAll('.composer__context-pane').forEach(c => c.classList.add('hidden'));
                    newTabBtn.classList.add('active');
             
                    document.getElementById(`context-pane-${subTabId}`).classList.remove('hidden');
                });
                contextTabsContainer.appendChild(newTabBtn);

                const newContentPane = document.createElement('div');
                newContentPane.id = `context-pane-${subTabId}`;
                newContentPane.className = `composer__context-pane ${!isActive ? 'hidden' : ''}`;
                
                const textarea = document.createElement('textarea');
                textarea.className = 'composer__textarea';
                textarea.rows = 15;
                textarea.placeholder = `So·∫°n th·∫£o nh·∫≠n x√©t cho tab ${btn.textContent.trim()}...`;
                
                if (!appState.composerTemplates[sectionId]) {
                    appState.composerTemplates[sectionId] = {};
                }
     
                textarea.value = appState.composerTemplates[sectionId][subTabId] || '';
                
                newContentPane.appendChild(textarea);
                contextContentContainer.appendChild(newContentPane);
            });
        }
        
        contextTabsContainer.classList.toggle('hidden', contextTabsContainer.children.length === 0);

        const filteredReportData = this._getFilteredReportData(sectionId);
        const supermarketReport = services.aggregateReport(filteredReportData);
        ui.populateComposerDetailTags(supermarketReport);

        ui.showComposerModal(sectionId);
    },

    handleComposerActions(e, modal) {
        const sectionId = modal.dataset.sectionId;
        const activeContextPane = modal.querySelector('.composer__context-pane:not(.hidden)');
        const activeTextarea = activeContextPane ? activeContextPane.querySelector('textarea') : null;
        
        if (e.target.matches('.composer__tab-btn:not([data-context-tab])')) {
             const nav = e.target.closest('.composer__nav');
            const content = nav.nextElementSibling;
            if (nav && content) {
             
                nav.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
                content.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
                e.target.classList.add('active');
                const targetId = e.target.dataset.tab;
                const targetContent = content.querySelector(`#${targetId}`);
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            }
            return;
        }

        if (e.target.matches('.composer__icon-btn, .composer__tag-btn')) {
             if (!activeTextarea) {
                ui.showNotification("Vui l√≤ng ch·ªçn m·ªôt tab n·ªôi dung ƒë·ªÉ ch√®n th·∫ª.", "error");
            }
             let tagToInsert = e.target.dataset.tag;
            if (e.target.dataset.tagTemplate) {
                const dept = document.getElementById('composer-dept-filter').value;
                tagToInsert = e.target.dataset.tagTemplate.replace('{dept}', dept);
            }
            ui.insertComposerTag(activeTextarea, tagToInsert || e.target.textContent);
            return;
        }

        if (e.target.id === 'save-composer-template-btn') {
            if (!activeTextarea) return;
            const activeContextTab = modal.querySelector('#composer-context-tabs .composer__tab-btn.active');
            const subTabId = activeContextTab?.dataset.target.replace('context-pane-', '');
            if (subTabId) {
                 if (!appState.composerTemplates[sectionId]) appState.composerTemplates[sectionId] =
{};
                appState.composerTemplates[sectionId][subTabId] = activeTextarea.value;
                localStorage.setItem('composerTemplates', JSON.stringify(appState.composerTemplates));
                ui.showNotification(`ƒê√£ l∆∞u m·∫´u cho tab con!`, 'success');
            } else {
                ui.showNotification(`Kh√¥ng t√¨m th·∫•y tab con ƒë·ªÉ l∆∞u.`, 'error');
            }
        }
        
        if (e.target.id === 'copy-composed-notification-btn') {
            if (!activeTextarea) {
                 ui.showNotification("L·ªói: Kh√¥ng t√¨m th·∫•y √¥ n·ªôi dung ƒëang ho·∫°t ƒë·ªông.", "error"); 
                return;
            }

         
            const template = activeTextarea.value;
            
            const filteredReportData = this._getFilteredReportData(sectionId);
            const supermarketReport = services.aggregateReport(filteredReportData);
            
            const selectedWarehouse = document.getElementById(`${sectionId}-filter-warehouse`).value;
            const goals = sectionId === 'realtime' ? settingsService.getRealtimeGoalSettings(selectedWarehouse).goals : settingsService.getLuykeGoalSettings(selectedWarehouse).goals;
            
            const competitionDataForComposer = services.parseCompetitionDataFromLuyKe(document.getElementById('paste-luyke')?.value || '');
            
            const processedText = services.processComposerTemplate(template, supermarketReport, goals, filteredReportData, competitionDataForComposer, sectionId);

            ui.showPreviewAndCopy(processedText);
        }
    },
    
    async loadAndDisplayQrCode() {
        try {
            const qrUrl = await firebase.getQrCodeDownloadURL();
            const imgEl = document.getElementById('header-qr-image');
            if (imgEl) {
                imgEl.src = qrUrl;
            }
        }
        catch (error) {
             console.error("Kh√¥ng th·ªÉ t·∫£i m√£ QR:", error);
            const container = document.querySelector('.header-qr-container');
            if (container) {
                container.style.display = 'none';
            }
        }
    }
};

app.init();
--- END FILE: ./main.js ---

--- START FILE: ./modules/capture.service.js ---
// Version 1.0 - Refactored from utils.js
// MODULE: CAPTURE SERVICE
// Ch·ª©a to√†n b·ªô logic li√™n quan ƒë·∫øn vi·ªác ch·ª•p ·∫£nh m√†n h√¨nh c√°c th√†nh ph·∫ßn UI.

import { ui } from '../ui.js';
import { firebase } from '../firebase.js';

// --- HELPER for Screenshot CSS Injection ---
const _injectCaptureStyles = () => {
    const styleId = 'dynamic-capture-styles';
    document.getElementById(styleId)?.remove();

    const styles = `
        .capture-container { 
            padding: 24px; 
            background-color: #f3f4f6; 
            box-sizing: border-box; 
            width: fit-content; 
            position: absolute;
            left: -9999px;
            top: 0;
            z-index: -1;
        }
        .capture-layout-container { 
            display: flex; 
            flex-direction: column; 
            gap: 24px; 
        }
        .capture-title { 
            font-size: 28px; 
            font-weight: 700; 
            text-align: center; 
            color: #1f2937; 
            margin-bottom: 24px; 
            padding: 12px; 
            background-color: #ffffff; 
            border-radius: 0.75rem; 
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); 
        }
        /* --- VIRTUAL STAGES / PRESETS --- */
        .prepare-for-kpi-capture {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 24px !important;
            width: 900px !important;
        }
        .preset-mobile-portrait {
            width: 750px !important;
        }
        .preset-landscape-table {
            width: fit-content !important;
        }
        .preset-landscape-table table {
            table-layout: fixed !important;
        }
        .preset-landscape-table th, 
        .preset-landscape-table td {
            width: 95px !important;
            word-wrap: break-word;
        }
        .preset-landscape-table th:first-child,
        .preset-landscape-table td:first-child {
            width: 180px !important;
        }
        .preset-large-font-report {
            width: 800px !important;
        }
        .preset-large-font-report table th {
            white-space: normal !important;
            vertical-align: middle;
        }
        .preset-large-font-report table td {
            font-size: 22px !important;
            vertical-align: middle;
        }
        .preset-infographic-wide {
            width: 1100px !important;
        }
    `;

    const styleElement = document.createElement('style');
    styleElement.id = styleId;
    styleElement.innerHTML = styles;
    document.head.appendChild(styleElement);
    return styleElement;
};

export const captureService = {
    async captureAndDownload(elementToCapture, title, presetClass = '') {
        const date = new Date();
        const timeString = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        const dateString = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
        const finalTitle = `${title.replace(/_/g, ' ')} - ${timeString} ${dateString}`;
    
        const captureWrapper = document.createElement('div');
        captureWrapper.className = 'capture-container';
    
        const titleEl = document.createElement('h2');
        titleEl.className = 'capture-title';
        titleEl.textContent = finalTitle;
        captureWrapper.appendChild(titleEl);
        
        const contentClone = elementToCapture.cloneNode(true);
        if (presetClass) {
            contentClone.classList.add(presetClass);
        }
        captureWrapper.appendChild(contentClone);

        document.body.appendChild(captureWrapper);
    
        try {
            const canvas = await html2canvas(captureWrapper, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#f3f4f6'
            });
    
            const link = document.createElement('a');
            link.download = `${title}_${dateString.replace(/\//g, '-')}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            ui.showNotification('ƒê√£ ch·ª•p v√† t·∫£i xu·ªëng h√¨nh ·∫£nh!', 'success');
        } catch (err) {
            console.error('L·ªói ch·ª•p m√†n h√¨nh:', err);
            ui.showNotification(`L·ªói khi ch·ª•p ·∫£nh: ${err.message}.`, 'error');
        } finally {
            if (document.body.contains(captureWrapper)) {
                document.body.removeChild(captureWrapper);
            }
        }
    },
    
    async captureDashboardInParts(contentContainer, baseTitle) {
        if (!contentContainer) {
            ui.showNotification('Kh√¥ng t√¨m th·∫•y v√πng n·ªôi dung ƒë·ªÉ ch·ª•p.', 'error');
            return;
        }

        firebase.incrementCounter('actionsTaken');
        
        ui.showNotification(`B·∫Øt ƒë·∫ßu ch·ª•p b√°o c√°o ${baseTitle}...`, 'success');
    
        const captureGroups = new Map();
        contentContainer.querySelectorAll('[data-capture-group]').forEach(el => {
            if (el.offsetParent !== null) {
                const group = el.dataset.captureGroup;
                if (!captureGroups.has(group)) {
                    captureGroups.set(group, []);
                }
                captureGroups.get(group).push(el);
            }
        });
        
        const styleElement = _injectCaptureStyles();
        try {
            if (captureGroups.size === 0) {
                if (contentContainer.offsetParent !== null) {
                    const preset = contentContainer.dataset.capturePreset;
                    const presetClass = preset ? `preset-${preset}` : '';
                    await this.captureAndDownload(contentContainer, baseTitle, presetClass);
                } else {
                     ui.showNotification('Kh√¥ng t√¨m th·∫•y ƒë·ªëi t∆∞·ª£ng hi·ªÉn th·ªã ƒë·ªÉ ch·ª•p.', 'error');
                }
                return;
            }

            for (const [group, elements] of captureGroups.entries()) {
                const captureTitle = captureGroups.size > 1 ? `${baseTitle}_Nhom_${group}` : baseTitle;
                
                const targetElement = elements[0];
                const preset = targetElement.dataset.capturePreset;
                const isKpiGroup = group === 'kpi';
                
                let elementToCapture;
                let presetClass = '';

                if (isKpiGroup) {
                    presetClass = 'prepare-for-kpi-capture';
                } else if (preset) {
                    presetClass = `preset-${preset}`;
                }

                if (elements.length > 1 && !isKpiGroup) {
                    const tempContainer = document.createElement('div');
                    tempContainer.className = 'capture-layout-container';
                    elements.forEach(el => tempContainer.appendChild(el.cloneNode(true)));
                    elementToCapture = tempContainer;
                } else {
                    elementToCapture = targetElement;
                }
    
                await this.captureAndDownload(elementToCapture, captureTitle, presetClass);
                await new Promise(resolve => setTimeout(resolve, 150));
            }
        } finally {
            styleElement.remove();
        }

        ui.showNotification(`ƒê√£ ho√†n t·∫•t ch·ª•p ·∫£nh b√°o c√°o ${baseTitle}!`, 'success');
    },
};
--- END FILE: ./modules/capture.service.js ---

--- START FILE: ./modules/file-upload.service.js ---
// Version 1.0 - Initial Upload Service
// MODULE: FILE UPLOAD SERVICE
// Ch·ª©a logic ƒë·ªÉ t·∫£i file l√™n Firebase Storage v√† l·∫Øng nghe k·∫øt qu·∫£ x·ª≠ l√Ω t·ª´ Firestore.

import { appState } from '../state.js';
import { ui } from '../ui.js';
import { ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
import { doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

export const fileUploadService = {
    /**
     * T·∫£i file l√™n Firebase Storage, sau ƒë√≥ l·∫Øng nghe k·∫øt qu·∫£ x·ª≠ l√Ω t·ª´ Firestore.
     * @param {File} file - ƒê·ªëi t∆∞·ª£ng file ng∆∞·ªùi d√πng ƒë√£ ch·ªçn.
     * @param {string} fileType - Lo·∫°i file (v√≠ d·ª•: 'ycx', 'danhsachnv').
     * @returns {Promise<Object>} - Promise s·∫Ω resolve v·ªõi d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω ho·∫∑c reject v·ªõi l·ªói.
     */
    uploadAndProcessFile(file, fileType) {
        return new Promise((resolve, reject) => {
            if (!appState.storage || !appState.db) {
                return reject(new Error("Firebase ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o."));
            }

            // 1. T·∫°o m·ªôt ID ƒë·ªôc nh·∫•t cho file ƒë·ªÉ theo d√µi
            const uniqueFileId = `${fileType}-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            const fileName = `${uniqueFileId}${file.name.substring(file.name.lastIndexOf('.'))}`;
            const storagePath = `uploads/${fileName}`;
            const storageRef = ref(appState.storage, storagePath);

            // 2. B·∫Øt ƒë·∫ßu qu√° tr√¨nh t·∫£i file l√™n Storage
            const uploadTask = uploadBytesResumable(storageRef, file);
            let unsubscribeSnapshot = null; // Bi·∫øn ƒë·ªÉ l∆∞u h√†m h·ªßy listener

            // T·∫°o listener trong Firestore ƒë·ªÉ ch·ªù k·∫øt qu·∫£
            const resultDocRef = doc(appState.db, "file_results", uniqueFileId);
            unsubscribeSnapshot = onSnapshot(resultDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const result = docSnap.data();
                    // H·ªßy listener ngay khi nh·∫≠n ƒë∆∞·ª£c k·∫øt qu·∫£ ƒë·ªÉ tr√°nh r√≤ r·ªâ b·ªô nh·ªõ
                    if (unsubscribeSnapshot) unsubscribeSnapshot();
                    clearTimeout(timeout); // H·ªßy timeout

                    if (result.status === 'success') {
                        resolve(result.data); // Tr·∫£ v·ªÅ d·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω
                    } else {
                        reject(new Error(result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ m√°y ch·ªß.'));
                    }
                }
            });

            // C·∫≠p nh·∫≠t giao di·ªán v·ªõi ti·∫øn tr√¨nh t·∫£i l√™n
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    ui.updateFileStatus(fileType, file.name, `ƒêang t·∫£i l√™n... ${Math.round(progress)}%`);
                },
                (error) => { // X·ª≠ l√Ω l·ªói t·∫£i l√™n
                    if (unsubscribeSnapshot) unsubscribeSnapshot();
                    clearTimeout(timeout);
                    console.error("L·ªói khi t·∫£i file l√™n Storage:", error);
                    reject(new Error("Kh√¥ng th·ªÉ t·∫£i file l√™n m√°y ch·ªß."));
                },
                () => { // T·∫£i l√™n th√†nh c√¥ng, chuy·ªÉn sang ch·ªù x·ª≠ l√Ω
                    ui.updateFileStatus(fileType, file.name, 'T·∫£i l√™n ho√†n t·∫•t, ƒëang ch·ªù m√°y ch·ªß x·ª≠ l√Ω...');
                }
            );

            // 3. ƒê·∫∑t m·ªôt kho·∫£ng th·ªùi gian ch·ªù t·ªëi ƒëa (v√≠ d·ª•: 60 gi√¢y)
            const timeout = setTimeout(() => {
                if (unsubscribeSnapshot) unsubscribeSnapshot();
                reject(new Error("M√°y ch·ªß x·ª≠ l√Ω qu√° l√¢u, vui l√≤ng th·ª≠ l·∫°i."));
            }, 60000); // 60 gi√¢y
        });
    }
};
--- END FILE: ./modules/file-upload.service.js ---

--- START FILE: ./modules/highlight.service.js ---
// Version 1.1 - Fix incorrect import paths for modules
// MODULE: HIGHLIGHT SERVICE
// Ch·ª©a logic ƒë·ªÉ qu·∫£n l√Ω v√† √°p d·ª•ng t√≠nh nƒÉng t√¥ m√†u (highlight) tr√™n c√°c b·∫£ng.

import { appState } from '../state.js';
import { utils } from '../utils.js';

export const highlightService = {
    populateHighlightFilters(prefix, ycxData, reportData) {
        if (!appState.choices[`${prefix}_highlight_nhanhang`]) return;
        const uniqueNganhHang = [...new Set(ycxData.map(r => utils.cleanCategoryName(r.nganhHang)).filter(Boolean))].sort();
        const uniqueNhomHang = [...new Set(ycxData.map(r => utils.cleanCategoryName(r.nhomHang)).filter(Boolean))].sort();
        const uniqueEmployees = [...new Set(reportData.map(r => r.hoTen).filter(Boolean))].sort();

        const createOptions = (arr) => arr.map(item => ({ value: item, label: item, selected: false }));
        
        appState.choices[`${prefix}_highlight_nhanhang`]?.setChoices(createOptions(uniqueNganhHang), 'value', 'label', true);
        appState.choices[`${prefix}_highlight_nhomhang`]?.setChoices(createOptions(uniqueNhomHang), 'value', 'label', true);
        appState.choices[`${prefix}_highlight_employee`]?.setChoices(createOptions(uniqueEmployees), 'value', 'label', true);
    },

    applyHighlights(prefix) {
        const settings = appState.highlightSettings[prefix] || {};
        const tableContainer = document.getElementById(`${prefix === 'luyke' ? 'health' : (prefix === 'sknv' ? 'health-employee' : 'realtime')}-section`);
        if (!tableContainer) return;
        
        tableContainer.querySelectorAll('tbody tr').forEach(row => {
             row.classList.remove('highlighted-row');
             row.style.backgroundColor = '';
        });

        if (settings.values && settings.values.length > 0) {
            tableContainer.querySelectorAll('tbody tr').forEach(row => {
                const cellText = row.cells[0] ? row.cells[0].textContent : '';
                if (settings.values.includes(cellText)) {
                    row.classList.add('highlighted-row');
                    row.style.backgroundColor = settings.color;
                }
            });
        }
    },
};
--- END FILE: ./modules/highlight.service.js ---

--- START FILE: ./modules/settings.service.js ---
// Version 2.0 - Revert loading logic to respect user-saved drag-drop order
// MODULE: SETTINGS SERVICE
// Ch·ª©a to√†n b·ªô logic li√™n quan ƒë·∫øn vi·ªác qu·∫£n l√Ω c√†i ƒë·∫∑t (l∆∞u/t·∫£i t·ª´ localStorage).

import { appState } from '../state.js';
import { ui } from '../ui.js';

// H·∫±ng s·ªë ch·ª©a danh s√°ch ƒë·∫ßy ƒë·ªß v√† th·ª© t·ª± c·ªôt ch√≠nh x√°c cho b·∫£ng Hi·ªáu qu·∫£ khai th√°c
const ALL_EFFICIENCY_ITEMS = [
    { id: 'dtICT', label: 'DT ICT' },
    { id: 'dtPhuKien', label: 'DT Ph·ª• ki·ªán' },
    { id: 'pctPhuKien', label: '% Ph·ª• ki·ªán' },
    { id: 'dtCE', label: 'DT CE' },
    { id: 'dtGiaDung', label: 'DT Gia d·ª•ng' },
    { id: 'pctGiaDung', label: '% Gia d·ª•ng' },
    { id: 'pctMLN',    label: '% MLN' },
    { id: 'pctSim',    label: '% Sim' },
    { id: 'pctVAS',    label: '% VAS' },
    { id: 'pctBaoHiem', label: '% B·∫£o hi·ªÉm' }
];


export const settingsService = {
    /**
     * L∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã cho b·∫£ng Hi·ªáu qu·∫£ khai th√°c.
     * C·∫•u tr√∫c m·ªõi l√† m·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng, m·ªói ƒë·ªëi t∆∞·ª£ng ch·ª©a {id, label, visible}.
     * @param {Array<Object>} settings - M·∫£ng c·∫•u h√¨nh c·ªôt ƒë·∫ßy ƒë·ªß.
     */
    saveEfficiencyViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try {
            localStorage.setItem('efficiencyViewSettings', JSON.stringify(settings));
        } catch (e) {
            console.error("L·ªói khi l∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã Hi·ªáu qu·∫£ khai th√°c:", e);
        }
    },
    
    /**
     * T·∫£i c√†i ƒë·∫∑t hi·ªÉn th·ªã cho b·∫£ng Hi·ªáu qu·∫£ khai th√°c.
     * Logic m·ªõi: ∆Øu ti√™n th·ª© t·ª± ƒë√£ l∆∞u c·ªßa ng∆∞·ªùi d√πng, v√† th√™m c√°c c·ªôt m·ªõi v√†o cu·ªëi.
     * @returns {Array<Object>} M·∫£ng c·∫•u h√¨nh c·ªôt ƒë·∫ßy ƒë·ªß.
     */
    loadEfficiencyViewSettings() {
        try {
            const savedSettingsJSON = localStorage.getItem('efficiencyViewSettings');
            if (savedSettingsJSON) {
                const savedItems = JSON.parse(savedSettingsJSON);
                
                // ƒê·∫£m b·∫£o d·ªØ li·ªáu l∆∞u l√† m·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng
                if (Array.isArray(savedItems) && savedItems.length > 0 && typeof savedItems[0] === 'object') {
                    const savedIds = new Set(savedItems.map(s => s.id));
                    // Th√™m c√°c c·ªôt m·ªõi (n·∫øu c√≥ trong b·∫£n c·∫≠p nh·∫≠t) m√† ng∆∞·ªùi d√πng ch∆∞a c√≥ trong c√†i ƒë·∫∑t
                    const newItems = ALL_EFFICIENCY_ITEMS
                        .filter(item => !savedIds.has(item.id))
                        .map(item => ({ ...item, visible: true }));
                    
                    // L·ªçc ra c√°c m·ª•c ƒë√£ l∆∞u m√† kh√¥ng c√≤n t·ªìn t·∫°i trong code n·ªØa
                    const currentItems = savedItems.filter(item => ALL_EFFICIENCY_ITEMS.some(config => config.id === item.id));
                    
                    return [...currentItems, ...newItems];
                }
            }
        } catch (e) {
            console.error("L·ªói khi t·∫£i c√†i ƒë·∫∑t hi·ªÉn th·ªã Hi·ªáu qu·∫£ khai th√°c:", e);
        }

        // Tr·∫£ v·ªÅ gi√° tr·ªã m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ g√¨ ƒë∆∞·ª£c l∆∞u ho·∫∑c c√≥ l·ªói
        return ALL_EFFICIENCY_ITEMS.map(item => ({ ...item, visible: true }));
    },

    saveQdcViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try {
            localStorage.setItem('qdcViewSettings', JSON.stringify(settings));
        } catch (e) {
            console.error("L·ªói khi l∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã Nh√≥m h√†ng QƒêC:", e);
        }
    },

    saveCategoryViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try {
            localStorage.setItem('categoryViewSettings', JSON.stringify(settings));
        } catch (e) {
            console.error("L·ªói khi l∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã Ng√†nh h√†ng chi ti·∫øt:", e);
        }
    },

    loadQdcViewSettings(allItems) {
        try {
            const savedSettings = localStorage.getItem('qdcViewSettings');
            if (savedSettings) {
                return JSON.parse(savedSettings);
            }
        } catch (e) {
            console.error("L·ªói khi t·∫£i c√†i ƒë·∫∑t hi·ªÉn th·ªã Nh√≥m h√†ng QƒêC:", e);
        }
        // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã t·∫•t c·∫£ n·∫øu ch∆∞a c√≥ c√†i ƒë·∫∑t
        return allItems;
    },

    loadCategoryViewSettings(allItems) {
        try {
            const savedSettings = localStorage.getItem('categoryViewSettings');
            if (savedSettings) {
                return JSON.parse(savedSettings);
            }
        } catch (e) {
            console.error("L·ªói khi t·∫£i c√†i ƒë·∫∑t hi·ªÉn th·ªã Ng√†nh h√†ng chi ti·∫øt:", e);
        }
        // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã t·∫•t c·∫£ n·∫øu ch∆∞a c√≥ c√†i ƒë·∫∑t
        return allItems;
    },
    
    loadInterfaceSettings() {
        try {
            const savedSettings = JSON.parse(localStorage.getItem('interfaceSettings')) || {};
            const defaultSettings = {
                kpiCard1Bg: '#38bdf8', kpiCard2Bg: '#34d399', kpiCard3Bg: '#fbbf24',
                kpiCard4Bg: '#2dd4bf', kpiCard5Bg: '#a78bfa', kpiCard6Bg: '#f472b6', 
                kpiCard7Bg: '#818cf8', kpiCard8Bg: '#f87171',
                kpiTitleColor: '#ffffff',
                kpiMainColor: '#ffffff',
                kpiSubColor: '#ffffff',
                globalFontSize: '14',
                kpiFontSize: '36'
            };
            const settings = { ...defaultSettings, ...savedSettings };
            
            ui.applyInterfaceSettings(settings);
            
            // C·∫≠p nh·∫≠t gi√° tr·ªã cho c√°c b·ªô ch·ªçn m√†u
            Object.keys(defaultSettings).forEach((key) => {
                if (key.startsWith('kpiCard')) {
                    const keyNumber = key.replace('kpiCard', '').replace('Bg', '');
                    const colorPicker = document.getElementById(`kpi-color-${keyNumber}`);
                    if (colorPicker) colorPicker.value = settings[key];
                }
            });
            
            const titleColorPicker = document.getElementById('kpi-title-color');
            if(titleColorPicker) titleColorPicker.value = settings.kpiTitleColor;
            
            const mainColorPicker = document.getElementById('kpi-main-color');
            if(mainColorPicker) mainColorPicker.value = settings.kpiMainColor;

            const subColorPicker = document.getElementById('kpi-sub-color');
            if(subColorPicker) subColorPicker.value = settings.kpiSubColor;


            const globalSlider = document.getElementById('global-font-size-slider');
            const kpiSlider = document.getElementById('kpi-font-size-slider');
            if(globalSlider) globalSlider.value = settings.globalFontSize;
            if(kpiSlider) kpiSlider.value = settings.kpiFontSize;
            
            this.handleFontSizeChange({ target: globalSlider }, 'global');
            this.handleFontSizeChange({ target: kpiSlider }, 'kpi');
            
        } catch (e) { console.error("L·ªói khi t·∫£i c√†i ƒë·∫∑t giao di·ªán:", e); }
    },
    
    saveInterfaceSettings() {
        const settings = {
            kpiCard1Bg: document.getElementById('kpi-color-1')?.value,
            kpiCard2Bg: document.getElementById('kpi-color-2')?.value,
            kpiCard3Bg: document.getElementById('kpi-color-3')?.value,
            kpiCard4Bg: document.getElementById('kpi-color-4')?.value,
            kpiCard5Bg: document.getElementById('kpi-color-5')?.value,
            kpiCard6Bg: document.getElementById('kpi-color-6')?.value,
            kpiCard7Bg: document.getElementById('kpi-color-7')?.value,
            kpiCard8Bg: document.getElementById('kpi-color-8')?.value,
            kpiTitleColor: document.getElementById('kpi-title-color')?.value,
            kpiMainColor: document.getElementById('kpi-main-color')?.value,
            kpiSubColor: document.getElementById('kpi-sub-color')?.value,
            globalFontSize: document.getElementById('global-font-size-slider')?.value,
            kpiFontSize: document.getElementById('kpi-font-size-slider')?.value,
        };
        localStorage.setItem('interfaceSettings', JSON.stringify(settings));
        ui.applyInterfaceSettings(settings);
        this.applyFontSettings();
    },

    applyFontSettings() {
        const settings = JSON.parse(localStorage.getItem('interfaceSettings')) || {};
        const globalSize = settings.globalFontSize || '14';
        const kpiSize = settings.kpiFontSize || '36';
        
        document.documentElement.style.setProperty('--global-font-size', `${globalSize}px`);
        document.documentElement.style.setProperty('--kpi-main-font-size', `${kpiSize}px`);
    },

    handleFontSizeChange(event, type) {
        if (!event || !event.target) return;
        const value = event.target.value;
        const valueDisplayId = type === 'global' ? 'global-font-size-value' : 'kpi-font-size-value';
        const valueDisplayElement = document.getElementById(valueDisplayId);

        if (valueDisplayElement) {
            valueDisplayElement.textContent = `${value}px`;
        }
        
        this.saveInterfaceSettings();
    },

    saveRealtimeGoalSettings() {
        const warehouse = document.getElementById('rt-goal-warehouse-select').value;
        if (!warehouse) return;
        const settings = { goals: {}, timing: {} };
        document.querySelectorAll('.rt-goal-input').forEach(input => settings.goals[input.dataset.goal] = input.value);
        document.querySelectorAll('.rt-setting-input').forEach(input => settings.timing[input.id] = input.value);
        
        if (!appState.realtimeGoalSettings) appState.realtimeGoalSettings = {};
        appState.realtimeGoalSettings[warehouse] = settings;
        localStorage.setItem('realtimeGoalSettings', JSON.stringify(appState.realtimeGoalSettings));
        ui.showNotification(`ƒê√£ l∆∞u c√†i ƒë·∫∑t Realtime cho kho ${warehouse}!`, 'success');
    },

    loadAndApplyRealtimeGoalSettings() {
        const warehouseSelect = document.getElementById('rt-goal-warehouse-select');
        if (!warehouseSelect) return;
        const warehouse = warehouseSelect.value;
        const settings = (warehouse && appState.realtimeGoalSettings && appState.realtimeGoalSettings[warehouse]) 
            ? appState.realtimeGoalSettings[warehouse] 
            : { goals: {}, timing: {} };

        document.querySelectorAll('.rt-goal-input').forEach(input => input.value = settings.goals?.[input.dataset.goal] || '');
        document.querySelectorAll('.rt-setting-input').forEach(input => input.value = settings.timing?.[input.id] || '');
    },

    saveLuykeGoalSettings() {
        const warehouse = document.getElementById('luyke-goal-warehouse-select').value;
        if (!warehouse) return;
        const settings = {};
        document.querySelectorAll('.luyke-goal-input').forEach(input => settings[input.dataset.goal] = input.value);

        if(!appState.luykeGoalSettings) appState.luykeGoalSettings = {};
        appState.luykeGoalSettings[warehouse] = settings;
        localStorage.setItem('luykeGoalSettings', JSON.stringify(appState.luykeGoalSettings));
        ui.showNotification(`ƒê√£ l∆∞u c√†i ƒë·∫∑t m·ª•c ti√™u L≈©y k·∫ø cho kho ${warehouse}!`, 'success');
    },

    loadAndApplyLuykeGoalSettings() {
        const warehouseSelect = document.getElementById('luyke-goal-warehouse-select');
        if (!warehouseSelect) return;
        const warehouse = warehouseSelect.value;
        const settings = (warehouse && appState.luykeGoalSettings && appState.luykeGoalSettings[warehouse]) 
            ? appState.luykeGoalSettings[warehouse] 
            : {};
        document.querySelectorAll('.luyke-goal-input').forEach(input => input.value = settings[input.dataset.goal] || '');
    },

    getLuykeGoalSettings(selectedWarehouse = null) {
        const settings = { goals: {} };
        const goalKeys = ['doanhThuThuc', 'doanhThuQD', 'phanTramQD', 'phanTramTC', 'phanTramGiaDung', 'phanTramMLN', 'phanTramPhuKien', 'phanTramBaoHiem', 'phanTramSim', 'phanTramVAS'];

        if (selectedWarehouse && appState.luykeGoalSettings[selectedWarehouse]) {
             const source = appState.luykeGoalSettings[selectedWarehouse];
             goalKeys.forEach(key => settings.goals[key] = parseFloat(source[key]) || 0);
        } else if (!selectedWarehouse) {
            const allSettings = appState.luykeGoalSettings || {};
            const warehouseKeys = Object.keys(allSettings);
            const percentCounts = {};
            
            goalKeys.forEach(key => settings.goals[key] = 0);

            warehouseKeys.forEach(whKey => {
                const source = allSettings[whKey];
                goalKeys.forEach(key => {
                    const value = parseFloat(source[key]) || 0;
                    if (key.startsWith('phanTram')) {
                        settings.goals[key] += value;
                        percentCounts[key] = (percentCounts[key] || 0) + 1;
                    } else {
                        settings.goals[key] += value;
                    }
                });
            });
            
            Object.keys(percentCounts).forEach(key => {
                if (percentCounts[key] > 0) settings.goals[key] /= percentCounts[key];
            });
        }
        return settings;
    },

    getRealtimeGoalSettings(selectedWarehouse = null) {
        if (selectedWarehouse && appState.realtimeGoalSettings && appState.realtimeGoalSettings[selectedWarehouse]) {
            return appState.realtimeGoalSettings[selectedWarehouse];
        }
        if (!selectedWarehouse) {
            const allSettings = appState.realtimeGoalSettings || {};
            const validWarehouseSettings = Object.values(allSettings).filter(s => s.goals && Object.keys(s.goals).length > 0);
            if(validWarehouseSettings.length === 0) return { goals: {}, timing: {} };
            const aggregatedGoals = { doanhThuThuc: 0, doanhThuQD: 0 };
            const percentGoals = {}; const percentCounts = {};
            validWarehouseSettings.forEach(ws => {
                aggregatedGoals.doanhThuThuc += parseFloat(ws.goals.doanhThuThuc || 0);
                aggregatedGoals.doanhThuQD += parseFloat(ws.goals.doanhThuQD || 0);
                Object.entries(ws.goals).forEach(([key, value]) => {
                    if (key.startsWith('phanTram')) {
                        if (!percentGoals[key]) { percentGoals[key] = 0; percentCounts[key] = 0; }
                        const numValue = parseFloat(value);
                        if(!isNaN(numValue)) { percentGoals[key] += numValue; percentCounts[key]++; }
                    }
                });
            });
            Object.keys(percentCounts).forEach(key => { if(percentCounts[key] > 0) aggregatedGoals[key] = percentGoals[key] / percentCounts[key]; });
            const representativeTiming = validWarehouseSettings.length > 0 ? (validWarehouseSettings[0].timing || {}) : {};
            return { goals: aggregatedGoals, timing: representativeTiming };
        }
        return { goals: {}, timing: {} };
    },

    applyContrastSetting() {
        const savedLevel = localStorage.getItem('contrastLevel') || '3';
        document.documentElement.dataset.contrast = savedLevel;
        document.querySelectorAll('.contrast-selector').forEach(sel => sel.value = savedLevel);
    },

    loadHighlightSettings() {
        try {
            const saved = localStorage.getItem('highlightSettings');
            if (saved) appState.highlightSettings = JSON.parse(saved);
        } catch(e) {
            console.error("Error loading highlight settings", e);
            appState.highlightSettings = { luyke: {}, sknv: {}, realtime: {} };
        }
    },
};
--- END FILE: ./modules/settings.service.js ---

--- START FILE: ./modules/storage.js ---
// Version 1.0 - Initial creation from main.js refactor
// MODULE: STORAGE
// Qu·∫£n l√Ω t·∫•t c·∫£ c√°c t∆∞∆°ng t√°c v·ªõi IndexedDB ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu c·ª•c b·ªô.

export const storage = {
    db: null,
    dbName: 'AppStorageDB',
    storeName: 'fileStore',

    openDB() {
        return new Promise((resolve, reject) => {
            if (this.db) return resolve(this.db);
            const request = indexedDB.open(this.dbName, 1);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(this.storeName)) {
                    db.createObjectStore(this.storeName, { keyPath: 'id' });
                }
            };
            request.onsuccess = (event) => {
                this.db = event.target.result;
                resolve(this.db);
            };
            request.onerror = (event) => {
                console.error("IndexedDB error:", event.target.errorCode);
                reject(event.target.error);
            };
        });
    },

    async setItem(id, value) {
        const db = await this.openDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([this.storeName], 'readwrite');
            const store = transaction.objectStore(this.storeName);
            const request = store.put({ id, value });
            request.onsuccess = () => resolve();
            request.onerror = (event) => reject(event.target.error);
        });
    },

    async getItem(id) {
        const db = await this.openDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([this.storeName], 'readonly');
            const store = transaction.objectStore(this.storeName);
            const request = store.get(id);
            request.onsuccess = (event) => {
                resolve(event.target.result ? event.target.result.value : null);
            };
            request.onerror = (event) => reject(event.target.error);
        });
    }
};
--- END FILE: ./modules/storage.js ---

--- START FILE: ./project_snapshot.txt ---
--- START FILE: ./.vscode/settings.json ---
{
    "liveServer.settings.port": 5504
}
--- END FILE: ./.vscode/settings.json ---

--- START FILE: ./Firebase.js ---
// Version 1.7 - Add function to get QR code URL from Storage
// MODULE: FIREBASE
// Ch·ªãu tr√°ch nhi·ªám k·∫øt n·ªëi, thi·∫øt l·∫≠p listener v·ªõi Firebase.
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, arrayUnion, serverTimestamp, query, orderBy, setDoc, increment, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
import { appState } from './state.js';
import { ui } from './ui.js';

const firebase = {
    async init() {
       // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyAQ3TWcpa4AnTN-32igGseYDlXrCf1BVew",
          authDomain: "qlst-9e6bd.firebaseapp.com",
          projectId: "qlst-9e6bd",
          storageBucket: "qlst-9e6bd.firebasestorage.app",
          messagingSenderId: "2316705291",
          appId: "1:2316705291:web:ebec2963816aea7585b10e",
          measurementId: "G-M0SM0XHCEK"
        };

        try {
            if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                throw new Error("Th√¥ng tin c·∫•u h√¨nh Firebase ch∆∞a ƒë∆∞·ª£c c·∫≠p nh·∫≠t.");
            }
            const firebaseApp = initializeApp(firebaseConfig);
            appState.auth = getAuth(firebaseApp);
            appState.db = getFirestore(firebaseApp);
            appState.storage = getStorage(firebaseApp);

            console.log("Firebase connected successfully!");
            this.setupListeners();
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            ui.showNotification(error.message || "Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi c∆° s·ªü d·ªØ li·ªáu.", "error");
        }
    },

    setupListeners() {
        if (!appState.db) return;

        const feedbackQuery = query(collection(appState.db, "feedback"), orderBy("timestamp", "desc"));
        onSnapshot(feedbackQuery, (querySnapshot) => {
            appState.feedbackList = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                appState.feedbackList.push({ id: doc.id, ...data, timestamp: data.timestamp?.toDate() });
            });
            if (document.getElementById('home-section')?.classList.contains('hidden') === false) {
                ui.renderFeedbackSection();
            }
        }, (error) => {
            console.error("Error listening to feedback collection: ", error);
            ui.showNotification("L·ªói khi t·∫£i danh s√°ch g√≥p √Ω.", "error");
        });

        const helpContentRef = collection(appState.db, "help_content");
        onSnapshot(helpContentRef, (querySnapshot) => {
             let contentUpdated = false;
            querySnapshot.forEach((doc) => {
                if (appState.helpContent.hasOwnProperty(doc.id)) {
                    appState.helpContent[doc.id] = doc.data().content;
                    contentUpdated = true;
                }
            });
            if (contentUpdated && appState.isAdmin && document.getElementById('declaration-section')?.classList.contains('hidden') === false) {
                ui.renderAdminHelpEditors();
            }
        }, (error) => {
            console.error("Error listening to help_content collection: ", error);
            ui.showNotification("L·ªói khi t·∫£i n·ªôi dung h∆∞·ªõng d·∫´n.", "error");
        });

        const statsRef = doc(appState.db, "analytics", "site_stats");
        onSnapshot(statsRef, (docSnap) => {
            if (docSnap.exists()) {
                const statsData = docSnap.data();
                ui.updateUsageCounter(statsData);
            } else {
                console.log("Kh√¥ng t√¨m th·∫•y document th·ªëng k√™.");
            }
        });
    },

    async incrementCounter(fieldName) {
        if (!appState.db || !fieldName) return;
        const statsRef = doc(appState.db, "analytics", "site_stats");
        try {
            await setDoc(statsRef, { [fieldName]: increment(1) }, { merge: true });
        } catch (error) {
            console.error(`L·ªói khi tƒÉng b·ªô ƒë·∫øm cho '${fieldName}':`, error);
        }
    },

    async submitFeedback(content) {
        if (!content || !appState.db || !appState.currentUser) {
             ui.showNotification("Kh√¥ng th·ªÉ g·ª≠i g√≥p √Ω: Ng∆∞·ªùi d√πng ch∆∞a ƒë∆∞·ª£c x√°c th·ª±c.", "error");
            return;
        }
        try {
            await addDoc(collection(appState.db, "feedback"), {
                user: {
                    uid: appState.currentUser.uid,
                    isAnonymous: appState.currentUser.isAnonymous,
                },
                content: content,
                timestamp: serverTimestamp(),
                replies: []
            });
            ui.showNotification("G√≥p √Ω c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i!", "success");
            return true;
        } catch (error) {
            console.error("Error adding feedback: ", error);
            ui.showNotification("L·ªói khi g·ª≠i g√≥p √Ω.", "error");
            return false;
        }
    },

    async submitReply(docId, content) {
        if (!docId || !content || !appState.db) return false;
        try {
            const feedbackRef = doc(appState.db, "feedback", docId);
            await updateDoc(feedbackRef, {
                replies: arrayUnion({
                    content: content,
                    timestamp: new Date()
                })
            });
            return true;
        } catch (error) {
            console.error("Error submitting reply:", error);
            ui.showNotification("L·ªói khi g·ª≠i tr·∫£ l·ªùi.", "error");
            return false;
        }
    },

    async saveHelpContent(contents) {
        if (!appState.db || !appState.isAdmin) return;
        ui.showNotification('ƒêang l∆∞u n·ªôi dung h∆∞·ªõng d·∫´n...', 'success');
        try {
            await Promise.all([
                setDoc(doc(appState.db, "help_content", "data"), { content: contents.data }),
                setDoc(doc(appState.db, "help_content", "luyke"), { content: contents.luyke }),
                setDoc(doc(appState.db, "help_content", "sknv"), { content: contents.sknv }),
                setDoc(doc(appState.db, "help_content", "realtime"), { content: contents.realtime })
            ]);
            ui.showNotification('ƒê√£ c·∫≠p nh·∫≠t n·ªôi dung h∆∞·ªõng d·∫´n th√†nh c√¥ng!', 'success');
        } catch (error) {
            console.error("Error saving help content:", error);
            ui.showNotification('L·ªói khi l∆∞u n·ªôi dung.', 'error');
        }
    },

    async saveCategoryDataToFirestore(data) {
        if (!appState.db || !appState.isAdmin) return;
        ui.showNotification('ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu khai b√°o l√™n cloud...', 'success');
        try {
            const categoryRef = doc(appState.db, "declarations", "categoryStructure");
            await setDoc(categoryRef, { data: data.categories || [] });

            const brandRef = doc(appState.db, "declarations", "brandList");
            await setDoc(brandRef, { data: data.brands || [] });

            ui.showNotification('ƒê·ªìng b·ªô d·ªØ li·ªáu khai b√°o th√†nh c√¥ng!', 'success');
        } catch (error) {
            console.error("L·ªói khi l∆∞u d·ªØ li·ªáu khai b√°o l√™n Firestore:", error);
            ui.showNotification('L·ªói khi ƒë·ªìng b·ªô d·ªØ li·ªáu l√™n cloud.', 'error');
        }
    },

    async loadCategoryDataFromFirestore() {
        if (!appState.db) return { categories: [], brands: [] };
        try {
            const declarationsCollection = collection(appState.db, "declarations");
            const querySnapshot = await getDocs(declarationsCollection);

            let categories = [];
            let brands = [];

            querySnapshot.forEach((doc) => {
                if (doc.id === "categoryStructure") {
                    categories = doc.data().data || [];
                } else if (doc.id === "brandList") {
                    brands = doc.data().data || [];
                }
            });

            console.log(`Loaded ${categories.length} categories and ${brands.length} brands from Firestore.`);
            return { categories, brands };
        } catch (error) {
            console.error("L·ªói khi t·∫£i d·ªØ li·ªáu khai b√°o t·ª´ Firestore:", error);
            ui.showNotification('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ng√†nh h√†ng t·ª´ cloud.', 'error');
            return { categories: [], brands: [] };
        }
    },

    // --- START: C√ÅC H√ÄM M·ªöI ƒê·ªÇ QU·∫¢N L√ù D·ªÆ LI·ªÜU KHAI B√ÅO T√çNH TO√ÅN ---
    async loadDeclarationsFromFirestore() {
        if (!appState.db) return {};
        console.log("Loading calculation declarations from Firestore...");
        try {
            const declarationIds = ['hinhThucXuat', 'hinhThucXuatGop', 'heSoQuyDoi'];
            const declarations = {};
            for (const id of declarationIds) {
                const docRef = doc(appState.db, "declarations", id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    // D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u d∆∞·ªõi d·∫°ng m·ªôt chu·ªói d√†i, ph√¢n t√°ch b·∫±ng \n
                    declarations[id] = docSnap.data().content || '';
                } else {
                    declarations[id] = '';
                }
            }
            console.log("Successfully loaded calculation declarations.");
            return declarations;
        } catch (error) {
            console.error("L·ªói khi t·∫£i d·ªØ li·ªáu khai b√°o t√≠nh to√°n t·ª´ Firestore:", error);
            ui.showNotification('L·ªói: Kh√¥ng th·ªÉ t·∫£i c√°c khai b√°o t√≠nh to√°n t·ª´ cloud.', 'error');
            return {};
        }
    },

    async saveDeclarationsToFirestore(declarations) {
        if (!appState.db || !appState.isAdmin) return;
        ui.showNotification('ƒêang ƒë·ªìng b·ªô khai b√°o t√≠nh to√°n l√™n cloud...', 'success');
        try {
            await Promise.all([
                setDoc(doc(appState.db, "declarations", "hinhThucXuat"), { content: declarations.ycx }),
                setDoc(doc(appState.db, "declarations", "hinhThucXuatGop"), { content: declarations.ycxGop }),
                 setDoc(doc(appState.db, "declarations", "heSoQuyDoi"), { content: declarations.heSo })
            ]);
            ui.showNotification('ƒê·ªìng b·ªô khai b√°o t√≠nh to√°n th√†nh c√¥ng!', 'success');
        } catch (error) {
            console.error("L·ªói khi l∆∞u d·ªØ li·ªáu khai b√°o t√≠nh to√°n:", error);
            ui.showNotification('L·ªói khi ƒë·ªìng b·ªô khai b√°o t√≠nh to√°n.', 'error');
        }
    },
    // --- END: C√ÅC H√ÄM M·ªöI ---

    async getTemplateDownloadURL() {
        if (!appState.storage) {
            throw new Error("Firebase Storage ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o.");
        }
        const filePath = 'templates/danh_sach_nhan_vien_mau.xlsx';
        const storageRef = ref(appState.storage, filePath);
        try {
            const url = await getDownloadURL(storageRef);
            return url;
        } catch (error) {
            console.error("L·ªói khi l·∫•y URL t·∫£i file m·∫´u: ", error);
            throw error;
        }
    },

    async getBookmarkDownloadURL() {
        if (!appState.storage) {
            throw new Error("Firebase Storage ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o.");
        }
        const filePath = 'templates/Share_QLST.zip';
        const storageRef = ref(appState.storage, filePath);

        try {
            const url = await getDownloadURL(storageRef);
            return url;
        } catch (error) {
            console.error("L·ªói khi l·∫•y URL t·∫£i file bookmark: ", error);
            throw error;
        }
    },

    // === START: H√ÄM M·ªöI ƒê·ªÇ L·∫§Y URL M√É QR ===
    async getQrCodeDownloadURL() {
        if (!appState.storage) {
            throw new Error("Firebase Storage ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o.");
        }
        // --- L∆ØU √ù: File ·∫£nh QR c·ªßa b·∫°n PH·∫¢I ƒë∆∞·ª£c t·∫£i l√™n ƒë√∫ng ƒë∆∞·ªùng d·∫´n n√†y ---
        const filePath = 'qrcodes/main-qr.jpg'; 
        const storageRef = ref(appState.storage, filePath);
        try {
            const url = await getDownloadURL(storageRef);
            return url;
        } catch (error) {
            console.error("L·ªói khi l·∫•y URL c·ªßa m√£ QR: ", error);
            // X·ª≠ l√Ω l·ªói c·ª• th·ªÉ khi kh√¥ng t√¨m th·∫•y file
            if (error.code === 'storage/object-not-found') {
                throw new Error(`Kh√¥ng t√¨m th·∫•y file m√£ QR t·∫°i ƒë∆∞·ªùng d·∫´n '${filePath}'. Vui l√≤ng ki·ªÉm tra l·∫°i Firebase Storage.`);
            }
            throw new Error("Kh√¥ng th·ªÉ t·∫£i ƒë∆∞·ª£c m√£ QR t·ª´ server.");
        }
    }
    // === END: H√ÄM M·ªöI ===
};

export { firebase };
--- END FILE: ./Firebase.js ---

--- START FILE: ./auth.js ---
// Version 1.1 - Add totalUsers counter on new user creation
// MODULE: AUTH
// Ch·ªãu tr√°ch nhi·ªám x·ª≠ l√Ω t·∫•t c·∫£ logic li√™n quan ƒë·∫øn x√°c th·ª±c ng∆∞·ªùi d√πng.

import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
// === START: TH√äM IMPORT M·ªöI ===
import { doc, setDoc, serverTimestamp, getDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
// === END: TH√äM IMPORT M·ªöI ===
import { appState } from './state.js';

export const auth = {
    /**
     * Kh·ªüi t·∫°o module x√°c th·ª±c.
     * Thi·∫øt l·∫≠p m·ªôt listener ƒë·ªÉ theo d√µi tr·∫°ng th√°i ƒëƒÉng nh·∫≠p v√† t·ª± ƒë·ªông ƒëƒÉng nh·∫≠p ·∫©n danh n·∫øu c·∫ßn.
     */
    init() {
        const authInstance = getAuth();
        
        onAuthStateChanged(authInstance, (user) => {
            if (user) {
                appState.currentUser = user;
                console.log("Ng∆∞·ªùi d√πng ƒë√£ x√°c th·ª±c v·ªõi UID:", user.uid);
                
                // T·∫°o m·ªôt b·∫£n ghi trong Firestore cho ng∆∞·ªùi d√πng n√†y n·∫øu ch∆∞a c√≥
                this.createUserRecord(user);
            } else {
                console.log("Ch∆∞a c√≥ ng∆∞·ªùi d√πng, ƒëang ti·∫øn h√†nh ƒëƒÉng nh·∫≠p ·∫©n danh...");
                signInAnonymously(authInstance).catch((error) => {
                    console.error("L·ªói ƒëƒÉng nh·∫≠p ·∫©n danh:", error);
                });
            }
        });
    },

    /**
     * T·∫°o m·ªôt b·∫£n ghi trong collection 'users' V√Ä tƒÉng b·ªô ƒë·∫øm ng∆∞·ªùi d√πng.
     * Ch·ªâ th·ª±c hi·ªán n·∫øu b·∫£n ghi ng∆∞·ªùi d√πng ch∆∞a t·ªìn t·∫°i.
     * @param {object} user - ƒê·ªëi t∆∞·ª£ng user tr·∫£ v·ªÅ t·ª´ Firebase Auth.
     */
    async createUserRecord(user) {
        if (!appState.db || !user) return;

        const userRef = doc(appState.db, "users", user.uid);

        try {
            const userDoc = await getDoc(userRef);

            // === START: LOGIC M·ªöI - CH·ªà TH·ª∞C HI·ªÜN KHI L√Ä NG∆Ø·ªúI D√ôNG M·ªöI ===
            if (!userDoc.exists()) {
                console.log(`Ph√°t hi·ªán ng∆∞·ªùi d√πng m·ªõi (${user.uid}). ƒêang t·∫°o h·ªì s∆° v√† c·∫≠p nh·∫≠t b·ªô ƒë·∫øm...`);
                
                // 1. T·∫°o h·ªì s∆° ng∆∞·ªùi d√πng
                const userData = {
                    uid: user.uid,
                    email: user.email || null,
                    createdAt: serverTimestamp(),
                    role: 'free_user'
                };
                await setDoc(userRef, userData);

                // 2. TƒÉng b·ªô ƒë·∫øm t·ªïng s·ªë ng∆∞·ªùi d√πng
                const statsRef = doc(appState.db, "analytics", "site_stats");
                await setDoc(statsRef, {
                    totalUsers: increment(1)
                }, { merge: true });
                
                console.log("-> ƒê√£ tƒÉng b·ªô ƒë·∫øm totalUsers.");
            }
            // === END: LOGIC M·ªöI ===
        } catch (error) {
            console.error("L·ªói khi ki·ªÉm tra ho·∫∑c t·∫°o b·∫£n ghi ng∆∞·ªùi d√πng:", error);
        }
    }
};
--- END FILE: ./auth.js ---

--- START FILE: ./changelog.json ---
[
   {
    "version": "3.5",
    "date": "23/10/2025",
    "notes": [
      "N√¢ng c·∫•p giao di·ªán tab SKNV cho ƒë·∫πp h∆°n"
    ]
  },  
   {
    "version": "3.4",
    "date": "17/10/2025",
    "notes": [
      "C√≥ th·ªÉ b·∫•m tr·ª±c ti·∫øp t√™n nh√¢n vi√™n ƒë·ªÉ xem chi ti·∫øt",
      "Th√™m icon v√†o menu cho sinh ƒë·ªông"
    ]
  },  
  {
    "version": "3.3",
    "date": "13/10/2025",
    "notes": [
      "Th√™m ch·ª©c nƒÉng t√πy ch·ªânh c·ªôt cho tab Hi·ªáu qu·∫£ khai th√°c nh√¢n vi√™n : c√≥ th·ªÉ ch·ªçn ·∫©n ho·∫∑c hi·ªán c·ªôt d·ªØ li·ªáu kh√¥ng li√™n quan ƒë·∫øn TGDD",
      "Cho ph√©p k√©o th·∫£ ƒë·ªÉ s·∫Øp x·∫øp c√°c c·ªôt trong b·∫£ng k·∫øt qu·∫£ hi·ªáu qu·∫£ khai th√°c nh√¢n vi√™n"
    ]
  },  
   {
    "version": "3.2",
    "date": "10/10/2025",
    "notes": [
      "Th√™m b·ªô l·ªçc ( h√¨nh rƒÉng c∆∞a ) v√†o 3 b·∫£ng Hi·ªáu qu·∫£ khai th√°c, Nh√≥m h√†ng quy ƒë·ªïi cao, Ng√†nh h√†ng chi ti·∫øt trong Si√™u th·ªã l≈©y k·∫ø v√† realtime",
      "S·ª≠a l·∫°i giao di·ªán khu v·ª±c c·∫≠p nh·∫≠t d·ªØ li·ªáu cho g·ªçn h∆°n"
    ]
  },  
  {
    "version": "3.1",
    "date": "09/10/2025",
    "notes": [
      "Th√™m 2 th·∫ª KPI m·ªõi cho tab si√™u th·ªã l≈©y k·∫ø",
      "Th√™m ch·ª©c nƒÉng c√†i ƒë·∫∑t m√†u ch·ªØ th·∫ª KPI trong c√†i ƒë·∫∑t giao di·ªán"
    ]
  },  
   {
    "version": "3.0",
    "date": "06/10/2025",
    "notes": [
      "N√¢ng c·∫•p t√≠nh nƒÉng t·∫°o ch∆∞∆°ng tr√¨nh thi ƒëua v√† theo d√µi hi·ªáu qu·∫£ thi ƒëua : C√≥ th·ªÉ theo d√µi c√πng l√∫c nhi·ªÅu h√£ng trong c√πng 1 nh√≥m h√†ng.",
      "N√¢ng c·∫•p t√≠nh nƒÉng nh·∫≠n x√©t:cho ph√©p t·∫°o nh·∫≠n x√©t cho nhi·ªÅu tab ph·ª•.",
      "N√¢ng c·∫•p t√≠nh nƒÉng nh·∫≠n x√©t: Th√™m b·ªô l·ªçc t·∫•t c·∫£ nh√¢n vi√™n d∆∞·ªõi m·ª•c ti√™u khai b√°o"
    ]
  },  
  {
    "version": "2.8",
    "date": "01/10/2025",
    "notes": [
      "Th√™m t√≠nh nƒÉng t·∫°o ch∆∞∆°ng tr√¨nh thi ƒëua v√† theo d√µi hi·ªáu qu·∫£ thi ƒëua."
    ]
  },
    {
    "version": "2.7",
    "date": "26/09/2025",
    "notes": [
      "Th√™m t√≠nh nƒÉng th√¥ng b√°o c√≥ phi√™n b·∫£n m·ªõi.",
      "Th√™m t√≠nh nƒÉng video h∆∞·ªõng d·∫´n ngo√†i trang ch·ªß.",
      "Th√™m b·ªô ƒë·∫øm l∆∞·ª£t truy c·∫≠p v√† s·ª≠ d·ª•ng."
    ]
  },
{
    "version": "2.6",
    "date": "25/09/2025",
    "notes": [
      "S·ª≠a l·ªói t√≠nh nƒÉng s·∫Øp x·∫øp tr√™n t·∫•t c·∫£ c√°c b·∫£ng.",
      "Ph·ª•c h·ªìi b√°o c√°o 'Thi ƒëua NV' v√† 'Hi·ªáu qu·∫£ khai th√°c LK'.",
      "S·ª≠a l·ªói 'Thi·∫øt l·∫≠p m·ª•c ti√™u' c·∫≠p nh·∫≠t kh√¥ng t·ª©c th·ªùi.",
      "S·ª≠a l·ªói b·ªô l·ªçc n√¢ng cao kh√¥ng hi·ªÉn th·ªã d·ªØ li·ªáu."
    ]
  },
  {
    "version": "2.5",
    "date": "24/09/2025",
    "notes": [
      "Th√™m t√≠nh nƒÉng x·ª≠ l√Ω file thi ƒëua theo v√πng trong 'S·ª©c kh·ªèe si√™u th·ªã.",
      "N√¢ng c·∫•p t√≠nh nƒÉng 'Nh·∫≠n x√©t' : th√™m icon, th√™m c√°c th·∫ª t√πy ch·ªçn"
    ]
  },
    {
    "version": "2.2",
    "date": "23/09/2025",
    "notes": [
      "S·ª≠a l·ªói nghi√™m tr·ªçng: T√≠nh to√°n sai gi√° tr·ªã doanh thu sau khi c·∫≠p nh·∫≠t b·ªô l·ªçc.",
      "C·∫•u tr√∫c l·∫°i h·ªá th·ªëng qu·∫£n l√Ω phi√™n b·∫£n v√† l·ªãch s·ª≠ c·∫≠p nh·∫≠t."
    ]
  },
  {
    "version": "2.1",
    "date": "23/09/2025",
    "notes": [
      "S·ª≠a l·ªói b·ªô l·ªçc n√¢ng cao kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ch·ªçn.",
      "S·ª≠a l·ªói t√¥ m√†u ti√™u ƒë·ªÅ b·∫£ng kh√¥ng ho·∫°t ƒë·ªông do sai CSS Selector."
    ]
  },
  {
    "version": "2.0",
    "date": "16/09/2025",
    "notes": [
      "Phi√™n b·∫£n ph√°t h√†nh ƒë·∫ßu ti√™n.",
      "Bao g·ªìm c√°c ch·ª©c nƒÉng c·ªët l√µi: SKNV, SKST L≈©y k·∫ø, Doanh thu Realtime."
    ]
  }
]
--- END FILE: ./changelog.json ---

--- START FILE: ./components/drawer-goal.js ---
// Version 1.0 - Component: Goal Drawer
// Ch·ª©a m√£ HTML cho drawer thi·∫øt l·∫≠p m·ª•c ti√™u.

const drawerGoalHTML = `
<div id="goal-drawer" class="settings-drawer fixed top-0 left-0 h-full bg-white shadow-2xl z-50 p-6 overflow-y-auto hidden">
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800">Thi·∫øt l·∫≠p m·ª•c ti√™u</h3>
        <button class="close-drawer-btn text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
    </div>
    
    <div class="border-b border-gray-200 mb-4">
        <nav id="goal-drawer-tabs" class="-mb-px flex space-x-6" aria-label="Tabs" data-content-container="goal-drawer-content">
             <button class="sub-tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="goal-tab-monthly">M·ª•c ti√™u Th√°ng (L≈©y k·∫ø)</button>
             <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="goal-tab-daily">M·ª•c ti√™u Ng√†y (Realtime)</button>
        </nav>
    </div>

    <div id="goal-drawer-content">
        <div id="goal-tab-monthly" class="sub-tab-content space-y-4">
            <div>
                <label for="luyke-goal-warehouse-select" class="block text-sm font-medium text-gray-700 mb-1">Thi·∫øt l·∫≠p cho kho</label>
                <select id="luyke-goal-warehouse-select" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-2 gap-x-4 gap-y-3">
                <div>
                    <label for="luyke-goal-dtt" class="block text-sm font-medium text-gray-700">Target DT Th·ª±c</label>
                    <input type="number" id="luyke-goal-dtt" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="doanhThuThuc">
                </div>
                <div>
                    <label for="luyke-goal-dtqd" class="block text-sm font-medium text-gray-700">Target DT Qƒê</label>
                    <input type="number" id="luyke-goal-dtqd" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="doanhThuQD">
                </div>
                <div>
                    <label for="luyke-goal-ptqd" class="block text-sm font-medium text-gray-700">% Quy ƒë·ªïi</label>
                    <input type="number" id="luyke-goal-ptqd" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramQD">
                </div>
                <div>
                    <label for="luyke-goal-pttc" class="block text-sm font-medium text-gray-700">% Tr·∫£ ch·∫≠m</label>
                    <input type="number" id="luyke-goal-pttc" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramTC">
                </div>
                <div>
                    <label for="luyke-goal-giadung" class="block text-sm font-medium text-gray-700">% Gia d·ª•ng</label>
                    <input type="number" id="luyke-goal-giadung" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramGiaDung">
                </div>
                <div>
                    <label for="luyke-goal-mln" class="block text-sm font-medium text-gray-700">% MLN</label>
                    <input type="number" id="luyke-goal-mln" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramMLN">
                </div>
                <div>
                    <label for="luyke-goal-phukien" class="block text-sm font-medium text-gray-700">% Ph·ª• ki·ªán</label>
                    <input type="number" id="luyke-goal-phukien" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramPhuKien">
                </div>
                 <div>
                    <label for="luyke-goal-baohiem" class="block text-sm font-medium text-gray-700">% B·∫£o hi·ªÉm</label>
                    <input type="number" id="luyke-goal-baohiem" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramBaoHiem">
                </div>
                <div>
                    <label for="luyke-goal-sim" class="block text-sm font-medium text-gray-700">% Sim</label>
                    <input type="number" id="luyke-goal-sim" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramSim">
                </div>
                <div>
                    <label for="luyke-goal-vas" class="block text-sm font-medium text-gray-700">% VAS</label>
                    <input type="number" id="luyke-goal-vas" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramVAS">
                </div>
            </div>
        </div>
        <div id="goal-tab-daily" class="sub-tab-content hidden space-y-4">
            <div>
                <label for="rt-goal-warehouse-select" class="block text-sm font-medium text-gray-700 mb-1">Thi·∫øt l·∫≠p cho kho</label>
                <select id="rt-goal-warehouse-select" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select>
            </div>
            <div class="grid grid-cols-2 gap-4 items-end">
                <div class="flex items-center gap-x-2">
                    <label for="rt-open-hour" class="font-medium text-gray-700 text-sm">M·ªü c·ª≠a:</label>
                    <input type="time" id="rt-open-hour" class="rt-setting-input p-1 border border-gray-300 rounded-md shadow-sm w-24">
                </div>
                <div class="flex items-center gap-x-2">
                    <label for="rt-close-hour" class="font-medium text-gray-700 text-sm">ƒê√≥ng c·ª≠a:</label>
                    <input type="time" id="rt-close-hour" class="rt-setting-input p-1 border border-gray-300 rounded-md shadow-sm w-24">
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-2 gap-x-4 gap-y-3">
                <div>
                    <label for="rt-goal-dtt" class="block text-sm font-medium text-gray-700">DT Th·ª±c (tri·ªáu)</label>
                    <input type="number" id="rt-goal-dtt" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="doanhThuThuc">
                </div>
                <div>
                    <label for="rt-goal-dtqd" class="block text-sm font-medium text-gray-700">DT Qƒê (tri·ªáu)</label>
                    <input type="number" id="rt-goal-dtqd" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="doanhThuQD">
                </div>
                <div>
                    <label for="rt-goal-ptqd" class="block text-sm font-medium text-gray-700">% Quy ƒë·ªïi</label>
                    <input type="number" id="rt-goal-ptqd" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramQD">
                </div>
                <div>
                    <label for="rt-goal-pttc" class="block text-sm font-medium text-gray-700">% Tr·∫£ ch·∫≠m</label>
                    <input type="number" id="rt-goal-pttc" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramTC">
                </div>
                <div>
                    <label for="rt-goal-giadung" class="block text-sm font-medium text-gray-700">% Gia d·ª•ng</label>
                    <input type="number" id="rt-goal-giadung" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramGiaDung">
                </div>
                <div>
                    <label for="rt-goal-mln" class="block text-sm font-medium text-gray-700">% MLN</label>
                    <input type="number" id="rt-goal-mln" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramMLN">
                </div>
                <div>
                    <label for="rt-goal-phukien" class="block text-sm font-medium text-gray-700">% Ph·ª• ki·ªán</label>
                    <input type="number" id="rt-goal-phukien" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramPhuKien">
                </div>
                <div>
                    <label for="rt-goal-sim" class="block text-sm font-medium text-gray-700">% Sim</label>
                    <input type="number" id="rt-goal-sim" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramSim">
                </div>
                <div>
                    <label for="rt-goal-vas" class="block text-sm font-medium text-gray-700">% VAS</label>
                    <input type="number" id="rt-goal-vas" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramVAS">
                </div>
                 <div>
                    <label for="rt-goal-baohiem" class="block text-sm font-medium text-gray-700">% B·∫£o hi·ªÉm</label>
                    <input type="number" id="rt-goal-baohiem" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramBaoHiem">
                </div>
            </div>
        </div>
    </div>

    <div class="border-t pt-6 mt-6">
         <div id="goal-tab-competition" class="space-y-4">
            <h4 class="text-md font-bold text-gray-800 mb-3">Qu·∫£n l√Ω Ch∆∞∆°ng tr√¨nh Thi ƒëua</h4>
            <div id="competition-list-container" class="space-y-2 mb-4">
            </div>
            <form id="competition-form" class="p-4 bg-slate-50 border rounded-lg space-y-3 hidden">
                <input type="hidden" id="competition-id">
                <div>
                    <label for="competition-name" class="block text-sm font-medium text-gray-700">T√™n ch∆∞∆°ng tr√¨nh</label>
                    <input type="text" id="competition-name" class="mt-1 block w-full p-2 border rounded-md" placeholder="VD: Thi ƒëua TV Sony T9">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="competition-brand" class="block text-sm font-medium text-gray-700">H√£ng s·∫£n xu·∫•t</label>
                        <select id="competition-brand" multiple class="mt-1 block w-full"></select>
                    </div>
                    <div>
                        <label for="competition-group" class="block text-sm font-medium text-gray-700">Nh√≥m h√†ng</label>
                        <select id="competition-group" multiple class="mt-1 block w-full"></select>
                    </div>
                </div>
                <div>
                    <label for="competition-type" class="block text-sm font-medium text-gray-700">Lo·∫°i ƒëo l∆∞·ªùng</label>
                    <select id="competition-type" class="mt-1 block w-full p-2 border rounded-md">
                        <option value="doanhthu">Theo Doanh thu</option>
                        <option value="soluong">Theo S·ªë l∆∞·ª£ng</option>
                    </select>
                </div>
                <div id="price-segment" class="hidden grid grid-cols-2 gap-4">
                    <div>
                        <label for="competition-min-price" class="block text-sm font-medium text-gray-700">Gi√° t·ª´ (tri·ªáu)</label>
                        <input type="number" id="competition-min-price" class="mt-1 block w-full p-2 border rounded-md" placeholder="VD: 3 (cho 3 tri·ªáu)">
                    </div>
                     <div>
                        <label for="competition-max-price" class="block text-sm font-medium text-gray-700">Gi√° ƒë·∫øn (tri·ªáu)</label>
                        <input type="number" id="competition-max-price" class="mt-1 block w-full p-2 border rounded-md" placeholder="VD: 5 (cho 5 tri·ªáu)">
                    </div>
                </div>
                <div class="flex items-center">
                    <input id="competition-exclude-apple" type="checkbox" class="h-4 w-4 rounded border-gray-300">
                    <label for="competition-exclude-apple" class="ml-2 block text-sm text-gray-900">Tr·ª´ h√£ng Apple kh·ªèi d·ªØ li·ªáu so s√°nh</label>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="cancel-competition-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">H·ªßy</button>
                    <button type="submit" id="save-competition-btn" class="px-4 py-2 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700">L∆∞u</button>
                </div>
            </form>
            <button id="add-competition-btn" class="mt-2 w-full text-sm py-2 px-4 border-2 border-dashed rounded-lg hover:bg-slate-50">
                + Th√™m ch∆∞∆°ng tr√¨nh m·ªõi
            </button>
        </div>
    </div>
</div>
`;

export const drawerGoal = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = drawerGoalHTML;
        }
    }
};
--- END FILE: ./components/drawer-goal.js ---

--- START FILE: ./components/drawer-interface.js ---
// Version 1.1 - Update font size slider range and default value
// Ch·ª©a m√£ HTML cho drawer c√†i ƒë·∫∑t giao di·ªán.

const drawerInterfaceHTML = `
<div id="interface-drawer" class="settings-drawer fixed top-0 left-0 h-full bg-white shadow-2xl z-50 p-6 overflow-y-auto hidden">
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800">C√†i ƒë·∫∑t giao di·ªán</h3>
        <button class="close-drawer-btn text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
    </div>
    <div class="space-y-6">
        <div>
            <label for="contrast-selector-drawer" class="block text-sm font-medium text-gray-700 mb-2">ƒê·ªô t∆∞∆°ng ph·∫£n</label>
            <select id="contrast-selector-drawer" class="contrast-selector w-full p-2 border rounded-lg text-sm bg-white shadow-sm">
                <option value="1">R·∫•t nh·∫π</option>
                <option value="2">Nh·∫π</option>
                <option value="3" selected>B√¨nh th∆∞·ªùng</option>
                <option value="4">Cao</option>
                <option value="5">R·∫•t cao</option>
                <option value="6">Cao nh·∫•t</option>
            </select>
        </div>
        <div>
            <label for="global-font-size-slider" class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                <span>C·ª° ch·ªØ to√†n trang</span>
                <span id="global-font-size-value" class="font-bold text-blue-600">18px</span>
            </label>
            <input type="range" id="global-font-size-slider" min="12" max="25" step="1" value="18" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
        </div>
        <div>
             <label for="kpi-font-size-slider" class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                <span>C·ª° ch·ªØ th·∫ª KPI</span>
                <span id="kpi-font-size-value" class="font-bold text-blue-600">36px</span>
            </label>
            <input type="range" id="kpi-font-size-slider" min="24" max="48" step="2" value="36" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
        </div>
        <div>
            <h4 class="text-sm font-medium text-gray-700 mb-2">M√†u s·∫Øc th·∫ª KPI</h4>
            <div class="grid grid-cols-2 gap-4">
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-1" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#38bdf8">
                    <label for="kpi-color-1" class="text-sm">Th·∫ª 1</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-2" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#34d399">
                    <label for="kpi-color-2" class="text-sm">Th·∫ª 2</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-3" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#fbbf24">
                    <label for="kpi-color-3" class="text-sm">Th·∫ª 3</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-4" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#2dd4bf">
                    <label for="kpi-color-4" class="text-sm">Th·∫ª 4</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-5" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#a78bfa">
                    <label for="kpi-color-5" class="text-sm">Th·∫ª 5</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-6" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#f472b6">
                    <label for="kpi-color-6" class="text-sm">Th·∫ª 6</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-7" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#818cf8">
                    <label for="kpi-color-7" class="text-sm">Th·∫ª 7</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-8" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#f87171">
                    <label for="kpi-color-8" class="text-sm">Th·∫ª 8</label>
                </div>
            </div>
        </div>
         <div>
            <h4 class="text-sm font-medium text-gray-700 mb-2">M√†u ch·ªØ th·∫ª KPI</h4>
             <div class="space-y-2">
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-title-color" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#ffffff">
                    <label for="kpi-title-color" class="text-sm">Ti√™u ƒë·ªÅ th·∫ª</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-main-color" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#ffffff">
                    <label for="kpi-main-color" class="text-sm">Gi√° tr·ªã ch√≠nh</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-sub-color" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#ffffff">
                    <label for="kpi-sub-color" class="text-sm">Gi√° tr·ªã ph·ª•</label>
                </div>
            </div>
        </div>
    </div>
</div>
`;

export const drawerInterface = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = drawerInterfaceHTML;
        }
    }
};
--- END FILE: ./components/drawer-interface.js ---

--- START FILE: ./components/modal-admin.js ---
// Version 1.0 - Component: Admin Modal
// Ch·ª©a m√£ HTML cho modal y√™u c·∫ßu m·∫≠t kh·∫©u admin.

const modalAdminHTML = `
<div id="admin-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-4">
        <h3 class="text-lg font-bold mb-4">Truy c·∫≠p khu v·ª±c Admin</h3>
        <p class="text-sm text-gray-600 mb-4">Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ xem v√† ch·ªânh s·ª≠a ph·∫ßn Khai b√°o.</p>
        <input type="password" id="admin-password-input" class="w-full p-2 border rounded-lg mb-2" placeholder="M·∫≠t kh·∫©u...">
        <p id="admin-error-msg" class="text-red-500 text-sm mb-4 hidden">M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng. Vui l√≤ng th·ª≠ l·∫°i.</p>
        <div class="flex justify-end space-x-3">
            <button id="admin-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">H·ªßy</button>
            <button id="admin-submit-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">X√°c nh·∫≠n</button>
        </div>
    </div>
</div>
`;

export const modalAdmin = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalAdminHTML;
        }
    }
};
--- END FILE: ./components/modal-admin.js ---

--- START FILE: ./components/modal-chart.js ---
// Version 1.0 - Component: Chart Modal
// Ch·ª©a m√£ HTML cho modal hi·ªÉn th·ªã bi·ªÉu ƒë·ªì chi ti·∫øt.

const modalChartHTML = `
<div id="chart-modal" class="modal hidden">
    <div class="modal__overlay" data-close-modal></div>
    <div class="modal__container modal__container--large">
         <div class="modal__header">
            <h3 id="chart-modal-title" class="modal__title"></h3>
            <button class="modal__close-btn" data-close-modal>&times;</button>
        </div>
        <div class="modal__content">
            <canvas id="top10-chart"></canvas>
        </div>
    </div>
</div>
`;

export const modalChart = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalChartHTML;
        }
    }
};
--- END FILE: ./components/modal-chart.js ---

--- START FILE: ./components/modal-composer.js ---
// Version 1.0 - Component: Composer Modal
// Ch·ª©a m√£ HTML cho modal Tr√¨nh t·∫°o Nh·∫≠n x√©t.

const modalComposerHTML = `
<div id="composer-modal" class="modal hidden">
    <div class="modal__overlay" data-close-modal></div>
    <div class="modal__container modal__container--large">
        <div class="modal__header">
            <h3 id="composer-modal-title" class="modal__title">Tr√¨nh t·∫°o Nh·∫≠n x√©t</h3>
            <button class="modal__close-btn" data-close-modal>&times;</button>
        </div>
        <div id="composer-modal-content" class="modal__content">
            <div class="composer">
                <div class="composer__editor">
                    <label class="composer__label">N·ªôi dung nh·∫≠n x√©t</label>
                    <nav id="composer-context-tabs" class="composer__nav mb-2"></nav>
                    <div id="composer-context-content">
                        </div>
                </div>
                <div class="composer__tags">
                    <div class="composer__nav">
                        <button class="composer__tab-btn active" data-tab="tab-general">Chung & Icons</button>
                        <button class="composer__tab-btn" data-tab="tab-kpi">KPIs Si√™u Th·ªã</button>
                        <button class="composer__tab-btn" data-tab="tab-ranking">X·∫øp H·∫°ng NV</button>
                        <button class="composer__tab-btn" data-tab="tab-details">Thi ƒêua & Chi Ti·∫øt</button>
                    </div>

                    <div class="composer__content">
                        <div class="composer__tab-pane active" id="tab-general">
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">Chung</h5>
                                <button class="composer__tag-btn" data-tag="[NGAY]">Ng√†y</button>
                                <button class="composer__tag-btn" data-tag="[GIO]">Gi·ªù</button>
                            </div>
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">Bi·ªÉu t∆∞·ª£ng (Icons)</h5>
                                <button class="composer__icon-btn">üìä</button>
                                <button class="composer__icon-btn">üí∞</button>
                                <button class="composer__icon-btn">üí•</button>
                                <button class="composer__icon-btn">üéØ</button>
                                <button class="composer__icon-btn">üìà</button>
                                <button class="composer__icon-btn">üì¶</button>
                                <button class="composer__icon-btn">‚ö†Ô∏è</button>
                                <button class="composer__icon-btn">üî•</button>
                                <button class="composer__icon-btn">‚úÖ</button>
                            </div>
                        </div>

                        <div class="composer__tab-pane" id="tab-kpi">
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">KPIs Ch√≠nh</h5>
                                <button class="composer__tag-btn" data-tag="[DT_THUC]">DT Th·ª±c</button>
                                <button class="composer__tag-btn" data-tag="[DTQD]">DT Quy ƒë·ªïi</button>
                                <button class="composer__tag-btn" data-tag="[%HT_DTT]">%HT DT Th·ª±c</button>
                                <button class="composer__tag-btn" data-tag="[%HT_DTQD]">%HT DT Qƒê</button>
                                <button class="composer__tag-btn" data-tag="[TLQD]">T·ª∑ l·ªá Quy ƒë·ªïi</button>
                                <button class="composer__tag-btn" data-tag="[DT_CHUAXUAT]">DTQƒê Ch∆∞a Xu·∫•t</button>
                                <button class="composer__tag-btn" data-tag="[SS_CUNGKY]">TƒÉng/gi·∫£m C√πng k·ª≥</button>
                            </div>
                        </div>

                        <div class="composer__tab-pane" id="tab-ranking">
                            <div class="composer__filter-group">
                                <label for="composer-dept-filter" class="composer__label">L·ªçc theo b·ªô ph·∫≠n:</label>
                                <select id="composer-dept-filter" class="composer__select">
                                    <option value="ALL">To√†n si√™u th·ªã</option>
                                </select>
                            </div>
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">X·∫øp h·∫°ng DT Quy ƒê·ªïi</h5>
                                <button class="composer__tag-btn" data-tag-template="[TOP3_DTQD_{dept}@msnv]">Top 3</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT3_DTQD_{dept}@msnv]">Bot 3</button>
                            </div>
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">X·∫øp h·∫°ng Thu Nh·∫≠p</h5>
                                <button class="composer__tag-btn" data-tag-template="[TOP3_THUNHAP_{dept}@msnv]">Top 3</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT3_THUNHAP_{dept}@msnv]">Bot 3</button>
                            </div>
                             <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">X·∫øp h·∫°ng T·ª∑ l·ªá Quy ƒë·ªïi</h5>
                                <button class="composer__tag-btn" data-tag-template="[TOP3_TLQD_{dept}@msnv]">Top 3</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT3_TLQD_{dept}@msnv]">Bot 3</button>
                            </div>
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">NV D∆∞·ªõi M·ª•c Ti√™u Khai B√°o</h5>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_TLQD_{dept}@msnv]">% Quy ƒë·ªïi</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_TLTC_{dept}@msnv]">% Tr·∫£ ch·∫≠m</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_PK_{dept}@msnv]">% Ph·ª• ki·ªán</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_GD_{dept}@msnv]">% Gia d·ª•ng</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_MLN_{dept}@msnv]">% MLN</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_SIM_{dept}@msnv]">% Sim</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_VAS_{dept}@msnv]">% VAS</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_BH_{dept}@msnv]">% B·∫£o hi·ªÉm</button>
                            </div>
                            </div>
                        
                        <div class="composer__tab-pane" id="tab-details">
                            <div class="composer__sub-nav">
                                <button class="composer__sub-tab-btn active" data-sub-tab="sub-tab-thidua">Thi ƒêua</button>
                                <button class="composer__sub-tab-btn" data-sub-tab="sub-tab-qdc">Nh√≥m QƒêC</button>
                                <button class="composer__sub-tab-btn" data-sub-tab="sub-tab-nganhhang">Ng√†nh H√†ng</button>
                            </div>
                            <div class="composer__sub-content">
                                <div class="composer__sub-tab-pane active" id="sub-tab-thidua">
                                    <div class="composer__tag-group">
                                        <h5 class="composer__tag-group-title">Thi ƒêua Ng√†nh H√†ng</h5>
                                        <button class="composer__tag-btn" data-tag="[TD_TONG_CT]">T·ªïng CT</button>
                                        <button class="composer__tag-btn" data-tag="[TD_CT_DAT]">>100%</button>
                                        <button class="composer__tag-btn" data-tag="[TD_CT_CHUADAT]"><100%</button>
                                        <button class="composer__tag-btn" data-tag="[TD_TYLE_DAT]">% ƒê·∫°t</button>
                                    </div>
                                </div>
                                <div class="composer__sub-tab-pane" id="sub-tab-qdc">
                                    <div id="composer-qdc-tags-container" class="composer__tag-group">
                                        <h5 class="composer__tag-group-title">Ch·ªçn Nh√≥m H√†ng QƒêC</h5>
                                    </div>
                                </div>
                                <div class="composer__sub-tab-pane" id="sub-tab-nganhhang">
                                    <div id="composer-nganhhang-tags-container" class="composer__tag-group">
                                        <h5 class="composer__tag-group-title">Ch·ªçn Ng√†nh H√†ng Chi Ti·∫øt</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal__footer">
            <button id="save-composer-template-btn" class="action-btn action-btn--save">L∆∞u m·∫´u</button>
            <button id="copy-composed-notification-btn" class="action-btn action-btn--copy">Xem tr∆∞·ªõc & Sao ch√©p</button>
        </div>
    </div>
</div>
`;

export const modalComposer = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalComposerHTML;
        }
    }
};
--- END FILE: ./components/modal-composer.js ---

--- START FILE: ./components/modal-force-update.js ---
// Version 1.1 - Add container for update notes
// MODULE: COMPONENTS - FORCE UPDATE MODAL
// Ch·ª©a m√£ HTML cho modal y√™u c·∫ßu ng∆∞·ªùi d√πng c·∫≠p nh·∫≠t phi√™n b·∫£n.

const modalForceUpdateHTML = `
<div id="force-update-modal" class="modal hidden">
    <div class="modal__overlay" style="cursor: not-allowed;"></div>
    <div class="modal__container" style="max-width: 500px;">
        <div class="modal__header">
            <h3 id="force-update-title" class="modal__title">üì¢ ƒê√£ c√≥ phi√™n b·∫£n m·ªõi!</h3>
        </div>
        <div class="modal__content">
            <p class="text-gray-600 mb-4">M·ªôt phi√™n b·∫£n m·ªõi v·ªõi c√°c b·∫£n s·ª≠a l·ªói v√† c·∫£i ti·∫øn ƒë√£ s·∫µn s√†ng. Vui l√≤ng t·∫£i l·∫°i trang ƒë·ªÉ ti·∫øp t·ª•c.</p>
            
            <div id="update-notes-container" class="my-4 p-3 bg-gray-50 border border-gray-200 rounded-lg max-h-48 overflow-y-auto">
                <p class="text-sm text-gray-500">ƒêang t·∫£i chi ti·∫øt...</p>
            </div>
            <button id="force-reload-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition text-lg">
                C·∫≠p nh·∫≠t ngay
            </button>
        </div>
    </div>
</div>
`;

export const modalForceUpdate = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalForceUpdateHTML;
        }
    }
};
--- END FILE: ./components/modal-force-update.js ---

--- START FILE: ./components/modal-help.js ---
// Version 1.0 - Component: Help Modal
// Ch·ª©a m√£ HTML cho modal hi·ªÉn th·ªã n·ªôi dung h∆∞·ªõng d·∫´n.

const modalHelpHTML = `
<div id="help-modal" class="modal hidden">
    <div class="modal__overlay" data-close-modal></div>
    <div class="modal__container">
        <div class="modal__header">
            <h3 id="help-modal-title" class="modal__title"></h3>
            <button class="modal__close-btn" data-close-modal>&times;</button>
        </div>
        <div id="help-modal-content" class="modal__content">
        </div>
    </div>
</div>
`;

export const modalHelp = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalHelpHTML;
        }
    }
};
--- END FILE: ./components/modal-help.js ---

--- START FILE: ./components/modal-preview.js ---
// Version 1.0 - Component: Preview Modal
// Ch·ª©a m√£ HTML cho modal xem tr∆∞·ªõc n·ªôi dung nh·∫≠n x√©t.

const modalPreviewHTML = `
<div id="preview-modal" class="modal hidden">
    <div class="modal__overlay" data-close-modal></div>
    <div class="modal__container">
        <div class="modal__header">
            <h3 id="preview-modal-title" class="modal__title">Xem tr∆∞·ªõc n·ªôi dung</h3>
            <button class="modal__close-btn" data-close-modal>&times;</button>
        </div>
        <div class="modal__content">
            <pre id="preview-modal-content" class="preview-content"></pre>
        </div>
        <div class="modal__footer">
            <button id="copy-from-preview-btn" class="action-btn action-btn--copy">Sao ch√©p n·ªôi dung</button>
        </div>
    </div>
</div>
`;

export const modalPreview = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalPreviewHTML;
        }
    }
};
--- END FILE: ./components/modal-preview.js ---

--- START FILE: ./components/modal-selection.js ---
// Version 1.0 - Component: Selection Modal
// Ch·ª©a m√£ HTML cho modal t√πy ch·ªânh hi·ªÉn th·ªã chung.

const modalSelectionHTML = `
<div id="selection-modal" class="modal hidden">
    <div class="modal__overlay" data-close-modal></div>
    <div class="modal__container">
        <div class="modal__header">
            <h3 id="selection-modal-title" class="modal__title">T√πy ch·ªânh hi·ªÉn th·ªã</h3>
            <button class="modal__close-btn" data-close-modal>&times;</button>
        </div>
        <div class="modal__content">
            <input type="text" id="selection-modal-search" class="w-full p-2 border rounded-md mb-4" placeholder="T√¨m ki·∫øm m·ª•c...">
            <div id="selection-modal-list" class="space-y-2 max-h-64 overflow-y-auto">
                </div>
        </div>
        <div class="modal__footer">
            <button id="selection-modal-save-btn" class="action-btn action-btn--save">L∆∞u C√†i ƒê·∫∑t</button>
        </div>
    </div>
</div>
`;

export const modalSelection = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalSelectionHTML;
        }
    }
};
--- END FILE: ./components/modal-selection.js ---

--- START FILE: ./components/sidebar.js ---
// Version 1.4 - Add font-semibold to all nav links for consistency
// Version 1.3 - Optimize HTML for better icon/text alignment
// Ch·ª©a m√£ HTML v√† logic cho thanh ƒëi·ªÅu h∆∞·ªõng b√™n.

const sidebarHTML = `
<nav id="sidebar" class="bg-white/80 backdrop-blur-sm shadow-lg fixed top-0 left-0 h-full z-30 p-3 flex flex-col justify-between">
    <div>
         <a href="#home-section" class="nav-link flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold mb-4">
            <i data-feather="home"></i>
            <span class="menu-text">H∆∞·ªõng D·∫´n & G√≥p √ù</span>
        </a>
        <ul class="space-y-2">
            <li>
                <a href="#data-section" class="nav-link flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="file-text"></i>
                    <span class="menu-text">C·∫≠p nh·∫≠t d·ªØ li·ªáu</span>
                </a>
            </li>
            <li>
                <a href="#health-section" class="nav-link flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="activity"></i>
                    <span class="menu-text">S·ª©c kh·ªèe si√™u th·ªã</span>
                </a>
            </li>
            <li>
                <a href="#health-employee-section" class="nav-link flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="users"></i>
                    <span class="menu-text">S·ª©c kh·ªèe nh√¢n vi√™n</span>
                </a>
            </li>
            <li>
                <a href="#realtime-section" class="nav-link flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="trending-up"></i>
                    <span class="menu-text">Doanh thu realtime</span>
                </a>
            </li>
        </ul>
    </div>
    <div>
        <ul class="space-y-2">
            <li>
                <button id="interface-settings-btn" class="w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="settings"></i>
                    <span class="menu-text">C√†i ƒë·∫∑t giao di·ªán</span>
                </button>
            </li>
            <li>
                <button id="goal-settings-btn" class="w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="target"></i>
                    <span class="menu-text">Thi·∫øt l·∫≠p m·ª•c ti√™u</span>
                </button>
            </li>
            <li>
                <button id="admin-access-btn" class="w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="edit"></i>
                    <span class="menu-text">Khai b√°o</span>
                </button>
            </li>
        </ul>
    </div>
</nav>
`;

export const sidebar = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = sidebarHTML;
        }
    }
};
--- END FILE: ./components/sidebar.js ---

--- START FILE: ./config.js ---
// Version 2.2 - New Features & Refinements
// MODULE 1: T·ª¶ C·∫§U H√åNH (CONFIG)
// File n√†y ch·ª©a t·∫•t c·∫£ c√°c c·∫•u h√¨nh tƒ©nh c·ªßa ·ª©ng d·ª•ng.

const config = {
    ADMIN_PASSWORD: "Linh3031",
    COLUMN_MAPPINGS: {
        danhsachnv: {
            maKho: { required: true, displayName: 'M√£ Kho', aliases: ['m√£ kho', 'makho', 'kho'] },
            maNV: { required: true, displayName: 'M√£ Nh√¢n Vi√™n', aliases: ['m√£ nv', 'msnv', 'm√£ nh√¢n vi√™n', 'manv', 'm√£ s·ªë nh√¢n vi√™n'] },
            hoTen: { required: true, displayName: 'H·ªç v√† T√™n', aliases: ['h·ªç v√† t√™n', 't√™n nh√¢n vi√™n', 't√™n nv', 'h·ªç t√™n'] },
            boPhan: { required: true, displayName: 'B·ªô ph·∫≠n', aliases: ['b·ªô ph·∫≠n'] }
        },
        ycx: { // D√πng chung cho c·∫£ YCX l≈©y k·∫ø v√† YCX realtime
            ngayTao: { required: true, displayName: 'Ng√†y t·∫°o', aliases: ['ng√†y t·∫°o'] },
            ngayHenGiao: { required: false, displayName: 'Ng√†y h·∫πn giao', aliases: ['ng√†y h·∫πn giao'] },
            nguoiTao: { required: true, displayName: 'Ng∆∞·ªùi t·∫°o', aliases: ['ng∆∞·ªùi t·∫°o'] },
            thanhTien: { required: true, displayName: 'Gi√° b√°n', aliases: ['gi√° b√°n_1', 'gi√° b√°n'] },
            soLuong: { required: true, displayName: 'S·ªë l∆∞·ª£ng', aliases: ['sl b√°n', 's·ªë l∆∞·ª£ng'] },
            nhomHang: { required: true, displayName: 'Nh√≥m h√†ng', aliases: ['nh√≥m h√†ng'] },
            tenSanPham: { required: true, displayName: 'T√™n s·∫£n ph·∫©m', aliases: ['t√™n s·∫£n ph·∫©m'] },
            tenKhachHang: { required: true, displayName: 'T√™n kh√°ch h√†ng', aliases: ['t√™n kh√°ch h√†ng', 'tenkhachhang'] },
            nhaSanXuat: { required: true, displayName: 'Nh√† s·∫£n xu·∫•t', aliases: ['nh√† s·∫£n xu·∫•t', 'nhasanxuat'] },
            nganhHang: { required: true, displayName: 'Ng√†nh h√†ng', aliases: ['ng√†nh h√†ng'] },
            hinhThucXuat: { required: true, displayName: 'H√¨nh th·ª©c xu·∫•t', aliases: ['h√¨nh th·ª©c xu·∫•t'] },
            trangThaiThuTien: { required: true, displayName: 'Tr·∫°ng th√°i thu ti·ªÅn', aliases: ['tr·∫°ng th√°i thu ti·ªÅn'] },
            trangThaiHuy: { required: true, displayName: 'Tr·∫°ng th√°i h·ªßy', aliases: ['tr·∫°ng th√°i h·ªßy'] },
            tinhTrangTra: { required: true, displayName: 'T√¨nh tr·∫°ng tr·∫£', aliases: ['t√¨nh tr·∫°ng nh·∫≠p tr·∫£ c·ªßa s·∫£n ph·∫©m ƒë·ªïi v·ªõi s·∫£n ph·∫©m ch√≠nh', 't√¨nh tr·∫°ng tr·∫£'] },
            trangThaiXuat: { required: true, displayName: 'Tr·∫°ng th√°i xu·∫•t', aliases: ['tr·∫°ng th√°i xu·∫•t'] }
        },
        giocong: {
            maNV: { required: false, displayName: 'M√£ NV', aliases: ['m√£ nv', 'msnv'] },
            hoTen: { required: false, displayName: 'T√™n NV', aliases: ['t√™n nv', 'tennv'] },
            tongGioCong: { required: true, displayName: 'T·ªïng gi·ªù c√¥ng', aliases: ['t·ªïng gi·ªù c√¥ng (x.nh·∫≠n) total', 't·ªïng gi·ªù c√¥ng'] }
        },
        thuongnong: {
            maNV: { required: false, displayName: 'M√£ NV', aliases: ['manv', 'm√£ nv'] },
            hoTen: { required: false, displayName: 'T√™n NV', aliases: ['tennv', 't√™n nv'] },
            diemThuong: { required: true, displayName: 'ƒêi·ªÉm th∆∞·ªüng', aliases: ['diemthuong', 'ƒëi·ªÉm th∆∞·ªüng'] }
        }
    },
    PRODUCT_GROUPS: {
        ICT: ['1491', '931', '42'],
        CE: ['1097', '1098', '1099', '1094', '894'],
        PHU_KIEN: ['16', '1394', '184', '764'], // 16 - Ph·ª• ki·ªán ti·ªán √≠ch, 1394 - Ph·ª• ki·ªán l·∫Øp ƒë·∫∑t, 184 - Ph·ª• ki·ªán trang tr√≠, 764 - Loa vi t√≠nh
        GIA_DUNG: ['484', '1214'], // M√£ ng√†nh h√†ng Gia D·ª•ng
        MAY_LOC_NUOC: ['4171', '4172'], // M√£ nh√≥m h√†ng M√°y L·ªçc N∆∞·ªõc
        PIN_SDP: '12',
        CAMERA_TRONG_NHA: '6479',
        CAMERA_NGOAI_TROi: '4219',
        TAI_NGHE_BLT: '4540',
        NOI_CHIEN: '4099',
        ROBOT_HB: '4439',
        TIVI: '1094',
        TU_LANH: '1097',
        MAY_GIAT: '1099',
        MAY_LANH: '1098',
        DIEN_THOAI: ['13', '1491', '18'],
        LAPTOP: '42',
        SIM: ['1891', '664'],
        VAS: ['164', '571'],
        BAO_HIEM_VAS: ['4479', '4499'],
        SMARTPHONE: ['1491', '18', '13'],
        BAO_HIEM_DENOMINATOR: ['1491', '1097', '894', '1099', '1098', '42', '1094', '3859', '911', '893', '3659'],
        QDC_GROUPS: {
            PIN_SDP: { codes: ['12'], name: 'Pin SDP' },
            TAI_NGHE_BLT: { codes: ['3346', '4540'], name: 'Tai nghe BLT' },
            DONG_HO: { codes: ['4059', '4060', '4061', '4062', '4063', '4064', '4070'], name: 'ƒê·ªìng h·ªì' },
            CAMERA: { codes: ['4219', '6479'], name: 'Camera' },
            LOA: { codes: ['1031', '1351', '4779'], name: 'Loa' },
            UDDD: { codes: ['571', '611'], name: 'UDDƒê' },
            BAO_HIEM: { codes: ['4479', '4499'], name: 'B·∫£o hi·ªÉm' },
            NOI_COM: { codes: ['4157', '4158'], name: 'N·ªìi c∆°m ƒëi·ªán t·ª≠ + cao t·∫ßn' },
            NOI_CHIEN: { codes: ['4099'], name: 'N·ªìi chi√™n' },
            MAY_LOC_NUOC: { codes: ['4171', '4172'], name: 'M√°y l·ªçc n∆∞·ªõc' },
            ROBOT_HB: { codes: ['4439'], name: 'Robot h√∫t b·ª•i' },
            SIM_ONLINE: { codes: ['1891'], name: 'SIM' }
        }
    },
    DEPARTMENT_GROUPS: [
        'BP T∆∞ V·∫•n - ƒêM',
        'BP Trang Tr√≠ ki√™m Thu ng√¢n - Sim S·ªë - ƒêM',
        'BP Kho Ki√™m H·ªó Tr·ª£ K·ªπ Thu·∫≠t Xe ƒê·∫°p - ƒêM'
    ],
    DEFAULT_DATA: {
        HINH_THUC_XUAT_TINH_DOANH_THU: [
            'Xu·∫•t b√°n h√†ng t·∫°i si√™u th·ªã', 'Xu·∫•t cung ·ª©ng d·ªãch v·ª•',
            'Xu·∫•t b√°n pre-order t·∫°i si√™u th·ªã', 'Xu·∫•t SIM tr·∫Øng k√®m theo SIM',
            'Xu·∫•t b√°n h√†ng ∆∞u ƒë√£i cho nh√¢n vi√™n', 'Xu·∫•t b√°n h√†ng t·∫°i si√™u th·ªã (TCƒêM)',
            'Xu·∫•t d·ªãch v·ª• b·∫£o h√†nh tr·ªçn ƒë·ªùi', 'Xu·∫•t d·ªãch v·ª• b·∫£o d∆∞·ª°ng tr·ªçn ƒë·ªùi',
            'Xu·∫•t b√°n h√†ng tr·∫£ g√≥p t·∫°i si√™u th·ªã', 'Xu·∫•t b√°n tr·∫£ g√≥p ∆∞u ƒë√£i cho nh√¢n vi√™n',
            'Xu·∫•t b√°n tr·∫£ g√≥p cho NV ph·ª•c v·ª• c√¥ng vi·ªác', 'Xu·∫•t b√°n pre-order tr·∫£ g√≥p t·∫°i si√™u th·ªã',
            'Xu·∫•t b√°n pre-order tr·∫£ g√≥p t·∫°i si√™u th·ªã (TCƒêM)',
            'Xu·∫•t d·ªãch v·ª• thu h·ªô b·∫£o hi·ªÉm'
        ],
        HINH_THUC_XUAT_TRA_GOP: ['Xu·∫•t b√°n h√†ng tr·∫£ g√≥p t·∫°i si√™u th·ªã', 'Xu·∫•t b√°n tr·∫£ g√≥p ∆∞u ƒë√£i cho nh√¢n vi√™n', 'Xu·∫•t b√°n tr·∫£ g√≥p cho NV ph·ª•c v·ª• c√¥ng vi·ªác', 'Xu·∫•t b√°n pre-order tr·∫£ g√≥p t·∫°i si√™u th·ªã', 'Xu·∫•t b√°n pre-order tr·∫£ g√≥p t·∫°i si√™u th·ªã (TCƒêM)'],
        HE_SO_QUY_DOI: { '1098 - M√°y l·∫°nh (IMEI)': 1, '2011 - Khuy·∫øn m√£i - SP ·∫¢o': 1, '2511 - N·∫°p ti·ªÅn AirTime M_Service': 1, '2151 - Phi·∫øu mua h√†ng/Pre Order': 1, '971 - Th·∫ª c√†o ƒëi·ªán t·ª≠': 1, '431 - ·ªêp L∆∞ng - Flip Cover': 3.37, '2571 - Thu h·ªô c∆∞·ªõc Viettel': 1, '4519 - Thu H·ªô Ti·ªÅn Tr·∫£ G√≥p': 1, '2513 - Thu h·ªô Payoo': 1, '4302 - N√≥n b·∫£o hi·ªÉm c√°c lo·∫°i': 1.92, '2291 - Sim tr·∫Øng (Seri)': 1, '18 - ƒêi·ªán Tho·∫°i Di ƒê·ªông': 1, '4599 - Thu H·ªô Ti·ªÅn M·∫∑t': 1, '12 - Pin s·∫°c d·ª± ph√≤ng': 3.37, '571 - UDDƒê': 1, '58 - Mi·∫øng d√°n m·∫∑t sau': 3.37, '1231 - Mi·∫øng d√°n m·∫∑t tr∆∞·ªõc': 3.37, '1491 - Smartphone': 1, '1891 - Sim Online': 5.45, '4479 - D·ªãch V·ª• B·∫£o Hi·ªÉm': 4.18, '3359 - Ph·ª• ki·ªán ƒë·ªìng h·ªì': 3, '2391 - Smartwatch': 3, '911 - M√°y n∆∞·ªõc n√≥ng': 1, '4499 - Thu H·ªô Ph√≠ B·∫£o Hi·ªÉm': 4.18, '4142 - B√¨nh ƒëun si√™u t·ªëc': 1.85, '4153 - Xay Sinh t·ªë': 1.85, '15 - Tai nghe d√¢y': 3.37, '1412 - D·ªãch v·ª• b·∫£o tr√¨': 1, '3345 - C√°p': 3.37, '2312 - M√£ n·∫°p th·∫ª game': 1, '4900 - B√†n ph√≠m': 3.37, '4141 - B√†n ·ªßi kh√¥': 1.85, '4156 - N·ªìi c∆°m n·∫Øp g√†i/n·∫Øp r·ªùi': 1.85, '14 - S·∫°c/ Adapter': 3.37, '42 - Laptop': 1.2, '751 - Khuy·∫øn m√£i ba l√¥, t√∫i x√°ch': 1, '1031 - Loa di ƒë·ªông': 3.37, '4199 - Mi·∫øng D√°n K√≠nh': 3.37, '3346 - Tai Nghe Bluetooth': 3.37, '931 - M√°y t√≠nh b·∫£ng': 1.2, '19 - Khuy·∫øn m√£i ƒêTDƒê': 1, '10 - Chu·ªôt': 3.37, '4060 - ƒê·ªìng h·ªì Nam D√¢y da': 3, '880 - Loa Karaoke': 1.29, '851 - Khuy·∫øn m√£i ƒêi·ªán T·ª≠': 1, '4169 - L√µi l·ªçc': 1.85, '4540 - Tai Nghe Bluetooth - imei': 3.37, '4062 - ƒê·ªìng h·ªì N·ªØ D√¢y kim lo·∫°i': 3, '2831 - Ph·ª• ki·ªán Apple': 3.37, '2691 - B·ªô S·∫°c/C√°p/Adaptor (Gi√° R·∫ª)': 3.37, '1351 - Loa vi t√≠nh (imei)': 3.37, '1094 - Tivi LED (IMEI)': 1, '4324 - Khung treo, gi√° ƒë·ª°': 3.37, '1099 - M√°y gi·∫∑t (IMEI)': 1, '1097 - T·ªß l·∫°nh (IMEI)': 1, '4099 - N·ªìi chi√™n': 1.85, '4070 - ƒê·ªìng h·ªì Tr·∫ª em': 3, '967 - S·∫•y t√≥c': 1.85, '957 - L√≤ n∆∞·ªõng': 1.85, '958 - L√≤ vi s√≥ng': 1.85, '4158 - N·ªìi c∆°m ƒëi·ªán t·ª≠': 1.85, '3241 - Dao/K√©o/Th·ªõt': 1.92, '3240 - H·ªôp/H≈©': 1.92, '3265 - N·ªìi': 1.92, '4139 - ƒê√®n b√†n/ƒê√®n S·∫°c/ƒê√®n b·∫Øt mu·ªói': 1.85, '73 - Ph·ª• ki·ªán ƒëi·ªán m√°y': 3.37, '4171 - L·ªçc n∆∞·ªõc d·∫°ng t·ªß ƒë·ª©ng': 1.85, '3384 - ƒê·ªì ngh·ªÅ s·ª≠ d·ª•ng ƒëi·ªán': 1, '4147 - B·∫øp ƒëi·ªán ƒë∆°n': 1.85, '4063 - ƒê·ªìng h·ªì N·ªØ D√¢y da': 3, '3263 - Ch·∫£o': 1.92, '3185 - V·ªá sinh nh√† c·ª≠a': 1.92, '4143 - B√†n ·ªßi h∆°i n∆∞·ªõc ƒë·ª©ng': 1.85, '4146 - B·∫øp gas ƒë√¥i': 1.85, '1052 - Khuy·∫øn m√£i ƒêi·ªán L·∫°nh': 1, '3799 - Qu·∫°t ƒëi·ªÅu h√≤a': 1.85, '1951 - Software (s·ªë L∆∞·ª£ng)': 1, '6000 - M√°y √©p tr√°i c√¢y': 1.85, '4059 - ƒê·ªìng h·ªì Nam D√¢y kim lo·∫°i': 3, '4160 - Qu·∫°t b√†n/h·ªôp/s·∫°c': 1.85, '4162 - B√¨nh/Ca ƒë·ª±ng n∆∞·ªõc': 1.92, '4660 - Qu·∫°t l·ª≠ng': 1.85, '17 - Ph·ª• ki·ªán IT kh√°c': 3.37, '4145 - B·∫øp gas ƒë∆°n': 1.85, '875 - D√†n m√°y': 1, '1071 - Ph·ª• ki·ªán ƒëi·ªán t·ª≠': 3.37, '891 - Micro': 1, '4152 - ·ªî c·∫Øm ƒëi·ªán/v·ª£t mu·ªói': 1.85, '4154 - Xay √©p/Kh√°c': 1.85, '5975 - Balo T√∫i Ch·ªëng S·ªëc': 3.37, '893 - T·ªß ƒë√¥ng': 1, '2531 - Thu h·ªô Mservice': 1, '4019 - Sim tr·∫Øng ƒëi·ªán t·ª≠': 1, '4320 - ƒê·ªìng h·ªì - Khuy·∫øn m√£i mua': 1, '3187 - B√¨nh/Ly/Ca gi·ªØ nhi·ªát': 1.92, '4159 - Qu·∫°t ƒë·ª©ng': 1.85, '4157 - N·ªìi c∆°m cao t·∫ßn': 1.85, '16 - Th·∫ª Nh·ªõ': 3.37, '4140 - B√†n ·ªßi h∆°i n∆∞·ªõc': 1.85, '4150 - M√°y n∆∞·ªõc n√≥ng l·∫°nh': 1.85, '591 - Thay sim': 1, '2999 - D·ª•ng c·ª• nh√† b·∫øp kh√°c': 1.92, '4779 - Loa di ƒë·ªông - imei': 3.37, '4440 - G√≥i C∆∞·ªõc V√† D·ªãch V·ª• GTGT': 1, '4121 - M√°y B∆°m N∆∞·ªõc': 1, '4161 - Qu·∫°t treo': 1.85, '4961 - Qu·∫ßn b√≥ & legging n·ªØ Th·ªÉ Thao': 1, '4151 - √Åp su·∫•t/l·∫©u/chi√™n/n∆∞·ªõng': 1.85, '4144 - B·∫øp gas √¢m': 1.85, '871 - USB': 3.37, '6479 - Camera IP Trong nh√†': 3.37, '4219 - Camera IP Ngo√†i tr·ªùi': 3.37, '4659 - Ph·ª• ki·ªán ti·ªán √≠ch Apple': 3.37, '531 - Pin, 4095 - C√°p (Gi√° R·∫ª)': 3.37, '2791 - Kinh doanh m√πa v·ª•': 3.37, '2771 - Gi√° treo m√†n h√¨nh m√°y t√≠nh': 3.37, '80 - Khuy·∫øn m√£i Kh√°c': 1, '1131 - M√°y in, Fax': 2, '4125 - Smartband': 3, '743 - Qu·∫°t s∆∞·ªüi': 1.85, '4659 - Ph·ª• ki·ªán Apple - Imei': 3.37, '4064 - ƒê·ªìng h·ªì N·ªØ D√¢y kh√°c': 3, '956 - H√∫t b·ª•i': 1.85, '4172 - L·ªçc n∆∞·ªõc √¢m t·ªß/tr√™n b√†n': 1.85, '3779 - B·∫øp ƒëi·ªán √¢m': 1.85, '4061 - ƒê·ªìng h·ªì Nam D√¢y kh√°c': 3, '4067 - ƒê·ªìng h·ªì Unisex D√¢y kh√°c': 3, '1411 - D·ªãch v·ª• l·∫Øp ƒë·∫∑t': 1, '4149 - B√¨nh th·ªßy ƒëi·ªán': 1.85, '4148 - B·∫øp ƒëi·ªán ƒë√¥i': 1.85, '955 - H√∫t m√πi/ h√∫t kh√≥i': 1.85, '4699 - Gia d·ª•ng kh√¥ng ƒëi·ªán kh√°c': 1.92, '4859 - Xe ƒë·∫°p ƒë∆∞·ªùng ph·ªë c·ªï ƒëi·ªÉn': 1, '4759 - Ph·ª• Ki·ªán Xe ƒê·∫°p': 1, '2471 - Thu h·ªô c∆∞·ªõc VinaPhone': 1, '3719 - Qu·∫ßn d√†i n·ªØ Th·ªÉ Thao': 1, '1051 - Khuy·∫øn m√£i ƒêi·ªán gia d·ª•ng': 1, '3721 - Qu·∫ßn ng·∫Øn & v√°y n·ªØ Th·ªÉ Thao': 1, '410 - Ph·ª• ki·ªán TT kh√°c': 3.37, '4155 - H√∫t b·ª•i c√¢y': 1.85, '3563 - M√°y t√≠nh nguy√™n b·ªô': 1, '894 - T·ªß m√°t': 1, '3639 - M√°y l·ªçc kh√¥ng kh√≠': 1.85, '611 - ·ª®ng d·ª•ng PC & Laptop': 1, '4089 - ƒê·ªìng h·ªì Unisex D√¢y kim lo·∫°i': 3, '4439 - H√∫t B·ª•i Robot': 1.85, '3740 - √Åo T-shirt nam Th·ªÉ Thao': 1, '4339 - ·ªîn √Åp': 1, '4459 - Qu·∫°t Tr·∫ßn': 1.85, '2351 - Router - Imei': 3.37, '3159 - DV Internet v√† Truy·ªÅn h√¨nh thu ti·ªÅn': 1, '3659 - M√°y s·∫•y l·ªìng ngang': 1, '3519 - √Åo Bra Th·ªÉ Thao': 1, '3479 - Thi·∫øt b·ªã m·∫°ng kh√°c': 3.37, '3859 - M√°y r·ª≠a ch√©n': 1 }
        }
    };

// D√≤ng cu·ªëi c√πng n√†y r·∫•t quan tr·ªçng. N√≥ "xu·∫•t kh·∫©u" ƒë·ªëi t∆∞·ª£ng config 
// ƒë·ªÉ c√°c file JavaScript kh√°c c√≥ th·ªÉ "nh·∫≠p kh·∫©u" v√† s·ª≠ d·ª•ng.
export { config };

--- END FILE: ./config.js ---

--- START FILE: ./create_snapshot.js ---
// K·ªãch b·∫£n Node.js chuy√™n d·ª•ng ƒë·ªÉ t·∫°o snapshot to√†n di·ªán cho d·ª± √°n
// Phi√™n b·∫£n 1.1 - M·ªü r·ªông c√°c lo·∫°i file ƒë∆∞·ª£c h·ªó tr·ª£

const fs = require('fs');
const path = require('path');

// --- C·∫§U H√åNH ---
const config = {
    // Th∆∞ m·ª•c g·ªëc ƒë·ªÉ b·∫Øt ƒë·∫ßu qu√©t
    rootDirectory: '.', 
    // T√™n file output
    outputFile: 'project_snapshot.txt',
    // ====> THAY ƒê·ªîI QUAN TR·ªåNG <====
    // C√°c ƒëu√¥i file c·∫ßn l·∫•y n·ªôi dung. ƒê√£ b·ªï sung .json, .svg, .md
    includeExtensions: ['.js', '.html', '.css', '.txt', '.json', '.svg', '.md'],
    // C√°c th∆∞ m·ª•c c·∫ßn b·ªè qua
    excludeDirectories: ['node_modules', '.git', '.history'] 
};

// --- LOGIC CH√çNH ---

// H√†m ƒë·ªá quy ƒë·ªÉ duy·ªát qua c√°c th∆∞ m·ª•c
function walkDirectory(dir, filelist = []) {
    const files = fs.readdirSync(dir);
    files.forEach(file => {
        const filepath = path.join(dir, file);
        const stat = fs.statSync(filepath);

        // N·∫øu l√† th∆∞ m·ª•c v√† kh√¥ng n·∫±m trong danh s√°ch lo·∫°i tr·ª´ -> ti·∫øp t·ª•c duy·ªát
        if (stat.isDirectory() && !config.excludeDirectories.includes(file)) {
            filelist = walkDirectory(filepath, filelist);
        } 
        // N·∫øu l√† file v√† c√≥ ƒëu√¥i file n·∫±m trong danh s√°ch cho ph√©p -> th√™m v√†o danh s√°ch
        else if (stat.isFile() && config.includeExtensions.includes(path.extname(file))) {
            filelist.push(filepath);
        }
    });
    return filelist;
}

// H√†m ch√≠nh ƒë·ªÉ ch·∫°y k·ªãch b·∫£n
function createSnapshot() {
    console.log('B·∫Øt ƒë·∫ßu qu√° tr√¨nh t·∫°o snapshot (phi√™n b·∫£n n√¢ng cao)...');
    
    const allFiles = walkDirectory(config.rootDirectory);

    if (fs.existsSync(config.outputFile)) {
        fs.unlinkSync(config.outputFile);
    }

    allFiles.forEach(filepath => {
        try {
            const content = fs.readFileSync(filepath, 'utf8');
            // Chu·∫©n h√≥a ƒë∆∞·ªùng d·∫´n ƒë·ªÉ lu√¥n d√πng d·∫•u g·∫°ch ch√©o '/'
            const normalizedPath = path.normalize(filepath).replace(/\\/g, '/');
            const fileHeader = `--- START FILE: ./${normalizedPath} ---\n`;
            const fileFooter = `\n--- END FILE: ./${normalizedPath} ---\n\n`;
            
            fs.appendFileSync(config.outputFile, fileHeader);
            fs.appendFileSync(config.outputFile, content);
            fs.appendFileSync(config.outputFile, fileFooter);
        } catch (err) {
            console.error(`L·ªói khi ƒë·ªçc file ${filepath}:`, err);
        }
    });

    console.log(`\x1b[32m%s\x1b[0m`, `‚úÖ ƒê√£ t·∫°o th√†nh c√¥ng file '${config.outputFile}' v·ªõi ${allFiles.length} file.`);
}

// Ch·∫°y h√†m ch√≠nh
createSnapshot();
--- END FILE: ./create_snapshot.js ---

--- START FILE: ./dashboard.css ---
/* Version 6.6 - Compact SKNV detail view for better balance */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
    --global-font-size: 18px;
    --kpi-main-font-size: 36px;
    --bg-lightness-1: 98%; --header-lightness-1: 96%; --header-text-lightness-1: 25%; --special-header-lightness-1: 92%; --below-target-lightness-1: 96%;
    --bg-lightness-2: 96%; --header-lightness-2: 94%; --header-text-lightness-2: 22%; --special-header-lightness-2: 88%; --below-target-lightness-2: 94%;
    --bg-lightness-3: 94%; --header-lightness-3: 92%; --header-text-lightness-3: 18%; --special-header-lightness-3: 85%; --below-target-lightness-3: 92%; /* Normal */
    --bg-lightness-4: 92%; --header-lightness-4: 88%; --header-text-lightness-4: 15%; --special-header-lightness-4: 80%; --below-target-lightness-4: 88%;
    --bg-lightness-5: 90%; --header-lightness-5: 84%; --header-text-lightness-5: 12%; --special-header-lightness-5: 75%; --below-target-lightness-5: 84%;
    --bg-lightness-6: 88%; --header-lightness-6: 80%; --header-text-lightness-6: 10%; --special-header-lightness-6: 70%; --below-target-lightness-6: 80%;
    --kpi-card-1-bg: #38bdf8;
    --kpi-card-2-bg: #34d399; --kpi-card-3-bg: #fbbf24;
    --kpi-card-4-bg: #2dd4bf; --kpi-card-5-bg: #a78bfa; --kpi-card-6-bg: #f472b6;
    --kpi-card-7-bg: #818cf8;
    --kpi-card-8-bg: #f87171;
    --kpi-title-color: #ffffff;
    --kpi-main-color: #ffffff;
    --kpi-sub-color: #ffffff;
}

body {
    font-family: 'Inter', sans-serif;
    background-color: #f3f4f6;
    font-size: var(--global-font-size);
}

html[data-contrast="1"] { --bg-lightness: var(--bg-lightness-1); --header-lightness: var(--header-lightness-1); --header-text-lightness: var(--header-text-lightness-1); --special-header-lightness: var(--special-header-lightness-1); --below-target-lightness: var(--below-target-lightness-1); }
html[data-contrast="2"] { --bg-lightness: var(--bg-lightness-2); --header-lightness: var(--header-lightness-2); --header-text-lightness: var(--header-text-lightness-2); --special-header-lightness: var(--special-header-lightness-2); --below-target-lightness: var(--below-target-lightness-2); }
html[data-contrast="3"] { --bg-lightness: var(--bg-lightness-3); --header-lightness: var(--header-lightness-3); --header-text-lightness: var(--header-text-lightness-3); --special-header-lightness: var(--special-header-lightness-3); --below-target-lightness: var(--below-target-lightness-3); }
html[data-contrast="4"] { --bg-lightness: var(--bg-lightness-4); --header-lightness: var(--header-lightness-4); --header-text-lightness: var(--header-text-lightness-4); --special-header-lightness: var(--special-header-lightness-4); --below-target-lightness: var(--below-target-lightness-4); }
html[data-contrast="5"] { --bg-lightness: var(--bg-lightness-5); --header-lightness: var(--header-lightness-5); --header-text-lightness: var(--header-text-lightness-5); --special-header-lightness: var(--special-header-lightness-5); --below-target-lightness: var(--below-target-lightness-5); }
html[data-contrast="6"] { --bg-lightness: var(--bg-lightness-6); --header-lightness: var(--header-lightness-6); --header-text-lightness: var(--header-text-lightness-6); --special-header-lightness: var(--special-header-lightness-6); --below-target-lightness: var(--below-target-lightness-6); }


::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: #555; }

#sidebar { width: 68px; transition: width 0.3s ease-in-out; overflow-x: hidden; }
#sidebar:hover { width: 256px; }
#sidebar.menu-locked:hover { width: 68px; }

#sidebar .nav-link, #sidebar button {
    white-space: nowrap;
    gap: 1rem;
    justify-content: flex-start; /* FIX: Canh l·ªÅ tr√°i cho icon v√† text */
}

.menu-text {
    transition: opacity 0.2s ease-in-out, width 0.3s ease-in-out;
    opacity: 0;
    white-space: nowrap;
    width: 0;
    overflow: hidden;
}
#sidebar:hover .menu-text {
    opacity: 1;
    transition-delay: 0.1s;
    width: auto;
}
#sidebar.menu-locked:hover .menu-text {
    opacity: 0;
    width: 0;
}

#main-content { transition: margin-left 0.3s ease-in-out; margin-left: 68px; }

.nav-link,
.action-btn,
.kpi-card,
.content-card,
.tdv-item-card,
.data-input-group,
.toggle-filters-btn,
.page-header__help-btn,
.column-toggle-btn {
    transition: all 0.2s ease-in-out;
}

/* === B·∫ÆT ƒê·∫¶U: N√ÇNG C·∫§P UI CHO SUB-TAB (V5.9) === */
.sub-tab-btn {
    border-bottom: 3px solid transparent;
    padding: 0.75rem 0.5rem;
    transition: all 0.2s ease-in-out;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}
.sub-tab-btn:not(.active):hover {
    background-color: #f3f4f6;
    border-bottom-color: #d1d5db;
    transform: translateY(-2px);
}
.sub-tab-btn.active {
    border-color: #3b82f6;
    color: #2563eb;
    background-color: transparent;
}
.sub-tab-btn .feather {
    width: 1.2rem;
    height: 1.2rem;
    stroke-width: 2.5;
    transition: all 0.2s ease-in-out;
}
.sub-tab-btn.active .feather {
    color: white;
    background-color: #3b82f6;
    border-radius: 9999px;
    padding: 4px;
}
/* T√¥ m√†u icon theo t·ª´ng tab */
.sub-tab-btn[data-title*="SieuThi"].active .feather,
.sub-tab-btn[data-title*="Vung"].active .feather { background-color: #3b82f6; } /* Blue */

.sub-tab-btn[data-title*="SKNV"].active .feather,
.sub-tab-btn[data-title*="ThuNhap"].active .feather,
.sub-tab-btn[data-title*="DoanhThuLK"].active .feather,
.sub-tab-btn[data-title*="DTNVRealtime"].active .feather { background-color: #16a34a; } /* Green */

.sub-tab-btn[data-title*="ThiDua"].active .feather { background-color: #8b5cf6; } /* Violet */

.sub-tab-btn[data-title*="HieuQua"].active .feather,
.sub-tab-btn[data-title*="NganhHang"].active .feather,
.sub-tab-btn[data-title*="HangRealtime"].active .feather { background-color: #f97316; } /* Orange */
/* === K·∫æT TH√öC: N√ÇNG C·∫§P UI CHO SUB-TAB === */


.nav-link:hover,
.action-btn:hover,
.kpi-card:hover,
.content-card:hover,
.data-input-group:hover,
.toggle-filters-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.tdv-item-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}
.page-header__help-btn:hover {
    transform: scale(1.1) translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.settings-drawer { width: 400px; max-width: 90vw; transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
.settings-drawer.open { transform: translateX(0); }
.close-drawer-btn { font-size: 2rem; line-height: 1; }
input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #e5e7eb; border-radius: 5px; outline: none; transition: background 0.2s; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }

.page-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
.page-header__title { font-size: 1.75rem; font-weight: 700; color: #1f2937; }
.content-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); padding: 1rem 1.5rem; margin-bottom: 2rem; border: 1px solid #e5e7eb; }
.content-card__header { display: flex; align-items: center; justify-content: space-between; font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; }

#notification { position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; z-index: 1200; opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(100px); }
#notification.show { opacity: 1; transform: translateY(0); }
.notification-success { background-color: #28a745; }
.notification-error { background-color: #dc3545; }
.placeholder-message { border: 2px dashed #f59e0b; background-color: #fffbeb; color: #b45309; padding: 2rem; border-radius: 0.75rem; text-align: center; font-weight: 600; }

[id$='-subtabs-nav'] { flex-wrap: wrap; }
.sortable { cursor: pointer; position: relative; user-select: none; }
.sort-indicator { display: inline-flex; flex-direction: column; align-items: center; justify-content: center; width: 1em; height: 1em; margin-left: 4px; vertical-align: middle; color: #9ca3af; transition: color 0.2s ease-in-out; }
.sortable .sort-indicator::before { content: '‚ñ≤'; font-size: 0.8em; line-height: 0.5; opacity: 0.4; }
.sortable .sort-indicator::after { content: '‚ñº'; font-size: 0.8em; line-height: 0.5; opacity: 0.4; }
.sortable:hover .sort-indicator { color: #374151; }
.sortable.sorted-asc .sort-indicator::before { opacity: 1; color: #3b82f6; }
.sortable.sorted-asc .sort-indicator::after { opacity: 0.4; }
.sortable.sorted-desc .sort-indicator::after { opacity: 1; color: #3b82f6; }
.sortable.sorted-desc .sort-indicator::before { opacity: 0.4; }

.data-input-group {
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem;
    background-color: #f9fafb;
    display: flex;
    flex-direction: column;
    border-top: 4px solid #9ca3af;
}

#data-section > .content-card:nth-of-type(1) .data-input-group { border-top-color: #3b82f6; }
#data-section > .content-card:nth-of-type(3) .data-input-group { border-top-color: #8b5cf6; }
.data-input-group__label { font-weight: 600; color: #4b5563; margin-bottom: 0.75rem; }
.data-input-group__label--link { text-decoration: none; display: inline-block; }
.data-input-group__label--link:hover { text-decoration: underline; color: #2563eb; }
.data-input-group__label--link > .font-normal { font-weight: 400; }
.data-input-group__content { display: flex; flex-direction: column; gap: 0.5rem; flex-grow: 1; }
.data-input-group__file-trigger { cursor: pointer; background-color: #e5e7eb; color: #374151; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875em; font-weight: 500; white-space: nowrap; }
.data-input-group__file-trigger:hover { background-color: #d1d5db; }
.data-input-group__file-name { font-size: 0.875em; color: #6b7280; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.data-input-group__link { color: #2563eb; text-decoration: none; font-size: 0.875em; }
.data-input-group__link:hover { text-decoration: underline; }
.data-input-group__status-wrapper { min-height: 1rem; margin-top: 0.25rem; }
.data-input-group__status-text { font-size: 0.875em; font-weight: 500; }
.data-input-group__status-text--default { color: #6b7280;
}
.data-input-group__status-text--success { color: #16a34a; }
.data-input-group__status-text--error { color: #dc2626; }
.data-textarea { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875em; font-family: 'Inter', sans-serif; }
.data-textarea:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: #3b82f6; box-shadow: 0 0 0 1px #3b82f6; }
.progress-bar-container { overflow: hidden; }
.progress-bar { background-image: linear-gradient(45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent); background-size: 1rem 1rem; animation: progress-bar-stripes 1s linear infinite; }
@keyframes progress-bar-stripes { from { background-position: 1rem 0; } to { background-position: 0 0; } }

.table-bordered { border-collapse: collapse; }
.table-bordered th, .table-bordered td { border: 1px solid #e5e7eb; }
.table-striped tbody tr:nth-child(even) { background-color: #f9fafb; }
.table-footer { background-color: hsl(210, 20%, var(--header-lightness));
border-top: 2px solid #9ca3af; }
.cell-performance.is-below { background-color: hsl(0, 80%, var(--below-target-lightness)) !important; }
.header-bg-blue { background-color: hsl(217, 95%, var(--special-header-lightness)) !important; color: hsl(217, 80%, var(--header-text-lightness)) !important; }
.header-bg-green { background-color: hsl(145, 80%, var(--special-header-lightness)) !important; color: hsl(145, 70%, var(--header-text-lightness)) !important; }
.header-bg-yellow { background-color: hsl(45, 95%, var(--special-header-lightness)) !important; color: hsl(45, 80%, var(--header-text-lightness)) !important; }

.interactive-row {
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    cursor: pointer; /* Ensure interactive rows are clickable */
}
.interactive-row:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    background-color: #eff6ff;
}
.interactive-row .employee-name-cell {
    cursor: pointer;
    color: #2563eb;
    transition: color 0.2s ease-out;
}
.interactive-row:hover .employee-name-cell {
    text-decoration: underline;
    color: #1d4ed8;
}

.header-group-1 { background-color: hsl(30, 90%, var(--header-lightness)); }
.header-group-2 { background-color: hsl(90, 90%, var(--header-lightness)); }
.header-group-3 { background-color: hsl(180, 90%, var(--header-lightness)); }
.header-group-4 { background-color: hsl(240, 90%, var(--header-lightness)); }
.header-group-5 { background-color: hsl(300, 90%, var(--header-lightness)); }
.header-group-6 { background-color: hsl(0, 90%, var(--header-lightness)); }
.header-group-7 { background-color: hsl(160, 80%, var(--header-lightness)) !important; }
.header-group-8 { background-color: hsl(280, 80%, var(--header-lightness)) !important; }
.header-group-9 { background-color: hsl(70, 80%, var(--header-lightness)) !important; }
.header-group-10 { background-color: hsl(190, 80%, var(--header-lightness)) !important; }
.header-group-11 { background-color: hsl(340, 80%, var(--header-lightness)) !important; }
.header-group-12 { background-color: hsl(20, 80%, var(--header-lightness)) !important; }

.income-positive { color: #16a34a; }
.income-negative { color: #dc2626; }
.line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.department-header-tv { background-color: #e0e7ff;
color: #3730a3; }
.department-header-kho { background-color: #d1fae5; color: #065f46; }
.department-header-tt { background-color: #fef3c7; color: #92400e; }
.category-header-ict { background-color: #dbeafe; color: #1e40af; }
.category-header-phukien { background-color: #fee2e2; color: #991b1b; }
.category-header-giadung { background-color: #fef9c3; color: #854d0e; }
.category-header-ce { background-color: #e0f2fe; color: #0c4a6e; }
.category-header-baohiem { background-color: #f3e8ff; color: #6b21a8; }
.header-bg-indigo { background-color: #e0e7ff; color: #3730a3; }
.header-bg-purple { background-color: #f3e8ff; color: #6b21a8; }
.qdc-group-title { font-weight: 600; }
.qdc-group-ict { background-color: hsl(190, 80%, var(--special-header-lightness)); }
.qdc-group-vas { background-color: hsl(140, 80%, var(--special-header-lightness)); }
.qdc-group-giadung { background-color: hsl(0, 80%, var(--special-header-lightness)); }
.qdc-group-sim { background-color: hsl(40, 80%, var(--special-header-lightness)); }
.competition-header-doanhthu { border-color: #a78bfa; background-color: hsl(260, 90%, var(--bg-lightness)); }
.competition-header-soluong { border-color: #facc15; background-color: hsl(50, 90%, var(--bg-lightness)); }
.header-highlight-special { background-color: hsl(25, 90%, var(--header-lightness)) !important; }
.competition-row-below-100 td { background-color: #fee2e2; color: #991b1b; }

.header-highlight { background-color: hsl(50, 95%,
var(--special-header-lightness)) !important; }

#dtnv-realtime-employee-selector-container .choices__inner { min-width: 300px; }
#dtnv-realtime-employee-selector-container .choices__list--single { min-width: 300px; }

.kpi-card-title { color: var(--kpi-title-color); opacity: 0.8; font-size: 1em; }
.kpi-card p[id$="-main"] { color: var(--kpi-main-color); font-size: var(--kpi-main-font-size);
transition: font-size 0.2s ease-in-out; }
.kpi-card p[id$="-sub"], .kpi-card p[id$="-sub1"], .kpi-card p[id$="-sub2"] { color: var(--kpi-sub-color); font-size: 1em; }

.kpi-percentage, .kpi-percentage-value { font-weight: 700; }
.kpi-sub-value { opacity: 0.9; }
#luyke-kpi-cards-container .kpi-card:nth-child(1), #realtime-kpi-cards-container .kpi-card:nth-child(1) { background-color: var(--kpi-card-1-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(2), #realtime-kpi-cards-container .kpi-card:nth-child(2) { background-color: var(--kpi-card-2-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(3), #realtime-kpi-cards-container .kpi-card:nth-child(3) { background-color: var(--kpi-card-3-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(4), #realtime-kpi-cards-container .kpi-card:nth-child(4) { background-color: var(--kpi-card-4-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(5) { background-color: var(--kpi-card-5-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(6) { background-color: var(--kpi-card-6-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(7) { background-color: var(--kpi-card-7-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(8) { background-color: var(--kpi-card-8-bg); }

#sknv-details-container .sknv-subtable-header th { font-size: 0.875em; font-weight: 600; background-color: #f3f4f6; }
.choices__inner { min-height: 42px; }
.choices__list--multiple .choices__item { background-color: #3b82f6; border-color:
#2563eb; }
.toggle-filters-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; background-color: #f3f4f6; color: #4b5563; font-weight: 500; font-size: 0.875em; cursor: pointer; margin-bottom: 1rem; border: 1px solid #e5e7eb; }
.toggle-filters-btn .icon { width: 1rem; height: 1rem; transition: transform 0.3s ease-in-out; }
.toggle-filters-btn.active .icon { transform: rotate(180deg); }
.highlight-trigger { background: none; border: none; cursor: pointer; color: #6b7280; }
.highlight-trigger:hover { color: #1d4ed8; }
.highlighted-row td { animation: pulse-bg 2s infinite; }
@keyframes pulse-bg { 0% { background-color: var(--highlight-color, #ffff99); } 50% { background-color: var(--highlight-color-light, #ffffcc); } 100% { background-color: var(--highlight-color, #ffff99); } }

.action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 500;
    font-size: 0.875em;
    cursor: pointer;
    border: 1px solid transparent;
}
.action-btn--composer {
background-color: #ede9fe; color: #5b21b6; border-color: #c4b5fd; }
.action-btn--composer:hover { background-color: #d8b4fe; }
.action-btn--export { background-color: #dcfce7; color: #166534; border-color: #86efac; }
.action-btn--export:hover { background-color: #bbf7d0; }
.action-btn--capture { background-color: #dbeafe; color: #1e40af; border-color: #93c5fd; }
.action-btn--capture:hover { background-color: #bfdbfe; }
.action-btn--save { background-color: #16a34a; color: white; }
.action-btn--save:hover { background-color: #15803d; }
.action-btn--copy { background-color: #2563eb; color: white; }
.action-btn--copy:hover { background-color: #1d4ed8; }
.page-header__help-btn { background-color: #fee2e2; color: #991b1b; border-radius: 9999px; width: 2rem; height: 2rem; display: inline-flex; align-items: center; justify-content: center; border: none; }

.modal { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
.modal.hidden { display: none; }
.modal__overlay { position: absolute; inset: 0; background-color: rgba(17, 24, 39, 0.6); backdrop-filter: blur(4px); cursor: pointer; }
.modal__container { position: relative; z-index: 1001; background-color: white; border-radius: 0.75rem; box-shadow: 0 20px
25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); width: 90%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; }

#force-update-modal .modal__overlay { cursor: not-allowed; }

.modal__container--large { max-width: 900px; }
.modal__header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
.modal__title { font-size: 1.25rem; font-weight: 600; color: #1f2937; }
.modal__close-btn { font-size: 1.75rem; line-height: 1; color: #6b7280; background: none; border: none; cursor: pointer; }
.modal__close-btn:hover { color: #111827; }
.modal__content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
.modal__content h4 { font-size: 1.125rem; font-weight: 600; color: #1e3a8a; margin-bottom: 0.75rem; }
.modal__content p { margin-bottom: 0.75rem; color: #374151; line-height: 1.6; }
.modal__content ul { list-style-type: disc; list-style-position: inside; margin-left: 0.5rem; }
.modal__content ul > *
+ * { margin-top: 0.5rem; }
.modal__footer { padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; background-color: #f9fafb; display: flex; justify-content: flex-end; gap: 0.75rem; flex-shrink: 0; }

.composer { display: flex; flex-direction: column; gap: 1.5rem; }
.composer__editor { flex-grow: 1; }
.composer__tags { width: 100%; }
.composer__label { display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
.composer__textarea { width: 100%; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.875em; resize: vertical; }
.composer__textarea:focus { border-color: #3b82f6; box-shadow: 0 0 0 1px #3b82f6; outline: none; }
.composer__nav { display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 1rem; }
.composer__tab-btn { padding: 0.5rem 1rem; border: none; background-color: transparent; cursor: pointer; font-weight: 500; color: #6b7280; border-bottom: 2px solid transparent; margin-bottom: -1px; font-size: 0.875em; }
.composer__tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; }
.composer__tab-pane {
display: none; }
.composer__tab-pane.active { display: block; }
.composer__tag-group { margin-bottom: 1rem; }
.composer__tag-group:last-child { margin-bottom: 0; }
.composer__tag-group-title { font-weight: 600; font-size: 0.875em; color: #4b5563; margin-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; }
.composer__tag-btn { background-color: #e0e7ff; color: #3730a3; border: 1px solid #c7d2fe; border-radius: 9999px; padding: 0.25rem 0.75rem; font-size: 0.8rem; font-weight: 500; cursor: pointer; margin: 0.25rem; }
.composer__icon-btn { background-color: #f3f4f6; color: #1f2937; border: 1px solid #d1d5db; border-radius: 9999px; padding: 0.25rem 0.75rem; font-size: 1.1rem; font-weight: 500; cursor: pointer; margin: 0.25rem; line-height: 1; }
.composer__filter-group { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; }
.composer__select { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: white; }
@media (min-width: 768px) { .composer { flex-direction: row; } .composer__tags { width: 350px; flex-shrink: 0; border-left: 1px
solid #e5e7eb; padding-left: 1.5rem; } }

.view-switcher { display: flex; align-items: center; padding: 0.25rem; background-color: #e5e7eb; border-radius: 0.5rem; }
.view-switcher__btn { padding: 0.5rem 1rem; border: none; background-color: transparent; border-radius: 0.375rem; font-weight: 500; color: #4b5563; cursor: pointer; }
.view-switcher__btn.active { background-color: white; color: #3b82f6; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }
.infographic-card { border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
.infographic-card__header { padding: 0.75rem 1rem; font-weight: 700; }
.infographic-card__header--completed { background-color: #dcfce7; color: #166534; }
.infographic-card__header--pending { background-color: #fee2e2; color: #991b1b; }
.infographic-card__body { padding: 1rem; background-color: #f9fafb; }
.infographic-card__item { border-bottom: 1px dashed #d1d5db; padding: 0.75rem 0; }
.infographic-card__item:last-child { border-bottom: none; }
.infographic-card__title { font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; }
.infographic-card__metrics { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.5rem 1rem; font-size:
0.875em; }
.metric-label { color: #6b7280; }
.metric-value { font-weight: 600; color: #111827; text-align: right; }
.metric-value.is-negative { color: #ef4444; }
.metric-value.is-positive { color: #22c55e; }

.rt-infographic-container { background-color: #f9fafb; border-radius: 0.75rem; border: 1px solid #e5e7eb; padding: 1.5rem; }
.rt-infographic-header .employee-name { font-size: 1.5rem; font-weight: 800; color: #111827; }
.rt-infographic-header .employee-title { font-size: 1rem; font-weight: 500; color: #6b7280; }
.rt-infographic-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
.rt-infographic-summary-card { background-color: white; border-radius: 0.5rem; padding: 1rem; text-align: center; border: 1px solid #e5e7eb; }
.rt-infographic-summary-card .label { font-size: 0.875em; color: #4b5563; font-weight: 500; }
.rt-infographic-summary-card .value { font-size: 1.75rem; font-weight: 700; color: #3b82f6; margin-top: 0.25rem; }
.rt-infographic-summary-card .value.is-positive { color: #2563eb; }
.rt-infographic-summary-card .value.is-negative { color: #dc2626; }
.rt-infographic-grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 1.5rem; margin-top: 1.5rem; }
@media
(min-width: 1024px) { .rt-infographic-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
.rt-infographic-section h4 { font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem; }
.rt-progress-bar-item { margin-bottom: 0.75rem; }
.rt-progress-bar-label { display: flex; justify-content: space-between; font-size: 0.875em; font-weight: 500; margin-bottom: 0.25rem; }
.rt-progress-bar-container { background-color: #e5e7eb; border-radius: 9999px; height: 0.75rem; overflow: hidden; }
.rt-progress-bar { background-color: #22c55e; height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }
.rt-customer-accordion { max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; }
.rt-customer-header { background-color: white; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; list-style: none; }
.rt-customer-header::-webkit-details-marker { display: none; }
.rt-customer-header:hover { background-color: #f9fafb; }
.rt-customer-header .arrow { transition: transform 0.3s; }
.rt-customer-header .product-count { color: #dc2626; font-weight: bold; }
details[open] > summary
.arrow { transform: rotate(180deg); }
.rt-customer-details { background-color: #f9fafb; padding: 1rem; }
.rt-customer-details table { font-size: 0.8rem; }
.preview-content { background-color: #f3f4f6; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap; word-wrap: break-word; font-size: 0.875em; line-height: 1.6; color: #1f2937; font-family: 'Inter', sans-serif; }

/* === B·∫ÆT ƒê·∫¶U: B·ªê C·ª§C CHO THI ƒêUA V√ôNG & THI ƒêUA L≈®Y K·∫æ (V5.9) === */
.tdv-rows-container { display: flex; flex-direction: column; gap: 1.5rem; }
#subtab-luyke-thi-dua .tdv-row-body {
    display: grid;
    grid-template-columns: 1fr; /* M·∫∑c ƒë·ªãnh 1 c·ªôt cho mobile */
    gap: 1rem;
}
@media (min-width: 768px) { /* 2 c·ªôt cho tablet tr·ªü l√™n */
    #subtab-luyke-thi-dua .tdv-row-body {
        grid-template-columns: repeat(2, 1fr);
    }
}
/* === END: B·ªê C·ª§C M·ªöI === */

.tdv-infographic-card {
    background-color: transparent;
    border: none;
    box-shadow: none;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.tdv-header { text-align: center; margin-bottom: 2rem; }
.tdv-supermarket-name { font-size: 2em; font-weight: bold; color: #005f73; }
.tdv-total-prize-container { margin-top: 0.5rem; font-size: 1.5em; font-weight: bold; }
.tdv-total-prize-label { color: #6b7280; font-weight: normal; }
.tdv-total-prize-value { color: #d90429; margin-left: 0.5rem; }

.tdv-summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1.5rem; margin-bottom: 2rem; }
@media (min-width: 768px) { .tdv-summary-grid { grid-template-columns: repeat(5, 1fr); } }
.tdv-summary-item { background-color: #ffffff; border-radius: 8px;
padding: 1rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; }
.tdv-summary-value { display: block; font-size: 1.75em; font-weight: 700; color: #0a9396; }
.tdv-summary-label { display: block; font-size: 0.9em; color: #4a5568; margin-top: 0.25rem; }

.tdv-row { background-color: #fdfdfd; border-radius: 8px; padding: 1rem; border: 1px solid #dee2e6; }
.tdv-row-title { font-size: 1.2em; font-weight: bold; padding-bottom: 0.75rem; margin-bottom: 1rem; border-bottom: 2px solid; line-height: 1.3; }
.tdv-row-title--prize { border-color: #0d6efd; color: #0d6efd; }
.tdv-row-title--soon-prize { border-color: #e9c46a; color: #e9c46a; }
.tdv-row-title--effort { border-color: #6c757d; color: #6c757d; }
.tdv-row-subtitle { font-size: 0.8em; font-weight: normal; color: #d90429; }

#subtab-thidua-vung .tdv-row-body { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; }
.tdv-row-body--effort { display: block; }

.tdv-item-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 6px;
padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; }
.tdv-item-card__title { font-weight: bold; margin: 0 0 10px 0; color: #333; }
.tdv-progress-bar-container {
    width: 100%;
    background-color: #e9ecef;
    border-radius: 20px;
    height: 28px;
    position: relative;
    font-size: 0.85em;
    font-weight: bold;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
}
.tdv-progress-bar { height: 100%; transition: width 0.5s ease; position: absolute; top: 0; left: 0; }
.tdv-progress-bar--blue { background-color: #0d6efd; }
.tdv-progress-bar--yellow { background-color: #e9c46a; }
.tdv-progress-bar__text {
    position: relative;
    z-index: 1;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
    color: white;
}
.tdv-item-card__details { font-size: 0.85em; color: #555; margin-top: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
.tdv-item-card__details span { display: block; }
.tdv-item-card__details strong { color: #000; }
.tdv-item-card__prize { grid-column: 1 / -1; font-weight:
bold !important; color: #d90429; margin-top: 4px; }

.tdv-effort-subgroup { margin-bottom: 1rem; }
.tdv-effort-subgroup:last-child { margin-bottom: 0; }
.tdv-effort-subgroup__title { font-weight: bold; margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #dee2e6; }
.tdv-effort-subgroup__title--potential { color: #fd7e14; }
.tdv-effort-subgroup__title--major { color: #6c757d; }
.tdv-effort-list { display: flex; flex-wrap: wrap; gap: 8px; }
.tdv-effort-item { background-color: #f1f3f5; color: #495057; padding: 5px 10px; border-radius: 15px; font-size: 0.9em; }

#video-container iframe {
    aspect-ratio: 16 / 9;
    width: 100%;
    height: auto;
    border-radius: 0.5rem;
}

#feedback-list-container {
    max-height: 600px;
    overflow-y: auto;
}
#goal-drawer .choices__inner {
    min-width: 250px;
}

#goal-drawer .choices__list--dropdown,
#goal-drawer .choices__list[aria-expanded] {
    min-width: 100%;
    width: auto;
    word-break: normal;
}

#goal-drawer .choices__list--multiple .choices__item {
    display: inline-flex;
    align-items: center;
    background-color: #3b82f6;
    border: 1px
solid #2563eb;
    color: white;
    border-radius: 9999px;
    padding: 2px 8px;
    font-size: 0.8em;
    font-weight: 500;
    margin: 2px 4px 2px 0;
}
#goal-drawer .choices__inner {
    height: auto !important;
    min-height: 42px !important;
    display: flex !important;
    flex-wrap: wrap !important;
}
.header-qr-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  border: 2px solid #ef4444; /* red-500 */
  padding: 4px;
  border-radius: 8px;
  background-color: white;
}
.header-qr-container span {
  font-size: 0.75rem; /* 12px */
  font-weight: 600;
  color: #b91c1c; /* red-700 */
}
.header-qr-image {
  width: 50px;
  height: 50px;
  background-color: #f3f4f6;
  border-radius: 4px;
}
.selection-item {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out;
}
.selection-item:hover {
    background-color: #f3f4f6; /* gray-100 */
}
.selection-item input[type="checkbox"] {
    width: 1rem;
    height: 1rem;
    margin-right: 0.75rem;
}
.selection-item label {
    flex-grow: 1;
    cursor: pointer;
}
.settings-trigger-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: #9ca3af; /* gray-400 */
    transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
    padding: 2px;
}
.settings-trigger-btn:hover {
    color: #3b82f6; /* blue-500 */
    transform: rotate(45deg);
}
.settings-trigger-btn svg {
    width: 18px;
    height: 18px;
    display: block;
}

#version-marquee-container {
    flex-grow: 1;
    margin: 0 1.5rem;
    overflow: hidden;
    position: relative;
    background-color: #eef2ff;
    border: 1px solid #c7d2fe;
    border-radius: 9999px;
    cursor: pointer;
    height: 38px;
}
#version-marquee-container:hover .marquee-text {
    animation-play-state: paused;
    color: #312e81;
}
.marquee-text {
    position: absolute;
    white-space: nowrap;
    will-change: transform;
    animation: marquee-scroll 25s linear infinite;
    font-weight: 600;
    color: #4338ca;
    line-height: 36px;
}
@keyframes marquee-scroll {
    from {
        transform: translateX(100%);
    }
    to {
        transform: translateX(-100%);
    }
}

.competition-summary-counter strong {
    font-size: 1.15rem !important;
    font-weight: 800 !important;
    white-space: nowrap;
}
.competition-summary-counter .text-blue-600 {
    color: #2563eb !important;
}
.competition-summary-counter .text-red-600 {
    color: #dc2626 !important;
}

.column-toggle-btn {
    padding: 4px 12px;
    font-size: 12px;
    font-weight: 500;
    border: 1px solid;
    border-radius: 9999px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    user-select: none;
}

.column-toggle-btn.active {
    background-color: #3b82f6; /* blue-500 */
    color: white;
    border-color: #3b82f6;
}

.column-toggle-btn:not(.active) {
    background-color: #e5e7eb; /* gray-200 */
    color: #374151; /* gray-700 */
    border-color: #d1d5db; /* gray-300 */
}

.column-toggle-btn:not(.active):hover {
    background-color: #d1d5db; /* gray-300 */
}

.draggable-header {
    cursor: move;
    cursor: grab;
}
.draggable-header:active {
    cursor: grabbing;
}
.sortable-ghost {
    opacity: 0.4;
    background-color: #c7d2fe; /* indigo-200 */
}

.column-toggle-btn.draggable-tag {
    cursor: grab;
}
.column-toggle-btn.draggable-tag:active {
    cursor: grabbing;
}
.column-toggle-btn.draggable-tag:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.drag-handle-icon {
    color: #6b7280;
    transition: color 0.2s ease-in-out;
}
.column-toggle-btn.draggable-tag:hover .drag-handle-icon {
    color: #1f2937;
}
.sortable-drag {
    opacity: 0.95;
    transform: rotate(-2deg);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}

.action-btn,
.nav-link,
.view-switcher__btn,
.toggle-filters-btn,
.page-header__help-btn
{
    display: inline-flex;
    align-items: center;
    /* justify-content: center; */ /* B·ªã lo·∫°i b·ªè ƒë·ªÉ s·ª≠a l·ªói sidebar */
    gap: 0.5rem;
}

.feather {
    width: 1.1rem;
    height: 1.1rem;
    stroke-width: 1.5;
    flex-shrink: 0;
}

#sidebar .feather {
    width: 1.5rem;
    height: 1.5rem;
    stroke-width: 2;
}

.page-header__help-btn .feather {
    width: 1.25rem;
    height: 1.25rem;
}

.luyke-detail-header h3 {
    font-size: 1.75rem; font-weight: 800; color: #111827; text-align: center;
}
.luyke-detail-progress-item {
    display: flex; flex-direction: column; gap: 4px;
}
.luyke-detail-progress-label {
    display: flex; justify-content: space-between; align-items: baseline; font-size: 0.875rem;
}
.luyke-detail-progress-values {
    display: flex; justify-content: space-between; font-size: 0.75rem; color: #4b5563;
}
.luyke-detail-chart-container {
    position: relative; height: 350px; width: 100%;
}
.customer-accordion-luyke summary {
    display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; padding: 0.5rem 1rem; cursor: pointer; list-style: none;
}
.customer-accordion-luyke summary:hover {
    background-color: #f9fafb;
}
.customer-accordion-luyke .customer-name-small {
    font-weight: 600; font-size: 0.9rem; color: #1f2937; flex-grow:
1; min-width: 120px;
}
.customer-accordion-luyke .order-metrics {
    display: flex; align-items: center; gap: 1rem; flex-shrink: 0; font-size: 0.75rem;
}
.customer-accordion-luyke .order-metrics span {
    white-space: nowrap;
}
.customer-accordion-luyke .accordion-arrow {
    margin-left: auto; color: #9ca3af; transition: transform 0.2s ease-in-out;
}
.customer-accordion-luyke details[open] > summary .accordion-arrow {
    transform: rotate(180deg);
}
.customer-accordion-luyke .product-list-scrollable {
    display: block;
    max-height: 200px;
    overflow-y: auto;
}
.customer-accordion-luyke .product-list-table {
    width: 100%;
}
.customer-accordion-luyke .qd-below-target { color: #b91c1c; }
.customer-accordion-luyke .qd-above-target { color: #1d4ed8; }

/* === START: SKNV INFOGRAPHIC CARD STYLES (V6.0) === */
.sknv-summary-grid {
    display: grid;
    grid-template-columns: 1fr; /* Default to 1 column for mobile */
    gap: 1.5rem;
}

@media (min-width: 768px) { /* 2 columns for tablets */
    .sknv-summary-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 1280px) { /* 4 columns for large desktops */
    .sknv-summary-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

.sknv-card {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 1rem; /* UPDATED: Compact padding */
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* UPDATED: Softer shadow */
    display: flex;
    flex-direction: column;
    gap: 0.75rem; /* UPDATED: Reduced gap */
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    cursor: pointer;
    position: relative; /* Added for medal positioning */
}
.sknv-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
}

.sknv-card__header {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.sknv-card__avatar {
    width: 48px;
    height: 48px;
    border-radius: 9999px;
    background-color: #eef2ff;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.sknv-card__avatar svg {
    width: 24px;
    height: 24px;
    color: #4338ca;
}

.sknv-card__info {
    flex-grow: 1;
    min-width: 0;
}
.sknv-card__info .name {
    font-weight: 700;
    color: #111827;
    line-height: 1.25;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
}

.sknv-card__info .id {
    font-size: 0.875rem;
    color: #6b7280;
}

.sknv-card__main-kpi {
    text-align: center;
    margin: 0.25rem 0; /* UPDATED: Reduced margin */
}

.sknv-card__main-kpi .value {
    font-size: 2.5rem; /* UPDATED: Reduced font size */
    font-weight: 800;
    line-height: 1;
    color: #4b5563;
}

.sknv-card__main-kpi .total {
    font-size: 1.25rem; /* UPDATED */
    font-weight: 600;
    color: #9ca3af;
}

.sknv-card__main-kpi .label {
    display: block;
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.25rem;
    font-weight: 500;
}

.sknv-card-kpi-strong { border-top: 4px solid #16a34a; } /* UPDATED: Added top border */
.sknv-card-kpi-medium { border-top: 4px solid #f59e0b; } /* UPDATED: Added top border */
.sknv-card-kpi-weak { border-top: 4px solid #ef4444; } /* UPDATED: Added top border */
.sknv-card-kpi-strong .value { color: #16a34a; }
.sknv-card-kpi-medium .value { color: #f59e0b; }
.sknv-card-kpi-weak .value { color: #ef4444; }

.sknv-card__sub-kpi-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem; /* UPDATED: Reduced gap */
    border-top: 1px solid #f3f4f6;
    padding-top: 0.75rem; /* UPDATED: Reduced padding */
}

.sknv-card__sub-kpi-item {
    background-color: #f9fafb;
    border-radius: 0.5rem;
    padding: 0.5rem; /* UPDATED: Reduced padding */
    text-align: center;
    transition: background-color 0.2s ease-in-out;
}

/* === START: NEW SUB-KPI LAYOUT === */
.sknv-card__sub-kpi-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
}
.sknv-card__sub-kpi-header .feather {
    width: 1rem;
    height: 1rem;
    stroke-width: 2;
    color: #6b7280;
}
.sknv-card__sub-kpi-header .label {
    font-size: 0.7rem;
    font-weight: 600;
    color: #4b5563;
}
.sknv-card__sub-kpi-item .value {
    font-size: 0.875rem;
    font-weight: 700;
    margin-top: 2px;
    display: block; /* Ensures it's on a new line */
}
/* === END: NEW SUB-KPI LAYOUT === */

.sknv-card__sub-kpi-item.strong { border-bottom: 3px solid #22c55e; }
.sknv-card__sub-kpi-item.medium { border-bottom: 3px solid #f59e0b; }
.sknv-card__sub-kpi-item.weak { border-bottom: 3px solid #ef4444; }
/* === END: SKNV INFOGRAPHIC CARD STYLES === */

/* === START: SKNV Department Grouping Styles (V6.1) === */
.sknv-department-group {
    margin-bottom: 2.5rem; /* Space between department groups */
}

.sknv-department-group:last-child {
    margin-bottom: 1rem; /* Less space for the last group */
}

.sknv-department-header {
    font-size: 1.6rem;
    font-weight: 700;
    color: #1f2937; /* Dark gray for general headers */
    padding-bottom: 0.75rem;
    margin-bottom: 1.5rem;
    border-bottom: 3px solid #d1d5db; /* Light gray border */
    position: relative;
    padding-left: 0.5rem;
}

.sknv-department-header--priority {
    color: #2563eb; /* Blue for priority department */
    border-bottom-color: #3b82f6; /* Matching blue border */
    background-color: #e0f2fe; /* Light blue background */
    padding: 0.75rem 1rem;
    border-radius: 0.5rem 0.5rem 0 0;
    margin-bottom: 0; /* Remove bottom margin to connect with cards */
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.sknv-department-header--priority::before {
    content: '\f02e'; /* Font Awesome 'flag' icon - if Font Awesome is available */
    font-family: 'Font Awesome 5 Free'; /* Specify font family */
    font-weight: 900; /* For solid icon style */
    font-size: 1.25rem;
    color: #2563eb;
}

/* Adjust grid gap and padding for priority department to integrate better */
.sknv-department-header--priority + .sknv-summary-grid {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    margin-top: 0; /* Remove top margin */
    padding-top: 1.5rem; /* Add padding inside grid */
    border: 1px solid #c7d2fe;
    background-color: #f3f4f6; /* Slightly different background */
    padding-left: 1rem;
    padding-right: 1rem;
    padding-bottom: 1rem;
    border-top: none;
}
/* === END: SKNV Department Grouping Styles === */

/* === START: SKNV DETAIL VIEW & MEDALS (V6.4) === */
/* NEW: Wrapper for compact detail view */
#sknv-detail-capture-area {
    max-width: 1100px;
    margin: 0 auto;
}
.sknv-detail-header-card {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding: 1rem; /* UPDATED: Compact padding */
    background-color: #eff6ff; /* blue-50 */
    border: 1px solid #dbeafe; /* blue-200 */
    border-top: 4px solid #3b82f6; /* blue-500 */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
}
.sknv-detail-avatar {
    width: 64px;
    height: 64px;
    border-radius: 9999px;
    background-color: #dbeafe; /* blue-200 */
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.sknv-detail-avatar svg {
    width: 32px;
    height: 32px;
    color: #1e40af; /* blue-800 */
}
.sknv-detail-info .name {
    color: #1e40af; /* UPDATED: Dark blue color */
}
.sknv-detail-info .department,
.sknv-detail-info .kpi-summary {
    color: #1f2937; /* dark text */
}
.sknv-detail-info .kpi-summary .font-bold {
    color: #1d4ed8; /* darker blue */
}
.sknv-detail-info .name {
    font-size: 1.5rem;
    font-weight: 800;
    line-height: 1.2;
}
.sknv-detail-info .department {
    font-size: 1rem;
    font-weight: 500;
}
.sknv-detail-info .kpi-summary {
    margin-top: 0.5rem;
    font-weight: 600;
}

.sknv-detail-card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem; /* UPDATED: Compact padding */
    color: #ffffff;
}
.sknv-detail-card-header .header-icon {
    width: 20px;
    height: 20px;
}
.sknv-header-blue { background-color: #2563eb; }
.sknv-header-green { background-color: #16a34a; }
.sknv-header-orange { background-color: #f97316; }
.sknv-header-yellow { background-color: #ca8a04; }
.sknv-header-indigo { background-color: #4f46e5; }
.sknv-header-purple { background-color: #7e22ce; }

.sknv-detail-grid-body {
    padding: 0.75rem 1rem; /* UPDATED: Compact padding */
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* UPDATED */
    gap: 0.75rem; /* UPDATED */
}
.sknv-detail-metric-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 0.5rem; /* UPDATED: Compact padding */
    background-color: #f9fafb;
    border-radius: 0.5rem;
    border: 1px solid #f3f4f6;
    transition: all 0.2s ease-in-out;
}
.sknv-detail-metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
}
.sknv-detail-metric-card .label {
    font-weight: 600;
    font-size: 0.8rem; /* UPDATED */
    color: #374151;
}
.sknv-detail-metric-card .value {
    font-weight: 700; /* UPDATED */
    font-size: 1.375rem; /* UPDATED: Reduced font size */
    line-height: 1.2;
    color: #111827;
    margin: 0.25rem 0;
}
.sknv-detail-metric-card .average {
    font-size: 0.7rem; /* UPDATED */
    color: #6b7280;
    font-style: italic;
}
.sknv-detail-metric-card .evaluation-badge {
    margin-top: 0.5rem;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 9999px;
    font-size: 0.7rem; /* UPDATED */
}
.evaluation-badge.text-green-600 { background-color: #dcfce7; }
.evaluation-badge.text-yellow-600 { background-color: #fef9c3; }

.medal-container {
    position: absolute; /* Changed for positioning */
    top: -8px; /* Position it slightly outside the card */
    left: 12px;
    width: 32px; /* Reduced size */
    height: 32px;
    flex-shrink: 0;
}
.medal-container svg {
    width: 100%;
    height: 100%;
    display: block;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); /* Add a nice shadow */
}

/* NEW: Compact tables in detail view */
#sknv-details-container .sknv-subtable-header {
    font-size: 0.8rem;
}
#sknv-details-container .table-bordered td,
#sknv-details-container .table-bordered th {
    padding: 0.5rem;
}
/* === END: SKNV DETAIL VIEW & MEDALS === */
--- END FILE: ./dashboard.css ---

--- START FILE: ./event-listeners/listeners-actions.js ---
// Version 1.0 - Refactored from ui-listeners.js
// MODULE: LISTENERS - ACTIONS
// Ch·ª©a logic ƒëƒÉng k√Ω s·ª± ki·ªán cho c√°c n√∫t h√†nh ƒë·ªông chung (Ch·ª•p ·∫£nh, Xu·∫•t Excel).

import { ui } from '../ui.js';
import { utils } from '../utils.js';
import { captureService } from '../modules/capture.service.js';

export function initializeActionListeners() {
    ['luyke', 'sknv', 'realtime'].forEach(prefix => {
        const captureBtn = document.getElementById(`capture-${prefix}-btn`);
        if (captureBtn) {
            captureBtn.addEventListener('click', () => {
                const navId = prefix === 'luyke' ? 'luyke-subtabs-nav' : (prefix === 'sknv' ? 'employee-subtabs-nav' : 'realtime-subtabs-nav');
                const contentContainerId = prefix === 'luyke' ? 'luyke-subtabs-content' : (prefix === 'sknv' ? 'employee-subtabs-content' : 'realtime-subtabs-content');

                const activeTabButton = document.querySelector(`#${navId} .sub-tab-btn.active`);
                if (!activeTabButton) {
                    ui.showNotification('Kh√¥ng t√¨m th·∫•y tab ƒëang ho·∫°t ƒë·ªông.', 'error');
                    return;
                }
                
                const title = activeTabButton.dataset.title || 'BaoCao';
                let elementToCapture;

                if (prefix === 'luyke' && activeTabButton.dataset.target === 'subtab-luyke-thidua-vung') {
                    elementToCapture = document.getElementById('thidua-vung-infographic-container');
                } else {
                    elementToCapture = document.querySelector(`#${contentContainerId} .sub-tab-content:not(.hidden)`);
                }

                if (!elementToCapture || elementToCapture.children.length === 0) {
                    ui.showNotification('Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ ch·ª•p.', 'error');
                    return;
                }

                captureService.captureDashboardInParts(elementToCapture, title);
            });
        }

        const exportBtn = document.getElementById(`export-${prefix}-btn`);
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                const navId = prefix === 'sknv' ? 'employee-subtabs-nav' : `${prefix}-subtabs-nav`;
                const contentContainerId = prefix === 'sknv' ? 'employee-subtabs-content' : `${prefix}-subtabs-content`;
                
                const activeTabButton = document.querySelector(`#${navId} .sub-tab-btn.active`);
                const activeTabContent = document.querySelector(`#${contentContainerId} .sub-tab-content:not(.hidden)`);
                if (activeTabContent && activeTabButton) {
                    const title = activeTabButton.dataset.title || 'BaoCao';
                    const timestamp = new Date().toLocaleDateString('vi-VN').replace(/\//g, '-');
                    utils.exportTableToExcel(activeTabContent, `${title}_${timestamp}`);
                } else {
                     ui.showNotification('Kh√¥ng t√¨m th·∫•y tab ƒë·ªÉ xu·∫•t.', 'error');
                }
            });
        }
    });
}
--- END FILE: ./event-listeners/listeners-actions.js ---

--- START FILE: ./event-listeners/listeners-collaboration.js ---
// Version 1.0 - Refactored from ui-listeners.js
// MODULE: LISTENERS - COLLABORATION
// Ch·ª©a logic s·ª± ki·ªán cho c√°c t√≠nh nƒÉng h·ª£p t√°c (G√≥p √Ω, Nh·∫≠n x√©t).

import { ui } from '../ui.js';

export function initializeCollaborationListeners(appController) {
    document.body.addEventListener('click', async (e) => {
        const target = e.target;

        // --- Feedback System ---
        if (target.id === 'submit-feedback-btn') {
            appController.handleSubmitFeedback();
        }
        const feedbackItem = target.closest('.feedback-item');
        if (feedbackItem) {
            appController.handleFeedbackReplyActions(e, feedbackItem);
        }
        
        // --- Composer System ---
        const composerTrigger = target.closest('.action-btn--composer');
        if (composerTrigger) {
            const sectionId = composerTrigger.id.split('-')[1];
            appController.prepareAndShowComposer(sectionId);
        }
        const composerModal = target.closest('#composer-modal');
        if (composerModal) {
            appController.handleComposerActions(e, composerModal);
        }
        if (target.id === 'copy-from-preview-btn') {
            ui.copyFromPreview();
        }

        // --- Admin/Declaration System ---
        if (target.id === 'save-help-content-btn') {
            appController.saveHelpContent();
        }
    });
}
--- END FILE: ./event-listeners/listeners-collaboration.js ---

--- START FILE: ./event-listeners/listeners-competition.js ---
// Version 1.0 - Refactored from ui-listeners.js
// MODULE: LISTENERS - COMPETITION
// Ch·ª©a logic s·ª± ki·ªán cho vi·ªác qu·∫£n l√Ω c√°c ch∆∞∆°ng tr√¨nh thi ƒëua.

import { appState } from '../state.js';

export function initializeCompetitionListeners(appController) {
    const goalDrawer = document.getElementById('goal-drawer');
    if (!goalDrawer) return;

    // S·ª≠ d·ª•ng event delegation cho c√°c n√∫t trong danh s√°ch
    goalDrawer.addEventListener('click', (e) => {
        const addBtn = e.target.closest('#add-competition-btn');
        const cancelBtn = e.target.closest('#cancel-competition-btn');
        const editBtn = e.target.closest('.edit-competition-btn');
        const deleteBtn = e.target.closest('.delete-competition-btn');

        if (addBtn) appController._handleCompetitionFormShow(true);
        if (cancelBtn) appController._handleCompetitionFormShow(false);
        if (editBtn) {
            const index = parseInt(editBtn.dataset.index, 10);
            appController._handleCompetitionFormEdit(index);
        }
        if (deleteBtn) {
            const index = parseInt(deleteBtn.dataset.index, 10);
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch∆∞∆°ng tr√¨nh n√†y?')) {
                appController._handleCompetitionDelete(index);
            }
        }
    });

    // G·∫Øn s·ª± ki·ªán cho form
    const form = document.getElementById('competition-form');
    form?.addEventListener('submit', (e) => appController._handleCompetitionFormSubmit(e));
    
    // G·∫Øn s·ª± ki·ªán cho select lo·∫°i thi ƒëua
    const competitionTypeSelect = document.getElementById('competition-type');
    competitionTypeSelect?.addEventListener('change', (e) => {
        const priceSegment = document.getElementById('price-segment');
        if(priceSegment) {
            priceSegment.classList.toggle('hidden', e.target.value !== 'soluong');
        }
    });

    // S·ª≠ d·ª•ng event delegation tr√™n body cho c√°c input target ƒë∆∞·ª£c t·∫°o ƒë·ªông
    document.body.addEventListener('change', (e) => {
        if (e.target.classList.contains('competition-target-input')) {
            const competitionId = e.target.dataset.competitionId;
            const config = appState.competitionConfigs.find(c => c.id === competitionId);
            if (config) {
                config.target = e.target.value; 
            }
            appController.updateAndRenderCurrentTab(); 
        }
    });
}
--- END FILE: ./event-listeners/listeners-competition.js ---

--- START FILE: ./event-listeners/listeners-dragdrop.js ---
// Version 2.1 - Add logging to diagnose re-render issue on drop
// MODULE: LISTENERS - DRAG & DROP
// Ch·ª©a logic kh·ªüi t·∫°o v√† x·ª≠ l√Ω s·ª± ki·ªán k√©o-th·∫£ c·ªôt b·∫±ng SortableJS.

import { settingsService } from '../modules/settings.service.js';

let appController = null;

/**
 * Kh·ªüi t·∫°o SortableJS tr√™n khu v·ª±c ch·ª©a c√°c th·∫ª t√πy ch·ªânh c·ªôt.
 * @param {HTMLElement} container - Ph·∫ßn t·ª≠ DOM ch·ª©a b·∫£ng v√† c√°c n√∫t t√πy ch·ªânh.
 */
function activateSortableOnColumnToggles(container) {
    if (!container) return;

    const toggleContainer = container.querySelector('#efficiency-column-toggles');
    if (!toggleContainer) return;

    // H·ªßy b·ªè instance c≈© n·∫øu c√≥ ƒë·ªÉ tr√°nh l·ªói kh·ªüi t·∫°o nhi·ªÅu l·∫ßn
    if (toggleContainer.sortable) {
        toggleContainer.sortable.destroy();
    }

    // T·∫°o instance m·ªõi
    toggleContainer.sortable = new Sortable(toggleContainer, {
        animation: 150, // Hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªông m∆∞·ª£t m√†
        filter: '.non-draggable', // B·ªè qua c√°c ph·∫ßn t·ª≠ c√≥ class n√†y (v√≠ d·ª•: label "T√πy ch·ªânh c·ªôt:")
        handle: '.drag-handle-icon', // Ch·ªâ cho ph√©p k√©o khi b·∫•m v√†o icon
        onEnd: (evt) => {
            // L·∫•y danh s√°ch c√°c th·∫ª <button> theo th·ª© t·ª± m·ªõi
            const newButtonOrder = Array.from(evt.target.querySelectorAll('button.column-toggle-btn'));
            
            // L·∫•y ra ID c·ªßa c√°c c·ªôt theo th·ª© t·ª± m·ªõi t·ª´ thu·ªôc t√≠nh data-column-id
            const newColumnIdOrder = newButtonOrder.map(btn => btn.dataset.columnId).filter(Boolean);

            // T·∫£i c√†i ƒë·∫∑t hi·ªán t·∫°i
            const currentSettings = settingsService.loadEfficiencyViewSettings();
             
            // T·∫°o m·ªôt Map ƒë·ªÉ truy c·∫≠p nhanh c√°c ƒë·ªëi t∆∞·ª£ng c√†i ƒë·∫∑t theo ID
            const settingsMap = new Map(currentSettings.map(s => [s.id, s]));

            // T·∫°o l·∫°i m·∫£ng c√†i ƒë·∫∑t theo th·ª© t·ª± m·ªõi
            const reorderedSettings = newColumnIdOrder.map(id => settingsMap.get(id));
               
            // Th√™m l·∫°i c√°c c·ªôt ƒë√£ b·ªã ·∫©n (n·∫øu c√≥) v√†o cu·ªëi danh s√°ch ƒë·ªÉ kh√¥ng l√†m m·∫•t ch√∫ng
            currentSettings.forEach(setting => {
                if (!reorderedSettings.find(s => s.id === setting.id)) {
                    reorderedSettings.push(setting);
                }
            });

            // L∆∞u l·∫°i c·∫•u h√¨nh m·ªõi
            settingsService.saveEfficiencyViewSettings(reorderedSettings);

            // V·∫Ω l·∫°i to√†n b·ªô tab ƒë·ªÉ ƒë·ªìng b·ªô header, body, v√† footer c·ªßa b·∫£ng
            if (appController) {
                console.log("LOG: Y√™u c·∫ßu render l·∫°i tab sau khi k√©o th·∫£."); // <<< TH√äM D√íNG N√ÄY ƒê·ªÇ G·ª† L·ªñI
                appController.updateAndRenderCurrentTab();
            }
        }
    });
}


export const dragDroplisteners = {
    /**
     * H√†m kh·ªüi t·∫°o ch√≠nh, nh·∫≠n v√†o controller c·ªßa ·ª©ng d·ª•ng.
     * @param {object} mainAppController - Controller ch√≠nh c·ªßa ·ª©ng d·ª•ng.
     */
    init(mainAppController) {
        appController = mainAppController;
    },
    
    /**
     * H√†m ƒë∆∞·ª£c g·ªçi sau m·ªói l·∫ßn render ƒë·ªÉ k√≠ch ho·∫°t l·∫°i t√≠nh nƒÉng k√©o-th·∫£.
     * @param {string} containerId - ID c·ªßa container ch·ª©a b·∫£ng (v√≠ d·ª•: 'efficiency-report-container').
     */
    initializeForContainer(containerId) {
        const container = document.getElementById(containerId);
        activateSortableOnColumnToggles(container);
    }
};
--- END FILE: ./event-listeners/listeners-dragdrop.js ---

--- START FILE: ./event-listeners/listeners-highlighting.js ---
// Version 1.0 - Refactored from ui-listeners.js
// MODULE: LISTENERS - HIGHLIGHTING
// Ch·ª©a logic s·ª± ki·ªán cho t√≠nh nƒÉng t√¥ m√†u (highlight).

import { appState } from '../state.js';
import { highlightService } from '../modules/highlight.service.js';

/**
 * X·ª≠ l√Ω khi ng∆∞·ªùi d√πng thay ƒë·ªïi l·ª±a ch·ªçn trong c√°c b·ªô l·ªçc highlight.
 * @param {string} prefix - 'luyke', 'sknv', ho·∫∑c 'realtime'.
 * @param {string} type - 'nhanhang', 'nhomhang', ho·∫∑c 'employee'.
 */
function handleHighlightFilterChange(prefix, type) {
    const choicesInstance = appState.choices[`${prefix}_highlight_${type}`];
    if (!choicesInstance) return;

    const values = choicesInstance.getValue(true);
    const color = document.getElementById(`${prefix}-highlight-color`).value;
    
    appState.highlightSettings[prefix] = { type, values, color };
    localStorage.setItem('highlightSettings', JSON.stringify(appState.highlightSettings));
    
    highlightService.applyHighlights(prefix);
}

export function initializeHighlightingListeners(appController) {
    ['luyke', 'sknv', 'realtime'].forEach(prefix => {
        const nhanhangFilter = document.getElementById(`${prefix}-highlight-nhanhang`);
        if (nhanhangFilter) {
            nhanhangFilter.addEventListener('change', () => handleHighlightFilterChange(prefix, 'nhanhang'));
        }

        const nhomhangFilter = document.getElementById(`${prefix}-highlight-nhomhang`);
        if (nhomhangFilter) {
            nhomhangFilter.addEventListener('change', () => handleHighlightFilterChange(prefix, 'nhomhang'));
        }

        const employeeFilter = document.getElementById(`${prefix}-highlight-employee`);
        if (employeeFilter) {
            employeeFilter.addEventListener('change', () => handleHighlightFilterChange(prefix, 'employee'));
        }

        const colorInput = document.getElementById(`${prefix}-highlight-color`);
        if (colorInput) {
            colorInput.addEventListener('input', () => appController.handleHighlightColorChange(prefix));
        }
        
        const clearButton = document.getElementById(`${prefix}-clear-highlight`);
        if (clearButton) {
            clearButton.addEventListener('click', () => appController.handleClearHighlight(prefix));
        }
    });
}
--- END FILE: ./event-listeners/listeners-highlighting.js ---

--- START FILE: ./event-listeners/listeners-settings.js ---
// Version 1.3 - Add event listener for efficiency column toggles
// MODULE: LISTENERS - SETTINGS
// Ch·ª©a logic s·ª± ki·ªán cho c√°c drawers C√†i ƒë·∫∑t v√† c√°c Modals.

import { ui } from '../ui.js';
import { settingsService } from '../modules/settings.service.js';

export function initializeSettingsListeners(appController) {
    // --- Open/Close Modals & Drawers ---
    document.getElementById('admin-access-btn')?.addEventListener('click', () => ui.toggleModal('admin-modal', true));
    document.getElementById('admin-submit-btn')?.addEventListener('click', () => appController.handleAdminLogin());
    document.getElementById('admin-cancel-btn')?.addEventListener('click', () => ui.toggleModal('admin-modal', false));
    document.getElementById('interface-settings-btn')?.addEventListener('click', () => ui.toggleDrawer('interface-drawer', true));
    document.getElementById('goal-settings-btn')?.addEventListener('click', () => ui.toggleDrawer('goal-drawer', true));
    document.querySelectorAll('.close-drawer-btn, #drawer-overlay').forEach(el => el.addEventListener('click', () => ui.closeAllDrawers()));

    // --- Interface Settings ---
    document.querySelectorAll('.contrast-selector').forEach(sel => sel.addEventListener('change', (e) => appController.handleContrastChange(e)));
    document.getElementById('global-font-size-slider')?.addEventListener('input', (e) => settingsService.handleFontSizeChange(e, 'global'));
    document.getElementById('kpi-font-size-slider')?.addEventListener('input', (e) => settingsService.handleFontSizeChange(e, 'kpi'));
    document.querySelectorAll('.kpi-color-input').forEach(picker => picker.addEventListener('input', () => settingsService.saveInterfaceSettings()));

    // --- Goal Settings ---
    document.getElementById('rt-goal-warehouse-select')?.addEventListener('change', () => settingsService.loadAndApplyRealtimeGoalSettings());
    document.getElementById('luyke-goal-warehouse-select')?.addEventListener('change', () => settingsService.loadAndApplyLuykeGoalSettings());
    document.querySelectorAll('.rt-goal-input, .rt-setting-input').forEach(input => input.addEventListener('input', () => {
        settingsService.saveRealtimeGoalSettings();
        appController.updateAndRenderCurrentTab();
    }));
    document.querySelectorAll('.luyke-goal-input').forEach(input => input.addEventListener('input', () => {
        settingsService.saveLuykeGoalSettings();
        appController.updateAndRenderCurrentTab();
    }));
    
    // --- Declaration Settings ---
    document.getElementById('save-declaration-btn')?.addEventListener('click', () => appController.saveDeclarations());

    // --- Global Modals (Help, etc.) & Debug Tool ---
    document.getElementById('toggle-debug-btn')?.addEventListener('click', (e) => ui.toggleDebugTool(e.currentTarget));
    
    // --- Event Delegation for dynamically added elements ---
    document.body.addEventListener('click', (e) => {
        const helpTrigger = e.target.closest('.page-header__help-btn');
        if(helpTrigger) {
            ui.showHelpModal(helpTrigger.dataset.helpId);
        }

        const closeModalTrigger = e.target.closest('[data-close-modal]');
        if (closeModalTrigger) {
            const modal = closeModalTrigger.closest('.modal');
            if(modal) {
                ui.toggleModal(modal.id, false);
            }
        }
        
        const selectionSaveBtn = e.target.closest('#selection-modal-save-btn');
        if (selectionSaveBtn) {
            const modal = document.getElementById('selection-modal');
            const settingType = modal.dataset.settingType;

            const selectedItems = [];
            document.querySelectorAll('#selection-modal-list input[type="checkbox"]:checked').forEach(checkbox => {
                selectedItems.push(checkbox.value);
            });

            if (settingType === 'efficiencyView') {
                // Logic c≈© n√†y v·∫´n c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi modal, nh∆∞ng UI m·ªõi s·∫Ω d√πng logic ri√™ng
                const allItems = settingsService.loadEfficiencyViewSettings();
                const updatedItems = allItems.map(item => ({...item, visible: selectedItems.includes(item.id)}));
                settingsService.saveEfficiencyViewSettings(updatedItems);
            } else if (settingType === 'qdcView') {
                settingsService.saveQdcViewSettings(selectedItems);
            } else if (settingType === 'categoryView') {
                settingsService.saveCategoryViewSettings(selectedItems);
            }

            ui.toggleModal('selection-modal', false);
            ui.showNotification('ƒê√£ l∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã!', 'success');
            appController.updateAndRenderCurrentTab();
        }

        // === B·∫ÆT ƒê·∫¶U LOGIC M·ªöI CHO T√ôY CH·ªàNH C·ªòT ===
        const columnToggleButton = e.target.closest('.column-toggle-btn');
        if (columnToggleButton && columnToggleButton.closest('#efficiency-column-toggles')) {
            e.preventDefault();
            const columnId = columnToggleButton.dataset.columnId;
            
            // 1. T·∫£i c√†i ƒë·∫∑t hi·ªán t·∫°i
            const currentSettings = settingsService.loadEfficiencyViewSettings();
            
            // 2. Thay ƒë·ªïi tr·∫°ng th√°i c·ªßa c·ªôt ƒë∆∞·ª£c nh·∫•p
            const newSettings = currentSettings.map(col => {
                if (col.id === columnId) {
                    return { ...col, visible: !col.visible };
                }
                return col;
            });

            // 3. L∆∞u c√†i ƒë·∫∑t m·ªõi
            settingsService.saveEfficiencyViewSettings(newSettings);
            
            // 4. Render l·∫°i tab ƒë·ªÉ √°p d·ª•ng thay ƒë·ªïi
            appController.updateAndRenderCurrentTab();
        }
        // === K·∫æT TH√öC LOGIC M·ªöI ===
    });

    const searchInput = document.getElementById('selection-modal-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('#selection-modal-list .selection-item').forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                item.style.display = label.includes(searchTerm) ? '' : 'none';
            });
        });
    }
}
--- END FILE: ./event-listeners/listeners-settings.js ---

--- START FILE: ./event-listeners/listeners-sorting.js ---
// Version 1.0 - Refactored from ui-listeners.js
// MODULE: LISTENERS - SORTING
// Ch·ª©a logic s·ª± ki·ªán cho vi·ªác s·∫Øp x·∫øp c√°c b·∫£ng.

import { appState } from '../state.js';

export function initializeSortingListeners(appController) {
    document.body.addEventListener('click', (e) => {
        const header = e.target.closest('.sortable');
        if (!header) return;

        const table = header.closest('table');
        if (!table) return;
        
        const tableType = table.dataset.tableType;
        const sortKey = header.dataset.sort;

        if (!tableType || !sortKey) return;

        const currentState = appState.sortState[tableType] || { key: sortKey, direction: 'desc' };
        
        let newDirection;
        if (currentState.key === sortKey) {
            newDirection = currentState.direction === 'desc' ? 'asc' : 'desc';
        } else {
            newDirection = 'desc';
        }
        
        appState.sortState[tableType] = { key: sortKey, direction: newDirection };

        appController.updateAndRenderCurrentTab();
    });
}
--- END FILE: ./event-listeners/listeners-sorting.js ---

--- START FILE: ./event-listeners/ui-listeners.js ---
// Version 3.12 - Critical Fix: Correct all import paths and update click listener
// MODULE: EVENT LISTENERS INITIALIZER
// File n√†y ƒë√≥ng vai tr√≤ l√† ƒëi·ªÉm kh·ªüi ƒë·∫ßu, import v√† kh·ªüi ch·∫°y t·∫•t c·∫£ c√°c module listener con.

import { appState } from '../state.js';
import { ui } from '../ui.js';
import { services } from '../services.js';
import { luykeTab } from '../tab-luyke.js';
import { sknvTab } from '../tab-sknv.js';
import { uiRealtime } from '../ui-realtime.js';
import { initializeActionListeners } from './listeners-actions.js';
import { initializeCollaborationListeners } from './listeners-collaboration.js';
import { initializeCompetitionListeners } from './listeners-competition.js';
import { initializeHighlightingListeners } from './listeners-highlighting.js';
import { initializeSettingsListeners } from './listeners-settings.js';
import { initializeSortingListeners } from './listeners-sorting.js';
import { dragDroplisteners } from './listeners-dragdrop.js';
import { captureService } from '../modules/capture.service.js';

let appController = null;

// --- HELPERS / HANDLERS ---

async function handleFileInputChange(e) {
    const fileInput = e.target;
    const file = fileInput.files[0];
    const fileType = fileInput.id.replace('file-', '');
    const dataName = fileInput.dataset.name || fileType;
    const stateKey = fileInput.dataset.stateKey;
    if (!file || !stateKey) return;

    ui.updateFileStatus(fileType, file.name, 'ƒêang x·ª≠ l√Ω...', 'default');
    ui.showProgressBar(fileType);

    try {
        const workbook = await appController.handleFileRead(file);
        const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        const normalizeType = fileType.includes('thangtruoc') ? fileType.replace('-thangtruoc', '') : fileType;
        const { normalizedData, success, missingColumns } = services.normalizeData(rawData, normalizeType);
        ui.displayDebugInfo(fileType);

        if (success) {
            appState[stateKey] = normalizedData;
            if (stateKey === 'danhSachNhanVien') {
                services.updateEmployeeMaps();
                ui.populateAllFilters();
            }
            ui.updateFileStatus(fileType, file.name, `‚úì ƒê√£ t·∫£i ${normalizedData.length} d√≤ng.`, 'success');
            ui.showNotification(`T·∫£i th√†nh c√¥ng file "${dataName}"!`, 'success');
            
            if (fileInput.dataset.saveKey) {
                await appController.storage.setItem(fileInput.dataset.saveKey, rawData);
                const savedStatusSpan = document.getElementById(`${fileType}-saved-status`);
                if (savedStatusSpan) savedStatusSpan.textContent = `ƒê√£ l∆∞u ${normalizedData.length} d√≤ng.`;
                ui.showNotification(`ƒê√£ l∆∞u "${dataName}" v√†o b·ªô nh·ªõ ƒë·ªám c·ªßa tr√¨nh duy·ªát.`, 'success');
            }
            appController.updateAndRenderCurrentTab();
        } else {
            const errorMessage = `L·ªói file "${dataName}": Thi·∫øu c·ªôt: ${missingColumns.join(', ')}.`;
            ui.updateFileStatus(fileType, file.name, `L·ªói: Thi·∫øu c·ªôt d·ªØ li·ªáu.`, 'error');
            ui.showNotification(errorMessage, 'error');
            if (document.getElementById('debug-tool-container')?.classList.contains('hidden')) {
                document.getElementById('toggle-debug-btn')?.click();
            }
        }
    } catch (error) {
        console.error(`L·ªói x·ª≠ l√Ω file ${dataName}:`, error);
        ui.updateFileStatus(fileType, file.name, `L·ªói: ${error.message}`, 'error');
        ui.showNotification(`L·ªói khi x·ª≠ l√Ω file "${dataName}".`, 'error');
    } finally {
        ui.hideProgressBar(fileType);
    }
}

function handleFilterChange(prefix) {
    appState.viewingDetailFor = null;
    ui.updateEmployeeFilter(prefix);
    appController.updateAndRenderCurrentTab();
}

// --- MAIN INITIALIZER ---

export function initializeEventListeners(mainAppController) {
    appController = mainAppController;

    try {
        const multiSelectConfig = {
            removeItemButton: true,
            placeholder: true,
            placeholderValue: 'Ch·ªçn ho·∫∑c g√µ ƒë·ªÉ t√¨m...',
            searchPlaceholderValue: 'T√¨m ki·∫øm...'
        };

        const competitionMultiSelectConfig = {
            removeItemButton: true,
            placeholder: true,
            placeholderValue: 'Ch·ªçn ho·∫∑c g√µ ƒë·ªÉ t√¨m...',
            searchPlaceholderValue: 'T√¨m ki·∫øm...',
        };

        ['luyke', 'sknv', 'realtime'].forEach(prefix => {
            const employeeEl = document.getElementById(`${prefix}-filter-name`);
            if (employeeEl) appState.choices[`${prefix}_employee`] = new Choices(employeeEl, multiSelectConfig);
            
            ['warehouse', 'department'].forEach(type => {
                const el = document.getElementById(`${prefix}-filter-${type}`);
                if(el) appState.choices[`${prefix}_${type}`] = new Choices(el, { searchEnabled: true, removeItemButton: false, itemSelectText: 'Ch·ªçn' });
            });
            ['nhanhang', 'nhomhang', 'employee'].forEach(type => {
                const highlightEl = document.getElementById(`${prefix}-highlight-${type}`);
                if (highlightEl) appState.choices[`${prefix}_highlight_${type}`] = new Choices(highlightEl, multiSelectConfig);
            });
        });

        const competitionBrandEl = document.getElementById('competition-brand');
        if (competitionBrandEl) appState.choices['competition_brand'] = new Choices(competitionBrandEl, competitionMultiSelectConfig);
        
        const competitionGroupEl = document.getElementById('competition-group');
        if (competitionGroupEl) appState.choices['competition_group'] = new Choices(competitionGroupEl, competitionMultiSelectConfig);

        const singleSelectConfig = {
            searchEnabled: true,
            removeItemButton: false,
            itemSelectText: 'Ch·ªçn',
            searchPlaceholderValue: 'T√¨m ki·∫øm...'
        };
        const singleSelects = {
             'thidua-employee-filter': 'thidua_employee_detail',
            'thidua-vung-filter-supermarket': 'thiDuaVung_sieuThi',
        };
        for (const [id, key] of Object.entries(singleSelects)) {
             const el = document.getElementById(id);
             if (el) appState.choices[key] = new Choices(el, singleSelectConfig);
        }
    } catch (error) { console.error("L·ªói khi kh·ªüi t·∫°o Choices.js:", error); }

    try {
        const initDatePicker = (prefix, renderFunc) => {
            const datePickerEl = document.getElementById(`${prefix}-filter-date`);
            if (!datePickerEl) return;
            const datePicker = flatpickr(datePickerEl, {
                mode: "multiple", dateFormat: "d/m", maxDate: "today",
                onClose: (selectedDates, dateStr, instance) => {
                    if (selectedDates.length === 2) {
                        const [start, end] = selectedDates.sort((a,b) => a - b);
                        const dateRange = Array.from({length: (end - start) / 86400000 + 1}, (_, i) => new Date(start.getTime() + i * 86400000));
                        instance.setDate(dateRange, false);
                    }
                    ui.updateDateSummary(document.getElementById(`${prefix}-date-summary`), instance);
                    appState.viewingDetailFor = null;
                    renderFunc();
                }
            });
            appState.choices[`${prefix}_date_picker`] = datePicker;
            document.getElementById(`${prefix}-clear-date`)?.addEventListener('click', () => { datePicker.clear(); renderFunc(); });
        };
        initDatePicker('luyke', luykeTab.render);
        initDatePicker('sknv', sknvTab.render);
    } catch (error) { console.error("L·ªói khi kh·ªüi t·∫°o Flatpickr:", error); }

    initializeSettingsListeners(appController);
    initializeHighlightingListeners(appController);
    initializeActionListeners();
    initializeCollaborationListeners(appController);
    initializeSortingListeners(appController);
    initializeCompetitionListeners(appController);
    dragDroplisteners.init(appController);

    document.getElementById('force-reload-btn')?.addEventListener('click', () => window.location.reload());
    document.querySelectorAll('a.nav-link').forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); appController.switchTab(link.getAttribute('href').substring(1)); }));
    
    document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', (e) => {
        ui.handleSubTabClick(e.currentTarget);
        appState.viewingDetailFor = null;
        const mainTabId = e.currentTarget.closest('.page-section')?.id || e.currentTarget.closest('.settings-drawer')?.id;
        
        if (mainTabId === 'health-section') luykeTab.render();
        else if (mainTabId === 'health-employee-section') sknvTab.render();
        else if (mainTabId === 'realtime-section') uiRealtime.render(); 
    }));

    document.querySelectorAll('.toggle-filters-btn').forEach(button => button.addEventListener('click', () => ui.toggleFilterSection(button.dataset.target)));
    
    document.querySelectorAll('.file-input').forEach(input => {
        if (input.id !== 'file-thidua-vung' && input.id !== 'file-category-structure') {
            input.addEventListener('change', (e) => handleFileInputChange(e));
        }
    });
    document.getElementById('file-category-structure')?.addEventListener('change', (e) => appController.handleCategoryFile(e));
    
    document.getElementById('paste-luyke')?.addEventListener('input', () => appController.handleLuykePaste());
    document.getElementById('paste-thiduanv')?.addEventListener('input', () => appController.handleThiduaNVPaste());
    document.getElementById('paste-thuongerp')?.addEventListener('input', () => appController.handleErpPaste());
    document.getElementById('paste-thuongerp-thangtruoc')?.addEventListener('input', (e) => appController.handleErpThangTruocPaste(e));
    document.getElementById('realtime-file-input')?.addEventListener('change', (e) => appController.handleRealtimeFileInput(e));
    document.getElementById('download-danhsachnv-template-btn')?.addEventListener('click', () => appController.handleTemplateDownload());
    
    document.getElementById('file-thidua-vung')?.addEventListener('change', (e) => appController.handleThiDuaVungFileInput(e));
    document.getElementById('thidua-vung-filter-supermarket')?.addEventListener('change', () => appController.handleThiDuaVungFilterChange());
    
    document.getElementById('debug-competition-file-input')?.addEventListener('change', (e) => appController.handleCompetitionDebugFile(e));

    ['luyke', 'sknv', 'realtime'].forEach(prefix => {
        document.getElementById(`${prefix}-filter-warehouse`)?.addEventListener('change', () => handleFilterChange(prefix));
        document.getElementById(`${prefix}-filter-department`)?.addEventListener('change', () => handleFilterChange(prefix));
         document.getElementById(`${prefix}-filter-name`)?.addEventListener('change', () => handleFilterChange(prefix));
    });
    
    document.getElementById('sknv-view-selector')?.addEventListener('click', (e) => appController.handleSknvViewChange(e));
    document.getElementById('sknv-employee-filter')?.addEventListener('change', () => sknvTab.render());
    
    document.body.addEventListener('click', (e) => {
        // === START: UPDATED CLICK LOGIC (V3.12) ===
        // This now targets '.interactive-row' which is on both summary cards and table rows
        const interactiveRow = e.target.closest('.interactive-row');
        if (interactiveRow && interactiveRow.dataset.employeeId) {
            e.preventDefault();
            
            // Prevent re-triggering if already viewing the same employee's detail
            if (appState.viewingDetailFor && appState.viewingDetailFor.employeeId === interactiveRow.dataset.employeeId) {
                return;
            }
            
            appState.viewingDetailFor = {
                employeeId: interactiveRow.dataset.employeeId,
                sourceTab: interactiveRow.dataset.sourceTab
            };
            appController.updateAndRenderCurrentTab();
            return;
        }
        // === END: UPDATED CLICK LOGIC ===

        const backButton = e.target.closest('.back-to-summary-btn');
        if (backButton) {
            e.preventDefault();
            appState.viewingDetailFor = null;
            appController.updateAndRenderCurrentTab();
            return;
        }

        const captureDetailBtn = e.target.closest('#capture-sknv-detail-btn, #capture-dtnv-lk-detail-btn, #capture-dtnv-rt-detail-btn');
        if (captureDetailBtn) {
            e.preventDefault();
            const areaToCapture = captureDetailBtn.closest('.sub-tab-content')?.querySelector('[id$="-capture-area"]');
            const title = appState.viewingDetailFor?.employeeId || 'ChiTietNV';
            if (areaToCapture) {
                captureService.captureDashboardInParts(areaToCapture, title);
            }
            return;
        }
        
        const luykeViewSwitcherBtn = e.target.closest('#luyke-thidua-view-selector .view-switcher__btn');
        if (luykeViewSwitcherBtn) {
            e.preventDefault();
            appController.handleLuykeThiDuaViewChange(e);
            return;
        }

        const thiDuaViewSwitcherBtn = e.target.closest('#thidua-view-selector .view-switcher__btn');
        if (thiDuaViewSwitcherBtn) {
            e.preventDefault();
            appController.handleThiDuaViewChange(e);
            return;
        }
        
        const dtHangViewSwitcherBtn = e.target.closest('#dthang-realtime-view-selector .view-switcher__btn');
        if (dtHangViewSwitcherBtn) {
            e.preventDefault();
            appController.handleDthangRealtimeViewChange(e);
            return;
        }
    });
    
    document.getElementById('thidua-employee-filter')?.addEventListener('change', () => ui.displayCompetitionReport('employee'));
    document.getElementById('realtime-brand-category-filter')?.addEventListener('change', () => uiRealtime.handleBrandFilterChange());
    document.getElementById('realtime-brand-filter')?.addEventListener('change', () => uiRealtime.handleBrandFilterChange());
}
--- END FILE: ./event-listeners/ui-listeners.js ---

--- START FILE: ./index.html ---
<!DOCTYPE html>
<html lang="vi" data-contrast="3">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• ph√¢n t√≠ch s·ªë cho QLST MWG 4.9</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <script src="https://unpkg.com/feather-icons"></script>

    <link rel="stylesheet" href="./dashboard.css">
    
    <style>
        #luyke-category-details-content td:first-child,
        #luyke-unexported-revenue-content td:first-child {
            text-transform: capitalize;
        }
    </style>
</head>
<body class="overflow-x-hidden">

    <div id="update-notification" class="hidden fixed bottom-5 right-5 bg-blue-600 text-white py-3 px-5 rounded-lg shadow-lg z-[1001] flex items-center gap-4">
        <p class="font-semibold">ƒê√£ c√≥ phi√™n b·∫£n m·ªõi! Xem chi ti·∫øt n·ªôi dung c·∫≠p nh·∫≠t ·ªü tab "H∆∞·ªõng D·∫´n & G√≥p √ù"</p>
        <button onclick="window.location.reload()" class="bg-white text-blue-600 font-bold py-1 px-3 rounded-md hover:bg-blue-100 transition">T·∫£i l·∫°i trang</button>
    </div>

    <div id="interface-drawer-container"></div>
    <div id="goal-drawer-container"></div>
    <div id="drawer-overlay" class="hidden fixed inset-0 bg-black bg-opacity-40 z-40"></div>

    <div class="flex min-h-screen">
        <div id="sidebar-container"></div> 
         <main id="main-content" class="flex-1 p-6">
            
<div class="max-w-full mx-auto">

                <section id="home-section" class="page-section hidden">
                    <div class="page-header">
                        <h2 class="page-header__title">H∆∞·ªõng D·∫´n & G√≥p √ù</h2>
                        <div id="usage-counter-display" class="text-sm font-semibold">
                     
<span class="text-blue-600">Ng∆∞·ªùi d√πng:</span>
                            <span id="user-count" class="text-red-600 font-bold">-</span>
                            <span class="text-blue-600 ml-4">L∆∞·ª£t truy c·∫≠p:</span>
                            <span id="visitor-count" class="text-red-600 font-bold">-</span>
                
<span class="text-blue-600 ml-4">L∆∞·ª£t s·ª≠ d·ª•ng:</span>
                            <span id="action-count" class="text-red-600 font-bold">-</span>
                        </div>
                    </div>
                  
          
<div class="content-card">
                         <h3 class="content-card__header">Video H∆∞·ªõng D·∫´n S·ª≠ D·ª•ng Nhanh</h3>
                         <div id="video-container" class="bg-gray-200 rounded-lg">
                            <iframe 
                    
class="w-full h-full aspect-video" 
                                src="https://www.youtube.com/embed/bmImlht_yB4?si=iIo9NZ7wc9FvKZKf" 
                                title="YouTube video player" 
                                frameborder="0" 
   
allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen>
                            </iframe>
                        
</div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                        <div class="flex flex-col">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">G√≥p √Ω & Th·∫£o lu·∫≠n</h2>
            
<div id="feedback-composer" class="bg-white rounded-xl shadow-md p-6 border border-gray-200 flex-grow">
                                </div>
                        </div>
                        <div class="flex flex-col">
             
<h2 class="text-2xl font-bold text-gray-800 mb-6">Danh s√°ch g√≥p √Ω</h2>
                            <div id="feedback-list-container" class="bg-white rounded-xl shadow-md p-6 border border-gray-200 flex-grow">
                                <div id="feedback-list" class="space-y-6">
                           
</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-12">
                     
<h2 class="text-2xl font-bold text-gray-800 mb-6">L·ªãch s·ª≠ c·∫≠p nh·∫≠t</h2>
                         <div id="update-history-list" class="space-y-6">
                        </div>
                    </div>
                    </section>
                  
<section id="data-section" class="page-section">
                        <div class="page-header">
                        <div class="flex items-center gap-x-3">
                            <h2 class="page-header__title">C·∫≠p nh·∫≠t d·ªØ li·ªáu</h2>
                            <button class="page-header__help-btn" data-help-id="data"
title="Xem h∆∞·ªõng d·∫´n">
                                <i data-feather="help-circle"></i>
                            </button>
                        </div>
                        <div id="version-marquee-container" class="marquee-container">
      
<p class="marquee-text"></p>
                        </div>
                    
                        <div class="header-qr-container">
                           
<span>THAM GIA TH·∫¢O LU·∫¨N - G√ìP √ù</span>
                             <img id="header-qr-image" src="" alt="M√£ QR" class="header-qr-image">
                        </div>
                    </div>
                    <div class="content-card">
            
<div class="flex justify-start items-baseline gap-x-4">
                            <h3 class="content-card__header !mb-0 !border-b-0">D·ªÆ LI·ªÜU C·∫¨P NH·∫¨T H√ÄNG NG√ÄY</h3>
                            <a href="#" id="download-bookmark-link" download="QLST_Bookmark.zip" class="data-input-group__link">
                                T·∫£i Bookmark Chrome
 
                            </a>
                        </div>
                        
                        <div class="flex flex-col gap-6 pt-4">
                
<div class="grid md:grid-cols-3 gap-6">
                                <div class="data-input-group">
                                    <a href="https://report.mwgroup.vn/home/dashboard/077" target="_blank" class="data-input-group__label data-input-group__label--link">üìÑ Y√™u c·∫ßu xu·∫•t l≈©y k·∫ø:</a>
                          
<div class="data-input-group__content">
                                        <div class="flex items-center gap-2">
                                            <label for="file-ycx" class="data-input-group__file-trigger">Th√™m file</label>
                  
<span id="file-name-ycx" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                        </div>
                                        <input type="file" id="file-ycx" class="hidden file-input" data-name="Y√™u c·∫ßu xu·∫•t l≈©y
k·∫ø" data-state-key="ycxData" data-save-key="saved_ycx" accept=".xlsx, .xls, .csv">
                                        <div class="data-input-group__status-wrapper"><span id="file-status-ycx" class="data-input-group__status-text"></span></div>
                                        <div id="progress-ycx" class="progress-bar-container hidden"><div class="progress-bar"></div></div>
                           
</div>
                                </div>
                                <div class="data-input-group">
                                    <a href="https://reports.thegioididong.com/#/viewreport/168754" target="_blank" class="data-input-group__label data-input-group__label--link">üìÑ Gi·ªù c√¥ng:</a>
   
<div class="data-input-group__content">
                                        <div class="flex items-center gap-2">
                                          
<label for="file-giocong" class="data-input-group__file-trigger">Th√™m file</label>
                                            <span id="file-name-giocong" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                        </div>
                          
<input type="file" id="file-giocong" class="hidden file-input" data-name="Gi·ªù c√¥ng" data-state-key="rawGioCongData" data-save-key="saved_giocong" accept=".xlsx, .xls, .csv">
                                        <div class="data-input-group__status-wrapper">
                                            <span id="file-status-giocong" class="data-input-group__status-text"></span>
       
</div>
                                        <div id="progress-giocong" class="progress-bar-container hidden"><div class="progress-bar"></div></div>
                                    </div>
      
</div>
                                <div class="data-input-group">
                                    <a href="https://report.mwgroup.vn/home/dashboard/105" target="_blank" class="data-input-group__label data-input-group__label--link">üìÑ Th∆∞·ªüng n√≥ng:</a>
                  
<div class="data-input-group__content">
                                        <div class="flex items-center gap-2">
                                            <label for="file-thuongnong" class="data-input-group__file-trigger">Th√™m file</label>
          
<span id="file-name-thuongnong" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                        </div>
                                        <input
type="file" id="file-thuongnong" class="hidden file-input" data-name="Th∆∞·ªüng n√≥ng" data-state-key="thuongNongData" data-save-key="saved_thuongnong" accept=".xlsx, .xls, .csv">
                                        <div class="data-input-group__status-wrapper">
                                            <span id="file-status-thuongnong" class="data-input-group__status-text"></span>
                      
</div>
                                        <div id="progress-thuongnong" class="progress-bar-container hidden"><div class="progress-bar"></div></div>
                                    </div>
                     
</div>
                            </div>
                            <div class="grid md:grid-cols-3 gap-6">
                                <div class="data-input-group h-full">
               
<a href="https://bi.thegioididong.com/reward?id=-1&tab=1" target="_blank" class="data-input-group__label data-input-group__label--link">üìã Th∆∞·ªüng ERP:<br><span class="font-normal">(Copy t·ª´ BI)</span></a>
                                    <div class="data-input-group__content">
                                        <textarea id="paste-thuongerp" rows="5" class="data-textarea" placeholder="D√°n to√†n b·ªô d·ªØ li·ªáu th∆∞·ªüng ERP..."></textarea>
  
<div class="data-input-group__status-wrapper"><span id="status-thuongerp" class="data-input-group__status-text"></span></div>
                                    </div>
                                </div>
          
<div class="data-input-group h-full">
                                    <a href="https://bi.thegioididong.com/sieu-thi-con?id=16612&tab=1" target="_blank" class="data-input-group__label data-input-group__label--link">üìã Data l≈©y k·∫ø:<br><span class="font-normal">(Copy t·ª´ BI)</span></a>
                                    <div class="data-input-group__content">
            
<textarea id="paste-luyke" rows="5" class="data-textarea" placeholder="D√°n d·ªØ li·ªáu ƒë√£ sao ch√©p..."></textarea>
                                        <div class="data-input-group__status-wrapper"><span id="status-luyke" class="data-input-group__status-text"></span></div>
                                    </div>
   
</div>
                                <div class="data-input-group h-full">
                                    <a href="https://bi.thegioididong.com/sieu-thi-con?id=16758&tab=bcdtnv&rt=2&dm=1" target="_blank" class="data-input-group__label data-input-group__label--link">üìã Thi ƒëua nh√¢n vi√™n:<br><span class="font-normal">(Copy t·ª´ BI)</span></a>
         
<div class="data-input-group__content">
                                        <textarea id="paste-thiduanv" rows="5" class="data-textarea" placeholder="D√°n d·ªØ li·ªáu ƒë√£ sao ch√©p..."></textarea>
                                        <div class="data-input-group__status-wrapper"><span
id="status-thiduanv" class="data-input-group__status-text"></span></div>
                                    </div>
                                </div>
                            </div>
                      
</div>
                    </div>

                    <div class="mb-6">
                        <button id="toggle-debug-btn" class="text-sm text-blue-600 hover:underline">Hi·ªÉn th·ªã C√¥ng c·ª• G·ª° l·ªói</button>
                        <div id="debug-tool-container" class="hidden mt-4 p-4 border-2 border-dashed border-red-300 rounded-lg bg-red-50">
          
<h3 class="text-lg font-bold text-red-700 mb-2">C√¥ng c·ª• G·ª° l·ªói & Ch·∫©n ƒëo√°n</h3>
                            <p class="text-sm text-gray-600 mb-4">C√¥ng c·ª• n√†y s·∫Ω t·ª± ƒë·ªông ki·ªÉm tra c√°c file b·∫°n t·∫£i l√™n v√† d·ªØ li·ªáu b·∫°n d√°n v√†o. N·∫øu c√≥ c·ªôt b√°o <span class="font-bold text-red-600">L·ªñI</span>, vui l√≤ng ki·ªÉm tra l·∫°i file ho·∫∑c d·ªØ li·ªáu copy.</p>
                         
<div id="debug-results-container" class="space-y-4">
                                 <p class="text-gray-500">Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c t·∫£i l√™n ƒë·ªÉ ki·ªÉm tra.</p>
                            </div>
                            <div id="pasted-debug-results-container" class="space-y-4 mt-4"></div>
            
</div>
                    </div>
                    
                    <div class="content-card">
                        <h3 class="content-card__header">D·ªÆ LI·ªÜU C·∫¨P NH·∫¨T 1 TH√ÅNG 1 L·∫¶N</h3>
              
<p class="text-sm text-yellow-600 bg-yellow-50 p-3 rounded-lg mb-4">L∆∞u √Ω: D·ªØ li·ªáu trong ph·∫ßn n√†y s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o tr√¨nh duy·ªát c·ªßa b·∫°n. D·ªØ li·ªáu s·∫Ω t·ªìn t·∫°i cho ƒë·∫øn khi b·∫°n c·∫≠p nh·∫≠t l·∫°i.</p>
                        
                        <div class="grid md:grid-cols-3 gap-6">
                          
<div class="space-y-4">
                                <div class="data-input-group">
                                    <label class="data-input-group__label">üìÑ Danh s√°ch nh√¢n vi√™n:</label>
                                    <div class="data-input-group__content">
     
<div class="flex items-center gap-2">
                                            <label for="file-danhsachnv" class="data-input-group__file-trigger">Th√™m file</label>
                                  
<span id="file-name-danhsachnv" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                        </div>
                                        <button id="download-danhsachnv-template-btn" class="data-input-group__link text-left">T·∫£i file m·∫´u</button>
                    
<input type="file" id="file-danhsachnv" class="hidden file-input" data-name="Danh s√°ch nh√¢n vi√™n" data-state-key="danhSachNhanVien" data-save-key="saved_danhsachnv" accept=".xlsx, .xls, .csv">
                                        <div class="data-input-group__status-wrapper">
                                            <span
id="file-status-danhsachnv" class="data-input-group__status-text"></span>
                                        </div>
                                        <div id="progress-danhsachnv" class="progress-bar-container hidden"><div class="progress-bar"></div></div>
                                  
</div>
                                </div>
                                <div class="data-input-group">
                                    <label class="data-input-group__label">üìÑ YCX L≈©y K·∫ø th√°ng tr∆∞·ªõc:</label>
          
<div class="data-input-group__content">
                                        <div class="flex items-center gap-2">
                                            <label for="file-ycx-thangtruoc" class="data-input-group__file-trigger">Th√™m file</label>
  
<span id="file-name-ycx-thangtruoc" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                        </div>
                                 
<input type="file" id="file-ycx-thangtruoc" class="hidden file-input" data-name="YCX L≈©y K·∫ø th√°ng tr∆∞·ªõc" data-state-key="ycxDataThangTruoc" data-save-key="saved_ycx_thangtruoc" accept=".xlsx, .xls, .csv">
                                        <div class="data-input-group__status-wrapper">
                                            <span id="file-status-ycx-thangtruoc" class="data-input-group__status-text"></span>
           
</div>
                                        <div id="progress-ycx-thangtruoc" class="progress-bar-container hidden"><div class="progress-bar"></div></div>
                                    </div>
          
</div>
                            </div>
                            <div class="space-y-4">
                                <div class="data-input-group">
       
<label class="data-input-group__label">üìÑ Th∆∞·ªüng n√≥ng th√°ng tr∆∞·ªõc:</label>
                                    <div class="data-input-group__content">
                                        <div class="flex items-center gap-2">
     
<label for="file-thuongnong-thangtruoc" class="data-input-group__file-trigger">Th√™m file</label>
                                            <span id="file-name-thuongnong-thangtruoc" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                             
</div>
                                        <input type="file" id="file-thuongnong-thangtruoc" class="hidden file-input" data-name="Th∆∞·ªüng n√≥ng th√°ng tr∆∞·ªõc" data-state-key="thuongNongDataThangTruoc" data-save-key="saved_thuongnong_thangtruoc" accept=".xlsx, .xls, .csv">
                                        <div class="data-input-group__status-wrapper">
              
<span id="file-status-thuongnong-thangtruoc" class="data-input-group__status-text"></span>
                                        </div>
                                        <div id="progress-thuongnong-thangtruoc" class="progress-bar-container hidden"><div class="progress-bar"></div></div>
   
</div>
                                </div>
                            </div>
                          
<div class="space-y-4">
                                <div class="data-input-group h-full">
                                    <label class="data-input-group__label">üìã Th∆∞·ªüng ERP th√°ng tr∆∞·ªõc:</label>
                                    <div class="data-input-group__content">
   
<textarea id="paste-thuongerp-thangtruoc" rows="5" class="data-textarea" placeholder="D√°n d·ªØ li·ªáu th∆∞·ªüng ERP th√°ng tr∆∞·ªõc..."></textarea>
                                        <div class="data-input-group__status-wrapper">
                               
<span id="status-thuongerp-thangtruoc" class="data-input-group__status-text"></span>
                                        </div>
                                    </div>
                            
</div>
                            </div>
                        </div>
                    </div>
                </section>
                <section id="health-section" class="page-section hidden">
        
<div id="health-section-placeholder" class="placeholder-message hidden">Vui l√≤ng c·∫≠p nh·∫≠t danh s√°ch nh√¢n vi√™n ƒë·ªÉ xem k·∫øt qu·∫£.</div>
                    <div id="health-section-content">
                        <div class="content-card">
                            <div class="page-header border-b pb-4 mb-6">
               
<h2 class="page-header__title">S·ª©c kh·ªèe si√™u th·ªã</h2>
                                <button class="page-header__help-btn" data-help-id="luyke" title="Xem h∆∞·ªõng d·∫´n">
                                    <i data-feather="help-circle"></i>
                        
</button>
                            </div>
                            <button class="toggle-filters-btn" data-target="luyke-filter-container">
                                <span class="text">Hi·ªán b·ªô l·ªçc n√¢ng cao</span>
                
<i data-feather="chevron-down" class="icon"></i>
                            </button>
                            <div id="luyke-filter-container" class="advanced-filters hidden">
                                <div id="luyke-filter-bar" class="p-4 bg-slate-50 border border-slate-200 rounded-lg space-y-4">
   
<div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                        <div class="md:col-span-2">
                                        
<label for="luyke-filter-date" class="block text-sm font-medium text-gray-600 mb-1">Ng√†y t·∫°o</label>
                                            <div class="relative">
                                                <input type="text" id="luyke-filter-date" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full" placeholder="Ch·ªçn ng√†y...">
    
<button id="luyke-clear-date" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-500 text-xs">B·ªè ch·ªçn</button>
                                            </div>
                      
<span id="luyke-date-summary" class="text-xs text-red-500 mt-1 block"></span>
                                        </div>
                                        <div class="md:col-span-2"><label for="luyke-filter-warehouse" class="block text-sm font-medium text-gray-600 mb-1">M√£ Kho</label><select id="luyke-filter-warehouse" class="p-2 border
rounded-lg text-sm bg-white shadow-sm w-full"></select></div>
                                        <div class="md:col-span-2"><label for="luyke-filter-department" class="block text-sm font-medium text-gray-600 mb-1">B·ªô Ph·∫≠n</label><select id="luyke-filter-department" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select></div>
                                        <div class="md:col-span-6"><label for="luyke-filter-name" class="block text-sm font-medium text-gray-600 mb-1">Nh√¢n Vi√™n</label><select id="luyke-filter-name" multiple></select></div>
         
</div>
                                    <div class="border-t pt-4 grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                        <div class="md:col-span-3"><label for="luyke-highlight-nhanhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u
ng√†nh h√†ng</label><select id="luyke-highlight-nhanhang" multiple></select></div>
                                        <div class="md:col-span-3"><label for="luyke-highlight-nhomhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√≥m h√†ng</label><select id="luyke-highlight-nhomhang" multiple></select></div>
                                        <div class="md:col-span-3"><label for="luyke-highlight-employee" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√¢n vi√™n</label><select id="luyke-highlight-employee" multiple></select></div>
            
<div class="md:col-span-3 flex items-end gap-2">
                                            <div><label for="luyke-highlight-color" class="block text-sm font-medium text-gray-600 mb-1">Ch·ªçn m√†u</label><input type="color" id="luyke-highlight-color" value="#ffff00" class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"></div>
                        
<button id="luyke-clear-highlight" class="bg-red-500 text-white px-4 h-10 rounded-lg hover:bg-red-600 transition text-sm">X√≥a m√†u</button>
                                        </div>
                                    </div>
             
</div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-8">
                    
<nav id="luyke-subtabs-nav" class="border-b border-gray-200 -mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" data-content-container="luyke-subtabs-content">
                                <button class="sub-tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-luyke-sieu-thi" data-title="SieuThiLuyKe">
                                    <i data-feather="home"></i>
                       
<span>Si√™u th·ªã L≈©y k·∫ø</span>
                                </button>
                                <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-luyke-thi-dua" data-title="ThiDuaLuyKe">
                              
<i data-feather="award"></i>
                                    <span>Thi ƒëua L≈©y k·∫ø</span>
                                </button>
                                <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-luyke-thidua-vung"
data-title="ThiDuaVung">
                                    <i data-feather="map"></i>
                                    <span>Thi ƒëua V√πng</span>
                                </button>
            
</nav>
                             <div class="flex items-center gap-x-2">
                                <button id="compose-luyke-notification-btn" class="action-btn action-btn--composer" title="Nh·∫≠n x√©t">
                                  
<i data-feather="pen-tool"></i>
                                    <span>Nh·∫≠n x√©t</span>
                                </button>
                                <button id="export-luyke-btn" class="action-btn action-btn--export" title="Xu·∫•t Excel tab hi·ªán t·∫°i">
       
<i data-feather="download"></i>
                                    <span>Xu·∫•t Excel</span>
                                </button>
                    
<button id="capture-luyke-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh tab hi·ªán t·∫°i">
                                    <i data-feather="camera"></i>
                                    <span>Ch·ª•p m√†n h√¨nh</span>
                        
</button>
                            </div>
                        </div>

                        <div id="luyke-subtabs-content">
                            <div id="subtab-luyke-sieu-thi" class="sub-tab-content space-y-8">
   
<h2 id="luyke-supermarket-title" class="text-2xl font-bold text-center text-gray-700"></h2>
                                
                                <div id="luyke-kpi-cards-container" data-capture-group="kpi" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              
<div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title">Doanh thu th·ª±c</h4>
                                        <p id="luyke-kpi-dt-thuc-main" class="font-bold mt-2 mb-3">0</p>
      
<p id="luyke-kpi-dt-thuc-sub1" class="text-sm">DK: 0 / Target: 0</p>
                                    </div>
                                    
       
<div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title">Doanh thu Quy ƒë·ªïi</h4>
                                        <p id="luyke-kpi-dt-qd-main"
class="font-bold mt-2 mb-3">0</p>
                                        <p id="luyke-kpi-dt-qd-sub1" class="text-sm">DK: 0 / Target: 0</p>
                                    </div>
                                
   
<div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title">T·ª∑ l·ªá ho√†n th√†nh Target</h4>
                                     
<p id="luyke-kpi-ht-target-qd-main" class="font-bold mt-2 mb-3">0%</p>
                                        <p id="luyke-kpi-ht-target-thuc-sub" class="text-sm">DT Th·ª±c: 0%</p>
                                    </div>
                                
    
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title">T·ª∑ l·ªá quy ƒë·ªïi</h4>
                               
<p id="luyke-kpi-tl-qd-main" class="font-bold mt-2 mb-3">0%</p>
                                        <p id="luyke-kpi-tl-qd-sub" class="text-sm">M·ª•c ti√™u: 0%</p>
                                    </div>
                          
           
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title">Doanh thu tr·∫£ ch·∫≠m</h4>
                         
<p id="luyke-kpi-dt-tc-main" class="font-bold mt-2 mb-3">0</p>
                                        <p id="luyke-kpi-dt-tc-sub" class="text-sm">% th·ª±c tr·∫£ ch·∫≠m: 0%</p>
                                    </div>
                  
                   
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title">DTQƒê Ch∆∞a xu·∫•t</h4>
                  
<p id="luyke-kpi-dtqd-chua-xuat-main" class="font-bold mt-2 mb-3">0</p>
                                    </div>
                                
                         
<div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title">Thi ƒëua ng√†nh h√†ng</h4>
                                        <p id="luyke-kpi-thidua-main" class="font-bold mt-2 mb-3">0%</p>
                
<p id="luyke-kpi-thidua-sub" class="text-sm">0/0 Ng√†nh</p>
                                    </div>
                                    
                    
<div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title">TƒÉng/gi·∫£m c√πng k·ª≥</h4>
                                        <p id="luyke-kpi-dtck-main" class="font-bold mt-2 mb-3">N/A</p>
            
<p id="luyke-kpi-dtck-sub" class="text-sm">Doanh thu: 0 | 0%</p>
                                        <p id="luyke-kpi-lkck-sub" class="text-sm">L∆∞·ª£t kh√°ch: 0 | 0%</p>
                                    </div>
   
</div>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                                    <div data-capture-group="1" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200"><h3 class="text-xl font-bold text-gray-700 mb-4 uppercase">Hi·ªáu qu·∫£ khai th√°c</h3><div
id="luyke-efficiency-content"></div></div>
                                    <div data-capture-group="1" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200"><h3 class="text-xl font-bold text-gray-700 mb-4 uppercase">Nh√≥m h√†ng quy ƒë·ªïi cao</h3><div id="luyke-qdc-content"></div></div>
                                </div>
                                <div
class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                                    <div data-capture-group="2" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200"><h3 class="text-xl font-bold text-gray-700 mb-4 uppercase">Ng√†nh h√†ng chi ti·∫øt</h3><div id="luyke-category-details-content"></div></div>
                                    <div data-capture-group="2" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200"><h3 class="text-xl font-bold uppercase mb-4">Doanh thu ch∆∞a xu·∫•t</h3><div id="luyke-unexported-revenue-content"></div></div>
          
</div>
                            </div>
                            <div id="subtab-luyke-thi-dua" class="sub-tab-content hidden space-y-4">
                                <div class="flex flex-wrap items-center justify-between
gap-4">
                                <div class="flex flex-wrap items-center gap-4">
                                    <h3 class="text-xl font-bold text-gray-800 uppercase">Thi ƒëua l≈©y k·∫ø <span id="luyke-competition-summary" class="text-sm font-normal"></span></h3>
                                    
<div id="luyke-thidua-view-selector-placeholder"></div> </div>
                                <div id="luyke-competition-content"></div>
                             </div>
                            
                           
<div id="subtab-luyke-thidua-vung" class="sub-tab-content hidden">
                                <div class="content-card">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                                        <div
class="data-input-group">
                                            <div class="flex flex-col sm:flex-row sm:items-center sm:gap-4">
                                                <label class="data-input-group__label !mb-2 sm:!mb-0 flex-shrink-0">File Thi ƒêua V√πng:</label>
               
<div class="flex items-center gap-2">
                                                    <label for="file-thidua-vung" class="data-input-group__file-trigger">Th√™m file</label>
                            
<span id="file-name-thidua-vung" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                                </div>
                                           
</div>
                                            <input type="file" id="file-thidua-vung" class="hidden file-input" data-name="Thi ƒëua v√πng" accept=".xlsx, .xls, .csv">
                                            <div class="data-input-group__status-wrapper mt-2"><span id="file-status-thidua-vung" class="data-input-group__status-text"></span></div>
                
</div>
                                        <div>
                                            <label for="thidua-vung-filter-supermarket" class="block text-sm font-medium text-gray-600 mb-1">Ch·ªçn Si√™u th·ªã</label>
   
<select id="thidua-vung-filter-supermarket"></select>
                                        </div>
                                    </div>
 
</div>
                                <div id="thidua-vung-infographic-container">
                                     <div class="placeholder-message">Vui l√≤ng t·∫£i file v√† ch·ªçn m·ªôt si√™u th·ªã ƒë·ªÉ xem b√°o c√°o.</div>
     
</div>
                            </div>
                        </div>
                    </div>
                </section>
    
<section id="health-employee-section" class="page-section hidden">
                    <div id="health-employee-section-placeholder" class="placeholder-message hidden">Vui l√≤ng c·∫≠p nh·∫≠t danh s√°ch nh√¢n vi√™n ƒë·ªÉ xem k·∫øt qu·∫£.</div>
                    <div id="health-employee-section-content">
                        <div class="content-card">
                        
<div class="page-header border-b pb-4 mb-6">
                                <h2 class="page-header__title">S·ª©c kh·ªèe nh√¢n vi√™n</h2>
                                <button class="page-header__help-btn" data-help-id="sknv" title="Xem h∆∞·ªõng d·∫´n">
                                    <i data-feather="help-circle"></i>
 
</button>
                            </div>

                            <button class="toggle-filters-btn" data-target="sknv-filter-container">
                              
<span class="text">Hi·ªán b·ªô l·ªçc n√¢ng cao</span>
                                <i data-feather="chevron-down" class="icon"></i>
                            </button>
                            <div id="sknv-filter-container" class="advanced-filters hidden">
                   
<div id="sknv-filter-bar" class="p-4 bg-slate-50 border border-slate-200 rounded-lg space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                        <div class="md:col-span-2">
                 
<label for="sknv-filter-date" class="block text-sm font-medium text-gray-600 mb-1">Ng√†y t·∫°o</label>
                                            <div class="relative">
                                        
<input type="text" id="sknv-filter-date" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full" placeholder="Ch·ªçn ng√†y...">
                                                <button id="sknv-clear-date" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-500 text-xs">B·ªè ch·ªçn</button>
                                           
</div>
                                            <span id="sknv-date-summary" class="text-xs text-red-500 mt-1 block"></span>
                                        </div>
                             
<div class="md:col-span-2"><label for="sknv-filter-warehouse" class="block text-sm font-medium text-gray-600 mb-1">M√£ Kho</label><select id="sknv-filter-warehouse" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select></div>
                                        <div class="md:col-span-2"><label for="sknv-filter-department" class="block text-sm font-medium text-gray-600 mb-1">B·ªô Ph·∫≠n</label><select id="sknv-filter-department" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select></div>
                                    
<div class="md:col-span-6"><label for="sknv-filter-name" class="block text-sm font-medium text-gray-600 mb-1">Nh√¢n Vi√™n</label><select id="sknv-filter-name" multiple></select></div>
                                    </div>
                                    <div class="border-t pt-4 grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                          
<div class="md:col-span-3"><label for="sknv-highlight-nhanhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u ng√†nh h√†ng</label><select id="sknv-highlight-nhanhang" multiple></select></div>
                                        <div class="md:col-span-3"><label for="sknv-highlight-nhomhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√≥m h√†ng</label><select id="sknv-highlight-nhomhang" multiple></select></div>
                                        <div
class="md:col-span-3"><label for="sknv-highlight-employee" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√¢n vi√™n</label><select id="sknv-highlight-employee" multiple></select></div>
                                        <div class="md:col-span-3 flex items-end gap-2">
                                            <div><label for="sknv-highlight-color" class="block text-sm font-medium text-gray-600 mb-1">Ch·ªçn m√†u</label><input type="color" id="sknv-highlight-color" value="#ffff00" class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"></div>
 
<button id="sknv-clear-highlight" class="bg-red-500 text-white px-4 h-10 rounded-lg hover:bg-red-600 transition text-sm">X√≥a m√†u</button>
                                        </div>
                          
</div>
                                </div>
                            </div>
                        </div>
                        
 
<div class="content-card">
                            <div class="flex justify-between items-center mb-8">
                                <nav id="employee-subtabs-nav" class="border-b border-gray-200 -mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" data-content-container="employee-subtabs-content">
                                    <button class="sub-tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-sknv" data-title="SKNV">
                                        <i data-feather="users"></i>
                                        <span>SKNV</span>
                                    </button>
                                    <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-doanhthu-lk" data-title="DoanhThuLK">
                                        <i data-feather="dollar-sign"></i>
                                        <span>Doanh thu LK</span>
                                    </button>
                                    <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-thunhap" data-title="ThuNhap">
                                        <i data-feather="briefcase"></i>
                                        <span>Thu nh·∫≠p</span>
                                    </button>
                                    <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-hieu-qua-khai-thac-luy-ke" data-title="HieuQuaKhaiThacLuyKe">
                                        <i data-feather="bar-chart-2"></i>
                                        <span>Hi·ªáu qu·∫£ NV LK</span>
                                    </button>
                                    <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-doanhthu-nganhhang" data-title="DTNganhHang">
                                        <i data-feather="layers"></i>
                                        <span>DT ng√†nh h√†ng</span>
                                    </button>
                                    <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-hieu-qua-thi-dua-lk" data-title="HieuQuaThiDuaLK">
                                        <i data-feather="award"></i>
                                        <span>Thi ƒëua NV LK</span>
                                    </button>
                                </nav>
                                 <div class="flex items-center gap-x-2">
                                     <button id="compose-sknv-notification-btn" class="action-btn action-btn--composer" title="Nh·∫≠n x√©t">
                                        <i data-feather="pen-tool"></i>
                                        <span>Nh·∫≠n x√©t</span>
                                    </button>
                                    <button id="export-sknv-btn" class="action-btn action-btn--export" title="Xu·∫•t Excel tab hi·ªán t·∫°i">
                                        <i data-feather="download"></i>
                                        <span>Xu·∫•t Excel</span>
                                    </button>
                                    <button id="capture-sknv-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh tab hi·ªán t·∫°i">
                                        <i data-feather="camera"></i>
                                        <span>Ch·ª•p m√†n h√¨nh</span>
                                    </button>
                                </div>
                            </div>
    
<div id="employee-subtabs-content">
                                <div id="subtab-sknv" class="sub-tab-content">
                                    <div id="sknv-summary-container"></div>
                       
<div id="sknv-details-container" class="mt-6 hidden">
                                        <p class="text-gray-500">Vui l√≤ng ch·ªçn m·ªôt nh√¢n vi√™n ƒë·ªÉ xem chi ti·∫øt.</p>
                                    </div>
                 
</div>
                                <div id="subtab-doanhthu-lk" class="sub-tab-content hidden space-y-6" data-capture-preset="landscape-table">
                                    <div id="revenue-report-container-lk"></div>
                              
<div id="dtnv-lk-details-container"></div>
                                </div>
                                <div id="subtab-thunhap" class="sub-tab-content hidden space-y-6" data-capture-preset="landscape-table">
                                    <div id="income-report-placeholder">
     
<p class="text-gray-500 mb-4">Vui l√≤ng t·∫£i ƒë·ªß c√°c file: <b>Danh s√°ch nh√¢n vi√™n, Y√™u c·∫ßu xu·∫•t l≈©y k·∫ø, Gi·ªù c√¥ng, Th∆∞·ªüng n√≥ng</b> v√† x·ª≠ l√Ω <b>Th∆∞·ªüng ERP</b> ·ªü tab Data ƒë·ªÉ xem b√°o c√°o thu nh·∫≠p.</p>
                                    </div>
              
<div id="income-report-container"></div>
                                </div>
                                <div id="subtab-hieu-qua-khai-thac-luy-ke" class="sub-tab-content hidden space-y-6" data-capture-preset="landscape-table">
                           
<div id="efficiency-report-container"></div>
                                </div>
                                <div id="subtab-doanhthu-nganhhang" class="sub-tab-content hidden space-y-6" data-capture-preset="mobile-portrait">
                                    <div id="category-revenue-report-container"></div>
  
</div>
                                <div id="subtab-hieu-qua-thi-dua-lk" class="sub-tab-content hidden space-y-6">
                                    <div id="competition-report-container-lk" class="mt-4">
               
<p class="text-gray-500">Vui l√≤ng khai b√°o ch∆∞∆°ng tr√¨nh thi ƒëua trong "Thi·∫øt l·∫≠p m·ª•c ti√™u" ƒë·ªÉ xem b√°o c√°o.</p>
                                    </div>
                                </div>
         
</div>
                        </div>
                    </div>
                </section>
                <section id="realtime-section" class="page-section hidden">
                    <div
id="realtime-section-placeholder" class="placeholder-message hidden">Vui l√≤ng c·∫≠p nh·∫≠t danh s√°ch nh√¢n vi√™n ƒë·ªÉ xem k·∫øt qu·∫£.</div>
                    <div id="realtime-section-content">
                        <div class="content-card">
                            <div class="page-header border-b pb-4 mb-6">
                            
<div class="flex items-center gap-x-3">
                                    <h2 class="page-header__title">Ph√¢n T√≠ch Doanh Thu Realtime</h2>
                                    <button class="page-header__help-btn" data-help-id="realtime" title="Xem h∆∞·ªõng d·∫´n">
                              
<i data-feather="help-circle"></i>
                                    </button>
                                </div>
                                <div class="flex-shrink-0 flex items-center gap-x-4 ml-auto">
   
<label for="realtime-file-input" class="cursor-pointer bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm font-medium whitespace-nowrap">Th√™m file Realtime</label>
                                    <input type="file" id="realtime-file-input" class="hidden" accept=".xlsx, .xls, .csv">
                              
<a href="https://report.mwgroup.vn/home/dashboard/077" target="_blank" class="text-blue-600 hover:underline whitespace-nowrap text-sm">L·∫•y file t·∫°i ƒë√¢y</a>
                                </div>
                            </div>

                            <button class="toggle-filters-btn" data-target="realtime-filter-container">
              
<span class="text">Hi·ªán b·ªô l·ªçc n√¢ng cao</span>
                                <i data-feather="chevron-down" class="icon"></i>
                            </button>
                            <div id="realtime-filter-container" class="advanced-filters hidden">
   
<div id="realtime-filter-bar" class="p-4 bg-slate-50 border border-slate-200 rounded-lg space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                        <div class="md:col-span-3"><label
for="realtime-filter-warehouse" class="block text-sm font-medium text-gray-600 mb-1">M√£ Kho</label><select id="realtime-filter-warehouse" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select></div>
                                        <div class="md:col-span-3"><label for="realtime-filter-department" class="block text-sm font-medium text-gray-600 mb-1">B·ªô Ph·∫≠n</label><select id="realtime-filter-department" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select></div>
                                        <div class="md:col-span-6"><label for="realtime-filter-name" class="block text-sm font-medium text-gray-600 mb-1">Nh√¢n Vi√™n</label><select
id="realtime-filter-name" multiple></select></div>
                                    </div>
                                    <div class="border-t pt-4 grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                       
<div class="md:col-span-3"><label for="realtime-highlight-nhanhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u ng√†nh h√†ng</label><select id="realtime-highlight-nhanhang" multiple></select></div>
                                        <div class="md:col-span-3"><label for="realtime-highlight-nhomhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√≥m h√†ng</label><select id="realtime-highlight-nhomhang" multiple></select></div>
                                        <div class="md:col-span-3"><label for="realtime-highlight-employee" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√¢n vi√™n</label><select id="realtime-highlight-employee" multiple></select></div>
  
<div class="md:col-span-3 flex items-end gap-2">
                                            <div><label for="realtime-highlight-color" class="block text-sm font-medium text-gray-600 mb-1">Ch·ªçn m√†u</label><input type="color" id="realtime-highlight-color" value="#ffff00" class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"></div>
              
<button id="realtime-clear-highlight" class="bg-red-500 text-white px-4 h-10 rounded-lg hover:bg-red-600 transition text-sm">X√≥a m√†u</button>
                                        </div>
                                    </div>
   
</div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-8">
          
<nav id="realtime-subtabs-nav" class="border-b border-gray-200 -mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" data-content-container="realtime-subtabs-content">
                                <button class="sub-tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-realtime-sieu-thi" data-title="SieuThiRealtime">
                                    <i data-feather="zap"></i>
             
<span>Si√™u th·ªã Realtime</span>
                                </button>
                                <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-realtime-nhan-vien" data-title="DTNVRealtime">
                     
<i data-feather="pie-chart"></i>
                                    <span>DT NV Realtime</span>
                                </button>
                                <button
class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-realtime-hieu-qua" data-title="HieuQuaKhaiThacRealtime">
                                    <i data-feather="bar-chart-2"></i>
                                    <span>Hi·ªáu qu·∫£ NV Realtime</span>
                                </button>
   
<button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-realtime-nganh-hang" data-title="NganhHangRealtime">
                                    <i data-feather="tag"></i>
                                    <span>Ng√†nh h√†ng Realtime</span>
      
</button>
                                <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-realtime-hang" data-title="HangRealtime">
                                    <i data-feather="globe"></i>
               
<span>DT H√£ng Realtime</span>
                                </button>
                                <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-hieu-qua-thi-dua-realtime" data-title="HieuQuaThiDuaRealtime">
                       
<i data-feather="award"></i>
                                    <span>Thi ƒëua NV Realtime</span>
                                </button>
                            </nav>
      
<div class="flex items-center gap-x-2">
                                <button id="compose-realtime-notification-btn" class="action-btn action-btn--composer" title="Nh·∫≠n x√©t">
                                    <i data-feather="pen-tool"></i>
                    
<span>Nh·∫≠n x√©t</span>
                                </button>
                                <button id="export-realtime-btn" class="action-btn action-btn--export" title="Xu·∫•t Excel tab hi·ªán t·∫°i">
                              
<i data-feather="download"></i>
                                    <span>Xu·∫•t Excel</span>
                                </button>
                                <button id="capture-realtime-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh tab hi·ªán t·∫°i">
   
<i data-feather="camera"></i>
                                    <span>Ch·ª•p m√†n h√¨nh</span>
                                </button>
               
</div>
                        </div>

                        <div id="realtime-subtabs-content">
                            <div id="subtab-realtime-sieu-thi" class="sub-tab-content space-y-8">
                          
<h2 id="realtime-supermarket-title" class="text-2xl font-bold text-center text-gray-700"></h2>
                                <div id="realtime-kpi-cards-container" data-capture-group="kpi" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg">
                             
<h4 class="kpi-card-title font-semibold uppercase tracking-wider">Doanh thu th·ª±c</h4>
                                        <p id="rt-kpi-dt-thuc-main" class="font-bold mt-2 mb-3">0</p>
                                        <p id="rt-kpi-dt-thuc-sub1" class="text-sm">% HT: <span class="kpi-percentage-value">0%</span> / Target: 0</p>
          
<p id="rt-kpi-dt-thuc-sub2" class="text-sm mt-1">DT Ch∆∞a xu·∫•t: 0</p>
                                    </div>
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg">
       
<h4 class="kpi-card-title font-semibold uppercase tracking-wider">Doanh thu Quy ƒë·ªïi</h4>
                                        <p id="rt-kpi-dt-qd-main" class="font-bold mt-2 mb-3">0</p>
                                   
<p id="rt-kpi-dt-qd-sub1" class="text-sm">% HT: <span class="kpi-percentage-value">0%</span> / Target: 0</p>
                                        <p id="rt-kpi-dt-qd-sub2" class="text-sm mt-1">DTQƒê Ch∆∞a xu·∫•t: 0</p>
                                    </div>
                        
<div class="kpi-card p-6 rounded-2xl shadow-lg">
                                        <h4 class="kpi-card-title font-semibold uppercase tracking-wider">T·ª∑ l·ªá quy ƒë·ªïi</h4>
                                        <p id="rt-kpi-tl-qd-main" class="font-bold mt-2 mb-3 kpi-percentage-value">0%</p>
           
<p id="rt-kpi-tl-qd-sub" class="text-sm">M·ª•c ti√™u: 0%</p>
                                    </div>
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg">
          
<h4 class="kpi-card-title font-semibold uppercase tracking-wider">Doanh thu tr·∫£ ch·∫≠m</h4>
                                        <p id="rt-kpi-dt-tc-main" class="font-bold mt-2 mb-3">0</p>
                                      
<p id="rt-kpi-dt-tc-sub" class="text-sm">% th·ª±c tr·∫£ ch·∫≠m: <span class="kpi-percentage-value">0%</span></p>
                                    </div>
                                </div>
                                
          
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                                    <div id="realtime-qdc-panel" data-capture-group="1" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200">
                                        <h3 id="realtime-qdc-title" class="text-xl font-bold text-gray-700 mb-4 uppercase
flex items-center gap-2"><span>NH√ìM H√ÄNG QUY ƒê·ªîI CAO</span></h3>
                                        <div id="realtime-qdc-content"><p class="text-gray-500 font-bold">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p></div>
                                    </div>
                          
<div id="realtime-category-panel" data-capture-group="1" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200">
                                        <h3 id="realtime-category-title" class="text-xl font-bold text-gray-700 mb-4 uppercase flex items-center gap-2">
                                            <span>NG√ÄNH H√ÄNG CHI TI·∫æT</span>
    
</h3>
                                        <div id="realtime-category-details-content"><p class="text-gray-500 font-bold">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p></div>
                                
</div>
                                </div>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                                    <div id="realtime-efficiency-panel" data-capture-group="2" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200">
 
<h3 id="realtime-efficiency-title" class="text-xl font-bold text-gray-700 mb-4 uppercase bg-yellow-100 text-yellow-800 p-2 rounded-md">HI·ªÜU QU·∫¢ KHAI TH√ÅC</h3>
                                        <div id="realtime-efficiency-content"><p class="text-gray-500 font-bold">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p></div>
                
</div>
                                    <div id="realtime-unexported-revenue-panel" data-capture-group="2" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200 flex flex-col">
                                         <h3 class="text-xl font-bold uppercase mb-4 bg-red-100 text-red-800 p-2 rounded-md">DOANH THU CH∆ØA
XU·∫§T</h3>
                                        <div id="realtime-unexported-revenue-content" class="flex-grow"><p class="text-gray-500 font-bold text-center">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p></div>
                                    </div>
                              
</div>
                            </div>

                            <div id="subtab-realtime-nhan-vien" class="sub-tab-content hidden space-y-4" data-capture-preset="large-font-report">
                                <div id="realtime-employee-detail-container"></div>
                       
<div id="realtime-revenue-report-container"></div>
                            </div>
                            <div id="subtab-realtime-hieu-qua" class="sub-tab-content hidden space-y-4" data-capture-preset="landscape-table">
                                <div id="realtime-efficiency-report-container"></div>
               
</div>
                            <div id="subtab-realtime-nganh-hang" class="sub-tab-content hidden space-y-4" data-capture-preset="mobile-portrait">
                                <div id="realtime-category-revenue-report-container"></div>
                            </div>
            
<div id="subtab-realtime-hang" class="sub-tab-content hidden space-y-4">
                                <div class="content-card" data-capture-group="1">
                                     <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                      
<h3 class="text-xl font-bold text-gray-700 uppercase">Th·ªëng k√™ theo H√£ng</h3>
                                        <div id="dthang-realtime-view-selector" class="view-switcher">
                                            <button data-view="brand" class="view-switcher__btn active">Theo H√£ng</button>
    
<button data-view="employee" class="view-switcher__btn">Theo Nh√¢n vi√™n</button>
                                        </div>
                                   
</div>
                                    <div class="flex flex-wrap items-center gap-4 mb-4">
                                        <div>
                                     
<label for="realtime-brand-category-filter" class="font-semibold text-sm text-gray-600">Ng√†nh h√†ng:</label>
                                            <select id="realtime-brand-category-filter" class="p-2 border rounded-lg text-sm bg-white shadow-sm mt-1"></select>
                                        </div>
               
<div>
                                            <label for="realtime-brand-filter" class="font-semibold text-sm text-gray-600">H√£ng:</label>
                                            <select id="realtime-brand-filter"
class="p-2 border rounded-lg text-sm bg-white shadow-sm mt-1"></select>
                                        </div>
                                    </div>
                                    
 
<div id="realtime-brand-report-container">
                                        <div id="realtime-brand-table-container"></div>
                                        <div id="realtime-employee-table-container"
class="hidden"></div>
                                    </div>
                                </div>
                            </div>
                       
<div id="subtab-hieu-qua-thi-dua-realtime" class="sub-tab-content hidden space-y-6">
                                <div id="competition-report-container-rt">
                                    <p class="text-gray-500">Vui l√≤ng khai b√°o ch∆∞∆°ng tr√¨nh thi ƒëua trong "Thi·∫øt l·∫≠p m·ª•c ti√™u" ƒë·ªÉ xem b√°o c√°o.</p>
                        
</div>
                            </div>
                            </div>
                    </div>
                </section>

                <section id="declaration-section" class="page-section
hidden">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">Khai b√°o d·ªØ li·ªáu</h2>
                    <div class="content-card">
                        <p class="text-sm text-yellow-600 bg-yellow-50 p-3 rounded-lg mb-4">L∆∞u √Ω: D·ªØ li·ªáu khai b√°o t·∫°i ƒë√¢y s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o tr√¨nh duy·ªát v√† s·ª≠ d·ª•ng cho c√°c logic t√≠nh to√°n. Ch·ªânh s·ª≠a v√† nh·∫•n "L∆∞u" ƒë·ªÉ c·∫≠p nh·∫≠t.</p>
           
                        <div class="space-y-8">
                            <div>
                                <h3 class="text-lg font-bold text-gray-700 mb-2 border-b pb-2">Khai b√°o Danh m·ª•c & C·∫•u tr√∫c</h3>
         
<div class="grid md:grid-cols-2 gap-6 mt-4">
                                    <div class="data-input-group">
                                        <label class="data-input-group__label">Danh m·ª•c Ng√†nh h√†ng - Nh√≥m h√†ng - H√£ng:</label>
      
<div class="data-input-group__content">
                                            <div class="flex items-center gap-2">
                                     
<label for="file-category-structure" class="data-input-group__file-trigger">Th√™m file Excel</label>
                                                <span id="file-name-category-structure" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                            </div>
        
<p class="text-xs text-gray-500">File Excel c√≥ 2 sheet: sheet ƒë·∫ßu ti√™n c√≥ c·ªôt "Ng√†nh h√†ng", "Nh√≥m h√†ng"; sheet th·ª© hai t√™n l√† "H√£ng" c√≥ 1 c·ªôt ch·ª©a t√™n c√°c h√£ng.</p>
                                            <input type="file" id="file-category-structure" class="hidden file-input" data-name="Danh m·ª•c Ng√†nh/Nh√≥m h√†ng" data-state-key="categoryStructure" data-save-key="saved_category_structure"
accept=".xlsx, .xls, .csv">
                                            <div class="data-input-group__status-wrapper">
                                                <span id="file-status-category-structure" class="data-input-group__status-text"></span>
                      
<span id="category-structure-saved-status" class="data-input-group__status-text"></span>
                                            </div>
                                            <div id="progress-category-structure" class="progress-bar-container
hidden"><div class="progress-bar"></div></div>
                                        </div>
                                    </div>
                                </div>
          
</div>

                            <div class="border-t pt-8">
                                <h3 class="text-lg font-bold text-gray-700 mb-2 border-b pb-2">D·ªØ li·ªáu t√≠nh to√°n</h3>
                              
<div class="grid md:grid-cols-2 gap-6 mt-4">
                                    <div>
                                        <label for="declaration-ycx" class="block text-md font-semibold text-gray-700 mb-2">H√¨nh th·ª©c xu·∫•t (T√≠nh doanh thu)</label>
                          
<textarea id="declaration-ycx" rows="8" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm" placeholder="D√°n danh s√°ch c√°c lo·∫°i YCX v√†o ƒë√¢y, m·ªói lo·∫°i m·ªôt d√≤ng..."></textarea>
                                    </div>
                                    <div>
          
<label for="declaration-ycx-gop" class="block text-md font-semibold text-gray-700 mb-2">H√¨nh th·ª©c xu·∫•t (Tr·∫£ g√≥p)</label>
                                        <textarea id="declaration-ycx-gop" rows="8" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm" placeholder="D√°n danh s√°ch c√°c lo·∫°i YCX G√≥p v√†o ƒë√¢y, m·ªói lo·∫°i m·ªôt d√≤ng..."></textarea>
               
</div>
                                    <div class="md:col-span-2">
                                        <label for="declaration-heso" class="block text-md font-semibold text-gray-700 mb-2">H·ªá s·ªë quy ƒë·ªïi</label>
            
<textarea id="declaration-heso" rows="8" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm" placeholder="D√°n danh s√°ch h·ªá s·ªë quy ƒë·ªïi v√†o ƒë√¢y, ƒë·ªãnh d·∫°ng: T√™n nh√≥m h√†ng,H·ªá s·ªë"></textarea>
                                    </div>
                             
</div>
                                <div class="mt-4">
                                    <button id="save-declaration-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition">L∆∞u D·ªØ li·ªáu t√≠nh to√°n</button>
                                </div>
   
</div>

                            <div class="border-t pt-8">
                                <h3 class="text-lg font-bold text-gray-700 mb-2 border-b pb-2">N·ªôi dung H∆∞·ªõng d·∫´n</h3>
                       
<div class="grid md:grid-cols-1 gap-6 mt-4">
                                    <div>
                                        <label for="edit-help-data" class="block text-md font-semibold text-gray-700 mb-2">H∆∞·ªõng d·∫´n Tab C·∫≠p nh·∫≠t d·ªØ li·ªáu</label>
                  
<textarea id="edit-help-data" rows="6" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Nh·∫≠p n·ªôi dung h∆∞·ªõng d·∫´n cho tab C·∫≠p nh·∫≠t d·ªØ li·ªáu..."></textarea>
                                    </div>
                                     <div>
   
<label for="edit-help-luyke" class="block text-md font-semibold text-gray-700 mb-2">H∆∞·ªõng d·∫´n Tab L≈©y k·∫ø</label>
                                        <textarea id="edit-help-luyke" rows="6" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Nh·∫≠p n·ªôi dung h∆∞·ªõng d·∫´n cho tab L≈©y k·∫ø..."></textarea>
             
</div>
                                    <div>
                                        <label for="edit-help-sknv" class="block text-md font-semibold text-gray-700 mb-2">H∆∞·ªõng d·∫´n Tab S·ª©c kh·ªèe NV</label>
         
<textarea id="edit-help-sknv" rows="6" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Nh·∫≠p n·ªôi dung h∆∞·ªõng d·∫´n cho tab S·ª©c kh·ªèe NV..."></textarea>
                                    </div>
                                
<div>
                                        <label for="edit-help-realtime" class="block text-md font-semibold text-gray-700 mb-2">H∆∞·ªõng d·∫´n Tab Realtime</label>
                                        <textarea id="edit-help-realtime" rows="6" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Nh·∫≠p n·ªôi dung h∆∞·ªõng d·∫´n cho tab Realtime..."></textarea>
        
</div>
                                </div>
                                <div class="mt-4">
                          
<button id="save-help-content-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">L∆∞u H∆∞·ªõng d·∫´n</button>
                                </div>
                            </div>
                        </div>
               
</div>
                </section>

            </div>
        </main>
    </div>

    <div id="modal-force-update-container"></div>
    <div id="notification"></div>
    <div id="modal-admin-container"></div>
    <div id="modal-help-container"></div>
    <div id="modal-chart-container"></div>
    <div id="modal-composer-container"></div>
    <div id="modal-preview-container"></div>
    <div id="modal-selection-container"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tailwindScript = document.querySelector('script[src="https://cdn.tailwindcss.com"]');
if (tailwindScript && window.location.protocol !== "file:") {
                console.warn("cdn.tailwindcss.com should not be used in production. To use Tailwind CSS in production, install it as a PostCSS plugin or use the Tailwind CLI: https://tailwindcss.com/docs/installation");
            }
        });
    </script>
    <script type="module" src="./main.js?v=3.5"></script>

</body>
</html>
--- END FILE: ./index.html ---

--- START FILE: ./main.js ---
// Version 3.6 - Refactor: Update imports to use uiRealtime module directly
// MODULE 5: B·ªò ƒêI·ªÄU KHI·ªÇN TRUNG T√ÇM (MAIN)
// File n√†y ƒë√≥ng vai tr√≤ ƒëi·ªÅu ph·ªëi, nh·∫≠p kh·∫©u c√°c module kh√°c v√† kh·ªüi ch·∫°y ·ª©ng d·ª•ng.

import { config } from './config.js';
import { appState } from './state.js';
import { services } from './services.js';
import { ui } from './ui.js';
import { firebase } from './firebase.js';
import { auth } from './auth.js';
import { luykeTab } from './tab-luyke.js';
import { sknvTab } from './tab-sknv.js';
import { uiRealtime } from './ui-realtime.js'; // <<< FIX: IMPORT MODULE M·ªöI
import { initializeEventListeners } from './event-listeners/ui-listeners.js';
import { sidebar } from './components/sidebar.js';
import { storage } from './modules/storage.js';
import { drawerInterface } from './components/drawer-interface.js';
import { drawerGoal } from './components/drawer-goal.js';
import { modalForceUpdate } from './components/modal-force-update.js';
import { modalAdmin } from './components/modal-admin.js';
import { modalHelp } from './components/modal-help.js';
import { modalChart } from './components/modal-chart.js';
import { modalComposer } from './components/modal-composer.js';
import { modalPreview } from './components/modal-preview.js';
import { modalSelection } from './components/modal-selection.js';
import { settingsService } from './modules/settings.service.js';
import { highlightService } from './modules/highlight.service.js';

const app = {
    currentVersion: '3.5',
    storage: storage,

    async init() {
        try {
            appState.competitionConfigs = [];
            appState.viewingDetailFor = null;

            await firebase.init();
            auth.init();

            // Render static UI components
            sidebar.render('#sidebar-container');
            drawerInterface.render('#interface-drawer-container');
            drawerGoal.render('#goal-drawer-container');
            modalForceUpdate.render('#modal-force-update-container');
            modalAdmin.render('#modal-admin-container');
            modalHelp.render('#modal-help-container');
            modalChart.render('#modal-chart-container');
            modalComposer.render('#modal-composer-container');
            modalPreview.render('#modal-preview-container');
            modalSelection.render('#modal-selection-container');

            // === G·ªåI L·ªÜNH V·∫º ICON SAU KHI RENDER COMPONENT ===
            feather.replace();

            this.loadAndApplyBookmarkLink();
            this.loadAndDisplayQrCode(); 
            this.setupMarquee();

            await this.storage.openDB();

            // === START: T·∫¢I T·∫§T C·∫¢ D·ªÆ LI·ªÜU T·ª™ FIRESTORE ===
            console.log("Loading category data from Firestore...");
            const { categories, brands } = await firebase.loadCategoryDataFromFirestore();
            appState.categoryStructure = categories;
            appState.brandList = brands;
            console.log(`Successfully populated ${appState.categoryStructure.length} categories and ${appState.brandList.length} brands from Firestore.`);
            
            console.log("Loading calculation declarations from Firestore...");
            const declarations = await firebase.loadDeclarationsFromFirestore();
            appState.declarations = declarations;
            document.getElementById('declaration-ycx').value = declarations.hinhThucXuat || config.DEFAULT_DATA.HINH_THUC_XUAT_TINH_DOANH_THU.join('\n');
            document.getElementById('declaration-ycx-gop').value = declarations.hinhThucXuatGop || config.DEFAULT_DATA.HINH_THUC_XUAT_TRA_GOP.join('\n');
            document.getElementById('declaration-heso').value = declarations.heSoQuyDoi || Object.entries(config.DEFAULT_DATA.HE_SO_QUY_DOI).map(([k, v]) => `${k},${v}`).join('\n');
            // === END: T·∫¢I T·∫§T C·∫¢ D·ªÆ LI·ªÜU T·ª™ FIRESTORE ===

            initializeEventListeners(this);
            await this.loadDataFromStorage();

            settingsService.loadInterfaceSettings();
            settingsService.applyContrastSetting();
            settingsService.loadHighlightSettings();

            ui.populateAllFilters();

            settingsService.loadAndApplyLuykeGoalSettings();
            settingsService.loadAndApplyRealtimeGoalSettings();

            this.loadPastedDataFromStorage();

            this.switchTab('data-section');
            this.checkForUpdates();
            setInterval(() => this.checkForUpdates(), 15 * 60 * 1000);
        } catch (error) {
            console.error("L·ªói nghi√™m tr·ªçng trong qu√° tr√¨nh kh·ªüi t·∫°o ·ª©ng d·ª•ng:", error);
        }
    },

    async setupMarquee() {
        const marqueeContainer = document.getElementById('version-marquee-container');
        const marqueeText = marqueeContainer?.querySelector('.marquee-text');

        if (!marqueeContainer || !marqueeText) return;

        try {
            const versionRes = await fetch(`./version.json?v=${new Date().getTime()}`);
            const versionInfo = await versionRes.json();
            const currentVersion = versionInfo.version || this.currentVersion;
            marqueeText.textContent = `üî• Chi ti·∫øt b·∫£n c·∫≠p nh·∫≠t - Phi√™n b·∫£n ${currentVersion}`;

            marqueeContainer.addEventListener('click', async () => {
                try {
                     const changelogRes = await fetch(`./changelog.json?v=${new Date().getTime()}`);
                    const changelogData = await changelogRes.json();
                    
                    const modalTitle = document.getElementById('help-modal-title');
                    const modalContent = document.getElementById('help-modal-content');

                     if (modalTitle) modalTitle.textContent = "L·ªãch S·ª≠ C·∫≠p Nh·∫≠t";
                    if (modalContent) {
                        modalContent.innerHTML = this._formatChangelogForModal(changelogData);
                    }
                   
                     ui.toggleModal('help-modal', true);

                } catch (error) {
                    console.error("L·ªói khi t·∫£i ho·∫∑c hi·ªÉn th·ªã changelog:", error);
                    ui.showNotification("Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt c·∫≠p nh·∫≠t.", "error");
                }
            });

        } catch (error) {
             console.error("L·ªói khi thi·∫øt l·∫≠p marquee:", error);
            marqueeText.textContent = "Kh√¥ng th·ªÉ t·∫£i th√¥ng tin phi√™n b·∫£n.";
        }
    },

    _formatChangelogForModal(changelogData) {
        if (!changelogData || changelogData.length === 0) {
            return '<p>Kh√¥ng c√≥ l·ªãch s·ª≠ c·∫≠p nh·∫≠t.</p>';
        }
        return changelogData.map(item => `
            <div class="mb-4 pb-4 border-b last:border-b-0">
                <h4 class="font-bold text-blue-600 mb-2">Phi√™n b·∫£n ${item.version} (${item.date})</h4>
                <ul class="list-disc list-inside text-gray-700 space-y-1 text-sm">
                    ${item.notes.map(note => `<li>${note}</li>`).join('')}
                </ul>
            </div>
        `).join('');
    },
    
    async checkForUpdates() {
        try {
            const response = await fetch(`./version.json?v=${new Date().getTime()}`);
            if (!response.ok) return;
            const serverConfig = await response.json();
            
            if (serverConfig.version && serverConfig.version !== this.currentVersion) {
                console.log(`Phi√™n b·∫£n m·ªõi ${serverConfig.version} ƒë√£ s·∫µn s√†ng!`);

                const changelogRes = await fetch(`./changelog.json?v=${new Date().getTime()}`);
                const changelogData = await changelogRes.json();
                const newVersionDetails = changelogData.find(log => log.version === serverConfig.version);

                const titleEl = document.getElementById('force-update-title');
                const notesContainer = document.getElementById('update-notes-container');

                if (titleEl) {
                    titleEl.textContent = `üì¢ ƒê√£ c√≥ phi√™n b·∫£n m·ªõi ${serverConfig.version}!`;
                }

                if (notesContainer && newVersionDetails && newVersionDetails.notes) {
                    notesContainer.innerHTML = `
                        <p class="text-sm font-semibold text-gray-700 mb-2">N·ªôi dung c·∫≠p nh·∫≠t:</p>
                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            ${newVersionDetails.notes.map(note => `<li>${note}</li>`).join('')}
                        </ul>
                    `;
                } else if (notesContainer) {
                    notesContainer.innerHTML = '<p class="text-sm text-gray-500">Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt c·∫≠p nh·∫≠t.</p>';
                }
                
                ui.toggleModal('force-update-modal', true);
            }
        } catch (error) {
            console.error('Kh√¥ng th·ªÉ ki·ªÉm tra phi√™n b·∫£n m·ªõi:', error);
        }
    },

    async loadDataFromStorage() {
        const loadSavedFile = async (saveKey, stateKey, fileType, uiId) => {
            if (saveKey === 'saved_category_structure') {
                if (appState.categoryStructure.length > 0 || appState.brandList.length > 0) {
                     ui.updateFileStatus('category-structure', 'T·∫£i t·ª´ Cloud', `‚úì ƒê√£ t·∫£i ${appState.categoryStructure.length} nh√≥m & ${appState.brandList.length} h√£ng.`, 'success');
                }
                return;
            }

            const savedData = await this.storage.getItem(saveKey);
            if (!savedData) return;

            try {
                const { normalizedData, success } = services.normalizeData(savedData, fileType);
                if (success) {
                    appState[stateKey] = normalizedData;
                    ui.updateFileStatus(uiId, '', `‚úì ƒê√£ t·∫£i ${normalizedData.length} d√≤ng.`, 'success');
                }
             } catch (e) { console.error(`L·ªói ƒë·ªçc ${uiId} t·ª´ IndexedDB:`, e); }
        };

        await loadSavedFile('saved_danhsachnv', 'danhSachNhanVien', 'danhsachnv', 'danhsachnv');
        if (appState.danhSachNhanVien.length > 0) {
            services.updateEmployeeMaps();
        }
        await loadSavedFile('saved_category_structure', null, null, null);
        await loadSavedFile('saved_ycx_thangtruoc', 'ycxDataThangTruoc', 'ycx', 'ycx-thangtruoc');
        await loadSavedFile('saved_thuongnong_thangtruoc', 'thuongNongDataThangTruoc', 'thuongnong', 'thuongnong-thangtruoc');
        await loadSavedFile('saved_ycx', 'ycxData', 'ycx', 'ycx');
        await loadSavedFile('saved_giocong', 'rawGioCongData', 'giocong', 'giocong');
        await loadSavedFile('saved_thuongnong', 'thuongNongData', 'thuongnong', 'thuongnong');

        try {
            const savedLuykeGoals = localStorage.getItem('luykeGoalSettings');
            if(savedLuykeGoals) appState.luykeGoalSettings = JSON.parse(savedLuykeGoals);

            const savedRealtimeGoals = localStorage.getItem('realtimeGoalSettings');
            if (savedRealtimeGoals) appState.realtimeGoalSettings = JSON.parse(savedRealtimeGoals);

            const savedTemplates = localStorage.getItem('composerTemplates');
            if (savedTemplates) {
                let parsedTemplates = JSON.parse(savedTemplates);
                for (const key in parsedTemplates) {
                    if (typeof parsedTemplates[key] === 'string') {
                        const oldString = parsedTemplates[key];
                        parsedTemplates[key] = {};
                        if (key === 'luyke') parsedTemplates[key]['subtab-luyke-sieu-thi'] = oldString;
                        else if (key === 'sknv') parsedTemplates[key]['subtab-sknv'] = oldString;
                        else if (key === 'realtime') parsedTemplates[key]['subtab-realtime-sieu-thi'] = oldString;
                    }
                 }
                appState.composerTemplates = parsedTemplates;
            } else {
                appState.composerTemplates = { luyke: {}, sknv: {}, realtime: {} };
            }

            const savedCompetition = localStorage.getItem('competitionConfigs');
            if (savedCompetition) appState.competitionConfigs = JSON.parse(savedCompetition);

        } catch (e) { console.error("L·ªói ƒë·ªçc c√†i ƒë·∫∑t t·ª´ localStorage:", e); }
    },

    loadPastedDataFromStorage() {
        const pasteThuongERPThangTruoc = localStorage.getItem('saved_thuongerp_thangtruoc');
        if (pasteThuongERPThangTruoc) {
             const el = document.getElementById('paste-thuongerp-thangtruoc');
            if(el) {
                el.value = pasteThuongERPThangTruoc;
                this.handleErpThangTruocPaste({ target: el });
            }
        }
        const pasteLuyke = localStorage.getItem('daily_paste_luyke');
        if (pasteLuyke) {
            document.getElementById('paste-luyke').value = pasteLuyke;
            this.handleLuykePaste();
        }

        const pasteThiduaNV = localStorage.getItem('daily_paste_thiduanv');
        if (pasteThiduaNV) {
            document.getElementById('paste-thiduanv').value = pasteThiduaNV;
            this.handleThiduaNVPaste();
        }

         const pasteThuongERP = localStorage.getItem('daily_paste_thuongerp');
        if (pasteThuongERP) {
             const el = document.getElementById('paste-thuongerp');
            if(el) {
                el.value = pasteThuongERP;
                this.handleErpPaste();
            }
        }
    },

    handleFileRead(file) {
        return new Promise((resolve, reject) => {
            if (!file) return reject(new Error("No file provided."));
            const reader = new FileReader();
             reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    resolve(workbook);
                } catch (err) { reject(err); }
             };
            reader.onerror = (err) => reject(new Error("Could not read the file: " + err));
            reader.readAsArrayBuffer(file);
        });
    },

    updateAndRenderCurrentTab() {
        if (appState.danhSachNhanVien.length === 0) return;

        ui.renderCompetitionConfigUI();

        const activeTab = document.querySelector('.page-section:not(.hidden)');
        if (!activeTab) return;

        switch (activeTab.id) {
            case 'health-section':
                 luykeTab.render();
                break;
            case 'health-employee-section':
                sknvTab.render();
                break;
            case 'realtime-section':
                // <<< FIX: Call render from the correct module >>>
                uiRealtime.render();
                break;
        }
        // === G·ªåI L·ªÜNH V·∫º ICON SAU KHI RENDER L·∫†I TAB ===
        feather.replace();
    },

    switchTab(targetId) {
        document.querySelectorAll('.page-section').forEach(section => section.classList.toggle('hidden', section.id !== targetId));
        document.querySelectorAll('.nav-link').forEach(link => {
            const isActive = link.getAttribute('href') === `#${targetId}`;
             link.classList.toggle('bg-blue-100', isActive);
            link.classList.toggle('text-blue-700', isActive);
        });

        if (targetId === 'home-section') ui.renderHomePage();
        else if (targetId === 'health-section') luykeTab.render();
        else if (targetId === 'health-employee-section') sknvTab.render();
        else if (targetId === 'realtime-section') uiRealtime.render(); // <<< FIX: Call render from the correct module >>>
        else if (targetId === 'declaration-section' && appState.isAdmin) ui.renderAdminHelpEditors();

        // === G·ªåI L·ªÜNH V·∫º ICON SAU KHI CHUY·ªÇN TAB ===
        feather.replace();
    },

    async loadAndApplyBookmarkLink() {
        try {
            const bookmarkUrl = await firebase.getBookmarkDownloadURL();
            const linkElement = document.getElementById('download-bookmark-link');
            if (linkElement) {
                 linkElement.href = bookmarkUrl;
            }
        } catch (error) {
            console.error("Kh√¥ng th·ªÉ t·∫£i link bookmark:", error);
            const linkElement = document.getElementById('download-bookmark-link');
            if (linkElement) {
                linkElement.style.display = 'none';
            }
        }
    },

    handleLuykePaste() {
        const pastedText = document.getElementById('paste-luyke')?.value || '';
        localStorage.setItem('daily_paste_luyke', pastedText);
        ui.updatePasteStatus('status-luyke');
        this.updateAndRenderCurrentTab();
    },

    handleThiduaNVPaste() {
        const pastedText = document.getElementById('paste-thiduanv')?.value || '';
        localStorage.setItem('daily_paste_thiduanv', pastedText);
        sknvTab.render();
        ui.updatePasteStatus('status-thiduanv', '‚úì ƒê√£ x·ª≠ l√Ω v√† hi·ªÉn th·ªã b√°o c√°o.');
    },

    handleErpPaste() {
        const pastedText = document.getElementById('paste-thuongerp')?.value || '';
        localStorage.setItem('daily_paste_thuongerp', pastedText);
        appState.thuongERPData = services.processThuongERP(pastedText);
        ui.updatePasteStatus('status-thuongerp', `‚úì ƒê√£ x·ª≠ l√Ω ${appState.thuongERPData.length} nh√¢n vi√™n.`);
        this.updateAndRenderCurrentTab();
    },

    handleErpThangTruocPaste(e) {
         const pastedText = e.target.value;
         localStorage.setItem('saved_thuongerp_thangtruoc', pastedText);
         appState.thuongERPDataThangTruoc = services.processThuongERP(pastedText);
         ui.updatePasteStatus('status-thuongerp-thangtruoc', `‚úì ƒê√£ x·ª≠ l√Ω ${appState.thuongERPDataThangTruoc.length} nh√¢n vi√™n.`);
         sknvTab.render();
    },

    async handleRealtimeFileInput(e) {
        const file = e.target.files[0];
        if (!file) return;
        ui.showNotification('ƒêang x·ª≠ l√Ω file realtime...', 'success');
        appState.realtimeYCXData = [];
        e.target.value = '';
        try {
            const workbook = await this.handleFileRead(file);
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const { normalizedData, success, missingColumns } = services.normalizeData(rawData, 'ycx');
            ui.displayDebugInfo('ycx-realtime');
            if (success) {
                appState.realtimeYCXData = normalizedData;
                ui.populateRealtimeBrandCategoryFilter();
                ui.showNotification(`T·∫£i th√†nh c√¥ng ${normalizedData.length} d√≤ng realtime!`, 'success');
                this.updateAndRenderCurrentTab();
            } else {
                 ui.showNotification(`File realtime l·ªói: Thi·∫øu c·ªôt ${missingColumns.join(', ')}.`, 'error');
                 if (document.getElementById('debug-tool-container')?.classList.contains('hidden')) {
                     document.getElementById('toggle-debug-btn')?.click();
                 }
            }
        } catch (err) { ui.showNotification(`C√≥ l·ªói khi ƒë·ªçc file: ${err.message}`, 'error'); console.error(err); }
    },
    
    async handleCategoryFile(e) {
        const fileInput = e.target;
        const file = fileInput.files[0];
        if (!file) return;
        ui.updateFileStatus('category-structure', file.name, 'ƒêang x·ª≠ l√Ω...', 'default');
        ui.showProgressBar('category-structure');
        try {
            const workbook = await this.handleFileRead(file);
            const categorySheet = workbook.Sheets[workbook.SheetNames[0]];
            const categoryRawData = XLSX.utils.sheet_to_json(categorySheet);
            const categoryResult = services.normalizeCategoryStructureData(categoryRawData);
            let brandResult = { success: true, normalizedData: [] };
            const brandSheetName = workbook.SheetNames.find(name => name.toLowerCase().trim() === 'h√£ng');
            if (brandSheetName) {
                const brandSheet = workbook.Sheets[brandSheetName];
                const brandRawData = XLSX.utils.sheet_to_json(brandSheet);
                brandResult = services.normalizeBrandData(brandRawData);
            }
            if(categoryResult.success) {
                appState.categoryStructure = categoryResult.normalizedData;
                appState.brandList = brandResult.normalizedData;
                await firebase.saveCategoryDataToFirestore({ categories: categoryResult.normalizedData, brands: brandResult.normalizedData });
                ui.updateFileStatus('category-structure', file.name, `‚úì ƒê√£ x·ª≠ l√Ω v√† ƒë·ªìng b·ªô ${categoryResult.normalizedData.length} nh√≥m & ${brandResult.normalizedData.length} h√£ng.`, 'success');
            } else {
                ui.showNotification(`L·ªói x·ª≠ l√Ω file khai b√°o: ${categoryResult.error}`, 'error');
            }
        } catch (error) {
            ui.updateFileStatus('category-structure', file.name, `L·ªói: ${error.message}`, 'error');
        } finally {
            ui.hideProgressBar('category-structure');
            fileInput.value = '';
        }
    },
    
    async handleThiDuaVungFileInput(e) {
        const fileInput = e.target;
        const file = fileInput.files[0];
        if (!file) return;
        ui.updateFileStatus('thidua-vung', file.name, 'ƒêang x·ª≠ l√Ω...', 'default');
        try {
            const workbook = await this.handleFileRead(file);
            const { chiTietData, tongData } = services.processThiDuaVungFile(workbook);
            if (!tongData || tongData.length === 0) throw new Error('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá trong sheet "TONG".');
            appState.thiDuaVungChiTiet = chiTietData;
            appState.thiDuaVungTong = tongData;
            const supermarketKey = Object.keys(tongData[0]).find(k => k.trim().toLowerCase().includes('si√™u th·ªã'));
            const supermarketNames = [...new Set(tongData.map(row => row[supermarketKey]).filter(Boolean))].sort();
            const choicesInstance = appState.choices.thiDuaVung_sieuThi;
            if (choicesInstance) {
                choicesInstance.clearStore();
                choicesInstance.setChoices(supermarketNames.map(name => ({ value: name, label: name })), 'value', 'label', true);
            }
            ui.updateFileStatus('thidua-vung', file.name, `‚úì ƒê√£ x·ª≠ l√Ω ${supermarketNames.length} si√™u th·ªã.`, 'success');
        } catch (error) {
            ui.updateFileStatus('thidua-vung', file.name, `L·ªói: ${error.message}`, 'error');
        }
    },

    handleThiDuaVungFilterChange() {
        const choicesInstance = appState.choices.thiDuaVung_sieuThi;
        if (!choicesInstance) return;
        const selectedValue = choicesInstance.getValue(true);
        if (selectedValue) {
            const reportData = services.generateThiDuaVungReport(selectedValue);
            ui.renderThiDuaVungInfographic(reportData);
        } else {
            const container = document.getElementById('thidua-vung-infographic-container');
            if(container) container.innerHTML = `<div class="placeholder-message">Vui l√≤ng ch·ªçn m·ªôt si√™u th·ªã ƒë·ªÉ xem b√°o c√°o.</div>`;
        }
    },

    handleDthangRealtimeViewChange(e) {
        const button = e.target.closest('.view-switcher__btn');
        if (button) {
            document.querySelectorAll('#dthang-realtime-view-selector .view-switcher__btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            uiRealtime.render();
        }
    },

    handleLuykeThiDuaViewChange(e) {
        const button = e.target.closest('.view-switcher__btn');
        if (button) {
            document.querySelectorAll('#luyke-thidua-view-selector .view-switcher__btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            luykeTab.render();
        }
    },

    handleThiDuaViewChange(e) {
        const button = e.target.closest('.view-switcher__btn');
        if (button) {
             document.querySelectorAll('#thidua-view-selector .view-switcher__btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            const view = button.dataset.view;
            document.getElementById('thidua-employee-selector-container').classList.toggle('hidden', view !== 'employee');
            ui.displayCompetitionReport(view);
        }
    },

    async handleCompetitionDebugFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        ui.showNotification('ƒêang ph√¢n t√≠ch file g·ª° l·ªói...', 'success');
        try {
            const workbook = await this.handleFileRead(file);
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const debugResults = services.debugCompetitionFiltering(rawData);
            ui.renderCompetitionDebugReport(debugResults);
        } catch (err) {
            ui.showNotification(`L·ªói khi ƒë·ªçc file g·ª° l·ªói: ${err.message}`, 'error');
        }
    },

    _handleCompetitionFormShow(show = true, isEdit = false) {
        const form = document.getElementById('competition-form');
        const addBtn = document.getElementById('add-competition-btn');
        if (!form || !addBtn) return;

        if (show) {
            ui.populateCompetitionFilters();
            ui.populateCompetitionBrandFilter();
        }

        form.classList.toggle('hidden', !show);
        addBtn.classList.toggle('hidden', show);

        if (show && !isEdit) {
            form.reset();
            document.getElementById('competition-id').value = '';
            appState.choices['competition_group']?.removeActiveItems();
            appState.choices['competition_brand']?.removeActiveItems();
            document.getElementById('price-segment').classList.add('hidden');
        }
    },

    _handleCompetitionFormEdit(index) {
        const config = appState.competitionConfigs[index];
        if (!config) return;

        this._handleCompetitionFormShow(true, true);
        
        document.getElementById('competition-id').value = index;
        document.getElementById('competition-name').value = config.name;
        
        const brandChoices = appState.choices['competition_brand'];
        if(brandChoices) {
            brandChoices.removeActiveItems();
            brandChoices.setChoiceByValue(config.brands || []);
        }

        document.getElementById('competition-type').value = config.type;
        document.getElementById('competition-exclude-apple').checked = config.excludeApple;
        
        const priceSegment = document.getElementById('price-segment');
        priceSegment.classList.toggle('hidden', config.type !== 'soluong');

        document.getElementById('competition-min-price').value = config.minPrice ? config.minPrice / 1000000 : '';
        document.getElementById('competition-max-price').value = config.maxPrice ? config.maxPrice / 1000000 : '';

        const groupChoices = appState.choices['competition_group'];
        if (groupChoices) {
            groupChoices.removeActiveItems();
            groupChoices.setChoiceByValue(config.groups);
        }
    },

    _handleCompetitionDelete(index) {
        appState.competitionConfigs.splice(index, 1);
        this._saveCompetitionConfigs();
        this.updateAndRenderCurrentTab();
        ui.showNotification('ƒê√£ x√≥a ch∆∞∆°ng tr√¨nh thi ƒëua.', 'success');
    },

    _handleCompetitionFormSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('competition-id').value;
        const name = document.getElementById('competition-name').value.trim();
        if (!name) {
             ui.showNotification('T√™n ch∆∞∆°ng tr√¨nh kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.', 'error');
            return;
        }

        const groupChoices = appState.choices['competition_group'];
        const groups = groupChoices ? groupChoices.getValue(true) : [];

        const brandChoices = appState.choices['competition_brand'];
        const brands = brandChoices ? brandChoices.getValue(true) : [];
        if (brands.length === 0) {
            ui.showNotification('L·ªói: Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h√£ng s·∫£n xu·∫•t.', 'error');
            return;
        }
        
        const newConfig = {
            id: id ? appState.competitionConfigs[parseInt(id, 10)].id : `comp_${new Date().getTime()}`,
            name: name,
            brands: brands,
            groups: groups,
            type: document.getElementById('competition-type').value,
            minPrice: (parseFloat(document.getElementById('competition-min-price').value) || 0) * 1000000,
            maxPrice: (parseFloat(document.getElementById('competition-max-price').value) || 0) * 1000000,
            excludeApple: document.getElementById('competition-exclude-apple').checked,
        };

        if (id !== '') {
             appState.competitionConfigs[parseInt(id, 10)] = newConfig;
        } else {
            appState.competitionConfigs.push(newConfig);
        }

        this._saveCompetitionConfigs();
        this._handleCompetitionFormShow(false);
        this.updateAndRenderCurrentTab();
        ui.showNotification('ƒê√£ l∆∞u ch∆∞∆°ng tr√¨nh thi ƒëua th√†nh c√¥ng!', 'success');
    },

     _saveCompetitionConfigs() {
        localStorage.setItem('competitionConfigs', JSON.stringify(appState.competitionConfigs));
    },
    
    async handleTemplateDownload() {
        ui.showNotification('ƒêang chu·∫©n b·ªã file m·∫´u...', 'success');
        try {
            const url = await firebase.getTemplateDownloadURL();
            const link = document.createElement('a');
            link.href = url;
            link.download = 'Danh_Sach_Nhan_Vien_Mau.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error("L·ªói khi t·∫£i file m·∫´u:", error);
            ui.showNotification('Kh√¥ng th·ªÉ t·∫£i file m·∫´u. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
        }
    },

    handleAdminLogin() {
        if (document.getElementById('admin-password-input').value === config.ADMIN_PASSWORD) {
            appState.isAdmin = true;
            ui.renderFeedbackSection();
            ui.renderAdminHelpEditors();
            this.switchTab('declaration-section');
            ui.toggleModal('admin-modal', false);
            document.getElementById('admin-password-input').value = '';
            document.getElementById('admin-error-msg').classList.add('hidden');
        } else {
            document.getElementById('admin-error-msg').classList.remove('hidden');
        }
    },
    
    handleContrastChange(e) {
         const level = e.target.value;
        localStorage.setItem('contrastLevel', level);
        document.documentElement.dataset.contrast = level;
    },

    handleHighlightColorChange(prefix) {
        const activeType = appState.highlightSettings[prefix]?.type;
        if (activeType) {
             const choicesInstance = appState.choices[`${prefix}_highlight_${activeType}`];
             if(choicesInstance) {
                const values = choicesInstance.getValue(true);
                const color = document.getElementById(`${prefix}-highlight-color`).value;
                appState.highlightSettings[prefix] = { type: activeType, values, color };
                localStorage.setItem('highlightSettings', JSON.stringify(appState.highlightSettings));
                highlightService.applyHighlights(prefix);
             }
        }
    },

    handleClearHighlight(prefix) {
        appState.highlightSettings[prefix] = {};
        localStorage.setItem('highlightSettings', JSON.stringify(appState.highlightSettings));
        ['nhanhang', 'nhomhang', 'employee'].forEach(type => {
             appState.choices[`${prefix}_highlight_${type}`]?.removeActiveItemsByValue(appState.choices[`${prefix}_highlight_${type}`]?.getValue(true) || []);
        });
        highlightService.applyHighlights(prefix);
    },

    async saveDeclarations() {
        const declarationsToSave = {
            ycx: document.getElementById('declaration-ycx').value,
            ycxGop: document.getElementById('declaration-ycx-gop').value,
            heSo: document.getElementById('declaration-heso').value
        };
        // Ghi l√™n Firebase
        await firebase.saveDeclarationsToFirestore(declarationsToSave);
        // C·∫≠p nh·∫≠t state c·ª•c b·ªô ngay l·∫≠p t·ª©c
         appState.declarations.hinhThucXuat = declarationsToSave.ycx;
        appState.declarations.hinhThucXuatGop = declarationsToSave.ycxGop;
        appState.declarations.heSoQuyDoi = declarationsToSave.heSo;
        // Render l·∫°i tab hi·ªán t·∫°i ƒë·ªÉ √°p d·ª•ng thay ƒë·ªïi
        this.updateAndRenderCurrentTab();
    },
    
    saveHelpContent() {
        const contents = {
            data: document.getElementById('edit-help-data').value,
            luyke: document.getElementById('edit-help-luyke').value,
            sknv: document.getElementById('edit-help-sknv').value,
            realtime: document.getElementById('edit-help-realtime').value
        };
        firebase.saveHelpContent(contents);
    },
    
    async handleSubmitFeedback() {
        const textarea = document.getElementById('feedback-textarea');
        const success = await firebase.submitFeedback(textarea.value.trim());
        if (success) textarea.value = '';
    },
    
    async handleFeedbackReplyActions(e, feedbackItem) {
        const docId = feedbackItem.dataset.id;
        const replyForm = feedbackItem.querySelector('.reply-form-container');
        if (e.target.classList.contains('reply-btn')) {
            replyForm.classList.remove('hidden');
        }
        if (e.target.classList.contains('cancel-reply-btn')) {
            replyForm.classList.add('hidden');
        }
        if (e.target.classList.contains('submit-reply-btn')) {
             const textarea = replyForm.querySelector('textarea');
            const success = await firebase.submitReply(docId, textarea.value.trim());
            if (success) {
                textarea.value = '';
                replyForm.classList.add('hidden');
            }
        }
    },

    _getFilteredReportData(sectionId) {
        const masterData = appState.masterReportData[sectionId] || [];
        if (masterData.length === 0) return [];

        const selectedWarehouse = document.getElementById(`${sectionId}-filter-warehouse`).value;
        const selectedDept = document.getElementById(`${sectionId}-filter-department`).value;
        const selectedNames = appState.choices[`${sectionId}_employee`] ? appState.choices[`${sectionId}_employee`].getValue(true) : [];
        
        let filteredReport = masterData;
        if (selectedWarehouse) filteredReport = filteredReport.filter(nv => nv.maKho == selectedWarehouse);
        if (selectedDept) filteredReport = filteredReport.filter(nv => nv.boPhan === selectedDept);
        if (selectedNames && selectedNames.length > 0) filteredReport = filteredReport.filter(nv => selectedNames.includes(String(nv.maNV)));

        return filteredReport;
    },

    async prepareAndShowComposer(sectionId) {
        const modal = document.getElementById('composer-modal');
        if (!modal) return;
        modal.dataset.sectionId = sectionId;

        const deptFilter = document.getElementById('composer-dept-filter');
        if (deptFilter) {
            const uniqueDepartments = [...new Set(appState.danhSachNhanVien.map(nv => nv.boPhan).filter(Boolean))].sort();
            deptFilter.innerHTML = '<option value="ALL">To√†n si√™u th·ªã</option>' + uniqueDepartments.map(dept => `<option value="${dept}">${dept}</option>`).join('');
        }
        
        const navIdMap = { luyke: 'luyke-subtabs-nav', sknv: 'employee-subtabs-nav', realtime: 'realtime-subtabs-nav' };
        const mainViewNav = document.getElementById(navIdMap[sectionId]);
        const contextTabsContainer = document.getElementById('composer-context-tabs');
        const contextContentContainer = document.getElementById('composer-context-content');
        contextTabsContainer.innerHTML = '';
        contextContentContainer.innerHTML = '';

        if (mainViewNav) {
            const subTabButtons = mainViewNav.querySelectorAll('.sub-tab-btn');
            subTabButtons.forEach(btn => {
                const subTabId = btn.dataset.target;
                const isActive = btn.classList.contains('active');

                const newTabBtn = document.createElement('button');
                newTabBtn.className = `composer__tab-btn ${isActive ? 'active' : ''}`;
             
                newTabBtn.dataset.target = `context-pane-${subTabId}`;
                newTabBtn.textContent = btn.textContent.trim();
                newTabBtn.addEventListener('click', () => {
                    contextTabsContainer.querySelectorAll('.composer__tab-btn').forEach(t => t.classList.remove('active'));
                    contextContentContainer.querySelectorAll('.composer__context-pane').forEach(c => c.classList.add('hidden'));
                    newTabBtn.classList.add('active');
             
                    document.getElementById(`context-pane-${subTabId}`).classList.remove('hidden');
                });
                contextTabsContainer.appendChild(newTabBtn);

                const newContentPane = document.createElement('div');
                newContentPane.id = `context-pane-${subTabId}`;
                newContentPane.className = `composer__context-pane ${!isActive ? 'hidden' : ''}`;
                
                const textarea = document.createElement('textarea');
                textarea.className = 'composer__textarea';
                textarea.rows = 15;
                textarea.placeholder = `So·∫°n th·∫£o nh·∫≠n x√©t cho tab ${btn.textContent.trim()}...`;
                
                if (!appState.composerTemplates[sectionId]) {
                    appState.composerTemplates[sectionId] = {};
                }
     
                textarea.value = appState.composerTemplates[sectionId][subTabId] || '';
                
                newContentPane.appendChild(textarea);
                contextContentContainer.appendChild(newContentPane);
            });
        }
        
        contextTabsContainer.classList.toggle('hidden', contextTabsContainer.children.length === 0);

        const filteredReportData = this._getFilteredReportData(sectionId);
        const supermarketReport = services.aggregateReport(filteredReportData);
        ui.populateComposerDetailTags(supermarketReport);

        ui.showComposerModal(sectionId);
    },

    handleComposerActions(e, modal) {
        const sectionId = modal.dataset.sectionId;
        const activeContextPane = modal.querySelector('.composer__context-pane:not(.hidden)');
        const activeTextarea = activeContextPane ? activeContextPane.querySelector('textarea') : null;
        
        if (e.target.matches('.composer__tab-btn:not([data-context-tab])')) {
             const nav = e.target.closest('.composer__nav');
            const content = nav.nextElementSibling;
            if (nav && content) {
             
                nav.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
                content.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
                e.target.classList.add('active');
                const targetId = e.target.dataset.tab;
                const targetContent = content.querySelector(`#${targetId}`);
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            }
            return;
        }

        if (e.target.matches('.composer__icon-btn, .composer__tag-btn')) {
             if (!activeTextarea) {
                ui.showNotification("Vui l√≤ng ch·ªçn m·ªôt tab n·ªôi dung ƒë·ªÉ ch√®n th·∫ª.", "error");
            }
             let tagToInsert = e.target.dataset.tag;
            if (e.target.dataset.tagTemplate) {
                const dept = document.getElementById('composer-dept-filter').value;
                tagToInsert = e.target.dataset.tagTemplate.replace('{dept}', dept);
            }
            ui.insertComposerTag(activeTextarea, tagToInsert || e.target.textContent);
            return;
        }

        if (e.target.id === 'save-composer-template-btn') {
            if (!activeTextarea) return;
            const activeContextTab = modal.querySelector('#composer-context-tabs .composer__tab-btn.active');
            const subTabId = activeContextTab?.dataset.target.replace('context-pane-', '');
            if (subTabId) {
                 if (!appState.composerTemplates[sectionId]) appState.composerTemplates[sectionId] =
{};
                appState.composerTemplates[sectionId][subTabId] = activeTextarea.value;
                localStorage.setItem('composerTemplates', JSON.stringify(appState.composerTemplates));
                ui.showNotification(`ƒê√£ l∆∞u m·∫´u cho tab con!`, 'success');
            } else {
                ui.showNotification(`Kh√¥ng t√¨m th·∫•y tab con ƒë·ªÉ l∆∞u.`, 'error');
            }
        }
        
        if (e.target.id === 'copy-composed-notification-btn') {
            if (!activeTextarea) {
                 ui.showNotification("L·ªói: Kh√¥ng t√¨m th·∫•y √¥ n·ªôi dung ƒëang ho·∫°t ƒë·ªông.", "error"); 
                return;
            }

         
            const template = activeTextarea.value;
            
            const filteredReportData = this._getFilteredReportData(sectionId);
            const supermarketReport = services.aggregateReport(filteredReportData);
            
            const selectedWarehouse = document.getElementById(`${sectionId}-filter-warehouse`).value;
            const goals = sectionId === 'realtime' ? settingsService.getRealtimeGoalSettings(selectedWarehouse).goals : settingsService.getLuykeGoalSettings(selectedWarehouse).goals;
            
            const competitionDataForComposer = services.parseCompetitionDataFromLuyKe(document.getElementById('paste-luyke')?.value || '');
            
            const processedText = services.processComposerTemplate(template, supermarketReport, goals, filteredReportData, competitionDataForComposer, sectionId);

            ui.showPreviewAndCopy(processedText);
        }
    },
    
    async loadAndDisplayQrCode() {
        try {
            const qrUrl = await firebase.getQrCodeDownloadURL();
            const imgEl = document.getElementById('header-qr-image');
            if (imgEl) {
                imgEl.src = qrUrl;
            }
        }
        catch (error) {
             console.error("Kh√¥ng th·ªÉ t·∫£i m√£ QR:", error);
            const container = document.querySelector('.header-qr-container');
            if (container) {
                container.style.display = 'none';
            }
        }
    }
};

app.init();
--- END FILE: ./main.js ---

--- START FILE: ./modules/capture.service.js ---
// Version 1.0 - Refactored from utils.js
// MODULE: CAPTURE SERVICE
// Ch·ª©a to√†n b·ªô logic li√™n quan ƒë·∫øn vi·ªác ch·ª•p ·∫£nh m√†n h√¨nh c√°c th√†nh ph·∫ßn UI.

import { ui } from '../ui.js';
import { firebase } from '../firebase.js';

// --- HELPER for Screenshot CSS Injection ---
const _injectCaptureStyles = () => {
    const styleId = 'dynamic-capture-styles';
    document.getElementById(styleId)?.remove();

    const styles = `
        .capture-container { 
            padding: 24px; 
            background-color: #f3f4f6; 
            box-sizing: border-box; 
            width: fit-content; 
            position: absolute;
            left: -9999px;
            top: 0;
            z-index: -1;
        }
        .capture-layout-container { 
            display: flex; 
            flex-direction: column; 
            gap: 24px; 
        }
        .capture-title { 
            font-size: 28px; 
            font-weight: 700; 
            text-align: center; 
            color: #1f2937; 
            margin-bottom: 24px; 
            padding: 12px; 
            background-color: #ffffff; 
            border-radius: 0.75rem; 
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); 
        }
        /* --- VIRTUAL STAGES / PRESETS --- */
        .prepare-for-kpi-capture {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 24px !important;
            width: 900px !important;
        }
        .preset-mobile-portrait {
            width: 750px !important;
        }
        .preset-landscape-table {
            width: fit-content !important;
        }
        .preset-landscape-table table {
            table-layout: fixed !important;
        }
        .preset-landscape-table th, 
        .preset-landscape-table td {
            width: 95px !important;
            word-wrap: break-word;
        }
        .preset-landscape-table th:first-child,
        .preset-landscape-table td:first-child {
            width: 180px !important;
        }
        .preset-large-font-report {
            width: 800px !important;
        }
        .preset-large-font-report table th {
            white-space: normal !important;
            vertical-align: middle;
        }
        .preset-large-font-report table td {
            font-size: 22px !important;
            vertical-align: middle;
        }
        .preset-infographic-wide {
            width: 1100px !important;
        }
    `;

    const styleElement = document.createElement('style');
    styleElement.id = styleId;
    styleElement.innerHTML = styles;
    document.head.appendChild(styleElement);
    return styleElement;
};

export const captureService = {
    async captureAndDownload(elementToCapture, title, presetClass = '') {
        const date = new Date();
        const timeString = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        const dateString = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
        const finalTitle = `${title.replace(/_/g, ' ')} - ${timeString} ${dateString}`;
    
        const captureWrapper = document.createElement('div');
        captureWrapper.className = 'capture-container';
    
        const titleEl = document.createElement('h2');
        titleEl.className = 'capture-title';
        titleEl.textContent = finalTitle;
        captureWrapper.appendChild(titleEl);
        
        const contentClone = elementToCapture.cloneNode(true);
        if (presetClass) {
            contentClone.classList.add(presetClass);
        }
        captureWrapper.appendChild(contentClone);

        document.body.appendChild(captureWrapper);
    
        try {
            const canvas = await html2canvas(captureWrapper, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#f3f4f6'
            });
    
            const link = document.createElement('a');
            link.download = `${title}_${dateString.replace(/\//g, '-')}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            ui.showNotification('ƒê√£ ch·ª•p v√† t·∫£i xu·ªëng h√¨nh ·∫£nh!', 'success');
        } catch (err) {
            console.error('L·ªói ch·ª•p m√†n h√¨nh:', err);
            ui.showNotification(`L·ªói khi ch·ª•p ·∫£nh: ${err.message}.`, 'error');
        } finally {
            if (document.body.contains(captureWrapper)) {
                document.body.removeChild(captureWrapper);
            }
        }
    },
    
    async captureDashboardInParts(contentContainer, baseTitle) {
        if (!contentContainer) {
            ui.showNotification('Kh√¥ng t√¨m th·∫•y v√πng n·ªôi dung ƒë·ªÉ ch·ª•p.', 'error');
            return;
        }

        firebase.incrementCounter('actionsTaken');
        
        ui.showNotification(`B·∫Øt ƒë·∫ßu ch·ª•p b√°o c√°o ${baseTitle}...`, 'success');
    
        const captureGroups = new Map();
        contentContainer.querySelectorAll('[data-capture-group]').forEach(el => {
            if (el.offsetParent !== null) {
                const group = el.dataset.captureGroup;
                if (!captureGroups.has(group)) {
                    captureGroups.set(group, []);
                }
                captureGroups.get(group).push(el);
            }
        });
        
        const styleElement = _injectCaptureStyles();
        try {
            if (captureGroups.size === 0) {
                if (contentContainer.offsetParent !== null) {
                    const preset = contentContainer.dataset.capturePreset;
                    const presetClass = preset ? `preset-${preset}` : '';
                    await this.captureAndDownload(contentContainer, baseTitle, presetClass);
                } else {
                     ui.showNotification('Kh√¥ng t√¨m th·∫•y ƒë·ªëi t∆∞·ª£ng hi·ªÉn th·ªã ƒë·ªÉ ch·ª•p.', 'error');
                }
                return;
            }

            for (const [group, elements] of captureGroups.entries()) {
                const captureTitle = captureGroups.size > 1 ? `${baseTitle}_Nhom_${group}` : baseTitle;
                
                const targetElement = elements[0];
                const preset = targetElement.dataset.capturePreset;
                const isKpiGroup = group === 'kpi';
                
                let elementToCapture;
                let presetClass = '';

                if (isKpiGroup) {
                    presetClass = 'prepare-for-kpi-capture';
                } else if (preset) {
                    presetClass = `preset-${preset}`;
                }

                if (elements.length > 1 && !isKpiGroup) {
                    const tempContainer = document.createElement('div');
                    tempContainer.className = 'capture-layout-container';
                    elements.forEach(el => tempContainer.appendChild(el.cloneNode(true)));
                    elementToCapture = tempContainer;
                } else {
                    elementToCapture = targetElement;
                }
    
                await this.captureAndDownload(elementToCapture, captureTitle, presetClass);
                await new Promise(resolve => setTimeout(resolve, 150));
            }
        } finally {
            styleElement.remove();
        }

        ui.showNotification(`ƒê√£ ho√†n t·∫•t ch·ª•p ·∫£nh b√°o c√°o ${baseTitle}!`, 'success');
    },
};
--- END FILE: ./modules/capture.service.js ---

--- START FILE: ./modules/file-upload.service.js ---
// Version 1.0 - Initial Upload Service
// MODULE: FILE UPLOAD SERVICE
// Ch·ª©a logic ƒë·ªÉ t·∫£i file l√™n Firebase Storage v√† l·∫Øng nghe k·∫øt qu·∫£ x·ª≠ l√Ω t·ª´ Firestore.

import { appState } from '../state.js';
import { ui } from '../ui.js';
import { ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
import { doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

export const fileUploadService = {
    /**
     * T·∫£i file l√™n Firebase Storage, sau ƒë√≥ l·∫Øng nghe k·∫øt qu·∫£ x·ª≠ l√Ω t·ª´ Firestore.
     * @param {File} file - ƒê·ªëi t∆∞·ª£ng file ng∆∞·ªùi d√πng ƒë√£ ch·ªçn.
     * @param {string} fileType - Lo·∫°i file (v√≠ d·ª•: 'ycx', 'danhsachnv').
     * @returns {Promise<Object>} - Promise s·∫Ω resolve v·ªõi d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω ho·∫∑c reject v·ªõi l·ªói.
     */
    uploadAndProcessFile(file, fileType) {
        return new Promise((resolve, reject) => {
            if (!appState.storage || !appState.db) {
                return reject(new Error("Firebase ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o."));
            }

            // 1. T·∫°o m·ªôt ID ƒë·ªôc nh·∫•t cho file ƒë·ªÉ theo d√µi
            const uniqueFileId = `${fileType}-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            const fileName = `${uniqueFileId}${file.name.substring(file.name.lastIndexOf('.'))}`;
            const storagePath = `uploads/${fileName}`;
            const storageRef = ref(appState.storage, storagePath);

            // 2. B·∫Øt ƒë·∫ßu qu√° tr√¨nh t·∫£i file l√™n Storage
            const uploadTask = uploadBytesResumable(storageRef, file);
            let unsubscribeSnapshot = null; // Bi·∫øn ƒë·ªÉ l∆∞u h√†m h·ªßy listener

            // T·∫°o listener trong Firestore ƒë·ªÉ ch·ªù k·∫øt qu·∫£
            const resultDocRef = doc(appState.db, "file_results", uniqueFileId);
            unsubscribeSnapshot = onSnapshot(resultDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const result = docSnap.data();
                    // H·ªßy listener ngay khi nh·∫≠n ƒë∆∞·ª£c k·∫øt qu·∫£ ƒë·ªÉ tr√°nh r√≤ r·ªâ b·ªô nh·ªõ
                    if (unsubscribeSnapshot) unsubscribeSnapshot();
                    clearTimeout(timeout); // H·ªßy timeout

                    if (result.status === 'success') {
                        resolve(result.data); // Tr·∫£ v·ªÅ d·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω
                    } else {
                        reject(new Error(result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ m√°y ch·ªß.'));
                    }
                }
            });

            // C·∫≠p nh·∫≠t giao di·ªán v·ªõi ti·∫øn tr√¨nh t·∫£i l√™n
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    ui.updateFileStatus(fileType, file.name, `ƒêang t·∫£i l√™n... ${Math.round(progress)}%`);
                },
                (error) => { // X·ª≠ l√Ω l·ªói t·∫£i l√™n
                    if (unsubscribeSnapshot) unsubscribeSnapshot();
                    clearTimeout(timeout);
                    console.error("L·ªói khi t·∫£i file l√™n Storage:", error);
                    reject(new Error("Kh√¥ng th·ªÉ t·∫£i file l√™n m√°y ch·ªß."));
                },
                () => { // T·∫£i l√™n th√†nh c√¥ng, chuy·ªÉn sang ch·ªù x·ª≠ l√Ω
                    ui.updateFileStatus(fileType, file.name, 'T·∫£i l√™n ho√†n t·∫•t, ƒëang ch·ªù m√°y ch·ªß x·ª≠ l√Ω...');
                }
            );

            // 3. ƒê·∫∑t m·ªôt kho·∫£ng th·ªùi gian ch·ªù t·ªëi ƒëa (v√≠ d·ª•: 60 gi√¢y)
            const timeout = setTimeout(() => {
                if (unsubscribeSnapshot) unsubscribeSnapshot();
                reject(new Error("M√°y ch·ªß x·ª≠ l√Ω qu√° l√¢u, vui l√≤ng th·ª≠ l·∫°i."));
            }, 60000); // 60 gi√¢y
        });
    }
};
--- END FILE: ./modules/file-upload.service.js ---

--- START FILE: ./modules/highlight.service.js ---
// Version 1.1 - Fix incorrect import paths for modules
// MODULE: HIGHLIGHT SERVICE
// Ch·ª©a logic ƒë·ªÉ qu·∫£n l√Ω v√† √°p d·ª•ng t√≠nh nƒÉng t√¥ m√†u (highlight) tr√™n c√°c b·∫£ng.

import { appState } from '../state.js';
import { utils } from '../utils.js';

export const highlightService = {
    populateHighlightFilters(prefix, ycxData, reportData) {
        if (!appState.choices[`${prefix}_highlight_nhanhang`]) return;
        const uniqueNganhHang = [...new Set(ycxData.map(r => utils.cleanCategoryName(r.nganhHang)).filter(Boolean))].sort();
        const uniqueNhomHang = [...new Set(ycxData.map(r => utils.cleanCategoryName(r.nhomHang)).filter(Boolean))].sort();
        const uniqueEmployees = [...new Set(reportData.map(r => r.hoTen).filter(Boolean))].sort();

        const createOptions = (arr) => arr.map(item => ({ value: item, label: item, selected: false }));
        
        appState.choices[`${prefix}_highlight_nhanhang`]?.setChoices(createOptions(uniqueNganhHang), 'value', 'label', true);
        appState.choices[`${prefix}_highlight_nhomhang`]?.setChoices(createOptions(uniqueNhomHang), 'value', 'label', true);
        appState.choices[`${prefix}_highlight_employee`]?.setChoices(createOptions(uniqueEmployees), 'value', 'label', true);
    },

    applyHighlights(prefix) {
        const settings = appState.highlightSettings[prefix] || {};
        const tableContainer = document.getElementById(`${prefix === 'luyke' ? 'health' : (prefix === 'sknv' ? 'health-employee' : 'realtime')}-section`);
        if (!tableContainer) return;
        
        tableContainer.querySelectorAll('tbody tr').forEach(row => {
             row.classList.remove('highlighted-row');
             row.style.backgroundColor = '';
        });

        if (settings.values && settings.values.length > 0) {
            tableContainer.querySelectorAll('tbody tr').forEach(row => {
                const cellText = row.cells[0] ? row.cells[0].textContent : '';
                if (settings.values.includes(cellText)) {
                    row.classList.add('highlighted-row');
                    row.style.backgroundColor = settings.color;
                }
            });
        }
    },
};
--- END FILE: ./modules/highlight.service.js ---

--- START FILE: ./modules/settings.service.js ---
// Version 2.0 - Revert loading logic to respect user-saved drag-drop order
// MODULE: SETTINGS SERVICE
// Ch·ª©a to√†n b·ªô logic li√™n quan ƒë·∫øn vi·ªác qu·∫£n l√Ω c√†i ƒë·∫∑t (l∆∞u/t·∫£i t·ª´ localStorage).

import { appState } from '../state.js';
import { ui } from '../ui.js';

// H·∫±ng s·ªë ch·ª©a danh s√°ch ƒë·∫ßy ƒë·ªß v√† th·ª© t·ª± c·ªôt ch√≠nh x√°c cho b·∫£ng Hi·ªáu qu·∫£ khai th√°c
const ALL_EFFICIENCY_ITEMS = [
    { id: 'dtICT', label: 'DT ICT' },
    { id: 'dtPhuKien', label: 'DT Ph·ª• ki·ªán' },
    { id: 'pctPhuKien', label: '% Ph·ª• ki·ªán' },
    { id: 'dtCE', label: 'DT CE' },
    { id: 'dtGiaDung', label: 'DT Gia d·ª•ng' },
    { id: 'pctGiaDung', label: '% Gia d·ª•ng' },
    { id: 'pctMLN',    label: '% MLN' },
    { id: 'pctSim',    label: '% Sim' },
    { id: 'pctVAS',    label: '% VAS' },
    { id: 'pctBaoHiem', label: '% B·∫£o hi·ªÉm' }
];


export const settingsService = {
    /**
     * L∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã cho b·∫£ng Hi·ªáu qu·∫£ khai th√°c.
     * C·∫•u tr√∫c m·ªõi l√† m·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng, m·ªói ƒë·ªëi t∆∞·ª£ng ch·ª©a {id, label, visible}.
     * @param {Array<Object>} settings - M·∫£ng c·∫•u h√¨nh c·ªôt ƒë·∫ßy ƒë·ªß.
     */
    saveEfficiencyViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try {
            localStorage.setItem('efficiencyViewSettings', JSON.stringify(settings));
        } catch (e) {
            console.error("L·ªói khi l∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã Hi·ªáu qu·∫£ khai th√°c:", e);
        }
    },
    
    /**
     * T·∫£i c√†i ƒë·∫∑t hi·ªÉn th·ªã cho b·∫£ng Hi·ªáu qu·∫£ khai th√°c.
     * Logic m·ªõi: ∆Øu ti√™n th·ª© t·ª± ƒë√£ l∆∞u c·ªßa ng∆∞·ªùi d√πng, v√† th√™m c√°c c·ªôt m·ªõi v√†o cu·ªëi.
     * @returns {Array<Object>} M·∫£ng c·∫•u h√¨nh c·ªôt ƒë·∫ßy ƒë·ªß.
     */
    loadEfficiencyViewSettings() {
        try {
            const savedSettingsJSON = localStorage.getItem('efficiencyViewSettings');
            if (savedSettingsJSON) {
                const savedItems = JSON.parse(savedSettingsJSON);
                
                // ƒê·∫£m b·∫£o d·ªØ li·ªáu l∆∞u l√† m·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng
                if (Array.isArray(savedItems) && savedItems.length > 0 && typeof savedItems[0] === 'object') {
                    const savedIds = new Set(savedItems.map(s => s.id));
                    // Th√™m c√°c c·ªôt m·ªõi (n·∫øu c√≥ trong b·∫£n c·∫≠p nh·∫≠t) m√† ng∆∞·ªùi d√πng ch∆∞a c√≥ trong c√†i ƒë·∫∑t
                    const newItems = ALL_EFFICIENCY_ITEMS
                        .filter(item => !savedIds.has(item.id))
                        .map(item => ({ ...item, visible: true }));
                    
                    // L·ªçc ra c√°c m·ª•c ƒë√£ l∆∞u m√† kh√¥ng c√≤n t·ªìn t·∫°i trong code n·ªØa
                    const currentItems = savedItems.filter(item => ALL_EFFICIENCY_ITEMS.some(config => config.id === item.id));
                    
                    return [...currentItems, ...newItems];
                }
            }
        } catch (e) {
            console.error("L·ªói khi t·∫£i c√†i ƒë·∫∑t hi·ªÉn th·ªã Hi·ªáu qu·∫£ khai th√°c:", e);
        }

        // Tr·∫£ v·ªÅ gi√° tr·ªã m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ g√¨ ƒë∆∞·ª£c l∆∞u ho·∫∑c c√≥ l·ªói
        return ALL_EFFICIENCY_ITEMS.map(item => ({ ...item, visible: true }));
    },

    saveQdcViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try {
            localStorage.setItem('qdcViewSettings', JSON.stringify(settings));
        } catch (e) {
            console.error("L·ªói khi l∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã Nh√≥m h√†ng QƒêC:", e);
        }
    },

    saveCategoryViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try {
            localStorage.setItem('categoryViewSettings', JSON.stringify(settings));
        } catch (e) {
            console.error("L·ªói khi l∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã Ng√†nh h√†ng chi ti·∫øt:", e);
        }
    },

    loadQdcViewSettings(allItems) {
        try {
            const savedSettings = localStorage.getItem('qdcViewSettings');
            if (savedSettings) {
                return JSON.parse(savedSettings);
            }
        } catch (e) {
            console.error("L·ªói khi t·∫£i c√†i ƒë·∫∑t hi·ªÉn th·ªã Nh√≥m h√†ng QƒêC:", e);
        }
        // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã t·∫•t c·∫£ n·∫øu ch∆∞a c√≥ c√†i ƒë·∫∑t
        return allItems;
    },

    loadCategoryViewSettings(allItems) {
        try {
            const savedSettings = localStorage.getItem('categoryViewSettings');
            if (savedSettings) {
                return JSON.parse(savedSettings);
            }
        } catch (e) {
            console.error("L·ªói khi t·∫£i c√†i ƒë·∫∑t hi·ªÉn th·ªã Ng√†nh h√†ng chi ti·∫øt:", e);
        }
        // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã t·∫•t c·∫£ n·∫øu ch∆∞a c√≥ c√†i ƒë·∫∑t
        return allItems;
    },
    
    loadInterfaceSettings() {
        try {
            const savedSettings = JSON.parse(localStorage.getItem('interfaceSettings')) || {};
            const defaultSettings = {
                kpiCard1Bg: '#38bdf8', kpiCard2Bg: '#34d399', kpiCard3Bg: '#fbbf24',
                kpiCard4Bg: '#2dd4bf', kpiCard5Bg: '#a78bfa', kpiCard6Bg: '#f472b6', 
                kpiCard7Bg: '#818cf8', kpiCard8Bg: '#f87171',
                kpiTitleColor: '#ffffff',
                kpiMainColor: '#ffffff',
                kpiSubColor: '#ffffff',
                globalFontSize: '14',
                kpiFontSize: '36'
            };
            const settings = { ...defaultSettings, ...savedSettings };
            
            ui.applyInterfaceSettings(settings);
            
            // C·∫≠p nh·∫≠t gi√° tr·ªã cho c√°c b·ªô ch·ªçn m√†u
            Object.keys(defaultSettings).forEach((key) => {
                if (key.startsWith('kpiCard')) {
                    const keyNumber = key.replace('kpiCard', '').replace('Bg', '');
                    const colorPicker = document.getElementById(`kpi-color-${keyNumber}`);
                    if (colorPicker) colorPicker.value = settings[key];
                }
            });
            
            const titleColorPicker = document.getElementById('kpi-title-color');
            if(titleColorPicker) titleColorPicker.value = settings.kpiTitleColor;
            
            const mainColorPicker = document.getElementById('kpi-main-color');
            if(mainColorPicker) mainColorPicker.value = settings.kpiMainColor;

            const subColorPicker = document.getElementById('kpi-sub-color');
            if(subColorPicker) subColorPicker.value = settings.kpiSubColor;


            const globalSlider = document.getElementById('global-font-size-slider');
            const kpiSlider = document.getElementById('kpi-font-size-slider');
            if(globalSlider) globalSlider.value = settings.globalFontSize;
            if(kpiSlider) kpiSlider.value = settings.kpiFontSize;
            
            this.handleFontSizeChange({ target: globalSlider }, 'global');
            this.handleFontSizeChange({ target: kpiSlider }, 'kpi');
            
        } catch (e) { console.error("L·ªói khi t·∫£i c√†i ƒë·∫∑t giao di·ªán:", e); }
    },
    
    saveInterfaceSettings() {
        const settings = {
            kpiCard1Bg: document.getElementById('kpi-color-1')?.value,
            kpiCard2Bg: document.getElementById('kpi-color-2')?.value,
            kpiCard3Bg: document.getElementById('kpi-color-3')?.value,
            kpiCard4Bg: document.getElementById('kpi-color-4')?.value,
            kpiCard5Bg: document.getElementById('kpi-color-5')?.value,
            kpiCard6Bg: document.getElementById('kpi-color-6')?.value,
            kpiCard7Bg: document.getElementById('kpi-color-7')?.value,
            kpiCard8Bg: document.getElementById('kpi-color-8')?.value,
            kpiTitleColor: document.getElementById('kpi-title-color')?.value,
            kpiMainColor: document.getElementById('kpi-main-color')?.value,
            kpiSubColor: document.getElementById('kpi-sub-color')?.value,
            globalFontSize: document.getElementById('global-font-size-slider')?.value,
            kpiFontSize: document.getElementById('kpi-font-size-slider')?.value,
        };
        localStorage.setItem('interfaceSettings', JSON.stringify(settings));
        ui.applyInterfaceSettings(settings);
        this.applyFontSettings();
    },

    applyFontSettings() {
        const settings = JSON.parse(localStorage.getItem('interfaceSettings')) || {};
        const globalSize = settings.globalFontSize || '14';
        const kpiSize = settings.kpiFontSize || '36';
        
        document.documentElement.style.setProperty('--global-font-size', `${globalSize}px`);
        document.documentElement.style.setProperty('--kpi-main-font-size', `${kpiSize}px`);
    },

    handleFontSizeChange(event, type) {
        if (!event || !event.target) return;
        const value = event.target.value;
        const valueDisplayId = type === 'global' ? 'global-font-size-value' : 'kpi-font-size-value';
        const valueDisplayElement = document.getElementById(valueDisplayId);

        if (valueDisplayElement) {
            valueDisplayElement.textContent = `${value}px`;
        }
        
        this.saveInterfaceSettings();
    },

    saveRealtimeGoalSettings() {
        const warehouse = document.getElementById('rt-goal-warehouse-select').value;
        if (!warehouse) return;
        const settings = { goals: {}, timing: {} };
        document.querySelectorAll('.rt-goal-input').forEach(input => settings.goals[input.dataset.goal] = input.value);
        document.querySelectorAll('.rt-setting-input').forEach(input => settings.timing[input.id] = input.value);
        
        if (!appState.realtimeGoalSettings) appState.realtimeGoalSettings = {};
        appState.realtimeGoalSettings[warehouse] = settings;
        localStorage.setItem('realtimeGoalSettings', JSON.stringify(appState.realtimeGoalSettings));
        ui.showNotification(`ƒê√£ l∆∞u c√†i ƒë·∫∑t Realtime cho kho ${warehouse}!`, 'success');
    },

    loadAndApplyRealtimeGoalSettings() {
        const warehouseSelect = document.getElementById('rt-goal-warehouse-select');
        if (!warehouseSelect) return;
        const warehouse = warehouseSelect.value;
        const settings = (warehouse && appState.realtimeGoalSettings && appState.realtimeGoalSettings[warehouse]) 
            ? appState.realtimeGoalSettings[warehouse] 
            : { goals: {}, timing: {} };

        document.querySelectorAll('.rt-goal-input').forEach(input => input.value = settings.goals?.[input.dataset.goal] || '');
        document.querySelectorAll('.rt-setting-input').forEach(input => input.value = settings.timing?.[input.id] || '');
    },

    saveLuykeGoalSettings() {
        const warehouse = document.getElementById('luyke-goal-warehouse-select').value;
        if (!warehouse) return;
        const settings = {};
        document.querySelectorAll('.luyke-goal-input').forEach(input => settings[input.dataset.goal] = input.value);

        if(!appState.luykeGoalSettings) appState.luykeGoalSettings = {};
        appState.luykeGoalSettings[warehouse] = settings;
        localStorage.setItem('luykeGoalSettings', JSON.stringify(appState.luykeGoalSettings));
        ui.showNotification(`ƒê√£ l∆∞u c√†i ƒë·∫∑t m·ª•c ti√™u L≈©y k·∫ø cho kho ${warehouse}!`, 'success');
    },

    loadAndApplyLuykeGoalSettings() {
        const warehouseSelect = document.getElementById('luyke-goal-warehouse-select');
        if (!warehouseSelect) return;
        const warehouse = warehouseSelect.value;
        const settings = (warehouse && appState.luykeGoalSettings && appState.luykeGoalSettings[warehouse]) 
            ? appState.luykeGoalSettings[warehouse] 
            : {};
        document.querySelectorAll('.luyke-goal-input').forEach(input => input.value = settings[input.dataset.goal] || '');
    },

    getLuykeGoalSettings(selectedWarehouse = null) {
        const settings = { goals: {} };
        const goalKeys = ['doanhThuThuc', 'doanhThuQD', 'phanTramQD', 'phanTramTC', 'phanTramGiaDung', 'phanTramMLN', 'phanTramPhuKien', 'phanTramBaoHiem', 'phanTramSim', 'phanTramVAS'];

        if (selectedWarehouse && appState.luykeGoalSettings[selectedWarehouse]) {
             const source = appState.luykeGoalSettings[selectedWarehouse];
             goalKeys.forEach(key => settings.goals[key] = parseFloat(source[key]) || 0);
        } else if (!selectedWarehouse) {
            const allSettings = appState.luykeGoalSettings || {};
            const warehouseKeys = Object.keys(allSettings);
            const percentCounts = {};
            
            goalKeys.forEach(key => settings.goals[key] = 0);

            warehouseKeys.forEach(whKey => {
                const source = allSettings[whKey];
                goalKeys.forEach(key => {
                    const value = parseFloat(source[key]) || 0;
                    if (key.startsWith('phanTram')) {
                        settings.goals[key] += value;
                        percentCounts[key] = (percentCounts[key] || 0) + 1;
                    } else {
                        settings.goals[key] += value;
                    }
                });
            });
            
            Object.keys(percentCounts).forEach(key => {
                if (percentCounts[key] > 0) settings.goals[key] /= percentCounts[key];
            });
        }
        return settings;
    },

    getRealtimeGoalSettings(selectedWarehouse = null) {
        if (selectedWarehouse && appState.realtimeGoalSettings && appState.realtimeGoalSettings[selectedWarehouse]) {
            return appState.realtimeGoalSettings[selectedWarehouse];
        }
        if (!selectedWarehouse) {
            const allSettings = appState.realtimeGoalSettings || {};
            const validWarehouseSettings = Object.values(allSettings).filter(s => s.goals && Object.keys(s.goals).length > 0);
            if(validWarehouseSettings.length === 0) return { goals: {}, timing: {} };
            const aggregatedGoals = { doanhThuThuc: 0, doanhThuQD: 0 };
            const percentGoals = {}; const percentCounts = {};
            validWarehouseSettings.forEach(ws => {
                aggregatedGoals.doanhThuThuc += parseFloat(ws.goals.doanhThuThuc || 0);
                aggregatedGoals.doanhThuQD += parseFloat(ws.goals.doanhThuQD || 0);
                Object.entries(ws.goals).forEach(([key, value]) => {
                    if (key.startsWith('phanTram')) {
                        if (!percentGoals[key]) { percentGoals[key] = 0; percentCounts[key] = 0; }
                        const numValue = parseFloat(value);
                        if(!isNaN(numValue)) { percentGoals[key] += numValue; percentCounts[key]++; }
                    }
                });
            });
            Object.keys(percentCounts).forEach(key => { if(percentCounts[key] > 0) aggregatedGoals[key] = percentGoals[key] / percentCounts[key]; });
            const representativeTiming = validWarehouseSettings.length > 0 ? (validWarehouseSettings[0].timing || {}) : {};
            return { goals: aggregatedGoals, timing: representativeTiming };
        }
        return { goals: {}, timing: {} };
    },

    applyContrastSetting() {
        const savedLevel = localStorage.getItem('contrastLevel') || '3';
        document.documentElement.dataset.contrast = savedLevel;
        document.querySelectorAll('.contrast-selector').forEach(sel => sel.value = savedLevel);
    },

    loadHighlightSettings() {
        try {
            const saved = localStorage.getItem('highlightSettings');
            if (saved) appState.highlightSettings = JSON.parse(saved);
        } catch(e) {
            console.error("Error loading highlight settings", e);
            appState.highlightSettings = { luyke: {}, sknv: {}, realtime: {} };
        }
    },
};
--- END FILE: ./modules/settings.service.js ---

--- START FILE: ./modules/storage.js ---
// Version 1.0 - Initial creation from main.js refactor
// MODULE: STORAGE
// Qu·∫£n l√Ω t·∫•t c·∫£ c√°c t∆∞∆°ng t√°c v·ªõi IndexedDB ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu c·ª•c b·ªô.

export const storage = {
    db: null,
    dbName: 'AppStorageDB',
    storeName: 'fileStore',

    openDB() {
        return new Promise((resolve, reject) => {
            if (this.db) return resolve(this.db);
            const request = indexedDB.open(this.dbName, 1);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(this.storeName)) {
                    db.createObjectStore(this.storeName, { keyPath: 'id' });
                }
            };
            request.onsuccess = (event) => {
                this.db = event.target.result;
                resolve(this.db);
            };
            request.onerror = (event) => {
                console.error("IndexedDB error:", event.target.errorCode);
                reject(event.target.error);
            };
        });
    },

    async setItem(id, value) {
        const db = await this.openDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([this.storeName], 'readwrite');
            const store = transaction.objectStore(this.storeName);
            const request = store.put({ id, value });
            request.onsuccess = () => resolve();
            request.onerror = (event) => reject(event.target.error);
        });
    },

    async getItem(id) {
        const db = await this.openDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([this.storeName], 'readonly');
            const store = transaction.objectStore(this.storeName);
            const request = store.get(id);
            request.onsuccess = (event) => {
                resolve(event.target.result ? event.target.result.value : null);
            };
            request.onerror = (event) => reject(event.target.error);
        });
    }
};
--- END FILE: ./modules/storage.js ---


--- END FILE: ./project_snapshot.txt ---

--- START FILE: ./services/data-processing.js ---
// Version 2.0 - Read declarations from appState instead of localStorage
// MODULE: SERVICES - DATA PROCESSING
// Ch·ª©a c√°c h√†m x·ª≠ l√Ω, chu·∫©n h√≥a, v√† ph√¢n t√≠ch c√∫ ph√°p d·ªØ li·ªáu th√¥.

import { config } from '../config.js';
import { appState } from '../state.js';
import { utils } from '../utils.js';

export const dataProcessing = {
    /**
     * Ph√¢n t√≠ch m·ªôt t·∫≠p d·ªØ li·ªáu YCX th√¥ ƒë·ªÉ g·ª° l·ªói c√°c ƒëi·ªÅu ki·ªán l·ªçc thi ƒëua.
     * @param {Array} rawTestData - D·ªØ li·ªáu YCX th√¥ t·ª´ file ng∆∞·ªùi d√πng t·∫£i l√™n.
     * @returns {Array} - M·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng, m·ªói ƒë·ªëi t∆∞·ª£ng ch·ª©a d·ªØ li·ªáu h√†ng v√† k·∫øt qu·∫£ c·ªßa t·ª´ng b∆∞·ªõc ki·ªÉm tra.
     */
    debugCompetitionFiltering(rawTestData) {
        if (!rawTestData || rawTestData.length === 0) {
            return [];
        }

        const { normalizedData } = this.normalizeData(rawTestData, 'ycx');
        if (normalizedData.length === 0) {
            return [];
        }

        const hinhThucXuatTinhDoanhThu = this.getHinhThucXuatTinhDoanhThu();

        const debugResults = normalizedData.map(row => {
            const checks = {
                isDoanhThuHTX: hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat),
                isThuTien: (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu',
                isChuaHuy: (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy',
                isChuaTra: (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£',
                isDaXuat: (row.trangThaiXuat || "").trim() === 'ƒê√£ xu·∫•t'
            };

            const isOverallValid = checks.isDoanhThuHTX && checks.isThuTien && checks.isChuaHuy && checks.isChuaTra && checks.isDaXuat;

            return {
                rowData: row,
                checks: checks,
                isOverallValid: isOverallValid
            };
        });

        return debugResults;
    },

    normalizeCategoryStructureData(rawData) {
        if (!rawData || rawData.length === 0) {
            return { success: false, error: 'File r·ªóng.', normalizedData: [] };
        }
        const header = Object.keys(rawData[0] || {});

        const nganhHangCol = this.findColumnName(header, ['ng√†nh h√†ng', 'nganh hang']);
        const nhomHangCol = this.findColumnName(header, ['nh√≥m h√†ng', 'nhom hang']);

        if (!nganhHangCol || !nhomHangCol) {
            return { success: false, error: 'File ph·∫£i c√≥ c·ªôt "Ng√†nh h√†ng" v√† "Nh√≥m h√†ng".', normalizedData: [] };
        }

        const normalizedData = rawData
            .map(row => ({
                nganhHang: String(row[nganhHangCol] || '').trim(),
                nhomHang: String(row[nhomHangCol] || '').trim(),
            }))
            .filter(item => item.nganhHang && item.nhomHang);

        return { success: true, normalizedData };
    },

    normalizeBrandData(rawData) {
        if (!rawData || rawData.length === 0) {
            return { success: false, error: 'Sheet "H√£ng" r·ªóng.', normalizedData: [] };
        }
        const header = Object.keys(rawData[0] || {});
        const brandCol = this.findColumnName(header, ['h√£ng', 't√™n h√£ng', 'nh√† s·∫£n xu·∫•t']);
        if (!brandCol) {
            return { success: false, error: 'Sheet "H√£ng" ph·∫£i c√≥ c·ªôt "H√£ng" ho·∫∑c "T√™n H√£ng".', normalizedData: [] };
        }

        const normalizedData = rawData
            .map(row => String(row[brandCol] || '').trim())
            .filter(brand => brand);

        return { success: true, normalizedData: [...new Set(normalizedData)].sort() };
    },

    // === START: C·∫¨P NH·∫¨T LOGIC ƒê·ªåC KHAI B√ÅO ===
    getHinhThucXuatTinhDoanhThu: () => {
        const declarationData = appState.declarations.hinhThucXuat;
        if (declarationData) return new Set(declarationData.split('\n').map(l => l.trim()).filter(Boolean));
        return new Set(config.DEFAULT_DATA.HINH_THUC_XUAT_TINH_DOANH_THU);
    },

    getHinhThucXuatTraGop: () => {
        const declarationData = appState.declarations.hinhThucXuatGop;
        if (declarationData) return new Set(declarationData.split('\n').map(l => l.trim()).filter(Boolean));
        return new Set(config.DEFAULT_DATA.HINH_THUC_XUAT_TRA_GOP);
    },

    getHeSoQuyDoi: () => {
        const declarationData = appState.declarations.heSoQuyDoi;
        const heSoMap = {};
        if (declarationData) {
            declarationData.split('\n').filter(l => l.trim()).forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const key = parts[0].trim();
                    const value = parseFloat(parts[1].trim());
                    if (key && !isNaN(value)) heSoMap[key] = value;
                }
            });
            return Object.keys(heSoMap).length > 0 ? heSoMap : config.DEFAULT_DATA.HE_SO_QUY_DOI;
        }
        return config.DEFAULT_DATA.HE_SO_QUY_DOI;
    },
    // === END: C·∫¨P NH·∫¨T LOGIC ƒê·ªåC KHAI B√ÅO ===

    findColumnName(header, aliases) {
        for (const colName of header) {
            const processedColName = String(colName || '').trim().toLowerCase();
            if (aliases.includes(processedColName)) {
                return colName;
            }
        }
        return null;
    },

    normalizeData(rawData, fileType) {
        const mapping = config.COLUMN_MAPPINGS[fileType];
        if (!mapping) {
            console.error(`No column mapping found for fileType: ${fileType}`);
            return { normalizedData: [], success: false, missingColumns: ['Unknown mapping'] };
        }

        if (!rawData || rawData.length === 0) {
            return { normalizedData: [], success: true, missingColumns: [] };
        }

        const header = Object.keys(rawData[0] || {});
        const foundMapping = {};
        let allRequiredFound = true;
        const missingColumns = [];

        appState.debugInfo[fileType] = { required: [], found: header, firstFiveMsnv: [] };

        for (const key in mapping) {
            const { required, displayName, aliases } = mapping[key];
            const foundName = this.findColumnName(header, aliases);
            foundMapping[key] = foundName;

            if (required) {
                const status = !!foundName;
                appState.debugInfo[fileType].required.push({ displayName, foundName: foundName || 'Kh√¥ng t√¨m th·∫•y', status: status });
                if (!status) {
                    allRequiredFound = false;
                    missingColumns.push(displayName);
                }
            }
        }

        if (fileType === 'giocong' || fileType === 'thuongnong') {
            if (!foundMapping.maNV && !foundMapping.hoTen) {
                allRequiredFound = false;
                const missingMsg = 'M√£ NV ho·∫∑c T√™n NV';
                missingColumns.push(missingMsg);
                if (!appState.debugInfo[fileType].required.some(r => r.displayName.includes('NV'))) {
                     appState.debugInfo[fileType].required.push({ displayName: missingMsg, foundName: 'Kh√¥ng t√¨m th·∫•y', status: false });
                }
            }
        }

        if (!allRequiredFound) {
            return { normalizedData: [], success: false, missingColumns };
        }

        const normalizedData = rawData.map(row => {
            const newRow = {};
            for (const key in foundMapping) {
                if (foundMapping[key]) {
                    if (key === 'maNV' || key === 'hoTen') {
                        newRow[key] = String(row[foundMapping[key]] || '').trim();
                    } else if ((key === 'ngayTao' || key === 'ngayHenGiao') && row[foundMapping[key]]) {
                        const dateValue = row[foundMapping[key]];
                        if (dateValue instanceof Date) {
                            newRow[key] = dateValue;
                        } else if (typeof dateValue === 'number') {
                            newRow[key] = new Date(Math.round((dateValue - 25569) * 86400 * 1000));
                        } else if (typeof dateValue === 'string') {
                            const parsedDate = new Date(dateValue.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$2/$1/$3'));
                            if (!isNaN(parsedDate)) newRow[key] = parsedDate;
                        }
                    }
                    else {
                        newRow[key] = row[foundMapping[key]];
                    }
                }
            }
            return newRow;
        });

        if (fileType === 'giocong') {
            appState.rawGioCongData = rawData.map(row => {
                const newRow = {};
                for (const key in foundMapping) {
                     if (foundMapping[key]) newRow[key] = row[foundMapping[key]];
                }
                return newRow;
            });
        }

        appState.debugInfo[fileType].firstFiveMsnv = normalizedData.slice(0, 5).map(r => r.maNV).filter(Boolean);

        return { normalizedData, success: true, missingColumns: [] };
    },

    processThuongERP: (pastedText) => {
        if (!pastedText || !pastedText.trim()) return [];
        const lines = pastedText.trim().split('\n');
        const results = [];
        const regex = /(ƒêML_|TGD|ƒêMM|ƒêMS).*?(BP .*?)(?:Nh√¢n Vi√™n|Tr∆∞·ªüng Ca)(.*?)([\d,]+)$/;
        lines.forEach(line => {
            const match = line.replace(/\s+/g, ' ').match(regex);
            if (match) results.push({ name: match[3].trim(), bonus: match[4].trim() });
        });
        return results;
    },

    parseLuyKePastedData: (text) => {
        const defaults = {
            mainKpis: {},
            comparisonData: { value: 0, percentage: 'N/A' },
            luotKhachData: { value: 0, percentage: 'N/A' },
            dtDuKien: 0,
            dtqdDuKien: 0,
        };
        if (!text) return defaults;

        const allLines = text.split('\n').map(line => line.trim());
        const textContent = allLines.join(' ');

        const patterns = {
            'Th·ª±c hi·ªán DT th·ª±c': /DTLK\s+([\d,.]+)/,
            'Th·ª±c hi·ªán DTQƒê': /DTQƒê\s+([\d,.]+)/,
            '% HT Target D·ª± Ki·∫øn (Qƒê)': /% HT Target D·ª± Ki·∫øn \(Qƒê\)\s+([\d.]+%?)/,
            'T·ª∑ Tr·ªçng Tr·∫£ G√≥p': /T·ª∑ Tr·ªçng Tr·∫£ G√≥p\s+([\d.]+%?)/,
        };

        for (const [key, regex] of Object.entries(patterns)) {
            const match = textContent.match(regex);
            if (match && match[1]) {
                defaults.mainKpis[key] = match[1];
            }
        }

        const findValueAfterKeyword = (lines, keyword, isQd = false) => {
            let keywordRegex;
            if (isQd) {
                keywordRegex = new RegExp(keyword.replace('(', '\\(').replace(')', '\\)'));
            } else {
                keywordRegex = new RegExp(`^${keyword}$`);
            }

            const index = lines.findIndex(line => keywordRegex.test(line) && !/l∆∞·ª£t kh√°ch/i.test(line));
            if (index !== -1 && index + 1 < lines.length) {
                return parseFloat(lines[index + 1].replace(/,/g, '')) || 0;
            }
            return 0;
        };

        defaults.dtDuKien = findValueAfterKeyword(allLines, "DT D·ª± Ki·∫øn");
        defaults.dtqdDuKien = findValueAfterKeyword(allLines, "DT D·ª± Ki·∫øn (Qƒê)", true);

        const dtckIndex = allLines.findIndex(line => line.includes('DTCK Th√°ng'));
        if (dtckIndex !== -1 && dtckIndex + 1 < allLines.length) {
            const valueLine = allLines[dtckIndex + 1];
            const values = valueLine.split(/\s+/);
            if (values.length >= 2) {
                defaults.comparisonData = {
                    value: parseFloat(values[0].replace(/,/g, '')) || 0,
                    percentage: values[1] || 'N/A'
                };
            }
        }

        const luotKhachIndex = allLines.findIndex(line => line.includes('L∆∞·ª£t Kh√°ch CK Th√°ng'));
        if (luotKhachIndex !== -1 && luotKhachIndex + 1 < allLines.length) {
            const valueLine = allLines[luotKhachIndex + 1];
            const values = valueLine.split(/\s+/);
            if (values.length >= 2) {
                defaults.luotKhachData = {
                    value: parseFloat(values[0].replace(/,/g, '')) || 0,
                    percentage: values[1] || 'N/A'
                };
            }
        }

        return defaults;
    },

    parseCompetitionDataFromLuyKe: (text) => {
        if (!text || !text.trim()) return [];
        const lines = text.split('\n').map(l => l.trim());
        const results = [];
        let currentCompetition = null;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (line.toLowerCase().startsWith('thi ƒëua')) {
                if (currentCompetition) results.push(currentCompetition);
                currentCompetition = {
                    name: line.replace("Thi ƒëua doanh thu", "DT").replace("Thi ƒëua s·ªë l∆∞·ª£ng", "SL"),
                    type: line.toLowerCase().includes('doanh thu') ? 'doanhThu' : 'soLuong',
                    luyKe: 0, target: 0, hoanThanh: '0%'
                };
            } else if (currentCompetition) {
                if (line.startsWith('DTLK') || line.startsWith('SLLK') || line.startsWith('DTQƒê')) {
                    if (i + 1 < lines.length) {
                        currentCompetition.luyKe = parseFloat(lines[i + 1].replace(/,/g, '')) || 0;
                    }
                } else if (line.startsWith('Target')) {
                    if (i + 1 < lines.length) {
                        currentCompetition.target = parseFloat(lines[i + 1].replace(/,/g, '')) || 0;
                    }
                } else if (line.startsWith('% HT D·ª± Ki·∫øn')) {
                    if (i + 1 < lines.length) {
                        currentCompetition.hoanThanh = lines[i + 1] || '0%';
                    }
                }
            }
        }
        if (currentCompetition) results.push(currentCompetition);

        appState.competitionData = results;
        return results;
    },

    processThiDuaNhanVienData(pastedText, luykeCompetitionData) {
        const debugInfo = { required: [], found: [], status: 'Ch∆∞a x·ª≠ l√Ω' };
        appState.debugInfo['thiduanv-pasted'] = debugInfo;

        if (!pastedText.trim() || !appState.danhSachNhanVien.length || !luykeCompetitionData.length) {
            debugInfo.status = 'L·ªói: Thi·∫øu d·ªØ li·ªáu ƒë·∫ßu v√†o (d√°n Thi ƒëua NV, DSNV, ho·∫∑c d√°n Data L≈©y k·∫ø).';
            return [];
        }

        const lines = pastedText.trim().split('\n').map(l => l.trim());
        const competitionCategories = [];
        const employeePastedDataMap = new Map();

        let isParsingCategories = false;
        let isParsingEmployees = false;

        for (const line of lines) {
            if (line.includes('Ph√≤ng ban')) {
                isParsingCategories = true;
                continue;
            }
            if (line.includes('T·ªïng')) {
                isParsingCategories = false;
                isParsingEmployees = true;
                continue;
            }
            if (isParsingCategories && line) {
                competitionCategories.push(line);
            }
            if (isParsingEmployees && line) {
                const row = line.split('\t').map(item => item.trim());
                const msnv = row[0];
                if (msnv) {
                    employeePastedDataMap.set(msnv, row.slice(2).map(val => parseFloat(val.replace(/,/g, '')) || 0));
                }
            }
        }

        debugInfo.found.push({
            name: 'S·ªë c·ªôt thi ƒëua ƒë√£ nh·∫≠n d·∫°ng',
            value: `${competitionCategories.length} c·ªôt`,
            status: competitionCategories.length > 0
        });
        debugInfo.found.push({
            name: 'S·ªë d√≤ng nh√¢n vi√™n ƒë√£ nh·∫≠n d·∫°ng',
            value: `${employeePastedDataMap.size} d√≤ng`,
            status: employeePastedDataMap.size > 0
        });

        const cleanCompetitionName = (name) => name.replace(/thi ƒëua doanh thu b√°n h√†ng|thi ƒëua doanh thu|thi ƒëua s·ªë l∆∞·ª£ng/gi, "").trim();

        const competitionTargets = luykeCompetitionData.map(comp => ({
            originalName: comp.name,
            cleanedName: cleanCompetitionName(comp.name),
            target: comp.target
        }));

        const totalEmployeesInSupermarket = appState.danhSachNhanVien.length;
        if (totalEmployeesInSupermarket === 0) {
            debugInfo.status = 'L·ªói: Danh s√°ch nh√¢n vi√™n tr·ªëng.';
            return [];
        }

        const finalReport = appState.danhSachNhanVien.map(employee => {
            const salesData = employeePastedDataMap.get(employee.maNV) || [];

            const employeeResult = {
                maNV: employee.maNV,
                hoTen: employee.hoTen,
                completedCount: 0,
                totalCompetitions: competitionCategories.length,
                competitions: []
            };

            competitionCategories.forEach((categoryName, index) => {
                const cleanedName = cleanCompetitionName(categoryName);
                const matchedTarget = competitionTargets.find(t => t.cleanedName === cleanedName);
                const groupTarget = matchedTarget ? matchedTarget.target : 0;
                const individualTarget = totalEmployeesInSupermarket > 0 ? groupTarget / totalEmployeesInSupermarket : 0;
                const actualSales = salesData[index] || 0;
                const percentExpected = individualTarget > 0 ? actualSales / individualTarget : (actualSales > 0 ? Infinity : 0);

                if (percentExpected >= 1) {
                    employeeResult.completedCount++;
                }

                employeeResult.competitions.push({
                    tenNganhHang: categoryName,
                    thucHien: actualSales,
                    mucTieu: individualTarget,
                    conLai: actualSales - individualTarget,
                    percentExpected: percentExpected,
                });
            });

            employeeResult.completionRate = employeeResult.totalCompetitions > 0 ? employeeResult.completedCount / employeeResult.totalCompetitions : 0;
            return employeeResult;
        });

        debugInfo.status = `Th√†nh c√¥ng: ƒê√£ x·ª≠ l√Ω b√°o c√°o cho ${finalReport.length} nh√¢n vi√™n.`;
        return finalReport;
    },

    parsePastedThiDuaTableData(rawText) {
        if (!rawText || !rawText.trim()) {
            return { success: false, error: 'D·ªØ li·ªáu ƒë·∫ßu v√†o r·ªóng.' };
        }

        const lines = rawText.split('\n').map(line => line.trim()).filter(line => line);

        const mainHeaders = [];
        let startHeaderIndex = lines.findIndex(line => line.includes('Ph√≤ng ban'));

        if (startHeaderIndex === -1) {
            return { success: false, error: 'Kh√¥ng t√¨m th·∫•y d√≤ng "Ph√≤ng ban".' };
        }

        for (let i = startHeaderIndex + 1; i < lines.length; i++) {
            const currentLine = lines[i];
            if (currentLine.startsWith('SLLK') || currentLine.startsWith('DTQƒê')) {
                break;
            }
            mainHeaders.push(currentLine);
        }

        let subHeaderLine = lines
            .filter(line => line.startsWith('SLLK') || line.startsWith('DTQƒê'))
            .join('\t');
        const subHeaders = subHeaderLine.split(/\s+/).filter(Boolean);

        const dataRows = [];
        for (const line of lines) {
            const parts = line.split(/\s{2,}|\t/);
            if (parts.length > 1 && /^-?[\d,.]+$/.test(parts[1].trim())) {
                const name = parts[0];
                const values = parts.slice(1);
                dataRows.push({ name, values });
            }
        }

        if (mainHeaders.length === 0 || dataRows.length === 0) {
            return { success: false, error: 'Kh√¥ng th·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu. ƒê·ªãnh d·∫°ng kh√¥ng h·ª£p l·ªá.' };
        }

        return { success: true, mainHeaders, subHeaders, dataRows };
    },

    classifyInsurance: (productName) => {
        if (!productName || typeof productName !== 'string') return null;
        const name = productName.trim().toLowerCase();
        if (name.includes('b·∫£o h√†nh m·ªü r·ªông')) return 'BHMR';
        if (name.includes('1 ƒë·ªïi 1')) return 'BH1d1';
        if (name.includes('kho·∫£n vay')) return 'BHKV';
        if (name.includes('r∆°i v·ª°')) return 'BHRV';
        if (name.includes('samsung care+')) return 'BHSC';
        if (name.includes('√¥ t√¥') || name.includes('v·∫≠t ch·∫•t √¥ t√¥')) return 'BHOTO';
        if (name.includes('xe m√°y') || name.includes('xe moto')) return 'BHXM';
        if (name.includes('x√£ h·ªôi') || name.includes('y t·∫ø')) return 'BHYT';
        return null;
    },

    processGioCongData: () => {
        const gioCongByMSNV = {};
        let currentMaNV = null;

        if (!appState.rawGioCongData || appState.rawGioCongData.length === 0) return gioCongByMSNV;

        for (const row of appState.rawGioCongData) {
            const maNV = String(row.maNV || '').trim();
            const hoTen = String(row.hoTen || '').trim().replace(/\s+/g, ' ');
            let foundMaNV = maNV || appState.employeeNameToMaNVMap.get(hoTen.toLowerCase()) || null;
            if (foundMaNV) currentMaNV = foundMaNV;

            if (currentMaNV && gioCongByMSNV[currentMaNV] === undefined) {
                gioCongByMSNV[currentMaNV] = 0;
            }

            const gioCongValue = parseFloat(String(row.tongGioCong || '0').replace(/,/g, '')) || 0;
            if (currentMaNV && gioCongValue > 0) {
                gioCongByMSNV[currentMaNV] += gioCongValue;
            }
        }
        return gioCongByMSNV;
    },

    _findHeaderAndProcess(sheet, requiredKeywords) {
        if (!sheet) return [];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
        if (rows.length === 0) return [];

        let headerRowIndex = -1;
        let foundHeaders = [];

        for (let i = 0; i < Math.min(rows.length, 10); i++) {
            const row = rows[i];
            const lowerCaseRow = row.map(cell => String(cell || '').trim().toLowerCase());

            const allKeywordsFound = requiredKeywords.every(keyword =>
                lowerCaseRow.some(cell => cell.includes(keyword))
            );

            if (allKeywordsFound) {
                headerRowIndex = i;
                foundHeaders = rows[i].map(cell => String(cell || '').trim());
                break;
            }
        }

        if (headerRowIndex === -1) {
            throw new Error(`Kh√¥ng t√¨m th·∫•y d√≤ng ti√™u ƒë·ªÅ ch·ª©a ƒë·ªß c√°c t·ª´ kh√≥a: ${requiredKeywords.join(', ')}.`);
        }

        const dataRows = rows.slice(headerRowIndex + 1);
        const jsonData = dataRows.map(row => {
            const obj = {};
            foundHeaders.forEach((header, index) => {
                if (header) {
                    const value = row[index];
                    const upperKey = header.toUpperCase();
                    if (upperKey.includes('K√äNH') || upperKey.includes('SI√äU TH·ªä') || upperKey.includes('NG√ÄNH H√ÄNG') || upperKey.includes('T·ªàNH') || upperKey.includes('BOSS')) {
                        obj[header] = value;
                    } else if (typeof value === 'string' && value.includes('%')) {
                        obj[header] = parseFloat(value.replace(/%|,/g, '')) / 100 || 0;
                    } else if (value !== null && value !== undefined) {
                        obj[header] = parseFloat(String(value).replace(/,/g, '')) || 0;
                    } else {
                        obj[header] = 0;
                    }
                }
            });
            return obj;
        }).filter(obj => {
            const supermarketKey = Object.keys(obj).find(k => k.toLowerCase().includes('si√™u th·ªã'));
            return supermarketKey && obj[supermarketKey];
        });

        return jsonData;
    },

    processThiDuaVungFile(workbook) {
        const sheetNames = workbook.SheetNames;
        const chiTietSheet = workbook.Sheets[sheetNames.find(name => name.toUpperCase().includes('CHITIET'))];
        const tongSheet = workbook.Sheets[sheetNames.find(name => name.toUpperCase().includes('TONG'))];

        if (!chiTietSheet || !tongSheet) {
            throw new Error('File Excel ph·∫£i ch·ª©a sheet c√≥ t√™n ch·ª©a "CHITIET" v√† "TONG".');
        }

        const chiTietData = this._findHeaderAndProcess(chiTietSheet, ['si√™u th·ªã', 'ng√†nh h√†ng', 'k√™nh']);
        const tongData = this._findHeaderAndProcess(tongSheet, ['si√™u th·ªã', 't·ªïng th∆∞·ªüng']);

        return { chiTietData, tongData };
    },
};
--- END FILE: ./services/data-processing.js ---

--- START FILE: ./services.js ---
// Version 38.0 - Refactor: Rework generateLuyKeEmployeeDetailReport to support new UI
// MODULE: SERVICES FACADE
// File n√†y ƒë√≥ng vai tr√≤ ƒëi·ªÅu ph·ªëi, nh·∫≠p kh·∫©u c√°c module logic con v√† export ch√∫ng ra ngo√†i.

import { config } from './config.js';
import { appState } from './state.js';
import { ui } from './ui.js';
import { utils } from './utils.js';
import { dataProcessing } from './services/data-processing.js';

const reportGeneration = {
    calculateCompetitionFocusReport(sourceYcxData, competitionConfigs) {
        if (!sourceYcxData || sourceYcxData.length === 0 || !competitionConfigs || competitionConfigs.length === 0) {
            return [];
        }

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();

        const validSalesData = sourceYcxData.filter(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' &&
                                (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' &&
                                (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£' &&
                                (row.trangThaiXuat || "").trim() === 'ƒê√£ xu·∫•t';
            return isBaseValid && isDoanhThuHTX;
        });

        const report = competitionConfigs.map(config => {
            const cleanedConfigGroups = new Set((config.groups || []).map(g => utils.cleanCategoryName(g)));

            let baseSalesData = validSalesData.filter(row => {
                const cleanNhomHangFromYCX = utils.cleanCategoryName(row.nhomHang);
                
                const isInGroup = cleanedConfigGroups.has(cleanNhomHangFromYCX);
                if (!isInGroup) return false;

                if (config.type === 'soluong' && (config.minPrice > 0 || config.maxPrice > 0)) {
                    const price = (parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0) / (parseInt(String(row.soLuong || "1"), 10) || 1);
                    const minPrice = config.minPrice || 0;
                    const maxPrice = config.maxPrice || Infinity;
                    if (price < minPrice || price > maxPrice) return false;
                }
                return true;
            });

            if (config.excludeApple) {
                baseSalesData = baseSalesData.filter(row => row.nhaSanXuat !== 'Apple');
            }
            
            const employeeResults = appState.danhSachNhanVien.map(employee => {
                let performanceByBrand = {};
                let totalTargetRevenue = 0;
                let totalTargetQuantity = 0;
                let baseCategoryRevenue = 0;
                let baseCategoryQuantity = 0;
                
                baseSalesData.forEach(row => {
                    const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
                    if (msnvMatch && msnvMatch[1].trim() === employee.maNV) {
                        const revenueValue = (parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0);
                        const quantityValue = (parseInt(String(row.soLuong || "0"), 10) || 0);

                        baseCategoryRevenue += revenueValue;
                        baseCategoryQuantity += quantityValue;

                        const brand = row.nhaSanXuat;
                        if ((config.brands || []).includes(brand)) {
                            if (!performanceByBrand[brand]) {
                                performanceByBrand[brand] = { revenue: 0, quantity: 0 };
                            }
                            performanceByBrand[brand].revenue += revenueValue;
                            performanceByBrand[brand].quantity += quantityValue;

                            totalTargetRevenue += revenueValue;
                            totalTargetQuantity += quantityValue;
                        }
                    }
                });
                
                return {
                    maNV: employee.maNV,
                    hoTen: employee.hoTen,
                    boPhan: employee.boPhan,
                    performanceByBrand,
                    targetBrandsRevenue: totalTargetRevenue,
                    targetBrandsQuantity: totalTargetQuantity,
                    baseCategoryRevenue,
                    baseCategoryQuantity,
                    tyLeDT: baseCategoryRevenue > 0 ? (totalTargetRevenue / baseCategoryRevenue) : 0,
                    tyLeSL: baseCategoryQuantity > 0 ? (totalTargetQuantity / baseCategoryQuantity) : 0,
                };
            }).filter(e => e.baseCategoryRevenue > 0 || e.baseCategoryQuantity > 0);

            return {
                competition: config,
                employeeData: employeeResults,
            };
        }).filter(r => r.employeeData.length > 0);

        return report;
    },

    generateMasterReportData: (sourceData, goalSettings, isRealtime = false) => {
        if (appState.danhSachNhanVien.length === 0) return [];

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const hinhThucXuatTraGop = dataProcessing.getHinhThucXuatTraGop();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();
        const PG = config.PRODUCT_GROUPS;
        const gioCongByMSNV = dataProcessing.processGioCongData();
        const thuongNongByMSNV = {};

        appState.thuongNongData.forEach(row => {
            const maNV = String(row.maNV || '').trim();
            const hoTen = String(row.hoTen || '').trim().replace(/\s+/g, ' ');
            let foundMaNV = maNV || appState.employeeNameToMaNVMap.get(hoTen.toLowerCase()) || null;
            if (foundMaNV) {
                const diemThuongValue = parseFloat(String(row.diemThuong || '0').replace(/,/g, '')) || 0;
                thuongNongByMSNV[foundMaNV] = (thuongNongByMSNV[foundMaNV] || 0) + diemThuongValue;
            }
        });
        
        const thuongNongThangTruocByMSNV = {};
        appState.thuongNongDataThangTruoc.forEach(row => {
            const maNV = String(row.maNV || '').trim();
            const hoTen = String(row.hoTen || '').trim().replace(/\s+/g, ' ');
            let foundMaNV = maNV || appState.employeeNameToMaNVMap.get(hoTen.toLowerCase()) || null;
            if (foundMaNV) {
                const diemThuongValue = parseFloat(String(row.diemThuong || '0').replace(/,/g, '')) || 0;
                thuongNongThangTruocByMSNV[foundMaNV] = (thuongNongThangTruocByMSNV[foundMaNV] || 0) + diemThuongValue;
            }
        });

        return appState.danhSachNhanVien.map((employee) => {
            let data = {
                doanhThu: 0, doanhThuQuyDoi: 0, doanhThuTraGop: 0, doanhThuTraGopQuyDoi: 0, 
                doanhThuChuaXuat: 0, doanhThuQuyDoiChuaXuat: 0,
                doanhThuGiaoXa: 0, doanhThuQuyDoiGiaoXa: 0,
                dtICT: 0, dtCE: 0, dtPhuKien: 0, dtGiaDung: 0, dtMLN: 0,
                slICT: 0, dtBaoHiem: 0, slBaoHiem: 0,
                slPhuKien: 0, slGiaDung: 0, slCE: 0, slPinSDP: 0, slCamera: 0,
                slTaiNgheBLT: 0, slNoiChien: 0, slMLN: 0, slRobotHB: 0,
                slBH1d1: 0, slBHXM: 0, slBHRV: 0, slBHMR: 0, 
                dtTivi: 0, slTivi: 0, dtTuLanh: 0, slTuLanh: 0,
                dtMayGiat: 0, slMayGiat: 0, dtMayLanh: 0, slMayLanh: 0,
                dtDienThoai: 0, slDienThoai: 0, dtLaptop: 0, slLaptop: 0,
                doanhThuTheoNganhHang: {}, slSimOnline: 0, slUDDD: 0, slBaoHiemVAS: 0, slSmartphone: 0, slBaoHiemDenominator: 0,
                qdc: {}
            };

            for (const key in PG.QDC_GROUPS) data.qdc[key] = { sl: 0, dt: 0, dtqd: 0, name: PG.QDC_GROUPS[key].name };

            sourceData.forEach(row => {
                const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
                if (msnvMatch && msnvMatch[1].trim() === employee.maNV) {
                    const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
                    const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' && (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' && (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£';
                    
                    if (isBaseValid && isDoanhThuHTX) {
                        const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                        if(isNaN(thanhTien)) return;

                        const heSo = heSoQuyDoi[row.nhomHang] || 1;
                        const trangThaiXuat = (row.trangThaiXuat || "").trim();

                        const nhomHangCode = String(row.nhomHang || '').match(/^\d+/)?.[0] || null;
                        const nganhHangCode = String(row.nganhHang || '').match(/^\d+/)?.[0] || null;

                        const isICT = PG.ICT.includes(nhomHangCode);
                        const isCE = PG.CE.includes(nhomHangCode);
                        const isPhuKien = PG.PHU_KIEN.includes(nganhHangCode);
                        const isGiaDung = PG.GIA_DUNG.includes(nganhHangCode);
                        const isMLN = PG.MAY_LOC_NUOC.includes(nhomHangCode);

                        if (trangThaiXuat === 'Ch∆∞a xu·∫•t') {
                            data.doanhThuChuaXuat += thanhTien;
                            data.doanhThuQuyDoiChuaXuat += thanhTien * heSo;
                        } else if (trangThaiXuat === 'ƒê√£ xu·∫•t') {
                            const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;
                            if(isNaN(soLuong)) return;
                            
                            const nganhHangName = utils.cleanCategoryName(row.nganhHang);

                            if (row.hinhThucXuat !== 'Xu·∫•t d·ªãch v·ª• thu h·ªô b·∫£o hi·ªÉm') { 
                                data.doanhThu += thanhTien; 
                                data.doanhThuQuyDoi += thanhTien * heSo; 

                                if (isRealtime && row.ngayTao && row.ngayHenGiao) {
                                    const diffTime = row.ngayHenGiao - row.ngayTao;
                                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                    if (diffDays >= 2) {
                                        data.doanhThuGiaoXa += thanhTien;
                                        data.doanhThuQuyDoiGiaoXa += thanhTien * heSo;
                                    }
                                }
                            }
                            if (hinhThucXuatTraGop.has(row.hinhThucXuat)) { data.doanhThuTraGop += thanhTien; data.doanhThuTraGopQuyDoi += thanhTien * heSo; }
                            
                            if (nganhHangName) {
                                if (!data.doanhThuTheoNganhHang[nganhHangName]) data.doanhThuTheoNganhHang[nganhHangName] = { revenue: 0, quantity: 0, revenueQuyDoi: 0 };
                                data.doanhThuTheoNganhHang[nganhHangName].revenue += thanhTien;
                                data.doanhThuTheoNganhHang[nganhHangName].quantity += soLuong;
                                data.doanhThuTheoNganhHang[nganhHangName].revenueQuyDoi += thanhTien * heSo;
                            }
                            
                            if (isICT) { data.dtICT += thanhTien; }
                            if (isCE) { data.dtCE += thanhTien; data.slCE += soLuong; }
                            if (isPhuKien) { data.dtPhuKien += thanhTien; data.slPhuKien += soLuong; }
                            if (isGiaDung) { data.dtGiaDung += thanhTien; data.slGiaDung += soLuong; }
                            if (isMLN) { data.dtMLN += thanhTien; data.slMLN += soLuong; }

                            if (PG.DIEN_THOAI.includes(nhomHangCode)) { data.dtDienThoai += thanhTien; data.slDienThoai += soLuong; }
                            if (PG.LAPTOP.includes(nhomHangCode)) { data.dtLaptop += thanhTien; data.slLaptop += soLuong; }
                            if (PG.TIVI.includes(nhomHangCode)) { data.dtTivi += thanhTien; data.slTivi += soLuong; }
                            if (PG.TU_LANH.includes(nhomHangCode)) { data.dtTuLanh += thanhTien; data.slTuLanh += soLuong; }
                            if (PG.MAY_GIAT.includes(nhomHangCode)) { data.dtMayGiat += thanhTien; data.slMayGiat += soLuong; }
                            if (PG.MAY_LANH.includes(nhomHangCode)) { data.dtMayLanh += thanhTien; data.slMayLanh += soLuong; }

                            const loaiBaoHiem = dataProcessing.classifyInsurance(row.tenSanPham);
                            if (loaiBaoHiem) { 
                                data.dtBaoHiem += thanhTien; data.slBaoHiem += soLuong; 
                                if (loaiBaoHiem === 'BH1d1') data.slBH1d1 += soLuong;
                                if (loaiBaoHiem === 'BHXM') data.slBHXM += soLuong;
                                if (loaiBaoHiem === 'BHRV') data.slBHRV += soLuong;
                                if (loaiBaoHiem === 'BHMR') data.slBHMR += soLuong;
                            }
                            if (nhomHangCode === PG.PIN_SDP) data.slPinSDP += soLuong;
                            if (nhomHangCode === PG.CAMERA_TRONG_NHA || nhomHangCode === PG.CAMERA_NGOAI_TROI) data.slCamera += soLuong;
                            if (nhomHangCode === PG.TAI_NGHE_BLT) data.slTaiNgheBLT += soLuong;
                            if (nhomHangCode === PG.NOI_CHIEN) data.slNoiChien += soLuong;
                            if (nhomHangCode === PG.ROBOT_HB) data.slRobotHB += soLuong;

                            if (PG.SIM.includes(nhomHangCode)) data.slSimOnline += soLuong;
                            if (PG.VAS.includes(nhomHangCode)) data.slUDDD += soLuong;
                            if (PG.SMARTPHONE.includes(nhomHangCode)) data.slSmartphone += soLuong;
                            if (PG.BAO_HIEM_VAS.includes(nhomHangCode)) data.slBaoHiemVAS += soLuong;
                            if (PG.BAO_HIEM_DENOMINATOR.includes(nhomHangCode)) data.slBaoHiemDenominator += soLuong;

                            for (const key in PG.QDC_GROUPS) if (PG.QDC_GROUPS[key].codes.includes(nhomHangCode)) {
                                data.qdc[key].sl += soLuong; data.qdc[key].dt += thanhTien; data.qdc[key].dtqd += thanhTien * heSo;
                            }
                        }
                    }
                }
            });

            data.slICT = data.slDienThoai + data.slLaptop;
            const gioCong = gioCongByMSNV[employee.maNV] || 0;
            const thuongNong = thuongNongByMSNV[employee.maNV] || 0;
            const erpEntry = appState.thuongERPData.find(e => e.name.includes(employee.hoTen));
            const thuongERP = erpEntry ? parseFloat(erpEntry.bonus.replace(/,/g, '')) : 0;
            const tongThuNhap = thuongNong + thuongERP;
            const today = new Date();
            const currentDay = today.getDate();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            let thuNhapDuKien = 0;
            if (currentDay > 1) thuNhapDuKien = (tongThuNhap / (currentDay - 1)) * daysInMonth;
            else if (currentDay === 1) thuNhapDuKien = tongThuNhap * daysInMonth;

            const thuongNongThangTruoc = thuongNongThangTruocByMSNV[employee.maNV] || 0;
            const erpEntryThangTruoc = appState.thuongERPDataThangTruoc.find(e => e.name.includes(employee.hoTen));
            const thuongERPThangTruoc = erpEntryThangTruoc ? parseFloat(erpEntryThangTruoc.bonus.replace(/,/g, '')) : 0;
            const thuNhapThangTruoc = thuongNongThangTruoc + thuongERPThangTruoc;
            const chenhLechThuNhap = thuNhapDuKien - thuNhapThangTruoc;

            const hieuQuaQuyDoi = data.doanhThu > 0 ? (data.doanhThuQuyDoi / data.doanhThu) - 1 : 0;
            const tyLeTraCham = data.doanhThu > 0 ? data.doanhThuTraGop / data.doanhThu : 0;
            const pctPhuKien = data.dtICT > 0 ? data.dtPhuKien / data.dtICT : 0;
            const pctGiaDung = data.dtCE > 0 ? data.dtGiaDung / data.dtCE : 0;
            const pctMLN = data.dtCE > 0 ? data.dtMLN / data.dtCE : 0;
            const pctSim = data.slSmartphone > 0 ? data.slSimOnline / data.slSmartphone : 0;
            const pctVAS = data.slSmartphone > 0 ? data.slUDDD / data.slSmartphone : 0;
            const pctBaoHiem = data.slBaoHiemDenominator > 0 ? data.slBaoHiemVAS / data.slBaoHiemDenominator : 0;
            
            data.donGiaTivi = data.slTivi > 0 ? data.dtTivi / data.slTivi : 0;
            data.donGiaTuLanh = data.slTuLanh > 0 ? data.dtTuLanh / data.slTuLanh : 0;
            data.donGiaMayGiat = data.slMayGiat > 0 ? data.dtMayGiat / data.slMayGiat : 0;
            data.donGiaMayLanh = data.slMayLanh > 0 ? data.dtMayLanh / data.slMayLanh : 0;
            data.donGiaDienThoai = data.slDienThoai > 0 ? data.dtDienThoai / data.slDienThoai : 0;
            data.donGiaLaptop = data.slLaptop > 0 ? data.dtLaptop / data.slLaptop : 0;
            
            const totalQuantity = Object.values(data.doanhThuTheoNganhHang).reduce((sum, category) => sum + category.quantity, 0);
            const donGiaTrungBinh = totalQuantity > 0 ? data.doanhThu / totalQuantity : 0;

            return { ...employee, ...data, gioCong, thuongNong, thuongERP, tongThuNhap, thuNhapDuKien, thuNhapThangTruoc, chenhLechThuNhap, hieuQuaQuyDoi, tyLeTraCham, pctPhuKien, pctGiaDung, pctMLN, pctSim, pctVAS, pctBaoHiem, donGiaTrungBinh, mucTieu: goalSettings };
        });
    },

    generateLuyKeChuaXuatReport(sourceYcxData) {
        if (!sourceYcxData || sourceYcxData.length === 0) return [];

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();
        const report = {};

        sourceYcxData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' &&
                                 (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' &&
                                (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£' &&
                                (row.trangThaiXuat || "").trim() === 'Ch∆∞a xu·∫•t';

            if (isBaseValid && isDoanhThuHTX) {
                const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;
                if (isNaN(thanhTien) || isNaN(soLuong)) return;

                const nganhHangName = utils.cleanCategoryName(row.nganhHang);
                const heSo = heSoQuyDoi[row.nhomHang] || 1;

                if (!report[nganhHangName]) {
                    report[nganhHangName] = {
                        nganhHang: nganhHangName,
                        soLuong: 0,
                        doanhThuThuc: 0,
                        doanhThuQuyDoi: 0
                    };
                }
                
                report[nganhHangName].soLuong += soLuong;
                report[nganhHangName].doanhThuThuc += thanhTien;
                report[nganhHangName].doanhThuQuyDoi += thanhTien * heSo;
            }
        });

        return Object.values(report);
    },

    generateRealtimeChuaXuatReport(sourceRealtimeYcxData) {
        if (!sourceRealtimeYcxData || sourceRealtimeYcxData.length === 0) return [];

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();
        const report = {};

        sourceRealtimeYcxData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' &&
                                (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' &&
                                (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£' &&
                                (row.trangThaiXuat || "").trim() === 'Ch∆∞a xu·∫•t';

            if (isBaseValid && isDoanhThuHTX) {
                const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;
                if (isNaN(thanhTien) || isNaN(soLuong)) return;

                const nganhHangName = utils.cleanCategoryName(row.nganhHang);
                const heSo = heSoQuyDoi[row.nhomHang] || 1;

                if (!report[nganhHangName]) {
                    report[nganhHangName] = {
                        nganhHang: nganhHangName,
                        soLuong: 0,
                        doanhThuThuc: 0,
                        doanhThuQuyDoi: 0
                    };
                }
                
                report[nganhHangName].soLuong += soLuong;
                report[nganhHangName].doanhThuThuc += thanhTien;
                report[nganhHangName].doanhThuQuyDoi += thanhTien * heSo;
            }
        });

        return Object.values(report);
    },

    calculateDepartmentAverages(departmentName, reportData) {
        const departmentEmployees = reportData.filter(e => e.boPhan === departmentName);
        if (departmentEmployees.length === 0) return {};

        const totals = departmentEmployees.reduce((acc, curr) => {
            Object.keys(curr).forEach(key => {
                if (typeof curr[key] === 'number') acc[key] = (acc[key] || 0) + curr[key];
                if (key === 'qdc' && typeof curr[key] === 'object') {
                    if (!acc.qdc) acc.qdc = {};
                    for (const qdcKey in curr.qdc) {
                        if (!acc.qdc[qdcKey]) acc.qdc[qdcKey] = { sl: 0, dt: 0, dtqd: 0 };
                        acc.qdc[qdcKey].sl += curr.qdc[qdcKey].sl;
                        acc.qdc[qdcKey].dt += curr.qdc[qdcKey].dt;
                        acc.qdc[qdcKey].dtqd += curr.qdc[qdcKey].dtqd;
                    }
                }
            });
            return acc;
        }, {});

        const averages = {};
        for (const key in totals) {
            if (key !== 'qdc') averages[key] = totals[key] / departmentEmployees.length;
            else {
                averages.qdc = {};
                for (const qdcKey in totals.qdc) averages.qdc[qdcKey] = {
                    sl: totals.qdc[qdcKey].sl / departmentEmployees.length,
                    dt: totals.qdc[qdcKey].dt / departmentEmployees.length,
                    dtqd: totals.qdc[qdcKey].dtqd / departmentEmployees.length
                };
            }
        }
        return averages;
    },

    generateRealtimeEmployeeDetailReport(employeeMaNV, realtimeYCXData) {
        if (!employeeMaNV || !realtimeYCXData || realtimeYCXData.length === 0) return null;
    
        const employeeData = realtimeYCXData.filter(row => {
            const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
            return msnvMatch && msnvMatch[1].trim() === String(employeeMaNV);
        });
    
        if (employeeData.length === 0) return null;
    
        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();
        
        const summary = { 
            totalRealRevenue: 0, 
            totalConvertedRevenue: 0,
            unexportedRevenue: 0
        };
        const byProductGroup = {};
        const byCustomer = {};
    
        employeeData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' && (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' && (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£';
    
            if (isDoanhThuHTX && isBaseValid) {
                const realRevenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const quantity = parseInt(String(row.soLuong || "0"), 10) || 0;
                const heSo = heSoQuyDoi[row.nhomHang] || 1;
                const convertedRevenue = realRevenue * heSo;
                const groupName = utils.cleanCategoryName(row.nhomHang || 'Kh√°c');
                const customerName = row.tenKhachHang || 'Kh√°ch l·∫ª';
    
                if ((row.trangThaiXuat || "").trim() === 'ƒê√£ xu·∫•t') {
                    summary.totalRealRevenue += realRevenue;
                    summary.totalConvertedRevenue += convertedRevenue;

                    if (!byProductGroup[groupName]) {
                        byProductGroup[groupName] = { name: groupName, quantity: 0, realRevenue: 0, convertedRevenue: 0 };
                    }
                    byProductGroup[groupName].quantity += quantity;
                    byProductGroup[groupName].realRevenue += realRevenue;
                    byProductGroup[groupName].convertedRevenue += convertedRevenue;
        
                    if (!byCustomer[customerName]) {
                        byCustomer[customerName] = { name: customerName, products: [], totalQuantity: 0 };
                    }
                    byCustomer[customerName].products.push({
                        productName: row.tenSanPham,
                        quantity: quantity,
                        realRevenue: realRevenue,
                        convertedRevenue: convertedRevenue,
                    });
                    byCustomer[customerName].totalQuantity += quantity;
                } else if ((row.trangThaiXuat || "").trim() === 'Ch∆∞a xu·∫•t') {
                    summary.unexportedRevenue += convertedRevenue;
                }
            }
        });
    
        summary.totalOrders = Object.keys(byCustomer).length;
        summary.bundledOrderCount = Object.values(byCustomer).filter(c => c.totalQuantity > 1).length;
        summary.conversionRate = summary.totalRealRevenue > 0 ? (summary.totalConvertedRevenue / summary.totalRealRevenue) - 1 : 0;
    
        return {
            summary,
            byProductGroup: Object.values(byProductGroup).sort((a, b) => b.realRevenue - a.realRevenue),
            byCustomer: Object.values(byCustomer)
        };
    },

    // === START: REFACTORED FUNCTION FOR LUY KE EMPLOYEE DETAIL (v38.0) ===
    generateLuyKeEmployeeDetailReport(employeeMaNV, luykeYCXData) {
        if (!employeeMaNV || !luykeYCXData || luykeYCXData.length === 0) {
            return null;
        }
    
        const employeeData = luykeYCXData.filter(row => {
            const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
            return msnvMatch && msnvMatch[1].trim() === String(employeeMaNV);
        });
    
        if (employeeData.length === 0) {
            return null;
        }
    
        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();
        
        const summary = {
            totalRealRevenue: 0,
            totalConvertedRevenue: 0,
            unexportedRevenue: 0, // Calculated from master data
        };
        const byProductGroup = {};
        const byCustomer = {};
        const categoryChartDataMap = {};

        const employeeMasterData = appState.masterReportData.sknv.find(e => String(e.maNV) === String(employeeMaNV));
        if (employeeMasterData) {
            summary.unexportedRevenue = employeeMasterData.doanhThuChuaXuat || 0;
        }
    
        employeeData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' &&
                                (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' &&
                                (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£' &&
                                (row.trangThaiXuat || "").trim() === 'ƒê√£ xu·∫•t';
    
            if (isDoanhThuHTX && isBaseValid) {
                const realRevenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const quantity = parseInt(String(row.soLuong || "0"), 10) || 0;
                if(isNaN(realRevenue) || isNaN(quantity)) return;

                const heSo = heSoQuyDoi[row.nhomHang] || 1;
                const convertedRevenue = realRevenue * heSo;
                const groupName = utils.cleanCategoryName(row.nhomHang || 'Kh√°c');
                const customerName = row.tenKhachHang || 'Kh√°ch L·∫ª';
                const categoryName = utils.cleanCategoryName(row.nganhHang || 'Kh√°c');

                // For Summary KPIs
                summary.totalRealRevenue += realRevenue;
                summary.totalConvertedRevenue += convertedRevenue;

                // For Top 8 Product Groups
                if (!byProductGroup[groupName]) {
                    byProductGroup[groupName] = { name: groupName, quantity: 0, realRevenue: 0, convertedRevenue: 0 };
                }
                byProductGroup[groupName].quantity += quantity;
                byProductGroup[groupName].realRevenue += realRevenue;
                byProductGroup[groupName].convertedRevenue += convertedRevenue;

                // For Chart Data
                if (!categoryChartDataMap[categoryName]) {
                    categoryChartDataMap[categoryName] = { name: categoryName, revenue: 0 };
                }
                categoryChartDataMap[categoryName].revenue += realRevenue;

                // For Customer Accordion
                if (!byCustomer[customerName]) {
                    byCustomer[customerName] = { name: customerName, products: [], totalQuantity: 0, totalRealRevenue: 0, totalConvertedRevenue: 0 };
                }
                byCustomer[customerName].products.push({
                    productName: row.tenSanPham,
                    quantity: quantity,
                    realRevenue: realRevenue,
                    convertedRevenue: convertedRevenue,
                });
                byCustomer[customerName].totalQuantity += quantity;
                byCustomer[customerName].totalRealRevenue += realRevenue;
                byCustomer[customerName].totalConvertedRevenue += convertedRevenue;
            }
        });
    
        // Final calculations for summary
        summary.totalOrders = Object.keys(byCustomer).length;
        summary.bundledOrderCount = Object.values(byCustomer).filter(c => c.products.length > 1).length;
        summary.conversionRate = summary.totalRealRevenue > 0 ? (summary.totalConvertedRevenue / summary.totalRealRevenue) - 1 : 0;
    
        // Final calculations for customers and product groups
        for (const customerName in byCustomer) {
            const customer = byCustomer[customerName];
            customer.conversionRate = customer.totalRealRevenue > 0 ? (customer.totalConvertedRevenue / customer.totalRealRevenue) - 1 : 0;
        }
        for (const groupName in byProductGroup) {
            const group = byProductGroup[groupName];
            group.conversionRate = group.realRevenue > 0 ? (group.convertedRevenue / group.realRevenue) - 1 : 0;
        }
    
        return {
            summary,
            topProductGroups: Object.values(byProductGroup)
                .sort((a, b) => b.realRevenue - a.realRevenue)
                .slice(0, 8),
            categoryChartData: Object.values(categoryChartDataMap),
            byCustomer: Object.values(byCustomer)
                .sort((a,b) => b.totalRealRevenue - a.totalRealRevenue)
        };
    },
    // === END: REFACTORED FUNCTION ===
    
    generateRealtimeBrandReport(realtimeYCXData, selectedCategory, selectedBrand) {
        if (!realtimeYCXData || realtimeYCXData.length === 0) return { byBrand: [], byEmployee: [] };
        
        const filteredData = realtimeYCXData.filter(row => {
            const categoryMatch = !selectedCategory || utils.cleanCategoryName(row.nganhHang) === selectedCategory;
            const brandMatch = !selectedBrand || (row.nhaSanXuat || 'H√£ng kh√°c') === selectedBrand;
            const isDoanhThuHTX = dataProcessing.getHinhThucXuatTinhDoanhThu().has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' && (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' && (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£' && (row.trangThaiXuat || "").trim() === 'ƒê√£ xu·∫•t';

            return categoryMatch && brandMatch && isDoanhThuHTX && isBaseValid;
        });
    
        const byBrand = {};
        const byEmployee = {};
    
        filteredData.forEach(row => {
            const brand = row.nhaSanXuat || 'H√£ng kh√°c';
            const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
            const employeeId = msnvMatch ? msnvMatch[1].trim() : 'Unknown';
            const realRevenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
            const quantity = parseInt(String(row.soLuong || "0"), 10) || 0;
    
            if (!byBrand[brand]) {
                byBrand[brand] = { name: brand, quantity: 0, revenue: 0 };
            }
            byBrand[brand].quantity += quantity;
            byBrand[brand].revenue += realRevenue;
    
            if (!byEmployee[employeeId]) {
                const employeeInfo = appState.employeeMaNVMap.get(employeeId);
                byEmployee[employeeId] = { id: employeeId, name: employeeInfo ? employeeInfo.hoTen : `NV ${employeeId}`, quantity: 0, revenue: 0 };
            }
            byEmployee[employeeId].quantity += quantity;
            byEmployee[employeeId].revenue += realRevenue;
        });
    
        const brandArray = Object.values(byBrand).map(b => ({...b, avgPrice: b.quantity > 0 ? b.revenue / b.quantity : 0})).sort((a,b) => b.revenue - a.revenue);
        const employeeArray = Object.values(byEmployee).sort((a,b) => b.revenue - a.revenue);
    
        return { byBrand: brandArray, byEmployee: employeeArray };
    },
};

const composerServices = {
    getEmployeeRanking(reportData, key, direction = 'desc', count = 3, department = 'ALL') {
        if (!reportData || reportData.length === 0) return [];
        
        let filteredData = reportData;
        if (department !== 'ALL') {
            filteredData = reportData.filter(e => e.boPhan === department);
        }

        return [...filteredData]
            .filter(e => e[key] > 0)
            .sort((a, b) => direction === 'desc' ? (b[key] || 0) - (a[key] || 0) : (a[key] || 0) - (b[key] || 0))
            .slice(0, count);
    },
    
    getEmployeesBelowTarget(reportData, dataKey, goalKey, department = 'ALL') {
        if (!reportData || reportData.length === 0) return [];

        let filteredData = reportData;
        if (department !== 'ALL') {
            filteredData = reportData.filter(e => e.boPhan === department);
        }

        return filteredData.filter(employee => {
            const value = employee[dataKey] || 0;
            const target = (employee.mucTieu?.[goalKey] || 0) / 100;
            return target > 0 && value < target;
        }).sort((a, b) => (b[dataKey] || 0) - (a[dataKey] || 0));
    },

    formatEmployeeList(employeeArray, valueKey, valueType = 'number') {
        if (!Array.isArray(employeeArray) || employeeArray.length === 0) {
            return " (kh√¥ng c√≥)";
        }
        return "\n" + employeeArray.map((e, index) => {
            const value = e[valueKey];
            let formattedValue = '';
            if (valueType === 'percent') {
                formattedValue = ui.formatPercentage(value);
            } else if (valueType === 'currency') {
                formattedValue = ui.formatRevenue(value) + " tr";
            } else {
                 formattedValue = ui.formatNumberOrDash(value);
            }
            return `${index + 1}. ${ui.getShortEmployeeName(e.hoTen, e.maNV)}: ${formattedValue} @${e.maNV}`;
        }).join("\n");
    },
    
    processComposerTemplate(template, supermarketReport, goals, rankingReportData, competitionData, sectionId) {
        if (!template || !supermarketReport || !goals) {
            return "L·ªói: D·ªØ li·ªáu kh√¥ng ƒë·ªß ƒë·ªÉ t·∫°o nh·∫≠n x√©t.";
        }
    
        const tagMapping = {
            'DTQD': { key: 'doanhThuQuyDoi', format: 'currency' },
            'THUNHAP': { key: 'tongThuNhap', format: 'currency' },
            'TLQD': { key: 'hieuQuaQuyDoi', format: 'percent' },
        };

        const botTargetMapping = {
            'TLQD': { dataKey: 'hieuQuaQuyDoi', goalKey: 'phanTramQD', format: 'percent' },
            'TLTC': { dataKey: 'tyLeTraCham', goalKey: 'phanTramTC', format: 'percent' },
            'PK': { dataKey: 'pctPhuKien', goalKey: 'phanTramPhuKien', format: 'percent' },
            'GD': { dataKey: 'pctGiaDung', goalKey: 'phanTramGiaDung', format: 'percent' },
            'MLN': { dataKey: 'pctMLN', goalKey: 'phanTramMLN', format: 'percent' },
            'SIM': { dataKey: 'pctSim', goalKey: 'phanTramSim', format: 'percent' },
            'VAS': { dataKey: 'pctVAS', goalKey: 'phanTramVAS', format: 'percent' },
            'BH': { dataKey: 'pctBaoHiem', goalKey: 'phanTramBaoHiem', format: 'percent' },
        };
        
        return template.replace(/\[(.*?)\]/g, (match, tag) => {
            const now = new Date();
            const currentDay = now.getDate() || 1;

            let dtThuc = supermarketReport.doanhThu || 0;
            let dtQd = supermarketReport.doanhThuQuyDoi || 0;
            let phanTramHTQD = goals.doanhThuQD > 0 ? (dtQd / 1000000) / goals.doanhThuQD : 0;
            
            if (sectionId === 'luyke') {
                const pastedLuyKeData = dataProcessing.parseLuyKePastedData(document.getElementById('paste-luyke')?.value || '');
                if (pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DT th·ª±c']) {
                    dtThuc = parseFloat(pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DT th·ª±c'].replace(/,/g, '')) * 1000000;
                }
                if (pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DTQƒê']) {
                    dtQd = parseFloat(pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DTQƒê'].replace(/,/g, '')) * 1000000;
                }
                if (pastedLuyKeData.mainKpis['% HT Target D·ª± Ki·∫øn (Qƒê)']) {
                    phanTramHTQD = (parseFloat(pastedLuyKeData.mainKpis['% HT Target D·ª± Ki·∫øn (Qƒê)'].replace('%', '')) || 0) / 100;
                }
            }

            if (tag === 'NGAY') return now.toLocaleDateString('vi-VN');
            if (tag === 'GIO') return now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            if (tag === 'DT_THUC') return ui.formatNumber(dtThuc / 1000000, 0) + " tr";
            if (tag === 'DTQD') return ui.formatNumber(dtQd / 1000000, 0) + " tr";
            if (tag === '%HT_DTQD') return ui.formatPercentage(phanTramHTQD);
            
            if (tag === 'TLQD') {
                if (sectionId === 'luyke') {
                    const pastedLuyKeData = dataProcessing.parseLuyKePastedData(document.getElementById('paste-luyke')?.value || '');
                    if (pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DT th·ª±c'] && pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DTQƒê']) {
                        const dtThucPasted = parseFloat(String(pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DT th·ª±c']).replace(/,/g, ''));
                        const dtQdPasted = parseFloat(String(pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DTQƒê']).replace(/,/g, ''));
                        if (dtThucPasted > 0) {
                            return ui.formatPercentage((dtQdPasted / dtThucPasted) - 1);
                        }
                    }
                }
                return ui.formatPercentage(supermarketReport.hieuQuaQuyDoi || 0);
            }

            if (tag === '%HT_DTT') {
                const target = parseFloat(goals.doanhThuThuc) || 0;
                const percent = target > 0 ? (dtThuc / 1000000) / target : 0;
                return ui.formatPercentage(percent);
            }
            if (tag === 'DT_CHUAXUAT') return ui.formatRevenue(supermarketReport.doanhThuQuyDoiChuaXuat || 0) + " tr";
            if (tag === 'SS_CUNGKY') return supermarketReport.comparisonData?.percentage || 'N/A';

            if (tag.startsWith('TD_')) {
                const total = competitionData?.length || 0;
                const dat = (competitionData || []).filter(d => parseFloat(String(d.hoanThanh).replace('%','')) >= 100).length;
                if (tag === 'TD_TONG_CT') return total;
                if (tag === 'TD_CT_DAT') return dat;
                if (tag === 'TD_CT_CHUADAT') return total - dat;
                if (tag === 'TD_TYLE_DAT') return total > 0 ? ui.formatPercentage(dat / total) : '0%';
            }

            if (tag === 'TOP_QDC_INFO') {
                if (!supermarketReport.qdc) return " (kh√¥ng c√≥)";
                const qdcArray = Object.values(supermarketReport.qdc).filter(item => item.sl > 0);
                const sortedQDC = qdcArray.sort((a,b) => b.dtqd - a.dtqd);
                return "\n" + sortedQDC.map(item => `  ‚Ä¢ ${item.name}: SL ${ui.formatNumber(item.sl)}, TB ${ui.formatNumber(item.sl / currentDay, 1)}/ng√†y`).join("\n");
            }
            if (tag === 'TOP_NGANHHANG_SL') {
                if (!supermarketReport.nganhHangChiTiet) return " (kh√¥ng c√≥)";
                const nganhHangArray = Object.values(supermarketReport.nganhHangChiTiet).filter(item => item.quantity > 0);
                const topNganhHang = nganhHangArray.sort((a,b) => b.quantity - a.quantity).slice(0, 10);
                return "\n" + topNganhHang.map(item => `  ‚Ä¢ ${utils.cleanCategoryName(item.name)}: ${ui.formatNumber(item.quantity)}`).join("\n");
            }
    
            const rankingRegex = /^(TOP|BOT)(\d)_(\w+)_([\s\S]+)$/;
            const rankingMatch = tag.match(rankingRegex);
            if (rankingMatch && rankingReportData) {
                const [_, type, count, metric, department] = rankingMatch;
                const cleanDepartment = department.replace(/@msnv$/, '').trim();
                const direction = type === 'TOP' ? 'desc' : 'asc';
                const metricInfo = tagMapping[metric];
                if (metricInfo) {
                    let dataForRanking = rankingReportData;
                    if (metric === 'THUNHAP' && appState.masterReportData.sknv.length > 0) {
                        dataForRanking = appState.masterReportData.sknv;
                    }
                    const ranking = composerServices.getEmployeeRanking(dataForRanking, metricInfo.key, direction, parseInt(count), cleanDepartment);
                    return composerServices.formatEmployeeList(ranking, metricInfo.key, metricInfo.format);
                }
            }
            
            const botTargetRegex = /^BOT_TARGET_(\w+)_([\s\S]+)$/;
            const botTargetMatch = tag.match(botTargetRegex);
            if(botTargetMatch && rankingReportData) {
                let [_, metric, department] = botTargetMatch;
                department = department.replace(/@msnv$/, '').trim();
                const metricInfo = botTargetMapping[metric];
                if (metricInfo) {
                    const employeeList = composerServices.getEmployeesBelowTarget(rankingReportData, metricInfo.dataKey, metricInfo.goalKey, department);
                    return composerServices.formatEmployeeList(employeeList, metricInfo.dataKey, metricInfo.format);
                }
            }

            const qdcInfoRegex = /^QDC_INFO_(.+)$/;
            const qdcMatch = tag.match(qdcInfoRegex);
            if(qdcMatch && supermarketReport.qdc){
                const itemName = qdcMatch[1];
                const itemData = Object.values(supermarketReport.qdc).find(i => i.name === itemName);
                return itemData ? `SL ${ui.formatNumber(itemData.sl)}, TB ${ui.formatNumber(itemData.sl / currentDay, 1)}/ng√†y` : '(N/A)';
            }
            
            const nhInfoRegex = /^NH_INFO_(.+)$/;
            const nhMatch = tag.match(nhInfoRegex);
            if(nhMatch && supermarketReport.nganhHangChiTiet){
                const itemName = nhMatch[1];
                 const itemData = Object.values(supermarketReport.nganhHangChiTiet).find(i => utils.cleanCategoryName(i.name) === itemName);
                return itemData ? `SL ${ui.formatNumber(itemData.quantity)}, TB ${ui.formatNumber(itemData.quantity / currentDay, 1)}/ng√†y` : '(N/A)';
            }

            return match;
        });
    },
    
    aggregateReport(reportData, selectedWarehouse = null) {
        if (!reportData || reportData.length === 0) {
            const emptyShell = { doanhThu: 0, doanhThuQuyDoi: 0, dtCE: 0, dtICT: 0, qdc: {}, nganhHangChiTiet: {}, comparisonData: { value: 0, percentage: 'N/A' } };
            const numericKeys = ['doanhThuTraGop', 'doanhThuChuaXuat','doanhThuQuyDoiChuaXuat', 'dtGiaDung', 'dtMLN', 'dtPhuKien', 'slSmartphone', 'slSimOnline', 'slUDDD', 'slBaoHiemDenominator', 'slBaoHiemVAS'];
            numericKeys.forEach(key => emptyShell[key] = 0);
            return emptyShell;
        }

        const supermarketReport = reportData.reduce((acc, curr) => {
            for (const key in curr) {
                if (typeof curr[key] === 'number') {
                    acc[key] = (acc[key] || 0) + curr[key];
                } else if (key === 'qdc' && typeof curr.qdc === 'object') {
                    if (!acc.qdc) acc.qdc = {};
                    for (const qdcKey in curr.qdc) {
                        if (!acc.qdc[qdcKey]) acc.qdc[qdcKey] = { sl: 0, dt: 0, dtqd: 0, name: curr.qdc[qdcKey].name };
                        acc.qdc[qdcKey].sl += curr.qdc[qdcKey].sl;
                        acc.qdc[qdcKey].dt += curr.qdc[qdcKey].dt;
                        acc.qdc[qdcKey].dtqd += curr.qdc[qdcKey].dtqd;
                    }
                }
            }
            acc.maKho = selectedWarehouse || '';
            return acc;
        }, {});

        const aggregatedNganhHang = {};
        reportData.forEach(employee => {
            if (employee.doanhThuTheoNganhHang) {
                Object.entries(employee.doanhThuTheoNganhHang).forEach(([name, values]) => {
                    if (!aggregatedNganhHang[name]) aggregatedNganhHang[name] = { name: name, quantity: 0, revenue: 0, revenueQuyDoi: 0, donGia: 0 };
                    aggregatedNganhHang[name].quantity += values.quantity;
                    aggregatedNganhHang[name].revenue += values.revenue;
                    aggregatedNganhHang[name].revenueQuyDoi += values.revenueQuyDoi;
                });
            }
        });
        for (const name in aggregatedNganhHang) {
            const item = aggregatedNganhHang[name];
            item.donGia = item.quantity > 0 ? item.revenue / item.quantity : 0;
        }
        supermarketReport.nganhHangChiTiet = aggregatedNganhHang;

        supermarketReport.hieuQuaQuyDoi = supermarketReport.doanhThu > 0 ? (supermarketReport.doanhThuQuyDoi / supermarketReport.doanhThu) - 1 : 0;
        supermarketReport.tyLeTraCham = supermarketReport.doanhThu > 0 ? supermarketReport.doanhThuTraGop / supermarketReport.doanhThu : 0;
        supermarketReport.pctGiaDung = supermarketReport.dtCE > 0 ? supermarketReport.dtGiaDung / supermarketReport.dtCE : 0;
        supermarketReport.pctMLN = supermarketReport.dtCE > 0 ? supermarketReport.dtMLN / supermarketReport.dtCE : 0;
        supermarketReport.pctPhuKien = supermarketReport.dtICT > 0 ? supermarketReport.dtPhuKien / supermarketReport.dtICT : 0;
        supermarketReport.pctSim = supermarketReport.slSmartphone > 0 ? supermarketReport.slSimOnline / supermarketReport.slSmartphone : 0;
        supermarketReport.pctVAS = supermarketReport.slSmartphone > 0 ? supermarketReport.slUDDD / supermarketReport.slSmartphone : 0;
        supermarketReport.pctBaoHiem = supermarketReport.slBaoHiemDenominator > 0 ? supermarketReport.slBaoHiemVAS / supermarketReport.slBaoHiemDenominator : 0;
        
        const pastedLuyKeData = dataProcessing.parseLuyKePastedData(document.getElementById('paste-luyke')?.value || '');
        supermarketReport.comparisonData = pastedLuyKeData.comparisonData;
        
        if (supermarketReport.qdc) {
            for (const key in supermarketReport.qdc) {
                const group = supermarketReport.qdc[key];
                group.donGia = group.sl > 0 ? group.dt / group.sl : 0;
            }
        }
        
        return supermarketReport;
    },

    getSupermarketReportFromPastedData(pastedData) {
        const cleanValue = (str) => (typeof str === 'string' ? parseFloat(str.replace(/,|%/g, '')) : (typeof str === 'number' ? str : 0));
        return {
            doanhThu: cleanValue(pastedData.mainKpis['Th·ª±c hi·ªán DT th·ª±c']) * 1000000,
            doanhThuQuyDoi: cleanValue(pastedData.mainKpis['Th·ª±c hi·ªán DTQƒê']) * 1000000,
            pastedHTQD: pastedData.mainKpis['% HT Target D·ª± Ki·∫øn (Qƒê)'] || 'N/A',
            comparisonData: pastedData.comparisonData,
        };
    },
    
    updateEmployeeMaps() {
        appState.employeeMaNVMap.clear();
        appState.employeeNameToMaNVMap.clear();
        appState.danhSachNhanVien.forEach(nv => {
            if (nv.maNV) appState.employeeMaNVMap.set(String(nv.maNV).trim(), nv);
            if (nv.hoTen) appState.employeeNameToMaNVMap.set(nv.hoTen.toLowerCase().replace(/\s+/g, ' '), String(nv.maNV).trim());
        });
    },

    generateThiDuaVungReport(selectedSupermarket) {
        if (!selectedSupermarket || !appState.thiDuaVungChiTiet || appState.thiDuaVungChiTiet.length === 0 || !appState.thiDuaVungTong || appState.thiDuaVungTong.length === 0) {
            return null;
        }
        
        const findKey = (data, keyword) => {
            if (!data || data.length === 0) return null;
            return Object.keys(data[0]).find(k => k.trim().toLowerCase().includes(keyword.toLowerCase()));
        };
        const supermarketKeyTong = findKey(appState.thiDuaVungTong, 'si√™u th·ªã');
        const supermarketKeyChiTiet = findKey(appState.thiDuaVungChiTiet, 'si√™u th·ªã');
        const tongThuongKey = findKey(appState.thiDuaVungChiTiet, 't·ªïng th∆∞·ªüng');
        const hangVuotTroiKey = findKey(appState.thiDuaVungChiTiet, 'h·∫°ng v∆∞·ª£t tr·ªôi');
        const hangTargetKey = findKey(appState.thiDuaVungChiTiet, 'h·∫°ng % target');
        const layTopKey = findKey(appState.thiDuaVungChiTiet, 'l·∫•y top');
        const kenhKey = findKey(appState.thiDuaVungChiTiet, 'k√™nh');
        const nganhHangKey = findKey(appState.thiDuaVungChiTiet, 'ng√†nh h√†ng');
        
        if (!supermarketKeyTong || !supermarketKeyChiTiet) {
            console.error("Kh√¥ng th·ªÉ t√¨m th·∫•y c·ªôt 'si√™u th·ªã' trong d·ªØ li·ªáu.");
            return null;
        }

        const summary = appState.thiDuaVungTong.find(row => row[supermarketKeyTong] === selectedSupermarket);
        if (!summary) return null;
        
        const chiTiet = appState.thiDuaVungChiTiet.filter(row => row[supermarketKeyChiTiet] === selectedSupermarket);
        
        if (chiTiet.length > 0 && layTopKey) {
            summary.hangCoGiaiKenh = chiTiet[0][layTopKey]; 
        } else {
            summary.hangCoGiaiKenh = 'N/A';
        }

        const report = { summary, coGiai: [], sapCoGiai: [], tiemNang: [], canCoGangNhieu: [] };
        
        const getPotentialPrize = (kenh, nganhHang) => {
            const winningSupermarkets = appState.thiDuaVungChiTiet.filter(sm => 
                sm[kenhKey] === kenh && sm[nganhHangKey] === nganhHang && sm[tongThuongKey] > 0
            );
            if (winningSupermarkets.length === 0) return 0;
            return Math.min(...winningSupermarkets.map(s => s[tongThuongKey]));
        };

        chiTiet.forEach(nganhHang => {
            if (nganhHang[tongThuongKey] > 0) {
                report.coGiai.push(nganhHang);
            } else {
                const hangVuotTroi = nganhHang[hangVuotTroiKey] || Infinity;
                const hangTarget = nganhHang[hangTargetKey] || Infinity;
                const hangCoGiai = nganhHang[layTopKey] || 0;
                
                const khoangCach = Math.min(
                    (hangVuotTroi > 0 && hangVuotTroi > hangCoGiai) ? hangVuotTroi - hangCoGiai : Infinity, 
                    (hangTarget > 0 && hangTarget > hangCoGiai) ? hangTarget - hangCoGiai : Infinity
                );
                nganhHang.khoangCach = khoangCach;

                if (hangCoGiai > 0 && khoangCach <= 20) {
                    nganhHang.thuongTiemNang = getPotentialPrize(nganhHang[kenhKey], nganhHang[nganhHangKey]);
                    report.sapCoGiai.push(nganhHang);
                } else if (hangCoGiai > 0 && khoangCach > 20 && khoangCach <= 40) {
                    report.tiemNang.push(nganhHang);
                } else {
                    report.canCoGangNhieu.push(nganhHang);
                }
            }
        });
        
        report.coGiai.sort((a, b) => b[tongThuongKey] - a[tongThuongKey]);
        report.sapCoGiai.sort((a, b) => a.khoangCach - b.khoangCach);
        report.tiemNang.sort((a, b) => a.khoangCach - b.khoangCach);

        return report;
    }
};

const services = {
    ...dataProcessing,
    ...reportGeneration,
    ...composerServices
};

export { services };
--- END FILE: ./services.js ---

--- START FILE: ./state.js ---
// Version 2.5 - Add cloud-based declaration properties
// MODULE 2: T·ª¶ TR·∫†NG TH√ÅI (APPSTATE)
// File n√†y ch·ª©a ƒë·ªëi t∆∞·ª£ng tr·∫°ng th√°i chung c·ªßa ·ª©ng d·ª•ng, ho·∫°t ƒë·ªông nh∆∞ m·ªôt "b·ªô nh·ªõ".

const appState = {
    // --- Collaboration & Dynamic Content ---
    db: null,
    isAdmin: false,
    feedbackList: [],
    helpContent: {
        data: 'ƒêang t·∫£i h∆∞·ªõng d·∫´n...',
        luyke: 'ƒêang t·∫£i h∆∞·ªõng d·∫´n...',
        sknv: 'ƒêang t·∫£i h∆∞·ªõng d·∫´n...',
        realtime: 'ƒêang t·∫£i h∆∞·ªõng d·∫´n...'
    },
    composerTemplates: {
        luyke: '',
        sknv: '',
        realtime: ''
    },

    // --- D·ªØ li·ªáu & Tr·∫°ng th√°i ---
    danhSachNhanVien: [],
    categoryStructure: [],
    brandList: [], // Master list of all brands

    // === START: D·ªÆ LI·ªÜU KHAI B√ÅO T√çNH TO√ÅN (ƒê·ªíNG B·ªò T·ª™ CLOUD) ===
    declarations: {
        hinhThucXuat: '',
        hinhThucXuatGop: '',
        heSoQuyDoi: ''
    },
    // === END: D·ªÆ LI·ªÜU KHAI B√ÅO T√çNH TO√ÅN ===

    // D·ªØ li·ªáu c·∫≠p nh·∫≠t h√†ng ng√†y
    ycxData: [],
    rawGioCongData: [],
    thuongNongData: [],
    thuongERPData: [],
    thiDuaNhanVienData: [],
    thiDuaVungChiTiet: [],
    thiDuaVungTong: [],

    thiDuaReportData: [],

    // D·ªØ li·ªáu c·∫≠p nh·∫≠t th√°ng tr∆∞·ªõc
    ycxDataThangTruoc: [],
    thuongNongDataThangTruoc: [],
    thuongERPDataThangTruoc: [],

    masterReportData: {
        luyke: [],
        sknv: [],
        realtime: []
    },
    
    competitionConfigs: [],
    
    realtimeYCXData: [],
    luykeGoalSettings: {},
    realtimeGoalSettings: {},
    highlightSettings: {
        luyke: {},
        sknv: {},
        realtime: {}
    },
    debugInfo: {},
    employeeMaNVMap: new Map(),
    employeeNameToMaNVMap: new Map(),
    charts: {},
    choices: {
        luyke_employee: null, luyke_date_picker: null, luyke_highlight_nhanhang: null, luyke_highlight_nhomhang: null, luyke_highlight_employee: null,
        sknv_employee: null, sknv_date_picker: null, sknv_highlight_nhanhang: null, sknv_highlight_nhomhang: null, sknv_highlight_employee: null,
        realtime_employee: null, realtime_highlight_nhanhang: null, realtime_highlight_nhomhang: null, realtime_highlight_employee: null,
        thiDuaVung_sieuThi: null,
        competition_group: null,
        competition_brand: null,
    },
    sortState: {
        luyke_chuaxuat: { key: 'doanhThuQuyDoi', direction: 'desc' },
        sknv_summary: { key: 'totalAbove', direction: 'desc' },
        doanhthu_lk: { key: 'doanhThu', direction: 'desc' },
        thunhap: { key: 'tongThuNhap', direction: 'desc' },
        hieu_qua: { key: 'dtICT', direction: 'desc' },
        sknv_ict: { key: 'dtICT', direction: 'desc' },
        sknv_phukien: { key: 'dtPhuKien', direction: 'desc' },
        sknv_giadung: { key: 'dtGiaDung', direction: 'desc' },
        sknv_ce: { key: 'dtCE', direction: 'desc' },
        sknv_baohiem: { key: 'dtBaoHiem', direction: 'desc' },
        sknv_nganhhang_chitiet: { key: 'revenue', direction: 'desc' },
        sknv_qdc: { key: 'dtqd', direction: 'desc' },
        sknv_thidua_summary: { key: 'completedCount', direction: 'desc'},
        sknv_thidua_category: { key: 'percentExpected', direction: 'desc'},
        sknv_thidua_employee: { key: 'percentExpected', direction: 'desc'},
        luyke_competition_doanhthu: { key: 'hoanThanh', direction: 'desc' },
        luyke_competition_soluong: { key: 'hoanThanh', direction: 'desc' },
        luyke_nganhhang: { key: 'revenue', direction: 'desc' },
        luyke_qdc: { key: 'dtqd', direction: 'desc' },
        realtime_nganhhang: { key: 'revenue', direction: 'desc' },
        realtime_dt_nhanvien: { key: 'doanhThu', direction: 'desc' },
        realtime_hieuqua_nhanvien: { key: 'dtICT', direction: 'desc' },
        realtime_ict: { key: 'dtICT', direction: 'desc' },
        realtime_phukien: { key: 'dtPhuKien', direction: 'desc' },
        realtime_giadung: { key: 'dtGiaDung', direction: 'desc' },
        realtime_ce: { key: 'dtCE', direction: 'desc' },
        realtime_baohiem: { key: 'dtBaoHiem', direction: 'desc' },
        realtime_qdc: { key: 'dtqd', direction: 'desc' },
        realtime_brand: { key: 'revenue', direction: 'desc' },
        realtime_brand_employee: { key: 'revenue', direction: 'desc' }
    }
};

// Xu·∫•t kh·∫©u appState ƒë·ªÉ c√°c module kh√°c c√≥ th·ªÉ s·ª≠ d·ª•ng
export { appState };
--- END FILE: ./state.js ---

--- START FILE: ./tab-luyke.js ---
// Version 2.9 - Adjust rendering logic to accommodate new layout in index.html
// MODULE: Ch·ªãu tr√°ch nhi·ªám cho Tab S·ª©c kh·ªèe Si√™u th·ªã (L≈©y k·∫ø)

import { appState } from './state.js';
import { ui } from './ui.js';
import { services } from './services.js';
import { settingsService } from './modules/settings.service.js';
import { highlightService } from './modules/highlight.service.js';

const luykeTab = {
    render() {
        if (appState.danhSachNhanVien.length === 0) {
            ui.togglePlaceholder('health-section', true);
            return;
        }
        ui.togglePlaceholder('health-section', false);

        services.parseCompetitionDataFromLuyKe(document.getElementById('paste-luyke').value);

        const activeSubTabBtn = document.querySelector('#luyke-subtabs-nav .sub-tab-btn.active');
        const activeSubTabId = activeSubTabBtn ? activeSubTabBtn.dataset.target : 'subtab-luyke-sieu-thi';

        const selectedWarehouse = document.getElementById('luyke-filter-warehouse').value;
        const selectedDept = document.getElementById('luyke-filter-department').value;
        const selectedNames = appState.choices.luyke_employee ? appState.choices.luyke_employee.getValue(true) : [];
        const selectedDates = appState.choices.luyke_date_picker ? appState.choices.luyke_date_picker.selectedDates : [];
        
        let filteredYCXData = appState.ycxData;
        if (selectedDates && selectedDates.length > 0) {
            const startOfDay = (date) => new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
            const selectedDateSet = new Set(selectedDates.map(d => startOfDay(d)));
            filteredYCXData = appState.ycxData.filter(row => row.ngayTao instanceof Date && !isNaN(row.ngayTao) && selectedDateSet.has(startOfDay(row.ngayTao)));
        }
        
        const goals = settingsService.getLuykeGoalSettings(selectedWarehouse).goals;
        appState.masterReportData.luyke = services.generateMasterReportData(filteredYCXData, goals);
        
        let filteredReport = appState.masterReportData.luyke;
        if (selectedWarehouse) filteredReport = filteredReport.filter(nv => nv.maKho == selectedWarehouse);
        if (selectedDept) filteredReport = filteredReport.filter(nv => nv.boPhan === selectedDept);
        if (selectedNames && selectedNames.length > 0) filteredReport = filteredReport.filter(nv => selectedNames.includes(String(nv.maNV)));

        if (activeSubTabId === 'subtab-luyke-sieu-thi') {
            const supermarketReport = services.aggregateReport(filteredReport, selectedWarehouse);
            const numDays = selectedDates.length > 0 ? selectedDates.length : new Set(appState.ycxData.map(row => new Date(row.ngayTao).toDateString())).size || 1;
            
            ui.updateLuykeSupermarketTitle(selectedWarehouse, new Date());
            ui.renderLuykeEfficiencyTable(supermarketReport, goals);
            ui.renderLuykeCategoryDetailsTable(supermarketReport, numDays);
            ui.renderLuykeQdcTable(supermarketReport, numDays);
            
            const chuaXuatReport = services.generateLuyKeChuaXuatReport(filteredYCXData);
            ui.renderChuaXuatTable(chuaXuatReport);

            const pastedData = services.parseLuyKePastedData(document.getElementById('paste-luyke').value);
            ui.displayHealthKpiTable(pastedData, goals); 

        } else if (activeSubTabId === 'subtab-luyke-thi-dua') {
            // === THAY ƒê·ªîI: T√°ch logic render n√∫t v√† n·ªôi dung ===
            const switcherPlaceholder = document.getElementById('luyke-thidua-view-selector-placeholder');
            const contentContainer = document.getElementById('luyke-competition-content');
            
            // 1. Ch√®n c√°c n√∫t chuy·ªÉn ch·∫ø ƒë·ªô v√†o placeholder n·∫øu ch∆∞a c√≥
            if(switcherPlaceholder && !switcherPlaceholder.querySelector('#luyke-thidua-view-selector')) {
                switcherPlaceholder.innerHTML = `
                    <div id="luyke-thidua-view-selector" class="view-switcher">
                        <button data-view="summary" class="view-switcher__btn active">Theo Ph√¢n Lo·∫°i</button>
                        <button data-view="completion" class="view-switcher__btn">Theo % Ho√†n Th√†nh</button>
                    </div>
                `;
            }
            
            // 2. Lu√¥n ƒë·∫£m b·∫£o container cho n·ªôi dung b√°o c√°o t·ªìn t·∫°i
            if (contentContainer) {
                 contentContainer.innerHTML = '<div id="luyke-competition-infographic-container" class="mt-4"></div>';
            }

            // 3. Render b√°o c√°o v√†o container ƒë√£ chu·∫©n b·ªã
            const activeViewBtn = document.querySelector('#luyke-thidua-view-selector .view-switcher__btn.active');
            const viewType = activeViewBtn ? activeViewBtn.dataset.view : 'summary';
            ui.displayCompetitionResultsFromLuyKe(document.getElementById('paste-luyke').value, viewType);
        }
        
        highlightService.populateHighlightFilters('luyke', filteredYCXData, filteredReport);
        highlightService.applyHighlights('luyke');
    },
};

export { luykeTab };
--- END FILE: ./tab-luyke.js ---

--- START FILE: ./tab-sknv.js ---
// Version 3.4 - No changes, confirming correct call to ui.renderLuykeEmployeeDetail
// MODULE: TAB SKNV
// Ch·ªãu tr√°ch nhi·ªám render v√† x·ª≠ l√Ω logic cho tab "S·ª©c kh·ªèe nh√¢n vi√™n"

import { appState } from './state.js';
import { services } from './services.js';
import { ui } from './ui.js';
import { settingsService } from './modules/settings.service.js';
import { highlightService } from './modules/highlight.service.js';
import { dragDroplisteners } from './event-listeners/listeners-dragdrop.js';

export const sknvTab = {
    render() {
        if (appState.danhSachNhanVien.length === 0) {
            ui.togglePlaceholder('health-employee-section', true);
            return;
        }
        
        ui.togglePlaceholder('health-employee-section', false);
        
        const selectedWarehouse = document.getElementById('sknv-filter-warehouse').value;
        const selectedDept = document.getElementById('sknv-filter-department').value;
        const selectedNames = appState.choices.sknv_employee ? appState.choices.sknv_employee.getValue(true) : [];
        const selectedDates = appState.choices.sknv_date_picker ? appState.choices.sknv_date_picker.selectedDates : [];
        
        let filteredYCXData = appState.ycxData;
        if (selectedDates && selectedDates.length > 0) {
            const startOfDay = (date) => new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
            const selectedDateSet = new Set(selectedDates.map(d => startOfDay(d)));
            filteredYCXData = appState.ycxData.filter(row => row.ngayTao instanceof Date && !isNaN(row.ngayTao) && selectedDateSet.has(startOfDay(row.ngayTao)));
        }
         
        const goals = settingsService.getLuykeGoalSettings(selectedWarehouse).goals;
        appState.masterReportData.sknv = services.generateMasterReportData(filteredYCXData, goals, false);
        
        let filteredReport = appState.masterReportData.sknv;
        if (selectedWarehouse) filteredReport = filteredReport.filter(nv => nv.maKho == selectedWarehouse);
        if (selectedDept) filteredReport = filteredReport.filter(nv => nv.boPhan === selectedDept);
        if (selectedNames && selectedNames.length > 0) filteredReport = filteredReport.filter(nv => selectedNames.includes(String(nv.maNV)));
        
        const activeSubTabBtn = document.querySelector('#employee-subtabs-nav .sub-tab-btn.active');
        const activeSubTabId = activeSubTabBtn ? activeSubTabBtn.dataset.target : 'subtab-sknv';

        const detailInfo = appState.viewingDetailFor;
        const isViewingDetail = detailInfo && (detailInfo.sourceTab === 'sknv' || detailInfo.sourceTab === 'dtnv-lk');

        if (isViewingDetail) {
            const employeeData = appState.masterReportData.sknv.find(nv => String(nv.maNV) === String(detailInfo.employeeId));
            if (activeSubTabId === 'subtab-sknv' && detailInfo.sourceTab === 'sknv') {
                 ui.displaySknvReport(filteredReport, true);
            } else if (activeSubTabId === 'subtab-doanhthu-lk' && detailInfo.sourceTab === 'dtnv-lk') {
                const luykeDetailData = services.generateLuyKeEmployeeDetailReport(detailInfo.employeeId, filteredYCXData);
                ui.renderLuykeEmployeeDetail(luykeDetailData, employeeData, 'dtnv-lk-details-container');
            } else {
                this.renderSummaryViews(activeSubTabId, filteredReport, filteredYCXData);
            }
        } else {
            this.renderSummaryViews(activeSubTabId, filteredReport, filteredYCXData);
        }

         highlightService.populateHighlightFilters('sknv', filteredYCXData, filteredReport);
        highlightService.applyHighlights('sknv');

        const efficiencyReportContainer = document.getElementById('efficiency-report-container');
        if (efficiencyReportContainer && !isViewingDetail) {
            dragDroplisteners.initializeForContainer('efficiency-report-container');
        }
    },

    renderSummaryViews(activeSubTabId, filteredReport, filteredYCXData) {
        if (activeSubTabId === 'subtab-hieu-qua-thi-dua-lk') {
            const competitionReportData = services.calculateCompetitionFocusReport(
                filteredYCXData,
                appState.competitionConfigs
            );
            ui.renderCompetitionUI('competition-report-container-lk', competitionReportData);
        } else if (activeSubTabId === 'subtab-sknv') {
            ui.displaySknvReport(filteredReport, false);
        } else if (activeSubTabId === 'subtab-doanhthu-lk') {
            ui.displayEmployeeRevenueReport(filteredReport, 'revenue-report-container-lk', 'doanhthu_lk');
        } else if (activeSubTabId === 'subtab-thunhap') {
            ui.displayEmployeeIncomeReport(filteredReport);
        } else if (activeSubTabId === 'subtab-hieu-qua-khai-thac-luy-ke') {
            ui.displayEmployeeEfficiencyReport(filteredReport, 'efficiency-report-container', 'hieu_qua');
        } else if (activeSubTabId === 'subtab-doanhthu-nganhhang') {
            ui.displayCategoryRevenueReport(filteredReport, 'category-revenue-report-container', 'sknv');
        }
    }
};
--- END FILE: ./tab-sknv.js ---

--- START FILE: ./ui-competition.js ---
// Version 2.9 - Simplify multi-brand competition table header
// MODULE: UI COMPETITION
// Ch·ª©a c√°c h√†m render giao di·ªán cho b√°o c√°o thi ƒëua ƒëa h√£ng, ƒëa nƒÉng.

import { appState } from './state.js';
import { uiComponents } from './ui-components.js';
import { config } from './config.js';

const uiCompetition = {
    /**
     * Render to√†n b·ªô giao di·ªán b√°o c√°o hi·ªáu qu·∫£ thi ƒëua m·ªõi.
     * @param {string} containerId - ID c·ªßa container ƒë·ªÉ render b√°o c√°o.
     * @param {Array} reportData - D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω t·ª´ services.calculateCompetitionFocusReport.
     */
    renderCompetitionUI(containerId, reportData) {
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!reportData || reportData.length === 0) {
            const isLk = containerId.includes('-lk');
            const configs = appState.competitionConfigs;
            const ycxData = isLk ? appState.ycxData : appState.realtimeYCXData;
            
            let errorMessage = '';
            if (configs.length === 0) {
                errorMessage = 'Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh thi ƒëua n√†o ƒë∆∞·ª£c khai b√°o trong "Thi·∫øt l·∫≠p m·ª•c ti√™u".';
            } else if (ycxData.length === 0) {
                errorMessage = `ƒê√£ c√≥ ${configs.length} ch∆∞∆°ng tr√¨nh thi ƒëua, nh∆∞ng b·∫°n ch∆∞a t·∫£i file d·ªØ li·ªáu b√°n h√†ng (${isLk ? 'YCX L≈©y k·∫ø' : 'Realtime'}) t∆∞∆°ng ·ª©ng ƒë·ªÉ t√≠nh to√°n.`;
            } else {
                errorMessage = `ƒê√£ t√¨m th·∫•y ${configs.length} ch∆∞∆°ng tr√¨nh thi ƒëua, nh∆∞ng kh√¥ng c√≥ doanh thu/s·ªë l∆∞·ª£ng n√†o kh·ªõp v·ªõi c√°c nh√≥m h√†ng ƒë√£ ch·ªçn trong file YCX. Vui l√≤ng ki·ªÉm tra l·∫°i s·ª± th·ªëng nh·∫•t v·ªÅ t√™n g·ªçi gi·ªØa c·∫•u h√¨nh thi ƒëua v√† d·ªØ li·ªáu b√°n h√†ng.`;
            }
            container.innerHTML = `<div class="p-4 bg-yellow-50 text-yellow-800 border border-yellow-200 rounded-lg italic">${errorMessage}</div>`;
            return;
        }

        let finalHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';
        reportData.forEach((competitionResult, index) => {
            if (competitionResult.employeeData.length === 0) return;
            finalHTML += this._renderFocusCompetitionTable(competitionResult, index);
        });
        finalHTML += `</div>`;
        container.innerHTML = finalHTML;
    },

    /**
     * @private
     * Render b·∫£ng k·∫øt qu·∫£ chi ti·∫øt cho m·ªôt ch∆∞∆°ng tr√¨nh thi ƒëua (phi√™n b·∫£n m·ªõi, h·ªó tr·ª£ ƒëa h√£ng).
     */
    _renderFocusCompetitionTable(competitionResult, index) {
        const { competition, employeeData } = competitionResult;
        const sortStateKey = `focus_competition_${competition.type}_${index}`;
        const sortState = appState.sortState[sortStateKey] || { key: 'tyLeDT', direction: 'desc' };
        const { key, direction } = sortState;

        const targetValue = parseFloat(competition.target) / 100 || 0;
        const brands = competition.brands || [];

        const sortedData = [...employeeData].sort((a, b) => {
            const valA = a[key] || 0;
            const valB = b[key] || 0;
            return direction === 'asc' ? valA - valB : valB - a[key];
        });

        // T√≠nh to√°n t·ªïng c·ªông, bao g·ªìm c·∫£ chi ti·∫øt cho t·ª´ng h√£ng
        const totals = employeeData.reduce((acc, item) => {
            acc.baseCategoryQuantity += item.baseCategoryQuantity;
            acc.baseCategoryRevenue += item.baseCategoryRevenue;
            acc.targetBrandsQuantity += item.targetBrandsQuantity;
            acc.targetBrandsRevenue += item.targetBrandsRevenue;

            for (const brandName of brands) {
                if (!acc.performanceByBrand[brandName]) {
                    acc.performanceByBrand[brandName] = { quantity: 0, revenue: 0 };
                }
                const brandPerf = item.performanceByBrand[brandName];
                if (brandPerf) {
                    acc.performanceByBrand[brandName].quantity += brandPerf.quantity;
                    acc.performanceByBrand[brandName].revenue += brandPerf.revenue;
                }
            }
            return acc;
        }, { 
            baseCategoryQuantity: 0, 
            baseCategoryRevenue: 0,
            targetBrandsQuantity: 0,
            targetBrandsRevenue: 0,
            performanceByBrand: {}
        });

        totals.tyLeSL = totals.baseCategoryQuantity > 0 ? (totals.targetBrandsQuantity / totals.baseCategoryQuantity) : 0;
        totals.tyLeDT = totals.baseCategoryRevenue > 0 ? (totals.targetBrandsRevenue / totals.baseCategoryRevenue) : 0;
        
        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;
        
        let tableHTML = `
            <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col" data-capture-group="competition-${competition.id}">
                <div class="p-4 bg-gray-50 border-b-2 border-indigo-200">
                    <h3 class="text-lg font-bold text-indigo-800 uppercase">${competition.name}</h3>
                    <div class="mt-2 flex items-center gap-2">
                        <label for="target-input-${competition.id}" class="text-sm font-medium text-gray-700 flex-shrink-0">M·ª•c ti√™u khai th√°c (%):</label>
                        <input type="number" id="target-input-${competition.id}" 
                               class="competition-target-input w-24 p-1 border rounded-md text-sm" 
                               placeholder="VD: 50"
                               value="${competition.target || ''}"
                               data-competition-id="${competition.id}">
                    </div>
                </div>
                <div class="overflow-x-auto flex-grow">
                    <table class="min-w-full text-sm text-left text-gray-600 table-bordered table-striped" data-table-type="${sortStateKey}">
                        <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
                            <tr>
                                <th rowspan="2" class="${headerClass('hoTen')}" data-sort="hoTen">Nh√¢n vi√™n <span class="sort-indicator"></span></th>
                                ${brands.map(brand => `<th colspan="2" class="px-4 py-2 text-center header-group-5">${brand}</th>`).join('')}
                                <th colspan="2" class="px-4 py-2 text-center header-group-10">T·ªïng Nh√≥m h√†ng</th>
                                <th colspan="2" class="px-4 py-2 text-center header-group-6">T·ª∑ l·ªá khai th√°c</th>
                            </tr>
                            <tr>
                                ${brands.map(() => `<th class="px-2 py-2 text-right">SL</th><th class="px-2 py-2 text-right">DT</th>`).join('')}
                                <th class="${headerClass('baseCategoryQuantity')} text-right" data-sort="baseCategoryQuantity">SL <span class="sort-indicator"></span></th>
                                <th class="${headerClass('baseCategoryRevenue')} text-right" data-sort="baseCategoryRevenue">DT <span class="sort-indicator"></span></th>
                                <th class="${headerClass('tyLeSL')} text-right header-highlight" data-sort="tyLeSL">% SL <span class="sort-indicator"></span></th>
                                <th class="${headerClass('tyLeDT')} text-right header-highlight" data-sort="tyLeDT">% DT <span class="sort-indicator"></span></th>
                            </tr>
                        </thead>
                        <tbody>`;

        sortedData.forEach(item => {
            const tyLeSLClass = targetValue > 0 && item.tyLeSL < targetValue ? 'cell-performance is-below' : '';
            const tyLeDTClass = targetValue > 0 && item.tyLeDT < targetValue ? 'cell-performance is-below' : '';

            tableHTML += `<tr class="hover:bg-gray-50">
                <td class="px-4 py-2 font-semibold line-clamp-2">${uiComponents.getShortEmployeeName(item.hoTen, item.maNV)}</td>
                ${brands.map(brandName => {
                    const brandPerf = item.performanceByBrand[brandName] || { quantity: 0, revenue: 0 };
                    return `<td class="px-2 py-2 text-right font-bold">${uiComponents.formatNumberOrDash(brandPerf.quantity)}</td>
                            <td class="px-2 py-2 text-right font-bold">${uiComponents.formatRevenue(brandPerf.revenue)}</td>`;
                }).join('')}
                <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumberOrDash(item.baseCategoryQuantity)}</td>
                <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.baseCategoryRevenue)}</td>
                <td class="px-4 py-2 text-right font-bold ${tyLeSLClass}">${uiComponents.formatPercentage(item.tyLeSL)}</td>
                <td class="px-4 py-2 text-right font-bold ${tyLeDTClass}">${uiComponents.formatPercentage(item.tyLeDT)}</td>
            </tr>`;
        });

        tableHTML += `
                        </tbody>
                        <tfoot class="table-footer font-bold">
                            <tr>
                                <td class="px-4 py-2">T·ªïng</td>
                                ${brands.map(brandName => {
                                    const brandTotals = totals.performanceByBrand[brandName] || { quantity: 0, revenue: 0 };
                                    return `<td class="px-2 py-2 text-right">${uiComponents.formatNumberOrDash(brandTotals.quantity)}</td>
                                            <td class="px-2 py-2 text-right">${uiComponents.formatRevenue(brandTotals.revenue)}</td>`;
                                }).join('')}
                                <td class="px-4 py-2 text-right">${uiComponents.formatNumberOrDash(totals.baseCategoryQuantity)}</td>
                                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.baseCategoryRevenue)}</td>
                                <td class="px-4 py-2 text-right">${uiComponents.formatPercentage(totals.tyLeSL)}</td>
                                <td class="px-4 py-2 text-right">${uiComponents.formatPercentage(totals.tyLeDT)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>`;
        return tableHTML;
    }
};

export { uiCompetition };
--- END FILE: ./ui-competition.js ---

--- START FILE: ./ui-components.js ---
// Version 3.9 - Fix click-to-detail bug in Luy Ke Revenue tab
// MODULE: UI COMPONENTS
// Ch·ª©a c√°c h√†m UI chung, t√°i s·ª≠ d·ª•ng ƒë∆∞·ª£c tr√™n to√†n b·ªô ·ª©ng d·ª•ng.

import { appState } from './state.js';
import { services } from './services.js';
import { utils } from './utils.js';
import { settingsService } from './modules/settings.service.js';

export const uiComponents = {
    renderSettingsButton(idSuffix) {
        return `<button id="settings-btn-${idSuffix}" class="settings-trigger-btn" title="T√πy ch·ªânh hi·ªÉn th·ªã">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                 </button>`;
    },

    renderCompetitionConfigUI() {
        const container = document.getElementById(`competition-list-container`);
        if (!container) return;
        const configs = appState.competitionConfigs || [];

        if (configs.length === 0) {
            container.innerHTML = '<p class="text-xs text-center text-gray-500 italic">Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh n√†o ƒë∆∞·ª£c t·∫°o.</p>';
            return;
        }

        container.innerHTML = configs.map((config, index) => {
            return `
                <div class="p-3 border rounded-lg bg-white flex justify-between items-center shadow-sm">
                     <div>
                         <div class="flex items-center gap-x-2">
                             <p class="font-bold text-gray-800">${config.name}</p>
                        </div>
                         <div class="text-xs text-gray-500 mt-1 space-y-1">
                             <p><strong>H√£ng:</strong> <span class="font-semibold text-blue-600">${(config.brands || []).join(', ')}</span></p>
                             <p><strong>Nh√≥m h√†ng:</strong> <span class="font-semibold">${(config.groups || []).length} nh√≥m</span></p>
                        </div>
                     </div>
                     <div class="flex items-center gap-x-2 flex-shrink-0">
                        <button class="edit-competition-btn p-2 rounded-md hover:bg-gray-200 text-gray-600" data-index="${index}" title="S·ª≠a ch∆∞∆°ng tr√¨nh">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                         </button>
                         <button class="delete-competition-btn p-2 rounded-md hover:bg-red-100 text-red-600" data-index="${index}" title="X√≥a ch∆∞∆°ng tr√¨nh">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    },
    
    populateComposerDetailTags(supermarketReport) {
        const qdcContainer = document.getElementById('composer-qdc-tags-container');
        const nganhHangContainer = document.getElementById('composer-nganhhang-tags-container');

        if (!qdcContainer || !nganhHangContainer) return;
        
        qdcContainer.innerHTML = '<h5 class="composer__tag-group-title">Ch·ªçn Nh√≥m H√†ng QƒêC</h5>';
        nganhHangContainer.innerHTML = '<h5 class="composer__tag-group-title">Ch·ªçn Ng√†nh H√†ng Chi Ti·∫øt</h5>';

        const createTagButton = (tag, text) => {
            const button = document.createElement('button');
            button.className = 'composer__tag-btn';
            button.dataset.tag = tag;
            button.textContent = text;
            return button;
        };

        if (supermarketReport && supermarketReport.qdc) {
            const qdcItems = Object.values(supermarketReport.qdc)
                .filter(item => item.sl > 0)
                .sort((a,b) => b.dtqd - a.dtqd);
            qdcItems.forEach(item => {
                const tag = `[QDC_INFO_${item.name}]`;
                qdcContainer.appendChild(createTagButton(tag, item.name));
            });
        }

        if (supermarketReport && supermarketReport.nganhHangChiTiet) {
            const nganhHangItems = Object.values(supermarketReport.nganhHangChiTiet)
                .filter(item => item.quantity > 0)
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 15);

            nganhHangItems.forEach(item => {
                const cleanName = utils.cleanCategoryName(item.name);
                const tag = `[NH_INFO_${cleanName}]`;
                nganhHangContainer.appendChild(createTagButton(tag, cleanName));
            });
        }
    },

    displayEmployeeRevenueReport: (reportData, containerId, sortStateKey) => {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = '';
        
        let detailContainerId;
        if (sortStateKey === 'doanhthu_lk') {
            detailContainerId = 'dtnv-lk-details-container';
        } else if (sortStateKey === 'realtime_dt_nhanvien') {
            detailContainerId = 'realtime-employee-detail-container';
        } else {
            detailContainerId = 'sknv-details-container';
        }
    
        const detailContainer = document.getElementById(detailContainerId);
        if (detailContainer) {
            detailContainer.innerHTML = ''; 
            detailContainer.classList.add('hidden');
        }
        container.classList.remove('hidden');

        if (!reportData || reportData.length === 0) {
            container.innerHTML = '<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu doanh thu cho l·ª±a ch·ªçn n√†y.</p>';
            return;
        }
        let finalHTML = `<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden" data-capture-group="1">
            <div class="p-4 header-group-1 text-gray-800">
                <h3 class="text-xl font-bold uppercase">Doanh thu nh√¢n vi√™n</h3>
                <p class="text-sm italic text-gray-600">(ƒë∆°n v·ªã t√≠nh: Tri·ªáu ƒë·ªìng)</p>
            </div>`;
        
        const groupedByDept = {};
        reportData.forEach(item => {
            const dept = item.boPhan;
            if (!groupedByDept[dept]) groupedByDept[dept] = [];
            groupedByDept[dept].push(item);
        });
        
        const departmentOrder = utils.getSortedDepartmentList(reportData);
        departmentOrder.forEach(deptName => {
            if (groupedByDept[deptName]) {
                finalHTML += uiComponents.renderRevenueTableForDepartment(deptName, groupedByDept[deptName], sortStateKey);
            }
        });

        finalHTML += `</div>`;
        container.innerHTML = finalHTML;
    },

    renderRevenueTableForDepartment: (title, data, sortStateKey) => {
        const sortState = appState.sortState[sortStateKey] || { key: 'doanhThu', direction: 'desc' };
        const { key, direction } = sortState;
        const sortedData = [...data].sort((a, b) => {
            const valA = a[key] || 0; const valB = b[key] || 0;
            return direction === 'asc' ? valA - valB : valB - valA;
        });

        const totals = data.reduce((acc, item) => {
            acc.doanhThu += item.doanhThu;
            acc.doanhThuQuyDoi += item.doanhThuQuyDoi;
            acc.doanhThuTraGop += item.doanhThuTraGop;
            acc.doanhThuChuaXuat += item.doanhThuChuaXuat;
            return acc;
        }, { doanhThu: 0, doanhThuQuyDoi: 0, doanhThuTraGop: 0, doanhThuChuaXuat: 0 });

        totals.hieuQuaQuyDoi = totals.doanhThu > 0 ? (totals.doanhThuQuyDoi / totals.doanhThu) - 1 : 0;
        totals.tyLeTraCham = totals.doanhThu > 0 ? totals.doanhThuTraGop / totals.doanhThu : 0;

        let titleClass = '';
        if (title.includes('T∆∞ V·∫•n')) titleClass = 'department-header-tv';
        else if (title.includes('Kho')) titleClass = 'department-header-kho';
        else if (title.includes('Trang Tr√≠')) titleClass = 'department-header-tt';

        const isRealtime = sortStateKey === 'realtime_dt_nhanvien';
        const headerClasses = {
            hoTen: '',
            doanhThu: isRealtime ? 'header-group-4' : 'header-bg-blue',
            doanhThuQuyDoi: isRealtime ? 'header-group-4' : 'header-bg-blue',
            hieuQuaQuyDoi: isRealtime ? 'header-group-4' : 'header-bg-blue',
            doanhThuTraGop: isRealtime ? 'header-group-5' : 'header-bg-green',
            tyLeTraCham: isRealtime ? 'header-group-5' : 'header-bg-green',
            doanhThuChuaXuat: isRealtime ? 'header-group-6' : 'header-bg-yellow'
        };

        const headerClass = (sortKey) => `px-4 py-3 sortable ${headerClasses[sortKey] || ''} ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;
        
        let tableHTML = `<div class="department-block"><h4 class="text-lg font-bold p-4 border-b border-gray-200 ${titleClass}">${title}</h4><div class="overflow-x-auto"><table class="min-w-full text-sm text-left text-gray-600 table-bordered table-striped" data-table-type="${sortStateKey}" data-capture-columns="7">
                 <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
                     <tr>
                                <th class="${headerClass('hoTen')}" data-sort="hoTen">Nh√¢n vi√™n <span class="sort-indicator"></span></th>
                                <th class="${headerClass('doanhThu')} text-right" data-sort="doanhThu">Doanh Thu <span class="sort-indicator"></span></th>
                                <th class="${headerClass('doanhThuQuyDoi')} text-right" data-sort="doanhThuQuyDoi">Doanh Thu Qƒê <span class="sort-indicator"></span></th>
                                <th class="${headerClass('hieuQuaQuyDoi')} text-right" data-sort="hieuQuaQuyDoi">% Qƒê <span class="sort-indicator"></span></th>
                                <th class="${headerClass('doanhThuTraGop')} text-right" data-sort="doanhThuTraGop">DT tr·∫£ ch·∫≠m <span class="sort-indicator"></span></th>
                                <th class="${headerClass('tyLeTraCham')} text-right" data-sort="tyLeTraCham">% tr·∫£ ch·∫≠m <span class="sort-indicator"></span></th>
                                <th class="${headerClass('doanhThuChuaXuat')} text-right" data-sort="doanhThuChuaXuat">DT Ch∆∞a Xu·∫•t <span class="sort-indicator"></span></th>
                            </tr>
                 </thead><tbody>`;
        sortedData.forEach(item => {
            const { mucTieu } = item;
            const qdClass = (mucTieu && item.hieuQuaQuyDoi < (mucTieu.phanTramQD / 100)) ? 'cell-performance is-below' : '';
            const tcClass = (mucTieu && item.tyLeTraCham < (mucTieu.phanTramTC / 100)) ? 'cell-performance is-below' : '';
            
            // === START: BUG FIX LOGIC ===
            let sourceTab;
            if (sortStateKey === 'doanhthu_lk') sourceTab = 'dtnv-lk';
            else if (sortStateKey === 'realtime_dt_nhanvien') sourceTab = 'dtnv-rt';
            else sourceTab = 'sknv';
            // === END: BUG FIX LOGIC ===

            tableHTML += `<tr class="interactive-row" data-employee-id="${item.maNV}" data-source-tab="${sourceTab}">
                    <td class="px-4 py-2 font-semibold line-clamp-2 employee-name-cell">
                        <a href="#">${uiComponents.getShortEmployeeName(item.hoTen, item.maNV)}</a>
                    </td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.doanhThu)}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.doanhThuQuyDoi)}</td>
                    <td class="px-4 py-2 text-right font-bold ${qdClass}">${uiComponents.formatPercentage(item.hieuQuaQuyDoi)}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.doanhThuTraGop)}</td>
                    <td class="px-4 py-2 text-right font-bold ${tcClass}">${uiComponents.formatPercentage(item.tyLeTraCham)}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.doanhThuChuaXuat)}</td></tr>`;
        });
         tableHTML += `</tbody><tfoot class="table-footer font-bold"><tr>
                    <td class="px-4 py-2">T·ªïng</td>
                    <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.doanhThu)}</td>
                    <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.doanhThuQuyDoi)}</td>
                    <td class="px-4 py-2 text-right">${uiComponents.formatPercentage(totals.hieuQuaQuyDoi)}</td>
                    <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.doanhThuTraGop)}</td>
                    <td class="px-4 py-2 text-right">${uiComponents.formatPercentage(totals.tyLeTraCham)}</td>
                    <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.doanhThuChuaXuat)}</td>
                 </tr></tfoot></table></div></div>`;
        return tableHTML;
    },

    displayEmployeeEfficiencyReport: (reportData, containerId, sortStateKey) => {
        const container = document.getElementById(containerId);
        if (!container) return;
        if (!reportData || reportData.length === 0) {
            container.innerHTML = '<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªáu qu·∫£ cho l·ª±a ch·ªçn n√†y.</p>';
            return;
        }

        const columnSettings = settingsService.loadEfficiencyViewSettings();
        const visibleColumns = columnSettings.filter(c => c.visible);

        const columnTogglesHTML = `
            <div id="efficiency-column-toggles" class="p-3 border-b border-gray-200 flex flex-wrap items-center gap-x-2 gap-y-2">
                <span class="text-sm font-semibold mr-2 text-gray-700 non-draggable">T√πy ch·ªânh c·ªôt:</span>
                ${columnSettings.map(col => `
                    <button 
                        class="column-toggle-btn draggable-tag flex items-center ${col.visible ? 'active' : ''}" 
                        data-column-id="${col.id}">
                        <svg class="drag-handle-icon mr-2 cursor-grab" width="12" height="12" viewBox="0 0 10 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M4 2a1 1 0 10-2 0 1 1 0 002 0zM2 9a1 1 0 110-2 1 1 0 010 2zm0 5a1 1 0 110-2 1 1 0 010 2zm5-12a1 1 0 10-2 0 1 1 0 002 0zM7 9a1 1 0 110-2 1 1 0 010 2zm0 5a1 1 0 110-2 1 1 0 010 2z" fill="currentColor"></path></svg>
                        <span>${col.label}</span>
                    </button>
                `).join('')}
            </div>
        `;

        let finalHTML = `<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
                            ${columnTogglesHTML}
                            <div data-capture-group="efficiency-table">
                                <div class="p-4 header-group-3 text-gray-800">
                                    <h3 class="text-xl font-bold uppercase">HI·ªÜU QU·∫¢ KHAI TH√ÅC THEO NH√ÇN VI√äN</h3>
                                    <p class="text-sm italic text-gray-600">(ƒë∆°n v·ªã t√≠nh: Tri·ªáu ƒë·ªìng)</p>
                                </div>`;

        const groupedByDept = {};
        reportData.forEach(item => {
            const dept = item.boPhan;
            if (!groupedByDept[dept]) groupedByDept[dept] = [];
            groupedByDept[dept].push(item);
        });

        const departmentOrder = utils.getSortedDepartmentList(reportData);

        departmentOrder.forEach(deptName => {
            if (groupedByDept[deptName]) {
                finalHTML += uiComponents.renderEfficiencyTableForDepartment(deptName, groupedByDept[deptName], sortStateKey, visibleColumns);
            }
        });

        finalHTML += `    </div> 
                        </div>`;
        container.innerHTML = finalHTML;
    },

    renderEfficiencyTableForDepartment: (title, data, sortStateKey, visibleColumns) => {
        const sortState = appState.sortState[sortStateKey] || { key: 'dtICT', direction: 'desc' };
        const { key, direction } = sortState;
        const sortedData = [...data].sort((a, b) => {
            const valA = a[key] || 0; const valB = b[key] || 0;
            return direction === 'asc' ? valA - valB : valB - valA;
        });

        const formatMap = {
            dtICT: (val) => uiComponents.formatRevenue(val),
            dtPhuKien: (val) => uiComponents.formatRevenue(val),
            dtCE: (val) => uiComponents.formatRevenue(val),
            dtGiaDung: (val) => uiComponents.formatRevenue(val),
            defaultPercent: (val) => uiComponents.formatPercentage(val)
        };

        const totals = data.reduce((acc, item) => {
            acc.dtICT += item.dtICT;
            acc.dtPhuKien += item.dtPhuKien;
            acc.dtCE += item.dtCE;
            acc.dtGiaDung += item.dtGiaDung;
            acc.dtMLN += item.dtMLN;
            acc.slSmartphone += item.slSmartphone;
            acc.slSimOnline += item.slSimOnline;
            acc.slUDDD += item.slUDDD;
            acc.slBaoHiemDenominator += item.slBaoHiemDenominator;
            acc.slBaoHiemVAS += item.slBaoHiemVAS;
            return acc;
        }, { dtICT: 0, dtPhuKien: 0, dtCE: 0, dtGiaDung: 0, dtMLN: 0, slSmartphone: 0, slSimOnline: 0, slUDDD: 0, slBaoHiemDenominator: 0, slBaoHiemVAS: 0 });

        totals.pctPhuKien = totals.dtICT > 0 ? totals.dtPhuKien / totals.dtICT : 0;
        totals.pctGiaDung = totals.dtCE > 0 ? totals.dtGiaDung / totals.dtCE : 0;
        totals.pctMLN = totals.dtCE > 0 ? totals.dtMLN / totals.dtCE : 0;
        totals.pctSim = totals.slSmartphone > 0 ? totals.slSimOnline / totals.slSmartphone : 0;
        totals.pctVAS = totals.slSmartphone > 0 ? totals.slUDDD / totals.slSmartphone : 0;
        totals.pctBaoHiem = totals.slBaoHiemDenominator > 0 ? totals.slBaoHiemVAS / totals.slBaoHiemDenominator : 0;
        
        let titleClass = '';
        if (title.includes('T∆∞ V·∫•n')) titleClass = 'department-header-tv';
        else if (title.includes('Kho')) titleClass = 'department-header-kho';
        else if (title.includes('Trang Tr√≠')) titleClass = 'department-header-tt';

        const allHeaders = {
            dtICT: { label: 'DT ICT', class: 'text-right header-group-10' },
            dtPhuKien: { label: 'DT Ph·ª• ki·ªán', class: 'text-right header-group-10' },
            pctPhuKien: { label: '% Ph·ª• ki·ªán', class: 'text-right header-group-10' },
            dtCE: { label: 'DT CE', class: 'text-right header-group-11' },
            dtGiaDung: { label: 'DT Gia d·ª•ng', class: 'text-right header-group-11' },
            pctGiaDung: { label: '% Gia d·ª•ng', class: 'text-right header-group-11' },
            pctMLN: { label: '% MLN', class: 'text-right header-group-12' },
            pctSim: { label: '% Sim', class: 'text-right header-group-12' },
            pctVAS: { label: '% VAS', class: 'text-right header-group-12' },
            pctBaoHiem: { label: '% B·∫£o hi·ªÉm', class: 'text-right header-group-12' }
        };

        const headerClass = (sortKey) => `px-4 py-3 sortable draggable-header ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;
        const captureColumnCount = 1 + visibleColumns.length;

        let tableHTML = `<div class="department-block"><h4 class="text-lg font-bold p-4 border-b border-gray-200 ${titleClass}">${title}</h4><div class="overflow-x-auto"><table class="min-w-full text-sm text-left text-gray-600 table-bordered table-striped" data-table-type="${sortStateKey}" data-capture-columns="${captureColumnCount}">
            <thead class="text-xs text-slate-800 uppercase font-bold">
                 <tr>
                    <th class="${headerClass('hoTen')}" data-sort="hoTen">T√™n nh√¢n vi√™n <span class="sort-indicator"></span></th>
                    ${visibleColumns.map(col => `<th class="${headerClass(col.id)} ${allHeaders[col.id].class}" data-sort="${col.id}">${allHeaders[col.id].label} <span class="sort-indicator"></span></th>`).join('')}
                </tr>
            </thead><tbody>`;

        sortedData.forEach(item => {
            const { mucTieu } = item;
            const classMap = {
                pctPhuKien: (mucTieu && item.pctPhuKien < (mucTieu.phanTramPhuKien / 100)) ? 'cell-performance is-below' : '',
                pctGiaDung: (mucTieu && item.pctGiaDung < (mucTieu.phanTramGiaDung / 100)) ? 'cell-performance is-below' : '',
                pctMLN: (mucTieu && item.pctMLN < (mucTieu.phanTramMLN / 100)) ? 'cell-performance is-below' : '',
                pctSim: (mucTieu && item.pctSim < (mucTieu.phanTramSim / 100)) ? 'cell-performance is-below' : '',
                pctVAS: (mucTieu && item.pctVAS < (mucTieu.phanTramVAS / 100)) ? 'cell-performance is-below' : '',
                pctBaoHiem: (mucTieu && item.pctBaoHiem < (mucTieu.phanTramBaoHiem / 100)) ? 'cell-performance is-below' : ''
            };

            tableHTML += `<tr class="interactive-row">
                <td class="px-4 py-2 font-semibold line-clamp-2 employee-name-cell" data-employee-id="${item.maNV}" data-source-tab="sknv">
                    <a href="#">${uiComponents.getShortEmployeeName(item.hoTen, item.maNV)}</a>
                </td>
                ${visibleColumns.map(col => {
                    const value = item[col.id];
                    const className = classMap[col.id] || '';
                    const formatter = formatMap[col.id] || formatMap.defaultPercent;
                    return `<td class="px-4 py-2 text-right font-bold ${className}">${formatter(value)}</td>`;
                }).join('')}
            </tr>`;
        });

        tableHTML += `</tbody><tfoot class="table-footer font-bold">
             <tr>
                <td class="px-4 py-2">T·ªïng</td>
                ${visibleColumns.map(col => {
                    const value = totals[col.id];
                    const formatter = formatMap[col.id] || formatMap.defaultPercent;
                    return `<td class="px-4 py-2 text-right">${formatter(value)}</td>`;
                }).join('')}
            </tr>
        </tfoot></table></div></div>`;
        return tableHTML;
    },
    
    renderCategoryTable(title, sortStateKey, reportData, mainRevenueKey, mainQuantityKey, subQuantityKeys, subQuantityLabels) {
        const sortState = appState.sortState[sortStateKey] || { key: mainRevenueKey, direction: 'desc' };
        const { key, direction } = sortState;

        const sortedData = [...reportData].sort((a, b) => {
            const valA = a[key] || 0;
            const valB = b[key] || 0;
            return direction === 'asc' ? valA - valB : valB - valA;
        });

        const totals = reportData.reduce((acc, item) => {
            acc[mainRevenueKey] += item[mainRevenueKey];
            acc[mainQuantityKey] += item[mainQuantityKey];
            subQuantityKeys.forEach(subKey => {
                acc[subKey] = (acc[subKey] || 0) + (item[subKey] || 0);
            });
            return acc;
        }, { [mainRevenueKey]: 0, [mainQuantityKey]: 0, ...subQuantityKeys.reduce((obj, key) => ({...obj, [key]: 0}), {}) });

        const headerClass = (sortKey) => `px-2 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;
        const titleClass = {
            'ICT': 'category-header-ict',
            'PH·ª§ KI·ªÜN': 'category-header-phukien',
            'GIA D·ª§NG': 'category-header-giadung',
            'CE': 'category-header-ce',
            'B·∫¢O HI·ªÇM': 'category-header-baohiem',
        }[title] || 'bg-gray-200';

        const subHeaders = subQuantityLabels.map((label) => `<th class="px-2 py-2 text-right">${label}</th>`).join('');

        const tableRows = [];
        sortedData.forEach(item => {
            if (item[mainRevenueKey] > 0 || item[mainQuantityKey] > 0) {
                 tableRows.push(`
                    <tr class="interactive-row">
                        <td class="px-2 py-2 font-semibold line-clamp-2 employee-name-cell" data-employee-id="${item.maNV}" data-source-tab="sknv">
                            <a href="#">${this.getShortEmployeeName(item.hoTen, item.maNV)}</a>
                        </td>
                        <td class="px-2 py-2 text-right font-bold">${this.formatRevenue(item[mainRevenueKey])}</td>
                        <td class="px-2 py-2 text-right font-bold">${this.formatNumberOrDash(item[mainQuantityKey])}</td>
                        ${subQuantityKeys.map(subKey => `<td class="px-2 py-2 text-right">${this.formatNumberOrDash(item[subKey])}</td>`).join('')}
                    </tr>
                `);
            }
        });

        const html = `
            <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
                <h4 class="text-lg font-bold p-3 border-b ${titleClass}">${title}</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm table-bordered table-striped" data-table-type="${sortStateKey}">
                        <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
                            <tr>
                                <th rowspan="2" class="${headerClass('hoTen')}" data-sort="hoTen">Nh√¢n vi√™n</th>
                                <th rowspan="2" class="${headerClass(mainRevenueKey)} text-right" data-sort="${mainRevenueKey}">DT</th>
                                <th rowspan="2" class="${headerClass(mainQuantityKey)} text-right" data-sort="${mainQuantityKey}">T·ªïng SL</th>
                                <th colspan="${subQuantityKeys.length}" class="px-2 py-2 text-center">Chi ti·∫øt SL</th>
                            </tr>
                            <tr>${subHeaders}</tr>
                        </thead>
                        <tbody>
                            ${tableRows.join('')}
                        </tbody>
                        <tfoot class="table-footer font-bold">
                            <tr>
                                <td class="px-2 py-2">T·ªïng</td>
                                <td class="px-2 py-2 text-right">${this.formatRevenue(totals[mainRevenueKey])}</td>
                                <td class="px-2 py-2 text-right">${this.formatNumberOrDash(totals[mainQuantityKey])}</td>
                                ${subQuantityKeys.map(subKey => `<td class="px-2 py-2 text-right">${this.formatNumberOrDash(totals[subKey])}</td>`).join('')}
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>`;
        return html;
    },

    displayCategoryRevenueReport(reportData, containerId, sortStatePrefix) {
        const container = document.getElementById(containerId);
        if (!container) return;
    
        const hasAnyData = reportData.some(item => item.dtICT > 0 || item.dtPhuKien > 0 || item.dtGiaDung > 0 || item.dtCE > 0 || item.dtBaoHiem > 0);
        if (!hasAnyData) {
            container.innerHTML = '<p class="text-yellow-600 font-semibold">Kh√¥ng t√¨m th·∫•y doanh thu cho c√°c ng√†nh h√†ng ch√≠nh.</p>';
            return;
        }

        const htmlParts = [
            '<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">',
            `<div data-capture-group="1" data-capture-columns="6">${this.renderCategoryTable('ICT', `${sortStatePrefix}_ict`, reportData, 'dtICT', 'slICT', ['slDienThoai', 'slLaptop'], ['SL ƒêi·ªán tho·∫°i', 'SL Laptop'])}</div>`,
            `<div data-capture-group="1" data-capture-columns="6">${this.renderCategoryTable('PH·ª§ KI·ªÜN', `${sortStatePrefix}_phukien`, reportData, 'dtPhuKien', 'slPhuKien', ['slPinSDP', 'slCamera', 'slTaiNgheBLT'], ['SL Pin SDP', 'SL Camera', 'SL Tai nghe BLT'])}</div>`,
            `<div data-capture-group="2" data-capture-columns="6">${this.renderCategoryTable('GIA D·ª§NG', `${sortStatePrefix}_giadung`, reportData, 'dtGiaDung', 'slGiaDung', ['slNoiChien', 'slMLN', 'slRobotHB'], ['SL N·ªìi chi√™n', 'SL MLN', 'SL Robot HB'])}</div>`,
            `<div data-capture-group="2" data-capture-columns="6">${this.renderCategoryTable('CE', `${sortStatePrefix}_ce`, reportData, 'dtCE', 'slCE', ['slTivi', 'slTuLanh', 'slMayGiat', 'slMayLanh'], ['SL Tivi', 'SL T·ªß l·∫°nh', 'SL M√°y gi·∫∑t', 'SL M√°y l·∫°nh'])}</div>`,
            `<div class="lg:col-span-2" data-capture-group="3" data-capture-columns="7">${this.renderCategoryTable('B·∫¢O HI·ªÇM', `${sortStatePrefix}_baohiem`, reportData, 'dtBaoHiem', 'slBaoHiem', ['slBH1d1', 'slBHXM', 'slBHRV', 'slBHMR'], ['BH 1-1', 'BHXM', 'BHRV', 'BHMR'])}</div>`,
            '</div>'
        ];
        container.innerHTML = htmlParts.join('');
    },
    
    showProgressBar: (elementId) => document.getElementById(`progress-${elementId}`)?.classList.remove('hidden'),
    hideProgressBar: (elementId) => document.getElementById(`progress-${elementId}`)?.classList.add('hidden'),
    
    showNotification: (message, type = 'success') => {
        const notification = document.getElementById('notification');
        if (!notification) return;
        notification.textContent = message;
        notification.className = `notification ${type === 'success' ? 'notification-success' : 'notification-error'} show`;
        setTimeout(() => notification.classList.remove('show'), 3000);
    },

    showUpdateNotification() {
        const notification = document.getElementById('update-notification');
        if (notification) {
            notification.classList.add('show');
            notification.querySelector('button').onclick = () => window.location.reload();
        }
    },
    
    updateUsageCounter: (statsData) => {
        const visitorCountEl = document.getElementById('visitor-count');
        const actionCountEl = document.getElementById('action-count');
        const userCountEl = document.getElementById('user-count');

        if (visitorCountEl) {
            visitorCountEl.textContent = statsData.pageLoads ? uiComponents.formatNumber(statsData.pageLoads) : '0';
        }
        if (actionCountEl) {
            actionCountEl.textContent = statsData.actionsTaken ? uiComponents.formatNumber(statsData.actionsTaken) : '0';
        }
        if (userCountEl) {
            userCountEl.textContent = statsData.totalUsers ? uiComponents.formatNumber(statsData.totalUsers) : '0';
        }
    },

    updateFileStatus(fileType, fileName, statusText, statusType = 'default') {
        const fileNameSpan = document.getElementById(`file-name-${fileType}`);
        const fileStatusSpan = document.getElementById(`file-status-${fileType}`);
        if (fileNameSpan) fileNameSpan.textContent = fileName;
        if (fileStatusSpan) {
            fileStatusSpan.textContent = statusText;
            fileStatusSpan.className = `data-input-group__status-text data-input-group__status-text--${statusType}`;
        }
    },

    updatePasteStatus(elementId, statusText = '‚úì ƒê√£ nh·∫≠n d·ªØ li·ªáu.') {
        const statusSpan = document.getElementById(elementId);
        if (statusSpan) {
            statusSpan.textContent = statusText;
            statusSpan.className = 'data-input-group__status-text data-input-group__status-text--success';
        }
    },

    togglePlaceholder: (sectionId, show) => {
        const placeholder = document.getElementById(`${sectionId}-placeholder`);
        const content = document.getElementById(`${sectionId}-content`);
        if (placeholder && content) {
            placeholder.classList.toggle('hidden', !show);
            content.classList.toggle('hidden', show);
        }
    },

    formatNumber: (value, decimals = 0) => {
        if (isNaN(value) || value === null) return '0';
        return new Intl.NumberFormat('vi-VN', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(value);
    },
    
    formatRevenue(value) {
        if (!isFinite(value) || value === null || value === 0) return '-';
        const millions = value / 1000000;
        const roundedValue = Math.round(millions * 10) / 10;
        return new Intl.NumberFormat('vi-VN', { 
            minimumFractionDigits: 0, 
            maximumFractionDigits: 1 
        }).format(roundedValue);
    },

    formatNumberOrDash: (value) => {
        if (!isFinite(value) || value === null || value === 0) return '-';
        const roundedValue = Math.round(value * 10) / 10;
        if (roundedValue === 0) return '-';
        return new Intl.NumberFormat('vi-VN', { 
            minimumFractionDigits: 0, 
            maximumFractionDigits: 1 
        }).format(roundedValue);
    },

    formatPercentage: (value) => {
        if (!isFinite(value) || value === null) return '-';
        if (value === 0) return '-';
        return new Intl.NumberFormat('vi-VN', { 
            style: 'percent', 
            maximumFractionDigits: 0 
        }).format(value);
    },
    
    formatTimeAgo(date) {
        if (!date) return '';
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " nƒÉm tr∆∞·ªõc";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " th√°ng tr∆∞·ªõc";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " ng√†y tr∆∞·ªõc";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " gi·ªù tr∆∞·ªõc";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " ph√∫t tr∆∞·ªõc";
        return "v√†i gi√¢y tr∆∞·ªõc";
    },

    // === START: UPDATED FUNCTION (V3.8) ===
    getShortEmployeeName(hoTen, maNV) {
        if (!hoTen) return maNV || '';
        const nameParts = hoTen.split(' ').filter(p => p); // L·ªçc b·ªè c√°c kho·∫£ng tr·∫Øng th·ª´a
        
        let displayName = hoTen; // M·∫∑c ƒë·ªãnh l√† t√™n ƒë·∫ßy ƒë·ªß
        if (nameParts.length > 2) {
            displayName = nameParts.slice(-2).join(' '); // L·∫•y 2 t·ª´ cu·ªëi
        }
        
        return `${displayName} - ${maNV}`;
    },
    // === END: UPDATED FUNCTION ===

    toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        if (show) {
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('is-visible'), 10);
        } else {
            modal.classList.remove('is-visible');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
    },

    toggleDrawer(drawerId, show) {
        const drawer = document.getElementById(drawerId);
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('drawer-overlay');

        if (!drawer || !sidebar || !overlay) return;
        if (show) {
            drawer.classList.remove('hidden');
            setTimeout(() => {
                drawer.classList.add('open');
                sidebar.classList.add('menu-locked');
                overlay.classList.remove('hidden');
            }, 10);
        } else {
            drawer.classList.remove('open');
            sidebar.classList.remove('menu-locked');
            overlay.classList.add('hidden');
            setTimeout(() => drawer.classList.add('hidden'), 300);
        }
    },

    closeAllDrawers() {
        this.toggleDrawer('interface-drawer', false);
        this.toggleDrawer('goal-drawer', false);
    },
    
    handleSubTabClick(button) {
        const nav = button.closest('nav');
        if (!nav) return;
        const targetId = button.dataset.target;
        const contentContainer = document.getElementById(nav.dataset.contentContainer);
        if (!contentContainer) return;

        nav.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
        button.classList.add('active');
        contentContainer.querySelectorAll('.sub-tab-content').forEach(content => content.classList.toggle('hidden', content.id !== targetId));
    },

    toggleFilterSection(targetId) {
        const targetContainer = document.getElementById(targetId);
        const button = document.querySelector(`.toggle-filters-btn[data-target="${targetId}"]`);
        if (targetContainer && button) {
            targetContainer.classList.toggle('hidden');
            const isHidden = targetContainer.classList.contains('hidden');
            button.classList.toggle('active', !isHidden);
            const textSpan = button.querySelector('.text');
            if (textSpan) textSpan.textContent = isHidden ? 'Hi·ªán b·ªô l·ªçc n√¢ng cao' : '·∫®n b·ªô l·ªçc n√¢ng cao';
        }
    },

    toggleDebugTool(button) {
        const container = document.getElementById('debug-tool-container');
        if (container) {
            container.classList.toggle('hidden');
            button.textContent = container.classList.contains('hidden') ? 'Hi·ªÉn th·ªã C√¥ng c·ª• G·ª° l·ªói' : '·∫®n C√¥ng c·ª• G·ª° l·ªói';
        }
    },

    showHelpModal(helpId) {
        const title = `H∆∞·ªõng d·∫´n cho Tab ${helpId.charAt(0).toUpperCase() + helpId.slice(1)}`;
        const content = appState.helpContent[helpId] || "N·ªôi dung h∆∞·ªõng d·∫´n kh√¥ng c√≥ s·∫µn.";
        
        document.getElementById('help-modal-title').textContent = title;
        document.getElementById('help-modal-content').innerHTML = content.replace(/\n/g, '<br>');
        this.toggleModal('help-modal', true);
    },
    
    showComposerModal(sectionId) {
        this.toggleModal('composer-modal', true);
    },
    
    insertComposerTag(textarea, tag) {
        if (!textarea) return;
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        textarea.value = `${textarea.value.substring(0, start)}${tag}${textarea.value.substring(end)}`;
        textarea.focus();
        textarea.selectionEnd = start + tag.length;
    },

    showPreviewAndCopy(processedText) {
        const previewContentEl = document.getElementById('preview-modal-content');
        if (!previewContentEl) return;
        previewContentEl.textContent = processedText;
        this.toggleModal('preview-modal', true);
    },

    copyFromPreview() {
        const content = document.getElementById('preview-modal-content').textContent;
        navigator.clipboard.writeText(content)
            .then(() => {
                uiComponents.showNotification('ƒê√£ sao ch√©p n·ªôi dung!', 'success');
                uiComponents.toggleModal('preview-modal', false);
            })
            .catch(err => {
                console.error('L·ªói sao ch√©p:', err);
                uiComponents.showNotification('L·ªói khi sao ch√©p.', 'error');
            });
    },

    renderAdminHelpEditors() {
        if (appState.isAdmin) {
            document.getElementById('edit-help-data').value = appState.helpContent.data;
            document.getElementById('edit-help-luyke').value = appState.helpContent.luyke;
            document.getElementById('edit-help-sknv').value = appState.helpContent.sknv;
            document.getElementById('edit-help-realtime').value = appState.helpContent.realtime;
        }
    },
    
    renderHomePage() {
        this.renderUpdateHistory();
        this.renderFeedbackSection();
    },

    async renderUpdateHistory() {
        const container = document.getElementById('update-history-list');
        if (!container) return;
        
        try {
            const response = await fetch(`./changelog.json?v=${new Date().getTime()}`);
            if (!response.ok) {
                throw new Error('Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ c·∫≠p nh·∫≠t.');
            }
            const updateHistory = await response.json();
            
            container.innerHTML = updateHistory.map(item => `
                <div class="bg-white rounded-xl shadow-md p-5 border border-gray-200">
                    <h4 class="font-bold text-blue-600 mb-2">Phi√™n b·∫£n ${item.version} (${item.date})</h4>
                    <ul class="list-disc list-inside text-gray-700 space-y-1 text-sm">
                        ${item.notes.map(note => `<li>${note}</li>`).join('')}
                    </ul>
                </div>
            `).join('');

        } catch (error) {
            console.error("L·ªói khi render l·ªãch s·ª≠ c·∫≠p nh·∫≠t:", error);
            container.innerHTML = '<p class="text-red-500">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ c·∫≠p nh·∫≠t.</p>';
        }
    },
    
    renderFeedbackSection() {
        const composerContainer = document.getElementById('feedback-composer');
        const listContainer = document.getElementById('feedback-list');
        if (!composerContainer || !listContainer) return;

        composerContainer.innerHTML = `
            <h4 class="text-lg font-semibold text-gray-800 mb-3">G·ª≠i g√≥p √Ω c·ªßa b·∫°n</h4>
            <textarea id="feedback-textarea" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mb-3" rows="4" placeholder="Ch√∫ng t√¥i lu√¥n l·∫Øng nghe √Ω ki·∫øn c·ªßa b·∫°n ƒë·ªÉ c·∫£i thi·ªán c√¥ng c·ª• t·ªët h∆°n..."></textarea>
            <button id="submit-feedback-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">G·ª≠i g√≥p √Ω</button>
        `;

        if (appState.feedbackList.length === 0) {
            listContainer.innerHTML = '<p class="text-center text-gray-500 mt-4">Ch∆∞a c√≥ g√≥p √Ω n√†o.</p>';
            return;
        }

        listContainer.innerHTML = appState.feedbackList.map(item => {
            let userNameDisplay = 'Ng∆∞·ªùi d√πng c≈©'; 
            if (typeof item.user === 'object' && item.user !== null && item.user.uid) {
                if (item.user.isAnonymous) {
                    userNameDisplay = `Ng∆∞·ªùi d√πng Kh√°ch #${item.user.uid.slice(-6)}`;
                } 
            } else if (typeof item.user === 'string') {
                userNameDisplay = item.user;
            }

            return `
                <div class="feedback-item bg-white rounded-xl shadow-md p-5 border border-gray-200" data-id="${item.id}">
                    <p class="text-gray-800">${item.content}</p>
                    <div class="text-xs text-gray-500 mt-3 flex justify-between items-center">
                        <span class="font-semibold">${userNameDisplay}</span>
                        <span>${this.formatTimeAgo(item.timestamp)}</span>
                        ${appState.isAdmin ? `<button class="reply-btn text-blue-600 hover:underline">Tr·∫£ l·ªùi</button>` : ''}
                    </div>
                    
                    <div class="ml-6 mt-4 space-y-3">
                        ${(item.replies || []).map(reply => `
                            <div class="bg-gray-100 rounded-lg p-3">
                                <p class="text-gray-700 text-sm">${reply.content}</p>
                                <div class="text-xs text-gray-500 mt-2">
                                    <strong>Admin</strong> - ${this.formatTimeAgo(reply.timestamp instanceof Date ? reply.timestamp : reply.timestamp?.toDate())}
                                </div>
                            </div>
                        `).join('')}
                    </div>
    
                    <div class="reply-form-container hidden ml-6 mt-4">
                        <textarea class="w-full p-2 border rounded-lg text-sm" rows="2" placeholder="Vi·∫øt c√¢u tr·∫£ l·ªùi..."></textarea>
                        <div class="flex justify-end gap-2 mt-2">
                            <button class="cancel-reply-btn text-sm text-gray-600 px-3 py-1 rounded-md hover:bg-gray-100">H·ªßy</button>
                            <button class="submit-reply-btn text-sm bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700">G·ª≠i</button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    },

    applyInterfaceSettings(settings) {
        const root = document.documentElement;
        if (settings.kpiCard1Bg) root.style.setProperty('--kpi-card-1-bg', settings.kpiCard1Bg);
        if (settings.kpiCard2Bg) root.style.setProperty('--kpi-card-2-bg', settings.kpiCard2Bg);
        if (settings.kpiCard3Bg) root.style.setProperty('--kpi-card-3-bg', settings.kpiCard3Bg);
        if (settings.kpiCard4Bg) root.style.setProperty('--kpi-card-4-bg', settings.kpiCard4Bg);
        if (settings.kpiCard5Bg) root.style.setProperty('--kpi-card-5-bg', settings.kpiCard5Bg);
        if (settings.kpiCard6Bg) root.style.setProperty('--kpi-card-6-bg', settings.kpiCard6Bg);
        if (settings.kpiCard7Bg) root.style.setProperty('--kpi-card-7-bg', settings.kpiCard7Bg);
        if (settings.kpiCard8Bg) root.style.setProperty('--kpi-card-8-bg', settings.kpiCard8Bg);
        if (settings.kpiTitleColor) root.style.setProperty('--kpi-title-color', settings.kpiTitleColor);
        if (settings.kpiMainColor) root.style.setProperty('--kpi-main-color', settings.kpiMainColor);
        if (settings.kpiSubColor) root.style.setProperty('--kpi-sub-color', settings.kpiSubColor);
    },

    displayDebugInfo(fileType) {
        const resultsContainer = document.getElementById('debug-results-container');
        if (!fileType) {
            if (resultsContainer) resultsContainer.innerHTML = '<p class="text-gray-500">Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c t·∫£i l√™n ƒë·ªÉ ki·ªÉm tra.</p>';
            return;
        }
        if (resultsContainer && resultsContainer.innerHTML.includes('Ch∆∞a c√≥ file n√†o')) resultsContainer.innerHTML = '';

        const debugData = appState.debugInfo[fileType];
        if (!debugData) return;

        const fileName = document.querySelector(`#file-${fileType}`)?.dataset.name || fileType;
        let tableHTML = `<div class="p-2 border rounded-md bg-white mb-4"><h4 class="font-bold text-gray-800 mb-2">${fileName}</h4><table class="min-w-full text-sm">
            <thead class="bg-gray-100"><tr><th class="px-2 py-1 text-left font-semibold text-gray-600">Y√™u c·∫ßu</th><th class="px-2 py-1 text-left font-semibold text-gray-600">C·ªôt t√¨m th·∫•y</th><th class="px-2 py-1 text-center font-semibold text-gray-600">Tr·∫°ng th√°i</th></tr></thead><tbody>`;
        (debugData.required || []).forEach(res => {
            const statusClass = res.status ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100';
            tableHTML += `<tr class="border-t"><td class="px-2 py-1 font-medium">${res.displayName}</td><td class="px-2 py-1 font-mono">${res.foundName}</td><td class="px-2 py-1 text-center font-bold ${statusClass}">${res.status ? 'OK' : 'L·ªñI'}</td></tr>`;
        });
        tableHTML += `</tbody></table>`;
        if (debugData.firstFiveMsnv && debugData.firstFiveMsnv.length > 0) {
            tableHTML += `<div class="mt-2 p-2 bg-gray-50 rounded"><p class="text-xs font-semibold">5 MSNV ƒë·∫ßu ti√™n ƒë·ªçc ƒë∆∞·ª£c:</p><ul class="text-xs font-mono list-disc list-inside">${debugData.firstFiveMsnv.map(msnv => `<li>"${msnv}"</li>`).join('')}</ul></div>`;
        }
        tableHTML += `</div>`;

        const existingEl = document.getElementById(`debug-table-${fileType}`);
        if (existingEl) {
            existingEl.innerHTML = tableHTML;
        } else if (resultsContainer) {
            const wrapper = document.createElement('div');
            wrapper.id = `debug-table-${fileType}`;
            wrapper.innerHTML = tableHTML;
            resultsContainer.appendChild(wrapper);
        }
    },
    
    displayPastedDebugInfo(dataType) {
        const container = document.getElementById('pasted-debug-results-container');
        if (!container) return;

        const debugData = appState.debugInfo[dataType];
        if (!debugData) {
            container.innerHTML = ''; // Clear if no data
            return;
        }

        let content = `<div class="p-2 border rounded-md bg-white mb-4">
            <h4 class="font-bold text-gray-800 mb-2">Ch·∫©n ƒëo√°n d·ªØ li·ªáu d√°n: ${dataType.replace('-pasted', '')}</h4>`;

        if (debugData.found && debugData.found.length > 0) {
            content += '<ul>';
            debugData.found.forEach(item => {
                content += `<li class="text-sm ${item.status ? 'text-green-700' : 'text-red-700'}"><strong>${item.name}:</strong> ${item.value}</li>`;
            });
            content += '</ul>';
        }
    
        content += `<p class="text-xs italic mt-2"><strong>Tr·∫°ng th√°i x·ª≠ l√Ω:</strong> ${debugData.status}</p></div>`;
        container.innerHTML = content;
    },
    
    displayThiDuaVungDebugInfo() {
        const resultsContainer = document.getElementById('debug-results-container');
        if (!resultsContainer) return;
    
        const renderDebugTable = (title, data) => {
            if (!data || data.length === 0) {
                return `<div class="p-2 border rounded-md bg-white mb-4">
                    <h4 class="font-bold text-gray-800 mb-2">${title}</h4>
                    <p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.</p>
                </div>`;
            }
    
            const headers = Object.keys(data[0]);
            let tableHTML = `<div class="p-2 border rounded-md bg-white mb-4">
                <h4 class="font-bold text-gray-800 mb-2">${title}</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-xs">
                        <thead class="bg-gray-100">
                            <tr>${headers.map(h => `<th class="px-2 py-1 text-left font-semibold text-gray-600 whitespace-nowrap">${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>`;
            
            data.forEach(row => {
                tableHTML += `<tr class="border-t">`;
                headers.forEach(header => {
                    tableHTML += `<td class="px-2 py-1 font-mono">${row[header] !== undefined ? row[header] : ''}</td>`;
                });
                tableHTML += `</tr>`;
            });
    
            tableHTML += `</tbody></table></div></div>`;
            return tableHTML;
        };
    
        const tongRaw = appState.debugInfo.thiDuaVungTongRaw;
        const chiTietRaw = appState.debugInfo.thiDuaVungChiTietRaw;
    
        let finalHTML = renderDebugTable('Thi ƒêua V√πng - Sheet TONG (10 d√≤ng ƒë·∫ßu)', tongRaw);
        finalHTML += renderDebugTable('Thi ƒêua V√πng - Sheet CHITIET (10 d√≤ng ƒë·∫ßu)', chiTietRaw);
        
        const existingEl = document.getElementById('debug-table-thidua-vung');
        if (existingEl) {
            existingEl.innerHTML = finalHTML;
        } else {
            const wrapper = document.createElement('div');
            wrapper.id = `debug-table-thidua-vung`;
            wrapper.innerHTML = finalHTML;
            resultsContainer.appendChild(wrapper);
        }
    
    },

    renderCompetitionDebugReport(debugResults) {
        const container = document.getElementById('debug-competition-results');
        if (!container) return;

        if (!debugResults || debugResults.length === 0) {
            container.innerHTML = '<p class="text-gray-600">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch.</p>';
            return;
        }

        const validCount = debugResults.filter(r => r.isOverallValid).length;
        const totalCount = debugResults.length;

        const checkHeaders = ['HTX H·ª£p l·ªá', 'ƒê√£ thu', 'Ch∆∞a h·ªßy', 'Ch∆∞a tr·∫£', 'ƒê√£ xu·∫•t'];

        let tableHTML = `
            <div class="p-4 bg-white border rounded-lg">
                <h4 class="font-bold text-lg mb-2">K·∫øt qu·∫£ Ph√¢n t√≠ch File: <span class="text-green-600">${validCount}</span> / ${totalCount} d√≤ng h·ª£p l·ªá</h4>
                <div class="overflow-x-auto max-h-[600px]">
                    <table class="min-w-full text-xs table-bordered competition-debug-table">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-2">Ng∆∞·ªùi t·∫°o</th>
                                <th class="p-2">Nh√≥m h√†ng</th>
                                <th class="p-2">HT Xu·∫•t</th>
                                <th class="p-2">TT Thu ti·ªÅn</th>
                                <th class="p-2">TT H·ªßy</th>
                                <th class="p-2">TT Tr·∫£</th>
                                <th class="p-2">TT Xu·∫•t</th>
                                ${checkHeaders.map(h => `<th class="p-2">${h}</th>`).join('')}
                                <th class="p-2">T·ªïng th·ªÉ</th>
                            </tr>
                        </thead>
                        <tbody>`;

        const renderCheck = (status) => `<td class="text-center font-bold text-lg">${status ? '<span class="text-green-500">‚úÖ</span>' : '<span class="text-red-500">‚ùå</span>'}</td>`;

        debugResults.forEach(result => {
            const rowClass = result.isOverallValid ? 'bg-green-50' : 'bg-red-50';
            const { rowData, checks, isOverallValid } = result;
            tableHTML += `
                <tr class="${rowClass}">
                    <td class="p-2">${rowData.nguoiTao || ''}</td>
                    <td class="p-2">${rowData.nhomHang || ''}</td>
                    <td class="p-2">${rowData.hinhThucXuat || ''}</td>
                    <td class="p-2">${rowData.trangThaiThuTien || ''}</td>
                    <td class="p-2">${rowData.trangThaiHuy || ''}</td>
                    <td class="p-2">${rowData.tinhTrangTra || ''}</td>
                    <td class="p-2">${rowData.trangThaiXuat || ''}</td>
                    ${renderCheck(checks.isDoanhThuHTX)}
                    ${renderCheck(checks.isThuTien)}
                    ${renderCheck(checks.isChuaHuy)}
                    ${renderCheck(checks.isChuaTra)}
                    ${renderCheck(checks.isDaXuat)}
                    ${renderCheck(isOverallValid)}
                </tr>
            `;
        });
        
        tableHTML += '</tbody></table></div></div>';
        container.innerHTML = tableHTML;
    },
    
    populateAllFilters: () => {
        const { danhSachNhanVien } = appState;
        if (danhSachNhanVien.length === 0) return;

        const uniqueWarehouses = [...new Set(danhSachNhanVien.map(nv => nv.maKho).filter(Boolean))].sort();
        const uniqueDepartments = [...new Set(danhSachNhanVien.map(nv => nv.boPhan).filter(Boolean))].sort();

        const createChoicesOptions = (items, includeAllOption = true) => {
            const options = items.map(item => ({ value: String(item), label: String(item) }));
            if (includeAllOption) {
                options.unshift({ value: '', label: 'T·∫•t c·∫£' });
            }
            return options;
        };

        const warehouseChoicesOptions = createChoicesOptions(uniqueWarehouses);
        const departmentChoicesOptions = createChoicesOptions(uniqueDepartments);

        ['luyke', 'sknv', 'realtime'].forEach(prefix => {
            const warehouseInstance = appState.choices[`${prefix}_warehouse`];
            if (warehouseInstance) {
                warehouseInstance.clearStore();
                warehouseInstance.setChoices(warehouseChoicesOptions, 'value', 'label', true);
            }
            
            const departmentInstance = appState.choices[`${prefix}_department`];
            if (departmentInstance) {
                departmentInstance.clearStore();
                departmentInstance.setChoices(departmentChoicesOptions, 'value', 'label', true);
            }
            
            uiComponents.updateEmployeeFilter(prefix);
        });
        
        const createOptionsHTML = (items, includeAllOption = false) => {
            let html = includeAllOption ? '<option value="">T·∫•t c·∫£</option>' : '';
            html += items.map(item => `<option value="${item}">${item}</option>`).join('');
            return html;
        };
        const luykeGoalEl = document.getElementById('luyke-goal-warehouse-select');
        if (luykeGoalEl) luykeGoalEl.innerHTML = createOptionsHTML(uniqueWarehouses);
        
        const rtGoalEl = document.getElementById('rt-goal-warehouse-select');
        if (rtGoalEl) rtGoalEl.innerHTML = createOptionsHTML(uniqueWarehouses);
    },

    populateCompetitionFilters() {
        if (!appState.categoryStructure || appState.categoryStructure.length === 0) return;

        const uniqueNhomHang = [...new Set(appState.categoryStructure.map(item => item.nhomHang))].sort();
        const choicesOptions = uniqueNhomHang.map(item => ({ value: item, label: item, selected: false }));

        const groupInstance = appState.choices['competition_group'];
        if (groupInstance) {
            const currentValues = groupInstance.getValue(true);
            groupInstance.clearStore();
            groupInstance.setChoices(choicesOptions, 'value', 'label', false);
            if (currentValues) groupInstance.setValue(currentValues);
        }
    },
    
    populateCompetitionBrandFilter() {
        if (!appState.brandList || appState.brandList.length === 0) return;

        const choicesOptions = appState.brandList.map(brand => ({ value: brand, label: brand, selected: false }));
        
        const instance = appState.choices['competition_brand'];
        if (instance) {
            const currentValues = instance.getValue(true);
            instance.clearStore();
            instance.setChoices(choicesOptions, 'value', 'label', false);
            if (currentValues && currentValues.length > 0) {
                const validValues = currentValues.filter(val => appState.brandList.includes(val));
                instance.setValue(validValues);
            }
        }
    },

    populateRealtimeBrandCategoryFilter: () => {
        const { realtimeYCXData } = appState;
        const realtimeBrandCategoryFilter = document.getElementById('realtime-brand-category-filter');
        if (!realtimeBrandCategoryFilter) return;

        if (realtimeYCXData.length > 0) {
            const uniqueCategories = [...new Set(realtimeYCXData.map(r => utils.cleanCategoryName(r.nganhHang)).filter(Boolean))].sort();
            let html = '<option value="">T·∫•t c·∫£</option>';
            html += uniqueCategories.map(item => `<option value="${item}">${item}</option>`).join('');
            realtimeBrandCategoryFilter.innerHTML = html;
        } else {
            realtimeBrandCategoryFilter.innerHTML = '<option value="">T·∫•t c·∫£</option>';
        }
    },

    updateEmployeeFilter: (prefix) => {
        const multiSelectInstance = appState.choices[`${prefix}_employee`];
        const selectedWarehouse = appState.choices[`${prefix}_warehouse`]?.getValue(true) || '';
        const selectedDept = appState.choices[`${prefix}_department`]?.getValue(true) || '';

        const filteredEmployees = appState.danhSachNhanVien.filter(nv => 
            (!selectedWarehouse || String(nv.maKho) == selectedWarehouse) &&
            (!selectedDept || nv.boPhan === selectedDept)
        );

        if (multiSelectInstance) {
            const currentMultiSelectValues = multiSelectInstance.getValue(true);
            const multiSelectOptions = filteredEmployees.map(nv => ({
                value: nv.maNV,
                label: `${uiComponents.getShortEmployeeName(nv.hoTen, nv.maNV)}`,
                selected: currentMultiSelectValues.includes(String(nv.maNV))
            }));
            multiSelectInstance.clearStore();
            multiSelectInstance.setChoices(multiSelectOptions, 'value', 'label', false);
        }

        const singleSelectOptions = filteredEmployees.map(nv => ({
            value: nv.maNV,
            label: uiComponents.getShortEmployeeName(nv.hoTen, nv.maNV)
        }));

        const updateSingleSelect = (instanceKey) => {
            const instance = appState.choices[instanceKey];
            if (instance) {
                const currentValue = instance.getValue(true);
                instance.clearStore();
                instance.setChoices(singleSelectOptions, 'value', 'label', false);
                
                if (currentValue && filteredEmployees.some(e => String(e.maNV) == currentValue)) {
                    instance.setValue([currentValue]);
                }
            }
        };
        
        if (prefix === 'sknv') {
            updateSingleSelect('sknv_employee_detail');
            updateSingleSelect('thidua_employee_detail');
        } else if (prefix === 'realtime') {
            updateSingleSelect('realtime_employee_detail');
        }
    },
    
    updateBrandFilterOptions(selectedCategory) {
        const brandFilter = document.getElementById('realtime-brand-filter');
        if (!brandFilter) return;

        const brands = [...new Set(appState.realtimeYCXData
            .filter(row => !selectedCategory || utils.cleanCategoryName(row.nganhHang) === selectedCategory)
            .map(row => (row.nhaSanXuat || 'H√£ng kh√°c'))
        )].sort();
        
        let html = '<option value="">T·∫•t c·∫£ h√£ng</option>' + brands.map(b => `<option value="${b}">${b}</option>`).join('');
        brandFilter.innerHTML = html;
    },
    
    updateDateSummary(summaryEl, datePickerInstance) {
        if (!summaryEl || !datePickerInstance) return;
        const { selectedDates } = datePickerInstance;
        if (selectedDates.length > 1) {
            const sortedDates = selectedDates.sort((a,b) => a - b);
            summaryEl.textContent = `ƒêang ch·ªçn ${selectedDates.length} ng√†y: ${datePickerInstance.formatDate(sortedDates[0], "d/m")} - ${datePickerInstance.formatDate(sortedDates[sortedDates.length - 1], "d/m")}`;
        } else if (selectedDates.length === 1) {
            summaryEl.textContent = `ƒêang ch·ªçn 1 ng√†y`;
        } else {
            summaryEl.textContent = '';
        }
    },
};
--- END FILE: ./ui-components.js ---

--- START FILE: ./ui-luyke.js ---
// Version 2.11 - Critical Fix: Restore all missing functions and add renderLuykeEmployeeDetail
// MODULE: UI LUY KE
// Ch·ª©a c√°c h√†m render giao di·ªán cho tab "S·ª©c kh·ªèe Si√™u th·ªã (L≈©y k·∫ø)".

import { appState } from './state.js';
import { services } from './services.js';
import { utils } from './utils.js';
import { uiComponents } from './ui-components.js';
import { settingsService } from './modules/settings.service.js';
import { highlightService } from './modules/highlight.service.js';

export const uiLuyke = {
    // === C√ÅC H√ÄM M·ªû MODAL C√ÄI ƒê·∫∂T CHO T·ª™NG B·∫¢NG ===
    _showEfficiencySettingsModal() {
        const modal = document.getElementById('selection-modal');
        if (!modal) return;

        const allItemsConfig = settingsService.loadEfficiencyViewSettings();
        
        const listContainer = document.getElementById('selection-modal-list');
        listContainer.innerHTML = allItemsConfig.map(item => `
            <div class="selection-item">
                <input type="checkbox" id="select-item-lk-eff-${item.id}" value="${item.id}" ${item.visible ? 'checked' : ''}>
                <label for="select-item-lk-eff-${item.id}">${item.label}</label>
             </div>
        `).join('');

        document.getElementById('selection-modal-title').textContent = 'T√πy ch·ªânh hi·ªÉn th·ªã Hi·ªáu qu·∫£ khai th√°c';
        modal.dataset.settingType = 'efficiencyView';
        const searchInput = document.getElementById('selection-modal-search');
        if (searchInput) searchInput.value = '';
        
        uiComponents.toggleModal('selection-modal', true);
    },

    _showQdcSettingsModal(supermarketReport) {
        const modal = document.getElementById('selection-modal');
        if (!modal || !supermarketReport || !supermarketReport.qdc) return;

        const allItems = Object.values(supermarketReport.qdc).map(item => item.name).sort();
        const savedSettings = settingsService.loadQdcViewSettings(allItems);
        
        const listContainer = document.getElementById('selection-modal-list');
        listContainer.innerHTML = allItems.map(item => `
            <div class="selection-item">
                <input type="checkbox" id="select-item-lk-qdc-${item.replace(/[^a-zA-Z0-9]/g, '')}" value="${item}" ${savedSettings.includes(item) ? 'checked' : ''}>
                <label for="select-item-lk-qdc-${item.replace(/[^a-zA-Z0-9]/g, '')}">${item}</label>
            </div>
        `).join('');

        document.getElementById('selection-modal-title').textContent = 'T√πy ch·ªânh hi·ªÉn th·ªã Nh√≥m h√†ng QƒêC';
        modal.dataset.settingType = 'qdcView';
        const searchInput = document.getElementById('selection-modal-search');
        if (searchInput) searchInput.value = '';
        
        uiComponents.toggleModal('selection-modal', true);
    },

    _showCategorySettingsModal(supermarketReport) {
        const modal = document.getElementById('selection-modal');
        if (!modal || !supermarketReport || !supermarketReport.nganhHangChiTiet) return;

        const allItems = Object.keys(supermarketReport.nganhHangChiTiet).sort();
        const savedSettings = settingsService.loadCategoryViewSettings(allItems);
        
        const listContainer = document.getElementById('selection-modal-list');
        listContainer.innerHTML = allItems.map(item => `
            <div class="selection-item">
                <input type="checkbox" id="select-item-lk-cat-${item.replace(/[^a-zA-Z0-9]/g, '')}" value="${item}" ${savedSettings.includes(item) ? 'checked' : ''}>
                <label for="select-item-lk-cat-${item.replace(/[^a-zA-Z0-9]/g, '')}">${item}</label>
            </div>
        `).join('');

        document.getElementById('selection-modal-title').textContent = 'T√πy ch·ªânh hi·ªÉn th·ªã Ng√†nh h√†ng chi ti·∫øt';
        modal.dataset.settingType = 'categoryView';
        const searchInput = document.getElementById('selection-modal-search');
        if (searchInput) searchInput.value = '';
        
        uiComponents.toggleModal('selection-modal', true);
    },
    
    // === START: RESTORED FUNCTION FOR SKNV DETAIL VIEW ===
    renderLuykeEmployeeDetail(detailData, employeeData, detailContainerId) {
        const summaryContainer = document.getElementById('revenue-report-container-lk');
        const detailContainer = document.getElementById(detailContainerId);

        if (!summaryContainer || !detailContainer) return;

        summaryContainer.classList.add('hidden');
        detailContainer.classList.remove('hidden');
        
        if (!detailData || !employeeData) {
            detailContainer.innerHTML = `
                <div class="mb-4">
                     <button class="back-to-summary-btn text-blue-600 hover:underline font-semibold">‚Äπ Quay l·∫°i b·∫£ng t·ªïng h·ª£p</button>
                </div>
                <p class="text-red-500">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu chi ti·∫øt cho nh√¢n vi√™n ƒë√£ ch·ªçn.</p>
            `;
            return;
        }

        const { summary, topProductGroups, categoryChartData, byCustomer } = detailData;
        const { mucTieu } = employeeData;
        const conversionRateTarget = (mucTieu?.phanTramQD || 0) / 100;

        const renderKpiCards = () => {
             const conversionRateClass = summary.conversionRate >= conversionRateTarget ? 'is-positive' : 'is-negative';
            return `
            <div class="rt-infographic-summary mb-6">
                <div class="rt-infographic-summary-card"><div class="label">T·ªïng DT Th·ª±c</div><div class="value">${uiComponents.formatRevenue(summary.totalRealRevenue, 1)}</div></div>
                <div class="rt-infographic-summary-card"><div class="label">T·ªïng DTQƒê</div><div class="value">${uiComponents.formatRevenue(summary.totalConvertedRevenue, 1)}</div></div>
                <div class="rt-infographic-summary-card"><div class="label">T·ª∑ l·ªá Qƒê</div><div class="value ${conversionRateClass}">${uiComponents.formatPercentage(summary.conversionRate)}</div></div>
                <div class="rt-infographic-summary-card"><div class="label">DT Ch∆∞a Xu·∫•t</div><div class="value">${uiComponents.formatRevenue(summary.unexportedRevenue, 1)}</div></div>
                <div class="rt-infographic-summary-card"><div class="label">T·ªïng ƒê∆°n H√†ng</div><div class="value">${summary.totalOrders}</div></div>
                <div class="rt-infographic-summary-card"><div class="label">SL ƒê∆°n B√°n K√®m</div><div class="value">${summary.bundledOrderCount}</div></div>
            </div>
            `;
        };

        const renderTopGroupsAsProgressBars = () => {
            const top5Groups = topProductGroups.slice(0, 5);
            if (!top5Groups || top5Groups.length === 0) return '<p class="text-sm text-gray-500">Kh√¥ng c√≥ doanh thu.</p>';
            
            const maxRevenue = top5Groups[0]?.realRevenue || 0;
            
            return top5Groups.map(group => {
                const percentage = maxRevenue > 0 ? (group.realRevenue / maxRevenue) * 100 : 0;
                return `
                <div class="luyke-detail-progress-item">
                    <div class="luyke-detail-progress-label">
                         <span class="font-semibold">${group.name}</span>
                        <span class="text-xs">SL: ${uiComponents.formatNumber(group.quantity)} | %Qƒê: ${uiComponents.formatPercentage(group.conversionRate)}</span>
                    </div>
                    <div class="rt-progress-bar-container">
                        <div class="rt-progress-bar" style="width: ${percentage}%;"></div>
                     </div>
                    <div class="luyke-detail-progress-values">
                        <span>DT Th·ª±c: <strong>${uiComponents.formatRevenue(group.realRevenue)}</strong></span>
                        <span>DTQƒê: <strong>${uiComponents.formatRevenue(group.convertedRevenue)}</strong></span>
                    </div>
                 </div>
                `;
            }).join('');
        };

        const renderCustomerAccordion = () => {
            if (!byCustomer || byCustomer.length === 0) return '<p class="text-sm text-gray-500 mt-4">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o.</p>';
            
            return byCustomer.map((customer, index) => {
                const qdClass = customer.conversionRate >= conversionRateTarget ? 'qd-above-target' : 'qd-below-target';
            
                const productListHtml = customer.products.map(p => `
                    <tr class="border-b last:border-b-0">
                        <td class="py-1 pr-2">${p.productName}</td>
                        <td class="py-1 px-2 text-right">SL: <strong>${p.quantity}</strong></td>
                         <td class="py-1 px-2 text-right">DT: <strong>${uiComponents.formatRevenue(p.realRevenue, 1)}</strong></td>
                        <td class="py-1 pl-2 text-right">DTQƒê: <strong>${uiComponents.formatRevenue(p.convertedRevenue, 1)}</strong></td>
                    </tr>
                `).join('');
                
                const tableContent = `<table class="min-w-full text-xs product-list-table"><tbody>${productListHtml}</tbody></table>`;
                
                const detailContent = customer.products.length > 8
                    ? `<div class="product-list-scrollable">${tableContent}</div>`
                    : tableContent;

                return `
                 <details class="bg-white rounded-lg shadow-sm border border-gray-200 mb-2">
                    <summary>
                        <span class="customer-name-small">${index + 1}. ${customer.name}</span>
                        <div class="order-metrics">
                             <span>SL: <strong>${customer.totalQuantity}</strong></span>
                            <span>DT Th·ª±c: <strong class="text-gray-900">${uiComponents.formatRevenue(customer.totalRealRevenue, 1)} Tr</strong></span>
                            <span>DTQƒê: <strong class="text-blue-600">${uiComponents.formatRevenue(customer.totalConvertedRevenue, 1)} Tr</strong></span>
                            <span>%Qƒê: <strong class="${qdClass}">${uiComponents.formatPercentage(customer.conversionRate)}</strong></span>
                         </div>
                        <span class="accordion-arrow">‚ñº</span>
                    </summary>
                    <div class="border-t border-gray-200 p-3 bg-gray-50">
                        ${detailContent}
                     </div>
                </details>
                `;
            }).join('');
        };
        
        const headerHtml = `
            <div class="mb-4 flex justify-between items-center">
                <button class="back-to-summary-btn text-blue-600 hover:underline font-semibold">‚Äπ Quay l·∫°i b·∫£ng t·ªïng h·ª£p</button>
                <button id="capture-dtnv-lk-detail-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh chi ti·∫øt">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1v6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828-.828A2 2 0 0 1 3.172 4H2z"/><path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5zm0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7zM3 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z"/></svg>
                    <span>Ch·ª•p ·∫£nh</span>
                </button>
            </div>
            <div id="dtnv-lk-capture-area">
                <div class="p-4 mb-6 bg-white text-gray-800 rounded-lg shadow-lg border luyke-detail-header">
                    <h3>${employeeData.hoTen} - ${employeeData.maNV}</h3>
                </div>
                
                ${renderKpiCards()}

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    
                     <div class="bg-white p-4 rounded-lg shadow-md border">
                        <h4 class="text-md font-bold text-gray-700 border-b pb-2 mb-3">Top 5 Nh√≥m H√†ng Doanh Thu Cao</h4>
                        <div class="space-y-3">
                            ${renderTopGroupsAsProgressBars()}
                         </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow-md border">
                        <h4 class="text-md font-bold text-gray-700 mb-2">T·ª∑ Tr·ªçng Doanh Thu Ng√†nh H√†ng</h4>
                         <div class="luyke-detail-chart-container">
                            <canvas id="luyke-employee-chart"></canvas>
                        </div>
                    </div>
                </div>
                 <div class="customer-accordion-luyke">
                    <h4 class="text-lg font-bold text-gray-800 mb-3">Chi Ti·∫øt Theo Kh√°ch H√†ng</h4>
                    ${renderCustomerAccordion()}
                </div>
            </div>`;

        detailContainer.innerHTML = headerHtml;

        const ctx = document.getElementById('luyke-employee-chart')?.getContext('2d');
        if (ctx && categoryChartData && categoryChartData.length > 0) {
            if (appState.charts['luyke-employee-chart']) {
                 appState.charts['luyke-employee-chart'].destroy();
            }
            const sortedChartData = [...categoryChartData].sort((a,b) => b.revenue - a.revenue);
            const topData = sortedChartData.slice(0, 10);
            
            appState.charts['luyke-employee-chart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topData.map(d => d.name),
                     datasets: [{
                        label: 'Doanh thu',
                        data: topData.map(d => d.revenue / 1000000),
                        backgroundColor: '#3b82f6',
                        borderRadius: 4,
                     }]
                },
                options: {
                    indexAxis: 'x',
                    responsive: true,
                    maintainAspectRatio: false,
                     plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                 label: context => `${context.label}: ${uiComponents.formatRevenue(context.raw * 1000000)} Tr`
                            }
                        },
                        datalabels: {
                             anchor: 'end',
                            align: 'end',
                            formatter: (value) => uiComponents.formatRevenue(value * 1000000),
                            color: '#4b5563',
                             font: { weight: 'bold', size: 10 }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                     }
                },
                plugins: [ChartDataLabels]
            });
        }
    },
    // === END: RESTORED FUNCTION ===

    renderCompetitionSummaryCounter: (data) => {
        const summary = {
            total: data.length,
            dat: data.filter(d => d.hoanThanhValue >= 100).length,
            doanhThuCount: data.filter(d => d.type === 'doanhThu').length,
            soLuongCount: data.filter(d => d.type === 'soLuong').length,
        };
        
        const totalHtml = `<strong class="text-blue-600">${summary.total}</strong>`;
        const datHtml = `<strong class="text-blue-600">${summary.dat}</strong>`;
        const chuaDatHtml = `<strong class="text-red-600">${summary.total - summary.dat}</strong>`;
        const dtHtml = `<strong class="text-blue-600">${summary.doanhThuCount}</strong>`;
        const slHtml = `<strong class="text-blue-600">${summary.soLuongCount}</strong>`;

        return `(<span class="font-normal text-gray-500">T·ªïng:</span> ${totalHtml}, 
                <span class="font-normal text-gray-500">ƒê·∫°t:</span> ${datHtml}, 
                <span class="font-normal text-gray-500">Ch∆∞a ƒë·∫°t:</span> ${chuaDatHtml}, 
                <span class="font-normal text-gray-500">DT:</span> ${dtHtml}, 
                <span class="font-normal text-gray-500">SL:</span> ${slHtml})`;
    },
    
    displayHealthKpiTable: (pastedData, goals) => {
        const { mainKpis, comparisonData, dtDuKien, dtqdDuKien, luotKhachData } = pastedData;
        
        const competitionSummary = { dat: 0, total: 0 };
        if (appState.competitionData && appState.competitionData.length > 0) {
            competitionSummary.total = appState.competitionData.length;
            competitionSummary.dat = appState.competitionData.filter(d => (parseFloat(String(d.hoanThanh).replace('%','')) || 0) >= 100).length;
        }

        if (!mainKpis || Object.keys(mainKpis).length === 0) {
            const supermarketReport = services.aggregateReport(appState.masterReportData.luyke);
            const cardData = {
                dtThucLK: supermarketReport.doanhThu,
                dtQdLK: supermarketReport.doanhThuQuyDoi,
                phanTramQd: supermarketReport.doanhThu > 0 ? (supermarketReport.doanhThuQuyDoi / supermarketReport.doanhThu) - 1 : 0,
                dtGop: supermarketReport.doanhThuTraGop,
                phanTramGop: supermarketReport.doanhThu > 0 ? supermarketReport.doanhThuTraGop / supermarketReport.doanhThu : 0,
                dtThucDuKien: 0,
                dtQdDuKien: 0,
                phanTramTargetQd: 0,
                phanTramTargetThuc: 0,
            };
            uiLuyke.renderLuykeKpiCards(cardData, comparisonData, luotKhachData, appState.masterReportData.luyke, goals, competitionSummary);
            return;
        }
        
        const cleanValue = (str) => (typeof str === 'string' ? parseFloat(str.replace(/,|%/g, '')) : (typeof str === 'number' ? str : 0));
        
        const dtThucLK = cleanValue(mainKpis['Th·ª±c hi·ªán DT th·ª±c']) * 1000000;
        const dtQdLK = cleanValue(mainKpis['Th·ª±c hi·ªán DTQƒê']) * 1000000;
        const phanTramGopRaw = cleanValue(mainKpis['T·ª∑ Tr·ªçng Tr·∫£ G√≥p']);
        const dtGop = dtThucLK * (phanTramGopRaw / 100);
        const phanTramQd = dtThucLK > 0 ? (dtQdLK / dtThucLK) - 1 : 0;
        const phanTramGop = dtThucLK > 0 ? dtGop / dtThucLK : 0;
        
        const targetThuc = (parseFloat(goals.doanhThuThuc) || 0) * 1000000;
        const phanTramTargetThuc = targetThuc > 0 ? (dtDuKien * 1000000) / targetThuc : 0;
        const phanTramTargetQd = (cleanValue(mainKpis['% HT Target D·ª± Ki·∫øn (Qƒê)']) || 0) / 100;

        const luykeCardData = { 
            dtThucLK, dtQdLK, dtGop, phanTramQd, phanTramGop, 
            phanTramTargetThuc, phanTramTargetQd,
            dtThucDuKien: dtDuKien * 1000000,
             dtQdDuKien: dtqdDuKien * 1000000,
        };
        
        uiLuyke.renderLuykeKpiCards(luykeCardData, comparisonData, luotKhachData, appState.masterReportData.luyke, goals, competitionSummary);
    },

    displayCompetitionResultsFromLuyKe: (text, viewType = 'summary') => {
        const container = document.getElementById('luyke-competition-infographic-container');
        if (!container) return;

        if (!text || !text.trim()) {
            container.innerHTML = '<p class="text-gray-500 font-bold col-span-2">Vui l√≤ng d√°n "Data l≈©y k·∫ø" ·ªü tab Data ƒë·ªÉ xem chi ti·∫øt.</p>';
            return;
        }

        appState.competitionData = services.parseCompetitionDataFromLuyKe(text);
        
        const data = appState.competitionData.map(item => {
            const hoanThanhValue = (parseFloat(String(item.hoanThanh).replace('%', '')) || 0);
            return { ...item, hoanThanhValue: hoanThanhValue };
        });

        if (data.length === 0) {
            container.innerHTML = '<p class="text-yellow-600 font-bold col-span-2">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu thi ƒëua trong vƒÉn b·∫£n ƒë√£ d√°n.</p>';
            return;
        }
        
        const summaryEl = document.getElementById('luyke-competition-summary');
        if (summaryEl) {
             summaryEl.innerHTML = uiLuyke.renderCompetitionSummaryCounter(data);
        }
        
        container.innerHTML = uiLuyke.renderLuykeCompetitionInfographic(data, viewType);
    },
    
    renderLuykeCompetitionInfographic(data, viewType) {
        
        const sortData = (items) => {
            return [...items].sort((a, b) => b.hoanThanhValue - a.hoanThanhValue);
        };

        const renderRow = (items, title, titleClass) => {
            if (items.length === 0) return '';
    
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const daysRemaining = Math.max(daysInMonth - today.getDate(), 1);
            
            const sortedItems = sortData(items);

            const achievedCount = items.filter(item => item.hoanThanhValue >= 100).length;
            const unachievedCount = items.length - achievedCount;
            
            const achievedHtml = `<strong class="text-blue-600">${achievedCount}</strong>`;
            const unachievedHtml = `<strong class="text-red-600">${unachievedCount}</strong>`;
            const counterText = `<span class="text-sm font-normal text-gray-700">(ƒê·∫°t: ${achievedHtml} / C·∫ßn n·ªó l·ª±c: ${unachievedHtml})</span>`;
    
            const itemsHtml = sortedItems.map(item => {
                const hoanThanhValue = item.hoanThanhValue;
                
                let dailyTarget = 0;
                const targetRemaining = item.target - item.luyKe;
                
                if (item.target > 0 && targetRemaining > 0 && daysRemaining > 0) {
                     dailyTarget = targetRemaining / daysRemaining;
                }
                
                const targetClass = dailyTarget > 0 ? 'text-red-600' : 'text-green-600';
    
                return `
                    <div class="tdv-item-card">
                         <p class="tdv-item-card__title">${item.name}</p>
                        <div class="tdv-progress-bar-container">
                            <div class="tdv-progress-bar ${hoanThanhValue >= 100 ? 'tdv-progress-bar--blue' : 'tdv-progress-bar--yellow'}" style="width: ${Math.min(hoanThanhValue, 100)}%;"></div>
                             <span class="tdv-progress-bar__text">${uiComponents.formatPercentage(hoanThanhValue / 100)}</span>
                        </div>
                        <div class="tdv-item-card__details">
                            <span>L≈©y k·∫ø: <strong>${uiComponents.formatNumberOrDash(item.luyKe)}</strong></span>
                            <span>Target: <strong>${uiComponents.formatNumberOrDash(item.target)}</strong></span>
                             <span class="font-bold ${targetClass}">M·ª•c ti√™u/ng√†y: <strong>${uiComponents.formatNumberOrDash(dailyTarget)}</strong></span>
                        </div>
                    </div>
                `;
            }).join('');
    
            return `
                <div class="tdv-row" data-capture-group="comp-row-${title.replace(/\s/g, '-')}" data-capture-columns="2">
                     <h3 class="tdv-row-title ${titleClass}">${title} ${counterText}</h3>
                    <div class="tdv-row-body grid grid-cols-2 gap-4">${itemsHtml}</div>
                </div>
            `;
        };
    
        if (viewType === 'summary') {
            const dataDoanhThu = data.filter(d => d.type === 'doanhThu');
            const dataSoLuong = data.filter(d => d.type === 'soLuong');
            return `
                <div class="tdv-rows-container space-y-6">
                    ${renderRow(dataDoanhThu, 'Thi ƒêua Doanh Thu', 'tdv-row-title--prize')}
                    ${renderRow(dataSoLuong, 'Thi ƒêua S·ªë L∆∞·ª£ng', 'tdv-row-title--soon-prize')}
                </div>
            `;
        } else {
             const completed = data.filter(d => d.hoanThanhValue >= 100);
            const pending = data.filter(d => d.hoanThanhValue < 100);
            return `
                <div class="tdv-rows-container space-y-6">
                    ${renderRow(completed, 'C√°c Ch∆∞∆°ng Tr√¨nh ƒê√£ ƒê·∫°t M·ª•c Ti√™u', 'tdv-row-title--prize')}
                    ${renderRow(pending, 'C√°c Ch∆∞∆°ng Tr√¨nh C·∫ßn N·ªó L·ª±c Th√™m', 'tdv-row-title--effort')}
                </div>
             `;
        }
    },
    
    renderChuaXuatTable: (reportData) => {
        const container = document.getElementById('luyke-unexported-revenue-content');
        if (!container) return;
        if (!reportData || reportData.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center font-bold">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ch∆∞a xu·∫•t.</p>';
            return;
        }

        const sortState = appState.sortState.luyke_chuaxuat || { key: 'doanhThuQuyDoi', direction: 'desc' };
        const { key, direction } = sortState;
        const sortedData = [...reportData].sort((a, b) => {
             const valA = a[key] || 0; const valB = b[key] || 0;
            return direction === 'asc' ? valA - valB : valB - valA;
        });

        const totals = reportData.reduce((acc, item) => {
            acc.soLuong += item.soLuong;
            acc.doanhThuThuc += item.doanhThuThuc;
            acc.doanhThuQuyDoi += item.doanhThuQuyDoi;
            return acc;
        }, { soLuong: 0, doanhThuThuc: 0, doanhThuQuyDoi: 0 });

        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;
        
        container.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full text-sm table-bordered table-striped" data-table-type="luyke_chuaxuat">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold"><tr>
                <th class="${headerClass('nganhHang')}" data-sort="nganhHang">Ng√†nh h√†ng</th>
                <th class="${headerClass('soLuong')} text-right" data-sort="soLuong">S·ªë l∆∞·ª£ng</th>
                <th class="${headerClass('doanhThuThuc')} text-right" data-sort="doanhThuThuc">Doanh thu th·ª±c</th>
                 <th class="${headerClass('doanhThuQuyDoi')} text-right" data-sort="doanhThuQuyDoi">Doanh thu Qƒê</th></tr>
            </thead>
            <tbody>${sortedData.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-semibold">${item.nganhHang}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumber(item.soLuong)}</td>
                     <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.doanhThuThuc)}</td>
                    <td class="px-4 py-2 text-right font-bold text-blue-600">${uiComponents.formatRevenue(item.doanhThuQuyDoi)}</td>
                </tr>`).join('')}
            </tbody>
            <tfoot class="table-footer font-bold"><tr>
                <td class="px-4 py-2">T·ªïng</td>
                 <td class="px-4 py-2 text-right">${uiComponents.formatNumber(totals.soLuong)}</td>
                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.doanhThuThuc)}</td>
                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.doanhThuQuyDoi)}</td>
            </tr></tfoot></table></div>`;
    },

    renderLuykeKpiCards: (luykeData, comparisonData, luotKhachData, masterReportDataLuyke, goals, competitionSummary) => {
        const { dtThucLK, dtQdLK, dtGop, phanTramQd, phanTramGop, phanTramTargetThuc, phanTramTargetQd, dtThucDuKien, dtQdDuKien } = luykeData;

        document.getElementById('luyke-kpi-dt-thuc-main').textContent = uiComponents.formatNumber((dtThucLK || 0) / 1000000, 0);
        document.getElementById('luyke-kpi-dt-thuc-sub1').innerHTML = `DK: <span class="font-bold">${uiComponents.formatNumber((dtThucDuKien || 0) / 1000000, 0)}</span> / Target: <span class="font-bold">${uiComponents.formatNumber(goals?.doanhThuThuc || 0)}</span>`;

        document.getElementById('luyke-kpi-dt-qd-main').textContent = uiComponents.formatNumber((dtQdLK || 0) / 1000000, 0);
        document.getElementById('luyke-kpi-dt-qd-sub1').innerHTML = `DK: <span class="font-bold">${uiComponents.formatNumber((dtQdDuKien || 0) / 1000000, 0)}</span> / Target: <span class="font-bold">${uiComponents.formatNumber(goals?.doanhThuQD || 0)}</span>`;
        
        document.getElementById('luyke-kpi-ht-target-qd-main').textContent = uiComponents.formatPercentage(phanTramTargetQd || 0);
        document.getElementById('luyke-kpi-ht-target-thuc-sub').innerHTML = `DT Th·ª±c: <span class="font-bold">${uiComponents.formatPercentage(phanTramTargetThuc || 0)}</span>`;

        document.getElementById('luyke-kpi-tl-qd-main').textContent = uiComponents.formatPercentage(phanTramQd || 0);
        document.getElementById('luyke-kpi-tl-qd-sub').innerHTML = `M·ª•c ti√™u: <span class="font-bold">${uiComponents.formatNumber(goals?.phanTramQD || 0)}%</span>`;
        document.getElementById('luyke-kpi-dt-tc-main').textContent = uiComponents.formatNumber((dtGop || 0) / 1000000, 0);
        document.getElementById('luyke-kpi-dt-tc-sub').innerHTML = `% th·ª±c tr·∫£ ch·∫≠m: <span class="font-bold">${uiComponents.formatPercentage(phanTramGop || 0)}</span>`;
        
        const chuaXuatQuyDoi = masterReportDataLuyke.reduce((sum, item) => sum + (item.doanhThuQuyDoiChuaXuat || 0), 0);
        document.getElementById('luyke-kpi-dtqd-chua-xuat-main').textContent = uiComponents.formatNumber(chuaXuatQuyDoi / 1000000, 0);
        
        const tyLeThiDuaDat = competitionSummary.total > 0 ? competitionSummary.dat / competitionSummary.total : 0;
        document.getElementById('luyke-kpi-thidua-main').textContent = uiComponents.formatPercentage(tyLeThiDuaDat);
        document.getElementById('luyke-kpi-thidua-sub').innerHTML = `<span class="font-bold">${competitionSummary.dat}/${competitionSummary.total}</span> Ng√†nh`;

        const formatComparisonPercentage = (percentageString) => {
            if (!percentageString || typeof percentageString !== 'string') return 'N/A';
            const numericValue = parseFloat(percentageString.replace('%', ''));
            if (isNaN(numericValue)) return 'N/A';
            return Math.round(numericValue) + '%';
        };
        const formattedDtPercentage = formatComparisonPercentage(comparisonData.percentage);
        const formattedLkPercentage = formatComparisonPercentage(luotKhachData.percentage);

        document.getElementById('luyke-kpi-dtck-main').textContent = formattedDtPercentage;
        document.getElementById('luyke-kpi-dtck-sub').innerHTML = `Doanh thu: <span class="font-bold">${uiComponents.formatNumber(comparisonData.value || 0)} | ${formattedDtPercentage}</span>`;
        document.getElementById('luyke-kpi-lkck-sub').innerHTML = `L∆∞·ª£t kh√°ch: <span class="font-bold">${uiComponents.formatNumber(luotKhachData.value || 0)} | ${formattedLkPercentage}</span>`;
    },

    renderLuykeCategoryDetailsTable: (data, numDays) => {
        const container = document.getElementById('luyke-category-details-content');
        const cardHeader = container.previousElementSibling;
        if (!container || !cardHeader || !data || !data.nganhHangChiTiet) { container.innerHTML = '<p class="text-gray-500 font-bold">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>'; return; }
        
        const allItems = Object.keys(data.nganhHangChiTiet).sort();
        const visibleItems = settingsService.loadCategoryViewSettings(allItems);
        
        if (Object.keys(data.nganhHangChiTiet).length === 0) {
            container.innerHTML = '<p class="text-gray-500 font-bold">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>'; return;
        }

        const sortState = appState.sortState.luyke_nganhhang || { key: 'revenue', direction: 'desc' };
        const { key, direction } = sortState;
        const sortedData = Object.entries(data.nganhHangChiTiet)
            .map(([name, values]) => ({ name, ...values }))
            .filter(item => visibleItems.includes(item.name)) 
            .sort((a, b) => direction === 'asc' ? a[key] - b[key] : b[key] - a[key]);

        const totals = sortedData.reduce((acc, item) => {
            acc.quantity += item.quantity;
            acc.revenue += item.revenue;
            return acc;
        }, { quantity: 0, revenue: 0 });

        if (!cardHeader.querySelector('.settings-trigger-btn')) {
            cardHeader.classList.add('flex', 'items-center', 'justify-between');
            cardHeader.innerHTML = `<span>NG√ÄNH H√ÄNG CHI TI·∫æT</span>` + uiComponents.renderSettingsButton('lk-cat');
            setTimeout(() => {
                document.getElementById('settings-btn-lk-cat').addEventListener('click', () => {
                    uiLuyke._showCategorySettingsModal(data);
                });
            }, 0);
        }

        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;
        container.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full text-sm table-bordered table-striped" data-table-type="luyke_nganhhang">
             <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold"><tr>
                <th class="${headerClass('name')}" data-sort="name">Ng√†nh h√†ng</th>
                <th class="${headerClass('quantity')} text-right" data-sort="quantity">S·ªë l∆∞·ª£ng</th>
                <th class="${headerClass('revenue')} text-right" data-sort="revenue">Doanh thu</th>
                <th class="${headerClass('avgQuantity')} text-right" data-sort="avgQuantity">SL TB/ng√†y</th>
                <th class="${headerClass('avgPrice')} text-right" data-sort="avgPrice">ƒê∆°n gi√° TB</th></tr>
             </thead>
            <tbody>${sortedData.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-semibold">${item.name}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumber(item.quantity)}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.revenue)}</td>
                     <td class="px-4 py-2 text-right font-bold text-blue-600">${uiComponents.formatNumberOrDash(item.quantity / numDays, 1)}</td>
                    <td class="px-4 py-2 text-right font-bold text-green-600">${uiComponents.formatRevenue(item.donGia)}</td>
                </tr>`).join('')}
            </tbody>
            <tfoot class="table-footer font-bold"><tr>
                <td class="px-4 py-2">T·ªïng</td>
                 <td class="px-4 py-2 text-right">${uiComponents.formatNumber(totals.quantity)}</td>
                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.revenue)}</td>
                <td colspan="2"></td>
            </tr></tfoot></table></div>`;
    },

    renderLuykeQdcTable: (data, numDays) => {
        const container = document.getElementById('luyke-qdc-content');
        const cardHeader = container.previousElementSibling;
        if (!container || !cardHeader || !data || !data.qdc) { container.innerHTML = `<p class="text-gray-500 font-bold">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>`; return; }
        
        const qdcData = Object.entries(data.qdc).map(([key, value]) => ({ id: key, ...value }));
        const allItems = qdcData.map(item => item.name);
        const visibleItems = settingsService.loadQdcViewSettings(allItems);

        const sortState = appState.sortState.luyke_qdc || { key: 'dtqd', direction: 'desc' };
        const { key, direction } = sortState;
        const sortedData = [...qdcData]
            .filter(item => visibleItems.includes(item.name))
            .sort((a,b) => direction === 'asc' ? a[key] - b[key] : b[key] - a[key]);
        
        if (!cardHeader.querySelector('.settings-trigger-btn')) {
             cardHeader.classList.add('flex', 'items-center', 'justify-between');
            cardHeader.innerHTML = `<span>NH√ìM H√ÄNG QUY ƒê·ªîI CAO</span>` + uiComponents.renderSettingsButton('lk-qdc');
            setTimeout(() => {
                 document.getElementById('settings-btn-lk-qdc').addEventListener('click', () => {
                    uiLuyke._showQdcSettingsModal(data);
                });
            }, 0);
        }

        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;

        container.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full text-sm table-bordered table-striped" data-table-type="luyke_qdc">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold"><tr>
                <th class="${headerClass('name')}" data-sort="name">Nh√≥m h√†ng</th>
                <th class="${headerClass('sl')} text-right" data-sort="sl">SL</th>
                <th class="${headerClass('dtqd')} text-right" data-sort="dtqd">DTQƒê</th>
                <th class="${headerClass('avgSl')} text-right" data-sort="avgSl">SL TB/Ng√†y</th></tr>
            </thead>
            <tbody>${sortedData.map(item => `
                 <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-semibold">${item.name}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumber(item.sl)}</td>
                    <td class="px-4 py-2 text-right font-bold text-blue-600">${uiComponents.formatRevenue(item.dtqd)}</td>
                    <td class="px-4 py-2 text-right font-bold text-green-600">${uiComponents.formatNumber(item.sl / numDays, 1)}</td></tr>`
                 ).join('')}
            </tbody></table></div>`;
    },
    
    renderLuykeEfficiencyTable: (data, goals) => {
        const container = document.getElementById('luyke-efficiency-content');
        const cardHeader = container.previousElementSibling;

        if (!container || !cardHeader || !data || !goals) { 
            if(container) container.innerHTML = `<p class="text-gray-500 font-bold">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>`; 
            return; 
        }
        
        const allItemsConfig = settingsService.loadEfficiencyViewSettings();
        
        const goalKeyMap = {
            pctPhuKien: 'phanTramPhuKien',
            pctGiaDung: 'phanTramGiaDung',
            pctMLN: 'phanTramMLN',
            pctSim: 'phanTramSim',
            pctVAS: 'phanTramVAS',
            pctBaoHiem: 'phanTramBaoHiem'
        };

        const allItems = allItemsConfig
            .filter(item => item.id.startsWith('pct'))
            .map(config => ({
                 ...config,
                value: data[config.id],
                target: goals[goalKeyMap[config.id]]
            }));
        
        const createRow = (label, value, target) => {
            const isBelow = value < ((target || 0) / 100); 
            
            return `<tr class="border-t">
                <td class="px-4 py-2 font-semibold text-gray-800">${label}</td>
                 <td class="px-4 py-2 text-right font-bold text-lg ${isBelow ? 'cell-performance is-below' : 'text-green-600'}">${uiComponents.formatPercentage(value || 0)}</td>
                <td class="px-4 py-2 text-right text-gray-600">${target || 0}%</td>
            </tr>`;
        };
        
        if (!cardHeader.querySelector('.settings-trigger-btn')) {
            cardHeader.classList.add('flex', 'items-center', 'justify-between');
            cardHeader.innerHTML = `<span>HI·ªÜU QU·∫¢ KHAI TH√ÅC SI√äU TH·ªä</span>` + uiComponents.renderSettingsButton('lk-eff');
            
            setTimeout(() => {
                document.getElementById('settings-btn-lk-eff').addEventListener('click', () => {
                     uiLuyke._showEfficiencySettingsModal();
                });
            }, 0);
        }
        
        container.innerHTML = `
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm table-bordered">
                    <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
                        <tr>
                             <th class="px-4 py-3 text-left">Ch·ªâ s·ªë</th>
                            <th class="px-4 py-3 text-right">Th·ª±c hi·ªán</th>
                             <th class="px-4 py-3 text-right">M·ª•c ti√™u</th>
                        </tr>
                     </thead>
                    <tbody>
                        ${allItems
                             .filter(item => item.visible) // L·ªçc theo c√†i ƒë·∫∑t hi·ªÉn th·ªã
                            .map(item => createRow(item.label, item.value, item.target))
                            .join('')}
                    </tbody>
                </table>
             </div>`;
    },

    updateLuykeSupermarketTitle: (warehouse, date) => {
        const titleEl = document.getElementById('luyke-supermarket-title');
        if (titleEl) titleEl.textContent = `B√°o c√°o l≈©y k·∫ø ${warehouse ? 'kho ' + warehouse : 'to√†n b·ªô'} - T√≠nh ƒë·∫øn ${date.toLocaleDateString('vi-VN')}`;
    },
};
--- END FILE: ./ui-luyke.js ---

--- START FILE: ./ui-realtime.js ---
// Version 4.0 - Major Refactor: Merge tab-realtime logic and fix all TypeErrors
// MODULE: UI REALTIME
// Ch·ª©a TO√ÄN B·ªò logic v√† h√†m render giao di·ªán cho tab "Doanh thu Realtime".

import { appState } from './state.js';
import { ui } from './ui.js';
import { services } from './services.js';
import { settingsService } from './modules/settings.service.js';
import { highlightService } from './modules/highlight.service.js';
import { dragDroplisteners } from './event-listeners/listeners-dragdrop.js';
import { uiComponents } from './ui-components.js';

export const uiRealtime = {
    render() {
        console.log("[CH·∫®N ƒêO√ÅN] B·∫Øt ƒë·∫ßu render() trong 'ui-realtime.js' (ƒë√£ g·ªôp).");

        if (appState.danhSachNhanVien.length === 0) {
            ui.togglePlaceholder('realtime-section', true);
            return;
        }
        ui.togglePlaceholder('realtime-section', false);

        const selectedWarehouse = document.getElementById('realtime-filter-warehouse').value;
        this.updateRealtimeSupermarketTitle(selectedWarehouse, new Date());
        
        const activeSubTabBtn = document.querySelector('#realtime-subtabs-nav .sub-tab-btn.active');
        const activeSubTabId = activeSubTabBtn ? activeSubTabBtn.dataset.target : 'subtab-realtime-sieu-thi';

        if (appState.realtimeYCXData.length === 0) {
             this.renderRealtimeKpiCards({}, { goals: {}, timing: {} });
             document.getElementById('realtime-category-details-content').innerHTML = '<p class="text-gray-500 font-bold">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p>';
             document.getElementById('realtime-efficiency-content').innerHTML = '<p class="text-gray-500 font-bold">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p>';
             document.getElementById('realtime-qdc-content').innerHTML = '<p class="text-gray-500 font-bold">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p>';
             document.getElementById('realtime-unexported-revenue-content').innerHTML = '<p class="text-gray-500 font-bold">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p>';
             document.getElementById('realtime-revenue-report-container').innerHTML = '';
             document.getElementById('realtime-employee-detail-container').innerHTML = '';
             document.getElementById('realtime-brand-report-container').innerHTML = '<p class="text-gray-500">Vui l√≤ng t·∫£i file realtime v√† ch·ªçn b·ªô l·ªçc ƒë·ªÉ xem d·ªØ li·ªáu.</p>';
             document.getElementById('competition-report-container-rt').innerHTML = '<p class="text-gray-500">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p>';
             return;
        };

        const selectedDept = document.getElementById('realtime-filter-department').value;
        const selectedEmployees = appState.choices.realtime_employee ? appState.choices.realtime_employee.getValue(true) : [];
        
        const settings = settingsService.getRealtimeGoalSettings(selectedWarehouse);
        
        appState.masterReportData.realtime = services.generateMasterReportData(appState.realtimeYCXData, settings.goals, true);
        
        let filteredReport = appState.masterReportData.realtime;
        if (selectedWarehouse) filteredReport = filteredReport.filter(nv => nv.maKho == selectedWarehouse);
        if (selectedDept) filteredReport = filteredReport.filter(nv => nv.boPhan === selectedDept);
        if (selectedEmployees && selectedEmployees.length > 0) filteredReport = filteredReport.filter(nv => selectedEmployees.includes(String(nv.maNV)));

        const visibleEmployees = new Set(filteredReport.map(nv => String(nv.maNV)));
        const filteredRealtimeYCX = appState.realtimeYCXData.filter(row => {
            const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
            return msnvMatch && visibleEmployees.has(msnvMatch[1].trim());
        });
        
        const detailInfo = appState.viewingDetailFor;
        const isViewingDetail = detailInfo && detailInfo.sourceTab === 'dtnv-rt';
        
        if (activeSubTabId === 'subtab-realtime-nhan-vien') {
            if (isViewingDetail) {
                this.handleEmployeeDetailChange(detailInfo.employeeId);
            } else {
                ui.displayEmployeeRevenueReport(filteredReport, 'realtime-revenue-report-container', 'realtime_dt_nhanvien');
                this.handleEmployeeDetailChange(null); 
            }
        }

        const supermarketReport = services.aggregateReport(filteredReport, selectedWarehouse);
        this.renderRealtimeKpiCards(supermarketReport, settings);
        this.renderRealtimeCategoryDetailsTable(supermarketReport);
        this.renderRealtimeEfficiencyTable(supermarketReport, settings.goals);
        this.renderRealtimeQdcTable(supermarketReport);
        const realtimeChuaXuatReport = services.generateRealtimeChuaXuatReport(filteredRealtimeYCX);
        this.renderRealtimeChuaXuatTable(realtimeChuaXuatReport);
        ui.displayEmployeeEfficiencyReport(filteredReport, 'realtime-efficiency-report-container', 'realtime_hieuqua_nhanvien');
        ui.displayCategoryRevenueReport(filteredReport, 'realtime-category-revenue-report-container', 'realtime');
        this.handleBrandFilterChange();
        
        const competitionReportData = services.calculateCompetitionFocusReport(
            appState.realtimeYCXData,
            appState.competitionConfigs
        );
        ui.renderCompetitionUI('competition-report-container-rt', competitionReportData);
        
        highlightService.populateHighlightFilters('realtime', filteredRealtimeYCX, filteredReport);
        highlightService.applyHighlights('realtime');
        
        if (!isViewingDetail) {
            const efficiencyReportContainer = document.getElementById('realtime-efficiency-report-container');
            if (efficiencyReportContainer) {
                dragDroplisteners.initializeForContainer('realtime-efficiency-report-container');
            }
         }
    },

    handleEmployeeDetailChange(employeeId) {
        const revenueContainer = document.getElementById('realtime-revenue-report-container');
        const detailContainer = document.getElementById('realtime-employee-detail-container');
        
        if (!revenueContainer || !detailContainer) return;
        
        if (!employeeId) {
            revenueContainer.classList.remove('hidden');
            detailContainer.classList.add('hidden');
            detailContainer.innerHTML = '';
            return;
        }

        revenueContainer.classList.add('hidden');
        detailContainer.classList.remove('hidden');

        const employeeInfo = appState.employeeMaNVMap.get(String(employeeId));
        const employeeName = employeeInfo ? ui.getShortEmployeeName(employeeInfo.hoTen, employeeInfo.maNV) : `NV ${employeeId}`;
        const detailData = services.generateRealtimeEmployeeDetailReport(employeeId, appState.realtimeYCXData);
        
        this.renderRealtimeEmployeeDetail(detailData, employeeName);
    },

    handleBrandFilterChange() {
        const categoryFilter = document.getElementById('realtime-brand-category-filter');
        const brandFilter = document.getElementById('realtime-brand-filter');
        const activeDthangViewBtn = document.querySelector('#dthang-realtime-view-selector .view-switcher__btn.active');
        const dthangViewType = activeDthangViewBtn ? activeDthangViewBtn.dataset.view : 'brand';

        if (!categoryFilter || !brandFilter) return;

        const selectedCategory = categoryFilter.value;
        
        ui.updateBrandFilterOptions(selectedCategory);

        const selectedBrand = brandFilter.value;
        const reportData = services.generateRealtimeBrandReport(appState.realtimeYCXData, selectedCategory, selectedBrand);
        this.renderRealtimeBrandReport(reportData, dthangViewType);
    },

    updateRealtimeSupermarketTitle: (warehouse, dateTime) => {
        const titleEl = document.getElementById('realtime-supermarket-title');
        if(titleEl) titleEl.textContent = `B√°o c√°o Realtime ${warehouse ? 'kho ' + warehouse : 'to√†n b·ªô'} - ${dateTime.toLocaleTimeString('vi-VN')} ${dateTime.toLocaleDateString('vi-VN')}`;
    },

    _showEfficiencySettingsModal() {
        const modal = document.getElementById('selection-modal');
        if (!modal) return;

        const allItemsConfig = settingsService.loadEfficiencyViewSettings();
        
        const listContainer = document.getElementById('selection-modal-list');
        listContainer.innerHTML = allItemsConfig.map(item => `
            <div class="selection-item">
                <input type="checkbox" id="select-item-rt-eff-${item.id}" value="${item.id}" ${item.visible ? 'checked' : ''}>
                <label for="select-item-rt-eff-${item.id}">${item.label}</label>
            </div>
        `).join('');

        document.getElementById('selection-modal-title').textContent = 'T√πy ch·ªânh hi·ªÉn th·ªã Hi·ªáu qu·∫£ khai th√°c';
        modal.dataset.settingType = 'efficiencyView';
        const searchInput = document.getElementById('selection-modal-search');
        if (searchInput) searchInput.value = '';
        
        uiComponents.toggleModal('selection-modal', true);
    },

    _showQdcSettingsModal(supermarketReport) {
        const modal = document.getElementById('selection-modal');
        if (!modal || !supermarketReport || !supermarketReport.qdc) return;

        const allItems = Object.values(supermarketReport.qdc).map(item => item.name).sort();
        const savedSettings = settingsService.loadQdcViewSettings(allItems);
        
        const listContainer = document.getElementById('selection-modal-list');
        listContainer.innerHTML = allItems.map(item => `
            <div class="selection-item">
                <input type="checkbox" id="select-item-rt-qdc-${item.replace(/[^a-zA-Z0-9]/g, '')}" value="${item}" ${savedSettings.includes(item) ? 'checked' : ''}>
                <label for="select-item-rt-qdc-${item.replace(/[^a-zA-Z0-9]/g, '')}">${item}</label>
            </div>
        `).join('');

        document.getElementById('selection-modal-title').textContent = 'T√πy ch·ªânh hi·ªÉn th·ªã Nh√≥m h√†ng QƒêC';
        modal.dataset.settingType = 'qdcView';
        const searchInput = document.getElementById('selection-modal-search');
        if (searchInput) searchInput.value = '';
        
        uiComponents.toggleModal('selection-modal', true);
    },

    _showCategorySettingsModal(supermarketReport) {
        const modal = document.getElementById('selection-modal');
        if (!modal || !supermarketReport || !supermarketReport.nganhHangChiTiet) return;

        const allItems = Object.keys(supermarketReport.nganhHangChiTiet).sort();
        const savedSettings = settingsService.loadCategoryViewSettings(allItems);
        
        const listContainer = document.getElementById('selection-modal-list');
        listContainer.innerHTML = allItems.map(item => `
            <div class="selection-item">
                <input type="checkbox" id="select-item-rt-cat-${item.replace(/[^a-zA-Z0-9]/g, '')}" value="${item}" ${savedSettings.includes(item) ? 'checked' : ''}>
                <label for="select-item-rt-cat-${item.replace(/[^a-zA-Z0-9]/g, '')}">${item}</label>
            </div>
        `).join('');

        document.getElementById('selection-modal-title').textContent = 'T√πy ch·ªânh hi·ªÉn th·ªã Ng√†nh h√†ng chi ti·∫øt';
        modal.dataset.settingType = 'categoryView';
        const searchInput = document.getElementById('selection-modal-search');
        if (searchInput) searchInput.value = '';
        
        uiComponents.toggleModal('selection-modal', true);
    },

    renderRealtimeKpiCards: (data, settings) => {
        const { doanhThu, doanhThuQuyDoi, doanhThuChuaXuat, doanhThuQuyDoiChuaXuat, doanhThuTraGop, hieuQuaQuyDoi, tyLeTraCham } = data;
        const { goals: rtGoals } = settings;

        const targetDTT = parseFloat(rtGoals?.doanhThuThuc) || 0;
        const targetDTQD = parseFloat(rtGoals?.doanhThuQD) || 0;

        document.getElementById('rt-kpi-dt-thuc-main').textContent = uiComponents.formatNumber((doanhThu || 0) / 1000000, 1);
        document.getElementById('rt-kpi-dt-thuc-sub1').innerHTML = `% HT: <span class="font-bold">${uiComponents.formatPercentage(targetDTT > 0 ? ((doanhThu || 0) / 1000000) / targetDTT : 0)}</span> / Target ng√†y: <span class="font-bold">${uiComponents.formatNumber(targetDTT || 0)}</span>`;
        document.getElementById('rt-kpi-dt-thuc-sub2').innerHTML = `DT Ch∆∞a xu·∫•t: <span class="font-bold">${uiComponents.formatNumber((doanhThuChuaXuat || 0) / 1000000, 1)}</span>`;

        document.getElementById('rt-kpi-dt-qd-main').textContent = uiComponents.formatNumber((doanhThuQuyDoi || 0) / 1000000, 1);
        document.getElementById('rt-kpi-dt-qd-sub1').innerHTML = `% HT: <span class="font-bold">${uiComponents.formatPercentage(targetDTQD > 0 ? ((doanhThuQuyDoi || 0) / 1000000) / targetDTQD : 0)}</span> / Target ng√†y: <span class="font-bold">${uiComponents.formatNumber(targetDTQD || 0)}</span>`;
        document.getElementById('rt-kpi-dt-qd-sub2').innerHTML = `DTQƒê Ch∆∞a xu·∫•t: <span class="font-bold">${uiComponents.formatNumber((doanhThuQuyDoiChuaXuat || 0) / 1000000, 1)}</span>`;

        document.getElementById('rt-kpi-tl-qd-main').textContent = uiComponents.formatPercentage(hieuQuaQuyDoi);
        document.getElementById('rt-kpi-tl-qd-sub').innerHTML = `M·ª•c ti√™u: <span class="font-bold">${uiComponents.formatNumber(rtGoals?.phanTramQD || 0)}%</span>`;

        document.getElementById('rt-kpi-dt-tc-main').textContent = uiComponents.formatNumber((doanhThuTraGop || 0) / 1000000, 1);
        document.getElementById('rt-kpi-dt-tc-sub').innerHTML = `% th·ª±c tr·∫£ ch·∫≠m: <span class="font-bold">${uiComponents.formatPercentage(tyLeTraCham)}</span>`;
    },

    renderRealtimeChuaXuatTable: (reportData) => {
        const container = document.getElementById('realtime-unexported-revenue-content');
        if (!container) return;
        if (!reportData || reportData.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center font-bold">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ch∆∞a xu·∫•t trong ng√†y.</p>';
            return;
        }

        const sortState = appState.sortState.realtime_chuaxuat || { key: 'doanhThuQuyDoi', direction: 'desc' };
        const { key, direction } = sortState;
        const sortedData = [...reportData].sort((a, b) => {
            const valA = a[key] || 0; const valB = b[key] || 0;
            return direction === 'asc' ? valA - valB : valB - valA;
        });

        const totals = reportData.reduce((acc, item) => {
             acc.soLuong += item.soLuong;
            acc.doanhThuThuc += item.doanhThuThuc;
            acc.doanhThuQuyDoi += item.doanhThuQuyDoi;
            return acc;
        }, { soLuong: 0, doanhThuThuc: 0, doanhThuQuyDoi: 0 });

        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;
        
        container.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full text-sm table-bordered table-striped" data-table-type="realtime_chuaxuat">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold"><tr>
                <th class="${headerClass('nganhHang')}" data-sort="nganhHang">Ng√†nh h√†ng</th>
                <th class="${headerClass('soLuong')} text-right" data-sort="soLuong">S·ªë l∆∞·ª£ng</th>
                <th class="${headerClass('doanhThuThuc')} text-right" data-sort="doanhThuThuc">Doanh thu th·ª±c</th>
                 <th class="${headerClass('doanhThuQuyDoi')} text-right" data-sort="doanhThuQuyDoi">Doanh thu Qƒê</th></tr>
            </thead>
            <tbody>${sortedData.map(item => `
                 <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-semibold">${item.nganhHang}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumber(item.soLuong)}</td>
                     <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.doanhThuThuc)}</td>
                    <td class="px-4 py-2 text-right font-bold text-blue-600">${uiComponents.formatRevenue(item.doanhThuQuyDoi)}</td>
                 </tr>`).join('')}
            </tbody>
            <tfoot class="table-footer font-bold"><tr>
                <td class="px-4 py-2">T·ªïng</td>
                 <td class="px-4 py-2 text-right">${uiComponents.formatNumber(totals.soLuong)}</td>
                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.doanhThuThuc)}</td>
                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.doanhThuQuyDoi)}</td>
             </tr></tfoot></table></div>`;
    },

    renderRealtimeCategoryDetailsTable: (data) => {
        const container = document.getElementById('realtime-category-details-content');
        const cardHeader = document.getElementById('realtime-category-title');
        if (!container || !cardHeader ||!data || !data.nganhHangChiTiet) { container.innerHTML = `<p class="text-gray-500 font-bold">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>`; return; }
        
        const { nganhHangChiTiet } = data;
        const allItems = Object.keys(nganhHangChiTiet).sort();
        const visibleItems = settingsService.loadCategoryViewSettings(allItems);

        if (Object.keys(nganhHangChiTiet).length === 0) {
            container.innerHTML = '<p class="text-gray-500 font-bold">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>'; return;
        }

        const sortState = appState.sortState.realtime_nganhhang || { key: 'revenue', direction: 'desc' };
        const { key, direction } = sortState;

        const sortedData = Object.entries(nganhHangChiTiet)
            .map(([name, values]) => ({ name, ...values }))
            .filter(item => visibleItems.includes(item.name)) // L·ªçc theo c√†i ƒë·∫∑t
            .sort((a, b) => b.revenue - a.revenue)
            .slice(0, 15)
            .sort((a, b) => direction === 'asc' ? a[key] - b[key] : b[key] - a[key]);

        if (!cardHeader.querySelector('.settings-trigger-btn')) {
             cardHeader.classList.add('flex', 'items-center', 'justify-between');
            cardHeader.innerHTML = `<span>NG√ÄNH H√ÄNG CHI TI·∫æT</span>` + uiComponents.renderSettingsButton('rt-cat');
            setTimeout(() => {
                document.getElementById('settings-btn-rt-cat').addEventListener('click', () => {
                    this._showCategorySettingsModal(data);
                });
            }, 0);
        }

        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;

        container.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full text-sm table-bordered table-striped" data-table-type="realtime_nganhhang">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold"><tr>
                <th class="${headerClass('name')}" data-sort="name">Ng√†nh h√†ng</th>
                <th class="${headerClass('quantity')} text-right header-highlight" data-sort="quantity">SL</th>
                <th class="${headerClass('revenue')} text-right header-highlight" data-sort="revenue">Doanh thu th·ª±c</th>
                <th class="${headerClass('revenueQuyDoi')} text-right" data-sort="revenueQuyDoi">Doanh thu Qƒê</th>
                 <th class="${headerClass('avgPrice')} text-right" data-sort="avgPrice">ƒê∆°n gi√° TB</th></tr>
            </thead>
            <tbody>${sortedData.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-semibold">${item.name}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumber(item.quantity)}</td>
                     <td class="px-4 py-2 text-right font-bold text-blue-600">${uiComponents.formatRevenue(item.revenue)}</td>
                    <td class="px-4 py-2 text-right font-bold text-purple-600">${uiComponents.formatRevenue(item.revenueQuyDoi)}</td>
                    <td class="px-4 py-2 text-right font-bold text-green-600">${uiComponents.formatRevenue(item.donGia)}</td>
                </tr>`).join('')}
            </tbody></table></div>`;
    },
    
    renderRealtimeEfficiencyTable: (data, goals) => {
         const container = document.getElementById('realtime-efficiency-content');
        const cardHeader = document.getElementById('realtime-efficiency-title');

        if (!container || !cardHeader || !data || !goals) { 
            if (container) container.innerHTML = `<p class="text-gray-500 font-bold">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>`;
            return; 
        }
        
        const allItemsConfig = settingsService.loadEfficiencyViewSettings();
        
        const goalKeyMap = {
            pctPhuKien: 'phanTramPhuKien',
            pctGiaDung: 'phanTramGiaDung',
            pctMLN: 'phanTramMLN',
            pctSim: 'phanTramSim',
            pctVAS: 'phanTramVAS',
            pctBaoHiem: 'phanTramBaoHiem'
        };

        const allItems = allItemsConfig
            .filter(item => item.id.startsWith('pct'))
            .map(config => ({
                ...config,
                value: data[config.id],
                 target: goals[goalKeyMap[config.id]]
            }));
        
        const createRow = (label, value, target) => {
            const isBelow = value < ((target || 0) / 100); 
            
            return `<tr class="border-t">
                <td class="px-4 py-2 font-semibold text-gray-800">${label}</td>
                <td class="px-4 py-2 text-right font-bold text-lg ${isBelow ? 'cell-performance is-below' : 'text-green-600'}">${uiComponents.formatPercentage(value || 0)}</td>
                <td class="px-4 py-2 text-right text-gray-600">${target || 0}%</td>
            </tr>`;
        };
        
        if (!cardHeader.querySelector('.settings-trigger-btn')) {
            cardHeader.classList.add('flex', 'items-center', 'justify-between');
            cardHeader.innerHTML = `<span>HI·ªÜU QU·∫¢ KHAI TH√ÅC</span>` + uiComponents.renderSettingsButton('rt-eff');
            
            setTimeout(() => {
                document.getElementById('settings-btn-rt-eff').addEventListener('click', () => {
                    this._showEfficiencySettingsModal();
                });
            }, 0);
        }
         
        container.innerHTML = `
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm table-bordered">
                    <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
                        <tr>
                             <th class="px-4 py-3 text-left">Ch·ªâ s·ªë</th>
                            <th class="px-4 py-3 text-right">Th·ª±c hi·ªán</th>
                             <th class="px-4 py-3 text-right">M·ª•c ti√™u</th>
                        </tr>
                     </thead>
                    <tbody>
                        ${allItems
                             .filter(item => item.visible) // L·ªçc theo c√†i ƒë·∫∑t hi·ªÉn th·ªã
                             .map(item => createRow(item.label, item.value, item.target))
                            .join('')}
                    </tbody>
                </table>
             </div>`;
    },

    renderRealtimeQdcTable: (data) => {
        const container = document.getElementById('realtime-qdc-content');
        const cardHeader = document.getElementById('realtime-qdc-title');
        if (!container || !cardHeader || !data || !data.qdc) { container.innerHTML = `<p class="text-gray-500 font-bold">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>`; return; }
        
        const qdcData = Object.entries(data.qdc).map(([key, value]) => ({ id: key, ...value }));
        const allItems = qdcData.map(item => item.name);
        const visibleItems = settingsService.loadQdcViewSettings(allItems);
        
        const sortState = appState.sortState.realtime_qdc || { key: 'dtqd', direction: 'desc' };
        const { key, direction } = sortState;
        const sortedData = [...qdcData]
            .filter(item => visibleItems.includes(item.name)) // L·ªçc theo c√†i ƒë·∫∑t
            .sort((a,b) => direction === 'asc' ? a[key] - b[key] : b[key] - a[key]);
        
        if (!cardHeader.querySelector('.settings-trigger-btn')) {
             cardHeader.classList.add('flex', 'items-center', 'justify-between');
            cardHeader.innerHTML = `<span>NH√ìM H√ÄNG QUY ƒê·ªîI CAO</span>` + uiComponents.renderSettingsButton('rt-qdc');
            setTimeout(() => {
                document.getElementById('settings-btn-rt-qdc').addEventListener('click', () => {
                    this._showQdcSettingsModal(data);
                });
            }, 0);
        }

        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;

        container.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full text-sm table-bordered table-striped" data-table-type="realtime_qdc">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
                <tr><th class="${headerClass('name')}" data-sort="name">Nh√≥m h√†ng</th>
                <th class="${headerClass('sl')} text-right" data-sort="sl">S·ªë l∆∞·ª£ng</th>
                <th class="${headerClass('dtqd')} text-right" data-sort="dtqd">DTQƒê (Tr)</th>
                <th class="${headerClass('donGia')} text-right" data-sort="donGia">ƒê∆°n gi√° (Tr)</th>
                 </tr>
            </thead>
            <tbody>${sortedData.map(item => `
                 <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-semibold">${item.name}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumber(item.sl)}</td>
                     <td class="px-4 py-2 text-right font-bold text-blue-600">${uiComponents.formatRevenue(item.dtqd)}</td>
                    <td class="px-4 py-2 text-right font-bold text-green-600">${uiComponents.formatRevenue(item.donGia)}</td>
                </tr>`).join('')}
            </tbody></table></div>`;
    },

    renderRealtimeEmployeeDetail: (detailData, employeeName, containerId = 'realtime-employee-detail-container') => {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        let headerHtml = '';
        const isMainContainer = containerId === 'realtime-employee-detail-container' || containerId.includes('luyke');

        if (isMainContainer) {
            headerHtml = `
                <div class="mb-4 flex justify-between items-center">
                    <button class="back-to-summary-btn text-blue-600 hover:underline font-semibold">‚Äπ Quay l·∫°i b·∫£ng t·ªïng h·ª£p</button>
                    <button id="capture-${containerId}-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh chi ti·∫øt">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1v6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828-.828A2 2 0 0 1 3.172 4H2z"/><path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5zm0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7zM3 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z"/></svg>
                        <span>Ch·ª•p ·∫£nh</span>
                    </button>
                </div>
             `;
        }

        if (!detailData) {
            container.innerHTML = headerHtml + `<div class="rt-infographic-container"><p class="text-center text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu doanh thu cho nh√¢n vi√™n ${employeeName}.</p></div>`;
            return;
        }

        const selectedWarehouse = document.getElementById('realtime-filter-warehouse')?.value || document.getElementById('sknv-filter-warehouse')?.value;
        const { goals } = containerId.includes('luyke') ? settingsService.getLuykeGoalSettings(selectedWarehouse) : settingsService.getRealtimeGoalSettings(selectedWarehouse);
        const { summary, byProductGroup, byCustomer } = detailData;
        const totalRevenue = byProductGroup.reduce((sum, g) => sum + g.realRevenue, 0);

        const renderProductGroupProgress = () => byProductGroup.map(group => {
            const percentage = totalRevenue > 0 ? (group.realRevenue / totalRevenue) * 100 : 0;
            return `<div class="rt-progress-bar-item">
                <div class="rt-progress-bar-label"><span>${group.name}</span><span>${uiComponents.formatRevenue(group.realRevenue, 0)}</span></div>
                <div class="rt-progress-bar-container"><div class="rt-progress-bar" style="width: ${percentage}%;"></div></div>
            </div>`;
        }).join('');

        const renderCustomerAccordion = () => byCustomer.map((customer, index) => `
            <div class="rt-customer-group">
                <details>
                     <summary class="rt-customer-header">
                        <span>${index + 1}. ${customer.name} (<span class="product-count">${customer.totalQuantity} s·∫£n ph·∫©m</span>)</span><span class="arrow">‚ñº</span>
                    </summary>
                    <div class="rt-customer-details">
                        <table class="w-full">
                            ${customer.products.map(p => `<tr><td>${p.productName}</td><td class="text-right font-semibold">${uiComponents.formatNumber(p.realRevenue)}</td></tr>`).join('')}
                        </table>
                    </div>
                </details>
            </div>`).join('');

        const conversionRateTarget = (goals?.phanTramQD || 0) / 100;
        const conversionRateClass = summary.conversionRate >= conversionRateTarget ? 'is-positive' : 'is-negative';

        const contentHtml = `
            <div id="employee-detail-capture-area">
                <div class="rt-infographic-container" data-capture-group="dtnv-infographic">
                    <div class="rt-infographic-header text-center">
                        <h3 class="employee-name">${employeeName}</h3>
                        <p class="employee-title">Chi ti·∫øt doanh thu</p>
                    </div>
                    <div class="rt-infographic-summary">
                        <div class="rt-infographic-summary-card"><div class="label">T·ªïng DT Th·ª±c</div><div class="value">${uiComponents.formatRevenue(summary.totalRealRevenue, 1)}</div></div>
                        <div class="rt-infographic-summary-card"><div class="label">T·ªïng DTQƒê</div><div class="value">${uiComponents.formatRevenue(summary.totalConvertedRevenue, 1)}</div></div>
                         <div class="rt-infographic-summary-card"><div class="label">T·ª∑ l·ªá Qƒê</div><div class="value ${conversionRateClass}">${uiComponents.formatPercentage(summary.conversionRate)}</div></div>
                        <div class="rt-infographic-summary-card"><div class="label">DT Ch∆∞a Xu·∫•t</div><div class="value">${uiComponents.formatRevenue(summary.unexportedRevenue, 1)}</div></div>
                        <div class="rt-infographic-summary-card"><div class="label">T·ªïng ƒê∆°n H√†ng</div><div class="value">${summary.totalOrders}</div></div>
                        <div class="rt-infographic-summary-card"><div class="label">SL ƒê∆°n B√°n K√®m</div><div class="value">${summary.bundledOrderCount}</div></div>
                     </div>
                    <div class="rt-infographic-grid">
                        <div class="rt-infographic-section"><h4>Nh√≥m h√†ng</h4>${renderProductGroupProgress()}</div>
                        <div class="rt-infographic-section"><h4>Chi ti·∫øt theo kh√°ch h√†ng</h4><div class="rt-customer-accordion">${renderCustomerAccordion()}</div></div>
                    </div>
                 </div>
            </div>`;
        
        container.innerHTML = headerHtml + contentHtml;
    },

    renderRealtimeBrandReport: (data, viewType = 'brand') => {
        const container = document.getElementById('realtime-brand-report-container');
        if (!container) return;
        const { byBrand, byEmployee } = data;

        if (byBrand.length === 0 && byEmployee.length === 0) {
            container.innerHTML = '<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu cho b·ªô l·ªçc n√†y.</p>';
            return;
        }

        const renderTable = (title, items, headers, rowRenderer, sortStateKey) => {
             const sortState = appState.sortState[sortStateKey] || { key: 'revenue', direction: 'desc' };
            const { key, direction } = sortState;
            const sortedItems = [...items].sort((a,b) => direction === 'asc' ? (a[key] - b[key]) : (b[key] - a[key]));

            const headerClass = (sortKey) => `px-4 py-2 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;
            return `<div class="overflow-x-auto"><h4 class="text-lg font-semibold text-gray-700 mb-2">${title}</h4>
                <table class="min-w-full text-sm table-bordered table-striped" data-table-type="${sortStateKey}">
                    <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
                         <tr>${headers.map(h => `<th class="${headerClass(h.key)}" data-sort="${h.key}">${h.label}<span class="sort-indicator"></span></th>`).join('')}</tr>
                    </thead>
                    <tbody>${sortedItems.map(rowRenderer).join('')}</tbody>
                </table></div>`;
        };

        const brandTable = renderTable('Th·ªëng k√™ theo h√£ng', byBrand,
            [{label: 'H√£ng', key: 'name'}, {label: 'S·ªë l∆∞·ª£ng', key: 'quantity'}, {label: 'Doanh thu', key: 'revenue'}, {label: 'ƒê∆°n gi√° TB', key: 'avgPrice'}],
            item => `<tr class="border-t">
                <td class="px-4 py-2 font-medium">${item.name}</td>
                <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumber(item.quantity)}</td>
                <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.revenue)}</td>
                <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.avgPrice)}</td>
            </tr>`, 'realtime_brand'
         );

        const employeeTable = renderTable('Th·ªëng k√™ theo nh√¢n vi√™n', byEmployee,
            [{label: 'Nh√¢n vi√™n', key: 'name'}, {label: 'S·ªë l∆∞·ª£ng', key: 'quantity'}, {label: 'Doanh thu', key: 'revenue'}],
            item => `<tr class="border-t">
                <td class="px-4 py-2 font-medium">${item.name}</td>
                <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumber(item.quantity)}</td>
                <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.revenue)}</td>
            </tr>`, 'realtime_brand_employee'
        );

        const brandTableHtml = `<div id="realtime-brand-table-container" class="${viewType !== 'brand' ? 'hidden' : ''}">${brandTable}</div>`;
        const employeeTableHtml = `<div id="realtime-employee-table-container" class="${viewType !== 'employee' ? 'hidden' : ''}">${employeeTable}</div>`;

        container.innerHTML = brandTableHtml + employeeTableHtml;
    }
};
--- END FILE: ./ui-realtime.js ---

--- START FILE: ./ui-sknv.js ---
// Version 6.9 - Update medal SVGs to new high-quality, detailed versions
// MODULE: UI SKNV
// Ch·ª©a c√°c h√†m render giao di·ªán cho tab "S·ª©c kh·ªèe nh√¢n vi√™n"

import { appState } from './state.js';
import { services } from './services.js';
import { uiComponents } from './ui-components.js';
import { utils } from './utils.js';

export const uiSknv = {
    displayEmployeeIncomeReport: (reportData) => {
        const container = document.getElementById('income-report-container');
        const placeholder = document.getElementById('income-report-placeholder');
        if (!container || !placeholder) return;
        const hasIncomeData = reportData.some(item => item.tongThuNhap > 0 || item.gioCong > 0);
        if (!reportData || reportData.length === 0 || !hasIncomeData) {
            placeholder.classList.remove('hidden'); container.innerHTML = ''; return;
        }
        placeholder.classList.add('hidden');
        let finalHTML = `<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden"><div class="p-4 header-group-2 text-gray-800"><h3 class="text-xl font-bold uppercase">Thu nh·∫≠p nh√¢n vi√™n</h3><p class="text-sm italic text-gray-600">(ƒë∆°n v·ªã t√≠nh: Tri·ªáu ƒë·ªìng)</p></div>`;
        
        const groupedByDept = {};
        reportData.forEach(item => {
            const dept = item.boPhan;
            if (!groupedByDept[dept]) groupedByDept[dept] = [];
            groupedByDept[dept].push(item);
        });
        const departmentOrder = utils.getSortedDepartmentList(reportData);
        
        departmentOrder.forEach(deptName => {
            if (groupedByDept[deptName]) finalHTML += uiSknv.renderIncomeTableForDepartment(deptName, groupedByDept[deptName]);
        });
        
        finalHTML += `</div>`;
        container.innerHTML = finalHTML;
    },

    renderIncomeTableForDepartment: (title, data) => {
        const sortState = appState.sortState.thunhap || { key: 'tongThuNhap', direction: 'desc' };
        const { key, direction } = sortState;
        const sortedData = [...data].sort((a, b) => {
            const valA = a[key] || 0; const valB = b[key] || 0;
            return direction === 'asc' ? valA - valB : valB - valA;
        });
        
        const totals = data.reduce((acc, item) => {
            acc.gioCong += item.gioCong;
            acc.thuongNong += item.thuongNong;
            acc.thuongERP += item.thuongERP;
            acc.tongThuNhap += item.tongThuNhap;
            acc.thuNhapDuKien += item.thuNhapDuKien;
            acc.thuNhapThangTruoc += item.thuNhapThangTruoc;
            acc.chenhLechThuNhap += item.chenhLechThuNhap;
            return acc;
        }, { gioCong: 0, thuongNong: 0, thuongERP: 0, tongThuNhap: 0, thuNhapDuKien: 0, thuNhapThangTruoc: 0, chenhLechThuNhap: 0 });

        const averageProjectedIncome = data.length > 0 ? totals.thuNhapDuKien / data.length : 0;
        let titleClass = '';
        if (title.includes('T∆∞ V·∫•n')) titleClass = 'department-header-tv';
        else if (title.includes('Kho')) titleClass = 'department-header-kho';
        else if (title.includes('Trang Tr√≠')) titleClass = 'department-header-tt';

        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;
        let tableHTML = `<div class="department-block"><h4 class="text-lg font-bold p-4 border-b border-gray-200 ${titleClass}">${title} <span class="text-sm font-normal text-gray-500">(Thu nh·∫≠p DK TB: ${uiComponents.formatRevenue(averageProjectedIncome)})</span></h4><div class="overflow-x-auto"><table class="min-w-full text-sm text-left text-gray-600 table-bordered table-striped" data-table-type="thunhap" data-capture-columns="8">
             <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
                 <tr>
                    <th class="${headerClass('hoTen')}" data-sort="hoTen">H·ªç T√™n <span class="sort-indicator"></span></th>
                    <th class="${headerClass('gioCong')} text-right" data-sort="gioCong">Gi·ªù c√¥ng <span class="sort-indicator"></span></th>
                    <th class="${headerClass('tongThuNhap')} text-right" data-sort="tongThuNhap">T·ªïng thu nh·∫≠p <span class="sort-indicator"></span></th>
                    <th class="${headerClass('thuNhapDuKien')} text-right" data-sort="thuNhapDuKien">Thu nh·∫≠p DK <span class="sort-indicator"></span></th>
                    <th class="${headerClass('thuNhapThangTruoc')} text-right" data-sort="thuNhapThangTruoc">Th√°ng tr∆∞·ªõc <span class="sort-indicator"></span></th>
                    <th class="${headerClass('chenhLechThuNhap')} text-right" data-sort="chenhLechThuNhap">+/- Th√°ng tr∆∞·ªõc <span class="sort-indicator"></span></th>
                 </tr>
                 </thead><tbody>`;
        sortedData.forEach(nv => {
            const incomeDkCellClass = nv.thuNhapDuKien < averageProjectedIncome ? 'cell-performance is-below' : '';
            const incomeDiffClass = nv.chenhLechThuNhap < 0 ? 'income-negative' : 'income-positive';
            tableHTML += `<tr class="interactive-row" data-employee-id="${nv.maNV}" data-source-tab="sknv">
                    <td class="px-4 py-2 font-semibold line-clamp-2 employee-name-cell">
                        <a href="#">${uiComponents.getShortEmployeeName(nv.hoTen, nv.maNV)}</a>
                    </td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumberOrDash(nv.gioCong)}</td>
                    <td class="px-4 py-2 text-right font-bold text-blue-600">${uiComponents.formatRevenue(nv.tongThuNhap)}</td>
                    <td class="px-4 py-2 text-right font-bold text-green-600 ${incomeDkCellClass}">${uiComponents.formatRevenue(nv.thuNhapDuKien)}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(nv.thuNhapThangTruoc)}</td>
                    <td class="px-4 py-2 text-right font-bold ${incomeDiffClass}">${uiComponents.formatRevenue(nv.chenhLechThuNhap)}</td>
                </tr>`;
        });
        tableHTML += `</tbody><tfoot class="table-footer font-bold">
            <tr>
                <td class="px-4 py-2">T·ªïng</td>
                <td class="px-4 py-2 text-right">${uiComponents.formatNumberOrDash(totals.gioCong)}</td>
                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.tongThuNhap)}</td>
                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.thuNhapDuKien)}</td>
                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.thuNhapThangTruoc)}</td>
                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.chenhLechThuNhap)}</td>
            </tr>
        </tfoot></table></div></div>`;
        return tableHTML;
    },

    displaySknvReport: (filteredReport, forceDetail = false) => {
        const summaryContainer = document.getElementById('sknv-summary-container');
        const detailsContainer = document.getElementById('sknv-details-container');
        if (!summaryContainer || !detailsContainer) return;
    
        const isViewingDetail = appState.viewingDetailFor && appState.viewingDetailFor.sourceTab === 'sknv';
    
        const shouldShowDetail = forceDetail || isViewingDetail;
    
        summaryContainer.classList.toggle('hidden', shouldShowDetail);
        detailsContainer.classList.toggle('hidden', !shouldShowDetail);
    
        if (shouldShowDetail) {
            const employeeId = appState.viewingDetailFor.employeeId;
            const employeeData = appState.masterReportData.sknv.find(nv => String(nv.maNV).trim() === String(employeeId).trim());
            uiSknv.renderSknvDetailForEmployee(employeeData, filteredReport);
        } else {
            uiSknv.displaySknvSummaryReport(filteredReport);
        }
    },
    
    _createDetailMetricGrid(title, colorClass, icon, data) {
        let itemsHtml = data.map(row => {
            const evaluation = uiSknv.getSknvEvaluation(row.rawValue, row.rawAverage, row.higherIsBetter);
            return `
                <div class="sknv-detail-metric-card">
                    <span class="label">${row.label}</span>
                    <span class="value ${row.valueClass || ''}">${row.value}</span>
                    <span class="average">(TB: ${row.average})</span>
                    <div class="evaluation-badge ${evaluation.class}">${evaluation.text}</div>
                </div>
            `;
        }).join('');
    
        return `
            <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
                <div class="sknv-detail-card-header ${colorClass}">
                    <i data-feather="${icon}" class="header-icon"></i>
                    <h4 class="text-lg font-bold">${title}</h4>
                </div>
                <div class="sknv-detail-grid-body">
                    ${itemsHtml}
                </div>
            </div>
        `;
    },

    renderSknvDetailForEmployee(employeeData, filteredReport) {
        const detailsContainer = document.getElementById('sknv-details-container');
        if (!detailsContainer) return;

        if (!employeeData) {
            detailsContainer.innerHTML = `
                <div class="mb-4">
                    <button class="back-to-summary-btn text-blue-600 hover:underline font-semibold">‚Äπ Quay l·∫°i b·∫£ng t·ªïng h·ª£p</button>
                </div>
                <p class="text-red-500">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho nh√¢n vi√™n ƒë√£ ch·ªçn. Vui l√≤ng t·∫£i l·∫°i d·ªØ li·ªáu YCX n·∫øu c·∫ßn.</p>
            `;
            return;
        }
    
        const departmentAverages = services.calculateDepartmentAverages(employeeData.boPhan, filteredReport);
        
        const evaluationCounts = {
            doanhthu: { above: 0, total: 7 },
            nangsuat: { above: 0, total: 7 },
            hieuqua: { above: 0, total: 6 },
            dongia: { above: 0, total: 7 },
            qdc: { above: 0, total: 0 }
        };

        const countEvaluation = (group, value, avgValue, higherIsBetter = true) => {
            if (!isFinite(value) || avgValue === undefined || !isFinite(avgValue)) return;
            let isAbove = higherIsBetter ? (value >= avgValue) : (value <= avgValue);
            if (isAbove) { evaluationCounts[group].above++; }
        };
        
        const { mucTieu } = employeeData;

        const doanhThuData = [
            { label: 'Doanh thu th·ª±c', value: uiComponents.formatRevenue(employeeData.doanhThu), average: uiComponents.formatRevenue(departmentAverages.doanhThu || 0), rawValue: employeeData.doanhThu, rawAverage: departmentAverages.doanhThu },
            { label: 'Doanh thu quy ƒë·ªïi', value: uiComponents.formatRevenue(employeeData.doanhThuQuyDoi), average: uiComponents.formatRevenue(departmentAverages.doanhThuQuyDoi || 0), rawValue: employeeData.doanhThuQuyDoi, rawAverage: departmentAverages.doanhThuQuyDoi },
            { label: '% Quy ƒë·ªïi', value: uiComponents.formatPercentage(employeeData.hieuQuaQuyDoi), valueClass: (mucTieu && employeeData.hieuQuaQuyDoi < (mucTieu.phanTramQD / 100)) ? 'cell-performance is-below' : '', average: uiComponents.formatPercentage(departmentAverages.hieuQuaQuyDoi), rawValue: employeeData.hieuQuaQuyDoi, rawAverage: departmentAverages.hieuQuaQuyDoi },
            { label: 'Doanh thu CE', value: uiComponents.formatRevenue(employeeData.dtCE), average: uiComponents.formatRevenue(departmentAverages.dtCE || 0), rawValue: employeeData.dtCE, rawAverage: departmentAverages.dtCE },
            { label: 'Doanh thu ICT', value: uiComponents.formatRevenue(employeeData.dtICT), average: uiComponents.formatRevenue(departmentAverages.dtICT || 0), rawValue: employeeData.dtICT, rawAverage: departmentAverages.dtICT },
            { label: 'Doanh thu tr·∫£ ch·∫≠m', value: uiComponents.formatRevenue(employeeData.doanhThuTraGop), average: uiComponents.formatRevenue(departmentAverages.doanhThuTraGop || 0), rawValue: employeeData.doanhThuTraGop, rawAverage: departmentAverages.doanhThuTraGop },
            { label: '% Tr·∫£ ch·∫≠m', value: uiComponents.formatPercentage(employeeData.tyLeTraCham), valueClass: (mucTieu && employeeData.tyLeTraCham < (mucTieu.phanTramTC / 100)) ? 'cell-performance is-below' : '', average: uiComponents.formatPercentage(departmentAverages.tyLeTraCham), rawValue: employeeData.tyLeTraCham, rawAverage: departmentAverages.tyLeTraCham }
        ];
        doanhThuData.forEach(d => countEvaluation('doanhthu', d.rawValue, d.rawAverage));

        const nangSuatData = [
            { label: 'Th∆∞·ªüng n√≥ng', value: uiComponents.formatRevenue(employeeData.thuongNong), average: uiComponents.formatRevenue(departmentAverages.thuongNong || 0), rawValue: employeeData.thuongNong, rawAverage: departmentAverages.thuongNong },
            { label: 'Th∆∞·ªüng ERP', value: uiComponents.formatRevenue(employeeData.thuongERP), average: uiComponents.formatRevenue(departmentAverages.thuongERP || 0), rawValue: employeeData.thuongERP, rawAverage: departmentAverages.thuongERP },
            { label: 'Thu nh·∫≠p l≈©y k·∫ø', value: uiComponents.formatRevenue(employeeData.tongThuNhap), average: uiComponents.formatRevenue(departmentAverages.tongThuNhap || 0), rawValue: employeeData.tongThuNhap, rawAverage: departmentAverages.tongThuNhap },
            { label: 'Thu nh·∫≠p d·ª± ki·∫øn', value: uiComponents.formatRevenue(employeeData.thuNhapDuKien), average: uiComponents.formatRevenue(departmentAverages.thuNhapDuKien || 0), rawValue: employeeData.thuNhapDuKien, rawAverage: departmentAverages.thuNhapDuKien },
            { label: 'Gi·ªù c√¥ng', value: uiComponents.formatNumberOrDash(employeeData.gioCong), average: uiComponents.formatNumberOrDash(departmentAverages.gioCong), rawValue: employeeData.gioCong, rawAverage: departmentAverages.gioCong },
            { label: 'Thu nh·∫≠p/GC', value: uiComponents.formatNumberOrDash(employeeData.gioCong > 0 ? employeeData.tongThuNhap / employeeData.gioCong : 0), average: uiComponents.formatNumberOrDash((departmentAverages.gioCong || 0) > 0 ? (departmentAverages.tongThuNhap || 0) / departmentAverages.gioCong : 0), rawValue: employeeData.gioCong > 0 ? employeeData.tongThuNhap / employeeData.gioCong : 0, rawAverage: (departmentAverages.gioCong || 0) > 0 ? (departmentAverages.tongThuNhap || 0) / departmentAverages.gioCong : 0 },
            { label: 'Doanh thu Qƒê/GC', value: uiComponents.formatRevenue(employeeData.gioCong > 0 ? employeeData.doanhThuQuyDoi / employeeData.gioCong : 0), average: uiComponents.formatRevenue((departmentAverages.gioCong || 0) > 0 ? (departmentAverages.doanhThuQuyDoi || 0) / departmentAverages.gioCong : 0), rawValue: employeeData.gioCong > 0 ? employeeData.doanhThuQuyDoi / employeeData.gioCong : 0, rawAverage: (departmentAverages.gioCong || 0) > 0 ? (departmentAverages.doanhThuQuyDoi || 0) / departmentAverages.gioCong : 0 }
        ];
        nangSuatData.forEach(d => countEvaluation('nangsuat', d.rawValue, d.rawAverage));

        const hieuQuaData = [
            { label: '% PK', value: uiComponents.formatPercentage(employeeData.pctPhuKien), valueClass: (mucTieu && employeeData.pctPhuKien < (mucTieu.phanTramPhuKien / 100)) ? 'cell-performance is-below' : '', average: uiComponents.formatPercentage(departmentAverages.pctPhuKien), rawValue: employeeData.pctPhuKien, rawAverage: departmentAverages.pctPhuKien },
            { label: '% Gia d·ª•ng', value: uiComponents.formatPercentage(employeeData.pctGiaDung), valueClass: (mucTieu && employeeData.pctGiaDung < (mucTieu.phanTramGiaDung / 100)) ? 'cell-performance is-below' : '', average: uiComponents.formatPercentage(departmentAverages.pctGiaDung), rawValue: employeeData.pctGiaDung, rawAverage: departmentAverages.pctGiaDung },
            { label: '% MLN', value: uiComponents.formatPercentage(employeeData.pctMLN), valueClass: (mucTieu && employeeData.pctMLN < (mucTieu.phanTramMLN / 100)) ? 'cell-performance is-below' : '', average: uiComponents.formatPercentage(departmentAverages.pctMLN), rawValue: employeeData.pctMLN, rawAverage: departmentAverages.pctMLN },
            { label: '% Sim', value: uiComponents.formatPercentage(employeeData.pctSim), valueClass: (mucTieu && employeeData.pctSim < (mucTieu.phanTramSim / 100)) ? 'cell-performance is-below' : '', average: uiComponents.formatPercentage(departmentAverages.pctSim), rawValue: employeeData.pctSim, rawAverage: departmentAverages.pctSim },
            { label: '% VAS', value: uiComponents.formatPercentage(employeeData.pctVAS), valueClass: (mucTieu && employeeData.pctVAS < (mucTieu.phanTramVAS / 100)) ? 'cell-performance is-below' : '', average: uiComponents.formatPercentage(departmentAverages.pctVAS), rawValue: employeeData.pctVAS, rawAverage: departmentAverages.pctVAS },
            { label: '% B·∫£o hi·ªÉm', value: uiComponents.formatPercentage(employeeData.pctBaoHiem), valueClass: (mucTieu && employeeData.pctBaoHiem < (mucTieu.phanTramBaoHiem / 100)) ? 'cell-performance is-below' : '', average: uiComponents.formatPercentage(departmentAverages.pctBaoHiem), rawValue: employeeData.pctBaoHiem, rawAverage: departmentAverages.pctBaoHiem },
        ];
        hieuQuaData.forEach(d => countEvaluation('hieuqua', d.rawValue, d.rawAverage));

        const donGiaData = [
            { label: 'ƒê∆°n gi√° TB', value: uiComponents.formatRevenue(employeeData.donGiaTrungBinh), average: uiComponents.formatRevenue(departmentAverages.donGiaTrungBinh), rawValue: employeeData.donGiaTrungBinh, rawAverage: departmentAverages.donGiaTrungBinh },
            { label: 'ƒê∆°n gi√° Tivi', value: uiComponents.formatRevenue(employeeData.donGiaTivi), average: uiComponents.formatRevenue(departmentAverages.donGiaTivi), rawValue: employeeData.donGiaTivi, rawAverage: departmentAverages.donGiaTivi },
            { label: 'ƒê∆°n gi√° T·ªß l·∫°nh', value: uiComponents.formatRevenue(employeeData.donGiaTuLanh), average: uiComponents.formatRevenue(departmentAverages.donGiaTuLanh), rawValue: employeeData.donGiaTuLanh, rawAverage: departmentAverages.donGiaTuLanh },
            { label: 'ƒê∆°n gi√° M√°y gi·∫∑t', value: uiComponents.formatRevenue(employeeData.donGiaMayGiat), average: uiComponents.formatRevenue(departmentAverages.donGiaMayGiat), rawValue: employeeData.donGiaMayGiat, rawAverage: departmentAverages.donGiaMayGiat },
            { label: 'ƒê∆°n gi√° M√°y l·∫°nh', value: uiComponents.formatRevenue(employeeData.donGiaMayLanh), average: uiComponents.formatRevenue(departmentAverages.donGiaMayLanh), rawValue: employeeData.donGiaMayLanh, rawAverage: departmentAverages.donGiaMayLanh },
            { label: 'ƒê∆°n gi√° ƒêi·ªán tho·∫°i', value: uiComponents.formatRevenue(employeeData.donGiaDienThoai), average: uiComponents.formatRevenue(departmentAverages.donGiaDienThoai), rawValue: employeeData.donGiaDienThoai, rawAverage: departmentAverages.donGiaDienThoai },
            { label: 'ƒê∆°n gi√° Laptop', value: uiComponents.formatRevenue(employeeData.donGiaLaptop), average: uiComponents.formatRevenue(departmentAverages.donGiaLaptop), rawValue: employeeData.donGiaLaptop, rawAverage: departmentAverages.donGiaLaptop },
        ];
        donGiaData.forEach(d => countEvaluation('dongia', d.rawValue, d.rawAverage));

        const totalAbove = evaluationCounts.doanhthu.above + evaluationCounts.nangsuat.above + evaluationCounts.hieuqua.above + evaluationCounts.dongia.above + evaluationCounts.qdc.above;
        const totalCriteria = evaluationCounts.doanhthu.total + evaluationCounts.nangsuat.total + evaluationCounts.hieuqua.total + evaluationCounts.dongia.total + evaluationCounts.qdc.total;
        
        detailsContainer.innerHTML = `
            <div class="mb-4 flex justify-between items-center">
                <button class="back-to-summary-btn text-blue-600 hover:underline font-semibold">‚Äπ Quay l·∫°i b·∫£ng t·ªïng h·ª£p</button>
                <button id="capture-sknv-detail-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh chi ti·∫øt">
                    <i data-feather="camera"></i>
                    <span>Ch·ª•p ·∫£nh</span>
                </button>
            </div>
            <div id="sknv-detail-capture-area">
                <div class="sknv-detail-header-card" data-capture-group="1">
                    <div class="sknv-card__avatar sknv-detail-avatar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>
                    <div class="sknv-detail-info">
                        <p class="name">${employeeData.hoTen} - ${employeeData.maNV}</p>
                        <p class="department">${employeeData.boPhan}</p>
                        <p class="kpi-summary">Ch·ªâ s·ªë tr√™n TB: <span class="text-green-600 font-bold">${totalAbove}</span> / T·ªïng: <span class="font-bold">${totalCriteria}</span></p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6" data-capture-layout="grid">
                    <div class="space-y-6" data-capture-group="1">
                        ${this._createDetailMetricGrid('Doanh thu', 'sknv-header-blue', 'trending-up', doanhThuData)}
                        ${this._createDetailMetricGrid('Hi·ªáu qu·∫£ khai th√°c', 'sknv-header-orange', 'award', hieuQuaData)}
                    </div>
                    <div class="space-y-6" data-capture-group="1">
                        ${this._createDetailMetricGrid('NƒÉng su·∫•t', 'sknv-header-green', 'dollar-sign', nangSuatData)}
                        ${this._createDetailMetricGrid('ƒê∆°n gi√°', 'sknv-header-yellow', 'tag', donGiaData)}
                    </div>
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6" data-capture-layout="grid">
                        <div data-capture-group="1">${uiSknv.renderSknvQdcTable(employeeData, departmentAverages, countEvaluation, evaluationCounts)}</div>
                        <div data-capture-group="1">${uiSknv.renderSknvNganhHangTable(employeeData)}</div>
                    </div>
                </div>
            </div>`;
            feather.replace();
    },
    
    displaySknvSummaryReport: (reportData) => {
        const container = document.getElementById('sknv-summary-container');
        if (!container) return;

        if (!reportData || reportData.length === 0) {
            container.innerHTML = '<p class="text-gray-500 font-bold p-4">Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªáu su·∫•t ƒë·ªÉ hi·ªÉn th·ªã.</p>';
            return;
        }

        const summarizedData = reportData.map(employee => {
            const departmentAverages = services.calculateDepartmentAverages(employee.boPhan, reportData);
            const counts = {
                doanhthu: { above: 0, total: 7 },
                nangsuat: { above: 0, total: 7 },
                hieuqua: { above: 0, total: 6 },
                dongia: { above: 0, total: 7 },
                qdc: { above: 0, total: 0 }
            };

            const check = (group, value, avg, higherIsBetter = true) => {
                if (!isFinite(value) || avg === undefined || !isFinite(avg)) return;
                if (higherIsBetter ? (value >= avg) : (value <= avg)) counts[group].above++;
            };

            check('doanhthu', employee.doanhThu, departmentAverages.doanhThu);
            check('doanhthu', employee.doanhThuQuyDoi, departmentAverages.doanhThuQuyDoi);
            check('doanhthu', employee.hieuQuaQuyDoi, departmentAverages.hieuQuaQuyDoi);
            check('doanhthu', employee.dtCE, departmentAverages.dtCE);
            check('doanhthu', employee.dtICT, departmentAverages.dtICT);
            check('doanhthu', employee.doanhThuTraGop, departmentAverages.doanhThuTraGop);
            check('doanhthu', employee.tyLeTraCham, departmentAverages.tyLeTraCham);

            check('nangsuat', employee.tongThuNhap, departmentAverages.tongThuNhap);
            check('nangsuat', employee.thuNhapDuKien, departmentAverages.thuNhapDuKien);
            check('nangsuat', employee.gioCong, departmentAverages.gioCong);
            check('nangsuat', employee.gioCong > 0 ? employee.tongThuNhap / employee.gioCong : 0, departmentAverages.gioCong > 0 ? departmentAverages.tongThuNhap / departmentAverages.gioCong : 0);
            check('nangsuat', employee.gioCong > 0 ? employee.doanhThuQuyDoi / employee.gioCong : 0, departmentAverages.gioCong > 0 ? departmentAverages.doanhThuQuyDoi / departmentAverages.gioCong : 0);
            check('nangsuat', employee.thuongNong, departmentAverages.thuongNong);
            check('nangsuat', employee.thuongERP, departmentAverages.thuongERP);

            check('hieuqua', employee.pctPhuKien, departmentAverages.pctPhuKien);
            check('hieuqua', employee.pctGiaDung, departmentAverages.pctGiaDung);
            check('hieuqua', employee.pctMLN, departmentAverages.pctMLN);
            check('hieuqua', employee.pctSim, departmentAverages.pctSim);
            check('hieuqua', employee.pctVAS, departmentAverages.pctVAS);
            check('hieuqua', employee.pctBaoHiem, departmentAverages.pctBaoHiem);

            check('dongia', employee.donGiaTrungBinh, departmentAverages.donGiaTrungBinh);
            check('dongia', employee.donGiaTivi, departmentAverages.donGiaTivi);
            check('dongia', employee.donGiaTuLanh, departmentAverages.donGiaTuLanh);
            check('dongia', employee.donGiaMayGiat, departmentAverages.donGiaMayGiat);
            check('dongia', employee.donGiaMayLanh, departmentAverages.donGiaMayLanh);
            check('dongia', employee.donGiaDienThoai, departmentAverages.donGiaDienThoai);
            check('dongia', employee.donGiaLaptop, departmentAverages.donGiaLaptop);

            if(employee.qdc && departmentAverages.qdc) {
                for (const key in employee.qdc) {
                    if(departmentAverages.qdc[key] && employee.qdc[key].dtqd > 0) {
                        counts.qdc.total++;
                        check('qdc', employee.qdc[key].dtqd, departmentAverages.qdc[key].dtqd);
                    }
                }
            }

            const totalAbove = counts.doanhthu.above + counts.nangsuat.above + counts.hieuqua.above + counts.dongia.above + counts.qdc.above;
            const totalCriteria = counts.doanhthu.total + counts.nangsuat.total + counts.hieuqua.total + counts.dongia.total + counts.qdc.total;
            
            return { ...employee, summary: counts, totalAbove, totalCriteria };
        });

        const subKpiGroups = [
            { key: 'doanhthu', label: 'Doanh Thu', icon: 'trending-up' },
            { key: 'nangsuat', label: 'NƒÉng Su·∫•t', icon: 'dollar-sign' },
            { key: 'hieuqua', label: 'Hi·ªáu Qu·∫£', icon: 'award' },
            { key: 'dongia', label: 'ƒê∆°n Gi√°', icon: 'tag' },
            { key: 'qdc', label: 'QƒêC', icon: 'star' }
        ];
        
        const groupedByDept = {};
        summarizedData.forEach(item => {
            const dept = item.boPhan;
            if (!groupedByDept[dept]) groupedByDept[dept] = [];
            groupedByDept[dept].push(item);
        });

        const departmentOrder = utils.getSortedDepartmentList(reportData);

        let finalCardsHtml = '';
        
        // === START: NEW HIGH-QUALITY MEDAL SVGS ===
        const gold_medal_svg = `<span class="medal-container"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="gold-grad" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#FFDF00;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#FFB800;stop-opacity:1" />
                </linearGradient>
                <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                    <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
                    <feOffset dx="2" dy="2" result="offsetblur"/>
                    <feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
            </defs>
            <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
            <circle cx="50" cy="45" r="38" fill="#BDBDBD"/>
            <circle cx="50" cy="45" r="35" fill="url(#gold-grad)"/>
            <circle cx="50" cy="45" r="28" fill="#FFC107" stroke="#FFFFFF" stroke-width="2"/>
            <text x="50" y="52" font-family="Arial, sans-serif" font-size="28" font-weight="bold" fill="white" text-anchor="middle">1</text>
            <path d="M 68 25 l 3 -6 l 3 6 l 6 3 l -6 3 l -3 6 l -3 -6 l -6 -3 Z" fill="white" opacity="0.8"/>
            <path d="M 30 55 l 2 -4 l 2 4 l 4 2 l -4 2 l -2 4 l -2 -4 l -4 -2 Z" fill="white" opacity="0.5"/>
        </svg></span>`;

        const silver_medal_svg = `<span class="medal-container"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="silver-grad" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#F5F5F5;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#B0BEC5;stop-opacity:1" />
                </linearGradient>
            </defs>
            <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
            <circle cx="50" cy="45" r="38" fill="#78909C"/>
            <circle cx="50" cy="45" r="35" fill="url(#silver-grad)"/>
            <circle cx="50" cy="45" r="28" fill="#B0BEC5" stroke="#FFFFFF" stroke-width="2"/>
            <text x="50" y="52" font-family="Arial, sans-serif" font-size="28" font-weight="bold" fill="white" text-anchor="middle">2</text>
            <path d="M 68 25 l 3 -6 l 3 6 l 6 3 l -6 3 l -3 6 l -3 -6 l -6 -3 Z" fill="white" opacity="0.8"/>
        </svg></span>`;

        const bronze_medal_svg = `<span class="medal-container"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="bronze-grad" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#FFCC80;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#D84315;stop-opacity:1" />
                </linearGradient>
            </defs>
            <path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/>
            <circle cx="50" cy="45" r="38" fill="#A1887F"/>
            <circle cx="50" cy="45" r="35" fill="url(#bronze-grad)"/>
            <circle cx="50" cy="45" r="28" fill="#D84315" stroke="#FFFFFF" stroke-width="2"/>
            <text x="50" y="52" font-family="Arial, sans-serif" font-size="28" font-weight="bold" fill="white" text-anchor="middle">3</text>
            <path d="M 68 25 l 3 -6 l 3 6 l 6 3 l -6 3 l -3 6 l -3 -6 l -6 -3 Z" fill="white" opacity="0.8"/>
        </svg></span>`;
        // === END: NEW HIGH-QUALITY MEDAL SVGS ===

        departmentOrder.forEach(deptName => {
            if (groupedByDept[deptName] && groupedByDept[deptName].length > 0) {
                const sortedDeptEmployees = [...groupedByDept[deptName]].sort((a, b) => (b.totalAbove || 0) - (a.totalAbove || 0));

                finalCardsHtml += `<div class="sknv-department-group">`;
                finalCardsHtml += `<h4 class="sknv-department-header ${deptName.includes('T∆∞ V·∫•n - ƒêM') ? 'sknv-department-header--priority' : ''}">${deptName}</h4>`;
                finalCardsHtml += `<div class="sknv-summary-grid">`;

                sortedDeptEmployees.forEach((item, index) => {
                    const performancePercentage = item.totalCriteria > 0 ? (item.totalAbove / item.totalCriteria) : 0;
                    const performanceColorClass = performancePercentage >= 0.7 ? 'sknv-card-kpi-strong' : performancePercentage >= 0.4 ? 'sknv-card-kpi-medium' : 'sknv-card-kpi-weak';
                    
                    let medalHtml = '';
                    if (index === 0) medalHtml = gold_medal_svg;
                    else if (index === 1) medalHtml = silver_medal_svg;
                    else if (index === 2) medalHtml = bronze_medal_svg;

                    const subKpisHtml = subKpiGroups.map(group => {
                        if (item.summary[group.key].total === 0) return '';
                        const subKpiPerf = item.summary[group.key].total > 0 ? item.summary[group.key].above / item.summary[group.key].total : 0;
                        const subKpiColorClass = subKpiPerf >= 0.7 ? 'strong' : subKpiPerf >= 0.4 ? 'medium' : 'weak';
                        const valueColorClass = subKpiPerf >= 0.5 ? 'text-blue-600' : 'text-red-600';

                        return `
                            <div class="sknv-card__sub-kpi-item ${subKpiColorClass}">
                                <div class="sknv-card__sub-kpi-header">
                                    <i data-feather="${group.icon}"></i>
                                    <span class="label">${group.label}</span>
                                </div>
                                <span class="value ${valueColorClass}">${item.summary[group.key].above}/${item.summary[group.key].total}</span>
                            </div>
                        `;
                    }).join('');
                    
                    finalCardsHtml += `
                        <div class="sknv-card interactive-row" data-employee-id="${item.maNV}" data-source-tab="sknv">
                            ${medalHtml}
                            <div class="sknv-card__header">
                                <div class="sknv-card__avatar">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                </div>
                                <div class="sknv-card__info">
                                    <p class="name">${uiComponents.getShortEmployeeName(item.hoTen, item.maNV)}</p>
                                    <p class="id">${item.boPhan}</p>
                                </div>
                            </div>
                            <div class="sknv-card__main-kpi ${performanceColorClass}">
                                <span class="value">${item.totalAbove}</span>
                                <span class="total">/ ${item.totalCriteria}</span>
                                <span class="label">Ch·ªâ s·ªë tr√™n TB</span>
                            </div>
                            <div class="sknv-card__sub-kpi-grid">
                                ${subKpisHtml}
                            </div>
                        </div>`;
                });
                finalCardsHtml += `</div></div>`;
            }
        });
        container.innerHTML = `<div data-capture-group="1">${finalCardsHtml}</div>`;
        
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    },
    
    getSknvEvaluation: (value, avgValue, higherIsBetter = true) => {
        if (!isFinite(value) || avgValue === undefined || !isFinite(avgValue)) return { text: '-', class: '' };
        const isAbove = higherIsBetter ? (value >= avgValue) : (value <= avgValue);
        return {
            text: isAbove ? 'Tr√™n TB' : 'D∆∞·ªõi TB',
            class: isAbove ? 'text-green-600' : 'text-yellow-600'
        };
    },
    
    renderSknvNganhHangTable(employeeData) {
        const { doanhThuTheoNganhHang } = employeeData;
        const sortState = appState.sortState.sknv_nganhhang_chitiet || { key: 'revenue', direction: 'desc' };
        const { key, direction } = sortState;
        
        const dataArray = Object.entries(doanhThuTheoNganhHang)
            .map(([name, values]) => ({ name, ...values }))
            .filter(item => item.revenue > 0);

        if (dataArray.length === 0) return '<div class="bg-white rounded-xl shadow-md border border-gray-200 p-4"><div class="sknv-detail-card-header sknv-header-purple"><i data-feather="list" class="header-icon"></i><h4 class="text-lg font-bold">Doanh thu theo Ng√†nh h√†ng</h4></div><p class="p-4 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</p></div>';

        const sortedData = [...dataArray].sort((a,b) => direction === 'asc' ? a[key] - b[key] : b[key] - a[key]);
        const headerClass = (sortKey) => `px-4 py-2 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;

        return `<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden"><div class="sknv-detail-card-header sknv-header-purple"><i data-feather="list" class="header-icon"></i><h4 class="text-lg font-bold">Doanh thu theo Ng√†nh h√†ng</h4></div><div class="overflow-x-auto" style="max-height: 400px;"><table class="min-w-full text-sm table-bordered table-striped" data-table-type="sknv_nganhhang_chitiet">
            <thead class="sknv-subtable-header"><tr>
                <th class="${headerClass('name')}" data-sort="name">Ng√†nh h√†ng</th>
                <th class="${headerClass('quantity')} text-right" data-sort="quantity">SL</th>
                <th class="${headerClass('revenue')} text-right" data-sort="revenue">Doanh thu</th>
                <th class="${headerClass('revenueQuyDoi')} text-right" data-sort="revenueQuyDoi">DTQƒê</th>
            </tr></thead>
            <tbody>${sortedData.map(item => `
                <tr class="border-t">
                    <td class="px-4 py-2 font-medium">${item.name}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumberOrDash(item.quantity)}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.revenue, 0)}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.revenueQuyDoi, 0)}</td>
                </tr>`).join('')}
            </tbody></table></div></div>`;
    },

    renderSknvQdcTable(employeeData, departmentAverages, countCallback, evaluationCounts) {
        const qdcData = employeeData.qdc;
        const avgQdcData = departmentAverages.qdc;

        const sortState = appState.sortState.sknv_qdc || { key: 'dtqd', direction: 'desc' };
        const { key, direction } = sortState;
        const sortedData = Object.entries(qdcData)
            .map(([id, values]) => ({ id, ...values }))
            .filter(item => item.sl > 0)
            .sort((a,b) => direction === 'asc' ? a[key] - b[key] : b[key] - a[key]);

        if (sortedData.length === 0) {
            evaluationCounts.qdc.total = 0;
            return '<div class="bg-white rounded-xl shadow-md border border-gray-200 p-4"><div class="sknv-detail-card-header sknv-header-indigo"><i data-feather="star" class="header-icon"></i><h4 class="text-lg font-bold">Nh√≥m h√†ng Quy ƒë·ªïi cao</h4></div><p class="p-4 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</p></div>';
        }
        
        evaluationCounts.qdc.total = sortedData.length;

        const headerClass = (sortKey) => `px-4 py-2 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;

        return `<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden"><div class="sknv-detail-card-header sknv-header-indigo"><i data-feather="star" class="header-icon"></i><h4 class="text-lg font-bold">Nh√≥m h√†ng Quy ƒë·ªïi cao</h4></div><div class="overflow-x-auto" style="max-height: 400px;"><table class="min-w-full text-sm table-bordered table-striped" data-table-type="sknv_qdc">
            <thead class="sknv-subtable-header"><tr>
                <th class="${headerClass('name')}" data-sort="name">Nh√≥m h√†ng</th>
                <th class="${headerClass('sl')} text-right" data-sort="sl">SL</th>
                <th class="${headerClass('dtqd')} text-right" data-sort="dtqd">DTQƒê (Tr)</th>
                <th class="px-4 py-2 text-center">ƒê√°nh gi√°</th>
            </tr></thead>
            <tbody>${sortedData.map(item => {
                const avgValue = avgQdcData?.[item.id]?.dtqd;
                const evaluation = uiSknv.getSknvEvaluation(item.dtqd, avgValue);
                countCallback('qdc', item.dtqd, avgValue);
                return `<tr class="border-t">
                    <td class="px-4 py-2 font-medium">${item.name}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumberOrDash(item.sl)}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.dtqd)}</td>
                    <td class="px-4 py-2 text-center font-semibold ${evaluation.class}">${evaluation.text}</td>
                </tr>`}).join('')}
            </tbody></table></div></div>`;
    },
};
--- END FILE: ./ui-sknv.js ---

--- START FILE: ./ui-thidua-vung.js ---
// Version 1.5 - Display 'Lay Top' data and finalize UI
// MODULE: UI THI ƒêUA V√ôNG
// Ch·ª©a c√°c h√†m render giao di·ªán cho tab "Thi ƒëua v√πng".

import { uiComponents } from './ui-components.js';

export const uiThiDuaVung = {
    renderThiDuaVungInfographic(reportData) {
        const container = document.getElementById('thidua-vung-infographic-container');
        if (!container) return;
        if (!reportData) {
            container.innerHTML = `<div class="placeholder-message">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho si√™u th·ªã ƒë√£ ch·ªçn.</div>`;
            return;
        }

        const { summary, coGiai, sapCoGiai, tiemNang, canCoGangNhieu } = reportData;

        // --- Helper function to find correct key regardless of case ---
        const findKey = (item, keyword) => {
            if (!item) return keyword;
            return Object.keys(item).find(k => k.trim().toLowerCase().includes(keyword.toLowerCase())) || keyword;
        };
        
        const firstItem = coGiai[0] || sapCoGiai[0] || tiemNang[0] || canCoGangNhieu[0];
        const keyMap = {
            sieuThi: findKey(summary, 'si√™u th·ªã'),
            tongThuongTamTinh: findKey(summary, 't·ªïng th∆∞·ªüng t·∫°m t·ªânh'),
            slThiDua: findKey(summary, 'sl nh thi ƒëua'),
            slDat: findKey(summary, 'sl nh >100%'),
            tyLeDat: findKey(summary, 't·ª∑ l·ªá nh ƒë·∫°t >100%'),
            slCoGiai: findKey(summary, 'sl nh d·ª± ki·∫øn ƒë·∫°t gi·∫£i'),
            nganhHang: findKey(firstItem, 'ng√†nh h√†ng'),
            phanTramDuKien: findKey(firstItem, '% d·ª± ki·∫øn'),
            duKienVuot: findKey(firstItem, 'd·ª± ki·∫øn d.thu'),
            hangVuotTroi: findKey(firstItem, 'h·∫°ng v∆∞·ª£t tr·ªôi'),
            hangTarget: findKey(firstItem, 'h·∫°ng % target'),
            tongThuong: findKey(firstItem, 't·ªïng th∆∞·ªüng'),
            hangCoGiaiKenh: 'hangCoGiaiKenh' // S·ª≠ d·ª•ng key ƒë√£ ƒë∆∞·ª£c chu·∫©n h√≥a trong services.js
        };

        const renderCoGiaiItem = (item) => `
            <div class="tdv-item-card">
                <p class="tdv-item-card__title">${item[keyMap.nganhHang]}</p>
                <div class="tdv-progress-bar-container">
                    <div class="tdv-progress-bar tdv-progress-bar--blue" style="width: ${Math.min(item[keyMap.phanTramDuKien] * 100, 100)}%;"></div>
                    <span class="tdv-progress-bar__text">${uiComponents.formatPercentage(item[keyMap.phanTramDuKien])}</span>
                </div>
                <div class="tdv-item-card__details">
                    <span>V∆∞·ª£t: <strong>${uiComponents.formatNumber(item[keyMap.duKienVuot])}</strong></span>
                    <span>H·∫°ng DT/SL: <strong>${item[keyMap.hangVuotTroi]}</strong></span>
                    <span>H·∫°ng %: <strong>${item[keyMap.hangTarget]}</strong></span>
                    <span class="tdv-item-card__prize">Th∆∞·ªüng: <strong>${uiComponents.formatNumber(item[keyMap.tongThuong])}</strong></span>
                </div>
            </div>
        `;

        const renderSapCoGiaiItem = (item) => `
            <div class="tdv-item-card">
                <p class="tdv-item-card__title">${item[keyMap.nganhHang]}</p>
                <div class="tdv-progress-bar-container">
                    <div class="tdv-progress-bar tdv-progress-bar--yellow" style="width: ${Math.min(item[keyMap.phanTramDuKien] * 100, 100)}%;"></div>
                    <span class="tdv-progress-bar__text">${uiComponents.formatPercentage(item[keyMap.phanTramDuKien])}</span>
                </div>
                <div class="tdv-item-card__details">
                    <span>C√°ch gi·∫£i: <strong>${item.khoangCach} h·∫°ng</strong></span>
                    <span>H·∫°ng DT/SL: <strong>${item[keyMap.hangVuotTroi]}</strong></span>
                    <span>H·∫°ng %: <strong>${item[keyMap.hangTarget]}</strong></span>
                    <span class="tdv-item-card__prize">Th∆∞·ªüng DK: <strong>${uiComponents.formatNumber(item.thuongTiemNang)}</strong></span>
                </div>
            </div>
        `;

        const renderNeedsEffortRow = (potentialItems, majorItems) => {
            let html = `<div class="tdv-row">
                <h3 class="tdv-row-title tdv-row-title--effort">Nh√≥m c√≤n l·∫°i (${potentialItems.length + majorItems.length})</h3>
                <div class="tdv-row-body tdv-row-body--effort">`;
            
            if (potentialItems.length > 0) {
                html += `<div class="tdv-effort-subgroup">
                    <h4 class="tdv-effort-subgroup__title tdv-effort-subgroup__title--potential">Ti·ªÅm nƒÉng (c√°ch 21-40 h·∫°ng)</h4>
                    <div class="tdv-effort-list">${potentialItems.map(item => `<div class="tdv-effort-item">${item[keyMap.nganhHang]} (c√°ch ${item.khoangCach})</div>`).join('')}</div>
                </div>`;
            }

            if (majorItems.length > 0) {
                 html += `<div class="tdv-effort-subgroup">
                    <h4 class="tdv-effort-subgroup__title tdv-effort-subgroup__title--major">C·∫ßn c·ªë g·∫Øng nhi·ªÅu</h4>
                    <div class="tdv-effort-list">${majorItems.map(item => `<div class="tdv-effort-item">${item[keyMap.nganhHang]}</div>`).join('')}</div>
                </div>`;
            }

            if (potentialItems.length === 0 && majorItems.length === 0) {
                html += '<p class="text-xs text-gray-500">Kh√¥ng c√≥.</p>';
            }

            html += `</div></div>`;
            return html;
        };
        
        const totalSoonPrize = sapCoGiai.reduce((sum, item) => sum + (item.thuongTiemNang || 0), 0);
        const soonPrizeTitleText = totalSoonPrize > 0 ? ` - DK: ${uiComponents.formatNumber(totalSoonPrize)}ƒë` : '';

        const html = `
            <div class="tdv-infographic-card">
                <div class="tdv-header">
                    <h2 class="tdv-supermarket-name">${summary[keyMap.sieuThi]}</h2>
                    <div class="tdv-total-prize-container">
                        <span class="tdv-total-prize-label">T·ªïng th∆∞·ªüng t·∫°m t√≠nh:</span>
                        <span class="tdv-total-prize-value">${uiComponents.formatNumber(summary[keyMap.tongThuongTamTinh])}ƒë</span>
                    </div>
                </div>

                <div class="tdv-summary-grid">
                    <div class="tdv-summary-item">
                        <span class="tdv-summary-value">${uiComponents.formatNumber(summary[keyMap.slThiDua])}</span>
                        <span class="tdv-summary-label">Ng√†nh thi ƒëua</span>
                    </div>
                    <div class="tdv-summary-item">
                        <span class="tdv-summary-value">${uiComponents.formatNumber(summary[keyMap.slDat])}</span>
                        <span class="tdv-summary-label">Ng√†nh >100%</span>
                    </div>
                    <div class="tdv-summary-item">
                        <span class="tdv-summary-value">${uiComponents.formatPercentage(summary[keyMap.tyLeDat])}</span>
                        <span class="tdv-summary-label">T·ª∑ l·ªá ƒë·∫°t</span>
                    </div>
                     <div class="tdv-summary-item">
                        <span class="tdv-summary-value">${uiComponents.formatNumber(summary[keyMap.slCoGiai])}</span>
                        <span class="tdv-summary-label">Ng√†nh d·ª± ki·∫øn c√≥ gi·∫£i</span>
                    </div>
                    <div class="tdv-summary-item">
                        <span class="tdv-summary-value">${uiComponents.formatNumber(summary[keyMap.hangCoGiaiKenh])}</span>
                        <span class="tdv-summary-label">H·∫°ng c√≥ gi·∫£i (K√™nh)</span>
                    </div>
                </div>

                <div class="tdv-rows-container">
                    <div class="tdv-row">
                        <h3 class="tdv-row-title tdv-row-title--prize">Ng√†nh h√†ng c√≥ gi·∫£i (${coGiai.length})</h3>
                        <div class="tdv-row-body">${coGiai.map(renderCoGiaiItem).join('') || '<p class="text-xs text-gray-500">Kh√¥ng c√≥.</p>'}</div>
                    </div>
                    
                    <div class="tdv-row">
                        <h3 class="tdv-row-title tdv-row-title--soon-prize">S·∫Øp c√≥ gi·∫£i (${sapCoGiai.length})<span class="tdv-row-subtitle">${soonPrizeTitleText}</span></h3>
                        <div class="tdv-row-body">${sapCoGiai.map(renderSapCoGiaiItem).join('') || '<p class="text-xs text-gray-500">Kh√¥ng c√≥.</p>'}</div>
                    </div>
                    
                    ${renderNeedsEffortRow(tiemNang, canCoGangNhieu)}
                </div>
            </div>
        `;

        container.innerHTML = html;
    }
};
--- END FILE: ./ui-thidua-vung.js ---

--- START FILE: ./ui.js ---
// Version 2.5 - Refactor: Update imports to reflect new module structure
// MODULE: UI FACADE (M·∫∑t ti·ªÅn Giao di·ªán)

import { uiComponents } from './ui-components.js';
import { uiLuyke } from './ui-luyke.js';
import { uiSknv } from './ui-sknv.js';
import { uiRealtime } from './ui-realtime.js';
import { uiThiDuaVung } from './ui-thidua-vung.js';
import { uiCompetition } from './ui-competition.js';

// G·ªôp t·∫•t c·∫£ c√°c h√†m t·ª´ c√°c module con v√†o m·ªôt ƒë·ªëi t∆∞·ª£ng 'ui' duy nh·∫•t.
const ui = {
    ...uiComponents,
    ...uiLuyke, 
    ...uiSknv,
    ...uiRealtime,
    ...uiThiDuaVung,
    ...uiCompetition,
};

// Xu·∫•t kh·∫©u ƒë·ªëi t∆∞·ª£ng 'ui' ƒë√£ ƒë∆∞·ª£c h·ª£p nh·∫•t.
export { ui };
--- END FILE: ./ui.js ---

--- START FILE: ./utils.js ---
// Version 3.3 - Make department sorting more robust
// MODULE: UTILITIES
// Ch·ª©a c√°c h√†m ti·ªán √≠ch chung kh√¥ng thu·ªôc v·ªÅ logic hay giao di·ªán c·ª• th·ªÉ.
import { ui } from './ui.js';

export const utils = {
    getRandomBrightColor() {
        const colors = [
            '#ef4444', // red-500
            '#f97316', // orange-500
            '#eab308', // yellow-500
            '#84cc16', // lime-500
            '#22c55e', // green-500
            '#10b981', // emerald-500
            '#14b8a6', // teal-500
            '#06b6d4', // cyan-500
            '#3b82f6', // blue-500
            '#8b5cf6', // violet-500
            '#d946ef', // fuchsia-500
            '#ec4899', // pink-500
        ];
        return colors[Math.floor(Math.random() * colors.length)];
    },

    cleanCategoryName(name) {
        if (!name || typeof name !== 'string') return '';
        // B·ªè m√£ s·ªë, kho·∫£ng tr·∫Øng th·ª´a, v√† vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu m·ªói t·ª´.
        return name
            .replace(/^\d+\s*-\s*/, '')
            .trim()
            .replace(/\s+/g, ' ')
            .toLowerCase()
            .split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    },

    exportTableToExcel(activeTabContent, fileName) {
        if (!activeTabContent) {
            ui.showNotification('Kh√¥ng t√¨m th·∫•y tab ƒëang ho·∫°t ƒë·ªông ƒë·ªÉ xu·∫•t.', 'error');
            return;
        }
        let table = activeTabContent.querySelector('.department-block table, #sknv-summary-container table, #luyke-competition-content table, table');
        if (!table) {
            ui.showNotification('Kh√¥ng t√¨m th·∫•y b·∫£ng d·ªØ li·ªáu trong tab n√†y ƒë·ªÉ xu·∫•t.', 'error');
            return;
        }
        try {
            const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
            XLSX.writeFile(wb, `${fileName}.xlsx`);
            ui.showNotification(`ƒê√£ xu·∫•t file ${fileName}.xlsx th√†nh c√¥ng!`, 'success');
        } catch (e) {
            console.error('L·ªói xu·∫•t Excel:', e);
            ui.showNotification('C√≥ l·ªói x·∫£y ra khi xu·∫•t file Excel.', 'error');
        }
    },

    // <<< START: UPDATED FUNCTION >>>
    getSortedDepartmentList(reportData) {
        const allDepts = [...new Set(reportData.map(item => item.boPhan).filter(Boolean))];

        allDepts.sort((a, b) => {
            const aIsPriority = a.includes('T∆∞ V·∫•n - ƒêM');
            const bIsPriority = b.includes('T∆∞ V·∫•n - ƒêM');

            if (aIsPriority && !bIsPriority) {
                return -1; // a comes first
            }
            if (!aIsPriority && bIsPriority) {
                return 1; // b comes first
            }
            // If both are priority or both are not, sort alphabetically
            return a.localeCompare(b);
        });

        return allDepts;
    },
    // <<< END: UPDATED FUNCTION >>>
};
--- END FILE: ./utils.js ---

--- START FILE: ./version.json ---
{
  "version": "3.5"
}

--- END FILE: ./version.json ---

