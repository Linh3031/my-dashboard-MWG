--- START FILE: ./Firebase.js ---
// Version 3.4 - Refactor: Extract action functions into separate services
// MODULE: FIREBASE (CORE)
// Ch·ªãu tr√°ch nhi·ªám k·∫øt n·ªëi, thi·∫øt l·∫≠p listener v·ªõi Firebase.
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, onSnapshot, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
import { appState } from './state.js';
import { ui } from './ui.js';

const firebase = {
    async initCore() {
        const firebaseConfig = {
          apiKey: "AIzaSyAQ3TWcpa4AnTN-32igGseYDlXrCf1BVew", // Replace with your actual config if needed
          authDomain: "qlst-9e6bd.firebaseapp.com",
          projectId: "qlst-9e6bd",
          storageBucket: "qlst-9e6bd.firebasestorage.app",
          messagingSenderId: "2316705291",
          appId: "1:2316705291:web:ebec2963816aea7585b10e",
          measurementId: "G-M0SM0XHCEK"
        };
        try {
            const firebaseApp = initializeApp(firebaseConfig);
            appState.auth = getAuth(firebaseApp);
            appState.db = getFirestore(firebaseApp);
            appState.storage = getStorage(firebaseApp);
            console.log("Firebase core services initialized successfully!");
        } catch (error) {
            console.error("Firebase core initialization failed:", error);
            ui.showNotification(error.message || "Kh√¥ng th·ªÉ kh·ªüi t·∫°o k·∫øt n·ªëi Firebase.", "error");
            throw error;
        }
    },

    setupListeners() {
        console.log("Setting up Firebase listeners...");
        if (!appState.db) {
            console.error("Firestore DB instance not available for setting up listeners.");
            return;
        }
        if (!appState.auth?.currentUser) {
             console.warn("Attempting to set up listeners before authentication is complete. This might lead to permission errors initially.");
        }

        const feedbackQuery = query(collection(appState.db, "feedback"), orderBy("timestamp", "desc"));
        onSnapshot(feedbackQuery, (querySnapshot) => {
            console.log("Feedback listener received data.");
            appState.feedbackList = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                appState.feedbackList.push({ id: doc.id, ...data, timestamp: data.timestamp?.toDate() });
            });
            // Ch·ªâ render n·∫øu ƒëang ·ªü trang ch·ªß
            if (document.getElementById('home-section')?.classList.contains('hidden') === false) {
                 ui.renderFeedbackSection(); // Gi·∫£ s·ª≠ h√†m n√†y n·∫±m trong ui object
            }
        }, (error) => {
            console.error("Error listening to feedback collection: ", error);
            if (error.code !== 'permission-denied') {
                 ui.showNotification("L·ªói khi t·∫£i danh s√°ch g√≥p √Ω.", "error");
            }
        });

        const helpContentRef = collection(appState.db, "help_content");
        onSnapshot(helpContentRef, (querySnapshot) => {
            console.log("Help content listener received data.");
            let contentUpdated = false;
            querySnapshot.forEach((doc) => {
                if (appState.helpContent.hasOwnProperty(doc.id)) {
                    appState.helpContent[doc.id] = doc.data().content;
                    contentUpdated = true;
                }
            });
            // Ch·ªâ render n·∫øu admin ƒëang ·ªü trang khai b√°o
            if (contentUpdated && appState.isAdmin && document.getElementById('declaration-section')?.classList.contains('hidden') === false) {
                 ui.renderAdminHelpEditors(); // Gi·∫£ s·ª≠ h√†m n√†y n·∫±m trong ui object
            }
        }, (error) => {
            console.error("Error listening to help_content collection: ", error);
            if (error.code !== 'permission-denied') {
                ui.showNotification("L·ªói khi t·∫£i n·ªôi dung h∆∞·ªõng d·∫´n.", "error");
            }
        });

        const statsRef = doc(appState.db, "analytics", "site_stats");
        onSnapshot(statsRef, (docSnap) => {
            if (docSnap.exists()) {
               console.log("Stats listener received data.");
               const statsData = docSnap.data();
                ui.updateUsageCounter(statsData); // Gi·∫£ s·ª≠ h√†m n√†y n·∫±m trong ui object
            } else {
                console.log("Kh√¥ng t√¨m th·∫•y document th·ªëng k√™.");
            }
        }, (error) => {
             console.error("Error listening to site_stats document: ", error);
             if (error.code !== 'permission-denied') {
                 ui.showNotification("L·ªói khi t·∫£i s·ªë li·ªáu th·ªëng k√™.", "error");
            }
        });

        console.log("Firebase listeners setup initiated.");
    },

    listenForDataChanges(kho, callback) {
        if (!appState.db || !kho || typeof callback !== 'function') return null;
        if (!appState.auth?.currentUser) {
             console.warn(`Cannot listen for data changes for kho ${kho} before auth is ready.`);
             return null;
        }
        const khoRef = doc(appState.db, "warehouseData", kho);
        console.log(`B·∫Øt ƒë·∫ßu l·∫Øng nghe thay ƒë·ªïi d·ªØ li·ªáu cho kho: ${kho}`);
        const unsubscribe = onSnapshot(khoRef, (docSnap) => {
            if (docSnap.exists()) {
                console.log(`Ph√°t hi·ªán d·ªØ li·ªáu/metadata m·ªõi cho kho ${kho}.`);
                const allData = docSnap.data();
                callback(allData);
            } else {
                console.log(`Ch∆∞a c√≥ d·ªØ li·ªáu/metadata n√†o tr√™n cloud cho kho ${kho}.`);
                callback({});
            }
        }, (error) => {
            console.error(`L·ªói khi l·∫Øng nghe d·ªØ li·ªáu kho ${kho}:`, error);
            if (error.code !== 'permission-denied') {
                 ui.showNotification("M·∫•t k·∫øt n·ªëi ƒë·ªìng b·ªô d·ªØ li·ªáu.", "error");
            } else {
                 console.warn(`Permission denied while listening for data changes on kho ${kho}. Check Firestore rules.`);
            }
        });
        return unsubscribe;
    }
};

export { firebase };
--- END FILE: ./Firebase.js ---

--- START FILE: ./auth.js ---
// Version 2.5 - Refactor: Call analyticsService instead of firebase
// MODULE: AUTH
// Ch·ªãu tr√°ch nhi·ªám x·ª≠ l√Ω logic ƒë·ªãnh danh ng∆∞·ªùi d√πng qua email, y√™u c·∫ßu sau khi c√≥ phi√™n ·∫©n danh.

import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { appState } from './state.js';
import { ui } from './ui.js';
// import { firebase } from './firebase.js'; // <-- ƒê√£ x√≥a
import { analyticsService } from './services/analytics.service.js'; // <-- ƒê√£ th√™m

export const auth = {
    _authInstance: null,

    async ensureAnonymousAuth() {
        if (!this._authInstance) {
            this._authInstance = getAuth();
            if (!this._authInstance) {
                 console.error("Firebase Auth ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o ƒë√∫ng c√°ch trong firebase.js"); 
                 throw new Error("Firebase Auth initialization failed."); 
            }
        }
        return new Promise((resolve, reject) => {
            onAuthStateChanged(this._authInstance, async (user) => {
                if (user) {
                    console.log("Anonymous user detected or already signed in:", user.uid);
                    resolve(user); 
                } else {
                    console.log("No user found, attempting anonymous sign-in..."); 
                    try {
                        const userCredential = await signInAnonymously(this._authInstance); 
                        console.log("Anonymous sign-in successful:", userCredential.user.uid); 
                        resolve(userCredential.user); 
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error); 
                        ui.showNotification("L·ªói x√°c th·ª±c. Kh√¥ng th·ªÉ k·∫øt n·ªëi.", "error"); 
                        reject(error); 
                    }
                }
            }, (error) => {
                console.error("Error in onAuthStateChanged listener:", error); 
                reject(error); 
            });
        });
    },

    initEmailIdentification(onSuccessCallback) {
        const savedEmail = localStorage.getItem('userEmail'); 
        if (savedEmail && this._isValidEmail(savedEmail)) { 
            appState.currentUser = { email: savedEmail }; 
            console.log("Email found in localStorage, proceeding."); 
            onSuccessCallback(); 
        } else {
            console.log("No valid email in localStorage, showing login modal."); 
            ui.toggleModal('login-modal', true); 
            this._setupLoginListenerDeferred(onSuccessCallback); 
        }
    },

    /**
     * @private
     * Thi·∫øt l·∫≠p tr√¨nh nghe s·ª± ki·ªán cho form ƒëƒÉng nh·∫≠p - Phi√™n b·∫£n m·ªõi v·ªõi polling
     * Ch·ªù cho ƒë·∫øn khi c√°c element c·ªßa modal xu·∫•t hi·ªán trong DOM.
     * @param {Function} onSuccessCallback - H√†m callback ƒë·ªÉ ch·∫°y sau khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng. 
     */
    _setupLoginListenerDeferred(onSuccessCallback) {
        const maxWaitTime = 5000; // Ch·ªù t·ªëi ƒëa 5 gi√¢y 
        const checkInterval = 100; // Ki·ªÉm tra m·ªói 100ms 
        let elapsedTime = 0; 

        console.log("[auth.js] Attempting to set up login listener, waiting for elements..."); 

        const intervalId = setInterval(() => {
            elapsedTime += checkInterval; // TƒÉng th·ªùi gian ƒë√£ tr√¥i qua ·ªü ƒë·∫ßu m·ªói l·∫ßn l·∫∑p 
            const submitBtn = document.getElementById('login-submit-btn'); 
            const emailInput = document.getElementById('login-email-input'); 

            // *** ADDED: Logging inside interval ***
            console.log(`[auth.js interval ${elapsedTime}ms] Checking... Button found: ${!!submitBtn}, Input found: ${!!emailInput}`); 

            if (submitBtn && emailInput) {
                clearInterval(intervalId); 
                console.log("[auth.js] Login elements found. Attaching listeners now."); 
                this._attachLoginHandlers(submitBtn, emailInput, onSuccessCallback); 
            } else if (elapsedTime >= maxWaitTime) {
                clearInterval(intervalId); 
                console.error("[auth.js] CRITICAL TIMEOUT: Login button or email input not found after waiting."); 
                // *** ADDED: Log current modal HTML on timeout ***
                const modalElement = document.getElementById('login-modal'); 
                console.error("[auth.js] Current #login-modal content on timeout:", modalElement?.innerHTML.substring(0, 300) + "..."); 
                ui.showNotification("L·ªói giao di·ªán nghi√™m tr·ªçng: Kh√¥ng th·ªÉ kh·ªüi t·∫°o form ƒëƒÉng nh·∫≠p.", "error"); 
            }
            // No 'else' needed here, just continue polling if not found and not timed out
        }, checkInterval);
    },

    /**
     * @private
     * G·∫Øn c√°c h√†m x·ª≠ l√Ω s·ª± ki·ªán click v√† keydown (t√°ch ra ƒë·ªÉ t√°i s·ª≠ d·ª•ng).
     */
     _attachLoginHandlers(submitBtn, emailInput, onSuccessCallback) {
         if (submitBtn.dataset.listenerAttached) { 
             console.warn("Login listener already attached. Skipping."); 
             return; 
         }
         submitBtn.dataset.listenerAttached = 'true'; 
         emailInput.dataset.listenerAttached = 'true'; 

         submitBtn.onclick = async () => {
             const currentEmailInput = document.getElementById('login-email-input');
             const currentErrorMsg = document.getElementById('login-error-msg');
             const currentSubmitBtn = document.getElementById('login-submit-btn');

             if (!currentEmailInput || !currentErrorMsg || !currentSubmitBtn) {
                 console.error("Login modal elements missing during click handler!");
                 return;
             }

             const email = currentEmailInput.value.trim(); 
             if (this._isValidEmail(email)) { 
                 currentErrorMsg.classList.add('hidden'); 
                 currentSubmitBtn.disabled = true; 
                 currentSubmitBtn.textContent = "ƒêang x·ª≠ l√Ω..."; 

                 localStorage.setItem('userEmail', email); 
                 appState.currentUser = { email: email }; 

                 ui.showNotification(`Ch√†o m·ª´ng ${email}!`, 'success'); 
                 
                 // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
                 await analyticsService.upsertUserRecord(email);
                 // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===

                 ui.toggleModal('login-modal', false); 
                 console.log("Email submitted, calling onSuccessCallback."); 
                 onSuccessCallback(); 
             } else {
                 currentErrorMsg.classList.remove('hidden'); 
                 currentSubmitBtn.disabled = false; 
                 currentSubmitBtn.textContent = "X√°c nh·∫≠n & Ti·∫øp t·ª•c"; 
             }
         };

         emailInput.onkeydown = (e) => { 
             if (e.key === 'Enter') { 
                 e.preventDefault(); 
                 const currentSubmitBtn = document.getElementById('login-submit-btn'); 
                 if (currentSubmitBtn && !currentSubmitBtn.disabled) { 
                     currentSubmitBtn.click(); 
                 }
             }
         };
         console.log("Successfully attached login handlers."); 
     },

    /**
     * @private
     * Ki·ªÉm tra ƒë·ªãnh d·∫°ng email ƒë∆°n gi·∫£n.
     * @param {string} email
     * @returns {boolean} 
     */
    _isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; 
        return email && emailRegex.test(email); 
    }
};
--- END FILE: ./auth.js ---

--- START FILE: ./components/drawer-goal.js ---
// Version 1.2 - Refactor: Remove Special Program form (moved to admin panel)
// Ch·ª©a m√£ HTML cho drawer thi·∫øt l·∫≠p m·ª•c ti√™u.

const drawerGoalHTML = `
<div id="goal-drawer" class="settings-drawer fixed top-0 left-0 h-full bg-white shadow-2xl z-50 p-6 overflow-y-auto hidden">
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800">Thi·∫øt l·∫≠p m·ª•c ti√™u</h3>
        <button class="close-drawer-btn text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
    </div>
    
    <div class="border-b border-gray-200 mb-4">
        <nav id="goal-drawer-tabs" class="-mb-px flex space-x-6" aria-label="Tabs" data-content-container="goal-drawer-content">
             <button class="sub-tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="goal-tab-monthly">M·ª•c ti√™u Th√°ng (L≈©y k·∫ø)</button>
             <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="goal-tab-daily">M·ª•c ti√™u Ng√†y (Realtime)</button>
        </nav>
    </div>

    <div id="goal-drawer-content">
        <div id="goal-tab-monthly" class="sub-tab-content space-y-4">
            <div>
                <label for="luyke-goal-warehouse-select" class="block text-sm font-medium text-gray-700 mb-1">Thi·∫øt l·∫≠p cho kho</label>
                <select id="luyke-goal-warehouse-select" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-2 gap-x-4 gap-y-3">
                <div>
                    <label for="luyke-goal-dtt" class="block text-sm font-medium text-gray-700">Target DT Th·ª±c</label>
                    <input type="number" id="luyke-goal-dtt" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="doanhThuThuc">
                </div>
                <div>
                    <label for="luyke-goal-dtqd" class="block text-sm font-medium text-gray-700">Target DT Qƒê</label>
                    <input type="number" id="luyke-goal-dtqd" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="doanhThuQD">
                </div>
            </div>

            <details class="declaration-group border rounded-lg overflow-hidden">
                <summary class="!py-3 !px-4 !text-sm !font-bold cursor-pointer hover:bg-gray-50">M·ª•c ti√™u khai th√°c (%)</summary>
                <div class="declaration-content !pt-4 !pb-4 !px-4 bg-gray-50 border-t grid grid-cols-2 md:grid-cols-2 gap-x-4 gap-y-3">
                    <div>
                        <label for="luyke-goal-ptqd" class="block text-sm font-medium text-gray-700">% Quy ƒë·ªïi</label>
                        <input type="number" id="luyke-goal-ptqd" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramQD">
                    </div>
                    <div>
                        <label for="luyke-goal-pttc" class="block text-sm font-medium text-gray-700">% Tr·∫£ ch·∫≠m</label>
                         <input type="number" id="luyke-goal-pttc" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramTC">
                    </div>
                    <div>
                        <label for="luyke-goal-giadung" class="block text-sm font-medium text-gray-700">% Gia d·ª•ng</label>
                        <input type="number" id="luyke-goal-giadung" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramGiaDung">
                    </div>
                    <div>
                        <label for="luyke-goal-mln" class="block text-sm font-medium text-gray-700">% MLN</label>
                        <input type="number" id="luyke-goal-mln" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramMLN">
                    </div>
                    <div>
                        <label for="luyke-goal-phukien" class="block text-sm font-medium text-gray-700">% Ph·ª• ki·ªán</label>
                        <input type="number" id="luyke-goal-phukien" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramPhuKien">
                    </div>
                    <div>
                        <label for="luyke-goal-baohiem" class="block text-sm font-medium text-gray-700">% B·∫£o hi·ªÉm</label>
                        <input type="number" id="luyke-goal-baohiem" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramBaoHiem">
                    </div>
                    <div>
                        <label for="luyke-goal-sim" class="block text-sm font-medium text-gray-700">% Sim</label>
                        <input type="number" id="luyke-goal-sim" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramSim">
                    </div>
                    <div>
                         <label for="luyke-goal-vas" class="block text-sm font-medium text-gray-700">% VAS</label>
                        <input type="number" id="luyke-goal-vas" class="luyke-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramVAS">
                    </div>
                </div>
            </details>
            </div>
        <div id="goal-tab-daily" class="sub-tab-content hidden space-y-4">
            <div>
                <label for="rt-goal-warehouse-select" class="block text-sm font-medium text-gray-700 mb-1">Thi·∫øt l·∫≠p cho kho</label>
                <select id="rt-goal-warehouse-select" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select>
            </div>
            <div class="grid grid-cols-2 gap-4 items-end">
                <div class="flex items-center gap-x-2">
                     <label for="rt-open-hour" class="font-medium text-gray-700 text-sm">M·ªü c·ª≠a:</label>
                    <input type="time" id="rt-open-hour" class="rt-setting-input p-1 border border-gray-300 rounded-md shadow-sm w-24">
                </div>
                <div class="flex items-center gap-x-2">
                    <label for="rt-close-hour" class="font-medium text-gray-700 text-sm">ƒê√≥ng c·ª≠a:</label>
                    <input type="time" id="rt-close-hour" class="rt-setting-input p-1 border border-gray-300 rounded-md shadow-sm w-24">
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-2 gap-x-4 gap-y-3">
                <div>
                    <label for="rt-goal-dtt" class="block text-sm font-medium text-gray-700">DT Th·ª±c (tri·ªáu)</label>
                    <input type="number" id="rt-goal-dtt" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="doanhThuThuc">
                </div>
                <div>
                    <label for="rt-goal-dtqd" class="block text-sm font-medium text-gray-700">DT Qƒê (tri·ªáu)</label>
                    <input type="number" id="rt-goal-dtqd" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="doanhThuQD">
                </div>
            </div>

            <details class="declaration-group border rounded-lg overflow-hidden">
                <summary class="!py-3 !px-4 !text-sm !font-bold cursor-pointer hover:bg-gray-50">M·ª•c ti√™u khai th√°c (%)</summary>
                <div class="declaration-content !pt-4 !pb-4 !px-4 bg-gray-50 border-t grid grid-cols-2 md:grid-cols-2 gap-x-4 gap-y-3">
                    <div>
                        <label for="rt-goal-ptqd" class="block text-sm font-medium text-gray-700">% Quy ƒë·ªïi</label>
                         <input type="number" id="rt-goal-ptqd" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramQD">
                    </div>
                    <div>
                        <label for="rt-goal-pttc" class="block text-sm font-medium text-gray-700">% Tr·∫£ ch·∫≠m</label>
                         <input type="number" id="rt-goal-pttc" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramTC">
                    </div>
                    <div>
                        <label for="rt-goal-giadung" class="block text-sm font-medium text-gray-700">% Gia d·ª•ng</label>
                        <input type="number" id="rt-goal-giadung" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramGiaDung">
                    </div>
                    <div>
                        <label for="rt-goal-mln" class="block text-sm font-medium text-gray-700">% MLN</label>
                        <input type="number" id="rt-goal-mln" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramMLN">
                    </div>
                    <div>
                        <label for="rt-goal-phukien" class="block text-sm font-medium text-gray-700">% Ph·ª• ki·ªán</label>
                        <input type="number" id="rt-goal-phukien" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramPhuKien">
                    </div>
                    <div>
                        <label for="rt-goal-sim" class="block text-sm font-medium text-gray-700">% Sim</label>
                        <input type="number" id="rt-goal-sim" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramSim">
                    </div>
                    <div>
                         <label for="rt-goal-vas" class="block text-sm font-medium text-gray-700">% VAS</label>
                        <input type="number" id="rt-goal-vas" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramVAS">
                    </div>
                    <div>
                        <label for="rt-goal-baohiem" class="block text-sm font-medium text-gray-700">% B·∫£o hi·ªÉm</label>
                        <input type="number" id="rt-goal-baohiem" class="rt-goal-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" data-goal="phanTramBaoHiem">
                    </div>
                </div>
            </details>
            </div>
    </div>

    <div class="border-t pt-6 mt-6">
        <div id="special-program-manager" class="space-y-4 mb-6">
            <h4 class="text-md font-bold text-gray-800 mb-3">Qu·∫£n l√Ω SP ƒê·∫∑c Quy·ªÅn (To√†n h·ªá th·ªëng)</h4>
            
            <div id="special-program-list-container" class="space-y-2 mb-4">
                <p class="text-xs text-center text-gray-500 italic">Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh SPƒêQ n√†o ƒë∆∞·ª£c t·∫°o.</p>
            </div>

            </div>
        
        <div id="goal-tab-competition" class="space-y-4 border-t pt-6 mt-6">
            <h4 class="text-md font-bold text-gray-800 mb-3">Qu·∫£n l√Ω Ch∆∞∆°ng tr√¨nh Thi ƒëua (T√πy ch·ªânh)</h4>
            <div id="competition-list-container" class="space-y-2 mb-4">
            </div>
            <form id="competition-form" class="p-4 bg-slate-50 border rounded-lg space-y-3 hidden">
                <input type="hidden" id="competition-id">
                <div>
                    <label for="competition-name" class="block text-sm font-medium text-gray-700">T√™n ch∆∞∆°ng tr√¨nh</label>
                    <input type="text" id="competition-name" class="mt-1 block w-full p-2 border rounded-md" placeholder="VD: Thi ƒëua TV Sony T9">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="competition-brand" class="block text-sm font-medium text-gray-700">H√£ng s·∫£n xu·∫•t</label>
                        <select id="competition-brand" multiple class="mt-1 block w-full"></select>
                    </div>
                    <div>
                        <label for="competition-group" class="block text-sm font-medium text-gray-700">Nh√≥m h√†ng</label>
                        <select id="competition-group" multiple class="mt-1 block w-full"></select>
                    </div>
                </div>
                <div>
                    <label for="competition-type" class="block text-sm font-medium text-gray-700">Lo·∫°i ƒëo l∆∞·ªùng</label>
                    <select id="competition-type" class="mt-1 block w-full p-2 border rounded-md">
                         <option value="doanhthu">Theo Doanh thu</option>
                        <option value="soluong">Theo S·ªë l∆∞·ª£ng</option>
                    </select>
                </div>
                <div id="price-segment" class="hidden grid grid-cols-2 gap-4">
                    <div>
                        <label for="competition-min-price" class="block text-sm font-medium text-gray-700">Gi√° t·ª´ (tri·ªáu)</label>
                        <input type="number" id="competition-min-price" class="mt-1 block w-full p-2 border rounded-md" placeholder="VD: 3 (cho 3 tri·ªáu)">
                    </div>
                     <div>
                         <label for="competition-max-price" class="block text-sm font-medium text-gray-700">Gi√° ƒë·∫øn (tri·ªáu)</label>
                        <input type="number" id="competition-max-price" class="mt-1 block w-full p-2 border rounded-md" placeholder="VD: 5 (cho 5 tri·ªáu)">
                    </div>
                </div>
                <div class="flex items-center">
                     <input id="competition-exclude-apple" type="checkbox" class="h-4 w-4 rounded border-gray-300">
                    <label for="competition-exclude-apple" class="ml-2 block text-sm text-gray-900">Tr·ª´ h√£ng Apple kh·ªèi d·ªØ li·ªáu so s√°nh</label>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="cancel-competition-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">H·ªßy</button>
                    <button type="submit" id="save-competition-btn" class="px-4 py-2 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700">L∆∞u</button>
                </div>
            </form>
            <button id="add-competition-btn" class="mt-2 w-full text-sm py-2 px-4 border-2 border-dashed rounded-lg hover:bg-slate-50">
                + Th√™m ch∆∞∆°ng tr√¨nh m·ªõi
            </button>
        </div>
    </div>
</div>
`;

export const drawerGoal = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = drawerGoalHTML;
        }
    }
};
--- END FILE: ./components/drawer-goal.js ---

--- START FILE: ./components/drawer-interface.js ---
// Version 1.1 - Update font size slider range and default value
// Ch·ª©a m√£ HTML cho drawer c√†i ƒë·∫∑t giao di·ªán.

const drawerInterfaceHTML = `
<div id="interface-drawer" class="settings-drawer fixed top-0 left-0 h-full bg-white shadow-2xl z-50 p-6 overflow-y-auto hidden">
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800">C√†i ƒë·∫∑t giao di·ªán</h3>
        <button class="close-drawer-btn text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
    </div>
    <div class="space-y-6">
        <div>
            <label for="contrast-selector-drawer" class="block text-sm font-medium text-gray-700 mb-2">ƒê·ªô t∆∞∆°ng ph·∫£n</label>
            <select id="contrast-selector-drawer" class="contrast-selector w-full p-2 border rounded-lg text-sm bg-white shadow-sm">
                <option value="1">R·∫•t nh·∫π</option>
                <option value="2">Nh·∫π</option>
                <option value="3" selected>B√¨nh th∆∞·ªùng</option>
                <option value="4">Cao</option>
                <option value="5">R·∫•t cao</option>
                <option value="6">Cao nh·∫•t</option>
            </select>
        </div>
        <div>
            <label for="global-font-size-slider" class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                <span>C·ª° ch·ªØ to√†n trang</span>
                <span id="global-font-size-value" class="font-bold text-blue-600">18px</span>
            </label>
            <input type="range" id="global-font-size-slider" min="12" max="25" step="1" value="18" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
        </div>
        <div>
             <label for="kpi-font-size-slider" class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                <span>C·ª° ch·ªØ th·∫ª KPI</span>
                <span id="kpi-font-size-value" class="font-bold text-blue-600">36px</span>
            </label>
            <input type="range" id="kpi-font-size-slider" min="24" max="48" step="2" value="36" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
        </div>
        <div>
            <h4 class="text-sm font-medium text-gray-700 mb-2">M√†u s·∫Øc th·∫ª KPI</h4>
            <div class="grid grid-cols-2 gap-4">
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-1" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#38bdf8">
                    <label for="kpi-color-1" class="text-sm">Th·∫ª 1</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-2" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#34d399">
                    <label for="kpi-color-2" class="text-sm">Th·∫ª 2</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-3" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#fbbf24">
                    <label for="kpi-color-3" class="text-sm">Th·∫ª 3</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-4" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#2dd4bf">
                    <label for="kpi-color-4" class="text-sm">Th·∫ª 4</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-5" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#a78bfa">
                    <label for="kpi-color-5" class="text-sm">Th·∫ª 5</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-6" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#f472b6">
                    <label for="kpi-color-6" class="text-sm">Th·∫ª 6</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-7" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#818cf8">
                    <label for="kpi-color-7" class="text-sm">Th·∫ª 7</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-color-8" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#f87171">
                    <label for="kpi-color-8" class="text-sm">Th·∫ª 8</label>
                </div>
            </div>
        </div>
         <div>
            <h4 class="text-sm font-medium text-gray-700 mb-2">M√†u ch·ªØ th·∫ª KPI</h4>
             <div class="space-y-2">
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-title-color" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#ffffff">
                    <label for="kpi-title-color" class="text-sm">Ti√™u ƒë·ªÅ th·∫ª</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-main-color" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#ffffff">
                    <label for="kpi-main-color" class="text-sm">Gi√° tr·ªã ch√≠nh</label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="color" id="kpi-sub-color" class="kpi-color-input p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg" value="#ffffff">
                    <label for="kpi-sub-color" class="text-sm">Gi√° tr·ªã ph·ª•</label>
                </div>
            </div>
        </div>
    </div>
</div>
`;

export const drawerInterface = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = drawerInterfaceHTML;
        }
    }
};
--- END FILE: ./components/drawer-interface.js ---

--- START FILE: ./components/modal-admin.js ---
// Version 1.0 - Component: Admin Modal
// Ch·ª©a m√£ HTML cho modal y√™u c·∫ßu m·∫≠t kh·∫©u admin.

const modalAdminHTML = `
<div id="admin-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-4">
        <h3 class="text-lg font-bold mb-4">Truy c·∫≠p khu v·ª±c Admin</h3>
        <p class="text-sm text-gray-600 mb-4">Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ xem v√† ch·ªânh s·ª≠a ph·∫ßn Khai b√°o.</p>
        <input type="password" id="admin-password-input" class="w-full p-2 border rounded-lg mb-2" placeholder="M·∫≠t kh·∫©u...">
        <p id="admin-error-msg" class="text-red-500 text-sm mb-4 hidden">M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng. Vui l√≤ng th·ª≠ l·∫°i.</p>
        <div class="flex justify-end space-x-3">
            <button id="admin-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">H·ªßy</button>
            <button id="admin-submit-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">X√°c nh·∫≠n</button>
        </div>
    </div>
</div>
`;

export const modalAdmin = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalAdminHTML;
        }
    }
};
--- END FILE: ./components/modal-admin.js ---

--- START FILE: ./components/modal-chart.js ---
// Version 1.0 - Component: Chart Modal
// Ch·ª©a m√£ HTML cho modal hi·ªÉn th·ªã bi·ªÉu ƒë·ªì chi ti·∫øt.

const modalChartHTML = `
<div id="chart-modal" class="modal hidden">
    <div class="modal__overlay" data-close-modal></div>
    <div class="modal__container modal__container--large">
         <div class="modal__header">
            <h3 id="chart-modal-title" class="modal__title"></h3>
            <button class="modal__close-btn" data-close-modal>&times;</button>
        </div>
        <div class="modal__content">
            <canvas id="top10-chart"></canvas>
        </div>
    </div>
</div>
`;

export const modalChart = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalChartHTML;
        }
    }
};
--- END FILE: ./components/modal-chart.js ---

--- START FILE: ./components/modal-composer.js ---
// Version 1.0 - Component: Composer Modal
// Ch·ª©a m√£ HTML cho modal Tr√¨nh t·∫°o Nh·∫≠n x√©t.

const modalComposerHTML = `
<div id="composer-modal" class="modal hidden">
    <div class="modal__overlay" data-close-modal></div>
    <div class="modal__container modal__container--large">
        <div class="modal__header">
            <h3 id="composer-modal-title" class="modal__title">Tr√¨nh t·∫°o Nh·∫≠n x√©t</h3>
            <button class="modal__close-btn" data-close-modal>&times;</button>
        </div>
        <div id="composer-modal-content" class="modal__content">
            <div class="composer">
                <div class="composer__editor">
                    <label class="composer__label">N·ªôi dung nh·∫≠n x√©t</label>
                    <nav id="composer-context-tabs" class="composer__nav mb-2"></nav>
                    <div id="composer-context-content">
                        </div>
                </div>
                <div class="composer__tags">
                    <div class="composer__nav">
                        <button class="composer__tab-btn active" data-tab="tab-general">Chung & Icons</button>
                        <button class="composer__tab-btn" data-tab="tab-kpi">KPIs Si√™u Th·ªã</button>
                        <button class="composer__tab-btn" data-tab="tab-ranking">X·∫øp H·∫°ng NV</button>
                        <button class="composer__tab-btn" data-tab="tab-details">Thi ƒêua & Chi Ti·∫øt</button>
                    </div>

                    <div class="composer__content">
                        <div class="composer__tab-pane active" id="tab-general">
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">Chung</h5>
                                <button class="composer__tag-btn" data-tag="[NGAY]">Ng√†y</button>
                                <button class="composer__tag-btn" data-tag="[GIO]">Gi·ªù</button>
                            </div>
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">Bi·ªÉu t∆∞·ª£ng (Icons)</h5>
                                <button class="composer__icon-btn">üìä</button>
                                <button class="composer__icon-btn">üí∞</button>
                                <button class="composer__icon-btn">üí•</button>
                                <button class="composer__icon-btn">üéØ</button>
                                <button class="composer__icon-btn">üìà</button>
                                <button class="composer__icon-btn">üì¶</button>
                                <button class="composer__icon-btn">‚ö†Ô∏è</button>
                                <button class="composer__icon-btn">üî•</button>
                                <button class="composer__icon-btn">‚úÖ</button>
                            </div>
                        </div>

                        <div class="composer__tab-pane" id="tab-kpi">
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">KPIs Ch√≠nh</h5>
                                <button class="composer__tag-btn" data-tag="[DT_THUC]">DT Th·ª±c</button>
                                <button class="composer__tag-btn" data-tag="[DTQD]">DT Quy ƒë·ªïi</button>
                                <button class="composer__tag-btn" data-tag="[%HT_DTT]">%HT DT Th·ª±c</button>
                                <button class="composer__tag-btn" data-tag="[%HT_DTQD]">%HT DT Qƒê</button>
                                <button class="composer__tag-btn" data-tag="[TLQD]">T·ª∑ l·ªá Quy ƒë·ªïi</button>
                                <button class="composer__tag-btn" data-tag="[DT_CHUAXUAT]">DTQƒê Ch∆∞a Xu·∫•t</button>
                                <button class="composer__tag-btn" data-tag="[SS_CUNGKY]">TƒÉng/gi·∫£m C√πng k·ª≥</button>
                            </div>
                        </div>

                        <div class="composer__tab-pane" id="tab-ranking">
                            <div class="composer__filter-group">
                                <label for="composer-dept-filter" class="composer__label">L·ªçc theo b·ªô ph·∫≠n:</label>
                                <select id="composer-dept-filter" class="composer__select">
                                    <option value="ALL">To√†n si√™u th·ªã</option>
                                </select>
                            </div>
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">X·∫øp h·∫°ng DT Quy ƒê·ªïi</h5>
                                <button class="composer__tag-btn" data-tag-template="[TOP3_DTQD_{dept}@msnv]">Top 3</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT3_DTQD_{dept}@msnv]">Bot 3</button>
                            </div>
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">X·∫øp h·∫°ng Thu Nh·∫≠p</h5>
                                <button class="composer__tag-btn" data-tag-template="[TOP3_THUNHAP_{dept}@msnv]">Top 3</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT3_THUNHAP_{dept}@msnv]">Bot 3</button>
                            </div>
                             <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">X·∫øp h·∫°ng T·ª∑ l·ªá Quy ƒë·ªïi</h5>
                                <button class="composer__tag-btn" data-tag-template="[TOP3_TLQD_{dept}@msnv]">Top 3</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT3_TLQD_{dept}@msnv]">Bot 3</button>
                            </div>
                            <div class="composer__tag-group">
                                <h5 class="composer__tag-group-title">NV D∆∞·ªõi M·ª•c Ti√™u Khai B√°o</h5>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_TLQD_{dept}@msnv]">% Quy ƒë·ªïi</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_TLTC_{dept}@msnv]">% Tr·∫£ ch·∫≠m</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_PK_{dept}@msnv]">% Ph·ª• ki·ªán</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_GD_{dept}@msnv]">% Gia d·ª•ng</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_MLN_{dept}@msnv]">% MLN</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_SIM_{dept}@msnv]">% Sim</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_VAS_{dept}@msnv]">% VAS</button>
                                <button class="composer__tag-btn" data-tag-template="[BOT_TARGET_BH_{dept}@msnv]">% B·∫£o hi·ªÉm</button>
                            </div>
                            </div>
                        
                        <div class="composer__tab-pane" id="tab-details">
                            <div class="composer__sub-nav">
                                <button class="composer__sub-tab-btn active" data-sub-tab="sub-tab-thidua">Thi ƒêua</button>
                                <button class="composer__sub-tab-btn" data-sub-tab="sub-tab-qdc">Nh√≥m QƒêC</button>
                                <button class="composer__sub-tab-btn" data-sub-tab="sub-tab-nganhhang">Ng√†nh H√†ng</button>
                            </div>
                            <div class="composer__sub-content">
                                <div class="composer__sub-tab-pane active" id="sub-tab-thidua">
                                    <div class="composer__tag-group">
                                        <h5 class="composer__tag-group-title">Thi ƒêua Ng√†nh H√†ng</h5>
                                        <button class="composer__tag-btn" data-tag="[TD_TONG_CT]">T·ªïng CT</button>
                                        <button class="composer__tag-btn" data-tag="[TD_CT_DAT]">>100%</button>
                                        <button class="composer__tag-btn" data-tag="[TD_CT_CHUADAT]"><100%</button>
                                        <button class="composer__tag-btn" data-tag="[TD_TYLE_DAT]">% ƒê·∫°t</button>
                                    </div>
                                </div>
                                <div class="composer__sub-tab-pane" id="sub-tab-qdc">
                                    <div id="composer-qdc-tags-container" class="composer__tag-group">
                                        <h5 class="composer__tag-group-title">Ch·ªçn Nh√≥m H√†ng QƒêC</h5>
                                    </div>
                                </div>
                                <div class="composer__sub-tab-pane" id="sub-tab-nganhhang">
                                    <div id="composer-nganhhang-tags-container" class="composer__tag-group">
                                        <h5 class="composer__tag-group-title">Ch·ªçn Ng√†nh H√†ng Chi Ti·∫øt</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal__footer">
            <button id="save-composer-template-btn" class="action-btn action-btn--save">L∆∞u m·∫´u</button>
            <button id="copy-composed-notification-btn" class="action-btn action-btn--copy">Xem tr∆∞·ªõc & Sao ch√©p</button>
        </div>
    </div>
</div>
`;

export const modalComposer = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalComposerHTML;
        }
    }
};
--- END FILE: ./components/modal-composer.js ---

--- START FILE: ./components/modal-customer-detail.js ---
// Version 1.2 - Add 'customer-accordion-luyke' class to fix font styling
// Ch·ª©a m√£ HTML cho modal b·∫≠t l√™n (popup) hi·ªÉn th·ªã chi ti·∫øt kh√°ch h√†ng.

const modalCustomerDetailHTML = `
<div id="customer-detail-modal" class="modal hidden">
    <div class="modal__overlay" data-close-modal></div>
    
    <div class="modal__container" style="max-width: 640px; max-height: 90vh;">
        <div class="modal__header">
            <h3 id="customer-detail-modal-title" class="modal__title">Chi ti·∫øt ƒê∆°n h√†ng theo Kh√°ch h√†ng</h3>
            <button class="modal__close-btn" data-close-modal>&times;</button>
        </div>
        
        <div class="modal__content !p-0">
            <div id="customer-detail-controls" class="p-3 border-b border-gray-200 bg-gray-50 sticky top-0 z-10">
                <span class="text-sm font-semibold mr-2">S·∫Øp x·∫øp theo:</span>
                <button class="px-3 py-1 text-xs font-medium rounded-full bg-gray-200" data-sort="totalRealRevenue" data-direction="desc">
                    Doanh thu (Cao &gt; Th·∫•p)
                </button>
                <button class="px-3 py-1 text-xs font-medium rounded-full bg-gray-200 ml-2" data-sort="conversionRate" data-direction="desc">
                    % Quy ƒë·ªïi (Cao &gt; Th·∫•p)
                </button>
            </div>
            
            <div id="customer-detail-list-container" class="p-3 customer-accordion-luyke" style="max-height: calc(90vh - 180px); overflow-y: auto;">
            <p class="text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu kh√°ch h√†ng...</p>
            </div>
        </div>
        
        <div class="modal__footer">
            <button class="action-btn action-btn--copy" data-close-modal>
                ƒê√≥ng
            </button>
        </div>
    </div>
</div>
`;

export const modalCustomerDetail = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalCustomerDetailHTML;
        }
    }
};
--- END FILE: ./components/modal-customer-detail.js ---

--- START FILE: ./components/modal-force-update.js ---
// Version 1.1 - Add container for update notes
// MODULE: COMPONENTS - FORCE UPDATE MODAL
// Ch·ª©a m√£ HTML cho modal y√™u c·∫ßu ng∆∞·ªùi d√πng c·∫≠p nh·∫≠t phi√™n b·∫£n.

const modalForceUpdateHTML = `
<div id="force-update-modal" class="modal hidden">
    <div class="modal__overlay" style="cursor: not-allowed;"></div>
    <div class="modal__container" style="max-width: 500px;">
        <div class="modal__header">
            <h3 id="force-update-title" class="modal__title">üì¢ ƒê√£ c√≥ phi√™n b·∫£n m·ªõi!</h3>
        </div>
        <div class="modal__content">
            <p class="text-gray-600 mb-4">M·ªôt phi√™n b·∫£n m·ªõi v·ªõi c√°c b·∫£n s·ª≠a l·ªói v√† c·∫£i ti·∫øn ƒë√£ s·∫µn s√†ng. Vui l√≤ng t·∫£i l·∫°i trang ƒë·ªÉ ti·∫øp t·ª•c.</p>
            
            <div id="update-notes-container" class="my-4 p-3 bg-gray-50 border border-gray-200 rounded-lg max-h-48 overflow-y-auto">
                <p class="text-sm text-gray-500">ƒêang t·∫£i chi ti·∫øt...</p>
            </div>
            <button id="force-reload-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition text-lg">
                C·∫≠p nh·∫≠t ngay
            </button>
        </div>
    </div>
</div>
`;

export const modalForceUpdate = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalForceUpdateHTML;
        }
    }
};
--- END FILE: ./components/modal-force-update.js ---

--- START FILE: ./components/modal-help.js ---
// Version 1.0 - Component: Help Modal
// Ch·ª©a m√£ HTML cho modal hi·ªÉn th·ªã n·ªôi dung h∆∞·ªõng d·∫´n.

const modalHelpHTML = `
<div id="help-modal" class="modal hidden">
    <div class="modal__overlay" data-close-modal></div>
    <div class="modal__container">
        <div class="modal__header">
            <h3 id="help-modal-title" class="modal__title"></h3>
            <button class="modal__close-btn" data-close-modal>&times;</button>
        </div>
        <div id="help-modal-content" class="modal__content">
        </div>
    </div>
</div>
`;

export const modalHelp = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalHelpHTML;
        }
    }
};
--- END FILE: ./components/modal-help.js ---

--- START FILE: ./components/modal-login.js ---
// Version 1.2 - Add logging to render function
// Ch·ª©a m√£ HTML cho modal y√™u c·∫ßu email ng∆∞·ªùi d√πng khi truy c·∫≠p l·∫ßn ƒë·∫ßu.

const modalLoginHTML = `
<div id="login-modal" class="modal hidden">
    <div class="modal__overlay" style="cursor: not-allowed;"></div>
    <div class="modal__container" style="max-width: 420px;">
        <div class="modal__header">
            <h3 class="modal__title">Ch√†o m·ª´ng ƒë·∫øn v·ªõi C√¥ng c·ª• Ph√¢n t√≠ch</h3>
        </div>
        <div class="modal__content">
            <p class="text-gray-600 mb-4">Vui l√≤ng nh·∫≠p email c·ªßa b·∫°n ƒë·ªÉ b·∫Øt ƒë·∫ßu s·ª≠ d·ª•ng. Email n√†y s·∫Ω ƒë∆∞·ª£c d√πng ƒë·ªÉ ƒë·ªãnh danh v√† ƒë·ªìng b·ªô d·ªØ li·ªáu trong t∆∞∆°ng lai.</p>
            <div class="space-y-4">
                <div>
                    <label for="login-email-input" class="block text-sm font-medium text-gray-700 mb-1">Email c·ªßa b·∫°n</label>
                    <input type="email" id="login-email-input" class="w-full p-2 border rounded-lg" placeholder="your.email@example.com">
                    <p id="login-error-msg" class="text-red-500 text-sm mt-1 hidden">Vui l√≤ng nh·∫≠p m·ªôt ƒë·ªãa ch·ªâ email h·ª£p l·ªá.</p>
                </div>
                <button id="login-submit-btn" class="w-full bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-blue-700 transition text-base">
                    X√°c nh·∫≠n & Ti·∫øp t·ª•c
                </button>
            </div>
        </div>
    </div>
</div>
`;

export const modalLogin = {
    async render(containerSelector) {
        console.log(`[modalLogin.render] Attempting to render into: ${containerSelector}`); // Log m·ªõi
        const container = document.querySelector(containerSelector);
        if (container) {
            console.log(`[modalLogin.render] Container found. Setting innerHTML.`); // Log m·ªõi
            container.innerHTML = modalLoginHTML;
            console.log(`[modalLogin.render] innerHTML set. Waiting for next tick.`); // Log m·ªõi
            // Return a promise that resolves after the next tick, ensuring DOM update
            return new Promise(resolve => setTimeout(() => {
                console.log(`[modalLogin.render] Next tick resolved.`); // Log m·ªõi
                resolve();
            }, 0));
        } else {
            console.error(`[modalLogin.render] Container ${containerSelector} NOT FOUND.`); // Log l·ªói m·ªõi
        }
        // Return a resolved promise if container not found to avoid breaking await
        return Promise.resolve();
    }
};
--- END FILE: ./components/modal-login.js ---

--- START FILE: ./components/modal-preview.js ---
// Version 1.0 - Component: Preview Modal
// Ch·ª©a m√£ HTML cho modal xem tr∆∞·ªõc n·ªôi dung nh·∫≠n x√©t.

const modalPreviewHTML = `
<div id="preview-modal" class="modal hidden">
    <div class="modal__overlay" data-close-modal></div>
    <div class="modal__container">
        <div class="modal__header">
            <h3 id="preview-modal-title" class="modal__title">Xem tr∆∞·ªõc n·ªôi dung</h3>
            <button class="modal__close-btn" data-close-modal>&times;</button>
        </div>
        <div class="modal__content">
            <pre id="preview-modal-content" class="preview-content"></pre>
        </div>
        <div class="modal__footer">
            <button id="copy-from-preview-btn" class="action-btn action-btn--copy">Sao ch√©p n·ªôi dung</button>
        </div>
    </div>
</div>
`;

export const modalPreview = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalPreviewHTML;
        }
    }
};
--- END FILE: ./components/modal-preview.js ---

--- START FILE: ./components/modal-selection.js ---
// Version 1.0 - Component: Selection Modal
// Ch·ª©a m√£ HTML cho modal t√πy ch·ªânh hi·ªÉn th·ªã chung.

const modalSelectionHTML = `
<div id="selection-modal" class="modal hidden">
    <div class="modal__overlay" data-close-modal></div>
    <div class="modal__container">
        <div class="modal__header">
            <h3 id="selection-modal-title" class="modal__title">T√πy ch·ªânh hi·ªÉn th·ªã</h3>
            <button class="modal__close-btn" data-close-modal>&times;</button>
        </div>
        <div class="modal__content">
            <input type="text" id="selection-modal-search" class="w-full p-2 border rounded-md mb-4" placeholder="T√¨m ki·∫øm m·ª•c...">
            <div id="selection-modal-list" class="space-y-2 max-h-64 overflow-y-auto">
                </div>
        </div>
        <div class="modal__footer">
            <button id="selection-modal-save-btn" class="action-btn action-btn--save">L∆∞u C√†i ƒê·∫∑t</button>
        </div>
    </div>
</div>
`;

export const modalSelection = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalSelectionHTML;
        }
    }
};
--- END FILE: ./components/modal-selection.js ---

--- START FILE: ./components/modal-unexported-detail.js ---
// Version 1.1 - Remove capture button from footer
// Ch·ª©a m√£ HTML cho modal b·∫≠t l√™n (popup) hi·ªÉn th·ªã chi ti·∫øt doanh thu ch∆∞a xu·∫•t.

const modalUnexportedDetailHTML = `
<div id="unexported-detail-modal" class="modal hidden">
    <div class="modal__overlay" data-close-modal></div>
    
    <div class="modal__container" style="max-width: 576px; max-height: 90vh;">
        <div class="modal__header">
            <h3 id="unexported-detail-modal-title" class="modal__title">Chi ti·∫øt Doanh thu Ch∆∞a xu·∫•t</h3>
            <button class="modal__close-btn" data-close-modal>&times;</button>
        </div>
        
        <div class="modal__content !p-0">
            <div id="unexported-detail-list-container" class="p-3 customer-accordion-luyke" style="max-height: calc(90vh - 180px); overflow-y: auto;">
                <p class="text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu ch∆∞a xu·∫•t...</p>
            </div>
        </div>
        
        <div class="modal__footer">
            <button class="action-btn action-btn--copy" data-close-modal>
                ƒê√≥ng
            </button>
        </div>
    </div>
</div>
`;

export const modalUnexportedDetail = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = modalUnexportedDetailHTML;
        }
    }
};
--- END FILE: ./components/modal-unexported-detail.js ---

--- START FILE: ./components/sidebar.js ---
// Version 1.4 - Add font-semibold to all nav links for consistency
// Version 1.3 - Optimize HTML for better icon/text alignment
// Ch·ª©a m√£ HTML v√† logic cho thanh ƒëi·ªÅu h∆∞·ªõng b√™n.

const sidebarHTML = `
<nav id="sidebar" class="bg-white/80 backdrop-blur-sm shadow-lg fixed top-0 left-0 h-full z-30 p-3 flex flex-col justify-between">
    <div>
         <a href="#home-section" class="nav-link flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold mb-4">
            <i data-feather="home"></i>
            <span class="menu-text">H∆∞·ªõng D·∫´n & G√≥p √ù</span>
        </a>
        <ul class="space-y-2">
            <li>
                <a href="#data-section" class="nav-link flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="file-text"></i>
                    <span class="menu-text">C·∫≠p nh·∫≠t d·ªØ li·ªáu</span>
                </a>
            </li>
            <li>
                <a href="#health-section" class="nav-link flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="activity"></i>
                    <span class="menu-text">S·ª©c kh·ªèe si√™u th·ªã</span>
                </a>
            </li>
            <li>
                <a href="#health-employee-section" class="nav-link flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="users"></i>
                    <span class="menu-text">S·ª©c kh·ªèe nh√¢n vi√™n</span>
                </a>
            </li>
            <li>
                <a href="#realtime-section" class="nav-link flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="trending-up"></i>
                    <span class="menu-text">Doanh thu realtime</span>
                </a>
            </li>
        </ul>
    </div>
    <div>
        <ul class="space-y-2">
            <li>
                <button id="interface-settings-btn" class="w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="settings"></i>
                    <span class="menu-text">C√†i ƒë·∫∑t giao di·ªán</span>
                </button>
            </li>
            <li>
                <button id="goal-settings-btn" class="w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="target"></i>
                    <span class="menu-text">Thi·∫øt l·∫≠p m·ª•c ti√™u</span>
                </button>
            </li>
            <li>
                <button id="admin-access-btn" class="w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold">
                    <i data-feather="edit"></i>
                    <span class="menu-text">Khai b√°o</span>
                </button>
            </li>
        </ul>
    </div>
</nav>
`;

export const sidebar = {
    render(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (container) {
            container.innerHTML = sidebarHTML;
        }
    }
};
--- END FILE: ./components/sidebar.js ---

--- START FILE: ./config.js ---
// Version 2.2 - New Features & Refinements
// MODULE 1: T·ª¶ C·∫§U H√åNH (CONFIG)
// File n√†y ch·ª©a t·∫•t c·∫£ c√°c c·∫•u h√¨nh tƒ©nh c·ªßa ·ª©ng d·ª•ng.

const config = {
    ADMIN_PASSWORD: "Linh3031",
    COLUMN_MAPPINGS: {
        danhsachnv: {
            maKho: { required: true, displayName: 'M√£ Kho', aliases: ['m√£ kho', 'makho', 'kho'] },
            maNV: { required: true, displayName: 'M√£ Nh√¢n Vi√™n', aliases: ['m√£ nv', 'msnv', 'm√£ nh√¢n vi√™n', 'manv', 'm√£ s·ªë nh√¢n vi√™n'] },
            hoTen: { required: true, displayName: 'H·ªç v√† T√™n', aliases: ['h·ªç v√† t√™n', 't√™n nh√¢n vi√™n', 't√™n nv', 'h·ªç t√™n'] },
            boPhan: { required: true, displayName: 'B·ªô ph·∫≠n', aliases: ['b·ªô ph·∫≠n'] }
        },
        ycx: { // D√πng chung cho c·∫£ YCX l≈©y k·∫ø v√† YCX realtime
            ngayTao: { required: true, displayName: 'Ng√†y t·∫°o', aliases: ['ng√†y t·∫°o'] },
            ngayHenGiao: { required: false, displayName: 'Ng√†y h·∫πn giao', aliases: ['ng√†y h·∫πn giao'] },
            nguoiTao: { required: true, displayName: 'Ng∆∞·ªùi t·∫°o', aliases: ['ng∆∞·ªùi t·∫°o'] },
            thanhTien: { required: true, displayName: 'Gi√° b√°n', aliases: ['gi√° b√°n_1', 'gi√° b√°n'] },
            soLuong: { required: true, displayName: 'S·ªë l∆∞·ª£ng', aliases: ['sl b√°n', 's·ªë l∆∞·ª£ng'] },
            nhomHang: { required: true, displayName: 'Nh√≥m h√†ng', aliases: ['nh√≥m h√†ng'] },
            tenSanPham: { required: true, displayName: 'T√™n s·∫£n ph·∫©m', aliases: ['t√™n s·∫£n ph·∫©m'] },
            // ========== START: TH√äM M·ªöI ==========
            maSanPham: { required: true, displayName: 'M√£ s·∫£n ph·∫©m', aliases: ['m√£ s·∫£n ph·∫©m', 'masanpham', 'm√£ sp', 'product code'] },
            // ========== END: TH√äM M·ªöI ==========
            tenKhachHang: { required: true, displayName: 'T√™n kh√°ch h√†ng', aliases: ['t√™n kh√°ch h√†ng', 'tenkhachhang'] },
            nhaSanXuat: { required: true, displayName: 'Nh√† s·∫£n xu·∫•t', aliases: ['nh√† s·∫£n xu·∫•t', 'nhasanxuat'] },
            nganhHang: { required: true, displayName: 'Ng√†nh h√†ng', aliases: ['ng√†nh h√†ng'] },
            hinhThucXuat: { required: true, displayName: 'H√¨nh th·ª©c xu·∫•t', aliases: ['h√¨nh th·ª©c xu·∫•t'] },
            trangThaiThuTien: { required: true, displayName: 'Tr·∫°ng th√°i thu ti·ªÅn', aliases: ['tr·∫°ng th√°i thu ti·ªÅn'] },
            trangThaiHuy: { required: true, displayName: 'Tr·∫°ng th√°i h·ªßy', aliases: ['tr·∫°ng th√°i h·ªßy'] },
            tinhTrangTra: { required: true, displayName: 'T√¨nh tr·∫°ng tr·∫£', aliases: ['t√¨nh tr·∫°ng nh·∫≠p tr·∫£ c·ªßa s·∫£n ph·∫©m ƒë·ªïi v·ªõi s·∫£n ph·∫©m ch√≠nh', 't√¨nh tr·∫°ng tr·∫£'] },
            trangThaiXuat: { required: true, displayName: 'Tr·∫°ng th√°i xu·∫•t', aliases: ['tr·∫°ng th√°i xu·∫•t'] }
        },
        giocong: {
            maNV: { required: false, displayName: 'M√£ NV', aliases: ['m√£ nv', 'msnv'] },
            hoTen: { required: false, displayName: 'T√™n NV', aliases: ['t√™n nv', 'tennv'] },
            tongGioCong: { required: true, displayName: 'T·ªïng gi·ªù c√¥ng', aliases: ['t·ªïng gi·ªù c√¥ng (x.nh·∫≠n) total', 't·ªïng gi·ªù c√¥ng'] }
        },
        thuongnong: {
            maNV: { required: false, displayName: 'M√£ NV', aliases: ['manv', 'm√£ nv'] },
            hoTen: { required: false, displayName: 'T√™n NV', aliases: ['tennv', 't√™n nv'] },
            diemThuong: { required: true, displayName: 'ƒêi·ªÉm th∆∞·ªüng', aliases: ['diemthuong', 'ƒëi·ªÉm th∆∞·ªüng'] }
        }
    },
    PRODUCT_GROUPS: {
        ICT: ['1491', '931', '42'],
        CE: ['1097', '1098', '1099', '1094', '894'],
        PHU_KIEN: ['16', '1394', '184', '764'], // 16 - Ph·ª• ki·ªán ti·ªán √≠ch, 1394 - Ph·ª• ki·ªán l·∫Øp ƒë·∫∑t, 184 - Ph·ª• ki·ªán trang tr√≠, 764 - Loa vi t√≠nh
        GIA_DUNG: ['484', '1214'], // M√£ ng√†nh h√†ng Gia D·ª•ng
        MAY_LOC_NUOC: ['4171', '4172'], // M√£ nh√≥m h√†ng M√°y L·ªçc N∆∞·ªõc
        PIN_SDP: '12',
        CAMERA_TRONG_NHA: '6479',
        CAMERA_NGOAI_TROi: '4219',
        TAI_NGHE_BLT: '4540',
        NOI_CHIEN: '4099',
        ROBOT_HB: '4439',
        TIVI: '1094',
        TU_LANH: '1097',
        MAY_GIAT: '1099',
        MAY_LANH: '1098',
        DIEN_THOAI: ['13', '1491', '18'],
        LAPTOP: '42',
        SIM: ['1891', '664'],
        VAS: ['164', '571'],
        BAO_HIEM_VAS: ['4479', '4499'],
        SMARTPHONE: ['1491', '18', '13'],
        BAO_HIEM_DENOMINATOR: ['1491', '1097', '894', '1099', '1098', '42', '1094', '3859', '911', '893', '3659'],
        QDC_GROUPS: {
            PIN_SDP: { codes: ['12'], name: 'Pin SDP' },
            TAI_NGHE_BLT: { codes: ['3346', '4540'], name: 'Tai nghe BLT' },
            DONG_HO: { codes: ['4059', '4060', '4061', '4062', '4063', '4064', '4070'], name: 'ƒê·ªìng h·ªì' },
            CAMERA: { codes: ['4219', '6479'], name: 'Camera' },
            LOA: { codes: ['1031', '1351', '4779'], name: 'Loa' },
            UDDD: { codes: ['571', '611'], name: 'UDDƒê' },
            BAO_HIEM: { codes: ['4479', '4499'], name: 'B·∫£o hi·ªÉm' },
            NOI_COM: { codes: ['4157', '4158'], name: 'N·ªìi c∆°m ƒëi·ªán t·ª≠ + cao t·∫ßn' },
            NOI_CHIEN: { codes: ['4099'], name: 'N·ªìi chi√™n' },
            MAY_LOC_NUOC: { codes: ['4171', '4172'], name: 'M√°y l·ªçc n∆∞·ªõc' },
            ROBOT_HB: { codes: ['4439'], name: 'Robot h√∫t b·ª•i' },
            SIM_ONLINE: { codes: ['1891'], name: 'SIM' }
        }
    },
    DEPARTMENT_GROUPS: [
        'BP T∆∞ V·∫•n - ƒêM',
        'BP Trang Tr√≠ ki√™m Thu ng√¢n - Sim S·ªë - ƒêM',
        'BP Kho Ki√™m H·ªó Tr·ª£ K·ªπ Thu·∫≠t Xe ƒê·∫°p - ƒêM'
    ],
    DEFAULT_DATA: {
        HINH_THUC_XUAT_TINH_DOANH_THU: [
            'Xu·∫•t b√°n h√†ng t·∫°i si√™u th·ªã', 'Xu·∫•t cung ·ª©ng d·ªãch v·ª•',
            'Xu·∫•t b√°n pre-order t·∫°i si√™u th·ªã', 'Xu·∫•t SIM tr·∫Øng k√®m theo SIM',
            'Xu·∫•t b√°n h√†ng ∆∞u ƒë√£i cho nh√¢n vi√™n', 'Xu·∫•t b√°n h√†ng t·∫°i si√™u th·ªã (TCƒêM)',
            'Xu·∫•t d·ªãch v·ª• b·∫£o h√†nh tr·ªçn ƒë·ªùi', 'Xu·∫•t d·ªãch v·ª• b·∫£o d∆∞·ª°ng tr·ªçn ƒë·ªùi',
            'Xu·∫•t b√°n h√†ng tr·∫£ g√≥p t·∫°i si√™u th·ªã', 'Xu·∫•t b√°n tr·∫£ g√≥p ∆∞u ƒë√£i cho nh√¢n vi√™n',
            'Xu·∫•t b√°n tr·∫£ g√≥p cho NV ph·ª•c v·ª• c√¥ng vi·ªác', 'Xu·∫•t b√°n pre-order tr·∫£ g√≥p t·∫°i si√™u th·ªã',
            'Xu·∫•t b√°n pre-order tr·∫£ g√≥p t·∫°i si√™u th·ªã (TCƒêM)',
            'Xu·∫•t d·ªãch v·ª• thu h·ªô b·∫£o hi·ªÉm'
        ],
        HINH_THUC_XUAT_TRA_GOP: ['Xu·∫•t b√°n h√†ng tr·∫£ g√≥p t·∫°i si√™u th·ªã', 'Xu·∫•t b√°n tr·∫£ g√≥p ∆∞u ƒë√£i cho nh√¢n vi√™n', 'Xu·∫•t b√°n tr·∫£ g√≥p cho NV ph·ª•c v·ª• c√¥ng vi·ªác', 'Xu·∫•t b√°n pre-order tr·∫£ g√≥p t·∫°i si√™u th·ªã', 'Xu·∫•t b√°n pre-order tr·∫£ g√≥p t·∫°i si√™u th·ªã (TCƒêM)'],
        HE_SO_QUY_DOI: { '1098 - M√°y l·∫°nh (IMEI)': 1, '2011 - Khuy·∫øn m√£i - SP ·∫¢o': 1, '2511 - N·∫°p ti·ªÅn AirTime M_Service': 1, '2151 - Phi·∫øu mua h√†ng/Pre Order': 1, '971 - Th·∫ª c√†o ƒëi·ªán t·ª≠': 1, '431 - ·ªêp L∆∞ng - Flip Cover': 3.37, '2571 - Thu h·ªô c∆∞·ªõc Viettel': 1, '4519 - Thu H·ªô Ti·ªÅn Tr·∫£ G√≥p': 1, '2513 - Thu h·ªô Payoo': 1, '4302 - N√≥n b·∫£o hi·ªÉm c√°c lo·∫°i': 1.92, '2291 - Sim tr·∫Øng (Seri)': 1, '18 - ƒêi·ªán Tho·∫°i Di ƒê·ªông': 1, '4599 - Thu H·ªô Ti·ªÅn M·∫∑t': 1, '12 - Pin s·∫°c d·ª± ph√≤ng': 3.37, '571 - UDDƒê': 1, '58 - Mi·∫øng d√°n m·∫∑t sau': 3.37, '1231 - Mi·∫øng d√°n m·∫∑t tr∆∞·ªõc': 3.37, '1491 - Smartphone': 1, '1891 - Sim Online': 5.45, '4479 - D·ªãch V·ª• B·∫£o Hi·ªÉm': 4.18, '3359 - Ph·ª• ki·ªán ƒë·ªìng h·ªì': 3, '2391 - Smartwatch': 3, '911 - M√°y n∆∞·ªõc n√≥ng': 1, '4499 - Thu H·ªô Ph√≠ B·∫£o Hi·ªÉm': 4.18, '4142 - B√¨nh ƒëun si√™u t·ªëc': 1.85, '4153 - Xay Sinh t·ªë': 1.85, '15 - Tai nghe d√¢y': 3.37, '1412 - D·ªãch v·ª• b·∫£o tr√¨': 1, '3345 - C√°p': 3.37, '2312 - M√£ n·∫°p th·∫ª game': 1, '4900 - B√†n ph√≠m': 3.37, '4141 - B√†n ·ªßi kh√¥': 1.85, '4156 - N·ªìi c∆°m n·∫Øp g√†i/n·∫Øp r·ªùi': 1.85, '14 - S·∫°c/ Adapter': 3.37, '42 - Laptop': 1.2, '751 - Khuy·∫øn m√£i ba l√¥, t√∫i x√°ch': 1, '1031 - Loa di ƒë·ªông': 3.37, '4199 - Mi·∫øng D√°n K√≠nh': 3.37, '3346 - Tai Nghe Bluetooth': 3.37, '931 - M√°y t√≠nh b·∫£ng': 1.2, '19 - Khuy·∫øn m√£i ƒêTDƒê': 1, '10 - Chu·ªôt': 3.37, '4060 - ƒê·ªìng h·ªì Nam D√¢y da': 3, '880 - Loa Karaoke': 1.29, '851 - Khuy·∫øn m√£i ƒêi·ªán T·ª≠': 1, '4169 - L√µi l·ªçc': 1.85, '4540 - Tai Nghe Bluetooth - imei': 3.37, '4062 - ƒê·ªìng h·ªì N·ªØ D√¢y kim lo·∫°i': 3, '2831 - Ph·ª• ki·ªán Apple': 3.37, '2691 - B·ªô S·∫°c/C√°p/Adaptor (Gi√° R·∫ª)': 3.37, '1351 - Loa vi t√≠nh (imei)': 3.37, '1094 - Tivi LED (IMEI)': 1, '4324 - Khung treo, gi√° ƒë·ª°': 3.37, '1099 - M√°y gi·∫∑t (IMEI)': 1, '1097 - T·ªß l·∫°nh (IMEI)': 1, '4099 - N·ªìi chi√™n': 1.85, '4070 - ƒê·ªìng h·ªì Tr·∫ª em': 3, '967 - S·∫•y t√≥c': 1.85, '957 - L√≤ n∆∞·ªõng': 1.85, '958 - L√≤ vi s√≥ng': 1.85, '4158 - N·ªìi c∆°m ƒëi·ªán t·ª≠': 1.85, '3241 - Dao/K√©o/Th·ªõt': 1.92, '3240 - H·ªôp/H≈©': 1.92, '3265 - N·ªìi': 1.92, '4139 - ƒê√®n b√†n/ƒê√®n S·∫°c/ƒê√®n b·∫Øt mu·ªói': 1.85, '73 - Ph·ª• ki·ªán ƒëi·ªán m√°y': 3.37, '4171 - L·ªçc n∆∞·ªõc d·∫°ng t·ªß ƒë·ª©ng': 1.85, '3384 - ƒê·ªì ngh·ªÅ s·ª≠ d·ª•ng ƒëi·ªán': 1, '4147 - B·∫øp ƒëi·ªán ƒë∆°n': 1.85, '4063 - ƒê·ªìng h·ªì N·ªØ D√¢y da': 3, '3263 - Ch·∫£o': 1.92, '3185 - V·ªá sinh nh√† c·ª≠a': 1.92, '4143 - B√†n ·ªßi h∆°i n∆∞·ªõc ƒë·ª©ng': 1.85, '4146 - B·∫øp gas ƒë√¥i': 1.85, '1052 - Khuy·∫øn m√£i ƒêi·ªán L·∫°nh': 1, '3799 - Qu·∫°t ƒëi·ªÅu h√≤a': 1.85, '1951 - Software (s·ªë L∆∞·ª£ng)': 1, '6000 - M√°y √©p tr√°i c√¢y': 1.85, '4059 - ƒê·ªìng h·ªì Nam D√¢y kim lo·∫°i': 3, '4160 - Qu·∫°t b√†n/h·ªôp/s·∫°c': 1.85, '4162 - B√¨nh/Ca ƒë·ª±ng n∆∞·ªõc': 1.92, '4660 - Qu·∫°t l·ª≠ng': 1.85, '17 - Ph·ª• ki·ªán IT kh√°c': 3.37, '4145 - B·∫øp gas ƒë∆°n': 1.85, '875 - D√†n m√°y': 1, '1071 - Ph·ª• ki·ªán ƒëi·ªán t·ª≠': 3.37, '891 - Micro': 1, '4152 - ·ªî c·∫Øm ƒëi·ªán/v·ª£t mu·ªói': 1.85, '4154 - Xay √©p/Kh√°c': 1.85, '5975 - Balo T√∫i Ch·ªëng S·ªëc': 3.37, '893 - T·ªß ƒë√¥ng': 1, '2531 - Thu h·ªô Mservice': 1, '4019 - Sim tr·∫Øng ƒëi·ªán t·ª≠': 1, '4320 - ƒê·ªìng h·ªì - Khuy·∫øn m√£i mua': 1, '3187 - B√¨nh/Ly/Ca gi·ªØ nhi·ªát': 1.92, '4159 - Qu·∫°t ƒë·ª©ng': 1.85, '4157 - N·ªìi c∆°m cao t·∫ßn': 1.85, '16 - Th·∫ª Nh·ªõ': 3.37, '4140 - B√†n ·ªßi h∆°i n∆∞·ªõc': 1.85, '4150 - M√°y n∆∞·ªõc n√≥ng l·∫°nh': 1.85, '591 - Thay sim': 1, '2999 - D·ª•ng c·ª• nh√† b·∫øp kh√°c': 1.92, '4779 - Loa di ƒë·ªông - imei': 3.37, '4440 - G√≥i C∆∞·ªõc V√† D·ªãch V·ª• GTGT': 1, '4121 - M√°y B∆°m N∆∞·ªõc': 1, '4161 - Qu·∫°t treo': 1.85, '4961 - Qu·∫ßn b√≥ & legging n·ªØ Th·ªÉ Thao': 1, '4151 - √Åp su·∫•t/l·∫©u/chi√™n/n∆∞·ªõng': 1.85, '4144 - B·∫øp gas √¢m': 1.85, '871 - USB': 3.37, '6479 - Camera IP Trong nh√†': 3.37, '4219 - Camera IP Ngo√†i tr·ªùi': 3.37, '4659 - Ph·ª• ki·ªán ti·ªán √≠ch Apple': 3.37, '531 - Pin, 4095 - C√°p (Gi√° R·∫ª)': 3.37, '2791 - Kinh doanh m√πa v·ª•': 3.37, '2771 - Gi√° treo m√†n h√¨nh m√°y t√≠nh': 3.37, '80 - Khuy·∫øn m√£i Kh√°c': 1, '1131 - M√°y in, Fax': 2, '4125 - Smartband': 3, '743 - Qu·∫°t s∆∞·ªüi': 1.85, '4659 - Ph·ª• ki·ªán Apple - Imei': 3.37, '4064 - ƒê·ªìng h·ªì N·ªØ D√¢y kh√°c': 3, '956 - H√∫t b·ª•i': 1.85, '4172 - L·ªçc n∆∞·ªõc √¢m t·ªß/tr√™n b√†n': 1.85, '3779 - B·∫øp ƒëi·ªán √¢m': 1.85, '4061 - ƒê·ªìng h·ªì Nam D√¢y kh√°c': 3, '4067 - ƒê·ªìng h·ªì Unisex D√¢y kh√°c': 3, '1411 - D·ªãch v·ª• l·∫Øp ƒë·∫∑t': 1, '4149 - B√¨nh th·ªßy ƒëi·ªán': 1.85, '4148 - B·∫øp ƒëi·ªán ƒë√¥i': 1.85, '955 - H√∫t m√πi/ h√∫t kh√≥i': 1.85, '4699 - Gia d·ª•ng kh√¥ng ƒëi·ªán kh√°c': 1.92, '4859 - Xe ƒë·∫°p ƒë∆∞·ªùng ph·ªë c·ªï ƒëi·ªÉn': 1, '4759 - Ph·ª• Ki·ªán Xe ƒê·∫°p': 1, '2471 - Thu h·ªô c∆∞·ªõc VinaPhone': 1, '3719 - Qu·∫ßn d√†i n·ªØ Th·ªÉ Thao': 1, '1051 - Khuy·∫øn m√£i ƒêi·ªán gia d·ª•ng': 1, '3721 - Qu·∫ßn ng·∫Øn & v√°y n·ªØ Th·ªÉ Thao': 1, '410 - Ph·ª• ki·ªán TT kh√°c': 3.37, '4155 - H√∫t b·ª•i c√¢y': 1.85, '3563 - M√°y t√≠nh nguy√™n b·ªô': 1, '894 - T·ªß m√°t': 1, '3639 - M√°y l·ªçc kh√¥ng kh√≠': 1.85, '611 - ·ª®ng d·ª•ng PC & Laptop': 1, '4089 - ƒê·ªìng h·ªì Unisex D√¢y kim lo·∫°i': 3, '4439 - H√∫t B·ª•i Robot': 1.85, '3740 - √Åo T-shirt nam Th·ªÉ Thao': 1, '4339 - ·ªîn √Åp': 1, '4459 - Qu·∫°t Tr·∫ßn': 1.85, '2351 - Router - Imei': 3.37, '3159 - DV Internet v√† Truy·ªÅn h√¨nh thu ti·ªÅn': 1, '3659 - M√°y s·∫•y l·ªìng ngang': 1, '3519 - √Åo Bra Th·ªÉ Thao': 1, '3479 - Thi·∫øt b·ªã m·∫°ng kh√°c': 3.37, '3859 - M√°y r·ª≠a ch√©n': 1 }
        }
    };

// D√≤ng cu·ªëi c√πng n√†y r·∫•t quan tr·ªçng. N√≥ "xu·∫•t kh·∫©u" ƒë·ªëi t∆∞·ª£ng config 
// ƒë·ªÉ c√°c file JavaScript kh√°c c√≥ th·ªÉ "nh·∫≠p kh·∫©u" v√† s·ª≠ d·ª•ng.
export { config };
--- END FILE: ./config.js ---

--- START FILE: ./event-listeners/listeners-actions.js ---
// Version 1.3 - Add capture support for pasted competition detail view
// Version 1.2 - Make capture button context-aware (detail vs. summary)
// Version 1.0 - Refactored from ui-listeners.js
// MODULE: LISTENERS - ACTIONS
// Ch·ª©a logic ƒëƒÉng k√Ω s·ª± ki·ªán cho c√°c n√∫t h√†nh ƒë·ªông chung (Ch·ª•p ·∫£nh, Xu·∫•t Excel).

import { ui } from '../ui.js';
import { utils } from '../utils.js';
import { captureService } from '../modules/capture.service.js';
import { appState } from '../state.js'; // <-- ƒê√É TH√äM

export function initializeActionListeners() {
    ['luyke', 'sknv', 'realtime'].forEach(prefix => {
        const captureBtn = document.getElementById(`capture-${prefix}-btn`);
        if (captureBtn) {
            captureBtn.addEventListener('click', () => {
                const navId = prefix === 'luyke' ? 'luyke-subtabs-nav' : (prefix === 'sknv' ? 'employee-subtabs-nav' : 'realtime-subtabs-nav');
                const contentContainerId = prefix === 'luyke' ? 'luyke-subtabs-content' : (prefix === 'sknv' ? 'employee-subtabs-content' : 'realtime-subtabs-content');

                const activeTabButton = document.querySelector(`#${navId} .sub-tab-btn.active`);
                if (!activeTabButton) {
                    ui.showNotification('Kh√¥ng t√¨m th·∫•y tab ƒëang ho·∫°t ƒë·ªông.', 'error');
                    return;
                }
                
                // *** START: NEW LOGIC FOR DETAIL VIEW (v1.2) ***
                // Ki·ªÉm tra xem c√≥ ƒëang xem chi ti·∫øt nh√¢n vi√™n kh√¥ng
                if (prefix === 'sknv' && appState.viewingDetailFor) {
                    const { employeeId, sourceTab } = appState.viewingDetailFor;
                    const activeTabTarget = activeTabButton.dataset.target;

                    let elementToCapture = null;
                    let title = '';
                    const preset = 'preset-mobile-portrait';

                    if (sourceTab === 'sknv' && activeTabTarget === 'subtab-sknv') {
                        elementToCapture = document.getElementById('sknv-detail-capture-area');
                        title = `SKNV_ChiTiet_${employeeId}`;
                    } else if (sourceTab === 'dtnv-lk' && activeTabTarget === 'subtab-doanhthu-lk') {
                        elementToCapture = document.getElementById('dtnv-lk-capture-area');
                        title = `DTLK_ChiTiet_${employeeId}`;
                    }
                    // === START: Y√äU C·∫¶U 1 (v1.3) - Th√™m logic ch·ª•p chi ti·∫øt thi ƒëua ===
                    else if (sourceTab === 'sknv-thidua-pasted' && activeTabTarget === 'subtab-hieu-qua-thi-dua-lk') {
                        elementToCapture = document.getElementById('sknv-thidua-detail-capture-area');
                        title = `ThiDuaLK_ChiTiet_${employeeId}`;
                    }
                    // === END: Y√äU C·∫¶U 1 (v1.3) ===
                    // (B·∫°n c√≥ th·ªÉ th√™m logic cho 'dtnv-rt' ·ªü ƒë√¢y n·∫øu mu·ªën)
                    // else if (sourceTab === 'dtnv-rt' && activeTabTarget === 'subtab-realtime-nhan-vien') {
                    //     elementToCapture = document.getElementById('dtnv-rt-capture-area');
                    //     title = `DTRT_ChiTiet_${employeeId}`;
                    // }

                    if (elementToCapture) {
                        if (!elementToCapture || elementToCapture.children.length === 0) {
                            ui.showNotification('Kh√¥ng c√≥ n·ªôi dung chi ti·∫øt ƒë·ªÉ ch·ª•p.', 'error');
                            return;
                        }
                        // G·ªçi h√†m captureAndDownload (gi·ªëng logic c·ªßa n√∫t c≈© ƒë√£ b·ªã x√≥a)
                        captureService.captureAndDownload(elementToCapture, title, preset);
                        return; // D·ª´ng l·∫°i, ƒë√£ x·ª≠ l√Ω xong ph·∫ßn ch·ª•p chi ti·∫øt
                    }
                }
                // *** END: NEW LOGIC FOR DETAIL VIEW (v1.2) ***
                
                // Logic ch·ª•p t√≥m t·∫Øt (nh∆∞ c≈©) ch·ªâ ch·∫°y khi kh√¥ng ·ªü ch·∫ø ƒë·ªô xem chi ti·∫øt
                const title = activeTabButton.dataset.title || 'BaoCao';
                let elementToCapture;

                // *** START BUG 4 FIX (v1.1) ***
                // Logic ƒë·∫∑c bi·ªát cho tab Thi ƒëua NV LK c√≥ view switcher
                if (prefix === 'sknv' && activeTabButton.dataset.target === 'subtab-hieu-qua-thi-dua-lk') {
                    const activeViewBtn = document.querySelector('#sknv-thidua-view-selector .view-switcher__btn.active');
                    const viewType = activeViewBtn ? activeViewBtn.dataset.view : 'program';
                    
                    if (viewType === 'program') {
                        elementToCapture = document.getElementById('competition-report-container-lk');
                    } else { // 'employee'
                        elementToCapture = document.getElementById('pasted-competition-report-container');
                    }
                } 
                // Logic ƒë·∫∑c bi·ªát cho tab Thi ƒëua V√πng (L≈©y k·∫ø)
                else if (prefix === 'luyke' && activeTabButton.dataset.target === 'subtab-luyke-thidua-vung') {
                    elementToCapture = document.getElementById('thidua-vung-infographic-container');
                } 
                // Logic g·ªëc cho t·∫•t c·∫£ c√°c tab kh√°c
                else {
                    elementToCapture = document.querySelector(`#${contentContainerId} .sub-tab-content:not(.hidden)`);
                }
                // *** END BUG 4 FIX (v1.1) ***

                if (!elementToCapture || elementToCapture.children.length === 0) {
                    ui.showNotification('Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ ch·ª•p.', 'error');
                    return;
                }

                captureService.captureDashboardInParts(elementToCapture, title);
            });
        }

        const exportBtn = document.getElementById(`export-${prefix}-btn`);
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                const navId = prefix === 'sknv' ? 'employee-subtabs-nav' : `${prefix}-subtabs-nav`;
                const contentContainerId = prefix === 'sknv' ? 'employee-subtabs-content' : `${prefix}-subtabs-content`;
                
                const activeTabButton = document.querySelector(`#${navId} .sub-tab-btn.active`);
                let activeTabContent; // Thay ƒë·ªïi t·ª´ const sang let

                // *** START BUG 4 FIX (v1.1) ***
                // Logic ƒë·∫∑c bi·ªát cho tab Thi ƒëua NV LK c√≥ view switcher
                if (prefix === 'sknv' && activeTabButton?.dataset.target === 'subtab-hieu-qua-thi-dua-lk') {
                    const activeViewBtn = document.querySelector('#sknv-thidua-view-selector .view-switcher__btn.active');
                    const viewType = activeViewBtn ? activeViewBtn.dataset.view : 'program';

                    if (viewType === 'program') {
                        activeTabContent = document.getElementById('competition-report-container-lk');
                    } else { // 'employee'
                        activeTabContent = document.getElementById('pasted-competition-report-container');
                    }
                } 
                // Logic g·ªëc cho t·∫•t c·∫£ c√°c tab kh√°c
                else {
                    activeTabContent = document.querySelector(`#${contentContainerId} .sub-tab-content:not(.hidden)`);
                }
                // *** END BUG 4 FIX (v1.1) ***

                if (activeTabContent && activeTabButton) {
                    const title = activeTabButton.dataset.title || 'BaoCao';
                    const timestamp = new Date().toLocaleDateString('vi-VN').replace(/\//g, '-');
                    utils.exportTableToExcel(activeTabContent, `${title}_${timestamp}`);
                } else {
                     ui.showNotification('Kh√¥ng t√¨m th·∫•y tab ƒë·ªÉ xu·∫•t.', 'error');
                }
            });
        }
    });
}
--- END FILE: ./event-listeners/listeners-actions.js ---

--- START FILE: ./event-listeners/listeners-collaboration.js ---
// Version 1.0 - Refactored from ui-listeners.js
// MODULE: LISTENERS - COLLABORATION
// Ch·ª©a logic s·ª± ki·ªán cho c√°c t√≠nh nƒÉng h·ª£p t√°c (G√≥p √Ω, Nh·∫≠n x√©t).

import { ui } from '../ui.js';

export function initializeCollaborationListeners(appController) {
    document.body.addEventListener('click', async (e) => {
        const target = e.target;

        // --- Feedback System ---
        if (target.id === 'submit-feedback-btn') {
            appController.handleSubmitFeedback();
        }
        const feedbackItem = target.closest('.feedback-item');
        if (feedbackItem) {
            appController.handleFeedbackReplyActions(e, feedbackItem);
        }
        
        // --- Composer System ---
        const composerTrigger = target.closest('.action-btn--composer');
        if (composerTrigger) {
            const sectionId = composerTrigger.id.split('-')[1];
            appController.prepareAndShowComposer(sectionId);
        }
        const composerModal = target.closest('#composer-modal');
        if (composerModal) {
            appController.handleComposerActions(e, composerModal);
        }
        if (target.id === 'copy-from-preview-btn') {
            ui.copyFromPreview();
        }

        // --- Admin/Declaration System ---
        if (target.id === 'save-help-content-btn') {
            appController.saveHelpContent();
        }
    });
}
--- END FILE: ./event-listeners/listeners-collaboration.js ---

--- START FILE: ./event-listeners/listeners-competition.js ---
// Version 1.1 - Refactor: Update target input listener to use globalCompetitionConfigs
// MODULE: LISTENERS - COMPETITION
// Ch·ª©a logic s·ª± ki·ªán cho vi·ªác qu·∫£n l√Ω c√°c ch∆∞∆°ng tr√¨nh thi ƒëua.

import { appState } from '../state.js';

export function initializeCompetitionListeners(appController) {
    const goalDrawer = document.getElementById('goal-drawer');
    if (!goalDrawer) return;

    // S·ª≠ d·ª•ng event delegation cho c√°c n√∫t trong danh s√°ch
    goalDrawer.addEventListener('click', (e) => {
        const addBtn = e.target.closest('#add-competition-btn');
        const cancelBtn = e.target.closest('#cancel-competition-btn');
        const editBtn = e.target.closest('.edit-competition-btn');
        const deleteBtn = e.target.closest('.delete-competition-btn');

        if (addBtn) appController._handleCompetitionFormShow(true);
        if (cancelBtn) appController._handleCompetitionFormShow(false);
        if (editBtn) {
            const index = parseInt(editBtn.dataset.index, 10);
            appController._handleCompetitionFormEdit(index);
        }
        if (deleteBtn) {
            const index = parseInt(deleteBtn.dataset.index, 10);
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch∆∞∆°ng tr√¨nh n√†y?')) {
                appController._handleCompetitionDelete(index);
            }
        }
    });

    // G·∫Øn s·ª± ki·ªán cho form
    const form = document.getElementById('competition-form');
    form?.addEventListener('submit', (e) => appController._handleCompetitionFormSubmit(e));
    
    // G·∫Øn s·ª± ki·ªán cho select lo·∫°i thi ƒëua
    const competitionTypeSelect = document.getElementById('competition-type');
    competitionTypeSelect?.addEventListener('change', (e) => {
        const priceSegment = document.getElementById('price-segment');
        if(priceSegment) {
            priceSegment.classList.toggle('hidden', e.target.value !== 'soluong');
        }
    });

    // S·ª≠ d·ª•ng event delegation tr√™n body cho c√°c input target ƒë∆∞·ª£c t·∫°o ƒë·ªông
    document.body.addEventListener('change', (e) => {
        if (e.target.classList.contains('competition-target-input')) {
            const competitionId = e.target.dataset.competitionId;
            
            // === START REFACTOR 2 (B∆∞·ªõc 2d) ===
            // S·ª≠a logic ƒë·ªÉ c·∫≠p nh·∫≠t v√†o global configs
            const config = appState.globalCompetitionConfigs.find(c => c.id === competitionId);
            // === END REFACTOR 2 ===

            if (config) {
                config.target = e.target.value; 
            }
            appController.updateAndRenderCurrentTab(); 
        }
    });
}
--- END FILE: ./event-listeners/listeners-competition.js ---

--- START FILE: ./event-listeners/listeners-dragdrop.js ---
// Version 2.3 - Fix selector for pasted competition toggles (div instead of button)
// Version 2.2 - Add dragdrop support for pasted competition column toggles
// Version 2.1 - Add logging to diagnose re-render issue on drop
// MODULE: LISTENERS - DRAG & DROP
// Ch·ª©a logic kh·ªüi t·∫°o v√† x·ª≠ l√Ω s·ª± ki·ªán k√©o-th·∫£ c·ªôt b·∫±ng SortableJS.

import { settingsService } from '../modules/settings.service.js';

let appController = null;

/**
 * K√≠ch ho·∫°t SortableJS cho c√°c th·∫ª t√πy ch·ªânh c·ªôt (B·∫£ng Hi·ªáu qu·∫£ NV LK)
 */
function activateSortableOnColumnToggles(container) {
    if (!container) return;

    const toggleContainer = container.querySelector('#efficiency-column-toggles');
    if (!toggleContainer) return;

    // H·ªßy b·ªè instance c≈© n·∫øu c√≥
    if (toggleContainer.sortable) {
        toggleContainer.sortable.destroy();
    }

    // T·∫°o instance m·ªõi
    toggleContainer.sortable = new Sortable(toggleContainer, {
        animation: 150,
        filter: '.non-draggable', 
        handle: '.drag-handle-icon',
        onEnd: (evt) => {
            const newButtonOrder = Array.from(evt.target.querySelectorAll('button.column-toggle-btn'));
            const newColumnIdOrder = newButtonOrder.map(btn => btn.dataset.columnId).filter(Boolean);
            const currentSettings = settingsService.loadEfficiencyViewSettings();
            const settingsMap = new Map(currentSettings.map(s => [s.id, s]));
            const reorderedSettings = newColumnIdOrder.map(id => settingsMap.get(id));
            
            currentSettings.forEach(setting => {
                if (!reorderedSettings.find(s => s.id === setting.id)) {
                    reorderedSettings.push(setting);
                }
            });

            settingsService.saveEfficiencyViewSettings(reorderedSettings);

            if (appController) {
                console.log("LOG: Y√™u c·∫ßu render l·∫°i tab (efficiency) sau khi k√©o th·∫£."); 
                appController.updateAndRenderCurrentTab();
            }
        }
    });
}

// === START: NEW FUNCTION (v2.2) ===
/**
 * K√≠ch ho·∫°t SortableJS cho c√°c th·∫ª t√πy ch·ªânh c·ªôt (B·∫£ng Thi ƒêua NV D√°n V√Äo)
 */
function activateSortableOnPastedCompToggles(container) {
    if (!container) return;

    // Target container m·ªõi
    const toggleContainer = container.querySelector('#pasted-competition-column-toggles');
    if (!toggleContainer) return;

    if (toggleContainer.sortable) {
        toggleContainer.sortable.destroy();
    }

    toggleContainer.sortable = new Sortable(toggleContainer, {
        animation: 150,
        filter: '.non-draggable',
        handle: '.drag-handle-icon',
        onEnd: (evt) => {
            // === START: S·ª¨A L·ªñI (v2.3) ===
            // Target c√°c th·∫ª div (thay v√¨ button)
            const newButtonOrder = Array.from(evt.target.querySelectorAll('div.pasted-comp-toggle-btn'));
            // === END: S·ª¨A L·ªñI (v2.3) ===
            
            // D√πng 'tenGoc' l√†m ID duy nh·∫•t
            const newColumnNameOrder = newButtonOrder.map(btn => btn.dataset.columnTenGoc).filter(Boolean);
            
            // G·ªçi h√†m settings m·ªõi
            const currentSettings = settingsService.loadPastedCompetitionViewSettings();
            
            const settingsMap = new Map(currentSettings.map(s => [s.tenGoc, s]));
            const reorderedSettings = newColumnNameOrder.map(name => settingsMap.get(name));
            
            currentSettings.forEach(setting => {
                if (!reorderedSettings.find(s => s.tenGoc === setting.tenGoc)) {
                    reorderedSettings.push(setting);
                }
            });

            // G·ªçi h√†m save m·ªõi
            settingsService.savePastedCompetitionViewSettings(reorderedSettings);

            if (appController) {
                console.log("LOG: Y√™u c·∫ßu render l·∫°i tab (pasted comp) sau khi k√©o th·∫£.");
                appController.updateAndRenderCurrentTab();
            }
        }
    });
}
// === END: NEW FUNCTION (v2.2) ===


export const dragDroplisteners = {
    /**
     * H√†m kh·ªüi t·∫°o ch√≠nh, nh·∫≠n v√†o controller c·ªßa ·ª©ng d·ª•ng.
     */
    init(mainAppController) {
        appController = mainAppController;
    },
    
    /**
     * H√†m ƒë∆∞·ª£c g·ªçi sau m·ªói l·∫ßn render ƒë·ªÉ k√≠ch ho·∫°t l·∫°i t√≠nh nƒÉng k√©o-th·∫£.
     * * === MODIFIED (v2.2): K√≠ch ho·∫°t cho c·∫£ hai b·∫£ng ===
     */
    initializeForContainer(containerId) {
        const container = document.getElementById(containerId);
        if (container) {
            // K√≠ch ho·∫°t cho b·∫£ng Hi·ªáu qu·∫£ NV LK
            activateSortableOnColumnToggles(container);
            
            // K√≠ch ho·∫°t cho b·∫£ng Thi ƒêua NV D√°n V√Äo
            activateSortableOnPastedCompToggles(container);
        }
    }
};
--- END FILE: ./event-listeners/listeners-dragdrop.js ---

--- START FILE: ./event-listeners/listeners-highlighting.js ---
// Version 1.0 - Refactored from ui-listeners.js
// MODULE: LISTENERS - HIGHLIGHTING
// Ch·ª©a logic s·ª± ki·ªán cho t√≠nh nƒÉng t√¥ m√†u (highlight).

import { appState } from '../state.js';
import { highlightService } from '../modules/highlight.service.js';

/**
 * X·ª≠ l√Ω khi ng∆∞·ªùi d√πng thay ƒë·ªïi l·ª±a ch·ªçn trong c√°c b·ªô l·ªçc highlight.
 * @param {string} prefix - 'luyke', 'sknv', ho·∫∑c 'realtime'.
 * @param {string} type - 'nhanhang', 'nhomhang', ho·∫∑c 'employee'.
 */
function handleHighlightFilterChange(prefix, type) {
    const choicesInstance = appState.choices[`${prefix}_highlight_${type}`];
    if (!choicesInstance) return;

    const values = choicesInstance.getValue(true);
    const color = document.getElementById(`${prefix}-highlight-color`).value;
    
    appState.highlightSettings[prefix] = { type, values, color };
    localStorage.setItem('highlightSettings', JSON.stringify(appState.highlightSettings));
    
    highlightService.applyHighlights(prefix);
}

export function initializeHighlightingListeners(appController) {
    ['luyke', 'sknv', 'realtime'].forEach(prefix => {
        const nhanhangFilter = document.getElementById(`${prefix}-highlight-nhanhang`);
        if (nhanhangFilter) {
            nhanhangFilter.addEventListener('change', () => handleHighlightFilterChange(prefix, 'nhanhang'));
        }

        const nhomhangFilter = document.getElementById(`${prefix}-highlight-nhomhang`);
        if (nhomhangFilter) {
            nhomhangFilter.addEventListener('change', () => handleHighlightFilterChange(prefix, 'nhomhang'));
        }

        const employeeFilter = document.getElementById(`${prefix}-highlight-employee`);
        if (employeeFilter) {
            employeeFilter.addEventListener('change', () => handleHighlightFilterChange(prefix, 'employee'));
        }

        const colorInput = document.getElementById(`${prefix}-highlight-color`);
        if (colorInput) {
            colorInput.addEventListener('input', () => appController.handleHighlightColorChange(prefix));
        }
        
        const clearButton = document.getElementById(`${prefix}-clear-highlight`);
        if (clearButton) {
            clearButton.addEventListener('click', () => appController.handleClearHighlight(prefix));
        }
    });
}
--- END FILE: ./event-listeners/listeners-highlighting.js ---

--- START FILE: ./event-listeners/listeners-settings.js ---
// Version 1.8 - Fix "Ghost Bug" by re-rendering lists on goal drawer open
// MODULE: LISTENERS - SETTINGS
// Ch·ª©a logic s·ª± ki·ªán cho c√°c drawers C√†i ƒë·∫∑t v√† c√°c Modals.

import { ui } from '../ui.js';
import { settingsService } from '../modules/settings.service.js';
import { appState } from '../state.js';
// import { firebase } from '../firebase.js'; // <-- ƒê√É X√ìA
import { adminService } from '../services/admin.service.js'; // <-- ƒê√É TH√äM 
import { services } from '../services.js'; // *** NEW (v1.5) ***

export function initializeSettingsListeners(appController) {
    // *** NEW (v1.5): Helper debounce function ***
    let debounceTimer;
    const debounce = (func, delay) => {
        return (...args) => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                func.apply(this, args);
            }, delay);
        };
    };

    // *** NEW (v1.5): Create a debounced save function (e.g., wait 1 second after last keystroke) ***
    const debouncedSaveMappings = debounce((mappings) => {
        // 1. Save to Firestore
        // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
        adminService.saveCompetitionNameMappings(mappings); // 
        // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
        ui.showNotification('ƒê√£ t·ª± ƒë·ªông l∆∞u t√™n r√∫t g·ªçn l√™n Cloud!', 'success');
        
        // 2. (Bug 1 Fix) Re-process pasted data with new names
        const pastedText = document.getElementById('paste-thiduanv')?.value || '';
        
        // Ch·ªâ x·ª≠ l√Ω l·∫°i n·∫øu ƒë√£ c√≥ d·ªØ li·ªáu ƒë∆∞·ª£c d√°n v√† x·ª≠ l√Ω tr∆∞·ªõc ƒë√≥
        // `appState.pastedThiDuaReportData` s·∫Ω c√≥ d·ªØ li·ªáu sau l·∫ßn d√°n ƒë·∫ßu ti√™n
        if (pastedText && appState.pastedThiDuaReportData) { 
            console.log("Re-processing pasted thi dua data after name change...");
            try {
                const parsedData = services.parsePastedThiDuaTableData(pastedText);
                if (parsedData.success) {
                    // Use the NEW mappings from appState
                    appState.pastedThiDuaReportData = services.processThiDuaNhanVienData(parsedData, appState.competitionData);
                    // Save the re-processed data to localStorage
                    localStorage.setItem('daily_paste_thiduanv', JSON.stringify(appState.pastedThiDuaReportData));
                    
                    // Re-render the current tab if it's the SKNV tab
                    const activeTab = document.querySelector('.page-section:not(.hidden)');
                    if (activeTab && activeTab.id === 'health-employee-section') {
                        appController.updateAndRenderCurrentTab();
                    }
                }
            } catch (e) {
                 console.error("Error re-processing pasted data after name mapping change:", e);
            }
        }
    }, 1000); // 1000ms (1 second) delay

    // --- Open/Close Modals & Drawers ---
    document.getElementById('admin-access-btn')?.addEventListener('click', () => ui.toggleModal('admin-modal', true));
    document.getElementById('admin-submit-btn')?.addEventListener('click', () => appController.handleAdminLogin());
    document.getElementById('admin-cancel-btn')?.addEventListener('click', () => ui.toggleModal('admin-modal', false));
    document.getElementById('interface-settings-btn')?.addEventListener('click', () => ui.toggleDrawer('interface-drawer', true));
    
    // === START: S·ª¨A L·ªñI (Bug 3 - L·ªói "Ma") ===
    document.getElementById('goal-settings-btn')?.addEventListener('click', () => {
        // Render l·∫°i c·∫£ hai danh s√°ch M·ªñI KHI M·ªû drawer ƒë·ªÉ x√≥a tr·∫°ng th√°i "ma"
        // (ƒê√¢y l√† c√°c h√†m trong ui-admin.js, ƒë∆∞·ª£c export qua ui.js)
        ui.renderCompetitionConfigUI(); // Render l·∫°i list "Thi ƒëua T√πy ch·ªânh"
        ui.renderSpecialProgramConfigUI(); // Render l·∫°i list "SP ƒê·∫∑c Quy·ªÅn"
        
        // M·ªü drawer sau khi ƒë√£ render
        ui.toggleDrawer('goal-drawer', true);
    });
    // === END: S·ª¨A L·ªñI (Bug 3) ===

    document.querySelectorAll('.close-drawer-btn, #drawer-overlay').forEach(el => el.addEventListener('click', () => ui.closeAllDrawers()));

    // --- Interface Settings ---
    document.querySelectorAll('.contrast-selector').forEach(sel => sel.addEventListener('change', (e) => appController.handleContrastChange(e)));
    document.getElementById('global-font-size-slider')?.addEventListener('input', (e) => settingsService.handleFontSizeChange(e, 'global'));
    document.getElementById('kpi-font-size-slider')?.addEventListener('input', (e) => settingsService.handleFontSizeChange(e, 'kpi'));
    document.querySelectorAll('.kpi-color-input').forEach(picker => picker.addEventListener('input', () => settingsService.saveInterfaceSettings()));

    // --- Goal Settings ---
    document.getElementById('rt-goal-warehouse-select')?.addEventListener('change', () => settingsService.loadAndApplyRealtimeGoalSettings());
    document.getElementById('luyke-goal-warehouse-select')?.addEventListener('change', () => settingsService.loadAndApplyLuykeGoalSettings());
    document.querySelectorAll('.rt-goal-input, .rt-setting-input').forEach(input => input.addEventListener('input', () => {
         settingsService.saveRealtimeGoalSettings();
        appController.updateAndRenderCurrentTab();
    }));
    document.querySelectorAll('.luyke-goal-input').forEach(input => input.addEventListener('input', () => {
         settingsService.saveLuykeGoalSettings();
         appController.updateAndRenderCurrentTab();
    }));
    
    // --- Declaration Settings ---
    document.getElementById('save-declaration-btn')?.addEventListener('click', () => appController.saveDeclarations());

    // --- Global Modals (Help, etc.) & Debug Tool ---
    document.getElementById('toggle-debug-btn')?.addEventListener('click', (e) => ui.toggleDebugTool(e.currentTarget));
    
    // --- Event Delegation for dynamically added elements --- 
    document.body.addEventListener('click', (e) => {
        const helpTrigger = e.target.closest('.page-header__help-btn');
        if(helpTrigger) {
            ui.showHelpModal(helpTrigger.dataset.helpId);
        }

        const closeModalTrigger = e.target.closest('[data-close-modal]');
        if (closeModalTrigger) {
            const modal = closeModalTrigger.closest('.modal');
            if(modal) {
                 ui.toggleModal(modal.id, false);
            }
        }
        
        const selectionSaveBtn = e.target.closest('#selection-modal-save-btn');
        if (selectionSaveBtn) {
            const modal = document.getElementById('selection-modal');
            const settingType = modal.dataset.settingType;

            const selectedItems = [];
            document.querySelectorAll('#selection-modal-list input[type="checkbox"]:checked').forEach(checkbox => {
                selectedItems.push(checkbox.value);
            });

            if (settingType === 'efficiencyView') {
                // Logic c≈© n√†y v·∫´n c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi modal, nh∆∞ng UI m·ªõi s·∫Ω d√πng logic ri√™ng
                const allItems = settingsService.loadEfficiencyViewSettings();
                const updatedItems = allItems.map(item => ({...item, visible: selectedItems.includes(item.id)}));
                settingsService.saveEfficiencyViewSettings(updatedItems);
            } else if (settingType === 'qdcView') {
                settingsService.saveQdcViewSettings(selectedItems);
            } else if (settingType === 'categoryView') {
                 settingsService.saveCategoryViewSettings(selectedItems);
            }

            ui.toggleModal('selection-modal', false);
            ui.showNotification('ƒê√£ l∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã!', 'success');
            appController.updateAndRenderCurrentTab();
        }

        // === LOGIC T√ôY CH·ªàNH C·ªòT (HI·ªÜU QU·∫¢ NV LK) ===
        const columnToggleButton = e.target.closest('.column-toggle-btn');
        if (columnToggleButton && columnToggleButton.closest('#efficiency-column-toggles')) {
            e.preventDefault();
            const columnId = columnToggleButton.dataset.columnId;
            
            // 1. T·∫£i c√†i ƒë·∫∑t hi·ªán t·∫°i
            const currentSettings = settingsService.loadEfficiencyViewSettings();
            
            // 2. Thay ƒë·ªïi tr·∫°ng th√°i c·ªßa c·ªôt ƒë∆∞·ª£c nh·∫•p
            const newSettings = currentSettings.map(col => {
                 if (col.id === columnId) {
                    return { ...col, visible: !col.visible };
                 }
                return col;
            });

            // 3. L∆∞u c√†i ƒë·∫∑t m·ªõi
            settingsService.saveEfficiencyViewSettings(newSettings);
            
            // 4. Render l·∫°i tab ƒë·ªÉ √°p d·ª•ng thay ƒë·ªïi
            appController.updateAndRenderCurrentTab();
        }
        
        // === START: NEW LOGIC (v1.6) - T√ôY CH·ªàNH C·ªòT (THI ƒêUA NV D√ÅN V√ÄO) ===
        const pastedCompToggleButton = e.target.closest('.pasted-comp-toggle-btn');
        if (pastedCompToggleButton && pastedCompToggleButton.closest('#pasted-competition-column-toggles')) {
            e.preventDefault();
            const columnTenGoc = pastedCompToggleButton.dataset.columnTenGoc; // D√πng t√™n g·ªëc l√†m ID
            
            // 1. T·∫£i c√†i ƒë·∫∑t hi·ªán t·∫°i
            const currentSettings = settingsService.loadPastedCompetitionViewSettings();
            
            // 2. Thay ƒë·ªïi tr·∫°ng th√°i
            const newSettings = currentSettings.map(col => {
                if (col.tenGoc === columnTenGoc) {
                    return { ...col, visible: !col.visible };
                }
                return col;
            });
            
            // 3. L∆∞u c√†i ƒë·∫∑t m·ªõi
            settingsService.savePastedCompetitionViewSettings(newSettings);
            
            // 4. Render l·∫°i tab
            appController.updateAndRenderCurrentTab();
        }
        // === END: NEW LOGIC (v1.6) ===
    });

    // *** MODIFIED (v1.5): Event delegation for auto-saving competition name mappings ***
    document.body.addEventListener('input', (e) => {
        const mappingInput = e.target.closest('.competition-name-input');
        
        if (mappingInput) {
            const originalName = mappingInput.dataset.originalName;
            const shortName = mappingInput.value.trim();
            
            if (originalName) {
                if (!appState.competitionNameMappings) {
                    appState.competitionNameMappings = {};
                }
                // 1. Update the state immediately
                appState.competitionNameMappings[originalName] = shortName;
                
                // 2. Call the debounced function to save to Firestore & re-process data
                debouncedSaveMappings(appState.competitionNameMappings);
            }
        }
    });
    // *** END MODIFIED ***

    const searchInput = document.getElementById('selection-modal-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('#selection-modal-list .selection-item').forEach(item => {
                 const label = item.querySelector('label').textContent.toLowerCase();
                item.style.display = label.includes(searchTerm) ? '' : 'none';
            });
        });
    }
}
--- END FILE: ./event-listeners/listeners-settings.js ---

--- START FILE: ./event-listeners/listeners-sorting.js ---
// Version 1.0 - Refactored from ui-listeners.js
// MODULE: LISTENERS - SORTING
// Ch·ª©a logic s·ª± ki·ªán cho vi·ªác s·∫Øp x·∫øp c√°c b·∫£ng.

import { appState } from '../state.js';

export function initializeSortingListeners(appController) {
    document.body.addEventListener('click', (e) => {
        const header = e.target.closest('.sortable');
        if (!header) return;

        const table = header.closest('table');
        if (!table) return;
        
        const tableType = table.dataset.tableType;
        const sortKey = header.dataset.sort;

        if (!tableType || !sortKey) return;

        const currentState = appState.sortState[tableType] || { key: sortKey, direction: 'desc' };
        
        let newDirection;
        if (currentState.key === sortKey) {
            newDirection = currentState.direction === 'desc' ? 'asc' : 'desc';
        } else {
            newDirection = 'desc';
        }
        
        appState.sortState[tableType] = { key: sortKey, direction: newDirection };

        appController.updateAndRenderCurrentTab();
    });
}
--- END FILE: ./event-listeners/listeners-sorting.js ---

--- START FILE: ./event-listeners/ui-listeners.js ---
// Version 3.41 - Add listeners for Special Program Edit/Delete buttons
// Version 3.34 - Refactor: Ho√†n t·∫•t di d·ªùi 2 listener (Template, Debug) sang data.service.js
// ... (c√°c phi√™n b·∫£n tr∆∞·ªõc gi·ªØ nguy√™n)
// MODULE: EVENT LISTENERS INITIALIZER
// File n√†y ƒë√≥ng vai tr√≤ l√† ƒëi·ªÉm kh·ªüi ƒë·∫ßu, import v√† kh·ªüi ch·∫°y t·∫•t c·∫£ c√°c module listener con.

import { appState } from '../state.js';
import { ui } from '../ui.js';
import { services } from '../services.js';
import { luykeTab } from '../tab-luyke.js';
import { sknvTab } from '../tab-sknv.js';
import { uiRealtime } from '../ui-realtime.js';
import { initializeActionListeners } from './listeners-actions.js';
import { initializeCollaborationListeners } from './listeners-collaboration.js';
import { initializeCompetitionListeners } from './listeners-competition.js';
import { initializeHighlightingListeners } from './listeners-highlighting.js';
import { initializeSettingsListeners } from './listeners-settings.js';
import { initializeSortingListeners } from './listeners-sorting.js';
import { dragDroplisteners } from './listeners-dragdrop.js';
import { captureService } from '../modules/capture.service.js';
import { firebase } from '../firebase.js';
import { uiComponents } from '../ui-components.js';
import { dataService } from '../services/data.service.js';

let appController = null;

// --- CONSTANTS ---
// (ƒê√£ x√≥a LOCAL_DATA_VERSIONS_KEY)

// --- HELPERS / HANDLERS ---

// (ƒê√É X√ìA TO√ÄN B·ªò H√ÄM handleFileInputChange)

function handleFilterChange(prefix) {
    appState.viewingDetailFor = null;
    uiComponents.updateEmployeeFilter(prefix);
    appController.updateAndRenderCurrentTab();
}

// --- MAIN INITIALIZER ---

export function initializeEventListeners(mainAppController) {
    appController = mainAppController;

    // Kh·ªüi t·∫°o Choices.js v√† Flatpickr (Gi·ªØ nguy√™n)
    try {
        const multiSelectConfig = { removeItemButton: true, placeholder: true, placeholderValue: 'Ch·ªçn ho·∫∑c g√µ ƒë·ªÉ t√¨m...', searchPlaceholderValue: 'T√¨m ki·∫øm...' };
        const competitionMultiSelectConfig = { ...multiSelectConfig };

        ['luyke', 'sknv', 'realtime'].forEach(prefix => {
            const employeeEl = document.getElementById(`${prefix}-filter-name`);
            if (employeeEl) appState.choices[`${prefix}_employee`] = new Choices(employeeEl, multiSelectConfig);
            ['warehouse', 'department'].forEach(type => {
                 const el = document.getElementById(`${prefix}-filter-${type}`);
                if(el) appState.choices[`${prefix}_${type}`] = new Choices(el, { searchEnabled: true, removeItemButton: false, itemSelectText: 'Ch·ªçn' });
            });
            ['nhanhang', 'nhomhang', 'employee'].forEach(type => {
                const highlightEl = document.getElementById(`${prefix}-highlight-${type}`);
                if (highlightEl) appState.choices[`${prefix}_highlight_${type}`] = new Choices(highlightEl, multiSelectConfig);
            });
        });
        const competitionBrandEl = document.getElementById('competition-brand');
        if (competitionBrandEl) appState.choices['competition_brand'] = new Choices(competitionBrandEl, competitionMultiSelectConfig);
        const competitionGroupEl = document.getElementById('competition-group');
        if (competitionGroupEl) appState.choices['competition_group'] = new Choices(competitionGroupEl, competitionMultiSelectConfig);
        
        // ========== START: TH√äM M·ªöI (SP ƒê·∫∂C QUY·ªÄN) ==========
        // Th√™m select box m·ªõi cho ch∆∞∆°ng tr√¨nh SPƒêQ
        const specialProgramGroupEl = document.getElementById('special-program-group');
        if (specialProgramGroupEl) appState.choices['special_program_group'] = new Choices(specialProgramGroupEl, competitionMultiSelectConfig);
        // ========== END: TH√äM M·ªöI ==========

        const singleSelectConfig = { searchEnabled: true, removeItemButton: false, itemSelectText: 'Ch·ªçn', searchPlaceholderValue: 'T√¨m ki·∫øm...' };
        
        const singleSelects = {
             'thidua-employee-filter': 'thidua_employee_detail',
            'thidua-vung-filter-supermarket': 'thiDuaVung_sieuThi',
            'realtime-brand-category-filter': 'realtime_brand_category_filter',
            'realtime-brand-filter': 'realtime_brand_filter',
        };

        for (const [id, key] of Object.entries(singleSelects)) {
             const el = document.getElementById(id);
             if (el) appState.choices[key] = new Choices(el, singleSelectConfig);
        }
    } catch (error) { console.error("L·ªói khi kh·ªüi t·∫°o Choices.js:", error); }

    try {
        const initDatePicker = (prefix, renderFunc) => {
            const datePickerEl = document.getElementById(`${prefix}-filter-date`);
            if (!datePickerEl) return;
            const datePicker = flatpickr(datePickerEl, {
                mode: "multiple", dateFormat: "d/m", maxDate: "today",
                onClose: (selectedDates, dateStr, instance) => {
                    if (selectedDates.length === 2) {
                         const [start, end] = selectedDates.sort((a,b) => a - b);
                        const dateRange = Array.from({length: (end - start) / 86400000 + 1}, (_, i) => new Date(start.getTime() + i * 86400000));
                         instance.setDate(dateRange, false);
                    }
                    uiComponents.updateDateSummary(document.getElementById(`${prefix}-date-summary`), instance);
                    appState.viewingDetailFor = null;
                    renderFunc();
                }
            });
            appState.choices[`${prefix}_date_picker`] = datePicker;
            document.getElementById(`${prefix}-clear-date`)?.addEventListener('click', () => { datePicker.clear(); renderFunc(); });
        };
        initDatePicker('luyke', luykeTab.render);
        initDatePicker('sknv', sknvTab.render);
    } catch (error) { console.error("L·ªói khi kh·ªüi t·∫°o Flatpickr:", error); }


    // G·ªçi c√°c h√†m kh·ªüi t·∫°o listener con
    initializeSettingsListeners(appController);
    initializeHighlightingListeners(appController);
    initializeActionListeners();
    initializeCollaborationListeners(appController);
    initializeSortingListeners(appController);
    initializeCompetitionListeners(appController);
    dragDroplisteners.init(appController);

    // General UI Listeners (Gi·ªØ nguy√™n)
    document.getElementById('force-reload-btn')?.addEventListener('click', () => window.location.reload());
    document.querySelectorAll('a.nav-link').forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); appController.switchTab(link.getAttribute('href').substring(1)); }));
    document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', (e) => {
        ui.handleSubTabClick(e.currentTarget);
        appState.viewingDetailFor = null;
        const mainTabId = e.currentTarget.closest('.page-section')?.id || e.currentTarget.closest('.settings-drawer')?.id;
        if (mainTabId === 'health-section') luykeTab.render();
        else if (mainTabId === 'health-employee-section') sknvTab.render();
        else if (mainTabId === 'realtime-section') uiRealtime.render();
    }));
    document.querySelectorAll('.toggle-filters-btn').forEach(button =>
        button.addEventListener('click', () => ui.toggleFilterSection(button.dataset.target)));

    // --- B·∫ÆT ƒê·∫¶U T√ÅI C·∫§U TR√öC (v3.32 -> v3.34) ---
    // File input listeners - Tr·ªè ƒë·∫øn dataService
    document.querySelectorAll('.file-input').forEach(input => {
        if (input.id !== 'file-thidua-vung' && input.id !== 'file-category-structure' && input.id !== 'realtime-file-input' && input.id !== 'debug-competition-file-input' && input.id !== 'file-special-products') { // <-- TH√äM M·ªöI: Lo·∫°i tr·ª´ file SPƒêQ
            input.addEventListener('change', (e) => dataService.handleFileUpload(e));
        }
    });
    // G√°n c√°c handler ƒë·∫∑c bi·ªát - Tr·ªè ƒë·∫øn dataService
    document.getElementById('file-category-structure')?.addEventListener('change', (e) => dataService.handleCategoryFile(e));
    
    // ========== START: TH√äM M·ªöI (SP ƒê·∫∂C QUY·ªÄN) ==========
    // Th√™m listener cho file SPƒêQ
    document.getElementById('file-special-products')?.addEventListener('change', (e) => dataService.handleSpecialProductFileUpload(e));
    // Th√™m listener cho form submit SPƒêQ
    document.getElementById('special-program-form')?.addEventListener('submit', (e) => appController._handleSpecialProgramFormSubmit(e));
    // ========== END: TH√äM M·ªöI ==========

    document.getElementById('paste-luyke')?.addEventListener('input', () => dataService.handleLuykePaste());
    document.getElementById('paste-thiduanv')?.addEventListener('input', () => dataService.handleThiduaNVPaste());
    document.getElementById('paste-thuongerp')?.addEventListener('input', () => dataService.handleErpPaste());
    document.getElementById('paste-thuongerp-thangtruoc')?.addEventListener('input', (e) => dataService.handleErpThangTruocPaste(e));
    document.getElementById('realtime-file-input')?.addEventListener('change', (e) => dataService.handleRealtimeFileInput(e));
    document.getElementById('file-thidua-vung')?.addEventListener('change', (e) => dataService.handleThiDuaVungFileInput(e));
    
    // <<< C·∫¨P NH·∫¨T (v3.34) >>>
    document.getElementById('download-danhsachnv-template-btn')?.addEventListener('click', () => dataService.handleTemplateDownload());
    document.getElementById('thidua-vung-filter-supermarket')?.addEventListener('change', () => appController.handleThiDuaVungFilterChange()); // (Gi·ªØ nguy√™n)
    document.getElementById('debug-competition-file-input')?.addEventListener('change', (e) => dataService.handleCompetitionDebugFile(e)); 
    // --- K·∫æT TH√öC T√ÅI C·∫§U TR√öC ---

    // Filter change listeners (Gi·ªØ nguy√™n)
    ['luyke', 'sknv', 'realtime'].forEach(prefix => {
        document.getElementById(`${prefix}-filter-warehouse`)?.addEventListener('change', () => handleFilterChange(prefix));
        document.getElementById(`${prefix}-filter-department`)?.addEventListener('change', () => handleFilterChange(prefix));
         document.getElementById(`${prefix}-filter-name`)?.addEventListener('change', () => handleFilterChange(prefix));
    });

    // Warehouse selector listener (Gi·ªØ nguy√™n logic, nh∆∞ng thay ƒë·ªïi h√†m callback)
    document.getElementById('data-warehouse-selector')?.addEventListener('change', (e) => {
        const selectedKho = e.target.value;
        console.log("[DEBUG] Kho selection changed. Selected:", selectedKho);
        if (selectedKho) {
            appState.selectedWarehouse = selectedKho;
            localStorage.setItem('selectedWarehouse', selectedKho);
            ui.showNotification(`ƒê√£ chuy·ªÉn sang l√†m vi·ªác v·ªõi kho ${selectedKho}.`, 'success');
             if(appController.unsubscribeDataListener) {
                console.log("[DEBUG] Unsubscribing from previous warehouse listener.");
                appController.unsubscribeDataListener();
            }
            appController.unsubscribeDataListener = firebase.listenForDataChanges(selectedKho, (cloudData) => {
                dataService.handleCloudDataUpdate(cloudData); 
            });
            ['ycx', 'giocong', 'thuongnong'].forEach(ft => {
                const versionInfo = appController._localDataVersions?.[selectedKho]?.[ft];
                if (!versionInfo || !versionInfo.version ||
                    versionInfo.version === 0) {
                     uiComponents.updateFileStatus(ft, 'Cloud', `ƒêang ch·ªù ƒë·ªìng b·ªô t·ª´ kho ${selectedKho}...`, 'default');
                }
            });
        } else {
            appState.selectedWarehouse = null;
            localStorage.removeItem('selectedWarehouse');
            ui.showNotification(`ƒê√£ b·ªè ch·ªçn kho. ƒê·ªìng b·ªô cloud t·∫°m d·ª´ng.`, 'success');
            if(appController.unsubscribeDataListener) {
                 console.log("[DEBUG] Unsubscribing warehouse listener (no warehouse selected).");
                appController.unsubscribeDataListener();
                appController.unsubscribeDataListener = null;
            }
             ['ycx', 'giocong', 'thuongnong'].forEach(ft => uiComponents.updateFileStatus(ft, '', 'Ch·ªçn kho ƒë·ªÉ ƒë·ªìng b·ªô...', 'default'));
        }
        appController.updateAndRenderCurrentTab();
    });

    // Other specific listeners (Gi·ªØ nguy√™n)
    document.getElementById('sknv-view-selector')?.addEventListener('click', (e) => appController.handleSknvViewChange(e));
    document.getElementById('sknv-employee-filter')?.addEventListener('change', () => sknvTab.render());

    // Body click listener (Gi·ªØ nguy√™n logic, nh∆∞ng thay ƒë·ªïi h√†m callback)
    document.body.addEventListener('click', (e) => {
        
        // ========== START: TH√äM M·ªöI (SP ƒê·∫∂C QUY·ªÄN) ==========
        // C√°c n√∫t trong form SP ƒê·∫∑c Quy·ªÅn
        const addSpecialBtn = e.target.closest('#add-special-program-btn');
        const cancelSpecialBtn = e.target.closest('#cancel-special-program-btn');
        
        if (addSpecialBtn) {
            e.preventDefault();
            appController._handleSpecialProgramFormShow(true); // C·∫ßn t·∫°o h√†m n√†y trong main.js
            return;
        }
        if (cancelSpecialBtn) {
            e.preventDefault();
            appController._handleSpecialProgramFormShow(false); // C·∫ßn t·∫°o h√†m n√†y trong main.js
            return;
        }
        
        // === START: S·ª¨A L·ªñI (Bug 2 - Th√™m listener cho S·ª≠a/X√≥a) ===
        const editSpecialBtn = e.target.closest('.edit-special-program-btn');
        const deleteSpecialBtn = e.target.closest('.delete-special-program-btn');

        if (editSpecialBtn) {
            e.preventDefault();
            const index = parseInt(editSpecialBtn.dataset.index, 10);
            appController._handleSpecialProgramFormEdit(index); // S·∫Ω th√™m ·ªü main.js
            return;
        }
        if (deleteSpecialBtn) {
            e.preventDefault();
            const index = parseInt(deleteSpecialBtn.dataset.index, 10);
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch∆∞∆°ng tr√¨nh SP ƒê·∫∑c Quy·ªÅn n√†y?')) {
                appController._handleSpecialProgramDelete(index); // S·∫Ω th√™m ·ªü main.js
            }
            return;
        }
        // === END: S·ª¨A L·ªñI (Bug 2) ===

        // (Listeners cho S·ª≠a/X√≥a s·∫Ω ƒë∆∞·ª£c th√™m sau khi UI render list)
        // ========== END: TH√äM M·ªöI ==========

        const interactiveRow = e.target.closest('.interactive-row');
        if (interactiveRow && interactiveRow.dataset.employeeId) {
            e.preventDefault();
            if (appState.viewingDetailFor && appState.viewingDetailFor.employeeId === interactiveRow.dataset.employeeId) return;
            appState.viewingDetailFor = { employeeId: interactiveRow.dataset.employeeId, sourceTab: interactiveRow.dataset.sourceTab };
            appController.updateAndRenderCurrentTab();
            return;
        }
        const backButton = e.target.closest('.back-to-summary-btn');
        if (backButton) {
            e.preventDefault();
            appState.viewingDetailFor = null;
            appController.updateAndRenderCurrentTab();
            return;
        }
        
        // *** START: S·ª¨A L·ªñI (Lo·∫°i b·ªè n√∫t chi ti·∫øt LK) ***
        // S·ª≠a l·ªói 1 (chia m·∫£nh) v√† 2 (bi·ªÉu ƒë·ªì tr·∫Øng)
        const captureDetailBtn = e.target.closest('#capture-sknv-detail-btn, #capture-dtnv-rt-detail-btn');
        if (captureDetailBtn) {
            e.preventDefault();
            const areaToCapture = captureDetailBtn.closest('.sub-tab-content')?.querySelector('[id$="-capture-area"]');
            const title = appState.viewingDetailFor?.employeeId || 'ChiTietNV';
            
            if (areaToCapture) {
                // Lu√¥n g·ªçi captureAndDownload (s·ª≠a l·ªói chia m·∫£nh)
                // v√† d√πng preset 'preset-mobile-portrait' (s·ª≠a l·ªói bi·ªÉu ƒë·ªì tr·∫Øng + ƒë·ªìng b·ªô k√≠ch th∆∞·ªõc)
                
                // √Åp d·ª•ng preset di ƒë·ªông cho chi ti·∫øt SKNV
                if (captureDetailBtn.id === 'capture-sknv-detail-btn') {
                    captureService.captureAndDownload(areaToCapture, title, 'preset-mobile-portrait');
                } else {
                    // Chi ti·∫øt DTNV Realtime
                    captureService.captureAndDownload(areaToCapture, title, 'preset-mobile-portrait');
                }
            }
            // *** END: S·ª¨A L·ªñI (Lo·∫°i b·ªè n√∫t chi ti·∫øt LK) ***
            return;
        }
        
        const luykeViewSwitcherBtn = e.target.closest('#luyke-thidua-view-selector .view-switcher__btn');
        if (luykeViewSwitcherBtn) {
            e.preventDefault();
            appController.handleLuykeThiDuaViewChange(e);
            return;
        }

        // *** NEW (v3.29) ***
        const sknvThiDuaViewSwitcherBtn = e.target.closest('#sknv-thidua-view-selector .view-switcher__btn');
        if (sknvThiDuaViewSwitcherBtn) {
            e.preventDefault();
            // X·ª≠ l√Ω chuy·ªÉn ƒë·ªïi view tr·ª±c ti·∫øp
            const viewSelector = sknvThiDuaViewSwitcherBtn.closest('#sknv-thidua-view-selector');
            if (viewSelector) {
                 viewSelector.querySelectorAll('.view-switcher__btn').forEach(btn => btn.classList.remove('active'));
            }
            sknvThiDuaViewSwitcherBtn.classList.add('active');
            
            // Render l·∫°i tab SKNV (n√≥ s·∫Ω ƒë·ªçc n√∫t active n√†y)
            appController.updateAndRenderCurrentTab(); 
            return;
        }
        // *** END NEW ***

        const thiDuaViewSwitcherBtn = e.target.closest('#thidua-view-selector .view-switcher__btn');
        if (thiDuaViewSwitcherBtn) {
            e.preventDefault();
            appController.handleThiDuaViewChange(e);
            return;
        }
        const dtHangViewSwitcherBtn = e.target.closest('#dthang-realtime-view-selector .view-switcher__btn');
        if (dtHangViewSwitcherBtn) {
            e.preventDefault();
            appController.handleDthangRealtimeViewChange(e);
            return;
        }

        const downloadBtn = e.target.closest('.download-data-btn');
        if (downloadBtn) {
            e.preventDefault();
            const dataType = downloadBtn.dataset.type;
            const warehouse = downloadBtn.dataset.warehouse;
            if (dataType && warehouse && appController) {
                console.log(`[Body Click Listener] Download button clicked for ${dataType} @ ${warehouse}`);
                dataService.handleDownloadAndProcessData(dataType, warehouse); 
            } else {
                console.error("Download button clicked but missing data-type or data-warehouse.", downloadBtn);
            }
            return;
        }

        // === START: MODIFIED (v3.39) - N√¢ng c·∫•p b·ªô l·ªçc ng√†y ===
        
        // (Task 1) Listener cho c√°c n√∫t l·ªçc ng√†y (TR·ª™ n√∫t T√πy ch·ªçn)
        const dailyChartFilterBtn = e.target.closest('.lk-daily-filter-btn:not(#lk-daily-filter-custom)');
        if (dailyChartFilterBtn) {
            e.preventDefault();
            
            // X√≥a tr·∫°ng th√°i l·ªçc t√πy ch·ªânh (n·∫øu c√≥)
            if(appState.currentEmployeeDetailData) appState.currentEmployeeDetailData.customFilteredDailyStats = null;

            const filterValue = dailyChartFilterBtn.dataset.days; // "3", "5", "7", "10", "all"
            
            // C·∫≠p nh·∫≠t UI n√∫t
            document.querySelectorAll('.lk-daily-filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-200');
            });
            dailyChartFilterBtn.classList.add('bg-blue-600', 'text-white');
            dailyChartFilterBtn.classList.remove('bg-gray-200');

            const detailData = appState.currentEmployeeDetailData;
            if (detailData && detailData.dailyStats) {
                let dataForChart;
                if (filterValue === 'all') {
                    dataForChart = detailData.dailyStats; // L·∫•y t·∫•t c·∫£
                } else {
                    const days = parseInt(filterValue, 10);
                    dataForChart = detailData.dailyStats.slice(-days); // L·∫•y X ng√†y cu·ªëi
                }
                
                // G·ªçi tr·ª±c ti·∫øp h√†m render bi·ªÉu ƒë·ªì (nhanh h∆°n l√† render l·∫°i to√†n b·ªô tab)
                ui._renderDailyCharts(detailData.dailyStats, dataForChart); // Pass m·∫£ng ƒë√£ l·ªçc
            } else {
                console.warn("Kh√¥ng t√¨m th·∫•y appState.currentEmployeeDetailData.dailyStats, kh√¥ng th·ªÉ v·∫Ω l·∫°i bi·ªÉu ƒë·ªì.");
            }
            return;
        }

        // (Task 3) Listener cho n√∫t "T√πy ch·ªçn..."
        const customDateFilterBtn = e.target.closest('#lk-daily-filter-custom');
        if (customDateFilterBtn) {
            e.preventDefault();
            
            const detailData = appState.currentEmployeeDetailData;
            if (!detailData || !detailData.dailyStats) {
                ui.showNotification("L·ªói: Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ng√†y ƒë·ªÉ l·ªçc.", "error");
                return;
            }

            // C·∫≠p nh·∫≠t UI n√∫t (l√†m cho n√≥ active)
            document.querySelectorAll('.lk-daily-filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-200');
            });
            customDateFilterBtn.classList.add('bg-blue-600', 'text-white');
            customDateFilterBtn.classList.remove('bg-gray-200');

            // M·ªü Flatpickr
            flatpickr(customDateFilterBtn, {
                mode: "range",
                dateFormat: "Y-m-d", // D√πng ƒë·ªãnh d·∫°ng chu·∫©n ƒë·ªÉ l·ªçc
                maxDate: "today",
                defaultDate: [],
                onClose: (selectedDates) => {
                    if (selectedDates.length === 2) {
                        const [start, end] = selectedDates;
                        const startTime = start.getTime();
                        // Set end time to end of day
                        const endTime = new Date(end.getFullYear(), end.getMonth(), end.getDate(), 23, 59, 59).getTime();

                        const filteredStats = detailData.dailyStats.filter(stat => {
                            const statTime = new Date(stat.date).getTime();
                            return statTime >= startTime && statTime <= endTime;
                        });

                        // L∆∞u k·∫øt qu·∫£ l·ªçc t√πy ch·ªânh v√†o state
                        appState.currentEmployeeDetailData.customFilteredDailyStats = filteredStats;
                        
                        // V·∫Ω l·∫°i bi·ªÉu ƒë·ªì v·ªõi d·ªØ li·ªáu ƒë√£ l·ªçc
                        ui._renderDailyCharts(detailData.dailyStats, filteredStats);
                    } else {
                        // N·∫øu kh√¥ng ch·ªçn range, reset
                        if(appState.currentEmployeeDetailData) appState.currentEmployeeDetailData.customFilteredDailyStats = null;
                        // K√≠ch ho·∫°t n√∫t 7 ng√†y l√†m m·∫∑c ƒë·ªãnh
                        const sevenDayBtn = document.querySelector('.lk-daily-filter-btn[data-days="7"]');
                        if (sevenDayBtn) sevenDayBtn.click();
                    }
                }
            }).open(); // M·ªü l·ªãch ngay l·∫≠p t·ª©c
            return;
        }

        // (Task 3) Listener cho th·∫ª KPI "T·ªïng ƒë∆°n h√†ng" (Chi ti·∫øt LK)
        const customerTrigger = e.target.closest('#lk-detail-customer-trigger');
        if (customerTrigger) {
            e.preventDefault();
            const detailData = appState.currentEmployeeDetailData;
            const employeeData = appState.masterReportData.sknv.find(nv => String(nv.maNV) === String(appState.viewingDetailFor?.employeeId));
            
            if (detailData && employeeData) {
                // S·ª≠a l·ªói (Task 1): Th√™m t√™n NV v√†o ti√™u ƒë·ªÅ
                const modalTitle = document.getElementById('customer-detail-modal-title');
                if (modalTitle) modalTitle.textContent = `Chi ti·∫øt Kh√°ch h√†ng - ${employeeData.hoTen}`;
                
                // ƒê·ªï d·ªØ li·ªáu v√†o modal
                ui._renderCustomerDetailModalContent({ // S·ª≠a l·ªói path
                    byCustomer: detailData.byCustomer, 
                    mucTieu: employeeData.mucTieu 
                });
                // M·ªü modal
                ui.toggleModal('customer-detail-modal', true);
            }
            return;
        }

        // (Task 4) Listener cho th·∫ª KPI "DT Ch∆∞a Xu·∫•t" (Chi ti·∫øt LK ho·∫∑c T√≥m t·∫Øt)
        const unexportedTrigger = e.target.closest('#lk-detail-unexported-trigger, #lk-summary-unexported-trigger');
        if (unexportedTrigger) {
            e.preventDefault();
            const detailData = appState.currentEmployeeDetailData; // D·ªØ li·ªáu chi ti·∫øt (n·∫øu c√≥)
            const employeeData = appState.masterReportData.sknv.find(nv => String(nv.maNV) === String(appState.viewingDetailFor?.employeeId));
            const modalTitle = document.getElementById('unexported-detail-modal-title');

            if (detailData && employeeData) {
                // Case 1: ƒêang xem chi ti·∫øt nh√¢n vi√™n
                if (modalTitle) modalTitle.textContent = `Chi ti·∫øt Ch∆∞a xu·∫•t - ${employeeData.hoTen}`;
                ui._renderUnexportedDetailModalContent({ // S·ª≠a l·ªói path
                    unexportedDetails: detailData.unexportedDetails
                });
                ui.toggleModal('unexported-detail-modal', true);
            } else if (unexportedTrigger.id === 'lk-summary-unexported-trigger') {
                // Case 2: ƒêang xem t√≥m t·∫Øt si√™u th·ªã
                // (Ch·ª©c nƒÉng n√†y ch∆∞a ƒë∆∞·ª£c y√™u c·∫ßu, nh∆∞ng c√≥ th·ªÉ m·ªü r·ªông ·ªü ƒë√¢y)
                ui.showNotification('Chi ti·∫øt ch∆∞a xu·∫•t to√†n si√™u th·ªã ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.', 'success');
            }
            return;
        }

        // (Task 3) Listener cho c√°c n√∫t ƒëi·ªÅu khi·ªÉn b√™n trong Modal Kh√°ch h√†ng
        const customerModalControls = e.target.closest('#customer-detail-controls button[data-sort]');
        if (customerModalControls) {
            e.preventDefault();
            
            // S·ª≠a l·ªói (Task 3): Logic s·∫Øp x·∫øp
            const sortKey = customerModalControls.dataset.sort;
            let direction = customerModalControls.dataset.direction || 'desc';
            
            // Chuy·ªÉn h∆∞·ªõng
            direction = direction === 'desc' ? 'asc' : 'desc';
            customerModalControls.dataset.direction = direction;
            
            // C·∫≠p nh·∫≠t UI n√∫t
            document.querySelectorAll('#customer-detail-controls button[data-sort]').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-200');
                if (btn !== customerModalControls) btn.dataset.direction = 'desc'; // Reset n√∫t kh√°c
            });
            customerModalControls.classList.add('bg-blue-600', 'text-white');
            customerModalControls.classList.remove('bg-gray-200');
            // C·∫≠p nh·∫≠t text n√∫t
            const sortText = sortKey === 'totalRealRevenue' ? 'Doanh thu' : '% Quy ƒë·ªïi';
            const dirText = direction === 'desc' ? 'Cao > Th·∫•p' : 'Th·∫•p > Cao';
            customerModalControls.textContent = `${sortText} (${dirText})`;

            // S·∫Øp x·∫øp l·∫°i d·ªØ li·ªáu v√† render
            const detailData = appState.currentEmployeeDetailData;
            const employeeData = appState.masterReportData.sknv.find(nv => String(nv.maNV) === String(appState.viewingDetailFor?.employeeId));
            
            if (detailData && employeeData) {
                detailData.byCustomer.sort((a, b) => {
                    const valA = a[sortKey] || 0;
                    const valB = b[sortKey] || 0;
                    return direction === 'desc' ? valB - valA : valA - valB;
                });
                
                ui._renderCustomerDetailModalContent({ 
                    byCustomer: detailData.byCustomer, 
                    mucTieu: employeeData.mucTieu 
                });
            }
            return;
        }
        
        const captureCustomerBtn = e.target.closest('#capture-customer-detail-btn');
        if (captureCustomerBtn) {
            e.preventDefault();
            // S·ª≠a l·ªói (Task 2): Ch·ª•p n·ªôi dung v√† d√πng preset
            const modalContent = document.getElementById('customer-detail-list-container');
            if (modalContent) {
                captureService.captureAndDownload(modalContent, 'ChiTietKhachHang', 'preset-mobile-portrait');
            }
            return;
        }
        
        // (Task 4) Listener cho n√∫t ch·ª•p ·∫£nh Modal Ch∆∞a Xu·∫•t
        const captureUnexportedBtn = e.target.closest('#capture-unexported-detail-btn');
        if (captureUnexportedBtn) {
            e.preventDefault();
            // S·ª≠a l·ªói (Task 2): Ch·ª•p n·ªôi dung v√† d√πng preset
            const modalContent = document.getElementById('unexported-detail-list-container');
            if (modalContent) {
                captureService.captureAndDownload(modalContent, 'ChiTietChuaXuat', 'preset-mobile-portrait');
            }
            return;
        }
        // === END: S·ª¨A L·ªñI (v3.37) / MODIFIED (v3.39) ===
    });

    // Specific filter listeners (Gi·ªØ nguy√™n)
    document.getElementById('thidua-employee-filter')?.addEventListener('change', () => ui.displayCompetitionReport('employee'));
    document.getElementById('realtime-brand-category-filter')?.addEventListener('change', () => uiRealtime.handleBrandFilterChange());
    document.getElementById('realtime-brand-filter')?.addEventListener('change', () => uiRealtime.handleBrandFilterChange());
}
--- END FILE: ./event-listeners/ui-listeners.js ---

--- START FILE: ./index.html ---
<!DOCTYPE html>
<html lang="vi" data-contrast="3">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• ph√¢n t√≠ch s·ªë cho QLST MWG 5.0</title>

    <script src="https://cdn.tailwindcss.com"></script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script src="https://unpkg.com/feather-icons"></script>

    <link rel="stylesheet" href="./styles/dashboard.css">
    <style>
       #luyke-category-details-content td:first-child,
        #luyke-unexported-revenue-content td:first-child {
            text-transform: capitalize;
        }

       /* === START: Declaration Accordion Styles === */
    
       .declaration-group {
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
       }
       .declaration-group:last-child {
            border-bottom: none;
       }
       .declaration-group summary {
            display: flex;
            justify-content: space-between; 
            align-items: center; 
            padding: 1rem 0.5rem; 
            cursor: pointer; 
            font-size: 1.125rem; /* text-lg */ 
            font-weight: 700; /* font-bold */ 
            color: #374151; /* gray-700 */ 
            list-style: none; /* Hide default marker */
       }
       .declaration-group summary::-webkit-details-marker {
            display: none; /* Hide default marker for Chrome */
       }
       .declaration-group summary:hover {
            background-color: #f9fafb; /* gray-50 */
       }
     
       .declaration-group summary::after {
            content: '+'; 
            font-size: 1.5rem;
            font-weight: 500; 
            color: #6b7280; /* gray-500 */ 
            transition: transform 0.2s ease-in-out;
       }
       .declaration-group[open] > summary::after {
            transform: rotate(45deg);
            content: '√ó';
       }
       .declaration-content {
            padding: 1rem 0.5rem 1.5rem 0.5rem;
       }
       /* === END: Declaration Accordion Styles === */
  
    </style>
</head>
<body class="overflow-x-hidden">

    <div id="update-notification" class="hidden fixed bottom-5 right-5 bg-blue-600 text-white py-3 px-5 rounded-lg shadow-lg z-[1001] flex items-center gap-4">
        <p class="font-semibold">ƒê√£ c√≥ phi√™n b·∫£n m·ªõi! Xem chi ti·∫øt n·ªôi dung c·∫≠p nh·∫≠t ·ªü tab "H∆∞·ªõng D·∫´n & G√≥p √ù"</p> 
        <button onclick="window.location.reload()" class="bg-white text-blue-600 font-bold py-1 px-3 rounded-md hover:bg-blue-100 transition">T·∫£i l·∫°i trang</button> 
    </div>

    <div id="interface-drawer-container"></div>
    <div id="goal-drawer-container"></div>
    <div id="drawer-overlay" class="hidden fixed inset-0 bg-black bg-opacity-40 z-40"></div> 

    <div class="flex min-h-screen">
        
 <div id="sidebar-container"></div> 
        <main id="main-content" class="flex-1 p-6"> 

            <div class="max-w-full mx-auto">

                <section id="home-section" class="page-section hidden">
                    <div class="page-header">
                         <h2 class="page-header__title">H∆∞·ªõng D·∫´n & G√≥p √ù</h2> 
                         <div id="usage-counter-display" class="text-sm font-semibold"> 
                            <span class="text-blue-600">Ng∆∞·ªùi d√πng:</span> 
                            <span id="user-count" class="text-red-600 font-bold">-</span> 
                            <span class="text-blue-600 ml-4">L∆∞·ª£t truy c·∫≠p:</span> 
                            <span id="visitor-count" class="text-red-600 font-bold">-</span> 
                            <span class="text-blue-600 ml-4">L∆∞·ª£t s·ª≠ d·ª•ng:</span> 
                            <span id="action-count" class="text-red-600 font-bold">-</span> 
                        </div>
                    </div>


                    <div class="content-card">
                        <h3 class="content-card__header">Video H∆∞·ªõng D·∫´n S·ª≠ D·ª•ng Nhanh</h3> 
                         <div id="video-container" class="bg-gray-200 rounded-lg"> 
                            <iframe
                                class="w-full h-full aspect-video" 
                                src="https://www.youtube.com/embed/bmImlht_yB4?si=iIo9NZ7wc9FvKZKf" 
                                title="YouTube video player" 
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen> 
                            </iframe>
                         </div> 
                    </div>


                   <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8"> 
                        <div class="flex flex-col"> 
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">G√≥p √Ω & Th·∫£o lu·∫≠n</h2> 
                            <div id="feedback-composer" class="bg-white rounded-xl shadow-md p-6 border border-gray-200 flex-grow"> 
                            </div> 
                        </div>

                        <div class="flex flex-col"> 
                             <h2 class="text-2xl font-bold text-gray-800 mb-6">Danh s√°ch g√≥p √Ω</h2> 
                             <div id="feedback-list-container" class="bg-white rounded-xl shadow-md p-6 border border-gray-200 flex-grow"> 
                                <div id="feedback-list" class="space-y-6"> 
                                </div> 
                             </div>
                        </div>
                    </div> 

                    <div class="mt-12"> 
                         <h2 class="text-2xl font-bold text-gray-800 mb-6">L·ªãch s·ª≠ c·∫≠p nh·∫≠t</h2> 
                         <div id="update-history-list" class="space-y-6"> 
                         </div> 
                    </div>
                </section>

                <section id="data-section" class="page-section"> 
                        <div class="page-header">
                            <div class="flex flex-wrap items-center gap-4">
                                <div class="flex items-center gap-x-3">
                                    <h2 class="page-header__title">C·∫≠p nh·∫≠t d·ªØ li·ªáu</h2>
                                    <button class="page-header__help-btn" data-help-id="data" title="Xem h∆∞·ªõng d·∫´n">
                                        <i data-feather="help-circle"></i>
                                    </button>
                                </div>
                                <div id="data-warehouse-selector-container" class="flex-shrink-0 flex items-center gap-2">
                                    <label for="data-warehouse-selector" class="text-sm font-semibold text-gray-700">Kho:</label>
                                    <select id="data-warehouse-selector" 
                                            class="p-2 border rounded-lg text-sm shadow-sm min-w-[200px] 
                                                   font-semibold text-indigo-800 bg-indigo-50 border-indigo-200 
                                                   focus:ring-indigo-500 focus:border-indigo-500" 
                                            disabled>
                                        <option>Vui l√≤ng t·∫£i file DSNV ƒë·ªÉ ch·ªçn kho...</option>
                                    </select>
                                </div>
                            </div>
                            <div id="version-marquee-container" class="marquee-container flex-grow min-w-[200px]">
                                <p class="marquee-text"></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6"> <div class="content-card data-card--blue flex flex-col gap-4"> <h3 class="content-card__header data-header--blue">
                                    <i data-feather="zap" class="h-5 w-5"></i>S·ª¨ D·ª§NG NHANH M·ªñI NG√ÄY
                                </h3>
                
                                <div class="data-input-group input-group--blue">
                                    <a href="https://report.mwgroup.vn/home/dashboard/077" target="_blank" class="data-input-group__label data-input-group__label--link">
                                        <i data-feather="file-text" class="h-5 w-5"></i>
                                        <span>Y√™u c·∫ßu xu·∫•t l≈©y k·∫ø:</span>
                                    </a>
                                    <div class="data-input-group__content">
                                        <div class="flex items-center gap-2">
                                            <label for="file-ycx" class="data-input-group__file-trigger">Th√™m file</label>
                                            <span id="file-name-ycx" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                        </div>
                                        <input type="file" id="file-ycx" class="hidden file-input" data-name="Y√™u c·∫ßu xu·∫•t l≈©y k·∫ø" data-state-key="ycxData" data-save-key="saved_ycx" accept=".xlsx, .xls, .csv">
                                        <div class="data-input-group__status-wrapper"><span id="file-status-ycx" class="data-input-group__status-text"></span></div>
                                        <div id="progress-ycx" class="progress-bar-container hidden"><div class="progress-bar"></div></div>
                                    </div>
                                </div>
                
                                <div class="data-input-group input-group--blue h-full">
                                    <a href="https://bi.thegioididong.com/sieu-thi-con?id=16612&tab=1" target="_blank" class="data-input-group__label data-input-group__label--link">
                                        <i data-feather="clipboard" class="h-5 w-5"></i>
                                        <span>Data l≈©y k·∫ø: <span class="font-normal">(Copy t·ª´ BI)</span></span>
                                    </a>
                                    <div class="data-input-group__content">
                                        <textarea id="paste-luyke" rows="5" class="data-textarea" placeholder="D√°n d·ªØ li·ªáu ƒë√£ sao ch√©p..."></textarea>
                                        <div class="data-input-group__status-wrapper"><span id="status-luyke" class="data-input-group__status-text"></span></div>
                                    </div>
                                </div>
                
                                <div class="data-input-group input-group--blue h-full">
                                    <a href="https://bi.thegioididong.com/sieu-thi-con?id=16758&tab=bcdtnv&rt=2&dm=1" target="_blank" class="data-input-group__label data-input-group__label--link">
                                        <i data-feather="clipboard" class="h-5 w-5"></i>
                                        <span>Thi ƒëua nh√¢n vi√™n: <span class="font-normal">(Copy t·ª´ BI)</span></span>
                                    </a>
                                    <div class="data-input-group__content">
                                        <textarea id="paste-thiduanv" rows="5" class="data-textarea" placeholder="D√°n d·ªØ li·ªáu ƒë√£ sao ch√©p..."></textarea>
                                        <div class="data-input-group__status-wrapper"><span id="status-thiduanv" class="data-input-group__status-text"></span></div>
                                    </div>
                                </div>
                            </div>
                
                            <div class="content-card data-card--green flex flex-col gap-4"> <h3 class="content-card__header data-header--green">
                                    <i data-feather="users" class="h-5 w-5"></i>CHI TI·∫æT NƒÇNG SU·∫§T NH√ÇN VI√äN
                                </h3>
                                
                                <div class="data-input-group input-group--green">
                                    <a href="https://reports.thegioididong.com/#/viewreport/168754" target="_blank" class="data-input-group__label data-input-group__label--link">
                                        <i data-feather="clock" class="h-5 w-5"></i>
                                        <span>Gi·ªù c√¥ng:</span>
                                    </a>
                                    <div class="data-input-group__content">
                                        <div class="flex items-center gap-2">
                                            <label for="file-giocong" class="data-input-group__file-trigger">Th√™m file</label>
                                            <span id="file-name-giocong" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                        </div>
                                        <input type="file" id="file-giocong" class="hidden file-input" data-name="Gi·ªù c√¥ng" data-state-key="rawGioCongData" data-save-key="saved_giocong" accept=".xlsx, .xls, .csv">
                                        <div class="data-input-group__status-wrapper">
                                            <span id="file-status-giocong" class="data-input-group__status-text"></span>
                                        </div>
                                        <div id="progress-giocong" class="progress-bar-container hidden"><div class="progress-bar"></div></div>
                                    </div>
                                </div>
                
                                <div class="data-input-group input-group--green">
                                    <a href="https://report.mwgroup.vn/home/dashboard/105" target="_blank" class="data-input-group__label data-input-group__label--link">
                                        <i data-feather="gift" class="h-5 w-5"></i>
                                        <span>Th∆∞·ªüng n√≥ng:</span>
                                    </a>
                                    <div class="data-input-group__content">
                                        <div class="flex items-center gap-2">
                                            <label for="file-thuongnong" class="data-input-group__file-trigger">Th√™m file</label>
                                            <span id="file-name-thuongnong" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                        </div>
                                        <input type="file" id="file-thuongnong" class="hidden file-input" data-name="Th∆∞·ªüng n√≥ng" data-state-key="thuongNongData" data-save-key="saved_thuongnong" accept=".xlsx, .xls, .csv">
                                        <div class="data-input-group__status-wrapper">
                                            <span id="file-status-thuongnong" class="data-input-group__status-text"></span>
                                        </div>
                                        <div id="progress-thuongnong" class="progress-bar-container hidden"><div class="progress-bar"></div></div>
                                    </div>
                                </div>
                
                                <div class="data-input-group input-group--green h-full">
                                    <a href="https://bi.thegioididong.com/reward?id=-1&tab=1" target="_blank" class="data-input-group__label data-input-group__label--link">
                                        <i data-feather="clipboard" class="h-5 w-5"></i>
                                        <span>Th∆∞·ªüng ERP: <span class="font-normal">(Copy t·ª´ BI)</span></span>
                                    </a>
                                    <div class="data-input-group__content">
                                        <textarea id="paste-thuongerp" rows="5" class="data-textarea" placeholder="D√°n to√†n b·ªô d·ªØ li·ªáu th∆∞·ªüng ERP..."></textarea>
                                        <div class="data-input-group__status-wrapper"><span id="status-thuongerp" class="data-input-group__status-text"></span></div>
                                    </div>
                                </div>
                            </div>
                
                        </div>
                        <div class="content-card data-card--yellow"> 
                            <h3 class="content-card__header data-header--yellow">
                                <i data-feather="calendar" class="h-5 w-5"></i>D·ªÆ LI·ªÜU C·∫¨P NH·∫¨T 1 TH√ÅNG 1 L·∫¶N
                            </h3>
                            <p class="text-sm text-yellow-800 bg-yellow-100 p-3 rounded-lg mb-4">L∆∞u √Ω: D·ªØ li·ªáu trong ph·∫ßn n√†y s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o tr√¨nh duy·ªát c·ªßa b·∫°n. D·ªØ li·ªáu s·∫Ω t·ªìn t·∫°i cho ƒë·∫øn khi b·∫°n c·∫≠p nh·∫≠t l·∫°i.</p> 
                
                            <div class="grid md:grid-cols-3 gap-4"> <div class="space-y-4"> <div class="data-input-group input-group--yellow"> 
                                        <label class="data-input-group__label">
                                            <i data-feather="users" class="h-5 w-5"></i>
                                            <span>Danh s√°ch nh√¢n vi√™n:</span>
                                        </label> 
                                        <div class="data-input-group__content"> 
                                            <div class="flex items-center gap-2"> 
                                                <label for="file-danhsachnv" class="data-input-group__file-trigger">Th√™m file</label> 
                                                <span id="file-name-danhsachnv" class="data-input-group__file-name">Ch∆∞a th√™m file</span> 
                                            </div> 
                                            <button id="download-danhsachnv-template-btn" class="data-input-group__link text-left">T·∫£i file m·∫´u</button> 
                                            <input type="file" id="file-danhsachnv" class="hidden file-input" data-name="Danh s√°ch nh√¢n vi√™n" data-state-key="danhSachNhanVien" data-save-key="saved_danhsachnv" accept=".xlsx, .xls, .csv"> 
                                            <div class="data-input-group__status-wrapper"> 
                                                <span id="file-status-danhsachnv" class="data-input-group__status-text"></span> 
                                            </div> 
                                            <div id="progress-danhsachnv" class="progress-bar-container hidden"><div class="progress-bar"></div></div> 
                                        </div> 
                                    </div> 
                                    <div class="data-input-group input-group--yellow"> 
                                        <label class="data-input-group__label">
                                            <i data-feather="file-text" class="h-5 w-5"></i>
                                            <span>YCX L≈©y K·∫ø th√°ng tr∆∞·ªõc:</span>
                                        </label> 
                                        <div class="data-input-group__content"> 
                                            <div class="flex items-center gap-2"> 
                                                <label for="file-ycx-thangtruoc" class="data-input-group__file-trigger">Th√™m file</label> 
                                                <span id="file-name-ycx-thangtruoc" class="data-input-group__file-name">Ch∆∞a th√™m file</span> 
                                            </div> 
                                            <input type="file" id="file-ycx-thangtruoc" class="hidden file-input" data-name="YCX L≈©y K·∫ø th√°ng tr∆∞·ªõc" data-state-key="ycxDataThangTruoc" data-save-key="saved_ycx_thangtruoc" accept=".xlsx, .xls, .csv"> 
                                            <div class="data-input-group__status-wrapper"> 
                                                <span id="file-status-ycx-thangtruoc" class="data-input-group__status-text"></span> 
                                            </div> 
                                            <div id="progress-ycx-thangtruoc" class="progress-bar-container hidden"><div class="progress-bar"></div></div> 
                                        </div> 
                                    </div> 
                                </div> 
                                <div class="space-y-4"> <div class="data-input-group input-group--yellow"> 
                                        <label class="data-input-group__label">
                                            <i data-feather="gift" class="h-5 w-5"></i>
                                            <span>Th∆∞·ªüng n√≥ng th√°ng tr∆∞·ªõc:</span>
                                        </label> 
                                        <div class="data-input-group__content"> 
                                            <div class="flex items-center gap-2"> 
                                                <label for="file-thuongnong-thangtruoc" class="data-input-group__file-trigger">Th√™m file</label> 
                                                <span id="file-name-thuongnong-thangtruoc" class="data-input-group__file-name">Ch∆∞a th√™m file</span> 
                                            </div> 
                                            <input type="file" id="file-thuongnong-thangtruoc" class="hidden file-input" data-name="Th∆∞·ªüng n√≥ng th√°ng tr∆∞·ªõc" data-state-key="thuongNongDataThangTruoc" data-save-key="saved_thuongnong_thangtruoc" accept=".xlsx, .xls, .csv"> 
                                            <div class="data-input-group__status-wrapper"> 
                                                <span id="file-status-thuongnong-thangtruoc" class="data-input-group__status-text"></span> 
                                            </div> 
                                            <div id="progress-thuongnong-thangtruoc" class="progress-bar-container hidden"><div class="progress-bar"></div></div> 
                                        </div> 
                                    </div> 
                                </div> 
                                <div class="space-y-4"> <div class="data-input-group input-group--yellow h-full"> 
                                        <label class="data-input-group__label">
                                            <i data-feather="clipboard" class="h-5 w-5"></i>
                                            <span>Th∆∞·ªüng ERP th√°ng tr∆∞·ªõc:</span>
                                        </label> 
                                        <div class="data-input-group__content"> 
                                            <textarea id="paste-thuongerp-thangtruoc" rows="5" class="data-textarea" placeholder="D√°n d·ªØ li·ªáu th∆∞·ªüng ERP th√°ng tr∆∞·ªõc..."></textarea> 
                                            <div class="data-input-group__status-wrapper"> 
                                                <span id="status-thuongerp-thangtruoc" class="data-input-group__status-text"></span> 
                                            </div> 
                                        </div> 
                                    </div> 
                                </div> 
                            </div> 
                        </div> 
                        </section> 
                
                <section id="health-section" class="page-section hidden">


                    <div id="health-section-placeholder" class="placeholder-message hidden">Vui l√≤ng c·∫≠p nh·∫≠t danh s√°ch nh√¢n vi√™n ƒë·ªÉ xem k·∫øt qu·∫£.</div> 
                    <div id="health-section-content"> 
                        <div class="content-card"> 
                            <div class="page-header border-b pb-4 mb-6"> 
                                <h2 class="page-header__title">S·ª©c kh·ªèe si√™u th·ªã</h2> 
                                <button class="page-header__help-btn" data-help-id="luyke" title="Xem h∆∞·ªõng d·∫´n"> 
                                    <i data-feather="help-circle"></i> 
                                </button> 
                            </div> 
                            <button class="toggle-filters-btn" data-target="luyke-filter-container"> 
                                <span class="text">Hi·ªán b·ªô l·ªçc n√¢ng cao</span> 
                                <i data-feather="chevron-down" class="icon"></i> 
                            </button> 
                            <div id="luyke-filter-container" class="advanced-filters hidden"> 
                                <div id="luyke-filter-bar" class="p-4 bg-slate-50 border border-slate-200 rounded-lg space-y-4"> 
                                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end"> 
                                        <div class="md:col-span-2"> 
                                            <label for="luyke-filter-date" class="block text-sm font-medium text-gray-600 mb-1">Ng√†y t·∫°o</label> 
                                            <div class="relative"> 
                                                <input type="text" id="luyke-filter-date" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full" placeholder="Ch·ªçn ng√†y..."> 
                                                <button id="luyke-clear-date" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-500 text-xs">B·ªè ch·ªçn</button> 
                                            </div> 
                                            <span id="luyke-date-summary" class="text-xs text-red-500 mt-1 block"></span> 
                                        </div> 
                                        <div class="md:col-span-2"><label for="luyke-filter-warehouse" class="block text-sm font-medium text-gray-600 mb-1">M√£ Kho</label><select id="luyke-filter-warehouse" class="p-2 border
    rounded-lg text-sm bg-white shadow-sm w-full"></select></div> 
                                        <div class="md:col-span-2"><label for="luyke-filter-department" class="block text-sm font-medium text-gray-600 mb-1">B·ªô Ph·∫≠n</label><select id="luyke-filter-department" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select></div> 
                                        <div class="md:col-span-6"><label for="luyke-filter-name" class="block text-sm font-medium text-gray-600 mb-1">Nh√¢n Vi√™n</label><select id="luyke-filter-name" multiple></select></div> 
                                    </div> 
                                    <div class="border-t pt-4 grid grid-cols-1 md:grid-cols-12 gap-4 items-end"> 
                                        <div class="md:col-span-3"><label for="luyke-highlight-nhanhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u
    ng√†nh h√†ng</label><select id="luyke-highlight-nhanhang" multiple></select></div> 
                                        <div class="md:col-span-3"><label for="luyke-highlight-nhomhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√≥m h√†ng</label><select id="luyke-highlight-nhomhang" multiple></select></div> 
                                        <div class="md:col-span-3"><label for="luyke-highlight-employee" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√¢n vi√™n</label><select id="luyke-highlight-employee" multiple></select></div> 
                                        <div class="md:col-span-3 flex items-end gap-2"> 
                                            <div><label for="luyke-highlight-color" class="block text-sm font-medium text-gray-600 mb-1">Ch·ªçn m√†u</label><input type="color" id="luyke-highlight-color" value="#ffff00" class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"></div> 
                                            <button id="luyke-clear-highlight" class="bg-red-500 text-white px-4 h-10 rounded-lg hover:bg-red-600 transition text-sm">X√≥a m√†u</button> 
                                        </div> 
                                    </div>
                                </div> 
                            </div> 
                        </div>

                        <div class="flex justify-between items-center mb-8"> 
                            <nav id="luyke-subtabs-nav" class="border-b border-gray-200 -mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" data-content-container="luyke-subtabs-content"> 
                                <button class="sub-tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-luyke-sieu-thi" data-title="SieuThiLuyKe"> 
                                    <i data-feather="home"></i> 
                                    <span>Si√™u th·ªã L≈©y k·∫ø</span> 
                                </button>
                                <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-luyke-thi-dua" data-title="ThiDuaLuyKe"> 
                                    <i data-feather="award"></i> 
                                    <span>Thi ƒëua L≈©y k·∫ø</span> 
                                </button>
                                <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-luyke-thidua-vung" data-title="ThiDuaVung"> 
                                    <i data-feather="map"></i> 
                                    <span>Thi ƒêua V√πng TNB</span> 
                                </button>
                            </nav> 
                            <div class="flex items-center gap-x-2"> 
                                <button id="compose-luyke-notification-btn" class="action-btn action-btn--composer" title="Nh·∫≠n x√©t"> 
                                    <i data-feather="pen-tool"></i> 
                                    <span>Nh·∫≠n x√©t</span> 
                                </button> 
                                <button id="export-luyke-btn" class="action-btn action-btn--export" title="Xu·∫•t Excel tab hi·ªán t·∫°i"> 
                                    <i data-feather="download"></i> 
                                    <span>Xu·∫•t Excel</span> 
                                </button>
                                <button id="capture-luyke-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh tab hi·ªán t·∫°i"> 
                                    <i data-feather="camera"></i> 
                                    <span>Ch·ª•p m√†n h√¨nh</span> 
                                </button> 
                            </div>
                        </div>

                        <div id="luyke-subtabs-content"> 
                            <div id="subtab-luyke-sieu-thi" class="sub-tab-content space-y-8"> 
                                <h2 id="luyke-supermarket-title" class="text-2xl font-bold text-center text-gray-700"></h2> 
                                <div id="luyke-kpi-cards-container" data-capture-group="kpi" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"> 
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg"> <h4 class="kpi-card-title">Doanh thu th·ª±c</h4> 
                                        <p id="luyke-kpi-dt-thuc-main" class="font-bold mt-2 mb-3">0</p> 
                                        <p id="luyke-kpi-dt-thuc-sub1" class="text-sm">DK: 0 / Target: 0</p> 
                                    </div>
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg"> <h4 class="kpi-card-title">Doanh thu Quy ƒë·ªïi</h4> 
                                        <p id="luyke-kpi-dt-qd-main" class="font-bold mt-2 mb-3">0</p> 
                                        <p id="luyke-kpi-dt-qd-sub1" class="text-sm">DK: 0 / Target: 0</p> 
                                    </div> 
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg"> <h4 class="kpi-card-title">T·ª∑ l·ªá ho√†n th√†nh Target</h4> 
                                        <p id="luyke-kpi-ht-target-qd-main" class="font-bold mt-2 mb-3">0%</p> 
                                        <p id="luyke-kpi-ht-target-thuc-sub" class="text-sm">DT Th·ª±c: 0%</p> 
                                    </div> <div class="kpi-card p-6 rounded-2xl shadow-lg"> <h4 class="kpi-card-title">T·ª∑ l·ªá quy ƒë·ªïi</h4> 
                                        <p id="luyke-kpi-tl-qd-main" class="font-bold mt-2 mb-3">0%</p> 
                                        <p id="luyke-kpi-tl-qd-sub" class="text-sm">M·ª•c ti√™u: 0%</p> 
                                    </div> <div class="kpi-card p-6 rounded-2xl shadow-lg"> <h4 class="kpi-card-title">Doanh thu tr·∫£ ch·∫≠m</h4> 
                                        <p id="luyke-kpi-dt-tc-main" class="font-bold mt-2 mb-3">0</p> 
                                        <p id="luyke-kpi-dt-tc-sub" class="text-sm">% th·ª±c tr·∫£ ch·∫≠m: 0%</p> 
                                    </div> <div class="kpi-card p-6 rounded-2xl shadow-lg"> <h4 class="kpi-card-title">DTQƒê Ch∆∞a xu·∫•t</h4> 
                                        <p id="luyke-kpi-dtqd-chua-xuat-main" class="font-bold mt-2 mb-3">0</p> 
                                    </div> <div class="kpi-card p-6 rounded-2xl shadow-lg"> <h4 class="kpi-card-title">Thi ƒëua ng√†nh h√†ng</h4> 
                                        <p id="luyke-kpi-thidua-main" class="font-bold mt-2 mb-3">0%</p> 
                                        <p id="luyke-kpi-thidua-sub" class="text-sm">0/0 Ng√†nh</p> 
                                    </div> 
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg"> <h4 class="kpi-card-title">TƒÉng/gi·∫£m c√πng k·ª≥</h4> 
                                        <p id="luyke-kpi-dtck-main" class="font-bold mt-2 mb-3">N/A</p> 
                                        <p id="luyke-kpi-dtck-sub" class="text-sm">Doanh thu: 0 | 0%</p> 
                                        <p id="luyke-kpi-lkck-sub" class="text-sm">L∆∞·ª£t kh√°ch: 0 | 0%</p> 
                                    </div> 
                                </div> 
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start"> 
                                    <div data-capture-group="1" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200"><h3 class="text-xl font-bold text-gray-700 mb-4 uppercase">Hi·ªáu qu·∫£ khai th√°c</h3><div id="luyke-efficiency-content"></div></div>
                                    <div data-capture-group="1" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200"><h3 class="text-xl font-bold text-gray-700 mb-4 uppercase">Nh√≥m h√†ng quy ƒë·ªïi cao</h3><div id="luyke-qdc-content"></div></div> 
                                </div> 
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start"> 
                                    <div data-capture-group="2" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200"><h3 class="text-xl font-bold text-gray-700 mb-4 uppercase">Ng√†nh h√†ng chi ti·∫øt</h3><div id="luyke-category-details-content"></div></div> 
                                    <div data-capture-group="2" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200"><h3 class="text-xl font-bold uppercase mb-4">Doanh thu ch∆∞a xu·∫•t</h3><div id="luyke-unexported-revenue-content"></div></div> 
                                </div> 
                            </div> 
                            <div id="subtab-luyke-thi-dua" class="sub-tab-content hidden space-y-4"> 
                                <div class="flex flex-wrap items-center justify-between gap-4"> 
                                    <div class="flex flex-wrap items-center gap-4"> 
                                        <h3 class="text-xl font-bold text-gray-800 uppercase">Thi ƒëua l≈©y k·∫ø <span id="luyke-competition-summary" class="text-sm font-normal"></span></h3> 
                                        <div id="luyke-thidua-view-selector" class="view-switcher"> 
                                            <button data-view="summary" class="view-switcher__btn active">Theo Ph√¢n Lo·∫°i</button> 
                                            <button data-view="completion" class="view-switcher__btn">Theo % Ho√†n Th√†nh</button> 
                                        </div> 
                                    </div>
                                    <div id="luyke-competition-content"></div> 
                                </div> 
                            </div>
    
                            <div id="subtab-luyke-thidua-vung" class="sub-tab-content hidden"> 
                                <div class="content-card"> 
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end"> 
                                        <div class="data-input-group"> 
                                            <div class="flex flex-col sm:flex-row sm:items-center sm:gap-4"> 
                                                <label class="data-input-group__label !mb-2 sm:!mb-0 flex-shrink-0">File Thi ƒêua V√πng:</label> 
                                                <div class="flex items-center gap-2"> 
                                                    <label for="file-thidua-vung" class="data-input-group__file-trigger">Th√™m file</label> 
                                                    <span id="file-name-thidua-vung" class="data-input-group__file-name">Ch∆∞a th√™m file</span> 
                                                </div>
                                            </div> 
                                            <input type="file" id="file-thidua-vung" class="hidden file-input" data-name="Thi ƒëua v√πng" accept=".xlsx, .xls, .csv"> 
                                            <div class="data-input-group__status-wrapper mt-2"><span id="file-status-thidua-vung" class="data-input-group__status-text"></span></div> 
                                        </div>
                                        <div> 
                                            <label for="thidua-vung-filter-supermarket" class="block text-sm font-medium text-gray-600 mb-1">Ch·ªçn Si√™u th·ªã</label> 
                                            <select id="thidua-vung-filter-supermarket"></select> 
                                        </div> 
                                    </div>
                                </div> 
                                <div id="thidua-vung-infographic-container"> 
                                    <div class="placeholder-message">Vui l√≤ng t·∫£i file v√† ch·ªçn m·ªôt si√™u th·ªã ƒë·ªÉ xem b√°o c√°o.</div> 
                                </div> 
                            </div> 
                        </div>
                    </div>
                </section> 

                <section id="health-employee-section" class="page-section hidden"> 

                    <div id="health-employee-section-placeholder" class="placeholder-message hidden">Vui l√≤ng c·∫≠p nh·∫≠t danh s√°ch nh√¢n vi√™n ƒë·ªÉ xem k·∫øt qu·∫£.</div> 
 
                    <div id="health-employee-section-content"> 
                        <div class="content-card"> 
                            <div class="page-header border-b pb-4 mb-6"> 
                                <h2 class="page-header__title">S·ª©c kh·ªèe nh√¢n vi√™n</h2> 
                                <button class="page-header__help-btn" data-help-id="sknv" title="Xem h∆∞·ªõng d·∫´n"> 
                                    <i data-feather="help-circle"></i> 
                                </button> 
                            </div>

                            <button class="toggle-filters-btn" data-target="sknv-filter-container"> 
                                <span class="text">Hi·ªán b·ªô l·ªçc n√¢ng cao</span> 
                                <i data-feather="chevron-down" class="icon"></i> 
                            </button> 
                            <div id="sknv-filter-container" class="advanced-filters hidden"> 
                                <div id="sknv-filter-bar" class="p-4 bg-slate-50 border border-slate-200 rounded-lg space-y-4"> 
                                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end"> 
                                        <div class="md:col-span-2"> 
                                            <label for="sknv-filter-date" class="block text-sm font-medium text-gray-600 mb-1">Ng√†y t·∫°o</label> 
                                            <div class="relative"> 
                                                <input type="text" id="sknv-filter-date" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full" placeholder="Ch·ªçn ng√†y..."> 
                                                <button id="sknv-clear-date" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-500 text-xs">B·ªè ch·ªçn</button> 
                                            </div> 
                                            <span id="sknv-date-summary" class="text-xs text-red-500 mt-1 block"></span> 
                                        </div> 
                                        <div class="md:col-span-2"><label for="sknv-filter-warehouse" class="block text-sm font-medium text-gray-600 mb-1">M√£ Kho</label><select id="sknv-filter-warehouse" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select></div> 
                                        <div class="md:col-span-2"><label for="sknv-filter-department" class="block text-sm font-medium text-gray-600 mb-1">B·ªô Ph·∫≠n</label><select id="sknv-filter-department" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select></div> 
                                        <div class="md:col-span-6"><label for="sknv-filter-name" class="block text-sm font-medium text-gray-600 mb-1">Nh√¢n Vi√™n</label><select id="sknv-filter-name" multiple></select></div> 
                                    </div> 
                                    <div class="border-t pt-4 grid grid-cols-1 md:grid-cols-12 gap-4 items-end"> 
                                        <div class="md:col-span-3"><label for="sknv-highlight-nhanhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u ng√†nh h√†ng</label><select id="sknv-highlight-nhanhang" multiple></select></div> 
                                        <div class="md:col-span-3"><label for="sknv-highlight-nhomhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√≥m h√†ng</label><select id="sknv-highlight-nhomhang" multiple></select></div> 
                                        <div class="md:col-span-3"><label for="sknv-highlight-employee" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√¢n vi√™n</label><select id="sknv-highlight-employee" multiple></select></div> 
                                        <div class="md:col-span-3 flex items-end gap-2"> 
                                            <div><label for="sknv-highlight-color" class="block text-sm font-medium text-gray-600 mb-1">Ch·ªçn m√†u</label><input type="color" id="sknv-highlight-color" value="#ffff00" class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"></div> 
                                            <button id="sknv-clear-highlight" class="bg-red-500 text-white px-4 h-10 rounded-lg hover:bg-red-600 transition text-sm">X√≥a m√†u</button> 
                                        </div>
                                    </div> 
                                </div>
                            </div> 
                        </div>



                        <div class="content-card"> 
                            <div class="flex justify-between items-center mb-8">
                                <nav id="employee-subtabs-nav" class="border-b border-gray-200 -mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" data-content-container="employee-subtabs-content"> 
                                    <button class="sub-tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-sknv" data-title="SKNV"> 
                                        <i data-feather="users"></i> 
                                        <span>SKNV</span> 
                                    </button> 
                                    <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-doanhthu-lk" data-title="DoanhThuLK"> 
                                        <i data-feather="dollar-sign"></i> 
                                        <span>Doanh thu LK</span> 
                                    </button> 
                                    <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-thunhap" data-title="ThuNhap"> 
                                        <i data-feather="briefcase"></i> 
                                        <span>Thu nh·∫≠p</span> 
                                    </button>
                                    <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-hieu-qua-khai-thac-luy-ke" data-title="HieuQuaKhaiThacLuyKe"> 
                                        <i data-feather="bar-chart-2"></i> 
                                        <span>Hi·ªáu qu·∫£ NV LK</span>
                                    </button> 
                                    <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-doanhthu-nganhhang" data-title="DTNganhHang"> 
                                        <i data-feather="layers"></i> 
                                        <span>DT ng√†nh h√†ng</span> 
                                    </button> 
                                    <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-hieu-qua-thi-dua-lk" data-title="HieuQuaThiDuaLK"> 
                                        <i data-feather="award"></i> 
                                        <span>Thi ƒëua NV LK</span> 
                                    </button>
                                </nav> 
                                <div class="flex items-center gap-x-2"> 
                                    <button id="compose-sknv-notification-btn" class="action-btn action-btn--composer" title="Nh·∫≠n x√©t"> 
                                        <i data-feather="pen-tool"></i> 
                                        <span>Nh·∫≠n x√©t</span> 
                                    </button>
                                    <button id="export-sknv-btn" class="action-btn action-btn--export" title="Xu·∫•t Excel tab hi·ªán t·∫°i"> 
                                        <i data-feather="download"></i> 
                                        <span>Xu·∫•t Excel</span> 
                                    </button>
                                    <button id="capture-sknv-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh tab hi·ªán t·∫°i"> 
                                        <i data-feather="camera"></i> 
                                        <span>Ch·ª•p m√†n h√¨nh</span> 
                                    </button> 
                                </div>
                            </div>

                            <div id="employee-subtabs-content"> 
                                <div id="subtab-sknv" class="sub-tab-content"> 
                                    <div id="sknv-summary-container"></div> 
                                    <div id="sknv-details-container" class="mt-6 hidden"> 
                                        <p class="text-gray-500">Vui l√≤ng ch·ªçn m·ªôt nh√¢n vi√™n ƒë·ªÉ xem chi ti·∫øt.</p> 
                                    </div> 
                                </div> 
                                <div id="subtab-doanhthu-lk" class="sub-tab-content hidden space-y-6"> 
                                    <div id="revenue-report-container-lk"></div> 
                                    <div id="dtnv-lk-details-container"></div> 
                                </div> 
                                <div id="subtab-thunhap" class="sub-tab-content hidden space-y-6"> 
                                    <div id="income-report-placeholder"> 
                                        <p class="text-gray-500 mb-4">Vui l√≤ng t·∫£i ƒë·ªß c√°c file: <b>Danh s√°ch nh√¢n vi√™n, Y√™u c·∫ßu xu·∫•t l≈©y k·∫ø, Gi·ªù c√¥ng, Th∆∞·ªüng n√≥ng</b> v√† x·ª≠ l√Ω <b>Th∆∞·ªüng ERP</b> ·ªü tab Data ƒë·ªÉ xem b√°o c√°o thu nh·∫≠p.</p> 
                                    </div>
                                    <div id="income-report-container"></div> 
                                </div>
                                <div id="subtab-hieu-qua-khai-thac-luy-ke" class="sub-tab-content hidden space-y-6" data-capture-preset="landscape-table"> 
                                    <div id="efficiency-report-container"></div> 
                                </div> 
                                <div id="subtab-doanhthu-nganhhang" class="sub-tab-content hidden space-y-6" data-capture-preset="mobile-portrait"> 
                                    <div id="category-revenue-report-container"></div> 
                                </div>
                                <div id="subtab-hieu-qua-thi-dua-lk" class="sub-tab-content hidden space-y-6"> 
                                    <div class="flex justify-start items-center"> 
                                        <div id="sknv-thidua-view-selector" class="view-switcher"> 
                                            <button data-view="program" class="view-switcher__btn">Theo Ch∆∞∆°ng Tr√¨nh</button> 
                                            <button data-view="employee" class="view-switcher__btn active">Theo Nh√¢n Vi√™n</button> 
                                        </div>
                                    </div>

                                    <div id="competition-report-container-lk" class="mt-4 view-content-program"> 
                                        <p class="text-gray-500">Vui l√≤ng khai b√°o ch∆∞∆°ng tr√¨nh thi ƒëua trong "Thi·∫øt l·∫≠p m·ª•c ti√™u" ƒë·ªÉ xem b√°o c√°o.</p> 
                                    </div>

                                    <div id="pasted-competition-report-container" class="mt-4 view-content-employee hidden"> 
                                        <p class="text-gray-500">Vui l√≤ng d√°n d·ªØ li·ªáu "Thi ƒëua nh√¢n vi√™n" ·ªü tab "C·∫≠p nh·∫≠t d·ªØ li·ªáu" ƒë·ªÉ xem b√°o c√°o.</p> 
                                    </div>
                                    
                                    <div id="pasted-competition-detail-container" class="mt-4 hidden"> 
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section> 
                 <section id="realtime-section" class="page-section hidden">
                    <div id="realtime-section-placeholder" class="placeholder-message hidden">Vui l√≤ng c·∫≠p nh·∫≠t danh s√°ch nh√¢n vi√™n ƒë·ªÉ xem k·∫øt qu·∫£.</div> 
                    <div id="realtime-section-content"> 
                        <div class="content-card"> 
                            <div class="page-header border-b pb-4 mb-6"> 
                                <div class="flex items-center gap-x-3"> 
                                    <h2 class="page-header__title">Ph√¢n T√≠ch Doanh Thu Realtime</h2> 
                                    <button class="page-header__help-btn" data-help-id="realtime" title="Xem h∆∞·ªõng d·∫´n"> 
                                        <i data-feather="help-circle"></i> 
                                    </button> 
                                </div> 
                                <div class="flex-shrink-0 flex items-center gap-x-4 ml-auto"> 
                                    <label for="realtime-file-input" class="cursor-pointer bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm font-medium whitespace-nowrap">Th√™m file Realtime</label> 
                                    <input type="file" id="realtime-file-input" class="hidden" accept=".xlsx, .xls, .csv"> 
                                    <a href="https://report.mwgroup.vn/home/dashboard/077" target="_blank" class="text-blue-600 hover:underline whitespace-nowrap text-sm">L·∫•y file t·∫°i ƒë√¢y</a> 
                                </div> 
                            </div>

                            <button class="toggle-filters-btn" data-target="realtime-filter-container"> 
                                <span class="text">Hi·ªán b·ªô l·ªçc n√¢ng cao</span> 
                                <i data-feather="chevron-down" class="icon"></i> 
                            </button>
                            <div id="realtime-filter-container" class="advanced-filters hidden"> 
                                <div id="realtime-filter-bar" class="p-4 bg-slate-50 border border-slate-200 rounded-lg space-y-4"> 
                                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end"> 
                                        <div class="md:col-span-3"><label
    for="realtime-filter-warehouse" class="block text-sm font-medium text-gray-600 mb-1">M√£ Kho</label><select id="realtime-filter-warehouse" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select></div> 
                                        <div class="md:col-span-3"><label for="realtime-filter-department" class="block text-sm font-medium text-gray-600 mb-1">B·ªô Ph·∫≠n</label><select id="realtime-filter-department" class="p-2 border rounded-lg text-sm bg-white shadow-sm w-full"></select></div> 
                                        <div class="md:col-span-6"><label for="realtime-filter-name" class="block text-sm font-medium text-gray-600 mb-1">Nh√¢n Vi√™n</label><select
    id="realtime-filter-name" multiple></select></div> 
                                    </div> 
                                    <div class="border-t pt-4 grid grid-cols-1 md:grid-cols-12 gap-4 items-end"> 
                                        <div class="md:col-span-3"><label for="realtime-highlight-nhanhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u ng√†nh h√†ng</label><select id="realtime-highlight-nhanhang" multiple></select></div> 
                                        <div class="md:col-span-3"><label for="realtime-highlight-nhomhang" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√≥m h√†ng</label><select id="realtime-highlight-nhomhang" multiple></select></div> 
                                        <div class="md:col-span-3"><label for="realtime-highlight-employee" class="block text-sm font-medium text-gray-600 mb-1">T√¥ m√†u nh√¢n vi√™n</label><select id="realtime-highlight-employee" multiple></select></div> 
                                        <div class="md:col-span-3 flex items-end gap-2"> 
                                            <div><label for="realtime-highlight-color" class="block text-sm font-medium text-gray-600 mb-1">Ch·ªçn m√†u</label><input type="color" id="realtime-highlight-color" value="#ffff00" class="p-1 h-10 w-14 block bg-white border border-gray-300 cursor-pointer rounded-lg"></div> 
                                            <button id="realtime-clear-highlight" class="bg-red-500 text-white px-4 h-10 rounded-lg hover:bg-red-600 transition text-sm">X√≥a m√†u</button> 
                                        </div> 
                                    </div>
                                </div> 
                            </div>
                         </div>


                         <div class="flex justify-between items-center mb-8"> 
                             <nav id="realtime-subtabs-nav" class="border-b border-gray-200 -mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" data-content-container="realtime-subtabs-content"> 
                                <button class="sub-tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-realtime-sieu-thi" data-title="SieuThiRealtime"> 
                                    <i data-feather="zap"></i> 
                                    <span>Si√™u th·ªã Realtime</span> 
                                </button> 
                                <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-realtime-nhan-vien" data-title="DTNVRealtime"> 
                                    <i data-feather="pie-chart"></i> 
                                    <span>DT NV Realtime</span> 
                                </button> 
                                <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-realtime-hieu-qua" data-title="HieuQuaKhaiThacRealtime"> 
                                    <i data-feather="bar-chart-2"></i> 
                                    <span>Hi·ªáu qu·∫£ NV Realtime</span> 
                                </button>
                                <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-realtime-nganh-hang" data-title="NganhHangRealtime"> 
                                    <i data-feather="tag"></i> 
                                    <span>Ng√†nh h√†ng Realtime</span> 
                                </button> 
                                <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-realtime-hang" data-title="HangRealtime"> 
                                    <i data-feather="globe"></i> 
                                    <span>DT H√£ng Realtime</span> 
                                </button>
                                <button class="sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-target="subtab-hieu-qua-thi-dua-realtime" data-title="HieuQuaThiDuaRealtime"> 
                                    <i data-feather="award"></i> 
                                    <span>Thi ƒëua NV Realtime</span> 
                                </button> 
                            </nav>

                            <div class="flex items-center gap-x-2"> 
                                <button id="compose-realtime-notification-btn" class="action-btn action-btn--composer" title="Nh·∫≠n x√©t"> 
                                    <i data-feather="pen-tool"></i> 
                                    <span>Nh·∫≠n x√©t</span> 
                                </button> 
                                <button id="export-realtime-btn" class="action-btn action-btn--export" title="Xu·∫•t Excel tab hi·ªán t·∫°i"> 
                                    <i data-feather="download"></i> 
                                    <span>Xu·∫•t Excel</span> 
                                </button> 
                                <button id="capture-realtime-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh tab hi·ªán t·∫°i"> 
                                    <i data-feather="camera"></i> 
                                    <span>Ch·ª•p m√†n h√¨nh</span> 
                                </button>
                            </div> 
                        </div>


                         <div id="realtime-subtabs-content"> 
                            <div id="subtab-realtime-sieu-thi" class="sub-tab-content space-y-8"> 
                                <h2 id="realtime-supermarket-title" class="text-2xl font-bold text-center text-gray-700"></h2> 
                                <div id="realtime-kpi-cards-container" data-capture-group="kpi" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"> 
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg"> 
                                        <h4 class="kpi-card-title font-semibold uppercase tracking-wider">Doanh thu th·ª±c</h4> 
                                        <p id="rt-kpi-dt-thuc-main" class="font-bold mt-2 mb-3">0</p> 
                                        <p id="rt-kpi-dt-thuc-sub1" class="text-sm">% HT: <span class="kpi-percentage-value">0%</span> / Target: 0</p> 
                                        <p id="rt-kpi-dt-thuc-sub2" class="text-sm mt-1">DT Ch∆∞a xu·∫•t: 0</p> 
                                    </div> 
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg"> 
                                        <h4 class="kpi-card-title font-semibold uppercase tracking-wider">Doanh thu Quy ƒë·ªïi</h4> 
                                        <p id="rt-kpi-dt-qd-main" class="font-bold mt-2 mb-3">0</p> 
                                        <p id="rt-kpi-dt-qd-sub1" class="text-sm">% HT: <span class="kpi-percentage-value">0%</span> / Target: 0</p> 
                                        <p id="rt-kpi-dt-qd-sub2" class="text-sm mt-1">DTQƒê Ch∆∞a xu·∫•t: 0</p> 
                                    </div> 
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg"> 
                                        <h4 class="kpi-card-title font-semibold uppercase tracking-wider">T·ª∑ l·ªá quy ƒë·ªïi</h4> 
                                        <p id="rt-kpi-tl-qd-main" class="font-bold mt-2 mb-3 kpi-percentage-value">0%</p> 
                                        <p id="rt-kpi-tl-qd-sub" class="text-sm">M·ª•c ti√™u: 0%</p> 
                                    </div> 
                                    <div class="kpi-card p-6 rounded-2xl shadow-lg"> 
                                        <h4 class="kpi-card-title font-semibold uppercase tracking-wider">Doanh thu tr·∫£ ch·∫≠m</h4> 
                                        <p id="rt-kpi-dt-tc-main" class="font-bold mt-2 mb-3">0</p> 
                                        <p id="rt-kpi-dt-tc-sub" class="text-sm">% th·ª±c tr·∫£ ch·∫≠m: <span class="kpi-percentage-value">0%</span></p> 
                                    </div> 
                                </div> 
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start"> 
                                    <div id="realtime-qdc-panel" data-capture-group="1" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200"> 
                                        <h3 id="realtime-qdc-title" class="text-xl font-bold text-gray-700 mb-4 uppercase
    flex items-center gap-2"><span>NH√ìM H√ÄNG QUY ƒê·ªîI CAO</span></h3> 
                                        <div id="realtime-qdc-content"><p class="text-gray-500 font-bold">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p></div> 
                                    </div> 

                                    <div id="realtime-category-panel" data-capture-group="1" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200"> 
                                        <h3 id="realtime-category-title" class="text-xl font-bold text-gray-700 mb-4 uppercase flex items-center gap-2"> 
                                            <span>NG√ÄNH H√ÄNG CHI TI·∫æT</span> 
                                        </h3> 
                                        <div id="realtime-category-details-content"><p class="text-gray-500 font-bold">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p></div> 
                                    </div> 
                                </div>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start"> 
                                    <div id="realtime-efficiency-panel" data-capture-group="2" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200"> 
                                        <h3 id="realtime-efficiency-title" class="text-xl font-bold text-gray-700 mb-4 uppercase bg-yellow-100 text-yellow-800 p-2 rounded-md">HI·ªÜU QU·∫¢ KHAI TH√ÅC</h3> 
                                        <div id="realtime-efficiency-content"><p class="text-gray-500 font-bold">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p></div> 
                                    </div> 
                                    <div id="realtime-unexported-revenue-panel" data-capture-group="2" class="bg-white rounded-xl shadow-md p-4 sm:p-6 border border-gray-200 flex flex-col"> 
                                        <h3 class="text-xl font-bold uppercase mb-4 bg-red-100 text-red-800 p-2 rounded-md">DOANH THU CH∆ØA
    XU·∫§T</h3> 
                                        <div id="realtime-unexported-revenue-content" class="flex-grow"><p class="text-gray-500 font-bold text-center">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p></div> 
                                    </div>
                                </div> 
                            </div> 

                            <div id="subtab-realtime-nhan-vien" class="sub-tab-content hidden space-y-4" data-capture-preset="large-font-report"> 
                                <div id="realtime-employee-detail-container"></div> 
                                <div id="realtime-revenue-report-container"></div> 
                            </div> 
                            <div id="subtab-realtime-hieu-qua" class="sub-tab-content hidden space-y-4" data-capture-preset="landscape-table"> 
                                <div id="realtime-efficiency-report-container"></div> 
                            </div> 
                            <div id="subtab-realtime-nganh-hang" class="sub-tab-content hidden space-y-4" data-capture-preset="mobile-portrait"> 
                                <div id="realtime-category-revenue-report-container"></div> 
                            </div> 

                            <div id="subtab-realtime-hang" class="sub-tab-content hidden space-y-4"> 
                                <div class="content-card" data-capture-group="1"> 
                                    <div class="flex flex-wrap items-center justify-between gap-4 mb-4"> 
                                        <h3 class="text-xl font-bold text-gray-700 uppercase">Th·ªëng k√™ theo H√£ng</h3> 
                                        <div id="dthang-realtime-view-selector" class="view-switcher"> 
                                            <button data-view="brand" class="view-switcher__btn active">Theo H√£ng</button> 
                                            <button data-view="employee" class="view-switcher__btn">Theo Nh√¢n vi√™n</button> 
                                        </div> 
                                    </div> 
                                    <div class="flex flex-wrap items-center gap-4 mb-4"> 
                                        <div> 
                                            <label for="realtime-brand-category-filter" class="font-semibold text-sm text-gray-600">Ng√†nh h√†ng:</label> 
                                            <select id="realtime-brand-category-filter" class="p-2 border rounded-lg text-sm bg-white shadow-sm mt-1"></select> 
                                        </div>
                                        <div> 
                                            <label for="realtime-brand-filter" class="font-semibold text-sm text-gray-600">H√£ng:</label> 
                                            <select id="realtime-brand-filter"
    class="p-2 border rounded-lg text-sm bg-white shadow-sm mt-1"></select> 
                                        </div> 
                                    </div> 
                                    <div id="realtime-brand-report-container"> 
                                        <div id="realtime-brand-table-container"></div> 
                                        <div id="realtime-employee-table-container"
    class="hidden"></div> 
                                    </div> 
                                </div> 
                            </div> 

                            <div id="subtab-hieu-qua-thi-dua-realtime" class="sub-tab-content hidden space-y-6"> 
                                <div id="competition-report-container-rt"> 
                                    <p class="text-gray-500">Vui l√≤ng khai b√°o ch∆∞∆°ng tr√¨nh thi ƒëua trong "Thi·∫øt l·∫≠p m·ª•c ti√™u" ƒë·ªÉ xem b√°o c√°o.</p> 
                                </div> 
                            </div>
                        </div> 
                    </div>
                </section>

                <section id="declaration-section" class="page-section hidden"> 
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">Khai b√°o d·ªØ li·ªáu</h2> 
                    <div class="content-card"> 
                        <p class="text-sm text-yellow-600 bg-yellow-50 p-3 rounded-lg mb-4">L∆∞u √Ω: D·ªØ li·ªáu khai b√°o t·∫°i ƒë√¢y s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o tr√¨nh duy·ªát v√† s·ª≠ d·ª•ng cho c√°c logic t√≠nh to√°n. Ch·ªânh s·ª≠a v√† nh·∫•n "L∆∞u" ƒë·ªÉ c·∫≠p nh·∫≠t.</p> 

                        <div class="space-y-0">  
                            <details class="declaration-group" open> 
                                <summary>Khai b√°o Danh m·ª•c & C·∫•u tr√∫c</summary> 
                                <div class="declaration-content"> 
                                    <div class="grid md:grid-cols-2 gap-6 mt-4"> 
                                        <div class="data-input-group"> 
                                            <label class="data-input-group__label">Danh m·ª•c Ng√†nh h√†ng - Nh√≥m h√†ng - H√£ng:</label> 
                                            <div class="data-input-group__content"> 
                                                <div class="flex items-center gap-2"> 
                                                    <label for="file-category-structure" class="data-input-group__file-trigger">Th√™m file Excel</label> 
                                                    <span id="file-name-category-structure" class="data-input-group__file-name">Ch∆∞a th√™m file</span> 
                                                </div> 
                                                <p class="text-xs text-gray-500">File Excel c√≥ 2 sheet: sheet ƒë·∫ßu ti√™n c√≥ c·ªôt "Ng√†nh h√†ng", "Nh√≥m h√†ng"; sheet th·ª© hai t√™n l√† "H√£ng" c√≥ 1 c·ªôt ch·ª©a t√™n c√°c h√£ng.</p> 
                                                <input type="file" id="file-category-structure" class="hidden file-input" data-name="Danh m·ª•c Ng√†nh/Nh√≥m h√†ng" data-state-key="categoryStructure" data-save-key="saved_category_structure" accept=".xlsx, .xls, .csv"> 
                                                <div class="data-input-group__status-wrapper"> 
                                                    <span id="file-status-category-structure" class="data-input-group__status-text"></span> 
                                                    <span id="category-structure-saved-status" class="data-input-group__status-text"></span> 
                                                </div> 
                                                <div id="progress-category-structure" class="progress-bar-container hidden"><div class="progress-bar"></div></div> 
                                            </div> 
                                        </div>
                                    </div> 
                                </div>
                            </details>

                            <details class="declaration-group">
                                <summary>Khai b√°o S·∫£n Ph·∫©m ƒê·∫∑c Quy·ªÅn</summary>
                                <div class="declaration-content">
                                    <div class="grid md:grid-cols-2 gap-6 mt-4">
                                        <div class="data-input-group">
                                            <label class="data-input-group__label">
                                                <i data-feather="star" class="h-5 w-5 text-yellow-500"></i>
                                                <span>File S·∫£n Ph·∫©m ƒê·∫∑c Quy·ªÅn (SPƒêQ):</span>
                                            </label>
                                            <div class="data-input-group__content">
                                                <div class="flex items-center gap-2">
                                                    <label for="file-special-products" class="data-input-group__file-trigger">Th√™m file SPƒêQ</label>
                                                    <span id="file-name-special-products" class="data-input-group__file-name">Ch∆∞a th√™m file</span>
                                                </div>
                                                <p class="text-xs text-gray-500">File Excel ch·ª©a danh s√°ch SPƒêQ, y√™u c·∫ßu c·ªôt: "M√£ s·∫£n ph·∫©m", "Nh√≥m h√†ng", "T√™n s·∫£n ph·∫©m". D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ƒë·ªìng b·ªô l√™n Cloud.</p>
                                                
                                                <input type="file" id="file-special-products" class="hidden file-input" data-name="S·∫£n Ph·∫©m ƒê·∫∑c Quy·ªÅn" accept=".xlsx, .xls, .csv">
                                                
                                                <div class="data-input-group__status-wrapper">
                                                    <span id="file-status-special-products" class="data-input-group__status-text"></span>
                                                </div>
                                                <div id="progress-special-products" class="progress-bar-container hidden"><div class="progress-bar"></div></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <form id="special-program-form" class="p-4 bg-slate-50 border rounded-lg space-y-3 hidden mt-6">
                                        <input type="hidden" id="special-program-id">
                                        <div>
                                            <label for="special-program-name" class="block text-sm font-medium text-gray-700">T√™n ch∆∞∆°ng tr√¨nh (VD: "Theo d√µi Tivi ƒê·∫∑c Quy·ªÅn")</label>
                                            <input type="text" id="special-program-name" class="mt-1 block w-full p-2 border rounded-md" placeholder="T√™n ch∆∞∆°ng tr√¨nh...">
                                        </div>
                                        <div>
                                            <label for="special-program-group" class="block text-sm font-medium text-gray-700">Ch·ªçn Nh√≥m h√†ng ƒë·ªÉ theo d√µi</label>
                                            <select id="special-program-group" multiple class="mt-1 block w-full"></select>
                                        </div>
                                        <div class="flex justify-end gap-2">
                                            <button type="button" id="cancel-special-program-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">H·ªßy</button>
                                            <button type="submit" id="save-special-program-btn" class="px-4 py-2 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700">L∆∞u Ch∆∞∆°ng tr√¨nh</button>
                                        </div>
                                    </form>
                        
                                    <button id="add-special-program-btn" class="mt-4 w-full text-sm py-2 px-4 border-2 border-dashed rounded-lg hover:bg-slate-50">
                                        + Th√™m Ch∆∞∆°ng tr√¨nh SP ƒê·∫∑c Quy·ªÅn
                                    </button>
                                    </div>
                            </details>
                            <details class="declaration-group"> 
                                <summary>D·ªØ li·ªáu t√≠nh to√°n</summary> 
                                <div class="declaration-content"> 
                                    <div class="grid md:grid-cols-2 gap-6 mt-4"> 
                                        <div>
                                            <label for="declaration-ycx" class="block text-md font-semibold text-gray-700 mb-2">H√¨nh th·ª©c xu·∫•t (T√≠nh doanh thu)</label> 
                                            <textarea id="declaration-ycx" rows="8" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm" placeholder="D√°n danh s√°ch c√°c lo·∫°i YCX v√†o ƒë√¢y, m·ªói lo·∫°i m·ªôt d√≤ng..."></textarea> 
                                        </div>
                                        <div> 
                                            <label for="declaration-ycx-gop" class="block text-md font-semibold text-gray-700 mb-2">H√¨nh th·ª©c xu·∫•t (Tr·∫£ g√≥p)</label> 
                                            <textarea id="declaration-ycx-gop" rows="8" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm" placeholder="D√°n danh s√°ch c√°c lo·∫°i YCX G√≥p v√†o ƒë√¢y, m·ªói lo·∫°i m·ªôt d√≤ng..."></textarea> 
                                        </div>
                                        <div class="md:col-span-2"> 
                                            <label for="declaration-heso" class="block text-md font-semibold text-gray-700 mb-2">H·ªá s·ªë quy ƒë·ªïi</label> 
                                            <textarea id="declaration-heso" rows="8" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm" placeholder="D√°n danh s√°ch h·ªá s·ªë quy ƒë·ªïi v√†o ƒë√¢y, ƒë·ªãnh d·∫°ng: T√™n nh√≥m h√†ng,H·ªá s·ªë"></textarea> 
                                        </div>
                                    </div> 
                                    <div class="mt-4">
                                        <button id="save-declaration-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition">L∆∞u D·ªØ li·ªáu t√≠nh to√°n</button> 
                                    </div> 
                                </div>
                            </details>

                            <details class="declaration-group"> 
                                <summary>Khai b√°o T√™n R√∫t G·ªçn (Thi ƒêua NV)</summary> 
                                <div class="declaration-content"> 
                                    <p class="text-sm text-gray-600 mt-4 mb-4">D·ªØ li·ªáu d√°n ·ªü tab "C·∫≠p nh·∫≠t d·ªØ li·ªáu" s·∫Ω t·ª± ƒë·ªông tr√≠ch xu·∫•t t√™n ch∆∞∆°ng tr√¨nh thi ƒëua g·ªëc v√†o ƒë√¢y. H√£y nh·∫≠p "T√™n R√∫t G·ªçn" ƒë·ªÉ b·∫£ng bi·ªÉu hi·ªÉn th·ªã g·ªçn g√†ng h∆°n. Thay ƒë·ªïi s·∫Ω ƒë∆∞·ª£c <strong>t·ª± ƒë·ªông l∆∞u</strong>.</p> 
                                    <div id="competition-name-mapping-container" class="max-h-96 overflow-y-auto pr-2"> 
                                        <p class="text-gray-500 italic">Vui l√≤ng d√°n d·ªØ li·ªáu "Thi ƒëua nh√¢n vi√™n" ·ªü tab "C·∫≠p nh·∫≠t d·ªØ li·ªáu" ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông tr√≠ch xu·∫•t t√™n...</p> 
                                    </div> 
                                </div>
                            </details>

                            <details class="declaration-group"> 
                                <summary>N·ªôi dung H∆∞·ªõng d·∫´n</summary> 
                                <div class="declaration-content"> 
                                    <div class="grid md:grid-cols-1 gap-6 mt-4"> 
                                        <div> 
                                            <label for="edit-help-data" class="block text-md font-semibold text-gray-700 mb-2">H∆∞·ªõng d·∫´n Tab C·∫≠p nh·∫≠t d·ªØ li·ªáu</label> 
                                            <textarea id="edit-help-data" rows="6" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Nh·∫≠p n·ªôi dung h∆∞·ªõng d·∫´n cho tab C·∫≠p nh·∫≠t d·ªØ li·ªáu..."></textarea> 
                                        </div>
 
                                        <div> 
                                            <label for="edit-help-luyke" class="block text-md font-semibold text-gray-700 mb-2">H∆∞·ªõng d·∫´n Tab L≈©y k·∫ø</label> 
                                            <textarea id="edit-help-luyke" rows="6" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Nh·∫≠p n·ªôi dung h∆∞·ªõng d·∫´n cho tab L≈©y k·∫ø..."></textarea> 
                                        </div>
                    
                                        <div> 
                                            <label for="edit-help-sknv" class="block text-md font-semibold text-gray-700 mb-2">H∆∞·ªõng d·∫´n Tab S·ª©c kh·ªèe NV</label> 
                                            <textarea id="edit-help-sknv" rows="6" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Nh·∫≠p n·ªôi dung h∆∞·ªõng d·∫´n cho tab S·ª©c kh·ªèe NV..."></textarea> 
                                        </div>
                                     
                                        <div> 
                                            <label for="edit-help-realtime" class="block text-md font-medium text-gray-700 mb-2">H∆∞·ªõng d·∫´n Tab Realtime</label> 
                                            <textarea id="edit-help-realtime" rows="6" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Nh·∫≠p n·ªôi dung h∆∞·ªõng d·∫´n cho tab Realtime..."></textarea> 
                                        </div>
                                    </div> 
                                    <div class="mt-4"> 
                                        <button id="save-help-content-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">L∆∞u H∆∞·ªõng d·∫´n</button> 
                                    </div> 
                                </div>
                            </details>

                        </div> 
                    </div> 

                    <details class="declaration-group content-card mt-8"> 
                        <summary>Th·ªëng k√™ Ng∆∞·ªùi d√πng</summary> 
                        <div class="declaration-content !p-0"> 
                            <div id="user-stats-container" class="mt-4"> 
                                <p class="text-gray-500">ƒêang t·∫£i danh s√°ch ng∆∞·ªùi d√πng...</p> 
                            </div>
                        </div> 
                    </details> 
                </section>
                </div>
        </main>
    </div>

    <div id="modal-force-update-container"></div>
    <div id="notification"></div>
    <div id="modal-admin-container"></div>
    <div id="modal-login-container"></div>
    <div id="modal-help-container"></div>
    
    <div id="modal-chart-container"></div>
    <div id="modal-composer-container"></div>
    <div id="modal-preview-container"></div>
    <div id="modal-selection-container"></div> 

    <div id="modal-customer-detail-container"></div>
    <div id="modal-unexported-detail-container"></div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tailwindScript = document.querySelector('script[src="https://cdn.tailwindcss.com"]');
            if (tailwindScript && window.location.protocol !== "file:") {
                console.warn("cdn.tailwindcss.com should not be used in production. To use Tailwind CSS in production, install it as a PostCSS plugin or use the Tailwind CLI: https://tailwindcss.com/docs/installation");
            }
        });
    </script>
    <script type="module" src="./main.js?v=4.56"></script> </body>
</html>
--- END FILE: ./index.html ---

--- START FILE: ./main.js ---
// Version 4.57 - Add Edit/Delete handlers for Special Programs
// MODULE 5: B·ªò ƒêI·ªÄU KHI·ªÇN TRUNG T√ÇM (MAIN)
// File n√†y ƒë√≥ng vai tr√≤ ƒëi·ªÅu ph·ªëi, nh·∫≠p kh·∫©u c√°c module kh√°c v√† kh·ªüi ch·∫°y ·ª©ng d·ª•ng.

import { config } from './config.js';
import { appState } from './state.js';
import { services } from './services.js';
import { ui } from './ui.js';
import { firebase } from './firebase.js'; // Gi·ªØ l·∫°i cho Core, Listeners
import { auth } from './auth.js';
import { luykeTab } from './tab-luyke.js';
import { sknvTab } from './tab-sknv.js';
import { uiRealtime } from './ui-realtime.js';
import { initializeEventListeners } from './event-listeners/ui-listeners.js';
import { sidebar } from './components/sidebar.js';
import { storage } from './modules/storage.js';
import { drawerInterface } from './components/drawer-interface.js';
import { drawerGoal } from './components/drawer-goal.js';
import { modalForceUpdate } from './components/modal-force-update.js';
import { modalAdmin } from './components/modal-admin.js';
import { modalLogin } from './components/modal-login.js';
import { modalHelp } from './components/modal-help.js';
import { modalChart } from './components/modal-chart.js';
import { modalComposer } from './components/modal-composer.js';
import { modalPreview } from './components/modal-preview.js';
import { modalSelection } from './components/modal-selection.js';
import { modalCustomerDetail } from './components/modal-customer-detail.js';
import { modalUnexportedDetail } from './components/modal-unexported-detail.js';
import { settingsService } from './modules/settings.service.js';
import { highlightService } from './modules/highlight.service.js';
import { dataService } from './services/data.service.js';

// === START: T√ÅI C·∫§U TR√öC (RE-WIRING) IMPORTS ===
import { analyticsService } from './services/analytics.service.js';
import { adminService } from './services/admin.service.js';
import { storageService } from './services/storage.service.js';
import { collaborationService } from './services/collaboration.service.js';
// === END: T√ÅI C·∫§U TR√öC (RE-WIRING) IMPORTS ===

const LOCAL_DATA_VERSIONS_KEY = '_localDataVersions';
const LOCAL_METADATA_PREFIX = '_localMetadata_';
const LOCAL_DSNV_FILENAME_KEY = '_localDsnvFilename';
const RAW_PASTE_THIDUANV_KEY = 'raw_paste_thiduanv';

const app = {
    // === START: FIX L·ªñI ===
    // Di chuy·ªÉn ALL_DATA_MAPPING t·ª´ b√™n ngo√†i v√†o b√™n trong ƒë·ªëi t∆∞·ª£ng 'app'
    ALL_DATA_MAPPING: {
        // Daily Files
        'ycx': { stateKey: 'ycxData', saveKey: 'saved_ycx', isPasted: false, uiId: 'ycx', firestoreKey: 'ycx' },
        'giocong': { stateKey: 'rawGioCongData', saveKey: 'saved_giocong', isPasted: false, uiId: 'giocong', firestoreKey: 'giocong' },
        'thuongnong': { stateKey: 'thuongNongData', saveKey: 'saved_thuongnong', isPasted: false, uiId: 'thuongnong', firestoreKey: 'thuongnong' },
        // Daily Pasted
        'pastedLuykeBI': { stateKey: null, saveKey: 'daily_paste_luyke', isPasted: true, uiId: 'status-luyke', firestoreKey: 'pastedLuykeBI' },
        'pastedThuongERP': { stateKey: 'thuongERPData', saveKey: 'daily_paste_thuongerp', isPasted: true, uiId: 'status-thuongerp', firestoreKey: 'pastedThuongERP', processFunc: services.processThuongERP },
        'pastedThiduaNVBI': { stateKey: 'pastedThiDuaReportData', saveKey: 'daily_paste_thiduanv', isPasted: true, uiId: 'status-thiduanv', firestoreKey: 'pastedThiduaNVBI' }, // *** MODIFIED (v4.40) ***
        // Previous Month Files
        'ycx-thangtruoc': { stateKey: 'ycxDataThangTruoc', saveKey: 'saved_ycx_thangtruoc', isPasted: false, uiId: 'ycx-thangtruoc', firestoreKey: 'ycx_thangtruoc' },
        'thuongnong-thangtruoc': { stateKey: 'thuongNongDataThangTruoc', saveKey: 'saved_thuongnong_thangtruoc', isPasted: false, uiId: 'thuongnong-thangtruoc', firestoreKey: 'thuongnong_thangtruoc' },
        // Previous Month Pasted
        'pastedThuongERPThangTruoc': { stateKey: 'thuongERPDataThangTruoc', saveKey: 'saved_thuongerp_thangtruoc', isPasted: true, uiId: 'status-thuongerp-thangtruoc', firestoreKey: 'pastedThuongERPThangTruoc', processFunc: services.processThuongERP }
    },
    // === END: FIX L·ªñI ===

    currentVersion: '4.2', // Gi·ªØ nguy√™n version n√†y, b·∫°n c√≥ th·ªÉ t·ª± c·∫≠p nh·∫≠t sau khi t√≠ch h·ª£p xong
    storage: storage,
    unsubscribeDataListener: null,
    _isInitialized: false,
    _localDataVersions: {},

    async init() {
        try {
            await firebase.initCore();
            console.log("Rendering static UI components...");
            sidebar.render('#sidebar-container');
            drawerInterface.render('#interface-drawer-container');
            drawerGoal.render('#goal-drawer-container');
            modalForceUpdate.render('#modal-force-update-container');
            modalAdmin.render('#modal-admin-container');
            await modalLogin.render('#modal-login-container');
            console.log("[main.js init] Finished awaiting modalLogin.render.");
            modalHelp.render('#modal-help-container');
            modalChart.render('#modal-chart-container');
            modalComposer.render('#modal-composer-container');
            modalPreview.render('#modal-preview-container');
            modalSelection.render('#modal-selection-container');
            // === START: RENDER MODALS M·ªöI (TASK 3 & 4) ===
            modalCustomerDetail.render('#modal-customer-detail-container');
            modalUnexportedDetail.render('#modal-unexported-detail-container');
            // === END: RENDER MODALS M·ªöI ===
            feather.replace();
            console.log("Static UI components rendered.");

            console.log("Ensuring anonymous authentication...");
            const user = await auth.ensureAnonymousAuth();

            if (user && !this._isInitialized) {
                this._isInitialized = true;
                console.log("Anonymous auth confirmed. Setting up listeners and email identification...");
                firebase.setupListeners();
                console.log("[main.js init] Calling auth.initEmailIdentification...");
                auth.initEmailIdentification(this.continueInit.bind(this));
            } else if (user && this._isInitialized) {
                console.log("App already initialized, skipping init steps.");
            }

        } catch (error) {
            console.error("L·ªói nghi√™m tr·ªçng trong qu√° tr√¨nh kh·ªüi t·∫°o ·ª©ng d·ª•ng:", error);
            ui.showNotification("L·ªói kh·ªüi t·∫°o. Vui l√≤ng th·ª≠ t·∫£i l·∫°i trang.", "error");
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                    mainContent.innerHTML = '<div class="placeholder-message notification-error">L·ªói nghi√™m tr·ªçng, kh√¥ng th·ªÉ kh·ªüi ƒë·ªông ·ª©ng d·ª•ng. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng, c√†i ƒë·∫∑t Firebase Rules v√† th·ª≠ l·∫°i.</div>';
            }
        }
    },

    async continueInit() {
        if (!appState.currentUser || !appState.currentUser.email) {
                console.error("continueInit called without user email in appState.");
                ui.showNotification("L·ªói: Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng.", "error");
                return;
        }
        console.log(`Email identification complete: ${appState.currentUser.email}. Continuing app initialization...`);

        // *** >>> S·ª¨A L·ªñI ƒê·∫æM L∆Ø·ª¢T TRUY C·∫¨P: G·ªåI H√ÄM ƒê·∫æM ·ªû ƒê√ÇY <<< ***
        // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
        analyticsService.upsertUserRecord(appState.currentUser.email);
        // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
        // *** >>> K·∫æT TH√öC S·ª¨A L·ªñI <<< ***

        // === START REFACTOR 2 (B∆∞·ªõc 2a) ===
        // Kh·ªüi t·∫°o c√°c m·∫£ng config
        appState.localCompetitionConfigs = []; // T·ª´ LocalStorage
        appState.globalCompetitionConfigs = []; // T·ª´ Firestore
        // === END REFACTOR 2 ===

        // ========== START: TH√äM M·ªöI (Kh·ªüi t·∫°o State SPƒêQ) ==========
        appState.specialProductList = []; // Danh s√°ch SPƒêQ (T·ª´ Firestore)
        appState.globalSpecialPrograms = []; // C·∫•u h√¨nh CT SPƒêQ (T·ª´ Firestore)
        // ========== END: TH√äM M·ªöI ==========

        appState.viewingDetailFor = null;

        try {
            const storedVersions = localStorage.getItem(LOCAL_DATA_VERSIONS_KEY);
            if (storedVersions) {
                this._localDataVersions = JSON.parse(storedVersions);
                console.log("%c[continueInit] Loaded _localDataVersions from localStorage:", "color: brown;", this._localDataVersions);
            } else {
                this._localDataVersions = {};
                console.log("%c[continueInit] No _localDataVersions found in localStorage, initialized as {}.", "color: brown;");
            }
        } catch (e) {
            console.error("%cError loading _localDataVersions from localStorage:", "color: red;", e);
            this._localDataVersions = {};
        }

        this.loadAndApplyBookmarkLink();
        this.loadAndDisplayQrCode();
        this.setupMarquee();
        await this.storage.openDB();
        console.log("Loading category data from Firestore...");
        try {
            // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
            const { categories, brands } = await adminService.loadCategoryDataFromFirestore();
            // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
            appState.categoryStructure = categories;
            appState.brandList = brands;
            console.log(`Successfully populated ${appState.categoryStructure.length} categories and ${appState.brandList.length} brands from Firestore.`);
            
            // === FIX 1a (Th√™m) ===
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i UI sau khi t·∫£i t·ª´ cloud, thay v√¨ ƒë·ªÉ tr·ªëng
            ui.updateFileStatus('category-structure', 'T·∫£i t·ª´ Cloud', `‚úì ƒê√£ t·∫£i ${categories.length} nh√≥m & ${brands.length} h√£ng.`, 'success', false); // <<< S·ª¨A (v4.47)
            // === END FIX ===

        } catch (error) {
                console.error("Error loading category data after auth:", error);
                ui.showNotification("Kh√¥ng th·ªÉ t·∫£i c·∫•u tr√∫c ng√†nh h√†ng t·ª´ cloud.", "error");
        }

        console.log("Loading calculation declarations from Firestore...");
        try {
            // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
            const declarations = await adminService.loadDeclarationsFromFirestore();
            // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
            appState.declarations = declarations;
            const decYcxEl = document.getElementById('declaration-ycx');
            if (decYcxEl) decYcxEl.value = declarations.hinhThucXuat || config.DEFAULT_DATA.HINH_THUC_XUAT_TINH_DOANH_THU.join('\n');
            const decYcxGopEl = document.getElementById('declaration-ycx-gop');
            if (decYcxGopEl) decYcxGopEl.value = declarations.hinhThucXuatGop || config.DEFAULT_DATA.HINH_THUC_XUAT_TRA_GOP.join('\n');
            const decHeSoEl = document.getElementById('declaration-heso');
            if (decHeSoEl) decHeSoEl.value = declarations.heSoQuyDoi || Object.entries(config.DEFAULT_DATA.HE_SO_QUY_DOI).map(([k, v]) => `${k},${v}`).join('\n');
        } catch (error) {
                console.error("Error loading declarations after auth:", error);
                ui.showNotification("Kh√¥ng th·ªÉ t·∫£i khai b√°o t√≠nh to√°n t·ª´ cloud.", "error");
        }
        
        // *** NEW (v4.41): Load competition name mappings from Firestore ***
        console.log("Loading competition name mappings from Firestore...");
        try {
            // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
            appState.competitionNameMappings = await adminService.loadCompetitionNameMappings();
            // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
            console.log("Successfully loaded competition name mappings from Firestore.");
        } catch (error) {
                console.error("Error loading competition name mappings:", error);
                ui.showNotification("Kh√¥ng th·ªÉ t·∫£i t√™n r√∫t g·ªçn (thi ƒëua) t·ª´ cloud.", "error");
                appState.competitionNameMappings = {}; // Ensure it's an object on failure
        }
        // *** END NEW ***

        // === START REFACTOR 2 (B∆∞·ªõc 2c) ===
        console.log("Loading Global Competition Configs from Firestore...");
        try {
            appState.globalCompetitionConfigs = await adminService.loadGlobalCompetitionConfigs();
            console.log(`Successfully loaded ${appState.globalCompetitionConfigs.length} global competition configs.`);
        } catch (error) {
            console.error("Error loading Global Competition Configs:", error);
            ui.showNotification("Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh thi ƒëua chung t·ª´ cloud.", "error");
            appState.globalCompetitionConfigs = []; // Ensure it's an array on failure
        }
        // === END REFACTOR 2 ===

        // ========== START: TH√äM M·ªöI (T·∫£i SP ƒê·∫∑c Quy·ªÅn & C·∫•u h√¨nh SPƒêQ) ==========
        console.log("Loading Special Product List from Firestore...");
        try {
            appState.specialProductList = await adminService.loadSpecialProductList();
            console.log(`Successfully loaded ${appState.specialProductList.length} special products.`);
        } catch (error) {
            console.error("Error loading Special Product List:", error);
            ui.showNotification("Kh√¥ng th·ªÉ t·∫£i danh s√°ch SP ƒê·∫∑c Quy·ªÅn t·ª´ cloud.", "error");
            appState.specialProductList = []; // Ensure it's an array on failure
        }

        console.log("Loading Global Special Programs from Firestore...");
        try {
            appState.globalSpecialPrograms = await adminService.loadGlobalSpecialPrograms();
            console.log(`Successfully loaded ${appState.globalSpecialPrograms.length} global special programs.`);
        } catch (error) {
            console.error("Error loading Global Special Programs:", error);
            ui.showNotification("Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh SP ƒê·∫∑c Quy·ªÅn t·ª´ cloud.", "error");
            appState.globalSpecialPrograms = []; // Ensure it's an array on failure
        }
        // ========== END: TH√äM M·ªöI ==========

        initializeEventListeners(this);
        dataService.init(this); // <<< TH√äM M·ªöI (v4.48): Kh·ªüi ƒë·ªông data service
        await this.loadDataFromStorage();

        const savedWarehouse = localStorage.getItem('selectedWarehouse');
        if (savedWarehouse) {
            appState.selectedWarehouse = savedWarehouse;
            if(this.unsubscribeDataListener) this.unsubscribeDataListener();
            console.log(`Re-attaching listener for saved warehouse: ${savedWarehouse}`);
            
            // <<< C·∫¨P NH·∫¨T (v4.48): Tr·ªè callback ƒë·∫øn dataService >>>
            // (H√ÄM N√ÄY V·∫™N G·ªåI firebase. V√å N√ì L√Ä H√ÄM L√ïI)
            this.unsubscribeDataListener = firebase.listenForDataChanges(savedWarehouse, (cloudData) => {
                dataService.handleCloudDataUpdate(cloudData);
            });

            console.log(`%c[continueInit] Checking sync status for warehouse ${savedWarehouse} (AFTER loadDataFromStorage)...`, "color: teal; font-weight: bold;");

            const fileDataTypes = Object.keys(this.ALL_DATA_MAPPING).filter(k => !this.ALL_DATA_MAPPING[k].isPasted);

            fileDataTypes.forEach(fileTypeKey => {
                const mappingInfo = this.ALL_DATA_MAPPING[fileTypeKey];
                if (!mappingInfo) return;

                const { firestoreKey, uiId } = mappingInfo;
                
                // <<< C·∫¨P NH·∫¨T (v4.48): G·ªçi h√†m helper t·ª´ dataService >>>
                const metadata = dataService._getSavedMetadata(savedWarehouse, firestoreKey); 
                const localVersionInfo = this._localDataVersions?.[savedWarehouse]?.[firestoreKey] || { version: 0, timestamp: 0 };

                console.log(`%c[continueInit] --> Checking ${firestoreKey}:`, "color: teal;");
                console.log(`%c    Metadata (localStorage):`, "color: teal;", metadata ? `v${metadata.version}, ts ${metadata.timestamp}, by ${metadata.updatedBy}` : 'null');
                console.log(`%c    Local Version Info (_localDataVersions):`, "color: teal;", `v${localVersionInfo.version}, ts ${localVersionInfo.timestamp}`);

                const fileStatusSpan = document.getElementById(`file-status-${uiId}`);
                // === FIX 2b.1 (S·ª≠a) ===
                // Thay ƒë·ªïi c√°ch ki·ªÉm tra 'cache', v√¨ ch√∫ng ta s·∫Ω hi·ªÉn th·ªã s·ªë d√≤ng
                const currentStatusIsCache = fileStatusSpan?.textContent?.includes('ƒê√£ t·∫£i');

                if (currentStatusIsCache) {
                        if (metadata && metadata.version > localVersionInfo.version) {
                        console.log(`%c[continueInit] Cache loaded for ${firestoreKey}, but cloud v${metadata.version} is newer. Showing download button.`, "color: orange;");
                        ui.updateFileStatus(uiId, metadata.fileName || 'Cloud', '', 'default', true, metadata, firestoreKey, savedWarehouse); // <<< S·ª¨A (v4.47)
                        } else {
                            console.log(`%c[continueInit] UI status for ${firestoreKey} was set by loadDataFromStorage (cache) and is up-to-date. Keeping it.`, "color: green;");
                        }
                } else if (metadata) {
                        if (metadata.version > localVersionInfo.version) {
                        ui.updateFileStatus(uiId, metadata.fileName || 'Cloud', '', 'default', true, metadata, firestoreKey, savedWarehouse); // <<< S·ª¨A (v4.47)
                        console.log(`%c[continueInit] UI status for ${firestoreKey} requires download (Cloud v${metadata.version} > Local v${localVersionInfo.version}).`, "color: green;");
                    } else {
                            ui.updateFileStatus(uiId, metadata.fileName || 'Cloud', '', 'default', true, metadata, firestoreKey, savedWarehouse); // <<< S·ª¨A (v4.47)
                        console.log(`%c[continueInit] UI status for ${firestoreKey} requires download (v${metadata.version}). Cache empty or not loaded.`, "color: orange;");
                    }
                } else {
                        ui.updateFileStatus(uiId, '', `ƒêang ch·ªù ƒë·ªìng b·ªô t·ª´ kho ${savedWarehouse}...`, 'default'); // <<< S·ª¨A (v4.47)
                    console.log(`%c[continueInit] No metadata for ${firestoreKey}, waiting for sync.`, "color: orange;");
                }
            });
            console.log(`%c[continueInit] Finished checking sync status.`, "color: teal; font-weight: bold;");

        } else {
                Object.keys(this.ALL_DATA_MAPPING).filter(k => !this.ALL_DATA_MAPPING[k].isPasted).forEach(fileTypeKey => {
                    ui.updateFileStatus(this.ALL_DATA_MAPPING[fileTypeKey].uiId, '', 'Ch·ªçn kho ƒë·ªÉ ƒë·ªìng b·ªô...', 'default'); // <<< S·ª¨A (v4.47)
                });
                const dsnvFilename = localStorage.getItem(LOCAL_DSNV_FILENAME_KEY);
                if (!dsnvFilename) {
                    ui.updateFileStatus('danhsachnv', '', 'Ch∆∞a th√™m file', 'default'); // <<< S·ª¨A (v4.47)
                }
        }

        if (appState.danhSachNhanVien.length > 0) {
            ui.populateWarehouseSelector(); // <<< S·ª¨A (v4.47)
        } else {
                console.error("[main.js continueInit] CRITICAL: appState.danhSachNhanVien is empty! Warehouse selector cannot be populated.");
                const selector = document.getElementById('data-warehouse-selector');
                if (selector) {
                    selector.innerHTML = '<option value="">-- Vui l√≤ng t·∫£i Danh s√°ch Nh√¢n vi√™n --</option>';
                    selector.disabled = true;
                }
        }

        settingsService.loadInterfaceSettings();
        settingsService.applyContrastSetting();
        settingsService.loadHighlightSettings();
        ui.populateAllFilters();
        settingsService.loadAndApplyLuykeGoalSettings();
        settingsService.loadAndApplyRealtimeGoalSettings();
        this.loadPastedDataFromStorage();
        this.switchTab('data-section');
        this.checkForUpdates();
        setInterval(() => this.checkForUpdates(), 15 * 60 * 1000);
    },

    // <<< START: X√ìA B·ªé KH·ªêI H√ÄM (v4.49) >>>
    // 14 h√†m (handleCloudDataUpdate, handleDownloadAndProcessData, _getSavedMetadata, 
    //         handleFileInputChange, handleDsnvUpload) ƒë√£ b·ªã x√≥a ·ªü v4.48.
    // 3 h√†m sau s·∫Ω b·ªã x√≥a ·ªü v4.49:
    // handleFileRead(file) { ... }
    // async handleCompetitionDebugFile(e) { ... }
    // async handleTemplateDownload() { ... }
    // <<< END: X√ìA B·ªé KH·ªêI H√ÄM (v4.49) >>>

    async setupMarquee() {
        // ... (Gi·ªØ nguy√™n)
        const marqueeContainer = document.getElementById('version-marquee-container');
        const marqueeText = marqueeContainer?.querySelector('.marquee-text');
        if (!marqueeContainer || !marqueeText) return;
        try {
            const versionRes = await fetch(`./version.json?v=${new Date().getTime()}`);
            const versionInfo = await versionRes.json();
            const currentVersion = versionInfo.version || this.currentVersion;
            marqueeText.textContent = `üî• Chi ti·∫øt b·∫£n c·∫≠p nh·∫≠t - Phi√™n b·∫£n ${currentVersion}`;
            marqueeContainer.addEventListener('click', async () => {
                    try {
                    const changelogRes = await fetch(`./changelog.json?v=${new Date().getTime()}`);
                    const changelogData = await changelogRes.json();
                    const modalTitle = document.getElementById('help-modal-title');
                    const modalContent = document.getElementById('help-modal-content');
                    if (modalTitle) modalTitle.textContent = "L·ªãch S·ª≠ C·∫≠p Nh·∫≠t";
                    if (modalContent) modalContent.innerHTML = this._formatChangelogForModal(changelogData);
                    ui.toggleModal('help-modal', true);
                } catch (error) {
                    console.error("L·ªói khi t·∫£i ho·∫∑c hi·ªÉn th·ªã changelog:", error);
                    ui.showNotification("Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt c·∫≠p nh·∫≠t.", "error");
                }
            });
        } catch (error) {
            console.error("L·ªói khi thi·∫øt l·∫≠p marquee:", error);
            marqueeText.textContent = "Kh√¥ng th·ªÉ t·∫£i th√¥ng tin phi√™n b·∫£n.";
        }
    },

    // === START: MODIFIED FUNCTION (v4.51) ===
    _formatChangelogForModal(changelogData) {
        if (!changelogData || changelogData.length === 0) return '<p>Kh√¥ng c√≥ l·ªãch s·ª≠ c·∫≠p nh·∫≠t.</p>';
        
        return changelogData.map(item => {
            const notesHtml = item.notes.map(note => {
                // Y√™u c·∫ßu m·ªõi: Ki·ªÉm tra xem 'note' l√† string hay object
                if (typeof note === 'object' && note !== null && note.title && Array.isArray(note.items)) {
                    // ƒê√¢y l√† m·ªôt m·ª•c l·ªìng c·∫•p
                    const subItemsHtml = note.items.map(subItem => 
                        // S·ª≠ d·ª•ng style 'list-style-type: "- "'
                        `<li class="ml-4" style="list-style-type: '- ';">${subItem}</li>`
                    ).join('');
                    
                    return `
                        <li class="mt-2 font-semibold text-gray-800">${note.title}
                            <ul class="font-normal text-gray-700 space-y-1 mt-1">
                                ${subItemsHtml}
                            </ul>
                        </li>
                    `;
                } else {
                    // ƒê√¢y l√† m·ªôt string b√¨nh th∆∞·ªùng
                    return `<li class="text-gray-700">${note}</li>`;
                }
            }).join('');

            return `
                <div class="mb-4 pb-4 border-b last:border-b-0">
                    <h4 class="font-bold text-blue-600 mb-2">Phi√™n b·∫£n ${item.version} (${item.date})</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        ${notesHtml}
                    </ul>
                </div>
            `;
        }).join('');
    },
    // === END: MODIFIED FUNCTION ===

    async checkForUpdates() {
        // ... (Gi·ªØ nguy√™n)
        try {
            const response = await fetch(`./version.json?v=${new Date().getTime()}`);
            if (!response.ok) return;
            const serverConfig = await response.json();
            if (serverConfig.version && serverConfig.version !== this.currentVersion) {
                    console.log(`Phi√™n b·∫£n m·ªõi ${serverConfig.version} ƒë√£ s·∫µn s√†ng!`);
                const changelogRes = await fetch(`./changelog.json?v=${new Date().getTime()}`);
                const changelogData = await changelogRes.json();
                const newVersionDetails = changelogData.find(log => log.version === serverConfig.version);
                const titleEl = document.getElementById('force-update-title');
                const notesContainer = document.getElementById('update-notes-container');
                if (titleEl) titleEl.textContent = `üì¢ ƒê√£ c√≥ phi√™n b·∫£n m·ªõi ${serverConfig.version}!`;
                if (notesContainer && newVersionDetails && newVersionDetails.notes) {
                    // S·ª≠ d·ª•ng c√πng logic render c·ªßa _formatChangelogForModal ƒë·ªÉ h·ªó tr·ª£ nested lists
                    const notesHtml = newVersionDetails.notes.map(note => {
                        if (typeof note === 'object' && note !== null && note.title && Array.isArray(note.items)) {
                            const subItemsHtml = note.items.map(subItem => 
                                `<li class="ml-4" style="list-style-type: '- ';">${subItem}</li>`
                            ).join('');
                            return `
                                <li class="mt-2 font-semibold text-gray-800">${note.title}
                                    <ul class="font-normal text-gray-700 space-y-1 mt-1">
                                        ${subItemsHtml}
                                    </ul>
                                </li>
                            `;
                        } else {
                            return `<li class="text-gray-700">${note}</li>`;
                        }
                    }).join('');
                    
                    notesContainer.innerHTML = `
                        <p class="text-sm font-semibold text-gray-700 mb-2">N·ªôi dung c·∫≠p nh·∫≠t:</p>
                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            ${notesHtml}
                        </ul>
                    `;
                } else if (notesContainer) {
                    notesContainer.innerHTML = '<p class="text-sm text-gray-500">Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt c·∫≠p nh·∫≠t.</p>';
                }
                ui.toggleModal('force-update-modal', true);
            }
        } catch (error) {
                console.error('Kh√¥ng th·ªÉ ki·ªÉm tra phi√™n b·∫£n m·ªõi:', error);
        }
    },

    async loadDataFromStorage() {
        // ... (GiÃü·ªØ nguy√™n)
    
        let dsnvLoadSuccess = false;
        const loadSavedFile = async (saveKey, stateKey, fileType, uiId) => {
            console.log(`[main.js loadDataFromStorage] Attempting to load ${saveKey} from IndexedDB...`);
            let savedData = null;
            try {
                savedData = await this.storage.getItem(saveKey);
            } catch (indexedDbError) {
                    console.error(`[main.js loadDataFromStorage] CRITICAL Error reading ${saveKey} from IndexedDB:`, indexedDbError);
                    ui.updateFileStatus(uiId, '', `L·ªói ƒë·ªçc cache IndexedDB!`, 'error'); // <<< S·ª¨A (v4.47)
                    if (saveKey === 'saved_danhsachnv') {
                        const selector = document.getElementById('data-warehouse-selector');
                        if (selector) {
                            selector.innerHTML = '<option value="">L·ªói t·∫£i DSNV t·ª´ cache!</option>';
                            selector.disabled = true;
                        }
                    }
                    return;
            }

            if (!savedData) {
                console.log(`[main.js loadDataFromStorage] ${saveKey} not found in IndexedDB.`);
                return;
            }

            console.log(`[main.js loadDataFromStorage] Found ${saveKey} in IndexedDB.`);
            try {
                if (saveKey === 'saved_category_structure') {
                        if (appState.categoryStructure.length > 0 || appState.brandList.length > 0) {
                            // ƒê√£ ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi logic Fix 1a, kh√¥ng c·∫ßn l√†m g√¨ ·ªü ƒë√¢y
                    }
                    return;
                }
                const normalizedData = savedData;
                if (normalizedData && Array.isArray(normalizedData) && normalizedData.length > 0) {
                    console.log(`[main.js loadDataFromStorage] Successfully validated data for ${saveKey}, ${normalizedData.length} rows.`);
                    appState[stateKey] = normalizedData;

                    let fileNameToShow = `Cache (${normalizedData.length} d√≤ng)`;
                    // === FIX 2b.1 (S·ª≠a) ===
                    let statusText = `‚úì ƒê√£ t·∫£i ${normalizedData.length} d√≤ng`;
                    let statusType = 'success';
                    let metadata = null;

                    const mappingEntry = Object.values(this.ALL_DATA_MAPPING).find(m => m.saveKey === saveKey);
                    const firestoreKey = mappingEntry ? mappingEntry.firestoreKey : null;

                    if (saveKey === 'saved_danhsachnv') {
                            dsnvLoadSuccess = true;
                            fileNameToShow = localStorage.getItem(LOCAL_DSNV_FILENAME_KEY) || fileNameToShow;
                    } else if (firestoreKey && !mappingEntry.isPasted) {
                            const currentWarehouse = localStorage.getItem('selectedWarehouse');
                            if (currentWarehouse) {
                                // <<< C·∫¨P NH·∫¨T (v4.48): G·ªçi h√†m helper t·ª´ dataService >>>
                                metadata = dataService._getSavedMetadata(currentWarehouse, firestoreKey);
                                if (metadata) {
                                        fileNameToShow = metadata.fileName || fileNameToShow;
                                    console.log(`[main.js loadDataFromStorage] Found metadata for ${firestoreKey}, will use it in status update.`);
                                } else {
                                    console.log(`[main.js loadDataFromStorage] No metadata found in localStorage for ${firestoreKey}, using basic cache status.`);
                                }
                            } else {
                                console.log(`[main.js loadDataFromStorage] No warehouse selected, using basic cache status for ${firestoreKey}.`);
                            }
                    }

                    ui.updateFileStatus(uiId, fileNameToShow, statusText, statusType, false, metadata); // <<< S·ª¨A (v4.47)

                    if (stateKey === 'danhSachNhanVien') {
                        console.log("[main.js loadDataFromStorage] Updating employee maps after loading DSNV from cache.");
                        services.updateEmployeeMaps();
                    }
                } else {
                        console.error(`[main.js loadDataFromStorage] Invalid or empty data array found in cache for ${saveKey}.`);
                        ui.updateFileStatus(uiId, '', `L·ªói d·ªØ li·ªáu cache.`, 'error'); // <<< S·ª¨A (v4.47)
                        try {
                            await this.storage.setItem(saveKey, null);
                            console.log(`[main.js loadDataFromStorage] Cleared potentially corrupted cache for ${saveKey}.`);
                        } catch(clearError) {
                            console.error(`[main.js loadDataFromStorage] Failed to clear corrupted cache for ${saveKey}:`, clearError);
                        }
                }
                } catch (e) {
                console.error(`[main.js loadDataFromStorage] L·ªói x·ª≠ l√Ω ${saveKey} t·ª´ IndexedDB:`, e);
                ui.updateFileStatus(uiId, '', `L·ªói x·ª≠ l√Ω cache.`, 'error'); // <<< S·ª¨A (v4.47)
            }
        };

        await loadSavedFile('saved_danhsachnv', 'danhSachNhanVien', 'danhsachnv', 'danhsachnv');
        if (!dsnvLoadSuccess) {
                console.error("[main.js loadDataFromStorage] CRITICAL: Failed to load 'saved_danhsachnv' from IndexedDB. App state might be incorrect.");
            const selector = document.getElementById('data-warehouse-selector');
                if (selector) {
                    selector.innerHTML = '<option value="">L·ªói t·∫£i DSNV t·ª´ cache!</option>';
                    selector.disabled = true;
                }
        }

        await loadSavedFile('saved_ycx_thangtruoc', 'ycxDataThangTruoc', 'ycx', 'ycx-thangtruoc');
        await loadSavedFile('saved_thuongnong_thangtruoc', 'thuongNongDataThangTruoc', 'thuongnong', 'thuongnong-thangtruoc');
        await loadSavedFile('saved_ycx', 'ycxData', 'ycx', 'ycx');
        await loadSavedFile('saved_giocong', 'rawGioCongData', 'giocong', 'giocong');
        await loadSavedFile('saved_thuongnong', 'thuongNongData', 'thuongnong', 'thuongnong');

        try {
                const savedLuykeGoals = localStorage.getItem('luykeGoalSettings');
            if(savedLuykeGoals) appState.luykeGoalSettings = JSON.parse(savedLuykeGoals);
            const savedRealtimeGoals = localStorage.getItem('realtimeGoalSettings');
            if (savedRealtimeGoals) appState.realtimeGoalSettings = JSON.parse(savedRealtimeGoals);
            const savedTemplates = localStorage.getItem('composerTemplates');
            if (savedTemplates) {
                let parsedTemplates = JSON.parse(savedTemplates);
                for (const key in parsedTemplates) {
                    if (typeof parsedTemplates[key] === 'string') {
                        const oldString = parsedTemplates[key];
                        parsedTemplates[key] = {};
                        if (key === 'luyke') parsedTemplates[key]['subtab-luyke-sieu-thi'] = oldString;
                        else if (key === 'sknv') parsedTemplates[key]['subtab-sknv'] = oldString;
                        else if (key === 'realtime') parsedTemplates[key]['subtab-realtime-sieu-thi'] = oldString;
                    }
                }
                appState.composerTemplates = parsedTemplates;
            } else {
                appState.composerTemplates = { luyke: {}, sknv: {}, realtime: {} };
            }

            // === START REFACTOR 2 (B∆∞·ªõc 2d) ===
            // ƒê·ªïi appState.competitionConfigs -> appState.localCompetitionConfigs
            const savedCompetition = localStorage.getItem('competitionConfigs');
            if (savedCompetition) appState.localCompetitionConfigs = JSON.parse(savedCompetition);
            // === END REFACTOR 2 ===
            
            // *** MODIFIED (v4.41): REMOVED localStorage load for competitionNameMappings ***
            // (N√≥ s·∫Ω ƒë∆∞·ª£c t·∫£i t·ª´ Firestore trong continueInit)
            
            const savedPastedThiDua = localStorage.getItem('daily_paste_thiduanv');
            if (savedPastedThiDua) {
                try {
                    // L∆∞u √Ω: Ch√∫ng ta l∆∞u m·∫£ng ƒê√É X·ª¨ L√ù, kh√¥ng ph·∫£i text th√¥
                    appState.pastedThiDuaReportData = JSON.parse(savedPastedThiDua); 
                    console.log(`[main.js loadDataFromStorage] Loaded ${appState.pastedThiDuaReportData.length} rows of processed pasted competition data.`);
                } catch (e) {
                    console.error("L·ªói ƒë·ªçc daily_paste_thiduanv t·ª´ localStorage:", e);
                    appState.pastedThiDuaReportData = [];
                }
            }
            // *** END MODIFIED ***

        } catch (e) { console.error("L·ªói ƒë·ªçc c√†i ƒë·∫∑t t·ª´ localStorage:", e); }
    },

    loadPastedDataFromStorage() {
        // === START: DEBUG (v4.43) ===
        console.log("%c[DEBUG loadPastedDataFromStorage] B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu d√°n...", "color: brown; font-weight: bold;");
        // === END: DEBUG ===

        const loadPasted = (saveKey, stateKey, uiId, processFunc) => {
            // === START: DEBUG (v4.43) ===
                console.log(`%c[DEBUG loadPastedDataFromStorage] ƒêang x·ª≠ l√Ω key: ${saveKey}`, "color: brown;");
            // === END: DEBUG ===
            
            const pastedText = localStorage.getItem(saveKey); // ƒê√¢y l√† text th√¥ (ngo·∫°i tr·ª´ daily_paste_thiduanv)
            
            // === START: DEBUG (v4.43) ===
            if (pastedText) {
                console.log(`%c[DEBUG loadPastedDataFromStorage]   > T√¨m th·∫•y d·ªØ li·ªáu cho ${saveKey}. (ƒê·ªô d√†i: ${pastedText.length})`, "color: green;");
            } else {
                console.log(`%c[DEBUG loadPastedDataFromStorage]   > Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho ${saveKey} trong localStorage.`, "color: red;");
            }
            // === END: DEBUG ===

            if (pastedText) {
                    const el = document.getElementById(uiId.replace('status-', 'paste-'));
                    
                    // === FIX 2a.2 (S·ª≠a) ===
                    // Kh√¥ng ƒëi·ªÅn text th√¥ cho √¥ thi ƒëua NV, v√¨ ch√∫ng ta l∆∞u *d·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω* v√†o key ƒë√≥
                    if (el && saveKey !== 'daily_paste_thiduanv') {
                    el.value = pastedText;
                    }
                    // === END FIX ===

                    let processedCount = 0;
                
                // === FIX 2a.2 (S·ª≠a) ===
                if (saveKey === 'daily_paste_thiduanv') {
                    // D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i v√†o appState.pastedThiDuaReportData trong loadDataFromStorage
                    processedCount = appState.pastedThiDuaReportData.length;
                } 
                // === END FIX ===
                else if (stateKey && processFunc) {
                    const processedData = processFunc(pastedText);
                    appState[stateKey] = processedData;
                    processedCount = processedData?.length || 0;
                } else if (uiId === 'status-luyke') {
                    // === FIX 2a.3 (Th√™m) ===
                    // X·ª≠ l√Ω ngay d·ªØ li·ªáu L≈©y k·∫ø d√°n v√†o ƒë·ªÉ appState.competitionData s·∫µn s√†ng
                    try {
                        services.parseCompetitionDataFromLuyKe(pastedText);
                        console.log("[loadPastedData] Parsed luyke paste data from cache.");
                    } catch(e) {
                        console.warn("L·ªói x·ª≠ l√Ω 'paste-luyke' t·ª´ cache khi t·∫£i trang:", e);
                    }
                    // === END FIX ===
                }


                const kho = localStorage.getItem('selectedWarehouse');
                const mappingInfo = Object.values(this.ALL_DATA_MAPPING).find(m => m.saveKey === saveKey);
                let metadata = null;
                if (kho && mappingInfo) {
                    // <<< C·∫¨P NH·∫¨T (v4.48): G·ªçi h√†m helper t·ª´ dataService >>>
                    metadata = dataService._getSavedMetadata(kho, mappingInfo.firestoreKey);
                    if (metadata) {
                            ui.updatePasteStatus(uiId, '', 'success', metadata, processedCount); // <<< S·ª¨A (v4.47)
                    } else {
                            // === FIX 2b.2 (S·ª≠a) ===
                            let countMsg = processedCount > 0 ? `(${processedCount} NV)` : '';
                            if (uiId === 'status-luyke') countMsg = ''; // L≈©y k·∫ø kh√¥ng ƒë·∫øm
                            ui.updatePasteStatus(uiId, `‚úì ƒê√£ t·∫£i ${countMsg} (ch∆∞a ƒë·ªìng b·ªô)`, 'success', null, processedCount); // <<< S·ª¨A (v4.47)
                    }
                } else if (pastedText) {
                        // === FIX 2b.2 (S·ª≠a) ===
                        let countMsg = processedCount > 0 ? `(${processedCount} NV)` : '';
                        if (uiId === 'status-luyke') countMsg = '';
                        ui.updatePasteStatus(uiId, `‚úì ƒê√£ t·∫£i ${countMsg} (ch∆∞a ch·ªçn kho)`, 'success', null, processedCount); // <<< S·ª¨A (v4.47)
                }
            }
        };

        loadPasted('saved_thuongerp_thangtruoc', 'thuongERPDataThangTruoc', 'status-thuongerp-thangtruoc', services.processThuongERP);
        loadPasted('daily_paste_luyke', null, 'status-luyke', null);
        loadPasted('daily_paste_thiduanv', 'pastedThiDuaReportData', 'status-thiduanv', null); // *** MODIFIED (v4.40) ***
        loadPasted('daily_paste_thuongerp', 'thuongERPData', 'status-thuongerp', services.processThuongERP);

        // === FIX 2a.2 (Th√™m) - X·ª≠ l√Ω t·∫£i l·∫°i raw text cho Thi ƒëua NV ===
        const rawThiDuaPaste = localStorage.getItem(RAW_PASTE_THIDUANV_KEY);
        // === START: DEBUG (v4.43) ===
        if (rawThiDuaPaste) {
            console.log(`%c[DEBUG loadPastedDataFromStorage]   > T√¨m th·∫•y d·ªØ li·ªáu TH√î cho ${RAW_PASTE_THIDUANV_KEY}. (ƒê·ªô d√†i: ${rawThiDuaPaste.length})`, "color: green;");
        } else {
            console.log(`%c[DEBUG loadPastedDataFromStorage]   > Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho ${RAW_PASTE_THIDUANV_KEY} trong localStorage.`, "color: red;");
        }
        // === END: DEBUG ===
        if (rawThiDuaPaste) {
            const el = document.getElementById('paste-thiduanv');
            if (el) el.value = rawThiDuaPaste;
        }
        // === END FIX ===
    },

    updateAndRenderCurrentTab() {
        // ... (Gi·ªØ nguy√™n)
        ui.renderCompetitionConfigUI(); // <<< S·ª¨A (v4.47)
        ui.renderSpecialProgramConfigUI(); // <<< TH√äM M·ªöI (v4.55)
        const activeTab = document.querySelector('.page-section:not(.hidden)');
        if (!activeTab) {
            return;
        }
        switch (activeTab.id) {
            case 'health-section': luykeTab.render(); break;
            case 'health-employee-section': sknvTab.render(); break;
            case 'realtime-section': uiRealtime.render(); break;
        }
        feather.replace();
    },

    switchTab(targetId) {
            // ... (Gi·ªØ nguy√™n)
        document.querySelectorAll('.page-section').forEach(section => section.classList.toggle('hidden', section.id !== targetId));
        document.querySelectorAll('.nav-link').forEach(link => {
                const isActive = link.getAttribute('href') === `#${targetId}`;
                link.classList.toggle('bg-blue-100', isActive);
            link.classList.toggle('text-blue-700', isActive);
        });
        if (targetId === 'home-section') ui.renderHomePage();
        else if (targetId === 'health-section') luykeTab.render();
        else if (targetId === 'health-employee-section') sknvTab.render();
        else if (targetId === 'realtime-section') uiRealtime.render();
        else if (targetId === 'declaration-section' && appState.isAdmin) ui.renderAdminPage();
        feather.replace();
    },

    async loadAndApplyBookmarkLink() {
        // ... (Gi·ªØ nguy√™n)
            try {
                // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
                const bookmarkUrl = await storageService.getBookmarkDownloadURL();
                // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
            const linkElement = document.getElementById('download-bookmark-link');
            if (linkElement) linkElement.href = bookmarkUrl;
        } catch (error) {
                console.error("Kh√¥ng th·ªÉ t·∫£i link bookmark:", error);
            const linkElement = document.getElementById('download-bookmark-link');
            if (linkElement) linkElement.style.display = 'none';
        }
    },

    handleThiDuaVungFilterChange() {
        // ... (Gi·ªØ nguy√™n)
        const choicesInstance = appState.choices.thiDuaVung_sieuThi;
        if (!choicesInstance) return;
        const selectedValue = choicesInstance.getValue(true);
        if (selectedValue) {
            const reportData = services.generateThiDuaVungReport(selectedValue);
            ui.renderThiDuaVungInfographic(reportData);
        } else {
            const container = document.getElementById('thidua-vung-infographic-container');
            if(container) container.innerHTML = `<div class="placeholder-message">Vui l√≤ng ch·ªçn m·ªôt si√™u th·ªã ƒë·ªÉ xem b√°o c√°o.</div>`;
        }
    },

    handleDthangRealtimeViewChange(e) {
        // ... (Giƒü nguy√™n)
        const button = e.target.closest('.view-switcher__btn');
        if (button) {
            document.querySelectorAll('#dthang-realtime-view-selector .view-switcher__btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            uiRealtime.render();
        }
    },

    handleLuykeThiDuaViewChange(e) {
        // ... (Gi·ªØ nguy√™n)
        const button = e.target.closest('.view-switcher__btn');
        if (button) {
            document.querySelectorAll('#luyke-thidua-view-selector .view-switcher__btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            luykeTab.render();
        }
    },

    handleThiDuaViewChange(e) {
        // ... (Gi·ªØ nguy√™n)
            const button = e.target.closest('.view-switcher__btn');
        if (button) {
                document.querySelectorAll('#thidua-view-selector .view-switcher__btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            const view = button.dataset.view;
            const thiduaEmployeeSelectorEl = document.getElementById('thidua-employee-selector-container');
            if(thiduaEmployeeSelectorEl) thiduaEmployeeSelectorEl.classList.toggle('hidden', view !== 'employee');
            ui.displayCompetitionReport(view);
        }
    },

    // <<< X√ìA B·ªé (v4.49) >>>
    // async handleCompetitionDebugFile(e) { ... }

    _handleCompetitionFormShow(show = true, isEdit = false) {
        // ... (Gi·ªØ nguy√™n)
        const form = document.getElementById('competition-form');
        const addBtn = document.getElementById('add-competition-btn');
        if (!form || !addBtn) return;
        if (show) {
            ui.populateCompetitionFilters(); // <<< S·ª¨A (v4.47)
            ui.populateCompetitionBrandFilter(); // <<< S·ª¨A (v4.47)
        }
        form.classList.toggle('hidden', !show);
        addBtn.classList.toggle('hidden', show);
        if (show && !isEdit) {
                form.reset();
            document.getElementById('competition-id').value = '';
            appState.choices['competition_group']?.removeActiveItems();
            appState.choices['competition_brand']?.removeActiveItems();
            const priceSegmentEl = document.getElementById('price-segment');
            if(priceSegmentEl) priceSegmentEl.classList.add('hidden');
        }
    },

    _handleCompetitionFormEdit(index) {
        // ... (Gi·ªØ nguy√™n)
        // === START REFACTOR 2 (B∆∞·ªõc 2d) ===
        // S·ª≠a appState.competitionConfigs -> appState.globalCompetitionConfigs
        const config = appState.globalCompetitionConfigs[index];
        // === END REFACTOR 2 ===
        if (!config) return;
        this._handleCompetitionFormShow(true, true);
        document.getElementById('competition-id').value = index;
        document.getElementById('competition-name').value = config.name;
        const brandChoices = appState.choices['competition_brand'];
        if(brandChoices) {
            brandChoices.removeActiveItems();
            brandChoices.setChoiceByValue(config.brands || []);
        }
        const compTypeEl = document.getElementById('competition-type');
        if(compTypeEl) compTypeEl.value = config.type;
        const compExcludeEl = document.getElementById('competition-exclude-apple');
        if(compExcludeEl) compExcludeEl.checked = config.excludeApple;
        const priceSegment = document.getElementById('price-segment');
        if(priceSegment) priceSegment.classList.toggle('hidden', config.type !== 'soluong');
        const minPriceEl = document.getElementById('competition-min-price');
        if(minPriceEl) minPriceEl.value = config.minPrice ? config.minPrice / 1000000 : '';
        const maxPriceEl = document.getElementById('competition-max-price');
        if(maxPriceEl) maxPriceEl.value = config.maxPrice ? config.maxPrice / 1000000 : '';
        const groupChoices = appState.choices['competition_group'];
        if (groupChoices) {
            groupChoices.removeActiveItems();
            groupChoices.setChoiceByValue(config.groups);
        }
    },

    _handleCompetitionDelete(index) {
        // ... (Gi·ªØ nguy√™n)
        // === START REFACTOR 2 (B∆∞·ªõc 2d) ===
        // S·ª≠a logic ƒë·ªÉ x√≥a kh·ªèi global configs v√† l∆∞u v√†o Firestore
        appState.globalCompetitionConfigs.splice(index, 1);
        adminService.saveGlobalCompetitionConfigs(appState.globalCompetitionConfigs);
        // === END REFACTOR 2 ===
        this.updateAndRenderCurrentTab();
        ui.showNotification('ƒê√£ x√≥a ch∆∞∆°ng tr√¨nh thi ƒëua.', 'success');
    },

    _handleCompetitionFormSubmit(e) {
        // ... (Gi·ªØ nguy√™n)
        e.preventDefault();
        const id = document.getElementById('competition-id').value;
        const name = document.getElementById('competition-name').value.trim();
        if (!name) { ui.showNotification('T√™n ch∆∞∆°ng tr√¨nh kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.', 'error'); return; }
        const groupChoices = appState.choices['competition_group'];
        const groups = groupChoices ? groupChoices.getValue(true) : [];
        const brandChoices = appState.choices['competition_brand'];
        const brands = brandChoices ? brandChoices.getValue(true) : [];
        if (brands.length === 0) { ui.showNotification('L·ªói: Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h√£ng s·∫£n xu·∫•t.', 'error'); return; }
        const compTypeEl = document.getElementById('competition-type');
        const minPriceEl = document.getElementById('competition-min-price');
        const maxPriceEl = document.getElementById('competition-max-price');
        const excludeAppleEl = document.getElementById('competition-exclude-apple');
        
        // === START REFACTOR 2 (B∆∞·ªõc 2d) ===
        // S·ª≠a logic ƒë·ªÉ l∆∞u v√†o global configs v√† Firestore
        const newConfig = {
            id: id ? appState.globalCompetitionConfigs[parseInt(id, 10)].id : `comp_${new Date().getTime()}`,
            name: name,
            brands: brands,
            groups: groups,
            type: compTypeEl ? compTypeEl.value : 'doanhthu',
            minPrice: (parseFloat(minPriceEl?.value) || 0) * 1000000,
            maxPrice: (parseFloat(maxPriceEl?.value) || 0) * 1000000,
            excludeApple: excludeAppleEl ? excludeAppleEl.checked : false,
        };
        if (id !== '') { appState.globalCompetitionConfigs[parseInt(id, 10)] = newConfig; }
        else { appState.globalCompetitionConfigs.push(newConfig); }
        adminService.saveGlobalCompetitionConfigs(appState.globalCompetitionConfigs);
        // === END REFACTOR 2 ===
        
        this._handleCompetitionFormShow(false);
        this.updateAndRenderCurrentTab();
        ui.showNotification('ƒê√£ l∆∞u ch∆∞∆°ng tr√¨nh thi ƒëua th√†nh c√¥ng!', 'success');
    },


    _saveCompetitionConfigs() {
        // ... (Gi·ªØ nguy√™n)
        // === START REFACTOR 2 (B∆∞·ªõc 2d) ===
        // L∆∞u config C√Å NH√ÇN (local) v√†o localStorage
        localStorage.setItem('competitionConfigs', JSON.stringify(appState.localCompetitionConfigs));
        // === END REFACTOR 2 ===
    },

    // ========== START: H√ÄM M·ªöI (S·ª¨A L·ªñI) ==========
    _handleSpecialProgramFormShow(show = true, isEdit = false) {
        const form = document.getElementById('special-program-form');
        const addBtn = document.getElementById('add-special-program-btn');
        if (!form || !addBtn) return;

        if (show) {
            // C·∫ßn ƒëi·ªÅn d·ªØ li·ªáu cho 'special-program-group'
            const groupSelectInstance = appState.choices['special_program_group'];
            if (groupSelectInstance) {
                // L·∫•y nh√≥m h√†ng t·ª´ danh s√°ch SPƒêQ ƒë√£ t·∫£i
                const uniqueGroups = [...new Set(appState.specialProductList.map(item => String(item.nhomHang).trim()).filter(Boolean))].sort();
                const groupOptions = uniqueGroups.map(group => ({ value: group, label: group }));
                groupSelectInstance.clearStore();
                groupSelectInstance.setChoices(groupOptions, 'value', 'label', true);
            }
        }

        form.classList.toggle('hidden', !show);
        addBtn.classList.toggle('hidden', show);

        if (show && !isEdit) {
            form.reset();
            document.getElementById('special-program-id').value = '';
            appState.choices['special_program_group']?.removeActiveItems();
        }
    },

    // === START: S·ª¨A L·ªñI (Bug 2) - Th√™m h√†m S·ª≠a ===
    _handleSpecialProgramFormEdit(index) {
        const config = appState.globalSpecialPrograms[index];
        if (!config) {
            ui.showNotification('L·ªói: Kh√¥ng t√¨m th·∫•y ch∆∞∆°ng tr√¨nh ƒë·ªÉ s·ª≠a.', 'error');
            return;
        }

        // 1. Hi·ªÉn th·ªã form ·ªü ch·∫ø ƒë·ªô "Edit"
        this._handleSpecialProgramFormShow(true, true);

        // 2. ƒêi·ªÅn d·ªØ li·ªáu c≈© v√†o form
        document.getElementById('special-program-id').value = index;
        document.getElementById('special-program-name').value = config.name;
        
        const groupChoices = appState.choices['special_program_group'];
        if (groupChoices) {
            groupChoices.removeActiveItems();
            // ƒê·∫£m b·∫£o c√°c l·ª±a ch·ªçn (choices) c√≥ s·∫µn tr∆∞·ªõc khi set gi√° tr·ªã
            const uniqueGroups = [...new Set(appState.specialProductList.map(item => String(item.nhomHang).trim()).filter(Boolean))].sort();
            const groupOptions = uniqueGroups.map(group => ({ value: group, label: group }));
            groupChoices.setChoices(groupOptions, 'value', 'label', true);
            // Set gi√° tr·ªã
            groupChoices.setChoiceByValue(config.groups || []);
        }
    },
    // === END: S·ª¨A L·ªñI (Bug 2) ===

    _handleSpecialProgramFormSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('special-program-id').value;
        const name = document.getElementById('special-program-name').value.trim();
        if (!name) { 
            ui.showNotification('T√™n ch∆∞∆°ng tr√¨nh kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.', 'error'); 
            return; 
        }

        // === START: TH√äM KI·ªÇM TRA TR√ôNG L·∫∂P (v4.56) ===
        const newNameLower = name.trim().toLowerCase();
        // Ki·ªÉm tra xem c√≥ ch∆∞∆°ng tr√¨nh n√†o kh√°c (kh√¥ng ph·∫£i ch√≠nh n√≥) c√≥ t√™n n√†y kh√¥ng
        const existingProgram = appState.globalSpecialPrograms.find((p, index) => {
            const isDifferentProgram = id === '' || parseInt(id, 10) !== index;
            return isDifferentProgram && p.name.trim().toLowerCase() === newNameLower;
        });

        if (existingProgram) {
            ui.showNotification('L·ªói: T√™n ch∆∞∆°ng tr√¨nh n√†y ƒë√£ t·ªìn t·∫°i.', 'error');
            return;
        }
        // === END: TH√äM KI·ªÇM TRA TR√ôNG L·∫∂P ===
        
        const groupChoices = appState.choices['special_program_group'];
        const groups = groupChoices ? groupChoices.getValue(true) : [];
        
        if (groups.length === 0) { 
            ui.showNotification('L·ªói: Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt Nh√≥m h√†ng.', 'error'); 
            return; 
        }

        const newProgram = {
            id: id ? appState.globalSpecialPrograms[parseInt(id, 10)].id : `sp_${new Date().getTime()}`,
            name: name,
            groups: groups,
        };

        if (id !== '') { 
            appState.globalSpecialPrograms[parseInt(id, 10)] = newProgram; 
        } else { 
            appState.globalSpecialPrograms.push(newProgram); 
        }
        
        // L∆∞u l√™n Firestore
        adminService.saveGlobalSpecialPrograms(appState.globalSpecialPrograms);
        
        this._handleSpecialProgramFormShow(false);
        this.updateAndRenderCurrentTab();
        ui.showNotification('ƒê√£ l∆∞u ch∆∞∆°ng tr√¨nh SP ƒê·∫∑c Quy·ªÅn th√†nh c√¥ng!', 'success');
    },
    
    // === START: S·ª¨A L·ªñI (Bug 2) - Th√™m h√†m X√≥a ===
    _handleSpecialProgramDelete(index) {
        const config = appState.globalSpecialPrograms[index];
        if (!config) {
            ui.showNotification('L·ªói: Kh√¥ng t√¨m th·∫•y ch∆∞∆°ng tr√¨nh ƒë·ªÉ x√≥a.', 'error');
            return;
        }

        // 1. X√≥a kh·ªèi m·∫£ng state
        appState.globalSpecialPrograms.splice(index, 1);
        
        // 2. L∆∞u m·∫£ng m·ªõi l√™n Firestore
        adminService.saveGlobalSpecialPrograms(appState.globalSpecialPrograms);
        
        // 3. Render l·∫°i UI (drawer s·∫Ω t·ª± c·∫≠p nh·∫≠t)
        this.updateAndRenderCurrentTab();
        ui.showNotification(`ƒê√£ x√≥a ch∆∞∆°ng tr√¨nh "${config.name}".`, 'success');
    },
    // === END: S·ª¨S L·ªñI (Bug 2) ===
    // ========== END: H√ÄM M·ªöI ==========

    // <<< X√ìA B·ªé (v4.49) >>>
    // async handleTemplateDownload() { ... }

    handleAdminLogin() {
        // ... (Gi·ªØ nguy√™n)
        const passInputEl = document.getElementById('admin-password-input');
        const errorMsgEl = document.getElementById('admin-error-msg');
        if (passInputEl?.value === config.ADMIN_PASSWORD) {
            appState.isAdmin = true;
            ui.renderFeedbackSection();
            ui.renderAdminHelpEditors();
            this.switchTab('declaration-section');
            ui.toggleModal('admin-modal', false);
            passInputEl.value = '';
            if(errorMsgEl) errorMsgEl.classList.add('hidden');
        } else {
            if(errorMsgEl) errorMsgEl.classList.remove('hidden');
        }
    },

    handleContrastChange(e) {
        // ... (Gi·ªØ nguy√™n)
            const level = e.target.value;
            localStorage.setItem('contrastLevel', level);
            document.documentElement.dataset.contrast = level;
    },

    handleHighlightColorChange(prefix) {
        // ... (Gi·ªØ nguy√™n)
        const activeType = appState.highlightSettings[prefix]?.type;
        if (activeType) {
                const choicesInstance = appState.choices[`${prefix}_highlight_${activeType}`];
                if(choicesInstance) {
                const values = choicesInstance.getValue(true);
                const colorEl = document.getElementById(`${prefix}-highlight-color`);
                const color = colorEl ? colorEl.value : '#ffff00';
                appState.highlightSettings[prefix] = { type: activeType, values, color };
                localStorage.setItem('highlightSettings', JSON.stringify(appState.highlightSettings));
                highlightService.applyHighlights(prefix);
                }
        }
    },

        handleClearHighlight(prefix) {
        // ... (Gi·ªØ nguy√™n)
        appState.highlightSettings[prefix] = {};
        localStorage.setItem('highlightSettings', JSON.stringify(appState.highlightSettings));
        ['nhanhang', 'nhomhang', 'employee'].forEach(type => {
            appState.choices[`${prefix}_highlight_${type}`]?.removeActiveItemsByValue(appState.choices[`${prefix}_highlight_${type}`]?.getValue(true) || []);
        });
        highlightService.applyHighlights(prefix);
    },

        async saveDeclarations() {
        // ... (Gi·ªØ nguy√™n)
        const ycxEl = document.getElementById('declaration-ycx');
        const ycxGopEl = document.getElementById('declaration-ycx-gop');
        const heSoEl = document.getElementById('declaration-heso');
        const declarationsToSave = {
            ycx: ycxEl ? ycxEl.value : '',
            ycxGop: ycxGopEl ? ycxGopEl.value : '',
            heSo: heSoEl ? heSoEl.value : ''
        };
        // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
        await adminService.saveDeclarationsToFirestore(declarationsToSave);
        // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
        appState.declarations.hinhThucXuat = declarationsToSave.ycx;
        appState.declarations.hinhThucXuatGop = declarationsToSave.ycxGop;
        appState.declarations.heSoQuyDoi = declarationsToSave.heSo;
        this.updateAndRenderCurrentTab();
    },

    saveHelpContent() {
        // ... (Gi·ªØ nguy√™n)
        const dataEl = document.getElementById('edit-help-data');
        const luykeEl = document.getElementById('edit-help-luyke');
        const sknvEl = document.getElementById('edit-help-sknv');
        const realtimeEl = document.getElementById('edit-help-realtime');
        const contents = {
                data: dataEl ? dataEl.value : '',
                luyke: luykeEl ? luykeEl.value : '',
                sknv: sknvEl ? sknvEl.value : '',
                realtime: realtimeEl ? realtimeEl.value : ''
        };
        // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
        adminService.saveHelpContent(contents);
        // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
    },

    async handleSubmitFeedback() {
        // ... (Gi·ªØ nguy√™n)
        const textarea = document.getElementById('feedback-textarea');
        if(textarea){
            // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
            const success = await collaborationService.submitFeedback(textarea.value.trim());
            // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
            if (success) textarea.value = '';
        }
    },

    async handleFeedbackReplyActions(e, feedbackItem) {
        // ... (Gi·ªØ nguy√™n)
        const docId = feedbackItem.dataset.id;
        const replyForm = feedbackItem.querySelector('.reply-form-container');
        if (!replyForm) return;
        if (e.target.classList.contains('reply-btn')) { replyForm.classList.remove('hidden'); }
            if (e.target.classList.contains('cancel-reply-btn')) { replyForm.classList.add('hidden'); }
        if (e.target.classList.contains('submit-reply-btn')) {
                const textarea = replyForm.querySelector('textarea');
                if(textarea){
                    // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
                    const success = await collaborationService.submitReply(docId, textarea.value.trim());
                    // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
                if (success) { textarea.value = ''; replyForm.classList.add('hidden'); }
                }
        }
    },

    _getFilteredReportData(sectionId) {
        // ... (Gi·ªØ nguy√™n)
        const masterData = appState.masterReportData[sectionId] || [];
        if (masterData.length === 0) return [];
        const warehouseEl = document.getElementById(`${sectionId}-filter-warehouse`);
        const deptEl = document.getElementById(`${sectionId}-filter-department`);
        const selectedWarehouse = warehouseEl ? warehouseEl.value : '';
        const selectedDept = deptEl ? deptEl.value : '';
        const selectedNames = appState.choices[`${sectionId}_employee`] ? appState.choices[`${sectionId}_employee`].getValue(true) : [];
        let filteredReport = masterData;
        if (selectedWarehouse) filteredReport = filteredReport.filter(nv => nv.maKho == selectedWarehouse);
        if (selectedDept) filteredReport = filteredReport.filter(nv => nv.boPhan === selectedDept);
        if (selectedNames && selectedNames.length > 0) filteredReport = filteredReport.filter(nv => selectedNames.includes(String(nv.maNV)));
        return filteredReport;
    },

    async prepareAndShowComposer(sectionId) {
        // ... (Gi·ªØ nguy√™n)
        const modal = document.getElementById('composer-modal');
        if (!modal) return;
        modal.dataset.sectionId = sectionId;
        const deptFilter = document.getElementById('composer-dept-filter');
        if (deptFilter) {
            const uniqueDepartments = [...new Set(appState.danhSachNhanVien.map(nv => nv.boPhan).filter(Boolean))].sort();
            deptFilter.innerHTML = '<option value="ALL">To√†n si√™u th·ªã</option>' + uniqueDepartments.map(dept => `<option value="${dept}">${dept}</option>`).join('');
        }
        const navIdMap = { luyke: 'luyke-subtabs-nav', sknv: 'employee-subtabs-nav', realtime: 'realtime-subtabs-nav' };
        const mainViewNav = document.getElementById(navIdMap[sectionId]);
        const contextTabsContainer = document.getElementById('composer-context-tabs');
        const contextContentContainer = document.getElementById('composer-context-content');
        if(contextTabsContainer) contextTabsContainer.innerHTML = '';
        if(contextContentContainer) contextContentContainer.innerHTML = '';
        if (mainViewNav && contextTabsContainer && contextContentContainer) {
                const subTabButtons = mainViewNav.querySelectorAll('.sub-tab-btn');
            subTabButtons.forEach(btn => {
                    const subTabId = btn.dataset.target;
                const isActive = btn.classList.contains('active');
                const newTabBtn = document.createElement('button');
                newTabBtn.className = `composer__tab-btn ${isActive ? 'active' : ''}`;
                newTabBtn.dataset.target = `context-pane-${subTabId}`;
                newTabBtn.textContent = btn.textContent.trim();
                    newTabBtn.addEventListener('click', () => {
                    contextTabsContainer.querySelectorAll('.composer__tab-btn').forEach(t => t.classList.remove('active'));
                    contextContentContainer.querySelectorAll('.composer__context-pane').forEach(c => c.classList.add('hidden'));
                    newTabBtn.classList.add('active');
                    const targetPane = document.getElementById(`context-pane-${subTabId}`);
                    if(targetPane) targetPane.classList.remove('hidden');
                });
                    contextTabsContainer.appendChild(newTabBtn);
                    const newContentPane = document.createElement('div');
                    newContentPane.id = `context-pane-${subTabId}`;
                    newContentPane.className = `composer__context-pane ${!isActive ? 'hidden' : ''}`;
                    const textarea = document.createElement('textarea');
                    textarea.className = 'composer__textarea';
                    textarea.rows = 15;
                    textarea.placeholder = `So·∫°n th·∫£o nh·∫≠n x√©t cho tab ${btn.textContent.trim()}...`;
                    if (!appState.composerTemplates[sectionId]) appState.composerTemplates[sectionId] = {};
                    textarea.value = appState.composerTemplates[sectionId]?.[subTabId] || '';
                    newContentPane.appendChild(textarea);
                    contextContentContainer.appendChild(newContentPane);
            });
            contextTabsContainer.classList.toggle('hidden', contextTabsContainer.children.length === 0);
        }
        const filteredReportData = this._getFilteredReportData(sectionId);
        const supermarketReport = services.aggregateReport(filteredReportData);
        ui.populateComposerDetailTags(supermarketReport);
        ui.showComposerModal(sectionId);
    },

    handleComposerActions(e, modal) {
        // ... (Gi·ªØ nguy√™n)
        const sectionId = modal.dataset.sectionId;
        const activeContextPane = modal.querySelector('.composer__context-pane:not(.hidden)');
        const activeTextarea = activeContextPane ? activeContextPane.querySelector('textarea') : null;
        if (e.target.matches('.composer__tab-btn:not([data-context-tab])')) {
            const nav = e.target.closest('.composer__nav');
            const content = nav?.nextElementSibling;
            if (nav && content) {
                    nav.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
                    content.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
                    e.target.classList.add('active');
                    const targetId = e.target.dataset.tab;
                    const targetContent = content.querySelector(`#${targetId}`);
                    if (targetContent) targetContent.classList.add('active');
            }
            return;
        }
        if (e.target.matches('.composer__icon-btn, .composer__tag-btn')) {
                if (!activeTextarea) { ui.showNotification("Vui l√≤ng ch·ªçn m·ªôt tab n·ªôi dung ƒë·ªÉ ch√®n th·∫ª.", "error"); return; }
                let tagToInsert = e.target.dataset.tag;
            if (e.target.dataset.tagTemplate) {
                const deptFilterEl = document.getElementById('composer-dept-filter');
                const dept = deptFilterEl ? deptFilterEl.value : 'ALL';
                tagToInsert = e.target.dataset.tagTemplate.replace('{dept}', dept);
            }
            ui.insertComposerTag(activeTextarea, tagToInsert || e.target.textContent);
            return;
        }
            if (e.target.id === 'save-composer-template-btn') {
            if (!activeTextarea) return;
            const activeContextTab = modal.querySelector('#composer-context-tabs .composer__tab-btn.active');
            const subTabId = activeContextTab?.dataset.target.replace('context-pane-', '');
            if (subTabId) {
                    if (!appState.composerTemplates[sectionId]) appState.composerTemplates[sectionId] ={};
                appState.composerTemplates[sectionId][subTabId] = activeTextarea.value;
                localStorage.setItem('composerTemplates', JSON.stringify(appState.composerTemplates));
                ui.showNotification(`ƒê√£ l∆∞u m·∫´u cho tab con!`, 'success');
            } else { ui.showNotification(`Kh√¥ng t√¨m th·∫•y tab con ƒë·ªÉ l∆∞u.`, 'error'); }
        }
        if (e.target.id === 'copy-composed-notification-btn') {
                if (!activeTextarea) { ui.showNotification("L·ªói: Kh√¥ng t√¨m th·∫•y √¥ n·ªôi dung ƒëang ho·∫°t ƒë·ªông.", "error"); return; }
                const template = activeTextarea.value;
                const filteredReportData = this._getFilteredReportData(sectionId);
                const supermarketReport = services.aggregateReport(filteredReportData);
                const warehouseEl = document.getElementById(`${sectionId}-filter-warehouse`);
                const selectedWarehouse = warehouseEl ? warehouseEl.value : null;
                const goals = sectionId === 'realtime' ? settingsService.getRealtimeGoalSettings(selectedWarehouse).goals : settingsService.getLuykeGoalSettings(selectedWarehouse).goals;
                const pasteLuykeEl = document.getElementById('paste-luyke');
                const competitionDataForComposer = services.parseCompetitionDataFromLuyKe(pasteLuykeEl?.value || '');
                const processedText = services.processComposerTemplate(template, supermarketReport, goals, filteredReportData, competitionDataForComposer, sectionId);
                ui.showPreviewAndCopy(processedText);
        }
    },

    async loadAndDisplayQrCode() {
        // ... (Gi·ªØ nguy√™n)
            try {
                // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
                const qrUrl = await storageService.getQrCodeDownloadURL();
                // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
            const imgEl = document.getElementById('header-qr-image');
            if (imgEl) imgEl.src = qrUrl;
        }
        catch (error) {
                console.error("Kh√¥ng th·ªÉ t·∫£i m√£ QR:", error);
            const container = document.querySelector('.header-qr-container');
            if (container) container.style.display = 'none';
        }
    }
};

// Kh·ªüi ch·∫°y ·ª©ng d·ª•ng khi DOM ƒë√£ s·∫µn s√†ng
app.init();
--- END FILE: ./main.js ---

--- START FILE: ./modules/capture.service.js ---
// Version 1.9 - Add fixed width to preset-mobile-portrait for better mobile viewing
// Version 1.8 - Fix: Apply presetClass to contentClone instead of wrapper
// Version 1.1 - Fix blank charts by disabling Chart.js animations and adding 500ms delay during capture
// Version 1.0 - Refactored from utils.js
// MODULE: CAPTURE SERVICE
// Ch·ª©a to√†n b·ªô logic li√™n quan ƒë·∫øn vi·ªác ch·ª•p ·∫£nh m√†n h√¨nh c√°c th√†nh ph·∫ßn UI.

import { ui } from '../ui.js';
import { analyticsService } from '../services/analytics.service.js';
import { appState } from '../state.js'; // <<< TH√äM M·ªöI (K·∫ø ho·∫°ch A)

// --- HELPER for Screenshot CSS Injection ---
const _injectCaptureStyles = () => {
    const styleId = 'dynamic-capture-styles';
    document.getElementById(styleId)?.remove();

    const styles = `
        .capture-container { 
            padding: 24px; 
            background-color: #f3f4f6; 
            box-sizing: border-box; 
            width: fit-content; 
            position: absolute;
            left: -9999px;
            top: 0;
            z-index: -1;
        }
        .capture-layout-container { 
            display: flex; 
            flex-direction: column; 
            gap: 24px; 
        }
        .capture-title { 
            font-size: 28px; 
            font-weight: 700; 
            text-align: center; 
            color: #1f2937; 
            margin-bottom: 24px; 
            padding: 12px; 
            background-color: #ffffff; 
            border-radius: 0.75rem; 
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); 
        }
        /* --- VIRTUAL STAGES / PRESETS --- */
        .prepare-for-kpi-capture {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 24px !important;
            width: 900px !important;
        }
        .preset-mobile-portrait {
            /* width: 750px !important; <-- ƒê√É X√ìA (v1.4) */
            width: 550px !important; /* (Req 3) Co chi·ªÅu ngang cho ·∫£nh ch·ª•p mobile */
        }
        .preset-landscape-table {
            width: fit-content !important;
        }
        .preset-landscape-table table {
            table-layout: fixed !important;
        }
        .preset-landscape-table th, 
        .preset-landscape-table td {
            width: 95px !important;
            word-wrap: break-word;
        }
        .preset-landscape-table th:first-child,
        .preset-landscape-table td:first-child {
            width: 180px !important;
        }
        .preset-large-font-report {
            width: 800px !important;
        }
        .preset-large-font-report table th {
            white-space: normal !important;
            vertical-align: middle;
        }
        .preset-large-font-report table td {
            font-size: 22px !important;
            vertical-align: middle;
        }
        .preset-infographic-wide {
            width: 1100px !important;
        }
    `;

    const styleElement = document.createElement('style');
    styleElement.id = styleId;
    styleElement.innerHTML = styles;
    document.head.appendChild(styleElement);
    return styleElement;
};

// === START: H√ÄM H·ªñ TR·ª¢ M·ªöI (K·∫ø ho·∫°ch A) ===
/**
 * T√¨m v√† thay th·∫ø t·∫•t c·∫£ <canvas> c·ªßa Chart.js b·∫±ng <img> tƒ©nh.
 * @param {HTMLElement} element - V√πng DOM (clone) s·∫Øp ƒë∆∞·ª£c ch·ª•p.
 */
const _swapCanvasToImage = (element) => {
    console.log("[Capture Service] Swapping canvas to image...");
    const canvasElements = element.querySelectorAll('canvas');
    let replacedCount = 0;
    
    canvasElements.forEach(canvas => {
        const chartId = canvas.id;
        if (chartId && appState.charts[chartId]) {
            try {
                const chart = appState.charts[chartId];
                const base64Image = chart.toBase64Image(); // L·∫•y ·∫£nh tƒ©nh
                
                if (base64Image) {
                    const img = document.createElement('img');
                    img.src = base64Image;
                    // Gi·ªØ nguy√™n k√≠ch th∆∞·ªõc ƒë·ªÉ tr√°nh v·ª° layout
                    img.style.width = canvas.style.width || `${canvas.width}px`;
                    img.style.height = canvas.style.height || `${canvas.height}px`;
                    img.style.display = 'block';
                    
                    // Thay th·∫ø canvas b·∫±ng img
                    canvas.parentNode.replaceChild(img, canvas);
                    replacedCount++;
                }
            } catch (e) {
                console.error(`[Capture Service] L·ªói khi ho√°n ƒë·ªïi canvas '${chartId}':`, e);
            }
        }
    });
    console.log(`[Capture Service] ƒê√£ ho√°n ƒë·ªïi ${replacedCount} bi·ªÉu ƒë·ªì.`);
};
// === END: H√ÄM H·ªñ TR·ª¢ M·ªöI ===

export const captureService = {
    async captureAndDownload(elementToCapture, title, presetClass = '') {
        const date = new Date();
        const timeString = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        const dateString = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
        const finalTitle = `${title.replace(/_/g, ' ')} - ${timeString} ${dateString}`;
    
        const captureWrapper = document.createElement('div');
        captureWrapper.className = 'capture-container';
    
        // *** S·ª¨A L·ªñI (v1.8) ***
        // X√≥a: if (presetClass) { captureWrapper.classList.add(presetClass); }

        const titleEl = document.createElement('h2');
        titleEl.className = 'capture-title';
        titleEl.textContent = finalTitle;
        captureWrapper.appendChild(titleEl);
        
        const contentClone = elementToCapture.cloneNode(true);
        
        // *** S·ª¨A L·ªñI (v1.8) ***
        // B·ªè ch√∫ th√≠ch v√† g√°n class cho contentClone
        if (presetClass) { contentClone.classList.add(presetClass); }

        captureWrapper.appendChild(contentClone);
        document.body.appendChild(captureWrapper);
    
        // === START: THAY TH·∫æ LOGIC 500ms (K·∫ø ho·∫°ch A) ===
        // T·∫Øt animation (v·∫´n gi·ªØ ƒë·ªÉ ph√≤ng h·ªù)
        if (window.Chart) {
            Chart.defaults.animation = false;
        }
        
        // **THAY TH·∫æ CANVAS B·∫∞NG IMG**
        _swapCanvasToImage(contentClone);

        // Th√™m m·ªôt ƒë·ªô tr·ªÖ ng·∫Øn (100ms) ƒë·ªÉ img k·ªãp render, an to√†n h∆°n 500ms
        await new Promise(resolve => setTimeout(resolve, 100));
        // === END: THAY TH·∫æ LOGIC 500ms ===

        // === START: DEBUG LOG (v1.5) - ƒê√É B·ªä X√ìA ===
        // console.group(...)
        // debugger;
        // console.groupEnd();
        // === END: DEBUG LOG (v1.5) - ƒê√É B·ªä X√ìA ===

        try {
            const canvas = await html2canvas(captureWrapper, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#f3f4f6'
            });
    
            const link = document.createElement('a');
            link.download = `${title}_${dateString.replace(/\//g, '-')}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            ui.showNotification('ƒê√£ ch·ª•p v√† t·∫£i xu·ªëng h√¨nh ·∫£nh!', 'success');
        } catch (err) {
            console.error('L·ªói ch·ª•p m√†n h√¨nh:', err);
            ui.showNotification(`L·ªói khi ch·ª•p ·∫£nh: ${err.message}.`, 'error');
        } finally {
            if (document.body.contains(captureWrapper)) {
                document.body.removeChild(captureWrapper);
            }
            // B·∫≠t l·∫°i animation
            if (window.Chart) {
                Chart.defaults.animation = {};
            }
        }
    },
    
    async captureDashboardInParts(contentContainer, baseTitle) {
        if (!contentContainer) {
            ui.showNotification('Kh√¥ng t√¨m th·∫•y v√πng n·ªôi dung ƒë·ªÉ ch·ª•p.', 'error');
            return;
        }

        // === START: S·ª¨A L·ªñI (v1.7) ===
        // Thay th·∫ø firebase.incrementCounter b·∫±ng analyticsService.incrementCounter
        analyticsService.incrementCounter('actionsTaken', appState.currentUser?.email);
        // === END: S·ª¨A L·ªñI (v1.7) ===
        
        ui.showNotification(`B·∫Øt ƒë·∫ßu ch·ª•p b√°o c√°o ${baseTitle}...`, 'success');
    
        const captureGroups = new Map();
        contentContainer.querySelectorAll('[data-capture-group]').forEach(el => {
            if (el.offsetParent !== null) {
                const group = el.dataset.captureGroup;
                if (!captureGroups.has(group)) {
                    captureGroups.set(group, []);
                }
                captureGroups.get(group).push(el);
            }
        });
        
        const styleElement = _injectCaptureStyles();
        
        // === START: THAY TH·∫æ LOGIC 500ms (K·∫ø ho·∫°ch A) ===
        // T·∫Øt animation (v·∫´n gi·ªØ ƒë·ªÉ ph√≤ng h·ªù)
        if (window.Chart) {
            Chart.defaults.animation = false;
        }
        // Th√™m ƒë·ªô tr·ªÖ ng·∫Øn (100ms) thay v√¨ 500ms
        await new Promise(resolve => setTimeout(resolve, 100));
        // === END: THAY TH·∫æ LOGIC 500ms ===
        
        try {
            if (captureGroups.size === 0) {
                if (contentContainer.offsetParent !== null) {
                    const preset = contentContainer.dataset.capturePreset;
                    const presetClass = preset ? `preset-${preset}` : '';
                    
                    // **G·ªåI H√ÄM ƒê√É S·ª¨A (ch·ª©a logic ho√°n ƒë·ªïi canvas)**
                    await this.captureAndDownload(contentContainer, baseTitle, presetClass);
                } else {
                     ui.showNotification('Kh√¥ng t√¨m th·∫•y ƒë·ªëi t∆∞·ª£ng hi·ªÉn th·ªã ƒë·ªÉ ch·ª•p.', 'error');
                }
                return;
            }

            for (const [group, elements] of captureGroups.entries()) {
                const captureTitle = captureGroups.size > 1 ? `${baseTitle}_Nhom_${group}` : baseTitle;
                
                const targetElement = elements[0];
                const preset = targetElement.dataset.capturePreset;
                const isKpiGroup = group === 'kpi';
                
                let elementToCapture;
                let presetClass = '';

                if (isKpiGroup) {
                    presetClass = 'prepare-for-kpi-capture';
                } else if (preset) {
                    presetClass = `preset-${preset}`;
                }

                if (elements.length > 1 && !isKpiGroup) {
                    const tempContainer = document.createElement('div');
                    tempContainer.className = 'capture-layout-container';
                    elements.forEach(el => tempContainer.appendChild(el.cloneNode(true)));
                    elementToCapture = tempContainer;
                } else {
                    elementToCapture = targetElement;
                }
    
                // **G·ªåI H√ÄM ƒê√É S·ª¨A (ch·ª©a logic ho√°n ƒë·ªïi canvas)**
                await this.captureAndDownload(elementToCapture, captureTitle, presetClass);
                await new Promise(resolve => setTimeout(resolve, 150)); // Gi·ªØ ƒë·ªô tr·ªÖ gi·ªØa c√°c l·∫ßn ch·ª•p
            }
        } finally {
            styleElement.remove();
            // B·∫≠t l·∫°i animation
            if (window.Chart) {
                Chart.defaults.animation = {};
            }
        }

        ui.showNotification(`ƒê√£ ho√†n t·∫•t ch·ª•p ·∫£nh b√°o c√°o ${baseTitle}!`, 'success');
    },
};
--- END FILE: ./modules/capture.service.js ---

--- START FILE: ./modules/file-upload.service.js ---
// Version 1.0 - Initial Upload Service
// MODULE: FILE UPLOAD SERVICE
// Ch·ª©a logic ƒë·ªÉ t·∫£i file l√™n Firebase Storage v√† l·∫Øng nghe k·∫øt qu·∫£ x·ª≠ l√Ω t·ª´ Firestore.

import { appState } from '../state.js';
import { ui } from '../ui.js';
import { ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
import { doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

export const fileUploadService = {
    /**
     * T·∫£i file l√™n Firebase Storage, sau ƒë√≥ l·∫Øng nghe k·∫øt qu·∫£ x·ª≠ l√Ω t·ª´ Firestore.
     * @param {File} file - ƒê·ªëi t∆∞·ª£ng file ng∆∞·ªùi d√πng ƒë√£ ch·ªçn.
     * @param {string} fileType - Lo·∫°i file (v√≠ d·ª•: 'ycx', 'danhsachnv').
     * @returns {Promise<Object>} - Promise s·∫Ω resolve v·ªõi d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω ho·∫∑c reject v·ªõi l·ªói.
     */
    uploadAndProcessFile(file, fileType) {
        return new Promise((resolve, reject) => {
            if (!appState.storage || !appState.db) {
                return reject(new Error("Firebase ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o."));
            }

            // 1. T·∫°o m·ªôt ID ƒë·ªôc nh·∫•t cho file ƒë·ªÉ theo d√µi
            const uniqueFileId = `${fileType}-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            const fileName = `${uniqueFileId}${file.name.substring(file.name.lastIndexOf('.'))}`;
            const storagePath = `uploads/${fileName}`;
            const storageRef = ref(appState.storage, storagePath);

            // 2. B·∫Øt ƒë·∫ßu qu√° tr√¨nh t·∫£i file l√™n Storage
            const uploadTask = uploadBytesResumable(storageRef, file);
            let unsubscribeSnapshot = null; // Bi·∫øn ƒë·ªÉ l∆∞u h√†m h·ªßy listener

            // T·∫°o listener trong Firestore ƒë·ªÉ ch·ªù k·∫øt qu·∫£
            const resultDocRef = doc(appState.db, "file_results", uniqueFileId);
            unsubscribeSnapshot = onSnapshot(resultDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const result = docSnap.data();
                    // H·ªßy listener ngay khi nh·∫≠n ƒë∆∞·ª£c k·∫øt qu·∫£ ƒë·ªÉ tr√°nh r√≤ r·ªâ b·ªô nh·ªõ
                    if (unsubscribeSnapshot) unsubscribeSnapshot();
                    clearTimeout(timeout); // H·ªßy timeout

                    if (result.status === 'success') {
                        resolve(result.data); // Tr·∫£ v·ªÅ d·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω
                    } else {
                        reject(new Error(result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ m√°y ch·ªß.'));
                    }
                }
            });

            // C·∫≠p nh·∫≠t giao di·ªán v·ªõi ti·∫øn tr√¨nh t·∫£i l√™n
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    ui.updateFileStatus(fileType, file.name, `ƒêang t·∫£i l√™n... ${Math.round(progress)}%`);
                },
                (error) => { // X·ª≠ l√Ω l·ªói t·∫£i l√™n
                    if (unsubscribeSnapshot) unsubscribeSnapshot();
                    clearTimeout(timeout);
                    console.error("L·ªói khi t·∫£i file l√™n Storage:", error);
                    reject(new Error("Kh√¥ng th·ªÉ t·∫£i file l√™n m√°y ch·ªß."));
                },
                () => { // T·∫£i l√™n th√†nh c√¥ng, chuy·ªÉn sang ch·ªù x·ª≠ l√Ω
                    ui.updateFileStatus(fileType, file.name, 'T·∫£i l√™n ho√†n t·∫•t, ƒëang ch·ªù m√°y ch·ªß x·ª≠ l√Ω...');
                }
            );

            // 3. ƒê·∫∑t m·ªôt kho·∫£ng th·ªùi gian ch·ªù t·ªëi ƒëa (v√≠ d·ª•: 60 gi√¢y)
            const timeout = setTimeout(() => {
                if (unsubscribeSnapshot) unsubscribeSnapshot();
                reject(new Error("M√°y ch·ªß x·ª≠ l√Ω qu√° l√¢u, vui l√≤ng th·ª≠ l·∫°i."));
            }, 60000); // 60 gi√¢y
        });
    }
};
--- END FILE: ./modules/file-upload.service.js ---

--- START FILE: ./modules/highlight.service.js ---
// Version 1.1 - Fix incorrect import paths for modules
// MODULE: HIGHLIGHT SERVICE
// Ch·ª©a logic ƒë·ªÉ qu·∫£n l√Ω v√† √°p d·ª•ng t√≠nh nƒÉng t√¥ m√†u (highlight) tr√™n c√°c b·∫£ng.

import { appState } from '../state.js';
import { utils } from '../utils.js';

export const highlightService = {
    populateHighlightFilters(prefix, ycxData, reportData) {
        if (!appState.choices[`${prefix}_highlight_nhanhang`]) return;
        const uniqueNganhHang = [...new Set(ycxData.map(r => utils.cleanCategoryName(r.nganhHang)).filter(Boolean))].sort();
        const uniqueNhomHang = [...new Set(ycxData.map(r => utils.cleanCategoryName(r.nhomHang)).filter(Boolean))].sort();
        const uniqueEmployees = [...new Set(reportData.map(r => r.hoTen).filter(Boolean))].sort();

        const createOptions = (arr) => arr.map(item => ({ value: item, label: item, selected: false }));
        
        appState.choices[`${prefix}_highlight_nhanhang`]?.setChoices(createOptions(uniqueNganhHang), 'value', 'label', true);
        appState.choices[`${prefix}_highlight_nhomhang`]?.setChoices(createOptions(uniqueNhomHang), 'value', 'label', true);
        appState.choices[`${prefix}_highlight_employee`]?.setChoices(createOptions(uniqueEmployees), 'value', 'label', true);
    },

    applyHighlights(prefix) {
        const settings = appState.highlightSettings[prefix] || {};
        const tableContainer = document.getElementById(`${prefix === 'luyke' ? 'health' : (prefix === 'sknv' ? 'health-employee' : 'realtime')}-section`);
        if (!tableContainer) return;
        
        tableContainer.querySelectorAll('tbody tr').forEach(row => {
             row.classList.remove('highlighted-row');
             row.style.backgroundColor = '';
        });

        if (settings.values && settings.values.length > 0) {
            tableContainer.querySelectorAll('tbody tr').forEach(row => {
                const cellText = row.cells[0] ? row.cells[0].textContent : '';
                if (settings.values.includes(cellText)) {
                    row.classList.add('highlighted-row');
                    row.style.backgroundColor = settings.color;
                }
            });
        }
    },
};
--- END FILE: ./modules/highlight.service.js ---

--- START FILE: ./modules/settings.service.js ---
// Version 2.4 - Fix "undefined" label bug (use tenNganhHang not tenRutGon)
// Version 2.3 - Fix critical path error (./state.js -> ../state.js)
// Version 2.2 - Fix critical syntax errors (remove all source tags)
// Version 2.1 - Add save/load functions for dynamic pasted competition columns
// Version 2.0 - Revert loading logic to respect user-saved drag-drop order
// MODULE: SETTINGS SERVICE
// Ch·ª©a to√†n b·ªô logic li√™n quan ƒë·∫øn vi·ªác qu·∫£n l√Ω c√†i ƒë·∫∑t (l∆∞u/t·∫£i t·ª´ localStorage).

import { appState } from '../state.js';
import { ui } from '../ui.js';

// H·∫±ng s·ªë ch·ª©a danh s√°ch ƒë·∫ßy ƒë·ªß v√† th·ª© t·ª± c·ªôt ch√≠nh x√°c cho b·∫£ng Hi·ªáu qu·∫£ khai th√°c
const ALL_EFFICIENCY_ITEMS = [
    { id: 'dtICT', label: 'DT ICT' },
    { id: 'dtPhuKien', label: 'DT Ph·ª• ki·ªán' },
    { id: 'pctPhuKien', label: '% Ph·ª• ki·ªán' },
    { id: 'dtCE', label: 'DT CE' },
    { id: 'dtGiaDung', label: 'DT Gia d·ª•ng' },
    { id: 'pctGiaDung', label: '% Gia d·ª•ng' },
    { id: 'pctMLN',    label: '% MLN' },
    { id: 'pctSim',    label: '% Sim' },
    { id: 'pctVAS',    label: '% VAS' },
    { id: 'pctBaoHiem', label: '% B·∫£o hi·ªÉm' }
];

// *** NEW (v2.1) ***
const PASTED_COMPETITION_SETTINGS_KEY = 'pastedCompetitionViewSettings';


export const settingsService = {
    /**
     * L∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã cho b·∫£ng Hi·ªáu qu·∫£ khai th√°c.
     * C·∫•u tr√∫c m·ªõi l√† m·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng, m·ªói ƒë·ªëi t∆∞·ª£ng ch·ª©a {id, label, visible}.
     * @param {Array<Object>} settings - M·∫£ng c·∫•u h√¨nh c·ªôt ƒë·∫ßy ƒë·ªß.
     */
    saveEfficiencyViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try {
            localStorage.setItem('efficiencyViewSettings', JSON.stringify(settings));
        } catch (e) {
            console.error("L·ªói khi l∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã Hi·ªáu qu·∫£ khai th√°c:", e);
        }
    },
    
    /**
     * T·∫£i c√†i ƒë·∫∑t hi·ªÉn th·ªã cho b·∫£ng Hi·ªáu qu·∫£ khai th√°c.
     * Logic m·ªõi: ∆Øu ti√™n th·ª© t·ª± ƒë√£ l∆∞u c·ªßa ng∆∞·ªùi d√πng, v√† th√™m c√°c c·ªôt m·ªõi v√†o cu·ªëi.
     * @returns {Array<Object>} M·∫£ng c·∫•u h√¨nh c·ªôt ƒë·∫ßy ƒë·ªß.
     */
    loadEfficiencyViewSettings() {
        try {
            const savedSettingsJSON = localStorage.getItem('efficiencyViewSettings');
            if (savedSettingsJSON) {
                const savedItems = JSON.parse(savedSettingsJSON);
                
                // ƒê·∫£m b·∫£o d·ªØ li·ªáu l∆∞u l√† m·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng
                if (Array.isArray(savedItems) && savedItems.length > 0 && typeof savedItems[0] === 'object') {
                    const savedIds = new Set(savedItems.map(s => s.id));
                    // Th√™m c√°c c·ªôt m·ªõi (n·∫øu c√≥ trong b·∫£n c·∫≠p nh·∫≠t) m√† ng∆∞·ªùi d√πng ch∆∞a c√≥ trong c√†i ƒë·∫∑t
                    const newItems = ALL_EFFICIENCY_ITEMS
                        .filter(item => !savedIds.has(item.id))
                        .map(item => ({ ...item, visible: true }));
                    
                    // L·ªçc ra c√°c m·ª•c ƒë√£ l∆∞u m√† kh√¥ng c√≤n t·ªìn t·∫°i trong code n·ªØa
                    const currentItems = savedItems.filter(item => ALL_EFFICIENCY_ITEMS.some(config => config.id === item.id));
                    
                    return [...currentItems, ...newItems];
                }
            }
        } catch (e) {
            console.error("L·ªói khi t·∫£i c√†i ƒë·∫∑t hi·ªÉn th·ªã Hi·ªáu qu·∫£ khai th√°c:", e);
        }

        // Tr·∫£ v·ªÅ gi√° tr·ªã m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ g√¨ ƒë∆∞·ª£c l∆∞u ho·∫∑c c√≥ l·ªói
        return ALL_EFFICIENCY_ITEMS.map(item => ({ ...item, visible: true }));
    },

    saveQdcViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try {
            localStorage.setItem('qdcViewSettings', JSON.stringify(settings));
        } catch (e) {
            console.error("L·ªói khi l∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã Nh√≥m h√†ng QƒêC:", e);
        }
    },

    saveCategoryViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try {
            localStorage.setItem('categoryViewSettings', JSON.stringify(settings));
        } catch (e) {
            console.error("L·ªói khi l∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã Ng√†nh h√†ng chi ti·∫øt:", e);
        }
    },

    loadQdcViewSettings(allItems) {
        try {
            const savedSettings = localStorage.getItem('qdcViewSettings');
            if (savedSettings) {
                return JSON.parse(savedSettings);
            }
        } catch (e) {
             console.error("L·ªói khi t·∫£i c√†i ƒë·∫∑t hi·ªÉn th·ªã Nh√≥m h√†ng QƒêC:", e);
        }
        // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã t·∫•t c·∫£ n·∫øu ch∆∞a c√≥ c√†i ƒë·∫∑t
        return allItems;
    },

    loadCategoryViewSettings(allItems) {
        try {
            const savedSettings = localStorage.getItem('categoryViewSettings');
            if (savedSettings) {
                return JSON.parse(savedSettings);
            }
        } catch (e) {
            console.error("L·ªói khi t·∫£i c√†i ƒë·∫∑t hi·ªÉn th·ªã Ng√†nh h√†ng chi ti·∫øt:", e);
        }
        // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã t·∫•t c·∫£ n·∫øu ch∆∞a c√≥ c√†i ƒë·∫∑t
        return allItems;
    },
    
    loadInterfaceSettings() {
        try {
            const savedSettings = JSON.parse(localStorage.getItem('interfaceSettings')) || {};
            const defaultSettings = {
                kpiCard1Bg: '#38bdf8', kpiCard2Bg: '#34d399', kpiCard3Bg: '#fbbf24',
                kpiCard4Bg: '#2dd4bf', kpiCard5Bg: '#a78bfa', kpiCard6Bg: '#f472b6', 
                kpiCard7Bg: '#818cf8', kpiCard8Bg: '#f87171',
                kpiTitleColor: '#ffffff',
                kpiMainColor: '#ffffff',
                kpiSubColor: '#ffffff',
                 globalFontSize: '14',
                kpiFontSize: '36'
            };
            const settings = { ...defaultSettings, ...savedSettings };
            
            ui.applyInterfaceSettings(settings);
            
            // C·∫≠p nh·∫≠t gi√° tr·ªã cho c√°c b·ªô ch·ªçn m√†u
            Object.keys(defaultSettings).forEach((key) => {
                if (key.startsWith('kpiCard')) {
                    const keyNumber = key.replace('kpiCard', '').replace('Bg', '');
                    const colorPicker = document.getElementById(`kpi-color-${keyNumber}`);
                     if (colorPicker) colorPicker.value = settings[key];
                }
            });
            
            const titleColorPicker = document.getElementById('kpi-title-color');
            if(titleColorPicker) titleColorPicker.value = settings.kpiTitleColor;
            
            const mainColorPicker = document.getElementById('kpi-main-color');
            if(mainColorPicker) mainColorPicker.value = settings.kpiMainColor;

            const subColorPicker = document.getElementById('kpi-sub-color');
            if(subColorPicker) subColorPicker.value = settings.kpiSubColor;


            const globalSlider = document.getElementById('global-font-size-slider');
            const kpiSlider = document.getElementById('kpi-font-size-slider');
            if(globalSlider) globalSlider.value = settings.globalFontSize;
            if(kpiSlider) kpiSlider.value = settings.kpiFontSize;
            
            this.handleFontSizeChange({ target: globalSlider }, 'global');
            this.handleFontSizeChange({ target: kpiSlider }, 'kpi');
            
        } catch (e) { console.error("L·ªói khi t·∫£i c√†i ƒë·∫∑t giao di·ªán:", e); }
    },
    
    saveInterfaceSettings() {
        const settings = {
            kpiCard1Bg: document.getElementById('kpi-color-1')?.value,
            kpiCard2Bg: document.getElementById('kpi-color-2')?.value,
            kpiCard3Bg: document.getElementById('kpi-color-3')?.value,
            kpiCard4Bg: document.getElementById('kpi-color-4')?.value,
            kpiCard5Bg: document.getElementById('kpi-color-5')?.value,
            kpiCard6Bg: document.getElementById('kpi-color-6')?.value,
            kpiCard7Bg: document.getElementById('kpi-color-7')?.value,
            kpiCard8Bg: document.getElementById('kpi-color-8')?.value,
            kpiTitleColor: document.getElementById('kpi-title-color')?.value,
            kpiMainColor: document.getElementById('kpi-main-color')?.value,
            kpiSubColor: document.getElementById('kpi-sub-color')?.value,
            globalFontSize: document.getElementById('global-font-size-slider')?.value,
            kpiFontSize: document.getElementById('kpi-font-size-slider')?.value,
        };
        localStorage.setItem('interfaceSettings', JSON.stringify(settings));
        ui.applyInterfaceSettings(settings);
        this.applyFontSettings();
    },

    applyFontSettings() {
        const settings = JSON.parse(localStorage.getItem('interfaceSettings')) || {};
        const globalSize = settings.globalFontSize || '14';
        const kpiSize = settings.kpiFontSize || '36';
        
        document.documentElement.style.setProperty('--global-font-size', `${globalSize}px`);
        document.documentElement.style.setProperty('--kpi-main-font-size', `${kpiSize}px`);
    },

    handleFontSizeChange(event, type) {
        if (!event || !event.target) return;
        const value = event.target.value;
        const valueDisplayId = type === 'global' ? 'global-font-size-value' : 'kpi-font-size-value';
        const valueDisplayElement = document.getElementById(valueDisplayId);

        if (valueDisplayElement) {
            valueDisplayElement.textContent = `${value}px`;
        }
        
        this.saveInterfaceSettings();
    },

    saveRealtimeGoalSettings() {
        const warehouse = document.getElementById('rt-goal-warehouse-select').value;
        if (!warehouse) return;
        const settings = { goals: {}, timing: {} };
        document.querySelectorAll('.rt-goal-input').forEach(input => settings.goals[input.dataset.goal] = input.value);
        document.querySelectorAll('.rt-setting-input').forEach(input => settings.timing[input.id] = input.value);
        
        if (!appState.realtimeGoalSettings) appState.realtimeGoalSettings = {};
        appState.realtimeGoalSettings[warehouse] = settings;
        localStorage.setItem('realtimeGoalSettings', JSON.stringify(appState.realtimeGoalSettings));
        ui.showNotification(`ƒê√£ l∆∞u c√†i ƒë·∫∑t Realtime cho kho ${warehouse}!`, 'success');
    },

    loadAndApplyRealtimeGoalSettings() {
         const warehouseSelect = document.getElementById('rt-goal-warehouse-select');
        if (!warehouseSelect) return;
        const warehouse = warehouseSelect.value;
        const settings = (warehouse && appState.realtimeGoalSettings && appState.realtimeGoalSettings[warehouse]) 
            ? appState.realtimeGoalSettings[warehouse] 
            : { goals: {}, timing: {} };

        document.querySelectorAll('.rt-goal-input').forEach(input => input.value = settings.goals?.[input.dataset.goal] || '');
        document.querySelectorAll('.rt-setting-input').forEach(input => input.value = settings.timing?.[input.id] || '');
    },

    saveLuykeGoalSettings() {
        const warehouse = document.getElementById('luyke-goal-warehouse-select').value;
        if (!warehouse) return;
        const settings = {};
        document.querySelectorAll('.luyke-goal-input').forEach(input => settings[input.dataset.goal] = input.value);

        if(!appState.luykeGoalSettings) appState.luykeGoalSettings = {};
        appState.luykeGoalSettings[warehouse] = settings;
        localStorage.setItem('luykeGoalSettings', JSON.stringify(appState.luykeGoalSettings));
        ui.showNotification(`ƒê√£ l∆∞u c√†i ƒë·∫∑t m·ª•c ti√™u L≈©y k·∫ø cho kho ${warehouse}!`, 'success');
    },

    loadAndApplyLuykeGoalSettings() {
        const warehouseSelect = document.getElementById('luyke-goal-warehouse-select');
        if (!warehouseSelect) return;
        const warehouse = warehouseSelect.value;
        const settings = (warehouse && appState.luykeGoalSettings && appState.luykeGoalSettings[warehouse]) 
             ? appState.luykeGoalSettings[warehouse] 
            : {};
        document.querySelectorAll('.luyke-goal-input').forEach(input => input.value = settings[input.dataset.goal] || '');
    },

    getLuykeGoalSettings(selectedWarehouse = null) {
        const settings = { goals: {} };
        const goalKeys = ['doanhThuThuc', 'doanhThuQD', 'phanTramQD', 'phanTramTC', 'phanTramGiaDung', 'phanTramMLN', 'phanTramPhuKien', 'phanTramBaoHiem', 'phanTramSim', 'phanTramVAS'];

        if (selectedWarehouse && appState.luykeGoalSettings[selectedWarehouse]) {
             const source = appState.luykeGoalSettings[selectedWarehouse];
             goalKeys.forEach(key => settings.goals[key] = parseFloat(source[key]) || 0);
        } else if (!selectedWarehouse) {
            const allSettings = appState.luykeGoalSettings || {};
            const warehouseKeys = Object.keys(allSettings);
            const percentCounts = {};
            
            goalKeys.forEach(key => settings.goals[key] = 0);

            warehouseKeys.forEach(whKey => {
                const source = allSettings[whKey];
                 goalKeys.forEach(key => {
                    const value = parseFloat(source[key]) || 0;
                    if (key.startsWith('phanTram')) {
                        settings.goals[key] += value;
                        percentCounts[key] = (percentCounts[key] || 0) + 1;
                    } else {
                         settings.goals[key] += value;
                    }
                });
            });
            
            Object.keys(percentCounts).forEach(key => {
                if (percentCounts[key] > 0) settings.goals[key] /= percentCounts[key];
            });
        }
        return settings;
    },

    getRealtimeGoalSettings(selectedWarehouse = null) {
        if (selectedWarehouse && appState.realtimeGoalSettings && appState.realtimeGoalSettings[selectedWarehouse]) {
            return appState.realtimeGoalSettings[selectedWarehouse];
        }
        if (!selectedWarehouse) {
            const allSettings = appState.realtimeGoalSettings || {};
            const validWarehouseSettings = Object.values(allSettings).filter(s => s.goals && Object.keys(s.goals).length > 0);
            if(validWarehouseSettings.length === 0) return { goals: {}, timing: {} };
            const aggregatedGoals = { doanhThuThuc: 0, doanhThuQD: 0 };
            const percentGoals = {}; const percentCounts = {};
            validWarehouseSettings.forEach(ws => {
                aggregatedGoals.doanhThuThuc += parseFloat(ws.goals.doanhThuThuc || 0);
                aggregatedGoals.doanhThuQD += parseFloat(ws.goals.doanhThuQD || 0);
                Object.entries(ws.goals).forEach(([key, value]) => {
                    if (key.startsWith('phanTram')) {
                        if (!percentGoals[key]) { percentGoals[key] = 0; percentCounts[key] = 0; }
                         const numValue = parseFloat(value);
                        if(!isNaN(numValue)) { percentGoals[key] += numValue; percentCounts[key]++; }
                    }
                });
            });
            Object.keys(percentCounts).forEach(key => { if(percentCounts[key] > 0) aggregatedGoals[key] = percentGoals[key] / percentCounts[key]; });
            const representativeTiming = validWarehouseSettings.length > 0 ? (validWarehouseSettings[0].timing || {}) : {};
            return { goals: aggregatedGoals, timing: representativeTiming };
        }
        return { goals: {}, timing: {} };
    },

    applyContrastSetting() {
         const savedLevel = localStorage.getItem('contrastLevel') || '3';
        document.documentElement.dataset.contrast = savedLevel;
        document.querySelectorAll('.contrast-selector').forEach(sel => sel.value = savedLevel);
    },

    loadHighlightSettings() {
        try {
            const saved = localStorage.getItem('highlightSettings');
            if (saved) appState.highlightSettings = JSON.parse(saved);
        } catch(e) {
            console.error("Error loading highlight settings", e);
            appState.highlightSettings = { luyke: {}, sknv: {}, realtime: {} };
        }
    },

    // === START: NEW FUNCTIONS (v2.1) ===
    /**
     * L∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã cho b·∫£ng Thi ƒëua NV D√°n v√†o.
     * @param {Array<Object>} settings - M·∫£ng c·∫•u h√¨nh c·ªôt ƒë·∫ßy ƒë·ªß.
     */
    savePastedCompetitionViewSettings(settings) {
        if (!Array.isArray(settings)) return;
        try {
            localStorage.setItem(PASTED_COMPETITION_SETTINGS_KEY, JSON.stringify(settings));
        } catch (e) {
            console.error("L·ªói khi l∆∞u c√†i ƒë·∫∑t hi·ªÉn th·ªã Thi ƒëua NV:", e);
        }
    },

    /**
     * T·∫£i v√† h·ª£p nh·∫•t c√†i ƒë·∫∑t hi·ªÉn th·ªã cho b·∫£ng Thi ƒëua NV D√°n v√†o.
     * N√≥ l·∫•y c√°c c·ªôt t·ª´ appState (d·ªØ li·ªáu m·ªõi d√°n) v√† h·ª£p nh·∫•t v·ªõi c√†i ƒë·∫∑t ƒë√£ l∆∞u.
     * @returns {Array<Object>} M·∫£ng c·∫•u h√¨nh c·ªôt ƒë·∫ßy ƒë·ªß.
     */
    loadPastedCompetitionViewSettings() {
        // 1. L·∫•y danh s√°ch c·ªôt "master" t·ª´ appState (d·ªØ li·ªáu v·ª´a d√°n)
        if (!appState.pastedThiDuaReportData || appState.pastedThiDuaReportData.length === 0) {
            return []; // Kh√¥ng c√≥ d·ªØ li·ªáu, kh√¥ng c√≥ c·ªôt
        }
        
        const masterColumns = appState.pastedThiDuaReportData[0].competitions.map((comp, index) => ({
            id: `comp_${index}`, // ID duy nh·∫•t t·∫°m th·ªùi d·ª±a tr√™n th·ª© t·ª±
            // *** START FIX (v2.4) ***
            label: comp.tenNganhHang, // S·ª≠a l·ªói: L·∫•y tenNganhHang thay v√¨ tenRutGon
            // *** END FIX (v2.4) ***
            tenGoc: comp.tenGoc, // T√™n g·ªëc ƒë·ªÉ l√†m kh√≥a ·ªïn ƒë·ªãnh
            loaiSoLieu: comp.loaiSoLieu,
            visible: true // M·∫∑c ƒë·ªãnh l√† hi·ªÉn th·ªã
        }));
        
        const masterMap = new Map(masterColumns.map(item => [item.tenGoc, item]));

        // 2. L·∫•y c√†i ƒë·∫∑t ƒë√£ l∆∞u t·ª´ localStorage
        let savedItems = [];
        try {
            savedItems = JSON.parse(localStorage.getItem(PASTED_COMPETITION_SETTINGS_KEY) || '[]');
            if (!Array.isArray(savedItems) || (savedItems.length > 0 && typeof savedItems[0] !== 'object')) {
                savedItems = []; // Reset n·∫øu d·ªØ li·ªáu l∆∞u kh√¥ng h·ª£p l·ªá
            }
        } catch (e) {
            console.error("L·ªói khi t·∫£i c√†i ƒë·∫∑t Thi ƒëua NV:", e);
            savedItems = [];
        }

        const savedMap = new Map(savedItems.map(item => [item.tenGoc, item]));
        const finalSettings = [];

        // 3. H·ª£p nh·∫•t: ∆Øu ti√™n th·ª© t·ª± v√† tr·∫°ng th√°i 'visible' ƒë√£ l∆∞u
        
        // Th√™m c√°c c·ªôt ƒë√£ l∆∞u m√† v·∫´n c√≤n t·ªìn t·∫°i trong master list
        savedItems.forEach(savedItem => {
            if (masterMap.has(savedItem.tenGoc)) {
                const masterItem = masterMap.get(savedItem.tenGoc);
                finalSettings.push({
                    ...savedItem,
                    // C·∫≠p nh·∫≠t ID v√† Label n·∫øu t√™n r√∫t g·ªçn ƒë√£ thay ƒë·ªïi
                    id: masterItem.id, 
                    label: masterItem.label 
                });
            }
        });

        // Th√™m c√°c c·ªôt m·ªõi (ch∆∞a c√≥ trong savedItems) v√†o cu·ªëi danh s√°ch
        masterColumns.forEach(masterItem => {
            if (!savedMap.has(masterItem.tenGoc)) {
                finalSettings.push(masterItem); // M·∫∑c ƒë·ªãnh visible: true
            }
        });

        return finalSettings;
    }
    // === END: NEW FUNCTIONS (v2.1) ===
};
--- END FILE: ./modules/settings.service.js ---

--- START FILE: ./modules/storage.js ---
// Version 1.1 - Add logging for debugging
// MODULE: STORAGE
// Qu·∫£n l√Ω t·∫•t c·∫£ c√°c t∆∞∆°ng t√°c v·ªõi IndexedDB ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu c·ª•c b·ªô.

export const storage = {
    db: null,
    dbName: 'AppStorageDB',
    storeName: 'fileStore',

    openDB() {
        console.log("[storage.js openDB] Opening IndexedDB..."); // Log m·ªõi
        return new Promise((resolve, reject) => {
            if (this.db) {
                console.log("[storage.js openDB] DB already open."); // Log m·ªõi
                return resolve(this.db);
            }
            const request = indexedDB.open(this.dbName, 1);
            request.onupgradeneeded = (event) => {
                console.log("[storage.js openDB] onupgradeneeded triggered."); // Log m·ªõi
                const db = event.target.result;
                if (!db.objectStoreNames.contains(this.storeName)) {
                    console.log(`[storage.js openDB] Creating object store: ${this.storeName}`); // Log m·ªõi
                    db.createObjectStore(this.storeName, { keyPath: 'id' });
                }
            };
            request.onsuccess = (event) => {
                console.log("[storage.js openDB] Success!"); // Log m·ªõi
                this.db = event.target.result;
                resolve(this.db);
            };
            request.onerror = (event) => {
                console.error("[storage.js openDB] IndexedDB error:", event.target.errorCode, event.target.error); // Log chi ti·∫øt l·ªói
                reject(event.target.error);
            };
        });
    },

    async setItem(id, value) {
        console.log(`[storage.js setItem] Attempting to save item with id: ${id}`); // Log m·ªõi
        try {
            const db = await this.openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([this.storeName], 'readwrite');
                const store = transaction.objectStore(this.storeName);
                const request = store.put({ id, value });
                request.onsuccess = () => {
                    console.log(`[storage.js setItem] Successfully saved item with id: ${id}`); // Log m·ªõi
                    resolve();
                };
                request.onerror = (event) => {
                    console.error(`[storage.js setItem] Error saving item with id ${id}:`, event.target.error); // Log chi ti·∫øt l·ªói
                    reject(event.target.error);
                };
                 transaction.onerror = (event) => { // Log l·ªói transaction
                     console.error(`[storage.js setItem] Transaction error saving item with id ${id}:`, event.target.error);
                     reject(event.target.error);
                 };
            });
        } catch (error) {
            console.error(`[storage.js setItem] Error opening DB to save item ${id}:`, error); // Log l·ªói m·ªü DB
            throw error; // Re-throw ƒë·ªÉ main.js c√≥ th·ªÉ b·∫Øt
        }
    },

    async getItem(id) {
        console.log(`[storage.js getItem] Attempting to get item with id: ${id}`); // Log m·ªõi
        try {
            const db = await this.openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                const request = store.get(id);
                request.onsuccess = (event) => {
                    const result = event.target.result;
                    console.log(`[storage.js getItem] Successfully retrieved item for id ${id}. Found: ${!!result}`); // Log m·ªõi
                    resolve(result ? result.value : null);
                };
                request.onerror = (event) => {
                    console.error(`[storage.js getItem] Error getting item with id ${id}:`, event.target.error); // Log chi ti·∫øt l·ªói
                    reject(event.target.error);
                };
                 transaction.onerror = (event) => { // Log l·ªói transaction
                     console.error(`[storage.js getItem] Transaction error getting item with id ${id}:`, event.target.error);
                     reject(event.target.error);
                 };
            });
        } catch (error) {
             console.error(`[storage.js getItem] Error opening DB to get item ${id}:`, error); // Log l·ªói m·ªü DB
             throw error; // Re-throw
        }
    }
};
--- END FILE: ./modules/storage.js ---

--- START FILE: ./services/admin.service.js ---
// Version 1.1 - Add functions for Global Competition Configs (Firestore)
// MODULE: ADMIN SERVICE
// Ch·ªãu tr√°ch nhi·ªám x·ª≠ l√Ω logic ƒë·ªçc/ghi d·ªØ li·ªáu c·ªßa Admin (Khai b√°o, H∆∞·ªõng d·∫´n).
import { getFirestore, collection, doc, setDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { appState } from '../state.js';
import { ui } from '../ui.js';

export const adminService = {
    async saveHelpContent(contents) {
        if (!appState.db || !appState.isAdmin) return;
        ui.showNotification('ƒêang l∆∞u n·ªôi dung h∆∞·ªõng d·∫´n...', 'success');
        try {
            await Promise.all([
                setDoc(doc(appState.db, "help_content", "data"), { content: contents.data }),
                setDoc(doc(appState.db, "help_content", "luyke"), { content: contents.luyke }),
                setDoc(doc(appState.db, "help_content", "sknv"), { content: contents.sknv }),
                setDoc(doc(appState.db, "help_content", "realtime"), { content: contents.realtime })
            ]);
            ui.showNotification('ƒê√£ c·∫≠p nh·∫≠t n·ªôi dung h∆∞·ªõng d·∫´n th√†nh c√¥ng!', 'success');
        } catch (error) {
            console.error("Error saving help content:", error);
            ui.showNotification('L·ªói khi l∆∞u n·ªôi dung.', 'error');
        }
    },

    async saveCategoryDataToFirestore(data) {
        if (!appState.db || !appState.isAdmin) return;
        ui.showNotification('ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu khai b√°o l√™n cloud...', 'success');
        try {
            const categoryRef = doc(appState.db, "declarations", "categoryStructure");
            await setDoc(categoryRef, { data: data.categories || [] });
            const brandRef = doc(appState.db, "declarations", "brandList");
            await setDoc(brandRef, { data: data.brands || [] });
            ui.showNotification('ƒê·ªìng b·ªô d·ªØ li·ªáu khai b√°o th√†nh c√¥ng!', 'success');
        } catch (error) {
            console.error("L·ªói khi l∆∞u d·ªØ li·ªáu khai b√°o l√™n Firestore:", error);
            ui.showNotification('L·ªói khi ƒë·ªìng b·ªô d·ªØ li·ªáu l√™n cloud.', 'error');
        }
    },

    async loadCategoryDataFromFirestore() {
        if (!appState.db) {
             console.warn("loadCategoryDataFromFirestore called before DB initialization.");
             return { categories: [], brands: [] };
        }
        try {
            const declarationsCollection = collection(appState.db, "declarations");
            const querySnapshot = await getDocs(declarationsCollection);
            let categories = []; let brands = [];
            querySnapshot.forEach((doc) => {
                if (doc.id === "categoryStructure") categories = doc.data().data || [];
                else if (doc.id === "brandList") brands = doc.data().data || [];
            });
            console.log(`Loaded ${categories.length} categories and ${brands.length} brands from Firestore.`);
            return { categories, brands };
        } catch (error) {
            console.error("L·ªói khi t·∫£i d·ªØ li·ªáu khai b√°o t·ª´ Firestore:", error);
            return { categories: [], brands: [] };
        }
    },

    async loadDeclarationsFromFirestore() {
        if (!appState.db) {
            console.warn("loadDeclarationsFromFirestore called before DB initialization.");
            return {};
        }
        console.log("Loading calculation declarations from Firestore...");
        try {
            const declarationIds = ['hinhThucXuat', 'hinhThucXuatGop', 'heSoQuyDoi'];
            const declarations = {};
            await Promise.all(declarationIds.map(async (id) => {
                const docRef = doc(appState.db, "declarations", id);
                const docSnap = await getDoc(docRef);
                declarations[id] = docSnap.exists() ? (docSnap.data().content || '') : '';
            }));
            console.log("Successfully loaded calculation declarations.");
            return declarations;
        } catch (error) {
            console.error("L·ªói khi t·∫£i d·ªØ li·ªáu khai b√°o t√≠nh to√°n t·ª´ Firestore:", error);
            return {};
        }
    },

    async saveDeclarationsToFirestore(declarations) {
        if (!appState.db || !appState.isAdmin) return;
        ui.showNotification('ƒêang ƒë·ªìng b·ªô khai b√°o t√≠nh to√°n l√™n cloud...', 'success');
        try {
            await Promise.all([
                setDoc(doc(appState.db, "declarations", "hinhThucXuat"), { content: declarations.ycx }),
                setDoc(doc(appState.db, "declarations", "hinhThucXuatGop"), { content: declarations.ycxGop }),
                 setDoc(doc(appState.db, "declarations", "heSoQuyDoi"), { content: declarations.heSo })
            ]);
            ui.showNotification('ƒê·ªìng b·ªô khai b√°o t√≠nh to√°n th√†nh c√¥ng!', 'success');
        } catch (error) {
            console.error("L·ªói khi l∆∞u d·ªØ li·ªáu khai b√°o t√≠nh to√°n:", error);
            ui.showNotification('L·ªói khi ƒë·ªìng b·ªô khai b√°o t√≠nh to√°n.', 'error');
        }
    },

    async loadCompetitionNameMappings() {
        if (!appState.db) {
            console.warn("loadCompetitionNameMappings called before DB initialization.");
            return {};
        }
        console.log("Loading competition name mappings from Firestore...");
        try {
            const docRef = doc(appState.db, "declarations", "competitionNameMappings");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                console.log("Successfully loaded competition name mappings.");
                return docSnap.data().mappings || {};
            } else {
                console.log("No competition name mappings found in Firestore, returning empty object.");
                return {};
            }
        } catch (error) {
            console.error("L·ªói khi t·∫£i B·∫£ng √Ånh X·∫° T√™n Thi ƒêua t·ª´ Firestore:", error);
            return {};
        }
    },

    async saveCompetitionNameMappings(mappings) {
        if (!appState.db || !appState.isAdmin) {
            console.warn("Save competition name mappings skipped: Not admin or DB not initialized.");
            return;
        }
        console.log("Saving competition name mappings to Firestore...");
        try {
            const docRef = doc(appState.db, "declarations", "competitionNameMappings");
            await setDoc(docRef, { mappings: mappings });
            console.log("Successfully saved competition name mappings.");
        } catch (error) {
            console.error("L·ªói khi l∆∞u B·∫£ng √Ånh X·∫° T√™n Thi ƒêua:", error);
            ui.showNotification('L·ªói khi l∆∞u t√™n r√∫t g·ªçn l√™n cloud.', 'error');
        }
    },

    // === START REFACTOR 2 (B∆∞·ªõc 2b) ===
    async loadGlobalCompetitionConfigs() {
        if (!appState.db) {
            console.warn("loadGlobalCompetitionConfigs called before DB initialization.");
            return [];
        }
        console.log("Loading Global Competition Configs from Firestore...");
        try {
            const docRef = doc(appState.db, "declarations", "globalCompetitionConfigs");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                console.log("Successfully loaded Global Competition Configs.");
                return docSnap.data().configs || [];
            } else {
                console.log("No Global Competition Configs found in Firestore, returning empty array.");
                return [];
            }
        } catch (error) {
            console.error("L·ªói khi t·∫£i C·∫•u h√¨nh Thi ƒêua Chung t·ª´ Firestore:", error);
            return [];
        }
    },

    async saveGlobalCompetitionConfigs(configs) {
        if (!appState.db || !appState.isAdmin) {
            console.warn("Save Global Competition Configs skipped: Not admin or DB not initialized.");
            ui.showNotification('L·ªói: B·∫°n kh√¥ng c√≥ quy·ªÅn l∆∞u c·∫•u h√¨nh chung.', 'error');
            return;
        }
        console.log("Saving Global Competition Configs to Firestore...");
        try {
            const docRef = doc(appState.db, "declarations", "globalCompetitionConfigs");
            await setDoc(docRef, { configs: configs });
            console.log("Successfully saved Global Competition Configs.");
            ui.showNotification('ƒê√£ l∆∞u C·∫•u h√¨nh Thi ƒêua Chung l√™n cloud!', 'success');
        } catch (error) {
            console.error("L·ªói khi l∆∞u C·∫•u h√¨nh Thi ƒêua Chung:", error);
            ui.showNotification('L·ªói khi l∆∞u c·∫•u h√¨nh thi ƒëua chung l√™n cloud.', 'error');
        }
    },
    // === END REFACTOR 2 (B∆∞·ªõc 2b) ===

    // ========== START: H√ÄM M·ªöI CHO S·∫¢N PH·∫®M ƒê·∫∂C QUY·ªÄN ==========
    /**
     * T·∫£i danh s√°ch S·∫£n Ph·∫©m ƒê·∫∑c Quy·ªÅn (SPƒêQ) t·ª´ Firestore.
     * @returns {Promise<Array<Object>>} M·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng SPƒêQ.
     */
    async loadSpecialProductList() {
        if (!appState.db) {
            console.warn("loadSpecialProductList called before DB initialization.");
            return [];
        }
        console.log("Loading Special Product List from Firestore...");
        try {
            const docRef = doc(appState.db, "declarations", "specialProductList");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const products = docSnap.data().products || [];
                console.log(`Successfully loaded ${products.length} special products.`);
                return products;
            } else {
                console.log("No Special Product List found in Firestore, returning empty array.");
                return [];
            }
        } catch (error) {
            console.error("L·ªói khi t·∫£i Danh s√°ch SP ƒê·∫∑c Quy·ªÅn t·ª´ Firestore:", error);
            return [];
        }
    },

    /**
     * L∆∞u danh s√°ch S·∫£n Ph·∫©m ƒê·∫∑c Quy·ªÅn (SPƒêQ) l√™n Firestore.
     * @param {Array<Object>} products - M·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng SPƒêQ.
     */
    async saveSpecialProductList(products) {
        if (!appState.db || !appState.isAdmin) {
            console.warn("saveSpecialProductList skipped: Not admin or DB not initialized.");
            ui.showNotification('L·ªói: B·∫°n kh√¥ng c√≥ quy·ªÅn l∆∞u danh s√°ch SPƒêQ.', 'error');
            return;
        }
        console.log(`Saving ${products.length} special products to Firestore...`);
        try {
            const docRef = doc(appState.db, "declarations", "specialProductList");
            await setDoc(docRef, { products: products });
            console.log("Successfully saved Special Product List.");
            ui.showNotification('ƒê√£ l∆∞u Danh s√°ch SP ƒê·∫∑c Quy·ªÅn l√™n cloud!', 'success');
        } catch (error) {
            console.error("L·ªói khi l∆∞u Danh s√°ch SP ƒê·∫∑c Quy·ªÅn:", error);
            ui.showNotification('L·ªói khi l∆∞u danh s√°ch SPƒêQ l√™n cloud.', 'error');
        }
    },

    /**
     * T·∫£i C·∫•u h√¨nh Ch∆∞∆°ng tr√¨nh SP ƒê·∫∑c Quy·ªÅn t·ª´ Firestore.
     * @returns {Promise<Array<Object>>} M·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng c·∫•u h√¨nh.
     */
    async loadGlobalSpecialPrograms() {
        if (!appState.db) {
            console.warn("loadGlobalSpecialPrograms called before DB initialization.");
            return [];
        }
        console.log("Loading Global Special Programs from Firestore...");
        try {
            const docRef = doc(appState.db, "declarations", "globalSpecialPrograms");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const programs = docSnap.data().programs || [];
                console.log(`Successfully loaded ${programs.length} global special programs.`);
                return programs;
            } else {
                console.log("No Global Special Programs found in Firestore, returning empty array.");
                return [];
            }
        } catch (error) {
            console.error("L·ªói khi t·∫£i C·∫•u h√¨nh Ch∆∞∆°ng tr√¨nh SPƒêQ t·ª´ Firestore:", error);
            return [];
        }
    },

    /**
     * L∆∞u C·∫•u h√¨nh Ch∆∞∆°ng tr√¨nh SP ƒê·∫∑c Quy·ªÅn l√™n Firestore.
     * @param {Array<Object>} programs - M·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng c·∫•u h√¨nh.
     */
    async saveGlobalSpecialPrograms(programs) {
        if (!appState.db || !appState.isAdmin) {
            console.warn("saveGlobalSpecialPrograms skipped: Not admin or DB not initialized.");
            ui.showNotification('L·ªói: B·∫°n kh√¥ng c√≥ quy·ªÅn l∆∞u c·∫•u h√¨nh SPƒêQ.', 'error');
            return;
        }
        console.log("Saving Global Special Programs to Firestore...");
        try {
            const docRef = doc(appState.db, "declarations", "globalSpecialPrograms");
            await setDoc(docRef, { programs: programs });
            console.log("Successfully saved Global Special Programs.");
            ui.showNotification('ƒê√£ l∆∞u C·∫•u h√¨nh Ch∆∞∆°ng tr√¨nh SPƒêQ l√™n cloud!', 'success');
        } catch (error) {
            console.error("L·ªói khi l∆∞u C·∫•u h√¨nh Ch∆∞∆°ng tr√¨nh SPƒêQ:", error);
            ui.showNotification('L·ªói khi l∆∞u c·∫•u h√¨nh SPƒêQ l√™n cloud.', 'error');
        }
    }
    // ========== END: H√ÄM M·ªöI CHO S·∫¢N PH·∫®M ƒê·∫∂C QUY·ªÄN ==========
};
--- END FILE: ./services/admin.service.js ---

--- START FILE: ./services/analytics.service.js ---
// Version 1.0 - Initial service extraction
// MODULE: ANALYTICS SERVICE
// Ch·ªãu tr√°ch nhi·ªám x·ª≠ l√Ω logic th·ªëng k√™, ng∆∞·ªùi d√πng v√† ph√¢n t√≠ch.
import { getFirestore, collection, doc, setDoc, increment, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { appState } from '../state.js';
import { ui } from '../ui.js';

export const analyticsService = {
    /**
     * TƒÉng gi√° tr·ªã m·ªôt tr∆∞·ªùng s·ªë trong Firestore.
     * N·∫øu fieldName l√† 'actionsTaken' v√† c√≥ email, tƒÉng b·ªô ƒë·∫øm cho user ƒë√≥.
     * Ng∆∞·ª£c l·∫°i, tƒÉng b·ªô ƒë·∫øm global trong 'analytics/site_stats'.
     * @param {string} fieldName T√™n tr∆∞·ªùng c·∫ßn tƒÉng (vd: 'pageLoads', 'actionsTaken').
     * @param {string} [email=null] Email c·ªßa ng∆∞·ªùi d√πng (ch·ªâ d√πng cho actionsTaken).
     */
    async incrementCounter(fieldName, email = null) {
        if (!appState.db || !fieldName) return;

        let docRef;
        const dataToUpdate = { [fieldName]: increment(1) };

        // ** Logic: Ki·ªÉm tra n·∫øu l√† actionsTaken v√† c√≥ email **
        if (fieldName === 'actionsTaken' && email) {
            docRef = doc(appState.db, "users", email);
            console.log(`Incrementing actionsTaken for user: ${email}`);
        } else if (fieldName === 'actionsTaken' && !email) {
            // N·∫øu l√† actionsTaken nh∆∞ng kh√¥ng c√≥ email (d·ª± ph√≤ng), v·∫´n tƒÉng global
            docRef = doc(appState.db, "analytics", "site_stats");
            console.log("Incrementing global actionsTaken (email not provided).");
        } else {
            // C√°c tr∆∞·ªùng h·ª£p kh√°c (vd: pageLoads) tƒÉng global
            docRef = doc(appState.db, "analytics", "site_stats");
            console.log(`Incrementing global counter: ${fieldName}`);
        }

        try {
            await setDoc(docRef, dataToUpdate, { merge: true });
        } catch (error) {
            console.error(`L·ªói khi tƒÉng b·ªô ƒë·∫øm cho '${fieldName}' t·∫°i ${docRef.path}:`, error);
        }
    },

    async upsertUserRecord(email) {
        if (!appState.db || !email) return;
        if (!appState.auth?.currentUser) { console.warn("Attempted to upsert user record before auth is ready."); return; }
        const userRef = doc(appState.db, "users", email);
        try {
            // Ch·ªâ tƒÉng loginCount, kh√¥ng reset actionsTaken ·ªü ƒë√¢y
            await setDoc(userRef, {
                email: email,
                lastLogin: serverTimestamp(),
                loginCount: increment(1)
            }, { merge: true });
            console.log(`User record for ${email} updated successfully (loginCount incremented).`);
        } catch (error) { console.error("Error upserting user record:", error); }
    },

    /**
     * L·∫•y danh s√°ch t·∫•t c·∫£ ng∆∞·ªùi d√πng v√† th√¥ng tin c·ªßa h·ªç t·ª´ Firestore.
     * Bao g·ªìm c·∫£ tr∆∞·ªùng 'actionsTaken'.
     * @returns {Promise<Array<Object>>} M·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng ng∆∞·ªùi d√πng.
     */
    async getAllUsers() {
        if (!appState.db || !appState.isAdmin) {
            ui.showNotification("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p ch·ª©c nƒÉng n√†y.", "error");
            return [];
        }
        try {
            const usersCollection = collection(appState.db, "users");
            const querySnapshot = await getDocs(usersCollection);
            const users = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                users.push({
                    email: data.email,
                    loginCount: data.loginCount || 0,
                    lastLogin: data.lastLogin?.toDate(),
                    actionsTaken: data.actionsTaken || 0 // L·∫•y th√™m actionsTaken
                });
            });
            console.log(`Loaded ${users.length} users from Firestore.`);
            return users;
        } catch (error) {
            console.error("L·ªói khi l·∫•y danh s√°ch ng∆∞·ªùi d√πng:", error);
            ui.showNotification("Kh√¥ng th·ªÉ t·∫£i danh s√°ch ng∆∞·ªùi d√πng.", "error");
            return [];
        }
    }
};
--- END FILE: ./services/analytics.service.js ---

--- START FILE: ./services/collaboration.service.js ---
// Version 1.0 - Initial service extraction
// MODULE: COLLABORATION SERVICE
// Ch·ªãu tr√°ch nhi·ªám x·ª≠ l√Ω logic G√≥p √Ω v√† Ph·∫£n h·ªìi.
import { getFirestore, collection, addDoc, doc, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { appState } from '../state.js';
import { ui } from '../ui.js';

export const collaborationService = {
    async submitFeedback(content) {
        if (!content || !appState.db || !appState.currentUser) {
             ui.showNotification("Kh√¥ng th·ªÉ g·ª≠i g√≥p √Ω: Ng∆∞·ªùi d√πng ch∆∞a ƒë∆∞·ª£c x√°c th·ª±c.", "error");
            return;
        }
        try {
            await addDoc(collection(appState.db, "feedback"), {
                user: { email: appState.currentUser.email },
                content: content, timestamp: serverTimestamp(), replies: []
            });
            ui.showNotification("G√≥p √Ω c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i!", "success");
            return true;
        } catch (error) {
            console.error("Error adding feedback: ", error);
            ui.showNotification("L·ªói khi g·ª≠i g√≥p √Ω.", "error");
            return false;
        }
    },

    async submitReply(docId, content) {
        if (!docId || !content || !appState.db) return false;
        try {
            const feedbackRef = doc(appState.db, "feedback", docId);
            await updateDoc(feedbackRef, { replies: arrayUnion({ content: content, timestamp: new Date() }) });
            return true;
        } catch (error) {
            console.error("Error submitting reply:", error);
            ui.showNotification("L·ªói khi g·ª≠i tr·∫£ l·ªùi.", "error");
            return false;
        }
    },
};
--- END FILE: ./services/collaboration.service.js ---

--- START FILE: ./services/data-processing.js ---
// Version 3.6 - Fix: G·ªôp nhi·ªÅu d√≤ng cho ti√™u ƒë·ªÅ ch√≠nh (main headers) trong parsePastedThiDuaTableData
// Version 3.5 - Update processThiDuaVungFile to accept new sheet names
// Version 3.4 - Fix processThiDuaNhanVienData for 1-column logic & Fix ReferenceError
// Version 3.2 - Fix ReferenceError in parsePastedThiDuaTableData
// Version 3.1 - Fix parsePastedThiDuaTableData to filter out "T·ªïng" and "BP" rows
// Version 3.0 - Th√™m logic ph√¢n t√≠ch v√† √°nh x·∫° t√™n thi ƒëua
// Version 2.0 - Read declarations from appState instead of localStorage
// MODULE: SERVICES - DATA PROCESSING
// Ch·ª©a c√°c h√†m x·ª≠ l√Ω, chu·∫©n h√≥a, v√† ph√¢n t√≠ch c√∫ ph√°p d·ªØ li·ªáu th√¥.

import { config } from '../config.js';
import { appState } from '../state.js';
import { utils } from '../utils.js';

export const dataProcessing = {
    /**
     * Ph√¢n t√≠ch m·ªôt t·∫≠p d·ªØ li·ªáu YCX th√¥ ƒë·ªÉ g·ª° l·ªói c√°c ƒëi·ªÅu ki·ªán l·ªçc thi ƒëua.
     * @param {Array} rawTestData - D·ªØ li·ªáu YCX th√¥ t·ª´ file ng∆∞·ªùi d√πng t·∫£i l√™n.
     * @returns {Array} - M·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng, m·ªói ƒë·ªëi t∆∞·ª£ng ch·ª©a d·ªØ li·ªáu h√†ng v√† k·∫øt qu·∫£ c·ªßa t·ª´ng b∆∞·ªõc ki·ªÉm tra.
     */
    debugCompetitionFiltering(rawTestData) {
        if (!rawTestData || rawTestData.length === 0) {
            return [];
        }

        const { normalizedData } = this.normalizeData(rawTestData, 'ycx');
        if (normalizedData.length === 0) {
            return [];
        }

        const hinhThucXuatTinhDoanhThu = this.getHinhThucXuatTinhDoanhThu();

        const debugResults = normalizedData.map(row => {
            const checks = {
                isDoanhThuHTX: hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat),
                isThuTien: (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu',
                isChuaHuy: (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy',
                isChuaTra: (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£',
                isDaXuat: (row.trangThaiXuat || "").trim() === 'ƒê√£ xu·∫•t'
            };

            const isOverallValid = checks.isDoanhThuHTX && checks.isThuTien && checks.isChuaHuy && checks.isChuaTra && checks.isDaXuat;

            return {
                rowData: row,
                checks: checks,
                isOverallValid: isOverallValid
            };
        });

        return debugResults;
    },

    normalizeCategoryStructureData(rawData) {
        if (!rawData || rawData.length === 0) {
            return { success: false, error: 'File r·ªóng.', normalizedData: [] };
        }
        const header = Object.keys(rawData[0] || {});

        const nganhHangCol = this.findColumnName(header, ['ng√†nh h√†ng', 'nganh hang']);
        const nhomHangCol = this.findColumnName(header, ['nh√≥m h√†ng', 'nhom hang']);

        if (!nganhHangCol || !nhomHangCol) {
            return { success: false, error: 'File ph·∫£i c√≥ c·ªôt "Ng√†nh h√†ng" v√† "Nh√≥m h√†ng".', normalizedData: [] };
        }

        const normalizedData = rawData
            .map(row => ({
                nganhHang: String(row[nganhHangCol] || '').trim(),
                nhomHang: String(row[nhomHangCol] || '').trim(),
            }))
            .filter(item => item.nganhHang && item.nhomHang);

        return { success: true, normalizedData };
    },

    // ========== START: H√ÄM M·ªöI CHO SPƒêQ ==========
    /**
     * Chu·∫©n h√≥a d·ªØ li·ªáu t·ª´ file S·∫£n Ph·∫©m ƒê·∫∑c Quy·ªÅn.
     * Y√™u c·∫ßu c√°c c·ªôt: "M√£ s·∫£n ph·∫©m", "Nh√≥m h√†ng", "T√™n s·∫£n ph·∫©m".
     * @param {Array<Object>} rawData - D·ªØ li·ªáu th√¥ t·ª´ file Excel.
     * @returns {Object} - { success, normalizedData, error? }
     */
    normalizeSpecialProductData(rawData) {
        if (!rawData || rawData.length === 0) {
            return { success: false, error: 'File r·ªóng.', normalizedData: [] };
        }
        const header = Object.keys(rawData[0] || {});

        const maSpCol = this.findColumnName(header, ['m√£ s·∫£n ph·∫©m', 'masanpham', 'm√£ sp', 'product code']);
        const nhomHangCol = this.findColumnName(header, ['nh√≥m h√†ng', 'nhom hang']);
        const tenSpCol = this.findColumnName(header, ['t√™n s·∫£n ph·∫©m', 'tensanpham', 't√™n sp']);

        const missingColumns = [];
        if (!maSpCol) missingColumns.push('M√£ s·∫£n ph·∫©m');
        if (!nhomHangCol) missingColumns.push('Nh√≥m h√†ng');
        if (!tenSpCol) missingColumns.push('T√™n s·∫£n ph·∫©m');

        if (missingColumns.length > 0) {
            return { success: false, error: `File thi·∫øu c√°c c·ªôt b·∫Øt bu·ªôc: ${missingColumns.join(', ')}.`, normalizedData: [] };
        }

        const normalizedData = rawData
            .map(row => ({
                // ƒê·∫£m b·∫£o M√£ s·∫£n ph·∫©m lu√¥n l√† string ƒë·ªÉ tr√°nh l·ªói ƒë·ªãnh d·∫°ng khoa h·ªçc (VD: 1.23E+10)
                maSanPham: String(row[maSpCol] || '').trim(),
                nhomHang: String(row[nhomHangCol] || '').trim(),
                tenSanPham: String(row[tenSpCol] || '').trim(),
            }))
            .filter(item => item.maSanPham && item.nhomHang && item.tenSanPham); // L·ªçc b·ªè c√°c d√≤ng tr·ªëng

        return { success: true, normalizedData };
    },
    // ========== END: H√ÄM M·ªöI ==========

    normalizeBrandData(rawData) {
        if (!rawData || rawData.length === 0) {
            return { success: false, error: 'Sheet "H√£ng" r·ªóng.', normalizedData: [] };
        }
        const header = Object.keys(rawData[0] || {});
        const brandCol = this.findColumnName(header, ['h√£ng', 't√™n h√£ng', 'nh√† s·∫£n xu·∫•t']);
        if (!brandCol) {
            return { success: false, error: 'Sheet "H√£ng" ph·∫£i c√≥ c·ªôt "H√£ng" ho·∫∑c "T√™n H√£ng".', normalizedData: [] };
        }

        const normalizedData = rawData
            .map(row => String(row[brandCol] || '').trim())
            .filter(brand => brand);

        return { success: true, normalizedData: [...new Set(normalizedData)].sort() };
    },

    // === START: C·∫¨P NH·∫¨T LOGIC ƒê·ªåC KHAI B√ÅO ===
    getHinhThucXuatTinhDoanhThu: () => {
        const declarationData = appState.declarations.hinhThucXuat;
        if (declarationData) return new Set(declarationData.split('\n').map(l => l.trim()).filter(Boolean));
        return new Set(config.DEFAULT_DATA.HINH_THUC_XUAT_TINH_DOANH_THU);
    },

    getHinhThucXuatTraGop: () => {
        const declarationData = appState.declarations.hinhThucXuatGop;
        if (declarationData) return new Set(declarationData.split('\n').map(l => l.trim()).filter(Boolean));
        return new Set(config.DEFAULT_DATA.HINH_THUC_XUAT_TRA_GOP);
    },

    getHeSoQuyDoi: () => {
        const declarationData = appState.declarations.heSoQuyDoi;
        const heSoMap = {};
        if (declarationData) {
            declarationData.split('\n').filter(l => l.trim()).forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const key = parts[0].trim();
                    const value = parseFloat(parts[1].trim());
                    if (key && !isNaN(value)) heSoMap[key] = value;
                }
            });
            return Object.keys(heSoMap).length > 0 ? heSoMap : config.DEFAULT_DATA.HE_SO_QUY_DOI;
        }
        return config.DEFAULT_DATA.HE_SO_QUY_DOI;
    },
    // === END: C·∫¨P NH·∫¨T LOGIC ƒê·ªåC KHAI B√ÅO ===

    findColumnName(header, aliases) {
        for (const colName of header) {
            const processedColName = String(colName || '').trim().toLowerCase();
            if (aliases.includes(processedColName)) {
                return colName;
            }
        }
        return null;
    },

    normalizeData(rawData, fileType) {
        const mapping = config.COLUMN_MAPPINGS[fileType];
        if (!mapping) {
            console.error(`No column mapping found for fileType: ${fileType}`);
            return { normalizedData: [], success: false, missingColumns: ['Unknown mapping'] };
        }

        if (!rawData || rawData.length === 0) {
            return { normalizedData: [], success: true, missingColumns: [] };
        }

        const header = Object.keys(rawData[0] || {});
        const foundMapping = {};
        let allRequiredFound = true;
        const missingColumns = [];

        appState.debugInfo[fileType] = { required: [], found: header, firstFiveMsnv: [] };

        for (const key in mapping) {
            const { required, displayName, aliases } = mapping[key];
            const foundName = this.findColumnName(header, aliases);
            foundMapping[key] = foundName;

            if (required) {
                const status = !!foundName;
                appState.debugInfo[fileType].required.push({ displayName, foundName: foundName || 'Kh√¥ng t√¨m th·∫•y', status: status });
                if (!status) {
                    allRequiredFound = false;
                    missingColumns.push(displayName);
                }
            }
        }

        if (fileType === 'giocong' || fileType === 'thuongnong') {
            if (!foundMapping.maNV && !foundMapping.hoTen) {
                allRequiredFound = false;
                const missingMsg = 'M√£ NV ho·∫∑c T√™n NV';
                missingColumns.push(missingMsg);
                if (!appState.debugInfo[fileType].required.some(r => r.displayName.includes('NV'))) {
                     appState.debugInfo[fileType].required.push({ displayName: missingMsg, foundName: 'Kh√¥ng t√¨m th·∫•y', status: false });
                }
            }
        }

        if (!allRequiredFound) {
            return { normalizedData: [], success: false, missingColumns };
        }

        const normalizedData = rawData.map(row => {
            const newRow = {};
            for (const key in foundMapping) {
                if (foundMapping[key]) {
                    if (key === 'maNV' || key === 'hoTen') {
                        newRow[key] = String(row[foundMapping[key]] || '').trim();
                    // ========== START: ƒêI·ªÄU CH·ªàNH LOGIC ƒê·ªåC M√É SP ==========
                    // ƒê·∫£m b·∫£o maSanPham lu√¥n l√† string
                    } else if (key === 'maSanPham') {
                        newRow[key] = String(row[foundMapping[key]] || '').trim();
                    // ========== END: ƒêI·ªÄU CH·ªàNH LOGIC ƒê·ªåC M√É SP ==========
                    } else if ((key === 'ngayTao' || key === 'ngayHenGiao') && row[foundMapping[key]]) {
                        const dateValue = row[foundMapping[key]];
                        if (dateValue instanceof Date) {
                            newRow[key] = dateValue;
                        } else if (typeof dateValue === 'number') {
                            newRow[key] = new Date(Math.round((dateValue - 25569) * 86400 * 1000));
                        } else if (typeof dateValue === 'string') {
                            const parsedDate = new Date(dateValue.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$2/$1/$3'));
                            if (!isNaN(parsedDate)) newRow[key] = parsedDate;
                        }
                    }
                    else {
                        newRow[key] = row[foundMapping[key]];
                    }
                }
            }
            return newRow;
        });

        if (fileType === 'giocong') {
            appState.rawGioCongData = rawData.map(row => {
                const newRow = {};
                for (const key in foundMapping) {
                    if (foundMapping[key]) newRow[key] = row[foundMapping[key]];
                }
                return newRow;
            });
        }

        appState.debugInfo[fileType].firstFiveMsnv = normalizedData.slice(0, 5).map(r => r.maNV).filter(Boolean);

        return { normalizedData, success: true, missingColumns: [] };
    },

    processThuongERP: (pastedText) => {
        if (!pastedText || !pastedText.trim()) return [];
        const lines = pastedText.trim().split('\n');
        const results = [];
        const regex = /(ƒêML_|TGD|ƒêMM|ƒêMS).*?(BP .*?)(?:Nh√¢n Vi√™n|Tr∆∞·ªüng Ca)(.*?)([\d,]+)$/;
        lines.forEach(line => {
            const match = line.replace(/\s+/g, ' ').match(regex);
            if (match) results.push({ name: match[3].trim(), bonus: match[4].trim() });
        });
        return results;
    },

    parseLuyKePastedData: (text) => {
        const defaults = {
            mainKpis: {},
            comparisonData: { value: 0, percentage: 'N/A' },
            luotKhachData: { value: 0, percentage: 'N/A' },
            dtDuKien: 0,
            dtqdDuKien: 0,
        };
        if (!text) return defaults;

        const allLines = text.split('\n').map(line => line.trim());
        const textContent = allLines.join(' ');

        const patterns = {
            'Th·ª±c hi·ªán DT th·ª±c': /DTLK\s+([\d,.]+)/,
            'Th·ª±c hi·ªán DTQƒê': /DTQƒê\s+([\d,.]+)/,
            '% HT Target D·ª± Ki·∫øn (Qƒê)': /% HT Target D·ª± Ki·∫øn \(Qƒê\)\s+([\d.]+%?)/,
            'T·ª∑ Tr·ªçng Tr·∫£ G√≥p': /T·ª∑ Tr·ªçng Tr·∫£ G√≥p\s+([\d.]+%?)/,
        };

        for (const [key, regex] of Object.entries(patterns)) {
            const match = textContent.match(regex);
            if (match && match[1]) {
                defaults.mainKpis[key] = match[1];
            }
        }

        const findValueAfterKeyword = (lines, keyword, isQd = false) => {
            let keywordRegex;
            if (isQd) {
                keywordRegex = new RegExp(keyword.replace('(', '\\(').replace(')', '\\)'));
            } else {
                keywordRegex = new RegExp(`^${keyword}$`);
            }

            const index = lines.findIndex(line => keywordRegex.test(line) && !/l∆∞·ª£t kh√°ch/i.test(line));
            if (index !== -1 && index + 1 < lines.length) {
                return parseFloat(lines[index + 1].replace(/,/g, '')) || 0;
            }
            return 0;
        };

        defaults.dtDuKien = findValueAfterKeyword(allLines, "DT D·ª± Ki·∫øn");
        defaults.dtqdDuKien = findValueAfterKeyword(allLines, "DT D·ª± Ki·∫øn (Qƒê)", true);

        const dtckIndex = allLines.findIndex(line => line.includes('DTCK Th√°ng'));
        if (dtckIndex !== -1 && dtckIndex + 1 < allLines.length) {
            const valueLine = allLines[dtckIndex + 1];
            const values = valueLine.split(/\s+/);
            if (values.length >= 2) {
                defaults.comparisonData = {
                    value: parseFloat(values[0].replace(/,/g, '')) || 0,
                    percentage: values[1] || 'N/A'
                };
            }
        }

        const luotKhachIndex = allLines.findIndex(line => line.includes('L∆∞·ª£t Kh√°ch CK Th√°ng'));
        if (luotKhachIndex !== -1 && luotKhachIndex + 1 < allLines.length) {
            const valueLine = allLines[luotKhachIndex + 1];
            const values = valueLine.split(/\s+/);
            if (values.length >= 2) {
                defaults.luotKhachData = {
                    value: parseFloat(values[0].replace(/,/g, '')) || 0,
                    percentage: values[1] || 'N/A'
                };
            }
        }

        return defaults;
    },

    parseCompetitionDataFromLuyKe: (text) => {
        if (!text || !text.trim()) return [];
        const lines = text.split('\n').map(l => l.trim());
        const results = [];
        let currentCompetition = null;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (line.toLowerCase().startsWith('thi ƒëua')) {
                if (currentCompetition) results.push(currentCompetition);
                currentCompetition = {
                    name: line.replace("Thi ƒëua doanh thu", "DT").replace("Thi ƒëua s·ªë l∆∞·ª£ng", "SL"),
                    type: line.toLowerCase().includes('doanh thu') ? 'doanhThu' : 'soLuong',
                    luyKe: 0, target: 0, hoanThanh: '0%'
                };
            } else if (currentCompetition) {
                if (line.startsWith('DTLK') || line.startsWith('SLLK') || line.startsWith('DTQƒê')) {
                    if (i + 1 < lines.length) {
                        currentCompetition.luyKe = parseFloat(lines[i + 1].replace(/,/g, '')) || 0;
                    }
                } else if (line.startsWith('Target')) {
                    if (i + 1 < lines.length) {
                        currentCompetition.target = parseFloat(lines[i + 1].replace(/,/g, '')) || 0;
                    }
                } else if (line.startsWith('% HT D·ª± Ki·∫øn')) {
                    if (i + 1 < lines.length) {
                        currentCompetition.hoanThanh = lines[i + 1] || '0%';
                    }
                }
            }
        }
        if (currentCompetition) results.push(currentCompetition);

        appState.competitionData = results;
        return results;
    },

    /**
     * C·∫≠p nh·∫≠t B·∫£ng √Ånh X·∫° T√™n Thi ƒêua trong appState v√† Cloud.
     * @param {Array<string>} mainHeaders - Danh s√°ch t√™n g·ªëc c·ªßa c√°c ch∆∞∆°ng tr√¨nh thi ƒëua.
     */
    updateCompetitionNameMappings(mainHeaders) {
        if (!mainHeaders || mainHeaders.length === 0) return;

        // T·∫£i mappings M·ªöI NH·∫§T t·ª´ appState (ƒë√£ ƒë∆∞·ª£c t·∫£i t·ª´ Cloud khi init)
        const oldMappings = appState.competitionNameMappings || {};
        const newMappings = { ...oldMappings }; // Sao ch√©p ƒë·ªÉ tr√°nh ghi ƒë√®
        let hasChanges = false;

        mainHeaders.forEach(originalName => {
            // Ch·ªâ th√™m n·∫øu t√™n n√†y ch∆∞a t·ªìn t·∫°i
            if (!newMappings.hasOwnProperty(originalName)) {
                newMappings[originalName] = ''; // Th√™m t√™n m·ªõi v·ªõi gi√° tr·ªã r·ªóng
                hasChanges = true;
            }
        });

        // Ch·ªâ l∆∞u l√™n Cloud n·∫øu c√≥ t√™n m·ªõi ƒë∆∞·ª£c th√™m v√†o
        if (hasChanges) {
            appState.competitionNameMappings = newMappings;
            // Kh√¥ng l∆∞u localStorage n·ªØa, h√†m g·ªçi (listeners-settings) s·∫Ω x·ª≠ l√Ω vi·ªác l∆∞u cloud
            console.log("Ph√°t hi·ªán t√™n thi ƒëua m·ªõi, B·∫£ng √Ånh X·∫° ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong appState.");
        }
    },

    /**
     * @private
     * H√†m d·ªçn d·∫πp t√™n ch∆∞∆°ng tr√¨nh thi ƒëua ƒë·ªÉ so kh·ªõp.
     */
    _cleanCompetitionName(name) {
        return name.replace(/thi ƒëua doanh thu b√°n h√†ng|thi ƒëua doanh thu|thi ƒëua s·ªë l∆∞·ª£ng/gi, "").trim();
    },

    // *** START: H√ÄM ƒê∆Ø·ª¢C VI·∫æT L·∫†I (v3.4) - S·ª≠a l·ªói logic 1 c·ªôt ***
    /**
     * X·ª≠ l√Ω d·ªØ li·ªáu thi ƒëua nh√¢n vi√™n ƒë√£ ƒë∆∞·ª£c ph√¢n t√≠ch c√∫ ph√°p.
     * @param {Object} parsedData - ƒê·ªëi t∆∞·ª£ng tr·∫£ v·ªÅ t·ª´ `parsePastedThiDuaTableData` ({ mainHeaders, subHeaders, dataRows }).
     * @param {Array} luykeCompetitionData - D·ªØ li·ªáu m·ª•c ti√™u thi ƒëua t·ª´ `parseCompetitionDataFromLuyKe`.
     * @returns {Array} - M·∫£ng d·ªØ li·ªáu b√°o c√°o thi ƒëua ƒë√£ ƒë∆∞·ª£c chu·∫©n h√≥a.
     */
    processThiDuaNhanVienData(parsedData, luykeCompetitionData) {
        const { mainHeaders, subHeaders, dataRows } = parsedData;
        
        const debugInfo = { required: [], found: [], status: 'ƒêang x·ª≠ l√Ω...' };
        appState.debugInfo['thiduanv-pasted'] = debugInfo;

        if (appState.danhSachNhanVien.length === 0) {
            debugInfo.status = 'L·ªói: Danh s√°ch nh√¢n vi√™n (DSNV) ch∆∞a ƒë∆∞·ª£c t·∫£i l√™n.';
            return [];
        }
        if (mainHeaders.length === 0 || dataRows.length === 0 || subHeaders.length === 0) {
            debugInfo.status = 'L·ªói: D·ªØ li·ªáu d√°n v√†o kh√¥ng h·ª£p l·ªá, kh√¥ng t√¨m th·∫•y ti√™u ƒë·ªÅ ho·∫∑c d√≤ng d·ªØ li·ªáu.';
            return [];
        }

        // T·∫£i b·∫£ng √°nh x·∫° t√™n r√∫t g·ªçn (ƒë√£ ƒë∆∞·ª£c t·∫£i t·ª´ Cloud)
        const nameMappings = appState.competitionNameMappings || {};
        
        // T·∫°o map m·ª•c ti√™u t·ª´ d·ªØ li·ªáu l≈©y k·∫ø
        const competitionTargets = (luykeCompetitionData || []).map(comp => ({
            ...comp,
            cleanedName: this._cleanCompetitionName(comp.name)
        }));
        
        const finalReport = [];
        const totalEmployeesInDSNV = appState.danhSachNhanVien.length; // Ch·ªâ ƒë·∫øm 1 l·∫ßn

        dataRows.forEach(row => {
            // B∆∞·ªõc 3.1: Tr√≠ch xu·∫•t MSNV t·ª´ "Nguy·ªÖn V≈© Linh - 3031"
            const nameParts = row.name.split(' - ');
            const msnv = nameParts.length > 1 ? nameParts[nameParts.length - 1].trim() : null;

            let employee;
            if (msnv) {
                // B∆∞·ªõc 3.2: Tra c·ª©u DSNV
                employee = appState.employeeMaNVMap.get(msnv);
            }

            // N·∫øu kh√¥ng t√¨m th·∫•y, t·∫°o m·ªôt ƒë·ªëi t∆∞·ª£ng t·∫°m
            if (!employee) {
                employee = { 
                    hoTen: row.name, 
                    maNV: msnv || 'N/A', 
                    boPhan: 'Nh√¢n vi√™n kh√¥ng t√¨m th·∫•y' 
                };
            }

            const employeeResult = {
                maNV: employee.maNV,
                hoTen: employee.hoTen,
                boPhan: employee.boPhan,
                completedCount: 0,
                totalCompetitions: mainHeaders.length, // S·ªë l∆∞·ª£ng ch∆∞∆°ng tr√¨nh
                competitions: [] // M·∫£ng ch·ª©a d·ªØ li·ªáu c·ªßa t·ª´ng ch∆∞∆°ng tr√¨nh
            };

            // L·∫∑p qua T·∫§T C·∫¢ c√°c c·ªôt (v√¨ mainHeaders v√† subHeaders c√≥ c√πng ƒë·ªô d√†i)
            // Gi·∫£ ƒë·ªãnh mainHeaders.length === subHeaders.length
            for (let i = 0; i < mainHeaders.length; i++) {
                const originalName = mainHeaders[i];
                const loaiSoLieu = subHeaders[i]; // "DTLK", "SLLK", "DTQƒê"
                
                // B∆∞·ªõc 5.1: Tra c·ª©u t√™n r√∫t g·ªçn
                const shortName = nameMappings[originalName] || originalName;
                
                // Logic t√≠nh to√°n m·ª•c ti√™u (target)
                const cleanedName = this._cleanCompetitionName(originalName);
                const matchedTarget = competitionTargets.find(t => t.cleanedName === cleanedName);
                const groupTarget = matchedTarget ? matchedTarget.target : 0;
                const individualTarget = totalEmployeesInDSNV > 0 ? groupTarget / totalEmployeesInDSNV : 0;

                // B∆∞·ªõc 3.3: L·∫•y GI√Å TR·ªä TH·ª∞C T·∫æ (ch·ªâ 1 gi√° tr·ªã)
                const giaTri = parseFloat(String(row.values[i] || '0').replace(/,/g, '')) || 0;
                const actualSales = giaTri; // actualSales ch√≠nh l√† giaTri

                const percentExpected = individualTarget > 0 ? actualSales / individualTarget : (actualSales > 0 ? Infinity : 0);

                if (percentExpected >= 1) {
                    employeeResult.completedCount++;
                }

                // L∆∞u ƒë·ªëi t∆∞·ª£ng m·ªõi v·ªõi c·∫•u tr√∫c 1 c·ªôt
                employeeResult.competitions.push({
                    tenNganhHang: shortName, // T√™n r√∫t g·ªçn
                    tenGoc: originalName,    // T√™n g·ªëc
                    loaiSoLieu: loaiSoLieu,  // Lo·∫°i d·ªØ li·ªáu (DTLK, SLLK, DTQƒê)
                    giaTri: giaTri,        // Gi√° tr·ªã
                    
                    // C√°c tr∆∞·ªùng c≈© ƒë·ªÉ so s√°nh (n·∫øu c·∫ßn)
                    thucHien: actualSales,
                    mucTieu: individualTarget,
                    percentExpected: percentExpected,
                });
            }

            employeeResult.completionRate = employeeResult.totalCompetitions > 0 ? employeeResult.completedCount / employeeResult.totalCompetitions : 0;
            finalReport.push(employeeResult);
        });

        debugInfo.status = `Th√†nh c√¥ng: ƒê√£ x·ª≠ l√Ω b√°o c√°o cho ${finalReport.length} nh√¢n vi√™n.`;
        return finalReport;
    },
    // *** END: H√ÄM ƒê∆Ø·ª¢C VI·∫æT L·∫†I (v3.4) ***

    // *** START: H√ÄM ƒê∆Ø·ª¢C VI·∫æT L·∫†I (v3.2) - S·ª≠a l·ªói ReferenceError ***
    /**
     * Ph√¢n t√≠ch c√∫ ph√°p d·ªØ li·ªáu th√¥ t·ª´ √¥ d√°n "Thi ƒëua nh√¢n vi√™n".
     * @param {string} rawText - VƒÉn b·∫£n th√¥ t·ª´ textarea.
     * @returns {Object} - { success, mainHeaders, subHeaders, dataRows, error? }
     */
    parsePastedThiDuaTableData(rawText) {
        const debugInfo = { required: [], found: [], status: 'B·∫Øt ƒë·∫ßu ph√¢n t√≠ch...' };
        appState.debugInfo['thiduanv-pasted'] = debugInfo;

        if (!rawText || !rawText.trim()) {
            debugInfo.status = 'L·ªói: D·ªØ li·ªáu d√°n v√†o r·ªóng.';
            return { success: false, error: debugInfo.status, mainHeaders: [], subHeaders: [], dataRows: [] };
        }

        // B∆∞·ªõc 0: Ti·ªÅn x·ª≠ l√Ω (L√†m s·∫°ch d·ªØ li·ªáu th√¥)
        const lines = rawText.split('\n')
            .map(line => line.trim())
            .filter(line => line.length > 0);

        // --- C√°c h·∫±ng s·ªë Regex ---
        const splitRegex = /\s{2,}|\t/; // T√°ch b·∫±ng 2+ d·∫•u c√°ch HO·∫∂C 1 d·∫•u tab
        const numberCheckRegex = /^-?[\d,.]+$/; // Ki·ªÉm tra l√† s·ªë

        // --- T√¨m c√°c "M·ªè neo" (Anchors) ---
        const mainHeaderStartIndex = lines.findIndex(line => line.includes('Ph√≤ng ban'));
        const subHeaderStartIndex = lines.findIndex(line => line.startsWith('DTLK') || line.startsWith('SLLK') || line.startsWith('DTQƒê'));
        
        let dataEndIndex = lines.findIndex(line => line.includes('H·ªó tr·ª£ BI'));
        if (dataEndIndex === -1) {
            dataEndIndex = lines.length; // N·∫øu kh√¥ng t√¨m th·∫•y footer, l·∫•y h·∫øt
        }

        // *** (LOGIC S·ª¨A L·ªñI v3.2) ***
        // T√¨m ƒëi·ªÉm b·∫Øt ƒë·∫ßu c·ªßa d·ªØ li·ªáu (d√≤ng ƒë·∫ßu ti√™n SAU ti√™u ƒë·ªÅ ph·ª•)
        // Ph·∫£i t√¨m tr∆∞·ªõc khi c·∫Øt m·∫£ng Ti√™u ƒë·ªÅ ph·ª•
        const dataRowsStartIndex = lines.findIndex((line, index) => {
            if (index <= subHeaderStartIndex) return false; // Ph·∫£i ·ªü SAU d√≤ng sub-header ƒë·∫ßu ti√™n
            
            const parts = line.split(splitRegex).map(p => p.trim());
            const firstPart = parts[0] || "";

            // B·ªè qua n·∫øu l√† d√≤ng t·ªïng, d√≤ng b·ªô ph·∫≠n, ho·∫∑c d√≤ng sub-header b·ªã ng·∫Øt
            if (firstPart.startsWith('T·ªïng') || firstPart.startsWith('BP ') || firstPart.startsWith('DTLK') || firstPart.startsWith('SLLK') || firstPart.startsWith('DTQƒê')) {
                return false;
            }
            
            // ƒê√¢y l√† d√≤ng d·ªØ li·ªáu N·∫æU n√≥ c√≥ > 1 ph·∫ßn T·ª¨ V√Ä ph·∫ßn t·ª≠ th·ª© 2 l√† s·ªë
            return parts.length > 1 && numberCheckRegex.test(parts[1]);
        });
        // *** (K·∫æT TH√öC LOGIC S·ª¨A L·ªñI v3.2) ***

        // --- Ki·ªÉm tra M·ªè neo ---
        if (mainHeaderStartIndex === -1 || subHeaderStartIndex === -1 || dataRowsStartIndex === -1) {
            let error = `L·ªói: Kh√¥ng th·ªÉ t√¨m th·∫•y m·ªè neo. 'Ph√≤ng ban': ${mainHeaderStartIndex !== -1}. 'SLLK/DTLK': ${subHeaderStartIndex !== -1}. 'D√≤ng d·ªØ li·ªáu ƒë·∫ßu ti√™n': ${dataRowsStartIndex !== -1}.`;
            debugInfo.status = error;
            return { success: false, error: error, mainHeaders: [], subHeaders: [], dataRows: [] };
        }
        
        // B∆∞·ªõc 1: Tr√≠ch xu·∫•t Ti√™u ƒê·ªÅ Ch√≠nh (Main Headers)
        // === START: S·ª¨A L·ªñI (v3.6) - G·ªôp nhi·ªÅu d√≤ng cho ti√™u ƒë·ªÅ ch√≠nh ===
        const mainHeaderLines = lines.slice(mainHeaderStartIndex + 1, subHeaderStartIndex);
        const mainHeaderString = mainHeaderLines.join('\t'); // N·ªëi b·∫±ng Tab (gi·ªëng sub-header)
        const mainHeaders = mainHeaderString.split(splitRegex).filter(Boolean); // T√°ch b·∫±ng regex (gi·ªëng sub-header)
        // === END: S·ª¨A L·ªñI (v3.6) ===
        debugInfo.found.push({ name: 'Ti√™u ƒë·ªÅ ch√≠nh (Ng√†nh h√†ng)', value: `${mainHeaders.length} m·ª•c`, status: mainHeaders.length > 0 });

        // B∆∞·ªõc 2: Tr√≠ch xu·∫•t Ti√™u ƒê·ªÅ Ph·ª• (Sub Headers)
        // L·∫•y T·∫§T C·∫¢ c√°c d√≤ng ti√™u ƒë·ªÅ ph·ª• (t·ª´ d√≤ng sub-header ƒë·∫ßu ti√™n ƒë·∫øn tr∆∞·ªõc d√≤ng data ƒë·∫ßu ti√™n)
        const subHeaderLines = lines.slice(subHeaderStartIndex, dataRowsStartIndex);
        const subHeaderString = subHeaderLines.join('\t'); // N·ªëi b·∫±ng Tab
        const subHeaders = subHeaderString.split(/\s+/).filter(Boolean);
        debugInfo.found.push({ name: 'Ti√™u ƒë·ªÅ ph·ª• (SLLK/DTQƒê)', value: `${subHeaders.length} m·ª•c`, status: subHeaders.length > 0 });

        // B∆∞·ªõc 3: Tr√≠ch xu·∫•t D·ªØ Li·ªáu Nh√¢n Vi√™n (Data Rows)
        const potentialDataLines = lines.slice(dataRowsStartIndex, dataEndIndex);
        const dataRows = [];
        
        for (const line of potentialDataLines) {
            const parts = line.split(splitRegex).map(p => p.trim());
            const firstPart = parts[0] || "";

            // *** QUY T·∫ÆC L·ªåC (v3.1) ***
            // B·ªè qua c√°c d√≤ng t·ªïng v√† d√≤ng t√≥m t·∫Øt b·ªô ph·∫≠n
            if (firstPart.startsWith('T·ªïng') || firstPart.startsWith('BP ')) {
                continue;
            }
            // *** K·∫æT TH√öC QUY T·∫ÆC L·ªåC ***

            // √Åp d·ª•ng "Quy t·∫Øc ki·ªÉm tra" (Ki·ªÉm tra l·∫°i ƒë·ªÉ ch·∫Øc ch·∫Øn)
            if (parts.length > 1 && numberCheckRegex.test(parts[1])) {
                dataRows.push({
                    name: firstPart,
                    values: parts.slice(1)
                });
            }
        }
        debugInfo.found.push({ name: 'D√≤ng d·ªØ li·ªáu nh√¢n vi√™n', value: `${dataRows.length} d√≤ng`, status: dataRows.length > 0 });

        if (mainHeaders.length === 0 || subHeaders.length === 0 || dataRows.length === 0) {
            debugInfo.status = 'L·ªói: Kh√¥ng th·ªÉ ph√¢n t√≠ch d·ªØ li·ªáu. Thi·∫øu Ti√™u ƒë·ªÅ ch√≠nh, Ti√™u ƒë·ªÅ ph·ª•, ho·∫∑c D√≤ng d·ªØ li·ªáu (sau khi l·ªçc).';
            return { success: false, error: debugInfo.status, mainHeaders, subHeaders, dataRows };
        }
        
        // Ki·ªÉm tra t√≠nh to√†n v·∫πn d·ªØ li·ªáu
        const expectedDataCols = subHeaders.length;
        if (dataRows.length > 0 && dataRows[0].values.length !== expectedDataCols) {
             console.warn(`[parsePastedThiDua] C·∫£nh b√°o: S·ªë c·ªôt ti√™u ƒë·ªÅ ph·ª• (${expectedDataCols}) kh√¥ng kh·ªõp v·ªõi s·ªë c·ªôt d·ªØ li·ªáu (${dataRows[0].values.length}). D·ªØ li·ªáu c√≥ th·ªÉ b·ªã l·ªách.`);
             debugInfo.status = `C·∫£nh b√°o: S·ªë c·ªôt kh√¥ng kh·ªõp! Ti√™u ƒë·ªÅ ph·ª• (${expectedDataCols}) vs D·ªØ li·ªáu (${dataRows[0].values.length}).`;
             // Kh√¥ng th·∫•t b·∫°i, nh∆∞ng c·∫£nh b√°o
        } else {
            debugInfo.status = `Ph√¢n t√≠ch th√†nh c√¥ng.`;
        }

        return { success: true, mainHeaders, subHeaders, dataRows };
    },
    // *** END: H√ÄM ƒê∆Ø·ª¢C VI·∫æT L·∫†I (v3.2) ***

    classifyInsurance: (productName) => {
        if (!productName || typeof productName !== 'string') return null;
        const name = productName.trim().toLowerCase();
        if (name.includes('b·∫£o h√†nh m·ªü r·ªông')) return 'BHMR';
        if (name.includes('1 ƒë·ªïi 1')) return 'BH1d1';
        if (name.includes('kho·∫£n vay')) return 'BHKV';
        if (name.includes('r∆°i v·ª°')) return 'BHRV';
        if (name.includes('samsung care+')) return 'BHSC';
        if (name.includes('√¥ t√¥') || name.includes('v·∫≠t ch·∫•t √¥ t√¥')) return 'BHOTO';
        if (name.includes('xe m√°y') || name.includes('xe moto')) return 'BHXM';
        if (name.includes('x√£ h·ªôi') || name.includes('y t·∫ø')) return 'BHYT';
        return null;
    },

    processGioCongData: () => {
        const gioCongByMSNV = {};
        let currentMaNV = null;

        if (!appState.rawGioCongData || appState.rawGioCongData.length === 0) return gioCongByMSNV;

        for (const row of appState.rawGioCongData) {
            const maNV = String(row.maNV || '').trim();
            const hoTen = String(row.hoTen || '').trim().replace(/\s+/g, ' ');
            let foundMaNV = maNV || appState.employeeNameToMaNVMap.get(hoTen.toLowerCase()) || null;
            if (foundMaNV) currentMaNV = foundMaNV;

            if (currentMaNV && gioCongByMSNV[currentMaNV] === undefined) {
                gioCongByMSNV[currentMaNV] = 0;
            }

            const gioCongValue = parseFloat(String(row.tongGioCong || '0').replace(/,/g, '')) || 0;
            if (currentMaNV && gioCongValue > 0) {
                gioCongByMSNV[currentMaNV] += gioCongValue;
            }
        }
        return gioCongByMSNV;
    },

    _findHeaderAndProcess(sheet, requiredKeywords) {
        if (!sheet) return [];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
        if (rows.length === 0) return [];

        let headerRowIndex = -1;
        let foundHeaders = [];

        for (let i = 0; i < Math.min(rows.length, 10); i++) {
            const row = rows[i];
            const lowerCaseRow = row.map(cell => String(cell || '').trim().toLowerCase());

            const allKeywordsFound = requiredKeywords.every(keyword =>
                lowerCaseRow.some(cell => cell.includes(keyword))
            );

            if (allKeywordsFound) {
                headerRowIndex = i;
                foundHeaders = rows[i].map(cell => String(cell || '').trim());
                break;
            }
        }

        if (headerRowIndex === -1) {
            throw new Error(`Kh√¥ng t√¨m th·∫•y d√≤ng ti√™u ƒë·ªÅ ch·ª©a ƒë·ªß c√°c t·ª´ kh√≥a: ${requiredKeywords.join(', ')}.`);
        }

        const dataRows = rows.slice(headerRowIndex + 1);
        const jsonData = dataRows.map(row => {
            const obj = {};
            foundHeaders.forEach((header, index) => {
                if (header) {
                    const value = row[index];
                    const upperKey = header.toUpperCase();
                    if (upperKey.includes('K√äNH') || upperKey.includes('SI√äU TH·ªä') || upperKey.includes('NG√ÄNH H√ÄNG') || upperKey.includes('T·ªàNH') || upperKey.includes('BOSS')) {
                        obj[header] = value;
                    } else if (typeof value === 'string' && value.includes('%')) {
                        obj[header] = parseFloat(value.replace(/%|,/g, '')) / 100 || 0;
                    } else if (value !== null && value !== undefined) {
                        obj[header] = parseFloat(String(value).replace(/,/g, '')) || 0;
                    } else {
                        obj[header] = 0;
                    }
                }
            });
            return obj;
        }).filter(obj => {
            const supermarketKey = Object.keys(obj).find(k => k.toLowerCase().includes('si√™u th·ªã'));
            return supermarketKey && obj[supermarketKey];
        });

        return jsonData;
    },

    processThiDuaVungFile(workbook) {
        const sheetNames = workbook.SheetNames;
        // *** START: Y√äU C·∫¶U M·ªöI (v3.5) ***
        // T√¨m sheet chi ti·∫øt (CHITIET ho·∫∑c CHI TI·∫æT)
        const chiTietSheetName = sheetNames.find(name => {
            const upperName = name.toUpperCase();
            return upperName.includes('CHITIET') || upperName.includes('CHI TI·∫æT');
        });
        
        // T√¨m sheet t·ªïng (TONG ho·∫∑c SIEU THI)
        const tongSheetName = sheetNames.find(name => {
            const upperName = name.toUpperCase();
            return upperName.includes('TONG') || upperName.includes('SIEU THI');
        });

        const chiTietSheet = chiTietSheetName ? workbook.Sheets[chiTietSheetName] : null;
        const tongSheet = tongSheetName ? workbook.Sheets[tongSheetName] : null;

        if (!chiTietSheet || !tongSheet) {
            throw new Error('File Excel ph·∫£i ch·ª©a sheet (CHITIET/CHI TI·∫æT) v√† (TONG/SIEU THI).');
        }
        // *** END: Y√äU C·∫¶U M·ªöI (v3.5) ***

        const chiTietData = this._findHeaderAndProcess(chiTietSheet, ['si√™u th·ªã', 'ng√†nh h√†ng', 'k√™nh']);
        const tongData = this._findHeaderAndProcess(tongSheet, ['si√™u th·ªã', 't·ªïng th∆∞·ªüng']);

        return { chiTietData, tongData };
    },
};
--- END FILE: ./services/data-processing.js ---

--- START FILE: ./services/data.service.js ---
// Version 1.10 - Fix critical 404 import path error
import { appState } from '../state.js';
import { ui } from '../ui.js';
import { services } from '../services.js'; 
// import { firebase } from '../firebase.js'; // ƒê√É X√ìA
import { settingsService } from '../modules/settings.service.js'; // <<< ƒê√É S·ª¨A L·ªñI
// === START: T√ÅI C·∫§U TR√öC (RE-WIRING) IMPORTS ===
import { analyticsService } from './analytics.service.js';
import { storageService } from './storage.service.js';
import { datasyncService } from './datasync.service.js';
import { adminService } from './admin.service.js';
// === END: T√ÅI C·∫§U TR√öC (RE-WIRING) IMPORTS ===

// --- CONSTANTS ---
const LOCAL_DATA_VERSIONS_KEY = '_localDataVersions';
const LOCAL_METADATA_PREFIX = '_localMetadata_';
const LOCAL_DSNV_FILENAME_KEY = '_localDsnvFilename';
const RAW_PASTE_THIDUANV_KEY = 'raw_paste_thiduanv';

export const dataService = {
    appController: null, // S·∫Ω ƒë∆∞·ª£c set b·ªüi main.js

    /**
     * Kh·ªüi t·∫°o service, nh·∫≠n controller ch√≠nh ƒë·ªÉ truy c·∫≠p c√°c th√†nh ph·∫ßn kh√°c
     * @param {object} controller - ƒê·ªëi t∆∞·ª£ng 'app' t·ª´ main.js
     */
    init(controller) {
        this.appController = controller;
    },

    // --- H√ÄM HELPER (T·ª™ MAIN.JS) ---
    /**
     * ƒê·ªçc file Excel/CSV b·∫±ng FileReader v√† XLSX.
     * (ƒê√£ di chuy·ªÉn t·ª´ main.js)
     */
    async _handleFileRead(file) {
        return new Promise((resolve, reject) => {
            if (!file) return reject(new Error("No file provided."));
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    // === START: S·ª¨A L·ªñI (V·∫•n ƒë·ªÅ 2 - Logic D·ªØ li·ªáu) ===
                    // Th√™m 'cellText: true' ƒë·ªÉ ƒë·ªçc M√£ SP d∆∞·ªõi d·∫°ng chu·ªói,
                    // tr√°nh b·ªã chuy·ªÉn th√†nh s·ªë khoa h·ªçc (E+10)
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellText: true });
                    // === END: S·ª¨A L·ªñI ===
                    resolve(workbook);
                } catch (err) { reject(err); }
            };
            reader.onerror = (err) => reject(new Error("Could not read the file: " + err));
            reader.readAsArrayBuffer(file);
        });
    },

    /**
     * L·∫•y metadata ƒë√£ l∆∞u t·ª´ localStorage.
     * (ƒê√£ di chuy·ªÉn t·ª´ main.js)
     */
    _getSavedMetadata(warehouse, dataType) {
        const metadataKey = `${LOCAL_METADATA_PREFIX}${warehouse}_${dataType}`;
        try {
            const storedMetadata = localStorage.getItem(metadataKey);
            return storedMetadata ? JSON.parse(storedMetadata) : null;
        } catch (e) {
            console.error(`Error reading metadata ${metadataKey} from localStorage:`, e);
            return null;
        }
    },

    // --- H√ÄM T·∫¢I FILE (T·ª™ UI-LISTENERS.JS) ---
    /**
     * X·ª≠ l√Ω logic khi ng∆∞·ªùi d√πng ch·ªçn file (tr·ª´ DSNV v√† c√°c file ƒë·∫∑c bi·ªát).
     * Bao g·ªìm: ƒë·ªçc, chu·∫©n h√≥a, l∆∞u cache, v√† ƒë·ªìng b·ªô cloud.
     * (ƒê√£ di chuy·ªÉn t·ª´ ui-listeners.js)
     */
    async handleFileUpload(e) {
        const fileInput = e.target;
        const file = fileInput.files[0];
        if (!file) {
            const fileType = fileInput.id.replace('file-', '');
            const mappingInfo = this.appController?.ALL_DATA_MAPPING
                ? Object.values(this.appController.ALL_DATA_MAPPING).find(m => m.uiId === fileType)
                : null;
            if (mappingInfo && mappingInfo.uiId) {
                ui.updateFileStatus(mappingInfo.uiId, '', 'Ch∆∞a th√™m file', 'default');
            }
            return;
        }

        const fileType = fileInput.id.replace('file-', '');
        const mappingInfo = this.appController?.ALL_DATA_MAPPING
            ? Object.values(this.appController.ALL_DATA_MAPPING).find(m => m.uiId === fileType)
            : null;

        if (!mappingInfo) {
            if (fileType === 'danhsachnv') {
                return this.handleDsnvUpload(e, file);
            }
            console.error(`[handleFileUpload] No mapping info found for fileType: ${fileType}`);
            ui.updateFileStatus(fileType, file.name, `L·ªói: Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh cho lo·∫°i file '${fileType}'.`, 'error');
            return;
        }

        const { stateKey, saveKey, firestoreKey } = mappingInfo;
        const dataName = fileInput.dataset.name || fileType;

        ui.updateFileStatus(fileType, file.name, 'ƒêang ƒë·ªçc & chu·∫©n h√≥a...', 'default');
        ui.showProgressBar(fileType);

        try {
            const workbook = await this._handleFileRead(file);
            // === START: S·ª¨A L·ªñI (V·∫•n ƒë·ªÅ 2 - Logic D·ªØ li·ªáu) ===
            // Th√™m { raw: false } ƒë·ªÉ s·ª≠ d·ª•ng cellText ƒë√£ ƒë·ªçc
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false, defval: null });
            // === END: S·ª¨A L·ªñI ===
            const normalizeType = fileType.replace('-thangtruoc', '');
            const { normalizedData, success, missingColumns } = services.normalizeData(rawData, normalizeType);
            ui.displayDebugInfo(fileType);

            if (!success) {
                const errorMessage = `L·ªói file "${dataName}": Thi·∫øu c·ªôt: ${missingColumns.join(', ')}.`;
                ui.updateFileStatus(fileType, file.name, `L·ªói: Thi·∫øu c·ªôt d·ªØ li·ªáu.`, 'error');
                ui.showNotification(errorMessage, 'error');
                if (document.getElementById('debug-tool-container')?.classList.contains('hidden')) {
                     document.getElementById('toggle-debug-btn')?.click();
                }
                 fileInput.value = '';
                return;
            }

            if (appState.currentUser?.email) {
                 // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
                analyticsService.incrementCounter('actionsTaken', appState.currentUser.email);
                 // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
                 console.log(`Incremented actionsTaken for ${appState.currentUser.email}`);
            } else {
                 // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
                 analyticsService.incrementCounter('actionsTaken'); // Fallback if email somehow isn't available
                 // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
                 console.warn("User email not found in appState, incrementing global actionsTaken.");
            }

            appState[stateKey] = normalizedData;
            ui.showNotification(`T·∫£i th√†nh c√¥ng file "${dataName}"!`, 'success');

            if (saveKey) {
                console.log(`[handleFileUpload] Saving normalized data (${normalizedData.length} rows) to cache: ${saveKey}`);
                await this.appController.storage.setItem(saveKey, normalizedData);
                console.log(`%c[DEBUG POST-CACHE] Successfully saved ${fileType} to cache. Proceeding...`, "color: brown;");
            }

            const warehouseToSync = appState.selectedWarehouse;
            const currentFirestoreKey = firestoreKey;

            // === START: KH√îI PH·ª§C LOG G·ªêC (v1.6) ===
            console.log(`%c[DEBUG PRE-SYNC CHECK] File Type: ${fileType}, Warehouse: ${warehouseToSync}, Firestore Key: ${currentFirestoreKey}`, "color: purple; font-weight: bold;");
            // === END: KH√îI PH·ª§C LOG G·ªêC ===

            if (warehouseToSync && currentFirestoreKey) {
                console.log(`%c[DEBUG SYNC BLOCK START] Entering cloud sync block for ${fileType} (Firestore Key: ${currentFirestoreKey})`, "color: magenta;");

                ui.updateFileStatus(fileType, file.name, `ƒêang chu·∫©n b·ªã ƒë·ªìng b·ªô cloud...`, 'default');

                let localDataVersions = this.appController._localDataVersions;
                const currentVersion = localDataVersions?.[warehouseToSync]?.[currentFirestoreKey]?.version || 0;
                const newVersion = currentVersion + 1;
                const uploadTimestamp = Date.now();

                const fileExtension = file.name.substring(file.name.lastIndexOf('.'));
                const storagePath = `uploads/${warehouseToSync}/${currentFirestoreKey}_v${newVersion}${fileExtension}`;

                console.log(`%c[handleFileUpload] Cloud Upload for ${currentFirestoreKey}:`, "color: magenta; font-weight: bold;");

                const onProgress = (progress) => {
                    ui.updateFileStatus(fileType, file.name, `ƒêang t·∫£i l√™n cloud... ${Math.round(progress)}%`, 'default');
                };

                try {
                    // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
                    const downloadURL = await storageService.uploadFileToStorage(file, storagePath, onProgress);
                    // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
                    ui.updateFileStatus(fileType, file.name, `Upload xong, ƒëang l∆∞u th√¥ng tin...`, 'default');

                    const metadata = {
                        storagePath: storagePath,
                        downloadURL: downloadURL,
                        version: newVersion,
                        timestamp: uploadTimestamp,
                        rowCount: normalizedData.length,
                        fileName: file.name
                    };

                    // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
                    await datasyncService.saveMetadataToFirestore(warehouseToSync, currentFirestoreKey, metadata);
                    // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===

                    const metadataKey = `${LOCAL_METADATA_PREFIX}${warehouseToSync}_${currentFirestoreKey}`;
                    const metadataToSaveLocally = { ...metadata, updatedAt: new Date() };
                    try {
                        localStorage.setItem(metadataKey, JSON.stringify(metadataToSaveLocally));
                        console.log(`[handleFileUpload] Saved metadata for ${currentFirestoreKey} to localStorage ('${metadataKey}') immediately.`);
                    } catch (lsError) {
                        console.error(`[handleFileUpload] Error saving metadata for ${currentFirestoreKey} to localStorage:`, lsError);
                    }

                    if (!localDataVersions[warehouseToSync]) localDataVersions[warehouseToSync] = {};
                    localDataVersions[warehouseToSync][currentFirestoreKey] = { version: newVersion, timestamp: uploadTimestamp };
                    localStorage.setItem(LOCAL_DATA_VERSIONS_KEY, JSON.stringify(localDataVersions));
                    this.appController._localDataVersions = localDataVersions;

                    console.log(`%c[handleFileUpload] Successfully uploaded ${currentFirestoreKey} (v${newVersion}).`, "color: magenta;");

                    ui.updateFileStatus(fileType, file.name, '', 'success', false, metadataToSaveLocally);

                } catch (syncError) {
                    console.error(`%c[handleFileUpload] Cloud sync failed for ${currentFirestoreKey}:`, "color: red;", syncError);
                    ui.updateFileStatus(fileType, file.name, `L·ªói ƒë·ªìng b·ªô cloud: ${syncError.message}`, 'error');
                }
                console.log(`%c[DEBUG SYNC BLOCK END] Finished cloud sync block for ${fileType}`, "color: magenta;");
            } else {
                 console.log(`%c[DEBUG SYNC SKIP] Skipping cloud sync for ${fileType}. Warehouse selected: ${!!warehouseToSync}, Firestore key exists: ${!!currentFirestoreKey}`, "color: orange;");
                ui.updateFileStatus(fileType, file.name, `‚úì ƒê√£ t·∫£i ${normalizedData.length} d√≤ng (Ch∆∞a ƒë·ªìng b·ªô).`, 'success', false, null);
            }

            console.log(`%c[DEBUG PRE-RENDER] About to call updateAndRenderCurrentTab for ${fileType}`, "color: blue;");
            this.appController.updateAndRenderCurrentTab();

        } catch (error) {
            console.error(`L·ªói x·ª≠ l√Ω file ${dataName}:`, error);
            ui.updateFileStatus(fileType, file.name, `L·ªói ƒë·ªçc file: ${error.message}`, 'error');
            ui.showNotification(`L·ªói khi x·ª≠ l√Ω file "${dataName}".`, 'error');
        } finally {
            ui.hideProgressBar(fileType);
            fileInput.value = '';
            console.log(`%c[DEBUG FUNCTION END] handleFileUpload finished for ${fileType}`, "color: gray;");
        }
    },

    // --- C√ÅC H√ÄM T·ª™ MAIN.JS ---

    /**
     * X·ª≠ l√Ω t·∫£i l√™n file Danh s√°ch nh√¢n vi√™n.
     * (ƒê√£ di chuy·ªÉn t·ª´ main.js)
     */
    async handleDsnvUpload(e, file) {
        const fileType = 'danhsachnv';
        const dataName = 'Danh s√°ch nh√¢n vi√™n';
        const stateKey = 'danhSachNhanVien';
        const saveKey = 'saved_danhsachnv';

        ui.updateFileStatus(fileType, file.name, 'ƒêang ƒë·ªçc & chu·∫©n h√≥a...', 'default');
        ui.showProgressBar(fileType);

        try {
            const workbook = await this._handleFileRead(file);
            // === START: S·ª¨A L·ªñI (V·∫•n ƒë·ªÅ 2 - Logic D·ªØ li·ªáu) ===
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false, defval: null });
            // === END: S·ª¨A L·ªñI ===
            const { normalizedData, success, missingColumns } = services.normalizeData(rawData, fileType);
            ui.displayDebugInfo(fileType);

            if (!success) {
                const errorMessage = `L·ªói file "${dataName}": Thi·∫øu c·ªôt: ${missingColumns.join(', ')}.`;
                ui.updateFileStatus(fileType, file.name, `L·ªói: Thi·∫øu c·ªôt d·ªØ li·ªáu.`, 'error');
                ui.showNotification(errorMessage, 'error');
                if (document.getElementById('debug-tool-container')?.classList.contains('hidden')) {
                    document.getElementById('toggle-debug-btn')?.click();
                }
                return;
            }

            appState[stateKey] = normalizedData;
            services.updateEmployeeMaps();
            ui.populateAllFilters();
            ui.populateWarehouseSelector();

            try {
                localStorage.setItem(LOCAL_DSNV_FILENAME_KEY, file.name);
                console.log(`[handleDsnvUpload] Saved DSNV filename '${file.name}' to localStorage.`);
            } catch (lsError) {
                console.error("[handleDsnvUpload] Error saving DSNV filename to localStorage:", lsError);
            }

            ui.showNotification(`T·∫£i th√†nh c√¥ng file "${dataName}"!`, 'success');

            if (saveKey) {
                console.log(`[handleDsnvUpload] Saving normalized data (${normalizedData.length} rows) to cache: ${saveKey}`);
                await this.appController.storage.setItem(saveKey, normalizedData);
            }

            ui.updateFileStatus(fileType, file.name, `‚úì ƒê√£ t·∫£i ${normalizedData.length} d√≤ng.`, 'success', false, null);
            this.appController.updateAndRenderCurrentTab();

        } catch (error) {
            console.error(`L·ªói x·ª≠ l√Ω file ${dataName}:`, error);
            ui.updateFileStatus(fileType, file.name, `L·ªói ƒë·ªçc file: ${error.message}`, 'error');
            ui.showNotification(`L·ªói khi x·ª≠ l√Ω file "${dataName}".`, 'error');
        } finally {
            ui.hideProgressBar(fileType);
            if(e.target) e.target.value = ''; // Th√™m ki·ªÉm tra e.target
        }
    },

    /**
     * X·ª≠ l√Ω d·ªØ li·ªáu m·ªõi nh·∫≠n t·ª´ listener Firestore.
     * (ƒê√£ di chuy·ªÉn t·ª´ main.js)
     */
    async handleCloudDataUpdate(cloudData) {
        const receivedTime = new Date().toLocaleTimeString();
        console.log(`%c[handleCloudDataUpdate @ ${receivedTime}] Received data snapshot from Firestore listener:`, "color: blue; font-weight: bold;", JSON.stringify(cloudData).substring(0, 500) + "...");
        let showSyncNotification = false;
        const currentWarehouse = appState.selectedWarehouse;
        if (!currentWarehouse) {
            console.warn(`[handleCloudDataUpdate @ ${receivedTime}] Received update but no warehouse selected. Ignoring.`);
            return;
        }

        for (const [dataType, mappingInfo] of Object.entries(this.appController.ALL_DATA_MAPPING)) {
            const cloudMetadata = cloudData[dataType];
            const { stateKey, saveKey, isPasted, uiId, processFunc } = mappingInfo;

            if (dataType === 'giocong' || dataType === 'thuongnong' || dataType.startsWith('pasted')) {
                console.log(`%c[handleCloudDataUpdate @ ${receivedTime}] --> Processing METADATA for WATCHED dataType: ${dataType}`, "color: fuchsia; font-weight: bold;", cloudMetadata);
            }

            if (cloudMetadata && typeof cloudMetadata === 'object' && cloudMetadata.version !== undefined && cloudMetadata.timestamp !== undefined) {

                const updatedBy = cloudMetadata.updatedBy;
                const cloudServerTimestampObj = cloudMetadata.updatedAt;
                const updatedTime = cloudServerTimestampObj
                    ? ui.formatTimeAgo(cloudServerTimestampObj.toDate ? cloudServerTimestampObj.toDate() : new Date(cloudServerTimestampObj))
                    : 'v·ª´a xong';

                const cloudVersion = cloudMetadata.version || 0;
                const cloudLocalTimestamp = cloudMetadata.timestamp || 0;
                const fileName = cloudMetadata.fileName || 'Cloud';

                const localVersionInfo = this.appController._localDataVersions?.[currentWarehouse]?.[dataType] || { version: 0, timestamp: 0 };
                const lastLocalVersion = localVersionInfo.version;
                const lastLocalTimestamp = localVersionInfo.timestamp;

                let shouldUpdateLocalInfo = false;
                if (cloudVersion > lastLocalVersion) {
                    shouldUpdateLocalInfo = true;
                } else if (cloudVersion === lastLocalVersion && cloudLocalTimestamp > lastLocalTimestamp) {
                    shouldUpdateLocalInfo = true;
                }

                if (shouldUpdateLocalInfo) {
                    const metadataKey = `${LOCAL_METADATA_PREFIX}${currentWarehouse}_${dataType}`;
                    try {
                        localStorage.setItem(metadataKey, JSON.stringify(cloudMetadata));
                        console.log(`%c[handleCloudDataUpdate @ ${receivedTime}] Saved received metadata for ${dataType} @ ${currentWarehouse} to localStorage ('${metadataKey}').`, "color: green; font-weight: bold;");
                    } catch (e) {
                        console.error(`Error saving metadata for ${dataType} to localStorage:`, e);
                    }

                    if (appState.currentUser && updatedBy === appState.currentUser.email) {
                        if (isPasted) {
                            let processedCount = 0;
                            if (stateKey && processFunc && cloudMetadata.content && dataType !== 'pastedThiduaNVBI') {
                                try {
                                    const processed = processFunc(cloudMetadata.content);
                                    processedCount = processed?.length || 0;
                                } catch (e) { console.error(`Error processing pasted content during status update for ${dataType}:`, e); }
                            } else if (dataType === 'pastedThiduaNVBI') {
                                const processedData = JSON.parse(localStorage.getItem(saveKey) || '[]');
                                processedCount = processedData.length;
                            }
                            ui.updatePasteStatus(uiId, '', 'success', cloudMetadata, processedCount);
                        } else {
                            ui.updateFileStatus(uiId, fileName, '', 'success', false, cloudMetadata);
                        }
                    } else {
                        showSyncNotification = true;
                        if (isPasted) {
                            console.log(`%c[handleCloudDataUpdate] Pasted data ${dataType} is new. Processing content...`, "color: darkcyan; font-weight: bold;");
                            const content = cloudMetadata.content || '';
                            let processedCount = 0;
                            try {
                                if (dataType === 'pastedThiduaNVBI') {
                                    const parsedData = services.parsePastedThiDuaTableData(content);
                                    if (!parsedData.success) throw new Error(parsedData.error);
                                    
                                    services.updateCompetitionNameMappings(parsedData.mainHeaders);
                                    
                                    const processedData = services.processThiDuaNhanVienData(parsedData, appState.competitionData);
                                    
                                    appState[stateKey] = processedData;
                                    localStorage.setItem(saveKey, JSON.stringify(processedData));
                                    processedCount = processedData.length;

                                    localStorage.setItem(RAW_PASTE_THIDUANV_KEY, content);
                                    const el = document.getElementById('paste-thiduanv');
                                    if (el) el.value = content;

                                } else {
                                    localStorage.setItem(saveKey, content);
                                    if (stateKey && processFunc) {
                                        const processedData = processFunc(content);
                                        appState[stateKey] = processedData;
                                        processedCount = processedData?.length || 0;
                                    } else if (stateKey) {
                                        console.warn(`Missing processFunc for pasted data ${dataType}`);
                                    } else if (uiId === 'status-luyke') {
                                        document.getElementById('paste-luyke').value = content;
                                    }
                                }

                                if (!this.appController._localDataVersions[currentWarehouse]) this.appController._localDataVersions[currentWarehouse] = {};
                                this.appController._localDataVersions[currentWarehouse][dataType] = { version: cloudVersion, timestamp: cloudLocalTimestamp };
                                localStorage.setItem(LOCAL_DATA_VERSIONS_KEY, JSON.stringify(this.appController._localDataVersions));

                                ui.updatePasteStatus(uiId, '', 'success', cloudMetadata, processedCount);
                                this.appController.updateAndRenderCurrentTab();
                                if (dataType === 'pastedThiduaNVBI' && appState.isAdmin && document.getElementById('declaration-section')?.classList.contains('hidden') === false) {
                                    ui.renderAdminPage();
                                }
                            } catch (e) {
                                console.error(`Error processing pasted data ${dataType} from cloud:`, e);
                                ui.updatePasteStatus(uiId, `L·ªói x·ª≠ l√Ω v${cloudVersion} t·ª´ cloud.`, 'error');
                            }
                        } else {
                            ui.updateFileStatus(uiId, fileName, '', 'default', true, cloudMetadata, dataType, currentWarehouse);
                        }
                    }
                } else {
                    const reasonText = '';
                    if (appState.currentUser && updatedBy === appState.currentUser.email) {
                        const statusText = `‚úì ƒê√£ ƒë·ªìng b·ªô cloud ${updatedTime} ${reasonText}`.trim();
                        isPasted ? ui.updatePasteStatus(uiId, statusText, 'success', cloudMetadata) : ui.updateFileStatus(uiId, fileName, statusText, 'success', false, cloudMetadata);
                    } else {
                        const statusText = `‚ìò ${updatedBy} c·∫≠p nh·∫≠t ${updatedTime} ${reasonText}`.trim();
                        isPasted ? ui.updatePasteStatus(uiId, statusText, 'default', cloudMetadata) : ui.updateFileStatus(uiId, fileName, statusText, 'default', false, cloudMetadata);
                    }
                }
            } else {
                if (dataType === 'giocong' || dataType === 'thuongnong' || dataType.startsWith('pasted')) {
                    console.warn(`%c[handleCloudDataUpdate @ ${receivedTime}] No valid METADATA structure found (version or timestamp missing) for WATCHED dataType ${dataType}. Received:`, "color: red; font-weight: bold;", cloudMetadata);
                }
            }
        }
        if (showSyncNotification) {
            ui.showNotification('C√≥ b·∫£n c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi t·ª´ cloud!', 'success');
        }
    },

    /**
     * T·∫£i file t·ª´ cloud (khi user click) v√† x·ª≠ l√Ω.
     * (ƒê√£ di chuy·ªÉn t·ª´ main.js)
     */
    async handleDownloadAndProcessData(dataType, warehouse) {
        console.log(`%c[handleDownloadAndProcessData] User requested download for ${dataType} @ ${warehouse}`, "color: darkcyan; font-weight: bold;");
        const metadataKey = `${LOCAL_METADATA_PREFIX}${warehouse}_${dataType}`;

        const mappingInfo = Object.values(this.appController.ALL_DATA_MAPPING).find(m => m.firestoreKey === dataType);

        if (!mappingInfo || mappingInfo.isPasted) {
            console.error(`[handleDownloadAndProcessData] Invalid or non-file dataType: ${dataType}`);
            ui.showNotification(`L·ªói: Lo·∫°i d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá (${dataType}).`, 'error');
            return;
        }
        const { stateKey, saveKey, uiId } = mappingInfo;

        let metadata;

        try {
            const storedMetadata = localStorage.getItem(metadataKey);
            if (!storedMetadata) {
                throw new Error(`Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë·ªìng b·ªô (${metadataKey}) trong localStorage.`);
            }
            metadata = JSON.parse(storedMetadata);
            const downloadURL = metadata.downloadURL;
            const expectedVersion = metadata.version;
            const expectedTimestamp = metadata.timestamp;
            const expectedFileName = metadata.fileName || `${dataType}_v${expectedVersion}.xlsx`;

            if (!downloadURL) {
                throw new Error("URL t·∫£i xu·ªëng kh√¥ng h·ª£p l·ªá trong th√¥ng tin ƒë·ªìng b·ªô.");
            }

            ui.updateFileStatus(uiId, expectedFileName, `ƒêang t·∫£i file...`, 'default', false);
            ui.showProgressBar(uiId);

            console.log(`[handleDownloadAndProcessData] Fetching file from: ${downloadURL}`);
            const response = await fetch(downloadURL);
            if (!response.ok) {
                throw new Error(`T·∫£i file th·∫•t b·∫°i: ${response.status} ${response.statusText}`);
            }
            const fileBlob = await response.blob();
            console.log(`[handleDownloadAndProcessData] File downloaded successfully. Blob size: ${fileBlob.size}`);
            const downloadedFile = new File([fileBlob], expectedFileName, { type: fileBlob.type });

            ui.updateFileStatus(uiId, expectedFileName, `ƒêang x·ª≠ l√Ω file...`, 'default');

            const workbook = await this._handleFileRead(downloadedFile);
            // === START: S·ª¨A L·ªñI (V·∫•n ƒë·ªÅ 2 - Logic D·ªØ li·ªáu) ===
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false, defval: null });
            // === END: S·ª¨A L·ªñI ===

            const normalizeType = dataType.replace('_thangtruoc', '');

            const { normalizedData, success, missingColumns } = services.normalizeData(rawData, normalizeType);
            console.log(`[handleDownloadAndProcessData] File processing result - Success: ${success}, Rows: ${normalizedData?.length}`);

            if (!success) {
                throw new Error(`File t·∫£i v·ªÅ l·ªói: Thi·∫øu c·ªôt ${missingColumns.join(', ')}.`);
            }

            appState[stateKey] = normalizedData;
            if (saveKey) {
                console.log(`[handleDownloadAndProcessData] Saving downloaded & processed data (${normalizedData.length} rows) to cache: ${saveKey}`);
                await this.appController.storage.setItem(saveKey, normalizedData);
            }

            if (!this.appController._localDataVersions[warehouse]) this.appController._localDataVersions[warehouse] = {};
            this.appController._localDataVersions[warehouse][dataType] = { version: expectedVersion, timestamp: expectedTimestamp };
            try {
                localStorage.setItem(LOCAL_DATA_VERSIONS_KEY, JSON.stringify(this.appController._localDataVersions));
                console.log(`%c[handleDownloadAndProcessData] CRITICAL FIX: Updated local version tracker to (v${expectedVersion}, t${expectedTimestamp}) and saved to localStorage.`, "color: purple; font-weight: bold;");
            } catch (e) {
                console.error("[handleDownloadAndProcessData] Error saving updated versions/timestamps to localStorage:", e);
            }

            ui.updateFileStatus(uiId, expectedFileName, '', 'success', false, metadata);
            ui.showNotification(`ƒê√£ t·∫£i v√† x·ª≠ l√Ω th√†nh c√¥ng d·ªØ li·ªáu ${dataType} (v${expectedVersion})!`, 'success');

            this.appController.updateAndRenderCurrentTab();

        } catch (error) {
            console.error(`%c[handleDownloadAndProcessData] Error processing ${dataType} @ ${warehouse}:`, "color: red;", error);
            ui.showNotification(`L·ªói khi t·∫£i/x·ª≠ l√Ω d·ªØ li·ªáu ${dataType}: ${error.message}`, 'error');
            if (metadata) {
                const statusText = `L·ªói t·∫£i/x·ª≠ l√Ω. Th·ª≠ l·∫°i?`;
                ui.updateFileStatus(uiId, metadata.fileName || 'Cloud', statusText, 'error', true, metadata, dataType, warehouse);
            } else {
                const fallbackMetadata = this._getSavedMetadata(warehouse, dataType);
                if (fallbackMetadata) {
                    const statusText = `L·ªói t·∫£i/x·ª≠ l√Ω. Th·ª≠ l·∫°i?`;
                    ui.updateFileStatus(uiId, fallbackMetadata.fileName || 'Cloud', statusText, 'error', true, fallbackMetadata, dataType, warehouse);
                } else {
                    ui.updateFileStatus(uiId, 'Cloud', 'L·ªói t·∫£i/xS·ª≠ l√Ω. Kh√¥ng t√¨m th·∫•y th√¥ng tin.', 'error', false);
                }
            }
        } finally {
            ui.hideProgressBar(uiId);
        }
    },

    /**
     * X·ª≠ l√Ω ƒë·ªìng b·ªô d·ªØ li·ªáu d√°n (paste) l√™n cloud.
     * (ƒê√£ di chuy·ªÉn t·ª´ main.js)
     */
    async _handlePastedDataSync(pastedText, kho, dataType, uiId, localStorageKey, stateKey = null, processFunc = null) {
        console.log(`%c[DEBUG _handlePastedDataSync] B·∫Øt ƒë·∫ßu ƒë·ªìng b·ªô cho: ${dataType}`, "color: darkcyan; font-weight: bold;");

        if (dataType !== 'pastedThiduaNVBI') {
            try {
                localStorage.setItem(localStorageKey, pastedText);
                console.log(`%c[DEBUG _handlePastedDataSync]   > ƒê√£ L∆ØU (setItem) text th√¥ v√†o localStorage key: ${localStorageKey}`, "color: darkcyan;");
            } catch (e) {
                console.error(`%c[DEBUG _handlePastedDataSync]   > L·ªñI khi l∆∞u text th√¥ v√†o localStorage key: ${localStorageKey}`, "color: red;", e);
            }
        }

        let processedData = null;
        let processedCount = 0;
        
        if (dataType === 'pastedThiduaNVBI') {
            const parsedData = services.parsePastedThiDuaTableData(pastedText);
            if(parsedData.success) {
                services.updateCompetitionNameMappings(parsedData.mainHeaders);
                processedData = services.processThiDuaNhanVienData(parsedData, appState.competitionData);
                appState[stateKey] = processedData;
                processedCount = processedData.length;
                localStorage.setItem(localStorageKey, JSON.stringify(processedData));
            } else {
                throw new Error(parsedData.error || "L·ªói ph√¢n t√≠ch c√∫ ph√°p d·ªØ li·ªáu thi ƒëua t·ª´ cloud");
            }
        } 
        else if (stateKey && processFunc) {
            processedData = processFunc(pastedText);
            appState[stateKey] = processedData;
            processedCount = processedData?.length || 0;
        }

        if (!kho) {
            ui.updatePasteStatus(uiId, '‚úì ƒê√£ nh·∫≠n (Ch·ªçn kho ƒë·ªÉ ƒë·ªìng b·ªô)', 'success', null, processedCount);
            if (dataType !== 'pastedLuykeBI') this.appController.updateAndRenderCurrentTab();
            return;
        }

        ui.updatePasteStatus(uiId, 'ƒêang ƒë·ªìng b·ªô cloud...', 'default');

        try {
            const localDataVersions = this.appController._localDataVersions;
            const currentVersion = localDataVersions?.[kho]?.[dataType]?.version || 0;
            const newVersion = currentVersion + 1;
            const uploadTimestamp = Date.now();
            const versionInfo = { version: newVersion, timestamp: uploadTimestamp };

            const metadata = {
                content: pastedText,
                version: versionInfo.version,
                timestamp: versionInfo.timestamp,
                updatedBy: appState.currentUser.email
            };

            // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
            await datasyncService.savePastedDataToFirestore(kho, dataType, metadata.content, versionInfo);
            // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===

            if (!localDataVersions[kho]) localDataVersions[kho] = {};
            localDataVersions[kho][dataType] = versionInfo;
            localStorage.setItem(LOCAL_DATA_VERSIONS_KEY, JSON.stringify(localDataVersions));

            const metadataKey = `${LOCAL_METADATA_PREFIX}${kho}_${dataType}`;
            const metadataToSaveLocally = { ...metadata, updatedAt: new Date() };
            localStorage.setItem(metadataKey, JSON.stringify(metadataToSaveLocally));

            ui.updatePasteStatus(uiId, '', 'success', metadataToSaveLocally, processedCount);

        } catch (error) {
            console.error(`[${dataType} Paste] Cloud sync failed:`, error);
            ui.updatePasteStatus(uiId, `L·ªói ƒë·ªìng b·ªô cloud: ${error.message}`, 'error');
        }

        if (dataType !== 'pastedLuykeBI') {
            this.appController.updateAndRenderCurrentTab();
        }
    },

    /**
     * X·ª≠ l√Ω d√°n d·ªØ li·ªáu L≈©y k·∫ø BI.
     * (ƒê√£ di chuy·ªÉn t·ª´ main.js)
     */
    async handleLuykePaste() {
        const pastedText = document.getElementById('paste-luyke')?.value || '';
        const kho = appState.selectedWarehouse;
        const mappingInfo = this.appController.ALL_DATA_MAPPING['pastedLuykeBI'];

        try {
            localStorage.setItem(mappingInfo.saveKey, pastedText);
            console.log(`%c[DEBUG handleLuykePaste] ƒê√£ L∆ØU (setItem) v√†o localStorage key: ${mappingInfo.saveKey} (ƒê·ªô d√†i: ${pastedText.length})`, "color: green;");
        } catch (e) {
            console.error(`%c[DEBUG handleLuykePaste] L·ªñI khi l∆∞u v√†o localStorage key: ${mappingInfo.saveKey}`, "color: red;", e);
        }
        
        ui.updatePasteStatus(mappingInfo.uiId, '‚úì ƒê√£ nh·∫≠n d·ªØ li·ªáu.', 'success');

        if (kho) {
            await this._handlePastedDataSync(
                pastedText,
                kho,
                mappingInfo.firestoreKey,
                mappingInfo.uiId,
                mappingInfo.saveKey
            );
        }
        this.appController.updateAndRenderCurrentTab();
    },

    /**
     * X·ª≠ l√Ω d√°n d·ªØ li·ªáu Thi ƒëua Nh√¢n vi√™n.
     * (ƒê√£ di chuy·ªÉn t·ª´ main.js)
     */
    async handleThiduaNVPaste() {
        const pastedText = document.getElementById('paste-thiduanv')?.value || '';
        const kho = appState.selectedWarehouse;
        const mappingInfo = this.appController.ALL_DATA_MAPPING['pastedThiduaNVBI'];
        if (!mappingInfo) return;

        const { stateKey, saveKey, firestoreKey, uiId } = mappingInfo;

        try {
            localStorage.setItem(RAW_PASTE_THIDUANV_KEY, pastedText);
            console.log(`%c[DEBUG handleThiduaNVPaste] ƒê√£ L∆ØU (setItem) text th√¥ v√†o localStorage key: ${RAW_PASTE_THIDUANV_KEY} (ƒê·ªô d√†i: ${pastedText.length})`, "color: green;");
        } catch (e) {
            console.warn("Kh√¥ng th·ªÉ l∆∞u raw_paste_thiduanv v√†o localStorage:", e);
        }

        try {
            const parsedData = services.parsePastedThiDuaTableData(pastedText);
            if (!parsedData.success) {
                throw new Error(parsedData.error || "L·ªói ph√¢n t√≠ch c√∫ ph√°p d·ªØ li·ªáu.");
            }

            services.updateCompetitionNameMappings(parsedData.mainHeaders);
            const processedData = services.processThiDuaNhanVienData(parsedData, appState.competitionData);
            
            appState[stateKey] = processedData;
            localStorage.setItem(saveKey, JSON.stringify(processedData));
            
            settingsService.loadPastedCompetitionViewSettings();
            console.log("[dataService handleThiduaNVPaste] ƒê√£ t·∫£i v√† h·ª£p nh·∫•t c√†i ƒë·∫∑t c·ªôt thi ƒëua.");

            const processedCount = processedData.length;
            
            await this._handlePastedDataSync(
                pastedText,
                kho,
                firestoreKey,
                uiId,
                saveKey,
                stateKey,
                null
            );

            this.appController.updateAndRenderCurrentTab();
            if (appState.isAdmin && document.getElementById('declaration-section')?.classList.contains('hidden') === false) {
                ui.renderAdminPage();
            }

        } catch (error) {
            console.error("L·ªói khi x·ª≠ l√Ω d·ªØ li·ªáu d√°n Thi ƒëua NV:", error);
            ui.updatePasteStatus(uiId, `L·ªói: ${error.message}`, 'error');
            const debugContainer = document.getElementById('debug-tool-container');
            if (debugContainer?.classList.contains('hidden')) {
                document.getElementById('toggle-debug-btn')?.click();
            }
        }
    },

    /**
     * X·ª≠ l√Ω d√°n d·ªØ li·ªáu Th∆∞·ªüng ERP.
     * (ƒê√£ di chuy·ªÉn t·ª´ main.js)
     */
    async handleErpPaste() {
        const pastedText = document.getElementById('paste-thuongerp')?.value || '';
        const kho = appState.selectedWarehouse;
        const mappingInfo = this.appController.ALL_DATA_MAPPING['pastedThuongERP'];
        
        try {
            localStorage.setItem(mappingInfo.saveKey, pastedText);
            console.log(`%c[DEBUG handleErpPaste] ƒê√£ L∆ØU (setItem) v√†o localStorage key: ${mappingInfo.saveKey} (ƒê·ªô d√†i: ${pastedText.length})`, "color: green;");
        } catch (e) {
            console.error(`%c[DEBUG handleErpPaste] L·ªñI khi l∆∞u v√†o localStorage key: ${mappingInfo.saveKey}`, "color: red;", e);
        }

        await this._handlePastedDataSync(
            pastedText,
            kho,
            mappingInfo.firestoreKey,
            mappingInfo.uiId,
            mappingInfo.saveKey,
            mappingInfo.stateKey,
            mappingInfo.processFunc
        );
    },

    /**
     * X·ª≠ l√Ω d√°n d·ªØ li·ªáu Th∆∞·ªüng ERP th√°ng tr∆∞·ªõc.
     * (ƒê√£ di chuy·ªÉn t·ª´ main.js)
     */
    async handleErpThangTruocPaste(e) {
        const pastedText = e.target.value;
        const kho = appState.selectedWarehouse;
        const mappingInfo = this.appController.ALL_DATA_MAPPING['pastedThuongERPThangTruoc'];
        
        try {
            localStorage.setItem(mappingInfo.saveKey, pastedText);
            console.log(`%c[DEBUG handleErpThangTruocPaste] ƒê√£ L∆ØU (setItem) v√†o localStorage key: ${mappingInfo.saveKey} (ƒê·ªô d√†i: ${pastedText.length})`, "color: green;");
        } catch (lsError) {
            console.error(`%c[DEBUG handleErpThangTruocPaste] L·ªñI khi l∆∞u v√†o localStorage key: ${mappingInfo.saveKey}`, "color: red;", lsError);
        }

        await this._handlePastedDataSync(
            pastedText,
            kho,
            mappingInfo.firestoreKey,
            mappingInfo.uiId,
            mappingInfo.saveKey,
            mappingInfo.stateKey,
            mappingInfo.processFunc
        );
    },

    /**
     * X·ª≠ l√Ω t·∫£i file Realtime.
     * (ƒê√£ di chuy·ªÉn t·ª´ main.js)
     */
    async handleRealtimeFileInput(e) {
        const file = e.target.files[0];
        if (!file) return;
        ui.showNotification('ƒêang x·ª≠ l√Ω file realtime...', 'success');
        appState.realtimeYCXData = [];
        e.target.value = '';
        try {
            const workbook = await this._handleFileRead(file);
            // === START: S·ª¨A L·ªñI (V·∫•n ƒë·ªÅ 2 - Logic D·ªØ li·ªáu) ===
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false, defval: null });
            // === END: S·ª¨A L·ªñI ===
            const { normalizedData, success, missingColumns } = services.normalizeData(rawData, 'ycx');
            ui.displayDebugInfo('ycx-realtime');
            if (success) {
                appState.realtimeYCXData = normalizedData;
                // *** START: S·ª¨A L·ªñI (v1.9) - X√≥a d√≤ng l·ªói ***
                // this.appController.populateRealtimeBrandCategoryFilter(); // <--- D√íNG N√ÄY G√ÇY L·ªñI
                // *** END: S·ª¨A L·ªñI (v1.9) ***
                ui.showNotification(`T·∫£i th√†nh c√¥ng ${normalizedData.length} d√≤ng realtime!`, 'success');
                this.appController.updateAndRenderCurrentTab();
            } else {
                ui.showNotification(`File realtime l·ªói: Thi·∫øu c·ªôt ${missingColumns.join(', ')}.`, 'error');
                const debugContainer = document.getElementById('debug-tool-container');
                if (debugContainer?.classList.contains('hidden')) {
                    document.getElementById('toggle-debug-btn')?.click();
                }
            }
        } catch (err) { ui.showNotification(`C√≥ l·ªói khi ƒë·ªçc file: ${err.message}`, 'error'); console.error(err); }
    },

    /**
     * X·ª≠ l√Ω t·∫£i file C·∫•u tr√∫c Ng√†nh h√†ng.
     * (ƒê√£ di chuy·ªÉn t·ª´ main.js)
     */
    async handleCategoryFile(e) {
        const fileInput = e.target;
        const file = fileInput.files[0];
        if (!file) return;
        ui.updateFileStatus('category-structure', file.name, 'ƒêang x·ª≠ l√Ω...', 'default');
        ui.showProgressBar('category-structure');
        try {
            const workbook = await this._handleFileRead(file);
            const categorySheet = workbook.Sheets[workbook.SheetNames[0]];
            // === START: S·ª¨A L·ªñI (V·∫•n ƒë·ªÅ 2 - Logic D·ªØ li·ªáu) ===
            const categoryRawData = XLSX.utils.sheet_to_json(categorySheet, { raw: false, defval: null });
            // === END: S·ª¨A L·ªñI ===
            const categoryResult = services.normalizeCategoryStructureData(categoryRawData);
            let brandResult = { success: true, normalizedData: [] };
            const brandSheetName = workbook.SheetNames.find(name => name.toLowerCase().trim() === 'h√£ng');
            if (brandSheetName) {
                const brandSheet = workbook.Sheets[brandSheetName];
                // === START: S·ª¨A L·ªñI (V·∫•n ƒë·ªÅ 2 - Logic D·ªØ li·ªáu) ===
                const brandRawData = XLSX.utils.sheet_to_json(brandSheet, { raw: false, defval: null });
                // === END: S·ª¨A L·ªñI ===
                brandResult = services.normalizeBrandData(brandRawData);
            }
            if(categoryResult.success) {
                appState.categoryStructure = categoryResult.normalizedData;
                appState.brandList = brandResult.normalizedData;
                // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
                await adminService.saveCategoryDataToFirestore({ categories: categoryResult.normalizedData, brands: brandResult.normalizedData });
                // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
                ui.updateFileStatus('category-structure', file.name, `‚úì ƒê√£ x·ª≠ l√Ω v√† ƒë·ªìng b·ªô ${categoryResult.normalizedData.length} nh√≥m & ${brandResult.normalizedData.length} h√£ng.`, 'success');
            } else {
                ui.showNotification(`L·ªói x·ª≠ l√Ω file khai b√°o: ${categoryResult.error}`, 'error');
            }
        } catch (error) {
            ui.updateFileStatus('category-structure', file.name, `L·ªói: ${error.message}`, 'error');
        } finally {
            ui.hideProgressBar('category-structure');
            fileInput.value = '';
        }
    },

    // ========== START: H√ÄM M·ªöI X·ª¨ L√ù FILE SPƒêQ ==========
    /**
     * X·ª≠ l√Ω t·∫£i file S·∫£n Ph·∫©m ƒê·∫∑c Quy·ªÅn (SPƒêQ).
     */
    async handleSpecialProductFileUpload(e) {
        const fileInput = e.target;
        const file = fileInput.files[0];
        const uiId = 'special-products'; // ID t·ª´ index.html
        if (!file) return;

        ui.updateFileStatus(uiId, file.name, 'ƒêang x·ª≠ l√Ω...', 'default');
        ui.showProgressBar(uiId);
        try {
            const workbook = await this._handleFileRead(file);
            // === START: S·ª¨A L·ªñI (V·∫•n ƒë·ªÅ 2 - Logic D·ªØ li·ªáu) ===
            // Th√™m { raw: false } ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªçc M√£ SP d·∫°ng text
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false, defval: null });
            // === END: S·ª¨A L·ªñI ===
            
            // G·ªçi h√†m normalize (s·∫Ω ƒë∆∞·ª£c th√™m v√†o services.js/data-processing.js)
            const result = services.normalizeSpecialProductData(rawData);

            if (result.success) {
                appState.specialProductList = result.normalizedData;
                
                // L∆∞u l√™n Cloud
                await adminService.saveSpecialProductList(result.normalizedData);
                
                ui.updateFileStatus(uiId, file.name, `‚úì ƒê√£ x·ª≠ l√Ω v√† ƒë·ªìng b·ªô ${result.normalizedData.length} SPƒêQ.`, 'success');
                ui.showNotification(`ƒê√£ ƒë·ªìng b·ªô ${result.normalizedData.length} S·∫£n ph·∫©m ƒê·∫∑c quy·ªÅn!`, 'success');
            } else {
                ui.showNotification(`L·ªói x·ª≠ l√Ω file SPƒêQ: ${result.error}`, 'error');
                ui.updateFileStatus(uiId, file.name, `L·ªói: ${result.error}`, 'error');
            }
        } catch (error) {
            console.error("L·ªói khi x·ª≠ l√Ω file SPƒêQ:", error);
            ui.updateFileStatus(uiId, file.name, `L·ªói: ${error.message}`, 'error');
            ui.showNotification(`L·ªói khi ƒë·ªçc file SPƒêQ: ${error.message}`, 'error');
        } finally {
            ui.hideProgressBar(uiId);
            fileInput.value = '';
        }
    },
    // ========== END: H√ÄM M·ªöI ==========

    /**
     * X·ª≠ l√Ω t·∫£i file Thi ƒêua V√πng.
     * (ƒê√£ di chuy·ªÉn t·ª´ main.js)
     */
    async handleThiDuaVungFileInput(e) {
        const fileInput = e.target;
        const file = fileInput.files[0];
        if (!file) return;
        ui.updateFileStatus('thidua-vung', file.name, 'ƒêang x·ª≠ l√Ω...', 'default');
        try {
            const workbook = await this._handleFileRead(file);
            const { chiTietData, tongData } = services.processThiDuaVungFile(workbook);
            if (!tongData || tongData.length === 0) throw new Error('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá trong sheet "TONG".');
            appState.thiDuaVungChiTiet = chiTietData;
            appState.thiDuaVungTong = tongData;
            const supermarketKey = Object.keys(tongData[0]).find(k => k.trim().toLowerCase().includes('si√™u th·ªã'));
            const supermarketNames = [...new Set(tongData.map(row => row[supermarketKey]).filter(Boolean))].sort();
            const choicesInstance = appState.choices.thiDuaVung_sieuThi;
            if (choicesInstance) {
                choicesInstance.clearStore();
                choicesInstance.setChoices(supermarketNames.map(name => ({ value: name, label: name })), 'value', 'label', true);
            }
            ui.updateFileStatus('thidua-vung', file.name, `‚úì ƒê√£ x·ª≠ l√Ω ${supermarketNames.length} si√™u th·ªã.`, 'success');
        } catch (error) {
            ui.updateFileStatus('thidua-vung', file.name, `L·ªói: ${error.message}`, 'error');
        }
    },
    

    // --- C√ÅC H√ÄM M·ªöI (v1.3) ---

    /**
     * T·∫£i file m·∫´u DSNV.
     * (ƒê√£ di chuy·ªÉn t·ª´ main.js )
     */
    async handleTemplateDownload() {
        ui.showNotification('ƒêang chu·∫©n b·ªã file m·∫´u...', 'success');
        try {
            // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
            const url = await storageService.getTemplateDownloadURL();
            // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
            const link = document.createElement('a');
            link.href = url;
            link.download = 'Danh_Sach_Nhan_Vien_Mau.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error("L·ªói khi t·∫£i file m·∫´u:", error);
            ui.showNotification('Kh√¥ng th·ªÉ t·∫£i file m·∫´u. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
        }
    },

    /**
     * X·ª≠ l√Ω file g·ª° l·ªói thi ƒëua.
     * (ƒê√£ di chuy·ªÉn t·ª´ main.js )
     */
    async handleCompetitionDebugFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        ui.showNotification('ƒêang ph√¢n t√≠ch file g·ª° l·ªói...', 'success');
        try {
            const workbook = await this._handleFileRead(file);
            // === START: S·ª¨A L·ªñI (V·∫•n ƒë·ªÅ 2 - Logic D·ªØ li·ªáu) ===
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false, defval: null });
            // === END: S·ª¨A L·ªñI ===
            const debugResults = services.debugCompetitionFiltering(rawData);
            ui.renderCompetitionDebugReport(debugResults);
        } catch (err) {
            ui.showNotification(`L·ªói khi ƒë·ªçc file g·ª° l·ªói: ${err.message}`, 'error');
        }
    }
};
--- END FILE: ./services/data.service.js ---

--- START FILE: ./services/datasync.service.js ---
// Version 1.0 - Initial service extraction
// MODULE: DATA SYNC SERVICE
// Ch·ªãu tr√°ch nhi·ªám x·ª≠ l√Ω logic ƒë·ªìng b·ªô d·ªØ li·ªáu kho (Metadata v√† Pasted Content) l√™n Firestore.
import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { appState } from '../state.js';
import { ui } from '../ui.js';

export const datasyncService = {
    async saveMetadataToFirestore(kho, dataType, metadata) {
        if (!appState.db || !kho || !dataType || !metadata) {
            console.error("[DataSyncService.saveMetadataToFirestore] Invalid input parameters.");
            throw new Error("Invalid parameters for saving metadata.");
        }
        if (!appState.currentUser?.email) {
            throw new Error("Kh√¥ng th·ªÉ l∆∞u metadata khi ch∆∞a ƒë·ªãnh danh email.");
        }

        const khoRef = doc(appState.db, "warehouseData", kho);
        const dataToSave = {
            [dataType]: {
                ...metadata,
                updatedAt: serverTimestamp(),
                updatedBy: appState.currentUser.email
            }
        };

        try {
            console.log(`[DataSyncService.saveMetadataToFirestore] Attempting to save metadata for ${dataType} (v${metadata.version}, t${metadata.timestamp}) for kho ${kho}.`);
            await setDoc(khoRef, dataToSave, { merge: true });
            console.log(`[DataSyncService.saveMetadataToFirestore] Successfully saved metadata for ${dataType} (v${metadata.version}).`);
        } catch (error) {
            console.error(`%c[DataSyncService.saveMetadataToFirestore] L·ªñI KHI L∆ØU METADATA KHO ${kho} (${dataType}, v${metadata.version}):`, "color: red; font-weight: bold;", error);
            console.error("[DataSyncService.saveMetadataToFirestore] Error details:", error.code, error.message);
            let userMessage = `L·ªói nghi√™m tr·ªçng khi l∆∞u th√¥ng tin ƒë·ªìng b·ªô ${dataType}.`;
            ui.showNotification(userMessage, 'error');
            throw error;
        }
    },

    async savePastedDataToFirestore(kho, dataType, content, versionInfo) {
        if (!appState.db || !kho || !dataType || !content || !versionInfo) {
            console.error("[DataSyncService.savePastedDataToFirestore] Invalid input parameters.");
            throw new Error("Invalid parameters for saving pasted data.");
        }
        if (!appState.currentUser?.email) {
            throw new Error("Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu d√°n khi ch∆∞a ƒë·ªãnh danh email.");
        }

        const khoRef = doc(appState.db, "warehouseData", kho);
        const metadata = {
            content: content,
            version: versionInfo.version,
            timestamp: versionInfo.timestamp,
            updatedAt: serverTimestamp(),
            updatedBy: appState.currentUser.email
        };
        const dataToSave = { [dataType]: metadata };

        try {
            console.log(`[DataSyncService.savePastedDataToFirestore] Attempting to save pasted data for ${dataType} (v${versionInfo.version}, t${versionInfo.timestamp}) for kho ${kho}.`);
            await setDoc(khoRef, dataToSave, { merge: true });
            console.log(`[DataSyncService.savePastedDataToFirestore] Successfully saved pasted data for ${dataType} (v${versionInfo.version}).`);
        } catch (error) {
            console.error(`%c[DataSyncService.savePastedDataToFirestore] L·ªñI KHI L∆ØU D·ªÆ LI·ªÜU D√ÅN KHO ${kho} (${dataType}, v${versionInfo.version}):`, "color: red; font-weight: bold;", error);
            let userMessage = `L·ªói nghi√™m tr·ªçng khi l∆∞u d·ªØ li·ªáu d√°n ${dataType}.`;
            ui.showNotification(userMessage, 'error');
            throw error;
        }
    },
};
--- END FILE: ./services/datasync.service.js ---

--- START FILE: ./services/storage.service.js ---
// Version 1.0 - Initial service extraction
// MODULE: STORAGE SERVICE
// Ch·ªãu tr√°ch nhi·ªám x·ª≠ l√Ω logic giao ti·∫øp v·ªõi Firebase Storage (Upload/Download).
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
import { appState } from '../state.js';
import { ui } from '../ui.js';

export const storageService = {
    async getTemplateDownloadURL() {
        if (!appState.storage) throw new Error("Firebase Storage ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o.");
        const filePath = 'templates/danh_sach_nhan_vien_mau.xlsx';
        const storageRef = ref(appState.storage, filePath);
        try { return await getDownloadURL(storageRef); }
        catch (error) { console.error("L·ªói khi l·∫•y URL t·∫£i file m·∫´u: ", error); throw error; }
    },

    async getBookmarkDownloadURL() {
        if (!appState.storage) throw new Error("Firebase Storage ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o.");
        const filePath = 'templates/Share_QLST.zip';
        const storageRef = ref(appState.storage, filePath);
        try { return await getDownloadURL(storageRef); }
        catch (error) { console.error("L·ªói khi l·∫•y URL t·∫£i file bookmark: ", error); throw error; }
    },

    async getQrCodeDownloadURL() {
        if (!appState.storage) throw new Error("Firebase Storage ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o.");
        const filePath = 'qrcodes/main-qr.jpg';
        const storageRef = ref(appState.storage, filePath);
        try { return await getDownloadURL(storageRef); }
        catch (error) {
            console.error("L·ªói khi l·∫•y URL c·ªßa m√£ QR: ", error);
            if (error.code === 'storage/object-not-found') throw new Error(`Kh√¥ng t√¨m th·∫•y file m√£ QR t·∫°i ƒë∆∞·ªùng d·∫´n '${filePath}'. Vui l√≤ng ki·ªÉm tra l·∫°i Firebase Storage.`);
            throw new Error("Kh√¥ng th·ªÉ t·∫£i ƒë∆∞·ª£c m√£ QR t·ª´ server.");
        }
    },

    async uploadFileToStorage(file, storagePath, onProgress) {
        if (!appState.storage) {
            throw new Error("Firebase Storage is not initialized.");
        }
        if (!file || !storagePath) {
            throw new Error("File or storage path is missing for upload.");
        }

        const storageRef = ref(appState.storage, storagePath);
        const uploadTask = uploadBytesResumable(storageRef, file);

        return new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log(`Upload ${storagePath} is ${progress}% done`);
                    if (onProgress && typeof onProgress === 'function') {
                        onProgress(progress);
                    }
                },
                (error) => {
                    console.error(`%c[StorageService.uploadFileToStorage] L·ªñI KHI UPLOAD file ${storagePath}:`, "color: red; font-weight: bold;", error);
                    let userMessage = `L·ªói upload file l√™n cloud (${error.code || 'UNKNOWN'}).`;
                    switch (error.code) {
                        case 'storage/unauthorized':
                            userMessage = "L·ªói upload: B·∫°n kh√¥ng c√≥ quy·ªÅn t·∫£i file l√™n.";
                            break;
                        case 'storage/canceled':
                            userMessage = "L·ªói upload: Qu√° tr√¨nh t·∫£i file ƒë√£ b·ªã h·ªßy.";
                            break;
                        case 'storage/unknown':
                            userMessage = "L·ªói upload: ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh tr√™n server.";
                            break;
                    }
                    ui.showNotification(userMessage, 'error');
                    reject(error);
                },
                async () => {
                    console.log(`[StorageService.uploadFileToStorage] File ${storagePath} uploaded successfully.`);
                    try {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        console.log('[StorageService.uploadFileToStorage] File available at', downloadURL);
                        resolve(downloadURL);
                    } catch (getUrlError) {
                        console.error(`%c[StorageService.uploadFileToStorage] L·ªñI KHI L·∫§Y DOWNLOAD URL cho ${storagePath}:`, "color: red; font-weight: bold;", getUrlError);
                        ui.showNotification(`L·ªói l·∫•y link file sau khi upload (${getUrlError.code || 'UNKNOWN'}).`, 'error');
                        reject(getUrlError);
                    }
                }
            );
        });
    },
};
--- END FILE: ./services/storage.service.js ---

--- START FILE: ./services.js ---
// Version 2.8 - Enhance generateLuyKeEmployeeDetailReport to return daily stats and unexported details
// MODULE: SERVICES FACADE
// File n√†y ƒë√≥ng vai tr√≤ ƒëi·ªÅu ph·ªëi, nh·∫≠p kh·∫©u c√°c module logic con v√† export ch√∫ng ra ngo√†i.

import { config } from './config.js';
import { appState } from './state.js';
import { ui } from './ui.js';
import { utils } from './utils.js';
import { dataProcessing } from './services/data-processing.js';

const reportGeneration = {
    // ========== START: H√ÄM M·ªöI CHO S·∫¢N PH·∫®M ƒê·∫∂C QUY·ªÄN ==========
    /**
     * T√≠nh to√°n b√°o c√°o S·∫£n Ph·∫©m ƒê·∫∑c Quy·ªÅn (SPƒêQ) cho c√°c ch∆∞∆°ng tr√¨nh ƒë√£ c·∫•u h√¨nh.
     * @param {Array} sourceYcxData - D·ªØ li·ªáu YCX th√¥ (l≈©y k·∫ø ho·∫∑c realtime).
     * @param {Array} specialProgramConfigs - C·∫•u h√¨nh c√°c ch∆∞∆°ng tr√¨nh SPƒêQ (t·ª´ appState.globalSpecialPrograms).
     * @returns {Array} - M·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng b√°o c√°o, m·ªói ƒë·ªëi t∆∞·ª£ng cho m·ªôt ch∆∞∆°ng tr√¨nh.
     */
    calculateSpecialProductReport(sourceYcxData, specialProgramConfigs) {
        // 1. Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o
        if (!sourceYcxData || sourceYcxData.length === 0 ||
            !specialProgramConfigs || specialProgramConfigs.length === 0 ||
            !appState.specialProductList || appState.specialProductList.length === 0) {
            return [];
        }

        // 2. L·ªçc d·ªØ li·ªáu b√°n h√†ng h·ª£p l·ªá (ƒê√£ xu·∫•t, ƒë√£ thu, ch∆∞a h·ªßy, ch∆∞a tr·∫£)
        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const validSalesData = sourceYcxData.filter(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' &&
                                (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' &&
                                (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£' &&
                                (row.trangThaiXuat || "").trim() === 'ƒê√£ xu·∫•t';
            return isBaseValid && isDoanhThuHTX;
        });

        if (validSalesData.length === 0) return [];

        // 3. X·ª≠ l√Ω t·ª´ng ch∆∞∆°ng tr√¨nh SPƒêQ
        const report = specialProgramConfigs.map(program => {
            
            // 3.1. L·∫•y danh s√°ch Nh√≥m h√†ng v√† M√£ SPƒêQ cho ch∆∞∆°ng tr√¨nh n√†y
            const programGroups = new Set((program.groups || []).map(g => String(g).trim()));
            if (programGroups.size === 0) return null; // B·ªè qua n·∫øu ch∆∞∆°ng tr√¨nh kh√¥ng ch·ªçn nh√≥m h√†ng

            const specialProductSet = new Set(
                appState.specialProductList
                    .filter(sp => programGroups.has(String(sp.nhomHang).trim()))
                    .map(sp => String(sp.maSanPham).trim())
            );

            // 3.2. L·ªçc d·ªØ li·ªáu b√°n h√†ng ch·ªâ cho c√°c nh√≥m h√†ng trong ch∆∞∆°ng tr√¨nh n√†y
            const totalGroupSales = validSalesData.filter(row => 
                programGroups.has(String(row.nhomHang).trim())
            );
            if (totalGroupSales.length === 0) return null; // B·ªè qua n·∫øu kh√¥ng c√≥ doanh thu nh√≥m h√†ng n√†y

            // 3.3. T√≠nh to√°n cho t·ª´ng nh√¢n vi√™n
            const employeeResults = appState.danhSachNhanVien.map(employee => {
                const stats = {
                    slDacQuyen: 0,
                    slNhomHang: 0,
                    dtDacQuyen: 0,
                    dtNhomHang: 0
                };

                // L·ªçc doanh s·ªë c·ªßa nh√¢n vi√™n n√†y
                const employeeSales = totalGroupSales.filter(row => {
                    const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
                    return msnvMatch && msnvMatch[1].trim() === employee.maNV;
                });

                if (employeeSales.length === 0) {
                    return { ...employee, ...stats, tyLeSL: 0, tyLeDT: 0 };
                }

                employeeSales.forEach(row => {
                    const maSanPham = String(row.maSanPham || '').trim();
                    const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                    const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;

                    // C·ªông v√†o t·ªïng nh√≥m h√†ng
                    stats.slNhomHang += soLuong;
                    stats.dtNhomHang += thanhTien;

                    // Ki·ªÉm tra n·∫øu l√† SPƒêQ
                    if (specialProductSet.has(maSanPham)) {
                        stats.slDacQuyen += soLuong;
                        stats.dtDacQuyen += thanhTien;
                    }
                });

                const tyLeSL = stats.slNhomHang > 0 ? (stats.slDacQuyen / stats.slNhomHang) : 0;
                const tyLeDT = stats.dtNhomHang > 0 ? (stats.dtDacQuyen / stats.dtNhomHang) : 0;

                return {
                    maNV: employee.maNV,
                    hoTen: employee.hoTen,
                    boPhan: employee.boPhan,
                    ...stats,
                    tyLeSL,
                    tyLeDT
                };
            }).filter(e => e.slNhomHang > 0); // Ch·ªâ gi·ªØ l·∫°i NV c√≥ b√°n nh√≥m h√†ng n√†y

            return {
                program: program, // C·∫•u h√¨nh ch∆∞∆°ng tr√¨nh (t√™n, nh√≥m h√†ng)
                employeeData: employeeResults, // D·ªØ li·ªáu ƒë√£ t√≠nh to√°n
            };
        }).filter(Boolean); // L·ªçc b·ªè c√°c ch∆∞∆°ng tr√¨nh null (kh√¥ng c√≥ nh√≥m h√†ng ho·∫∑c kh√¥ng c√≥ doanh thu)

        return report;
    },
    // ========== END: H√ÄM M·ªöI ==========

    calculateCompetitionFocusReport(sourceYcxData, competitionConfigs) {
        if (!sourceYcxData || sourceYcxData.length === 0 || !competitionConfigs || competitionConfigs.length === 0) {
            return [];
        }

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();

        const validSalesData = sourceYcxData.filter(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' &&
                                (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' &&
                                (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£' &&
                                (row.trangThaiXuat || "").trim() === 'ƒê√£ xu·∫•t';
            return isBaseValid && isDoanhThuHTX;
        });

        const report = competitionConfigs.map(config => {
            const cleanedConfigGroups = new Set((config.groups || []).map(g => utils.cleanCategoryName(g)));

            let baseSalesData = validSalesData.filter(row => {
                const cleanNhomHangFromYCX = utils.cleanCategoryName(row.nhomHang);

                const isInGroup = cleanedConfigGroups.has(cleanNhomHangFromYCX);
                if (!isInGroup) return false;

                if (config.type === 'soluong' && (config.minPrice > 0 || config.maxPrice > 0)) {
                    const price = (parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0) / (parseInt(String(row.soLuong || "1"), 10) || 1);
                    const minPrice = config.minPrice || 0;
                    const maxPrice = config.maxPrice || Infinity;
                    if (price < minPrice || price > maxPrice) return false;
                }
                return true;
            });

            if (config.excludeApple) {
                baseSalesData = baseSalesData.filter(row => row.nhaSanXuat !== 'Apple');
            }

            const employeeResults = appState.danhSachNhanVien.map(employee => {
                let performanceByBrand = {};
                let totalTargetRevenue = 0;
                let totalTargetQuantity = 0;
                let baseCategoryRevenue = 0;
                let baseCategoryQuantity = 0;

                baseSalesData.forEach(row => {
                    const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
                    if (msnvMatch && msnvMatch[1].trim() === employee.maNV) {
                        const revenueValue = (parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0);
                        const quantityValue = (parseInt(String(row.soLuong || "0"), 10) || 0);

                        baseCategoryRevenue += revenueValue;
                        baseCategoryQuantity += quantityValue;

                        const brand = row.nhaSanXuat;
                        if ((config.brands || []).includes(brand)) {
                            if (!performanceByBrand[brand]) {
                                performanceByBrand[brand] = { revenue: 0, quantity: 0 };
                            }
                            performanceByBrand[brand].revenue += revenueValue;
                            performanceByBrand[brand].quantity += quantityValue;

                            totalTargetRevenue += revenueValue;
                            totalTargetQuantity += quantityValue;
                        }
                    }
                });

                return {
                    maNV: employee.maNV,
                    hoTen: employee.hoTen,
                    boPhan: employee.boPhan,
                    performanceByBrand,
                    targetBrandsRevenue: totalTargetRevenue,
                    targetBrandsQuantity: totalTargetQuantity,
                    baseCategoryRevenue,
                    baseCategoryQuantity,
                    tyLeDT: baseCategoryRevenue > 0 ? (totalTargetRevenue / baseCategoryRevenue) : 0,
                    tyLeSL: baseCategoryQuantity > 0 ? (totalTargetQuantity / baseCategoryQuantity) : 0,
                };
            }).filter(e => e.baseCategoryRevenue > 0 || e.baseCategoryQuantity > 0);

            return {
                competition: config,
                employeeData: employeeResults,
            };
        }).filter(r => r.employeeData.length > 0);

        return report;
    },

    generateMasterReportData: (sourceData, goalSettings, isRealtime = false) => {
        if (appState.danhSachNhanVien.length === 0) return [];

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const hinhThucXuatTraGop = dataProcessing.getHinhThucXuatTraGop();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();
        const PG = config.PRODUCT_GROUPS;
        const gioCongByMSNV = dataProcessing.processGioCongData();
        const thuongNongByMSNV = {};

        appState.thuongNongData.forEach(row => {
            const maNV = String(row.maNV || '').trim();
            const hoTen = String(row.hoTen || '').trim().replace(/\s+/g, ' ');
            let foundMaNV = maNV || appState.employeeNameToMaNVMap.get(hoTen.toLowerCase()) || null;
            if (foundMaNV) {
                const diemThuongValue = parseFloat(String(row.diemThuong || '0').replace(/,/g, '')) || 0;
                thuongNongByMSNV[foundMaNV] = (thuongNongByMSNV[foundMaNV] || 0) + diemThuongValue;
            }
        });

        const thuongNongThangTruocByMSNV = {};
        appState.thuongNongDataThangTruoc.forEach(row => {
            const maNV = String(row.maNV || '').trim();
            const hoTen = String(row.hoTen || '').trim().replace(/\s+/g, ' ');
            let foundMaNV = maNV || appState.employeeNameToMaNVMap.get(hoTen.toLowerCase()) || null;
            if (foundMaNV) {
                const diemThuongValue = parseFloat(String(row.diemThuong || '0').replace(/,/g, '')) || 0;
                thuongNongThangTruocByMSNV[foundMaNV] = (thuongNongThangTruocByMSNV[foundMaNV] || 0) + diemThuongValue;
            }
        });

        return appState.danhSachNhanVien.map((employee) => {
            let data = {
                doanhThu: 0, doanhThuQuyDoi: 0, doanhThuTraGop: 0, doanhThuTraGopQuyDoi: 0,
                doanhThuChuaXuat: 0, doanhThuQuyDoiChuaXuat: 0,
                doanhThuGiaoXa: 0, doanhThuQuyDoiGiaoXa: 0,
                dtICT: 0, dtCE: 0, dtPhuKien: 0, dtGiaDung: 0, dtMLN: 0,
                slICT: 0, dtBaoHiem: 0, slBaoHiem: 0,
                slPhuKien: 0, slGiaDung: 0, slCE: 0, slPinSDP: 0, slCamera: 0,
                slTaiNgheBLT: 0, slNoiChien: 0, slMLN: 0, slRobotHB: 0,
                slBH1d1: 0, slBHXM: 0, slBHRV: 0, slBHMR: 0,
                dtTivi: 0, slTivi: 0, dtTuLanh: 0, slTuLanh: 0,
                dtMayGiat: 0, slMayGiat: 0, dtMayLanh: 0, slMayLanh: 0,
                dtDienThoai: 0, slDienThoai: 0, dtLaptop: 0, slLaptop: 0,
                doanhThuTheoNganhHang: {}, slSimOnline: 0, slUDDD: 0, slBaoHiemVAS: 0, slSmartphone: 0, slBaoHiemDenominator: 0,
                qdc: {}
            };

            for (const key in PG.QDC_GROUPS) data.qdc[key] = { sl: 0, dt: 0, dtqd: 0, name: PG.QDC_GROUPS[key].name };

            sourceData.forEach(row => {
                const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
                if (msnvMatch && msnvMatch[1].trim() === employee.maNV) {
                    const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
                    const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' && (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' && (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£';

                    if (isBaseValid && isDoanhThuHTX) {
                        const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                        if(isNaN(thanhTien)) return;

                        const heSo = heSoQuyDoi[row.nhomHang] || 1;
                        const trangThaiXuat = (row.trangThaiXuat || "").trim();

                        const nhomHangCode = String(row.nhomHang || '').match(/^\d+/)?.[0] || null;
                        const nganhHangCode = String(row.nganhHang || '').match(/^\d+/)?.[0] || null;

                        const isICT = PG.ICT.includes(nhomHangCode);
                        const isCE = PG.CE.includes(nhomHangCode);
                        const isPhuKien = PG.PHU_KIEN.includes(nganhHangCode);
                        const isGiaDung = PG.GIA_DUNG.includes(nganhHangCode);
                        const isMLN = PG.MAY_LOC_NUOC.includes(nhomHangCode);

                        if (trangThaiXuat === 'Ch∆∞a xu·∫•t') {
                            data.doanhThuChuaXuat += thanhTien;
                            data.doanhThuQuyDoiChuaXuat += thanhTien * heSo;
                        } else if (trangThaiXuat === 'ƒê√£ xu·∫•t') {
                            const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;
                            if(isNaN(soLuong)) return;

                            const nganhHangName = utils.cleanCategoryName(row.nganhHang);

                            // Revenue calculation no longer excludes specific HTX
                            data.doanhThu += thanhTien;
                            data.doanhThuQuyDoi += thanhTien * heSo;

                            if (isRealtime && row.ngayTao && row.ngayHenGiao) {
                                const diffTime = row.ngayHenGiao - row.ngayTao;
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                if (diffDays >= 2) {
                                    data.doanhThuGiaoXa += thanhTien;
                                    data.doanhThuQuyDoiGiaoXa += thanhTien * heSo;
                                }
                            }

                            if (hinhThucXuatTraGop.has(row.hinhThucXuat)) { data.doanhThuTraGop += thanhTien; data.doanhThuTraGopQuyDoi += thanhTien * heSo; }

                            if (nganhHangName) {
                                if (!data.doanhThuTheoNganhHang[nganhHangName]) data.doanhThuTheoNganhHang[nganhHangName] = { revenue: 0, quantity: 0, revenueQuyDoi: 0 };
                                data.doanhThuTheoNganhHang[nganhHangName].revenue += thanhTien;
                                data.doanhThuTheoNganhHang[nganhHangName].quantity += soLuong;
                                data.doanhThuTheoNganhHang[nganhHangName].revenueQuyDoi += thanhTien * heSo;
                            }

                            if (isICT) { data.dtICT += thanhTien; }
                            if (isCE) { data.dtCE += thanhTien; data.slCE += soLuong; }
                            if (isPhuKien) { data.dtPhuKien += thanhTien; data.slPhuKien += soLuong; }
                            if (isGiaDung) { data.dtGiaDung += thanhTien; data.slGiaDung += soLuong; }
                            if (isMLN) { data.dtMLN += thanhTien; data.slMLN += soLuong; }

                            if (PG.DIEN_THOAI.includes(nhomHangCode)) { data.dtDienThoai += thanhTien; data.slDienThoai += soLuong; }
                            if (PG.LAPTOP.includes(nhomHangCode)) { data.dtLaptop += thanhTien; data.slLaptop += soLuong; }
                            if (PG.TIVI.includes(nhomHangCode)) { data.dtTivi += thanhTien; data.slTivi += soLuong; }
                            if (PG.TU_LANH.includes(nhomHangCode)) { data.dtTuLanh += thanhTien; data.slTuLanh += soLuong; }
                            if (PG.MAY_GIAT.includes(nhomHangCode)) { data.dtMayGiat += thanhTien; data.slMayGiat += soLuong; }
                            if (PG.MAY_LANH.includes(nhomHangCode)) { data.dtMayLanh += thanhTien; data.slMayLanh += soLuong; }

                            const loaiBaoHiem = dataProcessing.classifyInsurance(row.tenSanPham);
                            if (loaiBaoHiem) {
                                data.dtBaoHiem += thanhTien; data.slBaoHiem += soLuong;
                                if (loaiBaoHiem === 'BH1d1') data.slBH1d1 += soLuong;
                                if (loaiBaoHiem === 'BHXM') data.slBHXM += soLuong;
                                if (loaiBaoHiem === 'BHRV') data.slBHRV += soLuong;
                                if (loaiBaoHiem === 'BHMR') data.slBHMR += soLuong;
                            }
                            if (nhomHangCode === PG.PIN_SDP) data.slPinSDP += soLuong;
                            if (nhomHangCode === PG.CAMERA_TRONG_NHA || nhomHangCode === PG.CAMERA_NGOAI_TROI) data.slCamera += soLuong;
                            if (nhomHangCode === PG.TAI_NGHE_BLT) data.slTaiNgheBLT += soLuong;
                            if (nhomHangCode === PG.NOI_CHIEN) data.slNoiChien += soLuong;
                            if (nhomHangCode === PG.ROBOT_HB) data.slRobotHB += soLuong;

                            if (PG.SIM.includes(nhomHangCode)) data.slSimOnline += soLuong;
                            if (PG.VAS.includes(nhomHangCode)) data.slUDDD += soLuong;
                            if (PG.SMARTPHONE.includes(nhomHangCode)) data.slSmartphone += soLuong;
                            if (PG.BAO_HIEM_VAS.includes(nhomHangCode)) data.slBaoHiemVAS += soLuong;
                            if (PG.BAO_HIEM_DENOMINATOR.includes(nhomHangCode)) data.slBaoHiemDenominator += soLuong;

                            for (const key in PG.QDC_GROUPS) if (PG.QDC_GROUPS[key].codes.includes(nhomHangCode)) {
                                data.qdc[key].sl += soLuong; data.qdc[key].dt += thanhTien; data.qdc[key].dtqd += thanhTien * heSo;
                            }
                        }
                    }
                }
            });

            data.slICT = data.slDienThoai + data.slLaptop;
            const gioCong = gioCongByMSNV[employee.maNV] || 0;
            const thuongNong = thuongNongByMSNV[employee.maNV] || 0;
            const erpEntry = appState.thuongERPData.find(e => e.name.includes(employee.hoTen));
            const thuongERP = erpEntry ? parseFloat(erpEntry.bonus.replace(/,/g, '')) : 0;
            const tongThuNhap = thuongNong + thuongERP;
            const today = new Date();
            const currentDay = today.getDate();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            let thuNhapDuKien = 0;
            if (currentDay > 1) thuNhapDuKien = (tongThuNhap / (currentDay - 1)) * daysInMonth;
            else if (currentDay === 1) thuNhapDuKien = tongThuNhap * daysInMonth;

            const thuongNongThangTruoc = thuongNongThangTruocByMSNV[employee.maNV] || 0;
            const erpEntryThangTruoc = appState.thuongERPDataThangTruoc.find(e => e.name.includes(employee.hoTen));
            const thuongERPThangTruoc = erpEntryThangTruoc ? parseFloat(erpEntryThangTruoc.bonus.replace(/,/g, '')) : 0;
            const thuNhapThangTruoc = thuongNongThangTruoc + thuongERPThangTruoc;
            const chenhLechThuNhap = thuNhapDuKien - thuNhapThangTruoc;

            const hieuQuaQuyDoi = data.doanhThu > 0 ? (data.doanhThuQuyDoi / data.doanhThu) - 1 : 0;
            const tyLeTraCham = data.doanhThu > 0 ? data.doanhThuTraGop / data.doanhThu : 0;
            const pctPhuKien = data.dtICT > 0 ? data.dtPhuKien / data.dtICT : 0;
            const pctGiaDung = data.dtCE > 0 ? data.dtGiaDung / data.dtCE : 0;
            const pctMLN = data.dtCE > 0 ? data.dtMLN / data.dtCE : 0;
            const pctSim = data.slSmartphone > 0 ? data.slSimOnline / data.slSmartphone : 0;
            const pctVAS = data.slSmartphone > 0 ? data.slUDDD / data.slSmartphone : 0;
            const pctBaoHiem = data.slBaoHiemDenominator > 0 ? data.slBaoHiemVAS / data.slBaoHiemDenominator : 0;

            data.donGiaTivi = data.slTivi > 0 ? data.dtTivi / data.slTivi : 0;
            data.donGiaTuLanh = data.slTuLanh > 0 ? data.dtTuLanh / data.slTuLanh : 0;
            data.donGiaMayGiat = data.slMayGiat > 0 ? data.dtMayGiat / data.slMayGiat : 0;
            data.donGiaMayLanh = data.slMayLanh > 0 ? data.dtMayLanh / data.slMayLanh : 0;
            data.donGiaDienThoai = data.slDienThoai > 0 ? data.dtDienThoai / data.slDienThoai : 0;
            data.donGiaLaptop = data.slLaptop > 0 ? data.dtLaptop / data.slLaptop : 0;

            const totalQuantity = Object.values(data.doanhThuTheoNganhHang).reduce((sum, category) => sum + category.quantity, 0);
            const donGiaTrungBinh = totalQuantity > 0 ? data.doanhThu / totalQuantity : 0;

            return { ...employee, ...data, gioCong, thuongNong, thuongERP, tongThuNhap, thuNhapDuKien, thuNhapThangTruoc, chenhLechThuNhap, hieuQuaQuyDoi, tyLeTraCham, pctPhuKien, pctGiaDung, pctMLN, pctSim, pctVAS, pctBaoHiem, donGiaTrungBinh, mucTieu: goalSettings };
        });
    },

    generateLuyKeChuaXuatReport(sourceYcxData) {
        if (!sourceYcxData || sourceYcxData.length === 0) return [];

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();
        const report = {};

        sourceYcxData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' &&
                                (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' &&
                                (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£' &&
                                (row.trangThaiXuat || "").trim() === 'Ch∆∞a xu·∫•t';

            if (isBaseValid && isDoanhThuHTX) {
                const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;
                if (isNaN(thanhTien) || isNaN(soLuong)) return;

                const nganhHangName = utils.cleanCategoryName(row.nganhHang);
                const heSo = heSoQuyDoi[row.nhomHang] || 1;

                if (!report[nganhHangName]) {
                    report[nganhHangName] = {
                        nganhHang: nganhHangName,
                        soLuong: 0,
                        doanhThuThuc: 0,
                        doanhThuQuyDoi: 0
                    };
                }

                report[nganhHangName].soLuong += soLuong;
                report[nganhHangName].doanhThuThuc += thanhTien;
                report[nganhHangName].doanhThuQuyDoi += thanhTien * heSo;
            }
        });

        return Object.values(report);
    },

    generateRealtimeChuaXuatReport(sourceRealtimeYcxData) {
        if (!sourceRealtimeYcxData || sourceRealtimeYcxData.length === 0) return [];

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();
        const report = {};

        sourceRealtimeYcxData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' &&
                                (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' &&
                                (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£' &&
                                (row.trangThaiXuat || "").trim() === 'Ch∆∞a xu·∫•t';

            if (isBaseValid && isDoanhThuHTX) {
                const thanhTien = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const soLuong = parseInt(String(row.soLuong || "0"), 10) || 0;
                if (isNaN(thanhTien) || isNaN(soLuong)) return;

                const nganhHangName = utils.cleanCategoryName(row.nganhHang);
                const heSo = heSoQuyDoi[row.nhomHang] || 1;

                if (!report[nganhHangName]) {
                    report[nganhHangName] = {
                        nganhHang: nganhHangName,
                        soLuong: 0,
                        doanhThuThuc: 0,
                        doanhThuQuyDoi: 0
                    };
                }

                report[nganhHangName].soLuong += soLuong;
                report[nganhHangName].doanhThuThuc += thanhTien;
                report[nganhHangName].doanhThuQuyDoi += thanhTien * heSo;
            }
        });

        return Object.values(report);
    },

    calculateDepartmentAverages(departmentName, reportData) {
        const departmentEmployees = reportData.filter(e => e.boPhan === departmentName);
        if (departmentEmployees.length === 0) return {};

        const totals = departmentEmployees.reduce((acc, curr) => {
            Object.keys(curr).forEach(key => {
                if (typeof curr[key] === 'number') acc[key] = (acc[key] || 0) + curr[key];
                if (key === 'qdc' && typeof curr[key] === 'object') {
                    if (!acc.qdc) acc.qdc = {};
                    for (const qdcKey in curr.qdc) {
                        if (!acc.qdc[qdcKey]) acc.qdc[qdcKey] = { sl: 0, dt: 0, dtqd: 0 };
                        acc.qdc[qdcKey].sl += curr.qdc[qdcKey].sl;
                        acc.qdc[qdcKey].dt += curr.qdc[qdcKey].dt;
                        acc.qdc[qdcKey].dtqd += curr.qdc[qdcKey].dtqd;
                    }
                }
            });
            return acc;
        }, {});

        const averages = {};
        for (const key in totals) {
            if (key !== 'qdc') averages[key] = totals[key] / departmentEmployees.length;
            else {
                averages.qdc = {};
                for (const qdcKey in totals.qdc) averages.qdc[qdcKey] = {
                    sl: totals.qdc[qdcKey].sl / departmentEmployees.length,
                    dt: totals.qdc[qdcKey].dt / departmentEmployees.length,
                    dtqd: totals.qdc[qdcKey].dtqd / departmentEmployees.length
                };
            }
        }
        return averages;
    },

    generateRealtimeEmployeeDetailReport(employeeMaNV, realtimeYCXData) {
        if (!employeeMaNV || !realtimeYCXData || realtimeYCXData.length === 0) return null;

        const employeeData = realtimeYCXData.filter(row => {
            const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
            return msnvMatch && msnvMatch[1].trim() === String(employeeMaNV);
        });

        if (employeeData.length === 0) return null;

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();

        const summary = {
            totalRealRevenue: 0,
            totalConvertedRevenue: 0,
            unexportedRevenue: 0
        };
        const byProductGroup = {};
        const byCustomer = {};

        employeeData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' && (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' && (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£';

            if (isDoanhThuHTX && isBaseValid) {
                const realRevenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const quantity = parseInt(String(row.soLuong || "0"), 10) || 0;
                const heSo = heSoQuyDoi[row.nhomHang] || 1;
                const convertedRevenue = realRevenue * heSo;
                const groupName = utils.cleanCategoryName(row.nhomHang || 'Kh√°c');
                const customerName = row.tenKhachHang || 'Kh√°ch l·∫ª';

                if ((row.trangThaiXuat || "").trim() === 'ƒê√£ xu·∫•t') {
                    summary.totalRealRevenue += realRevenue;
                    summary.totalConvertedRevenue += convertedRevenue;

                    if (!byProductGroup[groupName]) {
                        byProductGroup[groupName] = { name: groupName, quantity: 0, realRevenue: 0, convertedRevenue: 0 };
                    }
                    byProductGroup[groupName].quantity += quantity;
                    byProductGroup[groupName].realRevenue += realRevenue;
                    byProductGroup[groupName].convertedRevenue += convertedRevenue;

                    if (!byCustomer[customerName]) {
                        byCustomer[customerName] = { name: customerName, products: [], totalQuantity: 0 };
                    }
                    byCustomer[customerName].products.push({
                        productName: row.tenSanPham,
                        quantity: quantity,
                        realRevenue: realRevenue,
                        convertedRevenue: convertedRevenue,
                    });
                    byCustomer[customerName].totalQuantity += quantity;
                } else if ((row.trangThaiXuat || "").trim() === 'Ch∆∞a xu·∫•t') {
                    summary.unexportedRevenue += convertedRevenue;
                }
            }
        });

        summary.totalOrders = Object.keys(byCustomer).length;
        summary.bundledOrderCount = Object.values(byCustomer).filter(c => c.totalQuantity > 1).length;
        summary.conversionRate = summary.totalRealRevenue > 0 ? (summary.totalConvertedRevenue / summary.totalRealRevenue) - 1 : 0;

        return {
            summary,
            byProductGroup: Object.values(byProductGroup).sort((a, b) => b.realRevenue - a.realRevenue),
            byCustomer: Object.values(byCustomer)
        };
    },

    // === START: MODIFIED FUNCTION (v2.8) ===
    generateLuyKeEmployeeDetailReport(employeeMaNV, luykeYCXData) {
        if (!employeeMaNV || !luykeYCXData || luykeYCXData.length === 0) {
            return null;
        }

        const employeeData = luykeYCXData.filter(row => {
            const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
            return msnvMatch && msnvMatch[1].trim() === String(employeeMaNV);
        });

        if (employeeData.length === 0) {
            return null;
        }

        const hinhThucXuatTinhDoanhThu = dataProcessing.getHinhThucXuatTinhDoanhThu();
        const heSoQuyDoi = dataProcessing.getHeSoQuyDoi();

        const summary = {
            totalRealRevenue: 0,
            totalConvertedRevenue: 0,
            unexportedRevenue: 0, // Calculated from master data
        };
        const byProductGroup = {};
        const byCustomer = {};
        const categoryChartDataMap = {};

        // === START: NEW DATA FOR CHARTS/MODALS ===
        const dailyStats = {}; // For Task 1
        const unexportedDetails = {}; // For Task 4
        // === END: NEW DATA ===

        const employeeMasterData = appState.masterReportData.sknv.find(e => String(e.maNV) === String(employeeMaNV));
        if (employeeMasterData) {
            summary.unexportedRevenue = employeeMasterData.doanhThuChuaXuat || 0;
        }

        employeeData.forEach(row => {
            const isDoanhThuHTX = hinhThucXuatTinhDoanhThu.has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' &&
                                (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' &&
                                (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£';

            // === START: MODIFIED LOGIC (T√°ch 'ƒê√£ xu·∫•t' v√† 'Ch∆∞a xu·∫•t') ===
            if (isDoanhThuHTX && isBaseValid) {
                const realRevenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
                const quantity = parseInt(String(row.soLuong || "0"), 10) || 0;
                if(isNaN(realRevenue) || isNaN(quantity)) return;

                const heSo = heSoQuyDoi[row.nhomHang] || 1;
                const convertedRevenue = realRevenue * heSo;
                const groupName = utils.cleanCategoryName(row.nhomHang || 'Kh√°c');
                const customerName = row.tenKhachHang || 'Kh√°ch L·∫ª';
                const categoryName = utils.cleanCategoryName(row.nganhHang || 'Kh√°c');
                const productName = row.tenSanPham || 'Kh√¥ng r√µ'; // (Task 4)
                
                if ((row.trangThaiXuat || "").trim() === 'ƒê√£ xu·∫•t') {
                    // === START: EXISTING LOGIC (ƒê√£ xu·∫•t) ===
                    summary.totalRealRevenue += realRevenue;
                    summary.totalConvertedRevenue += convertedRevenue;

                    if (!byProductGroup[groupName]) {
                        byProductGroup[groupName] = { name: groupName, quantity: 0, realRevenue: 0, convertedRevenue: 0 };
                    }
                    byProductGroup[groupName].quantity += quantity;
                    byProductGroup[groupName].realRevenue += realRevenue;
                    byProductGroup[groupName].convertedRevenue += convertedRevenue;

                    if (!categoryChartDataMap[categoryName]) {
                        categoryChartDataMap[categoryName] = { name: categoryName, revenue: 0 };
                    }
                    categoryChartDataMap[categoryName].revenue += realRevenue;

                    if (!byCustomer[customerName]) {
                        byCustomer[customerName] = { name: customerName, products: [], totalQuantity: 0, totalRealRevenue: 0, totalConvertedRevenue: 0 };
                    }
                    byCustomer[customerName].products.push({
                        productName: row.tenSanPham,
                        quantity: quantity,
                        realRevenue: realRevenue,
                        convertedRevenue: convertedRevenue,
                    });
                    byCustomer[customerName].totalQuantity += quantity;
                    byCustomer[customerName].totalRealRevenue += realRevenue;
                    byCustomer[customerName].totalConvertedRevenue += convertedRevenue;
                    // === END: EXISTING LOGIC ===

                    // === START: NEW LOGIC (Task 1 - Daily Stats) ===
                    const ngayTao = row.ngayTao;
                    if (ngayTao instanceof Date) {
                        const dateString = ngayTao.toISOString().split('T')[0]; // 'YYYY-MM-DD'
                        if (!dailyStats[dateString]) {
                            dailyStats[dateString] = { date: ngayTao, revenue: 0, convertedRevenue: 0 };
                        }
                        dailyStats[dateString].revenue += realRevenue;
                        dailyStats[dateString].convertedRevenue += convertedRevenue;
                    }
                    // === END: NEW LOGIC (Task 1) ===

                } else if ((row.trangThaiXuat || "").trim() === 'Ch∆∞a xu·∫•t') {
                    // === START: NEW LOGIC (Task 4 - Unexported Details) ===
                    if (!unexportedDetails[groupName]) {
                        unexportedDetails[groupName] = { name: groupName, totalSL: 0, totalDTQD: 0, products: {} };
                    }
                    if (!unexportedDetails[groupName].products[productName]) {
                        unexportedDetails[groupName].products[productName] = { name: productName, sl: 0, dtqd: 0 };
                    }
                    unexportedDetails[groupName].products[productName].sl += quantity;
                    unexportedDetails[groupName].products[productName].dtqd += convertedRevenue;
                    unexportedDetails[groupName].totalSL += quantity;
                    unexportedDetails[groupName].totalDTQD += convertedRevenue;
                    // === END: NEW LOGIC (Task 4) ===
                }
            }
            // === END: MODIFIED LOGIC ===
        });

        // Final calculations for summary
        summary.totalOrders = Object.keys(byCustomer).length;
        summary.bundledOrderCount = Object.values(byCustomer).filter(c => c.products.length > 1).length;
        summary.conversionRate = summary.totalRealRevenue > 0 ? (summary.totalConvertedRevenue / summary.totalRealRevenue) - 1 : 0;

        // Final calculations for customers and product groups
        for (const customerName in byCustomer) {
            const customer = byCustomer[customerName];
            customer.conversionRate = customer.totalRealRevenue > 0 ? (customer.totalConvertedRevenue / customer.totalRealRevenue) - 1 : 0;
        }
        for (const groupName in byProductGroup) {
            const group = byProductGroup[groupName];
            group.conversionRate = group.realRevenue > 0 ? (group.convertedRevenue / group.realRevenue) - 1 : 0;
        }

        // Convert maps to arrays for returning
        const finalDailyStats = Object.values(dailyStats).sort((a, b) => a.date - b.date);
        const finalUnexportedDetails = Object.values(unexportedDetails)
            .map(group => ({
                ...group,
                products: Object.values(group.products).sort((a, b) => b.dtqd - a.dtqd)
            }))
            .sort((a, b) => b.totalDTQD - a.totalDTQD);

        return {
            summary,
            topProductGroups: Object.values(byProductGroup)
                .sort((a, b) => b.realRevenue - a.realRevenue)
                .slice(0, 8),
            categoryChartData: Object.values(categoryChartDataMap),
            byCustomer: Object.values(byCustomer)
                .sort((a,b) => b.totalRealRevenue - a.totalRealRevenue),
            // === START: NEW RETURN VALUES ===
            dailyStats: finalDailyStats, // For Task 1
            unexportedDetails: finalUnexportedDetails // For Task 4
            // === END: NEW RETURN VALUES ===
        };
    },
    // === END: MODIFIED FUNCTION ===

    generateRealtimeBrandReport(realtimeYCXData, selectedCategory, selectedBrand) {
        if (!realtimeYCXData || realtimeYCXData.length === 0) return { byBrand: [], byEmployee: [] };

        const filteredData = realtimeYCXData.filter(row => {
            const categoryMatch = !selectedCategory || utils.cleanCategoryName(row.nganhHang) === selectedCategory;
            const brandMatch = !selectedBrand || (row.nhaSanXuat || 'H√£ng kh√°c') === selectedBrand;
            const isDoanhThuHTX = dataProcessing.getHinhThucXuatTinhDoanhThu().has(row.hinhThucXuat);
            const isBaseValid = (row.trangThaiThuTien || "").trim() === 'ƒê√£ thu' && (row.trangThaiHuy || "").trim() === 'Ch∆∞a h·ªßy' && (row.tinhTrangTra || "").trim() === 'Ch∆∞a tr·∫£' && (row.trangThaiXuat || "").trim() === 'ƒê√£ xu·∫•t';

            return categoryMatch && brandMatch && isDoanhThuHTX && isBaseValid;
        });

        const byBrand = {};
        const byEmployee = {};

        filteredData.forEach(row => {
            const brand = row.nhaSanXuat || 'H√£ng kh√°c';
            const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/);
            const employeeId = msnvMatch ? msnvMatch[1].trim() : 'Unknown';
            const realRevenue = parseFloat(String(row.thanhTien || "0").replace(/,/g, '')) || 0;
            const quantity = parseInt(String(row.soLuong || "0"), 10) || 0;

            if (!byBrand[brand]) {
                byBrand[brand] = { name: brand, quantity: 0, revenue: 0 };
            }
            byBrand[brand].quantity += quantity;
            byBrand[brand].revenue += realRevenue;

            if (!byEmployee[employeeId]) {
                const employeeInfo = appState.employeeMaNVMap.get(employeeId);
                byEmployee[employeeId] = { id: employeeId, name: employeeInfo ? employeeInfo.hoTen : `NV ${employeeId}`, quantity: 0, revenue: 0 };
            }
            byEmployee[employeeId].quantity += quantity;
            byEmployee[employeeId].revenue += realRevenue;
        });

        const brandArray = Object.values(byBrand).map(b => ({...b, avgPrice: b.quantity > 0 ? b.revenue / b.quantity : 0})).sort((a,b) => b.revenue - a.revenue);
        const employeeArray = Object.values(byEmployee).sort((a,b) => b.revenue - a.revenue);

        return { byBrand: brandArray, byEmployee: employeeArray };
    },
};

const composerServices = {
    getEmployeeRanking(reportData, key, direction = 'desc', count = 3, department = 'ALL') {
        if (!reportData || reportData.length === 0) return [];

        let filteredData = reportData;
        if (department !== 'ALL') {
            filteredData = reportData.filter(e => e.boPhan === department);
        }

        return [...filteredData]
            .filter(e => e[key] > 0)
            .sort((a, b) => direction === 'desc' ? (b[key] || 0) - (a[key] || 0) : (a[key] || 0) - (b[key] || 0))
            .slice(0, count);
    },

    getEmployeesBelowTarget(reportData, dataKey, goalKey, department = 'ALL') {
        if (!reportData || reportData.length === 0) return [];

        let filteredData = reportData;
        if (department !== 'ALL') {
            filteredData = reportData.filter(e => e.boPhan === department);
        }

        return filteredData.filter(employee => {
            const value = employee[dataKey] || 0;
            const target = (employee.mucTieu?.[goalKey] || 0) / 100;
            return target > 0 && value < target;
        }).sort((a, b) => (b[dataKey] || 0) - (a[dataKey] || 0));
    },

    formatEmployeeList(employeeArray, valueKey, valueType = 'number') {
        if (!Array.isArray(employeeArray) || employeeArray.length === 0) {
            return " (kh√¥ng c√≥)";
        }
        return "\n" + employeeArray.map((e, index) => {
            const value = e[valueKey];
            let formattedValue = '';
            if (valueType === 'percent') {
                formattedValue = ui.formatPercentage(value);
            } else if (valueType === 'currency') {
                formattedValue = ui.formatRevenue(value) + " tr";
            } else {
                 formattedValue = ui.formatNumberOrDash(value);
            }
            return `${index + 1}. ${ui.getShortEmployeeName(e.hoTen, e.maNV)}: ${formattedValue} @${e.maNV}`;
        }).join("\n");
    },

    processComposerTemplate(template, supermarketReport, goals, rankingReportData, competitionData, sectionId) {
        if (!template || !supermarketReport || !goals) {
            return "L·ªói: D·ªØ li·ªáu kh√¥ng ƒë·ªß ƒë·ªÉ t·∫°o nh·∫≠n x√©t.";
        }

        const tagMapping = {
            'DTQD': { key: 'doanhThuQuyDoi', format: 'currency' },
            'THUNHAP': { key: 'tongThuNhap', format: 'currency' },
            'TLQD': { key: 'hieuQuaQuyDoi', format: 'percent' },
        };

        const botTargetMapping = {
            'TLQD': { dataKey: 'hieuQuaQuyDoi', goalKey: 'phanTramQD', format: 'percent' },
            'TLTC': { dataKey: 'tyLeTraCham', goalKey: 'phanTramTC', format: 'percent' },
            'PK': { dataKey: 'pctPhuKien', goalKey: 'phanTramPhuKien', format: 'percent' },
            'GD': { dataKey: 'pctGiaDung', goalKey: 'phanTramGiaDung', format: 'percent' },
            'MLN': { dataKey: 'pctMLN', goalKey: 'phanTramMLN', format: 'percent' },
            'SIM': { dataKey: 'pctSim', goalKey: 'phanTramSim', format: 'percent' },
            'VAS': { dataKey: 'pctVAS', goalKey: 'phanTramVAS', format: 'percent' },
            'BH': { dataKey: 'pctBaoHiem', goalKey: 'phanTramBaoHiem', format: 'percent' },
        };

        return template.replace(/\[(.*?)\]/g, (match, tag) => {
            const now = new Date();
            const currentDay = now.getDate() || 1;

            let dtThuc = supermarketReport.doanhThu || 0;
            let dtQd = supermarketReport.doanhThuQuyDoi || 0;
            let phanTramHTQD = goals.doanhThuQD > 0 ? (dtQd / 1000000) / goals.doanhThuQD : 0;

            if (sectionId === 'luyke') {
                const pastedLuyKeData = dataProcessing.parseLuyKePastedData(document.getElementById('paste-luyke')?.value || '');
                if (pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DT th·ª±c']) {
                    dtThuc = parseFloat(pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DT th·ª±c'].replace(/,/g, '')) * 1000000;
                }
                if (pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DTQƒê']) {
                    dtQd = parseFloat(pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DTQƒê'].replace(/,/g, '')) * 1000000;
                }
                if (pastedLuyKeData.mainKpis['% HT Target D·ª± Ki·∫øn (Qƒê)']) {
                    phanTramHTQD = (parseFloat(pastedLuyKeData.mainKpis['% HT Target D·ª± Ki·∫øn (Qƒê)'].replace('%', '')) || 0) / 100;
                }
            }

            if (tag === 'NGAY') return now.toLocaleDateString('vi-VN');
            if (tag === 'GIO') return now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            if (tag === 'DT_THUC') return ui.formatNumber(dtThuc / 1000000, 0) + " tr";
            if (tag === 'DTQD') return ui.formatNumber(dtQd / 1000000, 0) + " tr";
            if (tag === '%HT_DTQD') return ui.formatPercentage(phanTramHTQD);

            if (tag === 'TLQD') {
                if (sectionId === 'luyke') {
                    const pastedLuyKeData = dataProcessing.parseLuyKePastedData(document.getElementById('paste-luyke')?.value || '');
                    if (pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DT th·ª±c'] && pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DTQƒê']) {
                        const dtThucPasted = parseFloat(String(pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DT th·ª±c']).replace(/,/g, ''));
                        const dtQdPasted = parseFloat(String(pastedLuyKeData.mainKpis['Th·ª±c hi·ªán DTQƒê']).replace(/,/g, ''));
                        if (dtThucPasted > 0) {
                            return ui.formatPercentage((dtQdPasted / dtThucPasted) - 1);
                        }
                    }
                }
                return ui.formatPercentage(supermarketReport.hieuQuaQuyDoi || 0);
            }

            if (tag === '%HT_DTT') {
                const target = parseFloat(goals.doanhThuThuc) || 0;
                const percent = target > 0 ? (dtThuc / 1000000) / target : 0;
                return ui.formatPercentage(percent);
            }
            if (tag === 'DT_CHUAXUAT') return ui.formatRevenue(supermarketReport.doanhThuQuyDoiChuaXuat || 0) + " tr";
            if (tag === 'SS_CUNGKY') return supermarketReport.comparisonData?.percentage || 'N/A';

            if (tag.startsWith('TD_')) {
                const total = competitionData?.length || 0;
                const dat = (competitionData || []).filter(d => parseFloat(String(d.hoanThanh).replace('%','')) >= 100).length;
                if (tag === 'TD_TONG_CT') return total;
                if (tag === 'TD_CT_DAT') return dat;
                if (tag === 'TD_CT_CHUADAT') return total - dat;
                if (tag === 'TD_TYLE_DAT') return total > 0 ? ui.formatPercentage(dat / total) : '0%';
            }

            if (tag === 'TOP_QDC_INFO') {
                if (!supermarketReport.qdc) return " (kh√¥ng c√≥)";
                const qdcArray = Object.values(supermarketReport.qdc).filter(item => item.sl > 0);
                const sortedQDC = qdcArray.sort((a,b) => b.dtqd - a.dtqd);
                return "\n" + sortedQDC.map(item => `  ‚Ä¢ ${item.name}: SL ${ui.formatNumber(item.sl)}, TB ${ui.formatNumber(item.sl / currentDay, 1)}/ng√†y`).join("\n");
            }
            if (tag === 'TOP_NGANHHANG_SL') {
                if (!supermarketReport.nganhHangChiTiet) return " (kh√¥ng c√≥)";
                const nganhHangArray = Object.values(supermarketReport.nganhHangChiTiet).filter(item => item.quantity > 0);
                const topNganhHang = nganhHangArray.sort((a,b) => b.quantity - a.quantity).slice(0, 10);
                return "\n" + topNganhHang.map(item => `  ‚Ä¢ ${utils.cleanCategoryName(item.name)}: ${ui.formatNumber(item.quantity)}`).join("\n");
            }

            const rankingRegex = /^(TOP|BOT)(\d)_(\w+)_([\s\S]+)$/;
            const rankingMatch = tag.match(rankingRegex);
            if (rankingMatch && rankingReportData) {
                const [_, type, count, metric, department] = rankingMatch;
                const cleanDepartment = department.replace(/@msnv$/, '').trim();
                const direction = type === 'TOP' ? 'desc' : 'asc';
                const metricInfo = tagMapping[metric];
                if (metricInfo) {
                    let dataForRanking = rankingReportData;
                    if (metric === 'THUNHAP' && appState.masterReportData.sknv.length > 0) {
                        dataForRanking = appState.masterReportData.sknv;
                    }
                    const ranking = composerServices.getEmployeeRanking(dataForRanking, metricInfo.key, direction, parseInt(count), cleanDepartment);
                    return composerServices.formatEmployeeList(ranking, metricInfo.key, metricInfo.format);
                }
            }

            const botTargetRegex = /^BOT_TARGET_(\w+)_([\s\S]+)$/;
            const botTargetMatch = tag.match(botTargetRegex);
            if(botTargetMatch && rankingReportData) {
                let [_, metric, department] = botTargetMatch;
                department = department.replace(/@msnv$/, '').trim();
                const metricInfo = botTargetMapping[metric];
                if (metricInfo) {
                    const employeeList = composerServices.getEmployeesBelowTarget(rankingReportData, metricInfo.dataKey, metricInfo.goalKey, department);
                    return composerServices.formatEmployeeList(employeeList, metricInfo.dataKey, metricInfo.format);
                }
            }

            const qdcInfoRegex = /^QDC_INFO_(.+)$/;
            const qdcMatch = tag.match(qdcInfoRegex);
            if(qdcMatch && supermarketReport.qdc){
                const itemName = qdcMatch[1];
                const itemData = Object.values(supermarketReport.qdc).find(i => i.name === itemName);
                return itemData ? `SL ${ui.formatNumber(itemData.sl)}, TB ${ui.formatNumber(itemData.sl / currentDay, 1)}/ng√†y` : '(N/A)';
            }

            const nhInfoRegex = /^NH_INFO_(.+)$/;
            const nhMatch = tag.match(nhInfoRegex);
            if(nhMatch && supermarketReport.nganhHangChiTiet){
                const itemName = nhMatch[1];
                 const itemData = Object.values(supermarketReport.nganhHangChiTiet).find(i => utils.cleanCategoryName(i.name) === itemName);
                return itemData ? `SL ${ui.formatNumber(itemData.quantity)}, TB ${ui.formatNumber(itemData.quantity / currentDay, 1)}/ng√†y` : '(N/A)';
            }

            return match;
        });
    },

    aggregateReport(reportData, selectedWarehouse = null) {
        if (!reportData || reportData.length === 0) {
            const emptyShell = { doanhThu: 0, doanhThuQuyDoi: 0, dtCE: 0, dtICT: 0, qdc: {}, nganhHangChiTiet: {}, comparisonData: { value: 0, percentage: 'N/A' } };
            const numericKeys = ['doanhThuTraGop', 'doanhThuChuaXuat','doanhThuQuyDoiChuaXuat', 'dtGiaDung', 'dtMLN', 'dtPhuKien', 'slSmartphone', 'slSimOnline', 'slUDDD', 'slBaoHiemDenominator', 'slBaoHiemVAS'];
            numericKeys.forEach(key => emptyShell[key] = 0);
            return emptyShell;
        }

        const supermarketReport = reportData.reduce((acc, curr) => {
            for (const key in curr) {
                if (typeof curr[key] === 'number') {
                    acc[key] = (acc[key] || 0) + curr[key];
                } else if (key === 'qdc' && typeof curr.qdc === 'object') {
                    if (!acc.qdc) acc.qdc = {};
                    for (const qdcKey in curr.qdc) {
                        if (!acc.qdc[qdcKey]) acc.qdc[qdcKey] = { sl: 0, dt: 0, dtqd: 0, name: curr.qdc[qdcKey].name };
                        acc.qdc[qdcKey].sl += curr.qdc[qdcKey].sl;
                        acc.qdc[qdcKey].dt += curr.qdc[qdcKey].dt;
                        acc.qdc[qdcKey].dtqd += curr.qdc[qdcKey].dtqd;
                    }
                }
            }
            acc.maKho = selectedWarehouse || '';
            return acc;
        }, {});

        const aggregatedNganhHang = {};
        reportData.forEach(employee => {
            if (employee.doanhThuTheoNganhHang) {
                Object.entries(employee.doanhThuTheoNganhHang).forEach(([name, values]) => {
                    if (!aggregatedNganhHang[name]) aggregatedNganhHang[name] = { name: name, quantity: 0, revenue: 0, revenueQuyDoi: 0, donGia: 0 };
                    aggregatedNganhHang[name].quantity += values.quantity;
                    aggregatedNganhHang[name].revenue += values.revenue;
                    aggregatedNganhHang[name].revenueQuyDoi += values.revenueQuyDoi;
                });
            }
        });
        for (const name in aggregatedNganhHang) {
            const item = aggregatedNganhHang[name];
            item.donGia = item.quantity > 0 ? item.revenue / item.quantity : 0;
        }
        supermarketReport.nganhHangChiTiet = aggregatedNganhHang;

        supermarketReport.hieuQuaQuyDoi = supermarketReport.doanhThu > 0 ? (supermarketReport.doanhThuQuyDoi / supermarketReport.doanhThu) - 1 : 0;
        supermarketReport.tyLeTraCham = supermarketReport.doanhThu > 0 ? supermarketReport.doanhThuTraGop / supermarketReport.doanhThu : 0;
        supermarketReport.pctGiaDung = supermarketReport.dtCE > 0 ? supermarketReport.dtGiaDung / supermarketReport.dtCE : 0;
        supermarketReport.pctMLN = supermarketReport.dtCE > 0 ? supermarketReport.dtMLN / supermarketReport.dtCE : 0;
        supermarketReport.pctPhuKien = supermarketReport.dtICT > 0 ? supermarketReport.dtPhuKien / supermarketReport.dtICT : 0;
        supermarketReport.pctSim = supermarketReport.slSmartphone > 0 ? supermarketReport.slSimOnline / supermarketReport.slSmartphone : 0;
        supermarketReport.pctVAS = supermarketReport.slSmartphone > 0 ? supermarketReport.slUDDD / supermarketReport.slSmartphone : 0;
        supermarketReport.pctBaoHiem = supermarketReport.slBaoHiemDenominator > 0 ? supermarketReport.slBaoHiemVAS / supermarketReport.slBaoHiemDenominator : 0;

        const pastedLuyKeData = dataProcessing.parseLuyKePastedData(document.getElementById('paste-luyke')?.value || '');
        supermarketReport.comparisonData = pastedLuyKeData.comparisonData;

        if (supermarketReport.qdc) {
            for (const key in supermarketReport.qdc) {
                const group = supermarketReport.qdc[key];
                group.donGia = group.sl > 0 ? group.dt / group.sl : 0;
            }
        }

        return supermarketReport;
    },

    getSupermarketReportFromPastedData(pastedData) {
        const cleanValue = (str) => (typeof str === 'string' ? parseFloat(str.replace(/,|%/g, '')) : (typeof str === 'number' ? str : 0));
        return {
            doanhThu: cleanValue(pastedData.mainKpis['Th·ª±c hi·ªán DT th·ª±c']) * 1000000,
            doanhThuQuyDoi: cleanValue(pastedData.mainKpis['Th·ª±c hi·ªán DTQƒê']) * 1000000,
            pastedHTQD: pastedData.mainKpis['% HT Target D·ª± Ki·∫øn (Qƒê)'] || 'N/A',
            comparisonData: pastedData.comparisonData,
        };
    },

    updateEmployeeMaps() {
        appState.employeeMaNVMap.clear();
        appState.employeeNameToMaNVMap.clear();
        appState.danhSachNhanVien.forEach(nv => {
            if (nv.maNV) appState.employeeMaNVMap.set(String(nv.maNV).trim(), nv);
            if (nv.hoTen) appState.employeeNameToMaNVMap.set(nv.hoTen.toLowerCase().replace(/\s+/g, ' '), String(nv.maNV).trim());
        });
    },

    generateThiDuaVungReport(selectedSupermarket) {
        if (!selectedSupermarket || !appState.thiDuaVungChiTiet || appState.thiDuaVungChiTiet.length === 0 || !appState.thiDuaVungTong || appState.thiDuaVungTong.length === 0) {
            return null;
        }

        const findKey = (data, keyword) => {
            if (!data || data.length === 0) return null;
            return Object.keys(data[0]).find(k => k.trim().toLowerCase().includes(keyword.toLowerCase())) || keyword;
        };
        const supermarketKeyTong = findKey(appState.thiDuaVungTong, 'si√™u th·ªã');
        const supermarketKeyChiTiet = findKey(appState.thiDuaVungChiTiet, 'si√™u th·ªã');
        const tongThuongKey = findKey(appState.thiDuaVungChiTiet, 't·ªïng th∆∞·ªüng');
        const hangVuotTroiKey = findKey(appState.thiDuaVungChiTiet, 'h·∫°ng v∆∞·ª£t tr·ªôi');
        const hangTargetKey = findKey(appState.thiDuaVungChiTiet, 'h·∫°ng % target');
        const layTopKey = findKey(appState.thiDuaVungChiTiet, 'l·∫•y top');
        const kenhKey = findKey(appState.thiDuaVungChiTiet, 'k√™nh');
        const nganhHangKey = findKey(appState.thiDuaVungChiTiet, 'ng√†nh h√†ng');

        if (!supermarketKeyTong || !supermarketKeyChiTiet) {
            console.error("Kh√¥ng th·ªÉ t√¨m th·∫•y c·ªôt 'si√™u th·ªã' trong d·ªØ li·ªáu.");
            return null;
        }

        const summary = appState.thiDuaVungTong.find(row => row[supermarketKeyTong] === selectedSupermarket);
        if (!summary) return null;

        const chiTiet = appState.thiDuaVungChiTiet.filter(row => row[supermarketKeyChiTiet] === selectedSupermarket);

        if (chiTiet.length > 0 && layTopKey) {
            summary.hangCoGiaiKenh = chiTiet[0][layTopKey];
        } else {
            summary.hangCoGiaiKenh = 'N/A';
        }

        const report = { summary, coGiai: [], sapCoGiai: [], tiemNang: [], canCoGangNhieu: [] };

        const getPotentialPrize = (kenh, nganhHang) => {
            const winningSupermarkets = appState.thiDuaVungChiTiet.filter(sm =>
                sm[kenhKey] === kenh && sm[nganhHangKey] === nganhHang && sm[tongThuongKey] > 0
            );
            if (winningSupermarkets.length === 0) return 0;
            return Math.min(...winningSupermarkets.map(s => s[tongThuongKey]));
        };

        chiTiet.forEach(nganhHang => {
            if (nganhHang[tongThuongKey] > 0) {
                report.coGiai.push(nganhHang);
            } else {
                const hangVuotTroi = nganhHang[hangVuotTroiKey] || Infinity;
                const hangTarget = nganhHang[hangTargetKey] || Infinity;
                const hangCoGiai = nganhHang[layTopKey] || 0;

                const khoangCach = Math.min(
                    (hangVuotTroi > 0 && hangVuotTroi > hangCoGiai) ? hangVuotTroi - hangCoGiai : Infinity,
                    (hangTarget > 0 && hangTarget > hangCoGiai) ? hangTarget - hangCoGiai : Infinity
                );
                nganhHang.khoangCach = khoangCach;

                if (hangCoGiai > 0 && khoangCach <= 20) {
                    nganhHang.thuongTiemNang = getPotentialPrize(nganhHang[kenhKey], nganhHang[nganhHangKey]);
                    report.sapCoGiai.push(nganhHang);
                } else if (hangCoGiai > 0 && khoangCach > 20 && khoangCach <= 40) {
                    report.tiemNang.push(nganhHang);
                } else {
                    report.canCoGangNhieu.push(nganhHang);
                }
            }
        });

        report.coGiai.sort((a, b) => b[tongThuongKey] - a[tongThuongKey]);
        report.sapCoGiai.sort((a, b) => a.khoangCach - b.khoangCach);
        report.tiemNang.sort((a, b) => a.khoangCach - b.khoangCach);

        return report;
    }
};

const services = {
    ...dataProcessing,
    ...reportGeneration,
    ...composerServices
};

export { services };
--- END FILE: ./services.js ---

--- START FILE: ./state.js ---
// Version 3.2 - Add globalCompetitionConfigs for Firestore sync
// Version 3.1 - Add sort state for pasted competition detail table
// Version 3.0 - Add competitionNameMappings and pastedThiDuaReportData
// Version 2.8 - Merged features: Add warehouse state, user stats sort, and listener
// MODULE 2: T·ª¶ TR·∫†NG TH√ÅI (APPSTATE)
// File n√†y ch·ª©a ƒë·ªëi t∆∞·ª£ng tr·∫°ng th√°i chung c·ªßa ·ª©ng d·ª•ng, ho·∫°t ƒë·ªông nh∆∞ m·ªôt "b·ªô nh·ªõ".

const appState = {
    // --- Collaboration & Dynamic Content ---
    db: null,
    isAdmin: false,
    feedbackList: [],
    helpContent: {
        data: 'ƒêang t·∫£i h∆∞·ªõng d·∫´n...',
        luyke: 'ƒêang t·∫£i h∆∞·ªõng d·∫´n...',
        sknv: 'ƒêang t·∫£i h∆∞·ªõng d·∫´n...',
        realtime: 'ƒêang t·∫£i h∆∞·ªõng d·∫´n...'
    },
    composerTemplates: {
        luyke: '',
        sknv: '',
        realtime: ''
    },
    // *** NEW (v3.0) ***
    competitionNameMappings: {}, // L∆∞u tr·ªØ { "T√™n G·ªëc": "T√™n R√∫t G·ªçn" }
    // *** END NEW ***

    // --- D·ªØ li·ªáu & Tr·∫°ng th√°i ---
    selectedWarehouse: null, // <<< GIAI ƒêO·∫†N 1
    unsubscribeDataListener: null, // <<< GIAI ƒêO·∫†N 2
    danhSachNhanVien: [],
    categoryStructure: [],
    brandList: [], // Master list of all brands

    // === START: D·ªÆ LI·ªÜU KHAI B√ÅO T√çNH TO√ÅN (ƒê·ªíNG B·ªò T·ª™ CLOUD) ===
    declarations: {
        hinhThucXuat: '',
        hinhThucXuatGop: '',
        heSoQuyDoi: ''
    },
    // === END: D·ªÆ LI·ªÜU KHAI B√ÅO T√çNH TO√ÅN ===

    // D·ªØ li·ªáu c·∫≠p nh·∫≠t h√†ng ng√†y
    ycxData: [],
    rawGioCongData: [],
    thuongNongData: [],
    thuongERPData: [],
    thiDuaNhanVienData: [], // D·ªØ li·ªáu c≈© (t·ª´ logic khai b√°o m·ª•c ti√™u)
    thiDuaVungChiTiet: [],
    thiDuaVungTong: [],

    // *** NEW (v3.0) ***
    pastedThiDuaReportData: [], // L∆∞u k·∫øt qu·∫£ x·ª≠ l√Ω t·ª´ √¥ d√°n "Thi ƒëua nh√¢n vi√™n"
    // *** END NEW ***

    thiDuaReportData: [],

    // D·ªØ li·ªáu c·∫≠p nh·∫≠t th√°ng tr∆∞·ªõc
    ycxDataThangTruoc: [],
    thuongNongDataThangTruoc: [],
    thuongERPDataThangTruoc: [],

    masterReportData: {
        luyke: [],
        sknv: [],
        realtime: []
    },
    
    // === START REFACTOR 2 (B∆∞·ªõc 2a) ===
    localCompetitionConfigs: [], // ƒê·ªïi t√™n t·ª´ competitionConfigs (L∆∞u tr√™n localStorage)
    globalCompetitionConfigs: [], // Config chung do Admin t·∫°o (L∆∞u tr√™n Firestore)
    // === END REFACTOR 2 ===
    
    realtimeYCXData: [],
    luykeGoalSettings: {},
    realtimeGoalSettings: {},
    highlightSettings: {
        luyke: {},
        sknv: {},
        realtime: {}
    },
    debugInfo: {},
    employeeMaNVMap: new Map(),
    employeeNameToMaNVMap: new Map(),
    charts: {},
    choices: {
        luyke_employee: null, luyke_date_picker: null, luyke_highlight_nhanhang: null, luyke_highlight_nhomhang: null, luyke_highlight_employee: null,
        sknv_employee: null, sknv_date_picker: null, sknv_highlight_nhanhang: null, sknv_highlight_nhomhang: null, sknv_highlight_employee: null,
        realtime_employee: null, realtime_highlight_nhanhang: null, realtime_highlight_nhomhang: null, realtime_highlight_employee: null,
        thiDuaVung_sieuThi: null,
        competition_group: null,
        competition_brand: null,
    },
    sortState: {
        user_stats: { key: 'lastLogin', direction: 'desc' }, // <<< GIAI ƒêO·∫†N 4
        luyke_chuaxuat: { key: 'doanhThuQuyDoi', direction: 'desc' },
        sknv_summary: { key: 'totalAbove', direction: 'desc' },
        doanhthu_lk: { key: 'doanhThu', direction: 'desc' },
        thunhap: { key: 'tongThuNhap', direction: 'desc' },
        hieu_qua: { key: 'dtICT', direction: 'desc' },
        sknv_ict: { key: 'dtICT', direction: 'desc' },
        sknv_phukien: { key: 'dtPhuKien', direction: 'desc' },
        sknv_giadung: { key: 'dtGiaDung', direction: 'desc' },
        sknv_ce: { key: 'dtCE', direction: 'desc' },
        sknv_baohiem: { key: 'dtBaoHiem', direction: 'desc' },
        sknv_nganhhang_chitiet: { key: 'revenue', direction: 'desc' },
        sknv_qdc: { key: 'dtqd', direction: 'desc' },
        sknv_thidua_summary: { key: 'completedCount', direction: 'desc'},
        sknv_thidua_category: { key: 'percentExpected', direction: 'desc'},
        sknv_thidua_employee: { key: 'percentExpected', direction: 'desc'},
        // *** NEW (v3.0) ***
        sknv_thidua_pasted: { key: 'hoTen', direction: 'asc' }, // S·∫Øp x·∫øp cho b·∫£ng thi ƒëua d√°n v√†o
        // === START: Y√äU C·∫¶U 2 (v3.1) ===
        sknv_thidua_pasted_detail: { key: 'name', direction: 'asc' }, // S·∫Øp x·∫øp cho b·∫£ng chi ti·∫øt thi ƒëua
        // === END: Y√äU C·∫¶U 2 (v3.1) ===
        // *** END NEW ***
        luyke_competition_doanhthu: { key: 'hoanThanh', direction: 'desc' },
        luyke_competition_soluong: { key: 'hoanThanh', direction: 'desc' },
        luyke_nganhhang: { key: 'revenue', direction: 'desc' },
        luyke_qdc: { key: 'dtqd', direction: 'desc' },
        realtime_nganhhang: { key: 'revenue', direction: 'desc' },
        realtime_dt_nhanvien: { key: 'doanhThu', direction: 'desc' },
        realtime_hieuqua_nhanvien: { key: 'dtICT', direction: 'desc' },
        realtime_ict: { key: 'dtICT', direction: 'desc' },
        realtime_phukien: { key: 'dtPhuKien', direction: 'desc' },
        realtime_giadung: { key: 'dtGiaDung', direction: 'desc' },
        realtime_ce: { key: 'dtCE', direction: 'desc' },
        realtime_baohiem: { key: 'dtBaoHiem', direction: 'desc' },
        realtime_qdc: { key: 'dtqd', direction: 'desc' },
        realtime_brand: { key: 'revenue', direction: 'desc' },
        realtime_brand_employee: { key: 'revenue', direction: 'desc' }
    }
};

// Xu·∫•t kh·∫©u appState ƒë·ªÉ c√°c module kh√°c c√≥ th·ªÉ s·ª≠ d·ª•ng
export { appState };
--- END FILE: ./state.js ---

--- START FILE: ./styles/base.css ---
/* Version 1.0 - Base styles (Refactored from v6.19) */
/* Ch·ª©a c√°c thi·∫øt l·∫≠p n·ªÅn t·∫£ng: fonts, :root variables, body, scrollbar */

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
    --global-font-size: 18px;
    --kpi-main-font-size: 36px;
    --bg-lightness-1: 98%; --header-lightness-1: 96%; --header-text-lightness-1: 25%; --special-header-lightness-1: 92%; --below-target-lightness-1: 96%;
    --bg-lightness-2: 96%; --header-lightness-2: 94%; --header-text-lightness-2: 22%; --special-header-lightness-2: 88%; --below-target-lightness-2: 94%;
    --bg-lightness-3: 94%; --header-lightness-3: 92%; --header-text-lightness-3: 18%; --special-header-lightness-3: 85%; --below-target-lightness-3: 92%; /* Normal */
    --bg-lightness-4: 92%; --header-lightness-4: 88%; --header-text-lightness-4: 15%; --special-header-lightness-4: 80%; --below-target-lightness-4: 88%;
    --bg-lightness-5: 90%; --header-lightness-5: 84%; --header-text-lightness-5: 12%; --special-header-lightness-5: 75%; --below-target-lightness-5: 84%;
    --bg-lightness-6: 88%; --header-lightness-6: 80%; --header-text-lightness-6: 10%; --special-header-lightness-6: 70%; --below-target-lightness-6: 80%;
    --kpi-card-1-bg: #38bdf8;
    --kpi-card-2-bg: #34d399; --kpi-card-3-bg: #fbbf24;
    --kpi-card-4-bg: #2dd4bf; --kpi-card-5-bg: #a78bfa; --kpi-card-6-bg: #f472b6;
    --kpi-card-7-bg: #818cf8;
    --kpi-card-8-bg: #f87171;
    --kpi-title-color: #ffffff;
    --kpi-main-color: #ffffff;
    --kpi-sub-color: #ffffff;
}

body {
    font-family: 'Inter', sans-serif;
    background-color: #f3f4f6;
    font-size: var(--global-font-size);
}

html[data-contrast="1"] { --bg-lightness: var(--bg-lightness-1); --header-lightness: var(--header-lightness-1); --header-text-lightness: var(--header-text-lightness-1); --special-header-lightness: var(--special-header-lightness-1); --below-target-lightness: var(--below-target-lightness-1); }
html[data-contrast="2"] { --bg-lightness: var(--bg-lightness-2); --header-lightness: var(--header-lightness-2); --header-text-lightness: var(--header-text-lightness-2); --special-header-lightness: var(--special-header-lightness-2); --below-target-lightness: var(--below-target-lightness-2); }
html[data-contrast="3"] { --bg-lightness: var(--bg-lightness-3); --header-lightness: var(--header-lightness-3); --header-text-lightness: var(--header-text-lightness-3); --special-header-lightness: var(--special-header-lightness-3);
--below-target-lightness: var(--below-target-lightness-3); }
html[data-contrast="4"] { --bg-lightness: var(--bg-lightness-4); --header-lightness: var(--header-lightness-4); --header-text-lightness: var(--header-text-lightness-4); --special-header-lightness: var(--special-header-lightness-4); --below-target-lightness: var(--below-target-lightness-4); }
html[data-contrast="5"] { --bg-lightness: var(--bg-lightness-5); --header-lightness: var(--header-lightness-5); --header-text-lightness: var(--header-text-lightness-5); --special-header-lightness: var(--special-header-lightness-5); --below-target-lightness: var(--below-target-lightness-5); }
html[data-contrast="6"] { --bg-lightness: var(--bg-lightness-6); --header-lightness: var(--header-lightness-6); --header-text-lightness: var(--header-text-lightness-6); --special-header-lightness: var(--special-header-lightness-6); --below-target-lightness: var(--below-target-lightness-6); }


::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: #555; }

.feather {
    width: 1.1rem;
    height: 1.1rem;
    stroke-width: 1.5;
    flex-shrink: 0;
}
--- END FILE: ./styles/base.css ---

--- START FILE: ./styles/components.css ---
/* Version 1.7 - Add data-section themes & fix layout issues */
/* Ch·ª©a c√°c class t√°i s·ª≠ d·ª•ng cho c√°c "linh ki·ªán" UI: buttons, cards, modals, inputs, etc. */

.nav-link,
.action-btn,
.kpi-card,
.content-card,
.tdv-item-card,
.data-input-group,
.toggle-filters-btn,
.page-header__help-btn,
.column-toggle-btn,
.rt-infographic-summary-card { /* <-- S·ª¨A ƒê·ªîI: Th√™m th·∫ª KPI */
    transition: all 0.2s ease-in-out;
}

/* === 
B·∫ÆT ƒê·∫¶U: N√ÇNG C·∫§P UI CHO SUB-TAB (V5.9) === */
.sub-tab-btn {
    border-bottom: 3px solid transparent;
    padding: 0.75rem 0.5rem;
    transition: all 0.2s ease-in-out;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}
.sub-tab-btn:not(.active):hover {
    background-color: #f3f4f6;
    border-bottom-color: #d1d5db;
    transform: translateY(-2px);
}
.sub-tab-btn.active {
    border-color: #3b82f6;
    color: #2563eb;
    background-color: transparent;
}
.sub-tab-btn .feather {
    width: 1.2rem;
    height: 1.2rem;
    stroke-width: 2.5;
    transition: all 0.2s ease-in-out;
}
.sub-tab-btn.active .feather {
  color: white;
    background-color: #3b82f6;
    border-radius: 9999px;
    padding: 4px;
}
/* T√¥ m√†u icon theo t·ª´ng tab */
.sub-tab-btn[data-title*="SieuThi"].active .feather,
.sub-tab-btn[data-title*="Vung"].active .feather { background-color: #3b82f6; } /* Blue */

.sub-tab-btn[data-title*="SKNV"].active .feather,
.sub-tab-btn[data-title*="ThuNhap"].active .feather,
.sub-tab-btn[data-title*="DoanhThuLK"].active .feather,
.sub-tab-btn[data-title*="DTNVRealtime"].active .feather { background-color: #16a34a; } /* Green */

.sub-tab-btn[data-title*="ThiDua"].active .feather { background-color: #8b5cf6; } /* Violet */

.sub-tab-btn[data-title*="HieuQua"].active .feather,
.sub-tab-btn[data-title*="NganhHang"].active .feather,
.sub-tab-btn[data-title*="HangRealtime"].active .feather { background-color: #f97316; } /* Orange */
/* === K·∫æT TH√öC: N√ÇNG C·∫§P UI CHO SUB-TAB === */


.nav-link:hover,
.action-btn:hover,
.kpi-card:hover,
.content-card:hover,
.data-input-group:hover,
.toggle-filters-btn:hover,
.rt-infographic-summary-card:hover { /* <-- S·ª¨A ƒê·ªîI: Th√™m th·∫ª KPI */
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.tdv-item-card:hover {
    
transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}
.page-header__help-btn:hover {
    transform: scale(1.1) translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #e5e7eb; border-radius: 5px; outline: none; transition: background 0.2s; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }

.content-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); padding: 1rem 1.5rem; margin-bottom: 2rem; border: 1px solid #e5e7eb; }
/* === START: V1.7 (S·ª¨A L·ªñI CANH L·ªÄ) === */
.content-card__header { 
    display: flex; 
    align-items: center; 
    justify-content: flex-start; /* S·ª≠a t·ª´ space-between th√†nh flex-start */
    gap: 0.5rem; /* Th√™m gap */
    font-size: 1.125rem; 
    font-weight: 600; 
    color: #374151; 
    margin-bottom: 1rem; 
    padding-bottom: 0.5rem; 
    border-bottom: 1px solid #e5e7eb; 
}
/* === END: V1.7 === */

#notification { position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; z-index: 1200; opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(100px); }
#notification.show { opacity: 1; transform: translateY(0); }
.notification-success { background-color: #28a745; }
.notification-error { background-color: #dc3545; }
.placeholder-message { border: 2px dashed #f59e0b; background-color: #fffbeb; color: #b45309; padding: 2rem; border-radius: 0.75rem; text-align: center; font-weight: 600; }

[id$='-subtabs-nav'] { flex-wrap: wrap; }

.data-input-group {
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 0.75rem; /* === V1.7 (GI·∫¢M PADDING) === */
    background-color: #f9fafb;
    display: flex;
    flex-direction: column;
    border-top: 4px solid #9ca3af;
}

/* === START: V1.7 (X√ìA B·ªé B·ªò CH·ªåN C≈®) === */
/* ƒê√£ x√≥a: #data-section > .content-card:nth-of-type(1) .data-input-group */
/* ƒê√£ x√≥a: #data-section > .content-card:nth-of-type(3) .data-input-group */
/* === END: V1.7 === */

/* === START: V1.7 (TH√äM M√ÄU M·ªöI) === */
/* Ghi ƒë√® m√†u n·ªÅn v√† vi·ªÅn cho card (G·ª£i √Ω B) */
.data-card--blue { background-color: #f0f9ff; border-color: #bae6fd; }
.data-card--green { background-color: #f0fdf4; border-color: #bbf7d0; }
.data-card--yellow { background-color: #fefce8; border-color: #fef08a; }

/* Ghi ƒë√® m√†u header */
.data-header--blue { color: #0369a1; border-bottom-color: #7dd3fc; }
.data-header--green { color: #15803d; border-bottom-color: #86efac; }
.data-header--yellow { color: #854d0e; border-bottom-color: #fde047; }

/* Ghi ƒë√® m√†u cho c√°c group con b√™n trong (ƒë·ªÉ ch√∫ng n·ªïi b·∫≠t h∆°n n·ªÅn card) */
.input-group--blue { background-color: #ffffff; border-top-color: #3b82f6; border-color: #dbeafe; }
.input-group--green { background-color: #ffffff; border-top-color: #22c55e; border-color: #dcfce7; }
.input-group--yellow { background-color: #ffffff; border-top-color: #f59e0b; border-color: #fef3c7; }

/* Ghi ƒë√® m√†u ch·ªØ c·ªßa label ƒë·ªÉ kh·ªõp v·ªõi theme */
.input-group--blue .data-input-group__label { color: #1d4ed8; }
.input-group--green .data-input-group__label { color: #166534; }
.input-group--yellow .data-input-group__label { color: #92400e; }
/* === END: V1.7 === */


.data-input-group__label { 
    font-weight: 600; 
    /* color: #4b5563; */ /* <-- B·ªã ghi ƒë√® b·ªüi V1.7 */
    margin-bottom: 0.75rem; 
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.data-input-group__label .feather {
    width: 1.25rem;
    height: 1.25rem;
    flex-shrink: 0;
}
.data-input-group__label--link { text-decoration: none; display: inline-flex; } /* S·ª≠a th√†nh inline-flex */
.data-input-group__label--link:hover { text-decoration: underline; } /* M√†u s·∫Ω k·∫ø th·ª´a t·ª´ .input-group--blue/green... */
.data-input-group__label--link > .font-normal { font-weight: 400; }
.data-input-group__content { display: flex; flex-direction: column; gap: 0.5rem; flex-grow: 1; }
.data-input-group__file-trigger { cursor: pointer; background-color: #e5e7eb; color: #374151; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875em; font-weight: 500; white-space: nowrap; }
.data-input-group__file-trigger:hover { background-color: #d1d5db; }
.data-input-group__file-name { font-size: 0.875em; color: #6b7280; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.data-input-group__link { color: #2563eb; text-decoration: none; font-size: 0.875em; }
.data-input-group__link:hover { text-decoration: underline; }
.data-input-group__status-wrapper { min-height: 1rem; margin-top: 0.25rem; }
.data-input-group__status-text { font-size: 0.875em; font-weight: 500; }
.data-input-group__status-text--default { color: #6b7280;
}
.data-input-group__status-text--success { 
color: #16a34a; }
.data-input-group__status-text--error { color: #dc2626; }
.data-textarea { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875em; font-family: 'Inter', sans-serif; }
.data-textarea:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: #3b82f6; box-shadow: 0 0 0 1px #3b82f6; }
.progress-bar-container { overflow: hidden; }
.progress-bar { background-image: linear-gradient(45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent); background-size: 1rem 1rem; animation: progress-bar-stripes 1s linear infinite; }
@keyframes progress-bar-stripes { from { background-position: 1rem 0; } to { background-position: 0 0; } }

.interactive-row {
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    cursor: pointer; /* Ensure interactive rows are clickable */
}
.interactive-row:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    background-color: #eff6ff;
}
.interactive-row .employee-name-cell {
    cursor: pointer;
    color: #2563eb;
    transition: color 0.2s ease-out;
}
.interactive-row:hover .employee-name-cell {
    text-decoration: underline;
    color: #1d4ed8;
}

.income-positive { color: #16a34a; }
.income-negative { color: #dc2626; }
.line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

.kpi-card-title { color: var(--kpi-title-color); opacity: 0.8; font-size: 1em; }
.kpi-card p[id$="-main"] { color: var(--kpi-main-color); font-size: var(--kpi-main-font-size);
transition: font-size 0.2s ease-in-out; }
.kpi-card p[id$="-sub"], .kpi-card p[id$="-sub1"], .kpi-card p[id$="-sub2"] { color: var(--kpi-sub-color); font-size: 1em; }

.kpi-percentage, .kpi-percentage-value { font-weight: 700; }
.kpi-sub-value { opacity: 0.9; }
#luyke-kpi-cards-container .kpi-card:nth-child(1), #realtime-kpi-cards-container .kpi-card:nth-child(1) { background-color: var(--kpi-card-1-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(2), #realtime-kpi-cards-container .kpi-card:nth-child(2) { background-color: var(--kpi-card-2-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(3), #realtime-kpi-cards-container .kpi-card:nth-child(3) { background-color: var(--kpi-card-3-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(4), #realtime-kpi-cards-container .kpi-card:nth-child(4) { background-color: var(--kpi-card-4-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(5) { background-color: var(--kpi-card-5-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(6) { background-color: var(--kpi-card-6-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(7) { background-color: var(--kpi-card-7-bg); }
#luyke-kpi-cards-container .kpi-card:nth-child(8) { background-color: var(--kpi-card-8-bg); }

.toggle-filters-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; background-color: #f3f4f6; color: #4b5563; font-weight: 500; font-size: 0.875em; cursor: pointer; margin-bottom: 1rem; border: 1px solid #e5e7eb; }
.toggle-filters-btn .icon { width: 1rem; height: 1rem; transition: transform 0.3s ease-in-out; }
.toggle-filters-btn.active .icon { transform: rotate(180deg); }
.highlight-trigger { background: none; border: none; cursor: pointer; color: #6b7280; }
.highlight-trigger:hover { color: #1d4ed8; }
.highlighted-row td { animation: pulse-bg 2s infinite; }
@keyframes pulse-bg { 0% { background-color: var(--highlight-color, #ffff99); } 50% { background-color: var(--highlight-color-light, #ffffcc); } 100% { background-color: var(--highlight-color, #ffff99); } }

.action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 500;
    font-size: 0.875em;
    cursor: pointer;
    border: 1px solid transparent;
}
.action-btn--composer {
background-color: #ede9fe; color: #5b21b6; border-color: #c4b5fd; }
.action-btn--composer:hover { background-color: #d8b4fe; }
.action-btn--export { background-color: #dcfce7; color: #166534; border-color: #86efac; }
.action-btn--export:hover { background-color: #bbf7d0; }
.action-btn--capture { background-color: #dbeafe; color: #1e40af; border-color: #93c5fd; }
.action-btn--capture:hover { background-color: #bfdbfe; }
.action-btn--save { background-color: #16a34a; color: white; }
.action-btn--save:hover { background-color: #15803d; }
.action-btn--copy { background-color: #2563eb; color: white; }
.action-btn--copy:hover { background-color: #1d4ed8; }
.page-header__help-btn { background-color: #fee2e2; color: #991b1b; border-radius: 9999px; width: 2rem; height: 2rem; display: inline-flex; align-items: center; justify-content: center; border: none; }

.modal { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
.modal.hidden { display: none; }
.modal__overlay { position: absolute; inset: 0; background-color: rgba(17, 24, 39, 0.6); backdrop-filter: blur(4px); cursor: pointer; }
.modal__container { position: relative; z-index: 1001; background-color: white; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); width: 90%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; }

#force-update-modal .modal__overlay { cursor: not-allowed; }

.modal__container--large {
    max-width: 900px;
}
.modal__header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
.modal__title { font-size: 1.25rem; font-weight: 600; color: #1f2937; }
.modal__close-btn { font-size: 1.75rem; line-height: 1; color: #6b7280; background: none; border: none; cursor: pointer; }
.modal__close-btn:hover { color: #111827; }
.modal__content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
.modal__content h4 { font-size: 1.125rem; font-weight: 600; color: #1e3a8a; margin-bottom: 0.75rem; }
.modal__content p { margin-bottom: 0.75rem; color: #374151; line-height: 1.6; }
.modal__content ul { list-style-type: disc; list-style-position: inside; margin-left: 0.5rem; }
.modal__content ul > *
+ * { margin-top: 0.5rem; }
.modal__footer { padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; background-color: #f9fafb; display: flex; justify-content: flex-end; gap: 0.75rem; flex-shrink: 0; }

.view-switcher { display: flex; align-items: center; padding: 0.25rem; background-color: #e5e7eb; border-radius: 0.5rem; }
.view-switcher__btn { padding: 0.5rem 1rem; border: none; background-color: transparent; border-radius: 0.375rem; font-weight: 500; color: #4b5563; cursor: pointer; }
.view-switcher__btn.active { background-color: white; color: #3b82f6; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }
.infographic-card { border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
.infographic-card__header { padding: 0.75rem 1rem; font-weight: 700; }
.infographic-card__header--completed { background-color: #dcfce7; color: #166534; }
.infographic-card__header--pending { background-color: #fee2e2; color: #991b1b; }
.infographic-card__body { padding: 1rem; background-color: #f9fafb; }
.infographic-card__item { border-bottom: 1px dashed #d1d5db; padding: 0.75rem 0; }
.infographic-card__item:last-child { border-bottom: none; }
.infographic-card__title { font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; }
.infographic-card__metrics { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.5rem 1rem; font-size:
0.875em; }
.metric-label { color: #6b7280; }
.metric-value { font-weight: 600; color: #111827; text-align: right; }
.metric-value.is-negative { color: #ef4444; }
.metric-value.is-positive { color: #22c55e; }

.rt-infographic-container { background-color: #f9fafb; border-radius: 0.75rem; border: 1px solid #e5e7eb; padding: 1.5rem; }
.rt-infographic-header .employee-name { font-size: 1.5rem; font-weight: 800; color: #111827; }
.rt-infographic-header .employee-title { font-size: 1rem; font-weight: 500; color: #6b7280; }
.rt-infographic-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
.rt-infographic-summary-card { background-color: white; border-radius: 0.5rem; padding: 1rem; text-align: center; border: 1px solid #e5e7eb; }
.rt-infographic-summary-card .label { font-size: 0.875em; color: #4b5563; font-weight: 500; }
.rt-infographic-summary-card .value { font-size: 1.75rem; font-weight: 700; color: #3b82f6; margin-top: 0.25rem; }
.rt-infographic-summary-card .value.is-positive { color: #2563eb; }
.rt-infographic-summary-card .value.is-negative { color: #dc2626; }
.rt-infographic-grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 1.5rem; margin-top: 1.5rem; }
@media
(min-width: 1024px) { .rt-infographic-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
.rt-infographic-section h4 { font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem; }
.rt-progress-bar-item { margin-bottom: 0.75rem; }
.rt-progress-bar-label { display: flex; justify-content: space-between; font-size: 0.875em; font-weight: 500; margin-bottom: 0.25rem; }
.rt-progress-bar-container { background-color: #e5e7eb; border-radius: 9999px; height: 0.75rem; overflow: hidden; }
.rt-progress-bar { background-color: #22c55e; height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }
.rt-customer-accordion { max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; }
.rt-customer-header { background-color: white; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; list-style: none; }
.rt-customer-header::-webkit-details-marker { display: none; }
.rt-customer-header:hover { background-color: #f9fafb; }
.rt-customer-header .arrow { transition: transform 0.3s; }
.rt-customer-header .product-count { color: #dc2626; font-weight: bold; }
details[open] > summary
.arrow { transform: rotate(180deg); }
.rt-customer-details { background-color: #f9fafb; padding: 1rem; }
.rt-customer-details table { font-size: 0.8rem; }
.preview-content { background-color: #f3f4f6; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap; word-wrap: break-word; font-size: 0.875em; line-height: 1.6; color: #1f2937; font-family: 'Inter', sans-serif; }

.header-qr-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  border: 2px solid #ef4444; /* red-500 */
  padding: 4px;
  border-radius: 8px;
  background-color: white;
}
.header-qr-container span {
  font-size: 0.75rem; /* 12px */
  font-weight: 600;
  color: #b91c1c; /* red-700 */
}
.header-qr-image {
  width: 50px;
  height: 50px;
  background-color: #f3f4f6;
  border-radius: 4px;
}
.selection-item {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out;
}
.selection-item:hover {
    background-color: #f3f4f6; /* gray-100 */
}
.selection-item input[type="checkbox"] {
    width: 1rem;
    height: 1rem;
    margin-right: 0.75rem;
}
.selection-item label {
  
  flex-grow: 1;
    cursor: pointer;
}
.settings-trigger-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: #9ca3af; /* gray-400 */
    transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
    padding: 2px;
}
.settings-trigger-btn:hover {
    color: #3b82f6; /* blue-500 */
    transform: rotate(45deg);
}
.settings-trigger-btn svg {
    width: 18px;
    height: 18px;
    display: block;
}

#version-marquee-container {
    flex-grow: 1;
    margin: 0 1.5rem;
    overflow: hidden;
    position: relative;
    background-color: #eef2ff;
    border: 1px solid #c7d2fe;
    border-radius: 9999px;
    cursor: pointer;
    height: 38px;
}
#version-marquee-container:hover .marquee-text {
    animation-play-state: paused;
    color: #312e81;
}
.marquee-text {
    position: absolute;
    white-space: nowrap;
    will-change: transform;
    animation: marquee-scroll 25s linear infinite;
    font-weight: 600;
    color: #4338ca;
    line-height: 36px;
}
@keyframes marquee-scroll {
    from {
        transform: translateX(100%);
    }
    to {
        transform: translateX(-100%);
    }
}

.competition-summary-counter strong {
    font-size: 1.15rem !important;
    font-weight: 800 !important;
    white-space: nowrap;
}
.competition-summary-counter .text-blue-600 {
    color: #2563eb !important;
}
.competition-summary-counter .text-red-600 {
    color: #dc2626 !important;
}

.column-toggle-btn {
    padding: 4px 12px;
    font-size: 12px;
    font-weight: 500;
    border: 1px solid;
    border-radius: 9999px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    user-select: none;
}

.column-toggle-btn.active {
    background-color: #3b82f6; /* blue-500 */
    color: white;
    border-color: #3b82f6;
}

.column-toggle-btn:not(.active) {
    background-color: #e5e7eb; /* gray-200 */
    color: #374151; /* gray-700 */
    border-color: #d1d5db; /* gray-300 */
}

.column-toggle-btn:not(.active):hover {
    background-color: #d1d5db; /* gray-300 */
}

.draggable-header {
    cursor: move;
    cursor: grab;
}
.draggable-header:active {
    cursor: grabbing;
}
.sortable-ghost {
    opacity: 0.4;
    background-color: #c7d2fe; /* indigo-200 */
}

.column-toggle-btn.draggable-tag {
    cursor: grab;
}
.column-toggle-btn.draggable-tag:active {
    cursor: grabbing;
}
.column-toggle-btn.draggable-tag:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.drag-handle-icon {
   color: #6b7280;
    transition: color 0.2s ease-in-out;
}
.column-toggle-btn.draggable-tag:hover .drag-handle-icon {
    color: #1f2937;
}
.sortable-drag {
    opacity: 0.95;
    transform: rotate(-2deg);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}

.action-btn,
.nav-link,
.view-switcher__btn,
.toggle-filters-btn,
.page-header__help-btn
{
    display: inline-flex;
    align-items: center;
    /* justify-content: center; */ /* B·ªã lo·∫°i b·ªè ƒë·ªÉ s·ª≠a l·ªói sidebar */
    gap: 0.5rem;
}

#sidebar .feather {
    width: 1.5rem;
    height: 1.5rem;
    stroke-width: 2;
}

.page-header__help-btn .feather {
    width: 1.25rem;
    height: 1.25rem;
}

.luyke-detail-header h3 {
    font-size: 1.75rem; font-weight: 800; color: #111827; text-align: center;
}
.luyke-detail-progress-item {
    display: flex; flex-direction: column; gap: 4px;
}
.luyke-detail-progress-label {
    display: flex; justify-content: space-between; align-items: baseline; font-size: 0.875rem;
}
.luyke-detail-progress-values {
    display: flex; justify-content: space-between; font-size: 0.75rem; color: #4b5563;
}
.luyke-detail-chart-container {
    position: relative; height: 350px; width: 100%;
}
.customer-accordion-luyke summary {
    display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; padding: 0.5rem 1rem; cursor: pointer; list-style: none;
    /* === START: S·ª¨A L·ªñI FONT (Task 3) === */
    font-weight: 400; /* ƒê·∫∑t font-weight C∆† B·∫¢N l√† 400 (th∆∞·ªùng) */
    color: #4b5563; /* ƒê·∫∑t m√†u ch·ªØ C∆† B·∫¢N l√† gray-600 */
    /* === END: S·ª¨A L·ªñI FONT === */
}
.customer-accordion-luyke summary:hover {
    background-color: #f9fafb;
}
.customer-accordion-luyke .customer-name-small {
    /* === START: S·ª¨A L·ªñI FONT (Task 4) === */
    font-weight: 500; /* Gi·∫£m t·ª´ 600 xu·ªëng 500 */
    font-size: 0.9rem; 
    color: #2563eb; /* ƒê·ªïi sang m√†u xanh d∆∞∆°ng */
    /* === END: S·ª¨A L·ªñI FONT === */
    flex-grow: 1; 
    min-width: 120px;
}
.customer-accordion-luyke .order-metrics {
    display: flex; align-items: center; gap: 1rem; flex-shrink: 0; font-size: 0.75rem;
    /* (Task 3) C√°c nh√£n (SL, DT Th·ª±c) s·∫Ω k·∫ø th·ª´a font-weight 400 v√† color gray-600 t·ª´ summary */
}
.customer-accordion-luyke .order-metrics span {
    white-space: nowrap;
}
.customer-accordion-luyke .order-metrics strong {
    /* === START: S·ª¨A L·ªñI FONT (Task 4) === */
    font-weight: 500; /* Gi·∫£m t·ª´ 600 xu·ªëng 500 */
    color: #1f2937; /* M√†u ƒëen-x√°m cho s·ªë */
    /* === END: S·ª¨A L·ªñI FONT === */
}
.customer-accordion-luyke .order-metrics .text-gray-900 {
    color: #1f2937 !important; /* Ghi ƒë√® class c≈© (n·∫øu c√≥) */
}
.customer-accordion-luyke .order-metrics .text-blue-600 {
    color: #2563eb !important; /* M√†u xanh cho DTQƒê */
}
.customer-accordion-luyke .accordion-arrow {
    margin-left: auto; color: #9ca3af; transition: transform 0.2s ease-in-out;
}
.customer-accordion-luyke details[open] > summary .accordion-arrow {
    transform: rotate(180deg);
}
.customer-accordion-luyke .product-list-scrollable {
    display: block;
    max-height: 200px;
    overflow-y: auto;
}
.customer-accordion-luyke .product-list-table {
    width: 100%;
}
.customer-accordion-luyke .qd-below-target { color: #b91c1c; }
.customer-accordion-luyke .qd-above-target { color: #1d4ed8; }

/* === START: Capture Preset Fixes (v1.2) === */

/* 1. ƒê·∫£m b·∫£o khu v·ª±c ch·ª•p chi ti·∫øt (t·ª´ ui-luyke.js) tu√¢n th·ªß chi·ªÅu r·ªông preset */
.capture-container.preset-mobile-portrait .preset-mobile-capture-area {
    /* width: 750px !important; <-- ƒê√É X√ìA (v1.4) */
    box-sizing: border-box; /* ƒê·∫£m b·∫£o padding kh√¥ng ph√° v·ª° chi·ªÅu r·ªông */
}

/* 2. ƒê·∫£m b·∫£o n·ªôi dung modal tu√¢n th·ªß chi·ªÅu r·ªông preset */
.capture-container.preset-mobile-portrait #customer-detail-list-container,
.capture-container.preset-mobile-portrait #unexported-detail-list-container {
    width: 100% !important; /* L·∫•y 100% c·ªßa 750px */
    max-width: 100% !important;
    box-sizing: border-box;
}

/* === END: Capture Preset Fixes (v1.2) === */
--- END FILE: ./styles/components.css ---

--- START FILE: ./styles/dashboard.css ---
/* Version 6.20.1 - Fix: Remove underscores from import paths */
/* File n√†y l√† file CSS ch√≠nh m·ªõi.
  N√≥ KH√îNG ch·ª©a style, m√† ch·ªâ @import c√°c file "partial" (file con)
  theo ƒë√∫ng th·ª© t·ª±.
*/

/* 1. N·ªÅn t·∫£ng (Variables, body, scrollbar) */
@import url('base.css');

/* 2. B·ªë c·ª•c ch√≠nh (Sidebar, main-content, drawers) */
@import url('layout.css');

/* 3. Linh ki·ªán UI (Buttons, cards, modals, inputs) */
@import url('components.css');

/* 4. B·∫£ng bi·ªÉu (Table styles, sort indicators, header colors) */
@import url('tables.css');

/* 5. Ghi ƒë√® th∆∞ vi·ªán (Choices.js) */
@import url('vendor.css');

/* 6. Style chuy√™n bi·ªát cho t·ª´ng tab */
@import url('specific-sknv.css');
@import url('specific-tdv.css');
@import url('specific-composer.css');
@import url('specific-realtime.css');
--- END FILE: ./styles/dashboard.css ---

--- START FILE: ./styles/layout.css ---
/* Version 1.0 - Layout styles (Refactored from v6.19) */
/* Ch·ª©a c√°c ID v√† class ƒë·ªãnh h√¨nh b·ªë c·ª•c ch√≠nh: sidebar, main-content, drawers, page-header */

#sidebar { 
    width: 68px; 
    transition: width 0.3s ease-in-out; 
    overflow-x: hidden; 
}
#sidebar:hover { 
    width: 256px; 
}
#sidebar.menu-locked:hover { 
    width: 68px; 
}

#sidebar .nav-link, #sidebar button {
    white-space: nowrap;
    gap: 1rem;
    justify-content: flex-start; /* FIX: Canh l·ªÅ tr√°i cho icon v√† text */
}

.menu-text {
    transition: opacity 0.2s ease-in-out, width 0.3s ease-in-out;
    opacity: 0;
    white-space: nowrap;
    width: 0;
    overflow: hidden;
}
#sidebar:hover .menu-text {
    opacity: 1;
    transition-delay: 0.1s;
    width: auto;
}
#sidebar.menu-locked:hover .menu-text {
    opacity: 0;
    width: 0;
}

/* === START: S·ª¨A L·ªñI (v6.14) === */
#main-content { 
    transition: margin-left 0.3s ease-in-out; 
    margin-left: 68px; 
    min-width: 0; /* NgƒÉn flex item co gi√£n theo n·ªôi dung con (c√°i b·∫£ng r·ªông) */
}
/* === END: S·ª¨A L·ªñI (v6.14) === */

.settings-drawer { 
    width: 400px; 
    max-width: 90vw; 
    transform: translateX(-100%); 
    transition: transform 0.3s ease-in-out; 
}
.settings-drawer.open { 
    transform: translateX(0); 
}
.close-drawer-btn { 
    font-size: 2rem; 
    line-height: 1; 
}

.page-header { 
    display: flex; 
    flex-wrap: wrap; 
    justify-content: space-between; 
    align-items: center; 
    gap: 1rem; 
    margin-bottom: 1.5rem; 
}
.page-header__title { 
    font-size: 1.75rem; 
    font-weight: 700; 
    color: #1f2937; 
}
--- END FILE: ./styles/layout.css ---

--- START FILE: ./styles/specific-composer.css ---
/* Version 1.0 - Specific: Composer (Refactored from v6.19) */
/* Ch·ª©a c√°c style CH·ªà d√†nh ri√™ng cho modal Tr√¨nh t·∫°o Nh·∫≠n x√©t & Xem tr∆∞·ªõc */

.composer { 
    display: flex; 
    flex-direction: column; 
    gap: 1.5rem; 
}
.composer__editor { 
    flex-grow: 1; 
}
.composer__tags { 
    width: 100%; 
}
.composer__label { 
    display: block; 
    font-weight: 500; 
    color: #374151; 
    margin-bottom: 0.5rem; 
}
.composer__textarea { 
    width: 100%; 
    border: 1px solid #d1d5db; 
    border-radius: 0.5rem; 
    padding: 0.75rem; 
    font-size: 0.875em; 
    resize: vertical; 
}
.composer__textarea:focus { 
    border-color: #3b82f6; 
    box-shadow: 0 0 0 1px #3b82f6; 
    outline: none; 
}
.composer__nav { 
    display: flex; 
    border-bottom: 1px solid #e5e7eb; 
    margin-bottom: 1rem; 
}
.composer__tab-btn { 
    padding: 0.5rem 1rem; 
    border: none; 
    background-color: transparent; 
    cursor: pointer; 
    font-weight: 500; 
    color: #6b7280; 
    border-bottom: 2px solid transparent; 
    margin-bottom: -1px; 
    font-size: 0.875em; 
}
.composer__tab-btn.active { 
    color: #3b82f6; 
    border-bottom-color: #3b82f6; 
}
.composer__tab-pane {
    display: none; 
}
.composer__tab-pane.active { 
    display: block; 
}
.composer__tag-group { 
    margin-bottom: 1rem; 
}
.composer__tag-group:last-child { 
    margin-bottom: 0; 
}
.composer__tag-group-title { 
    font-weight: 600; 
    font-size: 0.875em; 
    color: #4b5563; 
    margin-bottom: 0.75rem; 
    border-bottom: 1px solid #e5e7eb; 
    padding-bottom: 0.5rem; 
}
.composer__tag-btn { 
    background-color: #e0e7ff; 
    color: #3730a3; 
    border: 1px solid #c7d2fe; 
    border-radius: 9999px; 
    padding: 0.25rem 0.75rem; 
    font-size: 0.8rem; 
    font-weight: 500; 
    cursor: pointer; 
    margin: 0.25rem; 
}
.composer__icon-btn { 
    background-color: #f3f4f6; 
    color: #1f2937; 
    border: 1px solid #d1d5db; 
    border-radius: 9999px; 
    padding: 0.25rem 0.75rem; 
    font-size: 1.1rem; 
    font-weight: 500; 
    cursor: pointer; 
    margin: 0.25rem; 
    line-height: 1; 
}
.composer__filter-group { 
    margin-bottom: 1rem;
    padding-bottom: 1rem; 
    border-bottom: 1px solid #e5e7eb; 
}
.composer__select { 
    width: 100%; 
    padding: 0.5rem; 
    border: 1px solid #d1d5db; 
    border-radius: 0.375rem; 
    background-color: white; 
}
@media (min-width: 768px) { 
    .composer { 
        flex-direction: row; 
    } 
    .composer__tags { 
        width: 350px; 
        flex-shrink: 0; 
        border-left: 1px solid #e5e7eb; 
        padding-left: 1.5rem; 
    } 
}

.preview-content { 
    background-color: #f3f4f6; 
    padding: 1rem; 
    border-radius: 0.5rem; 
    white-space: pre-wrap; 
    word-wrap: break-word; 
    font-size: 0.875em; 
    line-height: 1.6; 
    color: #1f2937; 
    font-family: 'Inter', sans-serif; 
}
--- END FILE: ./styles/specific-composer.css ---

--- START FILE: ./styles/specific-realtime.css ---
/* Version 1.0 - Specific: Realtime (Refactored from v6.19) */
/* Ch·ª©a c√°c style CH·ªà d√†nh ri√™ng cho tab Realtime */

#video-container iframe {
    aspect-ratio: 16 / 9;
    width: 100%;
    height: auto;
    border-radius: 0.5rem;
}

.rt-customer-details table { 
    font-size: 0.8rem; 
}
--- END FILE: ./styles/specific-realtime.css ---

--- START FILE: ./styles/specific-sknv.css ---
/* Version 1.8 - No changes for this refactor
/* Version 1.7 - (YC 1) Change competition detail employee name color to dark green
/* Version 1.6 - Adjust detail view layout, colors, and KPI styling
/* Version 1.5 - Add standard 'line-clamp' property for compatibility
/* Version 1.4 - Implement "Multi-lane" layout & fix text wrap for competition detail
/* Version 1.3 - Add 3-column infographic styles and fix capture scroll
/* Version 1.2 - Fix drag-drop cursor for pasted competition toggles
/* Version 1.1 - Add sticky column styles for pasted competition table */
/* Ch·ª©a c√°c style CH·ªà d√†nh ri√™ng cho tab S·ª©c Kh·ªèe Nh√¢n Vi√™n (SKNV) */

#sknv-details-container .sknv-subtable-header th { 
    font-size: 0.875em; 
    font-weight: 600; 
    background-color: #f3f4f6; 
}

/* === START: SKNV INFOGRAPHIC CARD STYLES (V6.0) === */
.sknv-summary-grid {
    display: grid;
    grid-template-columns: 1fr; /* Default to 1 column for mobile */
    gap: 1.5rem;
}

@media (min-width: 768px) { /* 2 columns for tablets 
*/
    .sknv-summary-grid {
        grid-template-columns: repeat(2, 1fr);
}
}

@media (min-width: 1280px) { /* 4 columns for large desktops */
    .sknv-summary-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

.sknv-card {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 1rem; /* UPDATED: Compact padding */
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* UPDATED: Softer shadow */
    display: flex;
    flex-direction: column;
    gap: 0.75rem; /* UPDATED: Reduced gap */
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    cursor: pointer;
    position: relative; /* Added for medal positioning */
}
.sknv-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
}

.sknv-card__header {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.sknv-card__avatar {
    width: 48px;
    height: 48px;
    border-radius: 9999px;
    background-color: #eef2ff;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    /* (v6.18) Th√™m position relative ƒë·ªÉ canh s·ªë Top 3 */
    position: relative;
}

.sknv-card__avatar svg {
    width: 24px;
    height: 24px;
    color: #4338ca;
}

.sknv-card__info {
    flex-grow: 1;
    min-width: 0;
}
.sknv-card__info .name {
    font-weight: 700;
    color: #111827;
    line-height: 1.25;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
}

.sknv-card__info .id {
    font-size: 0.875rem;
    color: #6b7280;
}

.sknv-card__main-kpi {
    text-align: center;
    margin: 0.25rem 0; /* UPDATED: Reduced margin */
}

.sknv-card__main-kpi .value {
    font-size: 2.5rem; /* UPDATED: Reduced font size */
    font-weight: 800;
    line-height: 1;
    color: #4b5563;
}

.sknv-card__main-kpi .total {
    font-size: 1.25rem; /* UPDATED */
    font-weight: 600;
    color: #9ca3af;
}

.sknv-card__main-kpi .label {
    display: block;
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.25rem;
    font-weight: 500;
}

.sknv-card-kpi-strong { border-top: 4px solid #16a34a; } /* UPDATED: Added top border */
.sknv-card-kpi-medium { border-top: 4px solid #f59e0b; } /* UPDATED: Added top border 
*/
.sknv-card-kpi-weak { border-top: 4px solid #ef4444; } /* UPDATED: Added top border */
.sknv-card-kpi-strong .value { color: #16a34a; }
.sknv-card-kpi-medium .value { color: #f59e0b; }
.sknv-card-kpi-weak .value { color: #ef4444; }

.sknv-card__sub-kpi-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem; /* UPDATED: Reduced gap */
    border-top: 1px solid #f3f4f6;
    padding-top: 0.75rem; /* UPDATED: Reduced padding */
}

.sknv-card__sub-kpi-item {
    background-color: #f9fafb;
    border-radius: 0.5rem;
    padding: 0.5rem; /* UPDATED: Reduced padding */
    text-align: center;
    transition: background-color 0.2s ease-in-out;
}

/* === START: NEW SUB-KPI LAYOUT === */
.sknv-card__sub-kpi-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
}
.sknv-card__sub-kpi-header .feather {
    width: 1rem;
    height: 1rem;
    stroke-width: 2;
    color: #6b7280;
}
.sknv-card__sub-kpi-header .label {
    font-size: 0.7rem;
    font-weight: 600;
    color: #4b5563;
}
.sknv-card__sub-kpi-item .value {
    font-size: 0.875rem;
    font-weight: 700;
    margin-top: 2px;
    display: block; /* Ensures it's on a new line */
}
/* === END: NEW SUB-KPI LAYOUT === */

.sknv-card__sub-kpi-item.strong { 
border-bottom: 3px solid #22c55e; }
.sknv-card__sub-kpi-item.medium { border-bottom: 3px solid #f59e0b; }
.sknv-card__sub-kpi-item.weak { border-bottom: 3px solid #ef4444; }
/* === END: SKNV INFOGRAPHIC CARD STYLES === */

/* === START: SKNV Department Grouping Styles (V6.1) === */
.sknv-department-group {
    margin-bottom: 2.5rem; /* Space between department groups */
}

.sknv-department-group:last-child {
    margin-bottom: 1rem; /* Less space for the last group */
}

.sknv-department-header {
    font-size: 1.6rem;
    font-weight: 700;
    color: #1f2937; /* Dark gray for general headers */
    padding-bottom: 0.75rem;
    margin-bottom: 1.5rem;
    border-bottom: 3px solid #d1d5db; /* Light gray border */
    position: relative;
    padding-left: 0.5rem;
    /* (v6.18) Th√™m flex ƒë·ªÉ icon canh gi·ªØa */
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* (v6.18) ƒê·ªãnh d·∫°ng cho icon (n·∫øu c√≥) */
.sknv-department-header .header-icon {
    width: 1.4rem;
    height: 1.4rem;
}

.sknv-department-header--priority {
    color: #2563eb; /* Blue for priority department */
    border-bottom-color: #3b82f6; /* Matching blue border */
    background-color: #e0f2fe; /* Light blue background */
    padding: 0.75rem 1rem;
    border-radius: 0.5rem 0.5rem 0 0;
    margin-bottom: 0; /* Remove bottom margin to connect with cards */
    
display: flex;
    align-items: center;
    gap: 0.75rem;
}

/* (v6.18) B·ªè icon FontAwesome c≈© */
.sknv-department-header--priority::before {
    content: none;
}

/* Adjust grid gap and padding for priority department to integrate better */
.sknv-department-header--priority + .sknv-summary-grid {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    margin-top: 0; /* Remove top margin */
    padding-top: 1.5rem; /* Add padding inside grid */
    border: 1px solid #c7d2fe;
    background-color: #f3f4f6; /* Slightly different background */
    padding-left: 1rem;
    padding-right: 1rem;
    padding-bottom: 1rem;
    border-top: none;
}
/* === END: SKNV Department Grouping Styles === */

/* === START: SKNV DETAIL VIEW & MEDALS (V6.4) === */
/* NEW: Wrapper for compact detail view */
#sknv-detail-capture-area {
    max-width: 1100px;
    margin: 0 auto;
}
.sknv-detail-header-card 
{
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding: 1rem; /* UPDATED: Compact padding */
    background-color: #eff6ff; /* blue-50 */
    border: 1px solid #dbeafe; /* blue-200 */
    border-top: 4px solid #3b82f6; /* blue-500 */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
}
.sknv-detail-avatar {
    width: 64px;
    height: 64px;
    border-radius: 9999px;
    background-color: #dbeafe; /* blue-200 */
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.sknv-detail-avatar svg {
    width: 32px;
    height: 32px;
    color: #1e40af; /* blue-800 */
}
.sknv-detail-info .name {
    color: #1e40af; /* UPDATED: Dark blue color */
}
.sknv-detail-info .department,
.sknv-detail-info .kpi-summary {
    color: #1f2937; /* dark text */
}
.sknv-detail-info .kpi-summary .font-bold {
    color: #1d4ed8; /* darker blue */
}
.sknv-detail-info .name {
    font-size: 1.5rem;
    font-weight: 800;
    line-height: 1.2;
}
.sknv-detail-info .department {
 
   font-size: 1rem;
    font-weight: 500;
}
.sknv-detail-info .kpi-summary {
    margin-top: 0.5rem;
    font-weight: 600;
}

.sknv-detail-card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem; /* UPDATED: Compact padding */
    color: #ffffff;
}
.sknv-detail-card-header .header-icon {
    width: 20px;
    height: 20px;
}
.sknv-header-blue { background-color: #2563eb; }
.sknv-header-green { background-color: #16a34a; }
.sknv-header-orange { background-color: #f97316; }
.sknv-header-yellow { background-color: #ca8a04; }
.sknv-header-indigo { background-color: #4f46e5; }
.sknv-header-purple { background-color: #7e22ce; }

.sknv-detail-grid-body {
    padding: 0.75rem 1rem; /* UPDATED: Compact padding */
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* UPDATED */
    gap: 0.75rem; /* UPDATED */
}
.sknv-detail-metric-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 0.5rem; /* UPDATED: Compact padding */
    background-color: #f9fafb;
    border-radius: 0.5rem;
    border: 1px solid #f3f4f6;
    transition: all 0.2s ease-in-out;
}
.sknv-detail-metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 
0 2px 4px -2px rgba(0, 0, 0, 0.1);
}
.sknv-detail-metric-card .label {
    font-weight: 600;
    font-size: 0.8rem; /* UPDATED */
    color: #374151;
}
.sknv-detail-metric-card .value {
    font-weight: 700; /* UPDATED */
    font-size: 1.375rem; /* UPDATED: Reduced font size */
    line-height: 1.2;
    color: #111827;
    margin: 0.25rem 0;
}
.sknv-detail-metric-card .average {
    font-size: 0.7rem; /* UPDATED */
    color: #6b7280;
    font-style: italic;
}
.sknv-detail-metric-card .evaluation-badge {
    margin-top: 0.5rem;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 9999px;
    font-size: 0.7rem; /* UPDATED */
}
.evaluation-badge.text-green-600 { background-color: #dcfce7; }
.evaluation-badge.text-yellow-600 { background-color: #fef9c3; }

.medal-container {
    position: absolute; /* Changed for positioning */
    /* (v6.19) YC: TƒÉng size + ƒëi·ªÅu ch·ªânh v·ªã tr√≠ */
    top: -10px;
    left: 10px;
    width: 48px;
    height: 48px;
    flex-shrink: 0;
}
.medal-container svg {
    width: 100%;
    height: 100%;
    display: block;
filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); /* Add a nice shadow */
}

/* NEW: Compact tables in detail view */
#sknv-details-container .sknv-subtable-header {
    font-size: 0.8rem;
}
#sknv-details-container .table-bordered td,
#sknv-details-container .table-bordered th {
    padding: 0.5rem;
}
/* === END: SKNV DETAIL VIEW & MEDALS === */

/* === START: SKNV Rank Number Styles (v6.19 - Ph∆∞∆°ng √°n A M·ªõi) === */

/* 1. (v6.19) ƒê·ªãnh d·∫°ng cho s·ªë th·ª© t·ª± (1, 2, 3) c·ªßa Top 3 */
.sknv-card__avatar-rank {
    font-size: 1.75rem; /* 28px */
    font-weight: 700; /* font-bold */
    line-height: 1;
    /* Canh s·ªë v√†o gi·ªØa v√≤ng tr√≤n */
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    /* (v6.19) N·∫±m ƒë√® l√™n tr√™n SVG huy ch∆∞∆°ng */
    position: absolute;
    top: 0;
    left: 0;
    z-index: 12; /* N·∫±m tr√™n huy ch∆∞∆°ng (z-11) */
    color: #ffffff; /* (v6.19) M√†u tr·∫Øng cho Top 3 */
}

/* 2. (v6.19) ·∫®n n·ªÅn xanh c·ªßa avatar Top 3, ƒë·ªÉ huy ch∆∞∆°ng SVG lo vi·ªác hi·ªÉn th·ªã */
.sknv-card:has(.medal-container) .sknv-card__avatar {
    background-color: transparent;
}

/* 3. (v6.19) ƒê·ªãnh d·∫°ng cho V√≤ng tr√≤n h·∫°ng 4+ (ƒê∆°n thu·∫ßn) */
.sknv-card__avatar--standard {
    background-color: #e5e7eb; /* (v6.19) V√≤ng tr√≤n x√°m (gray-200) */
}

/* 4. (v6.19) ƒê·ªãnh d·∫°ng cho S·ªê h·∫°ng 4+ */
.sknv-card__avatar--standard .sknv-card__avatar-rank {
    color: #4b5563; /* (v6.19) S·ªë m√†u x√°m ƒë·∫≠m (gray-600) */
    position: static; /* (v6.19) Reset l·∫°i position, kh√¥ng c·∫ßn ƒë√® */
}

/* 5. (v6.19) B·ªè SVG Huy ch∆∞∆°ng Th∆∞·ªùng (n·∫øu c√≥ t·ª´ v6.18) */
.sknv-card__avatar-medal {
    display: none;
}
/* === END: SKNV Rank Number Styles === */

/* === START: Declaration Accordion Styles (v6.11) === */
.declaration-group {
    border-bottom: 1px solid #e5e7eb; /* gray-200 */
}
.declaration-group:last-child {
    border-bottom: none;
}
.declaration-group summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0.5rem;
    cursor: pointer;
    font-size: 1.125rem; /* text-lg */
    font-weight: 700; /* font-bold 
*/
    color: #374151; /* gray-700 */
    list-style: none; /* Hide default marker */
}
.declaration-group summary::-webkit-details-marker {
    display: none; /* Hide default marker for Chrome */
}
.declaration-group summary:hover {
    background-color: #f9fafb; /* gray-50 */
}
.declaration-group summary::after {
    content: '+';
    font-size: 1.5rem;
    font-weight: 500;
    color: #6b7280; /* gray-500 */
    transition: transform 0.2s ease-in-out;
}
.declaration-group[open] > summary::after {
    transform: rotate(45deg);
    content: '√ó';
}
.declaration-content {
    padding: 1rem 0.5rem 1.5rem 0.5rem;
}
/* === END: Declaration Accordion Styles === */

/* === START: Pasted Competition Column Toggles & Header Wrap (v6.15) === */

/* Container for the toggle buttons */
#pasted-competition-column-toggles {
    padding: 0.75rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem 0.25rem;
    background-color: #f9fafb; /* gray-50 */
}

/* Label for the toggles */
#pasted-competition-column-toggles .non-draggable {
    font-size: 0.875rem; /* text-sm */
    font-weight: 600; /* font-semibold */
    margin-right: 0.5rem; /* mr-2 */
    color: #374151; /* gray-700 */
}

/* Styles for the table headers to allow wrapping */
#pasted-competition-report-container table th {
    white-space: normal; /* Allow text wrapping */
    vertical-align: middle;
    line-height: 1.3;
    max-width: 150px; /* Set a max-width */
    width: 120px; /* Set a base width */
}

/* Keep employee name header slightly wider and no-wrap */
#pasted-competition-report-container table th[data-sort="hoTen"] {
    white-space: nowrap;
    width: 150px; 
    min-width: 150px;
}
/* === END: Pasted Competition Styles === */

/* === START: LOGIN MODAL STYLES (V6.7) === */
#login-modal .modal__overlay {
    cursor: not-allowed;
}

#login-modal .modal__container {
    box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
}

#login-modal input[type="email"]:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
    outline: none;
}
/* === END: LOGIN MODAL STYLES === */

/* === START: Sticky Columns for Pasted Competition Table (v1.1) === */

/* 1. Container: Ph·∫£i b·∫≠t 'overflow-x-auto' (ƒë√£ c√≥) v√† 'position: relative' (quan tr·ªçng) */
.sknv-pasted-competition-scroller {
    position: relative; /* B·∫Øt bu·ªôc ƒë·ªÉ z-index c·ªßa sticky ho·∫°t ƒë·ªông */
}

/* 2. C√°c √¥ ti√™u ƒë·ªÅ (th) c·∫ßn "ƒë√≥ng bƒÉng" */
#pasted-competition-report-container table th.sticky-col {
    position: -webkit-sticky; /* cho Safari */
    position: sticky;
    z-index: 2; /* Ph·∫£i cao h∆°n z-index c·ªßa c√°c √¥ (td) */
    background-color: #e5e7eb; /* gray-200 (m√†u n·ªÅn thead) - R·∫•t quan tr·ªçng */
}

/* 3. C√°c √¥ d·ªØ li·ªáu (td) c·∫ßn "ƒë√≥ng bƒÉng" */
#pasted-competition-report-container table td.sticky-col {
    position: -webkit-sticky; /* cho Safari */
    position: sticky;
    z-index: 1; /* Ph·∫£i cao h∆°n c√°c √¥ td kh√°c, nh∆∞ng th·∫•p h∆°n th */
    background-color: #ffffff; /* M√†u n·ªÅn c·ªßa d√≤ng (tr·∫Øng) */
}

/* 4. ƒê·∫£m b·∫£o d√≤ng ch·∫µn/l·∫ª c≈©ng ƒë∆∞·ª£c ghi ƒë√® m√†u n·ªÅn */
#pasted-competition-report-container table tr:nth-child(even) td.sticky-col {
    background-color: #f9fafb; /* gray-50 (m√†u d√≤ng ch·∫µn) */
}

/* 5. ƒê·ªãnh v·ªã cho t·ª´ng c·ªôt */
.sticky-col.sticky-col-1 {
    left: 0; /* C·ªôt ƒë·∫ßu ti√™n */
}

.sticky-col.sticky-col-2 {
    left: 150px; /* C·ªôt th·ª© 2 - Ph·∫£i b·∫±ng ƒë·ªô r·ªông c·ªßa c·ªôt 1 (min-width: 150px t·ª´ CSS c≈©) */
}

/* 6. (An to√†n) ƒê·∫£m b·∫£o footer c≈©ng ƒë∆∞·ª£c "ƒë√≥ng bƒÉng" */
#pasted-competition-report-container table tfoot td.sticky-col {
    background-color: hsl(210, 20%, var(--header-lightness)); /* M√†u footer */
    z-index: 3; /* N·∫±m tr√™n c·∫£ ti√™u ƒë·ªÅ v√† n·ªôi dung */
}
/* === END: Sticky Columns (v1.1) === */

/* === START: Y√äU C·∫¶U 2 (v1.2) - S·ª≠a l·ªói con tr·ªè k√©o th·∫£ === */
.column-toggle-btn {
    /* M·∫∑c ƒë·ªãnh l√† pointer ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt c√≥ th·ªÉ click b·∫≠t/t·∫Øt */
    cursor: pointer;
}

.column-toggle-btn .drag-handle-icon {
    /* Ch·ªâ ri√™ng icon k√©o m·ªõi c√≥ cursor grab */
    cursor: grab;
}

.column-toggle-btn .drag-handle-icon:active {
    /* Khi ƒëang k√©o icon */
    cursor: grabbing;
}
/* === END: Y√äU C·∫¶U 2 (v1.2) === */

/* === START: UPDATED STYLES (v1.4) - "Multi-lane" Layout & Text Wrap === */

/* B·ªè layout 3 c·ªôt c≈© */
/*
.sknv-thidua-detail-grid { ... }
.sknv-thidua-column { ... }
.sknv-thidua-column-content { ... }
*/

/* Container cho m·ªói "l√†n ƒë∆∞·ªùng" (ƒê·∫°t, G·∫ßn ƒê·∫°t, C·∫ßn C·ªë G·∫Øng) */
.sknv-thidua-lane {
    display: flex;
    flex-direction: column;
}

/* Container ch·ª©a c√°c th·∫ª card, cho ph√©p x·∫øp h√†ng ngang v√† xu·ªëng d√≤ng */
.sknv-thidua-horizontal-content {
    padding: 0.75rem; /* p-3 */
    display: flex;
    flex-direction: row; /* X·∫øp h√†ng ngang */
    flex-wrap: wrap;     /* T·ª± ƒë·ªông xu·ªëng d√≤ng */
    gap: 0.75rem;        /* Kho·∫£ng c√°ch gi·ªØa c√°c th·∫ª */
}

/* Th√¥ng b√°o khi l√†n ƒë∆∞·ªùng tr·ªëng */
.sknv-thidua-horizontal-content .empty-col-msg {
    font-size: 0.875rem; /* text-sm */
    color: #6b7280; /* gray-500 */
    text-align: center;
    padding: 1rem 0;
    font-style: italic;
    width: 100%; /* Chi·∫øm to√†n b·ªô chi·ªÅu r·ªông c·ªßa l√†n ƒë∆∞·ªùng */
}

/* Th·∫ª chi ti·∫øt t·ª´ng ng√†nh h√†ng (Y√™u c·∫ßu 3 - Layout) */
.sknv-thidua-item-card {
    background-color: #ffffff; /* bg-white */
    border-radius: 0.5rem; /* rounded-lg */
    border: 1px solid #e5e7eb; /* border */
    padding: 0.75rem; /* p-3 */
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
    transition: all 0.2s ease-in-out;
    
    /* Logic x·∫øp h√†ng ngang: */
    /* === START: Y√äU C·∫¶U 3 (v1.6) === */
    flex: 1 1 180px; /* Th·∫ª c√≥ th·ªÉ co gi√£n, c∆° s·ªü l√† 180px (thay v√¨ 220px) */
    min-width: 180px; /* Chi·ªÅu r·ªông t·ªëi thi·ªÉu 180px (thay v√¨ 220px) */
    /* === END: Y√äU C·∫¶U 3 (v1.6) === */
} 
.sknv-thidua-item-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow-md */
}

/* Ti√™u ƒë·ªÅ ng√†nh h√†ng (Y√™u c·∫ßu 1 - Text Wrap) */
.item-card-title {
    font-weight: 600; /* font-semibold */
    color: #1f2937; /* gray-800 */
    margin-bottom: 0.5rem; /* mb-2 */
    
    /* B·∫Øt ƒë·∫ßu s·ª≠a l·ªói wrap text */
    white-space: normal; /* Cho ph√©p xu·ªëng d√≤ng */
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Gi·ªõi h·∫°n 2 d√≤ng */
    line-clamp: 2; /* === TH√äM M·ªöI (v1.5) - S·ª≠a l·ªói t∆∞∆°ng th√≠ch === */
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    min-height: 2.5em; /* ƒê·∫£m b·∫£o ƒë·ªß chi·ªÅu cao cho 2 d√≤ng (line-height 1.25) */
    line-height: 1.25;
    /* K·∫øt th√∫c s·ª≠a l·ªói wrap text */
}

/* C√°c style c√≤n l·∫°i c·ªßa th·∫ª ƒë∆∞·ª£c gi·ªØ nguy√™n */
.item-card-progress-bar-container {
    width: 100%;
    background-color: #e5e7eb; /* gray-200 */
    border-radius: 9999px; /* rounded-full */
    height: 0.75rem; /* h-3 */
    overflow: hidden;
    margin-bottom: 0.5rem; /* mb-2 */
}
.item-card-progress-bar {
    height: 100%;
    border-radius: 9999px;
    transition: width 0.5s ease-in-out;
}
.item-card-metrics {
    font-size: 0.75rem; /* text-xs */
    color: #4b5563; /* gray-600 */
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.25rem 0.5rem; /* gap-x-2 gap-y-1 */
}
.item-card-metrics strong {
    font-weight: 600;
    color: #111827; /* gray-900 */
}
.item-card-metrics .text-green-600 { color: #16a34a; }
.item-card-metrics .text-red-600 { color: #dc2626; }

/* === END: UPDATED STYLES (v1.4) === */


/* === START: S·ª¨A L·ªñI (v1.3) - CƒÉn ch·ªânh icon cho th·∫ª KPI === */
.rt-infographic-summary-card .label {
    font-size: 0.875em;
    color: #4b5563;
    font-weight: 500;
    /* Th√™m c√°c thu·ªôc t√≠nh flex ƒë·ªÉ cƒÉn ch·ªânh icon */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem; /* 4px */
}
.rt-infographic-summary-card .label .feather {
    width: 1em;
    height: 1em;
}
/* === END: S·ª¨A L·ªñI (v1.3) === */

/* === START: Y√äU C·∫¶U 5 (v1.6) - L√†m d·ªãu m√†u header === */
.sknv-thidua-column-header {
    display: flex;
    align-items: center;
    gap: 0.5rem; /* gap-2 */
    padding: 0.75rem 1rem; /* p-3 */
    border-bottom: 1px solid; /* C·∫≠p nh·∫≠t border color b√™n d∆∞·ªõi */
} 
.sknv-thidua-column-header .feather {
    width: 1.25rem; /* h-5 w-5 */
    height: 1.25rem;
    stroke-width: 2.5;
}
.sknv-thidua-column-header h4 {
    font-size: 1.125rem; /* text-lg */
    font-weight: 700; /* font-bold */
}
.sknv-thidua-column-header.header-blue {
    background-color: #dbeafe; /* blue-100 */
    color: #1e40af; /* blue-800 */
    border-color: #bfdbfe; /* blue-200 */
} 
.sknv-thidua-column-header.header-yellow {
    background-color: #fef9c3; /* yellow-100 */
    color: #854d0e; /* yellow-800 */
    border-color: #fde68a; /* yellow-200 */
} 
.sknv-thidua-column-header.header-red {
    background-color: #fee2e2; /* red-100 */
    color: #991b1b; /* red-800 */
    border-color: #fecaca; /* red-200 */
} 
/* === END: Y√äU C·∫¶U 5 (v1.6) === */


/* === START: (v1.6) Y√™u c·∫ßu t√πy ch·ªânh cho chi ti·∫øt thi ƒëua (Y√™u c·∫ßu 1 & 4) === */

/* Y√™u c·∫ßu 1: Ghi ƒë√® header nh√¢n vi√™n (lo·∫°i b·ªè m√†u t√≠m) */
#sknv-thidua-detail-capture-area .sknv-detail-header-card {
    background-color: #ffffff !important;
    border-color: #e5e7eb !important;
    border-top-width: 4px !important;
    border-top-color: #6b7280 !important; /* gray-500 */
} 
/* === START: THAY ƒê·ªîI (v1.7) === */
#sknv-thidua-detail-capture-area .sknv-detail-header-card .name {
    color: #166534 !important; /* YC 1 (v1.7): ƒê·ªïi sang xanh l√° c√¢y ƒë·∫≠m (green-800) */
} 
/* === END: THAY ƒê·ªîI (v1.7) === */
#sknv-thidua-detail-capture-area .sknv-detail-header-card .department {
    color: #374151 !important; /* gray-700 */
} 
#sknv-thidua-detail-capture-area .sknv-detail-header-card .sknv-card__avatar {
    background-color: #e5e7eb !important; /* gray-200 */
} 
#sknv-thidua-detail-capture-area .sknv-detail-header-card .sknv-card__avatar svg {
    color: #374151 !important; /* gray-700 */
} 

/* Y√™u c·∫ßu 4: Th√™m m√†u cho c√°c th·∫ª KPI */
.rt-infographic-summary-card .value.is-dat {
    color: #16a34a !important; /* green-600 */
} 
.rt-infographic-summary-card .value.is-positive {
    color: #2563eb !important; /* blue-600 */
} 
.rt-infographic-summary-card .value.is-gan-dat {
    color: #f59e0b !important; /* amber-500 */
} 
.rt-infographic-summary-card .value.is-can-co-gang,
.rt-infographic-summary-card .value.is-negative {
    color: #dc2626 !important; /* red-600 */
} 

/* === END: (v1.6) Y√™u c·∫ßu t√πy ch·ªânh === */

--- END FILE: ./styles/specific-sknv.css ---

--- START FILE: ./styles/specific-tdv.css ---
/* Version 1.0 - Specific: TDV (Refactored from v6.19) */
/* Ch·ª©a c√°c style CH·ªà d√†nh ri√™ng cho tab Thi ƒêua V√πng (TDV) */

/* === B·∫ÆT ƒê·∫¶U: B·ªê C·ª§C CHO THI ƒêUA V√ôNG & THI ƒêUA L≈®Y K·∫æ (V5.9) === */
.tdv-rows-container { 
    display: flex; 
    flex-direction: column; 
    gap: 1.5rem; 
}
#subtab-luyke-thi-dua .tdv-row-body {
    display: grid;
    grid-template-columns: 1fr; /* M·∫∑c ƒë·ªãnh 1 c·ªôt cho mobile */
    gap: 1rem;
}
@media (min-width: 768px) { /* 2 c·ªôt cho tablet tr·ªü l√™n */
    #subtab-luyke-thi-dua .tdv-row-body {
        grid-template-columns: repeat(2, 1fr);
    }
}
/* === END: B·ªê C·ª§C M·ªöI === */

.tdv-infographic-card {
    background-color: transparent;
    border: none;
    box-shadow: none;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.tdv-header { 
    text-align: center; 
    margin-bottom: 2rem; 
}
.tdv-supermarket-name { 
    font-size: 2em; 
    font-weight: bold; 
    color: #005f73; 
}
.tdv-total-prize-container { 
    margin-top: 0.5rem; 
    font-size: 1.5em; 
    font-weight: bold; 
}
.tdv-total-prize-label { 
    color: #6b7280; 
    font-weight: normal; 
}
.tdv-total-prize-value { 
    color: #d90429; 
    margin-left: 0.5rem; 
}

.tdv-summary-grid { 
    display: grid; 
    grid-template-columns: repeat(2, 1fr); 
    gap: 1rem; 
    margin-top: 1.5rem; 
    margin-bottom: 2rem; 
}
@media (min-width: 768px) { 
    .tdv-summary-grid { 
        grid-template-columns: repeat(5, 1fr); 
    } 
}
.tdv-summary-item { 
    background-color: #ffffff; 
    border-radius: 8px;
    padding: 1rem; 
    text-align: center; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
    border: 1px solid #e5e7eb; 
}
/* === START: S·ª≠a m√†u v√† font-weight cho .tdv-summary-value === */
.tdv-summary-value {
    display: block;
    font-size: 1.75em;
    font-weight: 800; /* TƒÉng ƒë·ªô ƒë·∫≠m */
    color: #005f73; /* ƒê·ªïi m√†u xanh ƒë·∫≠m h∆°n */
}
/* === END: S·ª≠a m√†u === */
.tdv-summary-label { 
    display: block; 
    font-size: 0.9em; 
    color: #4a5568; 
    margin-top: 0.25rem; 
}
/* === START: Th√™m class m√†u cho t·ª∑ l·ªá ƒë·∫°t === */
.tdv-tyledat-high { 
    color: #2563eb !important; /* blue-600 */
} 
.tdv-tyledat-low { 
    color: #dc2626 !important; /* red-600 */
} 
/* === END: Th√™m class m√†u === */

.tdv-row { 
    background-color: #fdfdfd; 
    border-radius: 8px; 
    padding: 1rem; 
    border: 1px solid #dee2e6; 
}
.tdv-row-title { 
    font-size: 1.2em; 
    font-weight: bold; 
    padding-bottom: 0.75rem; 
    margin-bottom: 1rem; 
    border-bottom: 2px solid; 
    line-height: 1.3; 
}
.tdv-row-title--prize { 
    border-color: #0d6efd; 
    color: #0d6efd; 
}
.tdv-row-title--soon-prize { 
    border-color: #e9c46a; 
    color: #e9c46a; 
}
.tdv-row-title--effort { 
    border-color: #6c757d; 
    color: #6c757d; 
}
.tdv-row-subtitle { 
    font-size: 0.8em; 
    font-weight: normal; 
    color: #d90429; 
}

/* === START: S·ª≠a layout 4 c·ªôt cho Thi ƒëua v√πng (S·ª¨A L·∫†I SELECTOR) === */
/* *** FIX: Corrected CSS selector to use #subtab-luyke-thidua-vung *** */
#subtab-luyke-thidua-vung .tdv-row-body {
    display: grid;
    grid-template-columns: repeat(1, 1fr); /* 1 c·ªôt cho mobile */
    gap: 1rem;
}
@media (min-width: 768px) { /* 2 c·ªôt cho tablet */
    #subtab-luyke-thidua-vung .tdv-row-body {
        grid-template-columns: repeat(2, 1fr);
    }
}
@media (min-width: 1280px) { /* 4 c·ªôt cho desktop l·ªõn */
    #subtab-luyke-thidua-vung .tdv-row-body {
        grid-template-columns: repeat(4, 1fr);
    }
}
/* === END: S·ª≠a layout === */
.tdv-row-body--effort { 
    display: block; 
}

.tdv-item-card { 
    background: #fff; 
    border: 1px solid #e0e0e0; 
    border-radius: 6px;
    padding: 12px; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
    overflow: hidden; 
}
.tdv-item-card__title { 
    font-weight: bold;
    margin: 0 0 10px 0; 
    color: #333; 
}
.tdv-progress-bar-container {
    width: 100%;
    background-color: #e9ecef;
    border-radius: 20px;
    height: 28px;
    position: relative;
    font-size: 0.85em;
    font-weight: bold;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
}
.tdv-progress-bar { 
    height: 100%; 
    transition: width 0.5s ease; 
    position: absolute; 
    top: 0; 
    left: 0; 
}
.tdv-progress-bar--blue { 
    background-color: #0d6efd; 
}
.tdv-progress-bar--yellow { 
    background-color: #e9c46a; 
}
.tdv-progress-bar__text {
    position: relative;
    z-index: 1;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
    color: white;
}
.tdv-item-card__details { 
    font-size: 0.85em; 
    color: #555; 
    margin-top: 8px; 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 5px; 
}
.tdv-item-card__details span { 
    display: block; 
}
.tdv-item-card__details strong { 
    color: #000; 
}
.tdv-item-card__prize { 
    grid-column: 1 / -1; 
    font-weight: bold !important; 
    color: #d90429; 
    margin-top: 4px; 
}

.tdv-effort-subgroup { 
    margin-bottom: 1rem; 
}
.tdv-effort-subgroup:last-child { 
    margin-bottom: 0; 
}
.tdv-effort-subgroup__title { 
    font-weight: bold; 
    margin: 0 0 10px 0; 
    padding-bottom: 5px; 
    border-bottom: 1px solid #dee2e6; 
}
.tdv-effort-subgroup__title--potential { 
    color: #fd7e14; 
}
.tdv-effort-subgroup__title--major { 
    color: #6c757d; 
}
.tdv-effort-list { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 8px; 
}
.tdv-effort-item { 
    background-color: #f1f3f5; 
    color: #495057; 
    padding: 5px 10px; 
    border-radius: 15px; 
    font-size: 0.9em; 
}
--- END FILE: ./styles/specific-tdv.css ---

--- START FILE: ./styles/tables.css ---
/* Version 1.0 - Tables styles (Refactored from v6.19) */
/* Ch·ª©a c√°c class chung cho b·∫£ng bi·ªÉu: borders, striping, header colors, sort indicators */

.table-bordered { 
    border-collapse: collapse; 
}
.table-bordered th, .table-bordered td { 
    border: 1px solid #e5e7eb; 
}
.table-striped tbody tr:nth-child(even) { 
    background-color: #f9fafb; 
}
.table-footer { 
    background-color: hsl(210, 20%, var(--header-lightness));
    border-top: 2px solid #9ca3af; 
}
.cell-performance.is-below { 
    background-color: hsl(0, 80%, var(--below-target-lightness)) !important; 
}

/* === Sort Indicators === */
.sortable { 
    cursor: pointer; 
    position: relative; 
    user-select: none; 
}
.sort-indicator { 
    display: inline-flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    width: 1em; 
    height: 1em; 
    margin-left: 4px; 
    vertical-align: middle; 
    color: #9ca3af; 
    transition: color 0.2s ease-in-out; 
}
.sortable .sort-indicator::before { 
    content: '‚ñ≤'; 
    font-size: 0.8em; 
    line-height: 0.5; 
    opacity: 0.4; 
}
.sortable .sort-indicator::after { 
    content: '‚ñº'; 
    font-size: 0.8em; 
    line-height: 0.5; 
    opacity: 0.4; 
}
.sortable:hover .sort-indicator { 
    color: #374151; 
}
.sortable.sorted-asc .sort-indicator::before { 
    opacity: 1; 
    color: #3b82f6; 
}
.sortable.sorted-asc .sort-indicator::after { 
    opacity: 0.4; 
}
.sortable.sorted-desc .sort-indicator::after { 
    opacity: 1; 
    color: #3b82f6; 
}
.sortable.sorted-desc .sort-indicator::before { 
    opacity: 0.4; 
}

/* === Draggable Headers === */
.draggable-header {
    cursor: move;
    cursor: grab;
}
.draggable-header:active {
    cursor: grabbing;
}
.sortable-ghost {
    opacity: 0.4;
    background-color: #c7d2fe; /* indigo-200 */
}
.sortable-drag {
    opacity: 0.95;
    transform: rotate(-2deg);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}


/* === Table Header Colors === */
.header-bg-blue { background-color: hsl(217, 95%, var(--special-header-lightness)) !important; color: hsl(217, 80%, var(--header-text-lightness)) !important; }
.header-bg-green { background-color: hsl(145, 80%, var(--special-header-lightness)) !important; color: hsl(145, 70%, var(--header-text-lightness)) !important; }
.header-bg-yellow { background-color: hsl(45, 95%, var(--special-header-lightness)) !important; color: hsl(45, 80%, var(--header-text-lightness)) !important; }

.header-group-1 { background-color: hsl(30, 90%, var(--header-lightness)); }
.header-group-2 { background-color: hsl(90, 90%, var(--header-lightness)); }
.header-group-3 { background-color: hsl(180, 90%, var(--header-lightness)); }
.header-group-4 { background-color: hsl(240, 90%, var(--header-lightness)); }
.header-group-5 { background-color: hsl(300, 90%, var(--header-lightness)); }
.header-group-6 { background-color: hsl(0, 90%, var(--header-lightness)); }
.header-group-7 { background-color: hsl(160, 80%, var(--header-lightness)) !important; }
.header-group-8 { background-color: hsl(280, 80%, var(--header-lightness)) !important; }
.header-group-9 { background-color: hsl(70, 80%, var(--header-lightness)) !important; }
.header-group-10 { background-color: hsl(190, 80%, var(--header-lightness)) !important; }
.header-group-11 { background-color: hsl(340, 80%, var(--header-lightness)) !important; }
.header-group-12 { background-color: hsl(20, 80%, var(--header-lightness)) !important; }

.department-header-tv { background-color: #e0e7ff; color: #3730a3; }
.department-header-kho { background-color: #d1fae5; color: #065f46; }
.department-header-tt { background-color: #fef3c7; color: #92400e; }
.category-header-ict { background-color: #dbeafe; color: #1e40af; }
.category-header-phukien { background-color: #fee2e2; color: #991b1b; }
.category-header-giadung { background-color: #fef9c3; color: #854d0e; }
.category-header-ce { background-color: #e0f2fe; color: #0c4a6e; }
.category-header-baohiem { background-color: #f3e8ff; color: #6b21a8; }
.header-bg-indigo { background-color: #e0e7ff; color: #3730a3; }
.header-bg-purple { background-color: #f3e8ff; color: #6b21a8; }

.qdc-group-title { font-weight: 600; }
.qdc-group-ict { background-color: hsl(190, 80%, var(--special-header-lightness)); }
.qdc-group-vas { background-color: hsl(140, 80%, var(--special-header-lightness)); }
.qdc-group-giadung { background-color: hsl(0, 80%, var(--special-header-lightness)); }
.qdc-group-sim { background-color: hsl(40, 80%, var(--special-header-lightness)); }

.competition-header-doanhthu { border-color: #a78bfa; background-color: hsl(260, 90%, var(--bg-lightness)); }
.competition-header-soluong { border-color: #facc15; background-color: hsl(50, 90%, var(--bg-lightness)); }
.header-highlight-special { background-color: hsl(25, 90%, var(--header-lightness)) !important; }
.competition-row-below-100 td { background-color: #fee2e2; color: #991b1b; }

.header-highlight { background-color: hsl(50, 95%, var(--special-header-lightness)) !important; }
--- END FILE: ./styles/tables.css ---

--- START FILE: ./styles/vendor.css ---
/* Version 1.0 - Vendor overrides (Refactored from v6.19) */
/* Ch·ª©a c√°c style ghi ƒë√® l√™n th∆∞ vi·ªán b√™n th·ª© ba, v√≠ d·ª•: Choices.js */

#dtnv-realtime-employee-selector-container .choices__inner { 
    min-width: 300px; 
}
#dtnv-realtime-employee-selector-container .choices__list--single { 
    min-width: 300px; 
}

.choices__inner { 
    min-height: 42px; 
}
.choices__list--multiple .choices__item { 
    background-color: #3b82f6; 
    border-color: #2563eb; 
}

#goal-drawer .choices__inner {
    min-width: 250px;
}

#goal-drawer .choices__list--dropdown,
#goal-drawer .choices__list[aria-expanded] {
    min-width: 100%;
    width: auto;
    word-break: normal;
}

#goal-drawer .choices__list--multiple .choices__item {
    display: inline-flex;
    align-items: center;
    background-color: #3b82f6;
    border: 1px solid #2563eb;
    color: white;
    border-radius: 9999px;
    padding: 2px 8px;
    font-size: 0.8em;
    font-weight: 500;
    margin: 2px 4px 2px 0;
}
#goal-drawer .choices__inner {
    height: auto !important;
    min-height: 42px !important;
    display: flex !important;
    flex-wrap: wrap !important;
}
--- END FILE: ./styles/vendor.css ---

--- START FILE: ./tab-luyke.js ---
// Version 3.3 - Add more detailed logging in render function
// MODULE: Ch·ªãu tr√°ch nhi·ªám cho Tab S·ª©c kh·ªèe Si√™u th·ªã (L≈©y k·∫ø)

import { appState } from './state.js';
import { ui } from './ui.js';
import { services } from './services.js';
import { settingsService } from './modules/settings.service.js';
import { highlightService } from './modules/highlight.service.js';

const luykeTab = {
    render() {
        console.log("[tab-luyke.js render] === Starting render ==="); // Log m·ªõi (v3.3)
        console.log(`[tab-luyke.js render] appState lengths - DSNV: ${appState.danhSachNhanVien?.length}, YCX: ${appState.ycxData?.length}`); // (v3.2)

        if (appState.danhSachNhanVien.length === 0) {
            console.log("[tab-luyke.js render] DSNV tr·ªëng, hi·ªÉn th·ªã placeholder."); // (v3.2)
            ui.togglePlaceholder('health-section', true);
            return;
        }
        ui.togglePlaceholder('health-section', false);
        console.log("[tab-luyke.js render] DSNV found, proceeding."); // Log m·ªõi (v3.3)

        try {
            services.parseCompetitionDataFromLuyKe(document.getElementById('paste-luyke')?.value || '');
            console.log("[tab-luyke.js render] Parsed competition data from paste."); // Log m·ªõi (v3.3)
        } catch(e) {
            console.error("[tab-luyke.js render] Error parsing competition data:", e); // Log m·ªõi (v3.3)
        }


        const activeSubTabBtn = document.querySelector('#luyke-subtabs-nav .sub-tab-btn.active');
        const activeSubTabId = activeSubTabBtn ? activeSubTabBtn.dataset.target : 'subtab-luyke-sieu-thi';
        console.log(`[tab-luyke.js render] Active subtab: ${activeSubTabId}`); // (v3.2)

        const selectedWarehouse = document.getElementById('luyke-filter-warehouse')?.value || '';
        const selectedDept = document.getElementById('luyke-filter-department')?.value || '';
        const selectedNames = appState.choices.luyke_employee ? appState.choices.luyke_employee.getValue(true) : [];
        const selectedDates = appState.choices.luyke_date_picker ? appState.choices.luyke_date_picker.selectedDates : [];
        console.log(`[tab-luyke.js render] Filters - Warehouse: '${selectedWarehouse}', Dept: '${selectedDept}', Names: ${selectedNames.length}, Dates: ${selectedDates.length}`); // Log m·ªõi (v3.3)

        let filteredYCXData = appState.ycxData;
        if (selectedDates && selectedDates.length > 0) {
            console.log("[tab-luyke.js render] Filtering YCX data by date..."); // Log m·ªõi (v3.3)
            const startOfDay = (date) => new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
            const selectedDateSet = new Set(selectedDates.map(d => startOfDay(d)));
            filteredYCXData = appState.ycxData.filter(row => row.ngayTao instanceof Date && !isNaN(row.ngayTao) && selectedDateSet.has(startOfDay(row.ngayTao)));
        }
        console.log(`[tab-luyke.js render] Filtered YCX data length: ${filteredYCXData?.length}`); // (v3.2)

        const goals = settingsService.getLuykeGoalSettings(selectedWarehouse).goals;
        console.log("[tab-luyke.js render] Loaded goals:", goals); // Log m·ªõi (v3.3)
        try {
            appState.masterReportData.luyke = services.generateMasterReportData(filteredYCXData, goals);
            console.log(`[tab-luyke.js render] Generated masterReportData.luyke length: ${appState.masterReportData.luyke?.length}`); // (v3.2)
        } catch (e) {
            console.error("[tab-luyke.js render] Error generating master report data:", e); // Log m·ªõi (v3.3)
             ui.showNotification("L·ªói khi t√≠nh to√°n b√°o c√°o t·ªïng h·ª£p.", "error"); // Log m·ªõi (v3.3)
             appState.masterReportData.luyke = []; // Reset ƒë·ªÉ tr√°nh l·ªói ti·∫øp theo
        }


        let filteredReport = appState.masterReportData.luyke;
        if (selectedWarehouse) filteredReport = filteredReport.filter(nv => nv.maKho == selectedWarehouse);
        if (selectedDept) filteredReport = filteredReport.filter(nv => nv.boPhan === selectedDept);
        if (selectedNames && selectedNames.length > 0) filteredReport = filteredReport.filter(nv => selectedNames.includes(String(nv.maNV)));
        console.log(`[tab-luyke.js render] Final filtered report length for UI: ${filteredReport?.length}`); // (v3.2)

        // --- Logic render theo Subtab ---
        try { // Th√™m try...catch cho ph·∫ßn render UI (v3.3)
            if (activeSubTabId === 'subtab-luyke-sieu-thi') {
                console.log("[tab-luyke.js render] Rendering subtab 'Si√™u th·ªã L≈©y k·∫ø'."); // (v3.2)
                if(filteredReport.length === 0 && appState.ycxData.length > 0) {
                     console.warn("[tab-luyke.js render] Filtered report is empty, but YCX data exists. Check filters or master report generation."); // (v3.2)
                }
                const supermarketReport = services.aggregateReport(filteredReport, selectedWarehouse);
                console.log("[tab-luyke.js render] Aggregated supermarket report:", JSON.stringify(supermarketReport).substring(0, 300) + "..."); // (v3.2 - S·ª≠a ƒë·ªïi v3.3)
                const numDays = selectedDates.length > 0 ? selectedDates.length : new Set(appState.ycxData.map(row => row.ngayTao instanceof Date ? new Date(row.ngayTao).toDateString() : null).filter(Boolean)).size || 1;
                console.log(`[tab-luyke.js render] numDays calculated: ${numDays}`); // Log m·ªõi (v3.3)

                console.log("[tab-luyke.js render] Calling ui.updateLuykeSupermarketTitle..."); // Log m·ªõi (v3.3)
                ui.updateLuykeSupermarketTitle(selectedWarehouse, new Date());
                console.log("[tab-luyke.js render] Calling ui.renderLuykeEfficiencyTable..."); // Log m·ªõi (v3.3)
                ui.renderLuykeEfficiencyTable(supermarketReport, goals);
                console.log("[tab-luyke.js render] Calling ui.renderLuykeCategoryDetailsTable..."); // Log m·ªõi (v3.3)
                ui.renderLuykeCategoryDetailsTable(supermarketReport, numDays);
                console.log("[tab-luyke.js render] Calling ui.renderLuykeQdcTable..."); // Log m·ªõi (v3.3)
                ui.renderLuykeQdcTable(supermarketReport, numDays);

                console.log("[tab-luyke.js render] Calling services.generateLuyKeChuaXuatReport..."); // Log m·ªõi (v3.3)
                const chuaXuatReport = services.generateLuyKeChuaXuatReport(filteredYCXData);
                console.log("[tab-luyke.js render] Calling ui.renderChuaXuatTable..."); // Log m·ªõi (v3.3)
                ui.renderChuaXuatTable(chuaXuatReport);

                console.log("[tab-luyke.js render] Calling services.parseLuyKePastedData..."); // Log m·ªõi (v3.3)
                const pastedData = services.parseLuyKePastedData(document.getElementById('paste-luyke')?.value || '');
                console.log("[tab-luyke.js render] Calling ui.displayHealthKpiTable..."); // Log m·ªõi (v3.3)
                ui.displayHealthKpiTable(pastedData, goals);

            } else if (activeSubTabId === 'subtab-luyke-thi-dua') {
                 console.log("[tab-luyke.js render] Rendering subtab 'Thi ƒëua L≈©y k·∫ø'."); // (v3.2)
                const switcherPlaceholder = document.getElementById('luyke-thidua-view-selector-placeholder'); // Should be removed or updated in ui.js if still used
                const contentContainer = document.getElementById('luyke-competition-content');

                if (contentContainer) {
                     contentContainer.innerHTML = '<div id="luyke-competition-infographic-container" class="mt-4"></div>';
                } else {
                     console.error("[tab-luyke.js render] Missing #luyke-competition-content container");
                }

                const activeViewBtn = document.querySelector('#luyke-thidua-view-selector .view-switcher__btn.active');
                const viewType = activeViewBtn ? activeViewBtn.dataset.view : 'summary';
                console.log(`[tab-luyke.js render] Calling ui.displayCompetitionResultsFromLuyKe with viewType: ${viewType}`); // Log m·ªõi (v3.3)
                ui.displayCompetitionResultsFromLuyKe(document.getElementById('paste-luyke')?.value || '', viewType);

            } else if (activeSubTabId === 'subtab-luyke-thidua-vung') {
                console.log("[tab-luyke.js render] Rendering subtab 'Thi ƒëua V√πng'."); // (v3.2)
                const controlsCard = document.querySelector('#subtab-luyke-thidua-vung .content-card');
                if (controlsCard) {
                    controlsCard.classList.remove('hidden');
                     console.log("[tab-luyke.js render] Thi ƒëua V√πng: Ensured controlsCard is visible."); // (v3.2)
                } else {
                     console.error("[tab-luyke.js render] Thi ƒëua V√πng: Cannot find controlsCard."); // (v3.2)
                }

                const choicesInstance = appState.choices.thiDuaVung_sieuThi;
                const selectedSupermarket = choicesInstance ? choicesInstance.getValue(true) : null;
                const hasFileData = appState.thiDuaVungChiTiet && appState.thiDuaVungChiTiet.length > 0;
                console.log("[tab-luyke.js render] Thi ƒëua V√πng: selectedSupermarket:", selectedSupermarket, "hasFileData:", hasFileData); // (v3.2)

                if (selectedSupermarket && hasFileData) {
                    const reportData = services.generateThiDuaVungReport(selectedSupermarket);
                     console.log("[tab-luyke.js render] Thi ƒëua V√πng: Calling ui.renderThiDuaVungInfographic with data:", reportData); // (v3.2)
                    ui.renderThiDuaVungInfographic(reportData);
                } else {
                    const container = document.getElementById('thidua-vung-infographic-container');
                    if (container) {
                        container.innerHTML = `<div class="placeholder-message">Vui l√≤ng t·∫£i file v√† ch·ªçn m·ªôt si√™u th·ªã ƒë·ªÉ xem b√°o c√°o.</div>`;
                          console.log("[tab-luyke.js render] Thi ƒëua V√πng: Rendered placeholder."); // (v3.2)
                    } else {
                         console.error("[tab-luyke.js render] Thi ƒëua V√πng: Cannot find infographic container."); // (v3.2)
                    }
                }
            } else {
                 console.warn(`[tab-luyke.js render] Unknown activeSubTabId: ${activeSubTabId}`); // Log m·ªõi (v3.3)
            }
        } catch (uiError) {
             console.error(`[tab-luyke.js render] Error during UI rendering for subtab ${activeSubTabId}:`, uiError); // Log m·ªõi (v3.3)
             ui.showNotification("ƒê√£ x·∫£y ra l·ªói khi hi·ªÉn th·ªã d·ªØ li·ªáu tab.", "error"); // Log m·ªõi (v3.3)
             const errorContainer = document.getElementById(activeSubTabId);
             if (errorContainer) {
                 errorContainer.innerHTML = `<div class="placeholder-message notification-error">L·ªói hi·ªÉn th·ªã d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra Console (F12) ƒë·ªÉ bi·∫øt chi ti·∫øt ho·∫∑c th·ª≠ t·∫£i l·∫°i trang.</div>`;
             }
        }


        console.log("[tab-luyke.js render] Calling highlightService..."); // Log m·ªõi (v3.3)
        highlightService.populateHighlightFilters('luyke', filteredYCXData, filteredReport);
        highlightService.applyHighlights('luyke');
        console.log("[tab-luyke.js render] === Render complete ==="); // (v3.2 - S·ª≠a ƒë·ªïi v3.3)
    },
};

export { luykeTab };
--- END FILE: ./tab-luyke.js ---

--- START FILE: ./tab-sknv.js ---
// Version 4.8 - Fix competition layout (use grid instead of stack)
// Version 4.3 - Refactor: Use globalCompetitionConfigs for report calculation
// MODULE: TAB SKNV
// Ch·ªãu tr√°ch nhi·ªám render v√† x·ª≠ l√Ω logic cho tab "S·ª©c kh·ªèe nh√¢n vi√™n"

import { appState } from './state.js';
import { services } from './services.js';
import { ui } from './ui.js';
import { settingsService } from './modules/settings.service.js';
import { highlightService } from './modules/highlight.service.js';
import { dragDroplisteners } from './event-listeners/listeners-dragdrop.js';
import { uiSknv } from './ui-sknv.js'; // Import uiSknv ƒë·ªÉ g·ªçi h√†m render m·ªõi
import { uiCompetition } from './ui-competition.js'; // Import logic render "Theo Ch∆∞∆°ng Tr√¨nh"

export const sknvTab = {
    render() {
    
    console.log("[tab-sknv.js render] === Starting render ==="); 
        console.log(`[tab-sknv.js render] Current appState lengths - DSNV: ${appState.danhSachNhanVien?.length}, YCX: ${appState.ycxData?.length}`); 

        if (!appState.danhSachNhanVien || appState.danhSachNhanVien.length === 0) { 
            console.warn("[tab-sknv.js render] DSNV is empty, showing placeholder."); 
            ui.togglePlaceholder('health-employee-section', true); 
            return; 
        }

        ui.togglePlaceholder('health-employee-section', false); 
        console.log("[tab-sknv.js render] DSNV found, proceeding."); 

        try {
            services.parseCompetitionDataFromLuyKe(document.getElementById('paste-luyke')?.value || '');
            console.log("[tab-sknv.js render] Parsed competition data from paste."); 
        } catch(e) {
             console.error("[tab-sknv.js render] Error parsing competition data:", e); 
        }

        const activeSubTabBtn = document.querySelector('#employee-subtabs-nav .sub-tab-btn.active'); 
        const activeSubTabId = activeSubTabBtn ? activeSubTabBtn.dataset.target : 'subtab-sknv';
        console.log(`[tab-sknv.js render] Active subtab ID: ${activeSubTabId}`); 

        const selectedWarehouse = document.getElementById('sknv-filter-warehouse')?.value || ''; 
        const selectedDept = document.getElementById('sknv-filter-department')?.value || ''; 
        const selectedNames = appState.choices.sknv_employee ? appState.choices.sknv_employee.getValue(true) : []; 
        const selectedDates 
= appState.choices.sknv_date_picker ? appState.choices.sknv_date_picker.selectedDates : []; 
        console.log(`[tab-sknv.js render] Filters - Warehouse: '${selectedWarehouse}', Dept: '${selectedDept}', Names: ${selectedNames.length}, Dates: ${selectedDates.length}`); 

        let filteredYCXData = appState.ycxData; 
        if (selectedDates && selectedDates.length > 0) { 
            console.log("[tab-sknv.js render] Filtering YCX data by date..."); 
            const startOfDay = (date) => new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime(); 
            const selectedDateSet = new Set(selectedDates.map(d => startOfDay(d))); 
            filteredYCXData = appState.ycxData.filter(row => row.ngayTao instanceof Date && !isNaN(row.ngayTao) && selectedDateSet.has(startOfDay(row.ngayTao))); 
        }
        console.log(`[tab-sknv.js render] Filtered YCX data length: ${filteredYCXData?.length}`); 

        const goals = settingsService.getLuykeGoalSettings(selectedWarehouse).goals; 
        console.log("[tab-sknv.js render] Loaded goals:", goals); 
        try {
            appState.masterReportData.sknv = services.generateMasterReportData(filteredYCXData, goals, false); 
            console.log(`[tab-sknv.js render] Generated masterReportData.sknv length: ${appState.masterReportData.sknv?.length}`); 
        } catch(e) {
             console.error("[tab-sknv.js render] Error generating master report data:", e); 
             ui.showNotification("L·ªói khi t√≠nh to√°n b√°o c√°o SKNV.", "error");
             appState.masterReportData.sknv = []; 
        }


 
       let filteredReport = appState.masterReportData.sknv; 
        if (selectedWarehouse) filteredReport = filteredReport.filter(nv => nv.maKho == selectedWarehouse); 
        if (selectedDept) filteredReport = filteredReport.filter(nv => nv.boPhan === selectedDept); 
        if (selectedNames && selectedNames.length > 0) filteredReport = filteredReport.filter(nv => selectedNames.includes(String(nv.maNV))); 
        console.log(`[tab-sknv.js render] Final filtered report length for UI: ${filteredReport?.length}`); 

        console.log(`[tab-sknv.js render] Active subtab ID (re-check): ${activeSubTabId}`); 

        const detailInfo = appState.viewingDetailFor; 
        // === START: Y√äU C·∫¶U 4 (Th√™m check sknv-thidua-pasted) ===
        const isViewingDetail = detailInfo && (detailInfo.sourceTab === 'sknv' || detailInfo.sourceTab === 'dtnv-lk' || detailInfo.sourceTab === 'sknv-thidua-pasted'); 
        // === END: Y√äU C·∫¶U 4 ===
        console.log(`[tab-sknv.js render] Is viewing detail? ${isViewingDetail}. Detail Info:`, detailInfo); 

        try { 
            if (isViewingDetail) { 
                console.log(`[tab-sknv.js render] Rendering detail view for employee: ${detailInfo.employeeId}`); 
                
                if (activeSubTabId === 'subtab-sknv' && detailInfo.sourceTab === 'sknv') { 
                    const employeeData = appState.masterReportData.sknv.find(nv => String(nv.maNV) === String(detailInfo.employeeId)); 
                    console.log("[tab-sknv.js render] Calling ui.displaySknvReport (detail mode)."); 
                    ui.displaySknvReport(filteredReport, true); 

                } else if (activeSubTabId === 'subtab-doanhthu-lk' && detailInfo.sourceTab === 'dtnv-lk') { 
                    const employeeData = appState.masterReportData.sknv.find(nv => String(nv.maNV) === String(detailInfo.employeeId)); 
                    console.log("[tab-sknv.js render] Calling services.generateLuyKeEmployeeDetailReport..."); 
                    const luykeDetailData = services.generateLuyKeEmployeeDetailReport(detailInfo.employeeId, filteredYCXData); 
                    console.log("[tab-sknv.js render] Calling ui.renderLuykeEmployeeDetail..."); 
                    ui.renderLuykeEmployeeDetail(luykeDetailData, employeeData, 'dtnv-lk-details-container'); 

                // === START: Y√äU C·∫¶U 4 (Render chi ti·∫øt) ===
                } else if (activeSubTabId === 'subtab-hieu-qua-thi-dua-lk' && detailInfo.sourceTab === 'sknv-thidua-pasted') {
                    console.log("[tab-sknv.js render] Calling uiSknv.renderPastedCompetitionDetail...");
                    // T√¨m data NV t·ª´ appState.pastedThiDuaReportData
                    const employeePastedData = appState.pastedThiDuaReportData.find(nv => String(nv.maNV) === String(detailInfo.employeeId));
                    // L·∫•y TBT b·ªô ph·∫≠n ƒë√£ l∆∞u
                    const deptAverages = uiSknv._lastPastedAverages || {};
                    
                    // G·ªçi h√†m render chi ti·∫øt
                    uiSknv.renderPastedCompetitionDetail(employeePastedData, deptAverages);
                    
                    // ·∫®n c√°c container t√≥m t·∫Øt
                    document.getElementById('competition-report-container-lk')?.classList.add('hidden');
                    document.getElementById('pasted-competition-report-container')?.classList.add('hidden');
                    document.getElementById('pasted-competition-detail-container')?.classList.remove('hidden');

                // === END: Y√äU C·∫¶U 4 ===
                } else {
                    console.log(`[tab-sknv.js render] Viewing detail but not on the correct subtab (${activeSubTabId}), rendering summary instead.`); 
                    this.renderSummaryViews(activeSubTabId, filteredReport, filteredYCXData); 
                }
            } else {
                
                console.log("[tab-sknv.js render] Rendering summary views."); 
                this.renderSummaryViews(activeSubTabId, filteredReport, filteredYCXData); 
            }
        
} catch (uiError) {
             console.error(`[tab-sknv.js render] Error during UI rendering for subtab ${activeSubTabId}:`, uiError); 
             ui.showNotification("ƒê√£ x·∫£y ra l·ªói khi hi·ªÉn th·ªã d·ªØ li·ªáu tab SKNV.", "error"); 
             const errorContainer = document.getElementById(activeSubTabId);
             if (errorContainer) {
                 errorContainer.innerHTML = `<div class="placeholder-message notification-error">L·ªói hi·ªÉn th·ªã d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra Console (F12) ƒë·ªÉ bi·∫øt chi ti·∫øt ho·∫∑c th·ª≠ t·∫£i l·∫°i trang.</div>`;
             }
        }


         console.log("[tab-sknv.js render] Calling highlightService..."); 
         highlightService.populateHighlightFilters('sknv', filteredYCXData, filteredReport); 
        highlightService.applyHighlights('sknv'); 

        // === START: MODIFIED (v4.1) - S·ª≠a l·ªói k√©o th·∫£ ===
        // Ch·ªâ kh·ªüi t·∫°o k√©o th·∫£ khi ·ªü view t√≥m t·∫Øt (kh√¥ng ph·∫£i chi ti·∫øt)
        if (!isViewingDetail) {
            // V√† ch·ªâ kh·ªüi t·∫°o cho container c·ªßa tab con ƒëang ho·∫°t ƒë·ªông
            
            if (activeSubTabId === 'subtab-hieu-qua-khai-thac-luy-ke') {
                // K√≠ch ho·∫°t k√©o th·∫£ cho b·∫£ng "Hi·ªáu qu·∫£ NV LK"
                console.log("[tab-sknv.js render] Initializing drag-drop for 'efficiency-report-container'."); 
                dragDroplisteners.initializeForContainer('efficiency-report-container');
            
            } else if (activeSubTabId === 'subtab-hieu-qua-thi-dua-lk') {
                // K√≠ch ho·∫°t k√©o th·∫£ cho tab "Thi ƒëua NV LK"
                const activeViewBtn = document.querySelector('#sknv-thidua-view-selector .view-switcher__btn.active');
                const viewType = activeViewBtn ? activeViewBtn.dataset.view : 'employee';
                
                // Ch·ªâ k√≠ch ho·∫°t cho view "Theo Nh√¢n Vi√™n" (n∆°i c√≥ c√°c th·∫ª k√©o th·∫£)
                if (viewType === 'employee') {
                    console.log("[tab-sknv.js render] Initializing drag-drop for 'pasted-competition-report-container'."); 
                    dragDroplisteners.initializeForContainer('pasted-competition-report-container'); 
                }
            }
        }
        // === END: MODIFIED (v4.1) ===
        
        console.log("[tab-sknv.js render] === Render complete ==="); 
    },

    renderSummaryViews(activeSubTabId, 
filteredReport, filteredYCXData) {
        console.log(`[tab-sknv.js renderSummaryViews] Rendering summary for subtab: ${activeSubTabId}`); 
        
        // *** START: MODIFIED (v3.8 & v4.0) ***
        if (activeSubTabId === 'subtab-hieu-qua-thi-dua-lk') { 
            console.log("[tab-sknv.js renderSummaryViews] Rendering 'Thi ƒëua NV LK' subtab.");
            
            // ========== START: LOGIC DI CHUY·ªÇN (SP ƒê·∫∂C QUY·ªÄN) ==========
            const activeViewBtn = document.querySelector('#sknv-thidua-view-selector .view-switcher__btn.active');
            const viewType = activeViewBtn ? activeViewBtn.dataset.view : 'employee'; // <<< Y√äU C·∫¶U 1: ƒê·ªïi m·∫∑c ƒë·ªãnh sang 'employee'
            console.log(`[tab-sknv.js renderSummaryViews] View type selected: ${viewType}`);

            const programContainer = document.getElementById('competition-report-container-lk');
            const employeeContainer = document.getElementById('pasted-competition-report-container');
            const detailContainer = document.getElementById('pasted-competition-detail-container');

            if (!programContainer || !employeeContainer || !detailContainer) { 
                console.error("[tab-sknv.js renderSummaryViews] Missing competition containers!");
                return;
            }

            detailContainer.classList.add('hidden'); // Lu√¥n ·∫©n chi ti·∫øt khi render t√≥m t·∫Øt

            // === START: THAY ƒê·ªîI (V4.8) ===
            // 1. T√¨m ho·∫∑c t·∫°o wrapper (Grid 2 c·ªôt)
            const mainContainer = document.getElementById('subtab-hieu-qua-thi-dua-lk');
            let programGridWrapper = document.getElementById('sknv-program-grid-wrapper');
            if (!programGridWrapper && mainContainer) {
                programGridWrapper = document.createElement('div');
                programGridWrapper.id = 'sknv-program-grid-wrapper';
                
                // ƒê·ªîI T·ª™ 'space-y-6' (x·∫øp ch·ªìng) SANG 'grid 2 c·ªôt'
                programGridWrapper.className = 'grid grid-cols-1 md:grid-cols-2 gap-6';
                
                // Ch√®n wrapper v√†o DOM, ngay sau view-selector
                const viewSelector = document.getElementById('sknv-thidua-view-selector');
                if (viewSelector) {
                    // ƒê·∫£m b·∫£o n√≥ ch∆∞a t·ªìn t·∫°i
                    if (!viewSelector.nextElementSibling || viewSelector.nextElementSibling.id !== 'sknv-program-grid-wrapper') {
                        viewSelector.after(programGridWrapper);
                    }
                } else {
                    mainContainer.prepend(programGridWrapper);
                }
            } else if (programGridWrapper) {
                // ƒê·∫£m b·∫£o n√≥ ƒë√∫ng class (tr∆∞·ªùng h·ª£p render l·∫°i)
                programGridWrapper.className = 'grid grid-cols-1 md:grid-cols-2 gap-6';
            }
            
            // 2. T√¨m ho·∫∑c t·∫°o container SPƒêQ
            let spContainer = document.getElementById('special-program-report-container-lk');
            if (!spContainer) {
                spContainer = document.createElement('div');
                spContainer.id = 'special-program-report-container-lk';
            }
            
            // 3. ƒê·∫£m b·∫£o c·∫£ 2 container b√°o c√°o n·∫±m TRONG wrapper
            // (appendChild s·∫Ω t·ª± ƒë·ªông di chuy·ªÉn n·∫øu n√≥ ƒë√£ t·ªìn t·∫°i ·ªü ch·ªó kh√°c)
            if (programGridWrapper) {
                programGridWrapper.appendChild(spContainer);
                programGridWrapper.appendChild(programContainer);
            }
            // === END: THAY ƒê·ªîI (V4.8) ===


            if (viewType === 'program') {
                
                // === START: DI CHUY·ªÇN LOGIC SPƒêQ V√ÄO ƒê√ÇY (v4.4) ===
                console.log("[tab-sknv.js renderSummaryViews] Calculating 'Special Product' report...");
                
                // T√≠nh to√°n d·ªØ li·ªáu SPƒêQ
                const specialReportData = services.calculateSpecialProductReport(
                    filteredYCXData, // D·ªØ li·ªáu YCX ƒë√£ ƒë∆∞·ª£c l·ªçc (ng√†y, kho, v.v.)
                    appState.globalSpecialPrograms
                );
                
                // Render SPƒêQ
                uiSknv.renderSpecialProgramReport(spContainer, specialReportData);
                if (specialReportData.length > 0) {
                    console.log("D·ªØ li·ªáu SPƒêQ (LK) ƒë√£ t√≠nh to√°n:", specialReportData);
                }
                // === END: DI CHUY·ªÇN LOGIC SPƒêQ (v4.4) ===


                console.log("[tab-sknv.js renderSummaryViews] Calculating 'program' report..."); 
                
                // === START REFACTOR 2 (B∆∞·ªõc 2e) ===
                // G·ªôp 2 danh s√°ch config
                const allConfigs = [ ...appState.globalCompetitionConfigs, ...appState.localCompetitionConfigs ];
                const competitionReportData = services.calculateCompetitionFocusReport( 
                    filteredYCXData, 
                    allConfigs // Truy·ªÅn danh s√°ch ƒë√£ g·ªôp
                );
                // === END REFACTOR 2 ===

                console.log("[tab-sknv.js renderSummaryViews] Calling uiCompetition.renderCompetitionUI..."); 
                uiCompetition.renderCompetitionUI('competition-report-container-lk', competitionReportData); 
                
                // === START: S·ª¨A L·ªñI LAYOUT (v4.5 -> v4.6) ===
                // Hi·ªÉn th·ªã grid wrapper, ·∫©n view "Theo Nh√¢n Vi√™n"
                if (programGridWrapper) {
                    programGridWrapper.classList.remove('hidden');
                }
                employeeContainer.classList.add('hidden');
                // === END: S·ª¨A L·ªñI LAYOUT (v4.5 -> v4.6) ===

            } else { // viewType === 'employee'
                
                // === START: S·ª¨A L·ªñI LAYOUT (v4.5 -> v4.6) ===
                // ·∫®n grid wrapper, hi·ªÉn th·ªã view "Theo Nh√¢n Vi√™n"
                if (programGridWrapper) {
                    programGridWrapper.classList.add('hidden');
                }
                employeeContainer.classList.remove('hidden');
                // === END: S·ª¨A L·ªñI LAYOUT (v4.5 -> v4.6) ===
                
                console.log("[tab-sknv.js renderSummaryViews] Calling uiSknv.renderPastedCompetitionReport..."); 
                
                // L·ªçc d·ªØ li·ªáu thi ƒëua ƒë√£ d√°n d·ª±a tr√™n b·ªô l·ªçc chung (kho, b·ªô ph·∫≠n, t√™n)
                const visibleEmployeeMaNVs = new Set(filteredReport.map(nv => nv.maNV));
                const filteredPastedData = (appState.pastedThiDuaReportData || []).filter(item => 
                    visibleEmployeeMaNVs.has(item.maNV)
                );
                
                uiSknv.renderPastedCompetitionReport(filteredPastedData); 
            }
            // === END: Y√äU C·∫¶U 4 ===
        
        } else if (activeSubTabId === 'subtab-sknv') { 
             console.log("[tab-sknv.js renderSummaryViews] Calling ui.displaySknvReport (summary mode)..."); 
            ui.displaySknvReport(filteredReport, false); 
        } else if (activeSubTabId === 'subtab-doanhthu-lk') { 
            console.log("[tab-sknv.js renderSummaryViews] Calling ui.displayEmployeeRevenueReport for luyke..."); 
            ui.displayEmployeeRevenueReport(filteredReport, 'revenue-report-container-lk', 'doanhthu_lk'); 
        } else if (activeSubTabId === 'subtab-thunhap') { 
            console.log("[tab-sknv.js renderSummaryViews] Calling ui.displayEmployeeIncomeReport..."); 
            ui.displayEmployeeIncomeReport(filteredReport); 
        } else if (activeSubTabId === 'subtab-hieu-qua-khai-thac-luy-ke') { 
            console.log("[tab-sknv.js renderSummaryViews] Calling ui.displayEmployeeEfficiencyReport..."); 
            ui.displayEmployeeEfficiencyReport(filteredReport, 'efficiency-report-container', 'hieu_qua'); 
        } else if (activeSubTabId === 'subtab-doanhthu-nganhhang') { 
    
        console.log("[tab-sknv.js renderSummaryViews] Calling ui.displayCategoryRevenueReport..."); 
            ui.displayCategoryRevenueReport(filteredReport, 'category-revenue-report-container', 'sknv'); 
        } else {
             console.warn(`[tab-sknv.js renderSummaryViews] No summary render defined for subtab: ${activeSubTabId}`); 
        }
    }
};
--- END FILE: ./tab-sknv.js ---

--- START FILE: ./ui-admin.js ---
// Version 1.6 - Fix incorrect import path for analytics.service
// Version 1.3 - Add STT column to competition name mapping table
// Version 1.2 - Refactor: Re-wire call to new analyticsService
// MODULE: UI ADMIN
// Ch·ª©a c√°c h√†m render cho trang Qu·∫£n tr·ªã (Khai b√°o).

import { appState } from './state.js';
// import { firebase } from './firebase.js'; // <-- ƒê√É X√ìA
import { analyticsService } from './services/analytics.service.js'; // <-- ƒê√É S·ª¨A ƒê∆Ø·ªúNG D·∫™N
import { formatters } from './ui-formatters.js';

/**
 * Render b·∫£ng th·ªëng k√™ ng∆∞·ªùi d√πng trong Trang Qu·∫£n tr·ªã.
 * (ƒê√£ di chuy·ªÉn t·ª´ ui-components.js)
 */
const renderUserStatsTable = (users) => {
    const container = document.getElementById('user-stats-container');
    if (!container) return;

    if (!users || users.length === 0) {
        container.innerHTML = '<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu ng∆∞·ªùi d√πng.</p>';
        return;
    }

    const sortState = appState.sortState.user_stats || { key: 'lastLogin', direction: 'desc' };
    const { key, direction } = sortState;

    const sortedUsers = [...users].sort((a, b) => {
        let valA = a[key];
            let valB = b[key];

        if (key === 'lastLogin') {
            valA = valA instanceof Date ? valA.getTime() : 0;
            valB = valB instanceof Date ? valB.getTime() : 0;
        }
        else if (key === 'loginCount' || key === 'actionsTaken') {
                valA = Number(valA) || 0;
                valB = Number(valB) || 0;
        }

        if (valA < valB) return direction === 'asc' ? -1 : 1;
        if (valA > valB) return direction === 'asc' ? 1 : -1;
        return 0;
    });

    const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;

    let tableHTML = `
        <div class="overflow-x-auto max-h-[600px]">
            <table class="min-w-full text-sm table-bordered table-striped" data-table-type="user_stats">
                    <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold sticky top-0">
                    <tr>
                        <th class="${headerClass('email')}" data-sort="email">Email <span class="sort-indicator"></span></th>
                        <th class="${headerClass('loginCount')} text-right" data-sort="loginCount">L∆∞·ª£t truy c·∫≠p <span class="sort-indicator"></span></th>
                        <th class="${headerClass('actionsTaken')} text-right" data-sort="actionsTaken">L∆∞·ª£t s·ª≠ d·ª•ng <span class="sort-indicator"></span></th>
                            <th class="${headerClass('lastLogin')} text-right" data-sort="lastLogin">L·∫ßn cu·ªëi truy c·∫≠p <span class="sort-indicator"></span></th>
                    </tr>
                </thead>
                <tbody>
    `;

    sortedUsers.forEach(user => {
        const lastLoginDate = user.lastLogin instanceof Date ? user.lastLogin : null;
        const formattedLastLogin = lastLoginDate
            ? `${lastLoginDate.toLocaleDateString('vi-VN')} ${lastLoginDate.toLocaleTimeString('vi-VN')}`
                : 'Ch∆∞a r√µ';

        tableHTML += `
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-2 font-medium text-gray-900">${user.email}</td>
                <td class="px-4 py-2 text-right font-bold">${formatters.formatNumber(user.loginCount || 0)}</td>
                <td class="px-4 py-2 text-right font-bold">${formatters.formatNumber(user.actionsTaken || 0)}</td>
                    <td class="px-4 py-2 text-right">${formattedLastLogin}</td>
            </tr>
        `;
    });

    tableHTML += `</tbody></table></div>`;
    container.innerHTML = tableHTML;
};

/**
 * Render b·∫£ng √°nh x·∫° t√™n thi ƒëua trong Tab Khai b√°o.
 * (ƒê√£ di chuy·ªÉn t·ª´ ui-components.js)
 */
const renderCompetitionNameMappingTable = () => {
    const container = document.getElementById('competition-name-mapping-container');
    if (!container) return;

    const mappings = appState.competitionNameMappings || {};
    const mappingEntries = Object.entries(mappings);

    if (mappingEntries.length === 0) {
            container.innerHTML = '<p class="text-gray-500 italic">Vui l√≤ng d√°n d·ªØ li·ªáu "Thi ƒëua nh√¢n vi√™n" ·ªü tab "C·∫≠p nh·∫≠t d·ªØ li·ªáu" ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông tr√≠ch xu·∫•t t√™n...</p>';
        return;
    }

    // === START: THAY ƒê·ªîI (v1.3) ===
    let tableHTML = `
        <table class="min-w-full text-sm table-bordered bg-white">
            <thead class="text-xs text-slate-800 uppercase bg-slate-100 font-bold">
                <tr>
                    <th class="px-2 py-2 text-center w-12">STT</th>
                    <th class="px-4 py-2 text-left w-1/2">T√™n G·ªëc (T·ª´ d·ªØ li·ªáu d√°n)</th>
                    <th class="px-4 py-2 text-left w-1/2">T√™n R√∫t G·ªçn (Nh·∫≠p ƒë·ªÉ thay th·∫ø)</th>
                </tr>
            </thead>
            <tbody>
    `;

    mappingEntries.forEach(([originalName, shortName], index) => { // Th√™m 'index'
        tableHTML += `
            <tr class="border-t hover:bg-gray-50">
                <td class="px-2 py-2 text-center font-medium text-gray-700 align-top">${index + 1}</td>
                <td class="px-4 py-2 text-gray-600 align-top text-xs">
                        ${originalName}
                </td>
                <td class="px-4 py-2 align-top">
                    <input 
                        type="text" 
                        class="competition-name-input w-full p-1 border rounded-md text-sm" 
                            value="${shortName || ''}" 
                        data-original-name="${originalName}"
                        placeholder="Nh·∫≠p t√™n r√∫t g·ªçn..."
                    >
                </td>
            </tr>
        `;
    });
    // === END: THAY ƒê·ªîI (v1.3) ===

    tableHTML += `</tbody></table>`;
    container.innerHTML = tableHTML;
};

/**
 * ƒêi·ªÅn n·ªôi dung v√†o c√°c tr√¨nh ch·ªânh s·ª≠a H∆∞·ªõng d·∫´n trong Trang Qu·∫£n tr·ªã.
 * (ƒê√£ di chuy·ªÉn t·ª´ ui-components.js)
 */
const renderAdminHelpEditors = () => {
        if (appState.isAdmin) {
        const dataEl = document.getElementById('edit-help-data');
        if (dataEl) dataEl.value = appState.helpContent.data || '';
        const luykeEl = document.getElementById('edit-help-luyke');
        if (luykeEl) luykeEl.value = appState.helpContent.luyke || '';
        const sknvEl = document.getElementById('edit-help-sknv');
        if (sknvEl) sknvEl.value = appState.helpContent.sknv || '';
        const realtimeEl = document.getElementById('edit-help-realtime');
        if (realtimeEl) realtimeEl.value = appState.helpContent.realtime || '';
    }
};

/**
 * Render n·ªôi dung ch√≠nh c·ªßa Trang Qu·∫£n tr·ªã (Khai b√°o).
 * (ƒê√£ di chuy·ªÉn t·ª´ ui.js)
 */
const renderAdminPage = async () => {
    if (!appState.isAdmin) return;
    
    // Render b·∫£ng th·ªëng k√™ ng∆∞·ªùi d√πng
    // === START: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
    const users = await analyticsService.getAllUsers();
    // === END: T√ÅI C·∫§U TR√öC (RE-WIRING) ===
    renderUserStatsTable(users); // G·ªçi h√†m n·ªôi b·ªô
    
    // Render c√°c tr√¨nh ch·ªânh s·ª≠a h∆∞·ªõng d·∫´n
    renderAdminHelpEditors(); // G·ªçi h√†m n·ªôi b·ªô

    // Render b·∫£ng √°nh x·∫° t√™n thi ƒëua
    renderCompetitionNameMappingTable(); // G·ªçi h√†m n·ªôi b·ªô
};

/**
 * Render danh s√°ch c√°c ch∆∞∆°ng tr√¨nh thi ƒëua ƒë√£ t·∫°o (trong tab Khai b√°o).
 * (ƒê√£ di chuy·ªÉn t·ª´ ui-components.js v3.31)
 */
const renderCompetitionConfigUI = () => {
    const container = document.getElementById(`competition-list-container`);
    if (!container) return;
    
    // === START REFACTOR 2 (B∆∞·ªõc 2e) ===
    // ƒê·ªçc t·ª´ globalCompetitionConfigs (Firestore) thay v√¨ competitionConfigs (LocalStorage)
    const configs = appState.globalCompetitionConfigs || [];
    // === END REFACTOR 2 ===

    if (configs.length === 0) {
        container.innerHTML = '<p class="text-xs text-center text-gray-500 italic">Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh n√†o ƒë∆∞·ª£c t·∫°o.</p>';
        return;
    }

    container.innerHTML = configs.map((config, index) => {
            return `
                <div class="p-3 border rounded-lg bg-white flex justify-between items-center shadow-sm">
                    <div>
                        <div class="flex items-center gap-x-2">
                            <p class="font-bold text-gray-800">${config.name}</p>
                        </div>
                        <div class="text-xs text-gray-500 mt-1 space-y-1">
                            <p><strong>H√£ng:</strong> <span class="font-semibold text-blue-600">${(config.brands || []).join(', ')}</span></p>
                            <p><strong>Nh√≥m h√†ng:</strong> <span class="font-semibold">${(config.groups || []).length > 0 ? (config.groups || []).join(', ') : 'T·∫•t c·∫£'}</span></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-x-2 flex-shrink-0">
                        <button class="edit-competition-btn p-2 rounded-md hover:bg-gray-200 text-gray-600" data-index="${index}" title="S·ª≠a ch∆∞∆°ng tr√¨nh">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="delete-competition-btn p-2 rounded-md hover:bg-red-100 text-red-600" data-index="${index}" title="X√≥a ch∆∞∆°ng tr√¨nh">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </div>
            `;
    }).join('');
};

// ========== START: H√ÄM M·ªöI (v1.5) ==========
/**
 * Render danh s√°ch c√°c ch∆∞∆°ng tr√¨nh SP ƒê·∫∑c Quy·ªÅn ƒë√£ t·∫°o (trong tab Khai b√°o).
 */
const renderSpecialProgramConfigUI = () => {
    const container = document.getElementById(`special-program-list-container`);
    if (!container) return;
    
    const configs = appState.globalSpecialPrograms || [];

    if (configs.length === 0) {
        container.innerHTML = '<p class="text-xs text-center text-gray-500 italic">Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh SPƒêQ n√†o ƒë∆∞·ª£c t·∫°o.</p>';
        return;
    }

    container.innerHTML = configs.map((config, index) => {
            return `
                <div class="p-3 border rounded-lg bg-white flex justify-between items-center shadow-sm">
                    <div>
                        <div class="flex items-center gap-x-2">
                            <p class="font-bold text-gray-800">${config.name}</p>
                        </div>
                        <div class="text-xs text-gray-500 mt-1 space-y-1">
                            <p><strong>Nh√≥m h√†ng:</strong> <span class="font-semibold text-blue-600">${(config.groups || []).join(', ')}</span></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-x-2 flex-shrink-0">
                        <button class="edit-special-program-btn p-2 rounded-md hover:bg-gray-200 text-gray-600" data-index="${index}" title="S·ª≠a ch∆∞∆°ng tr√¨nh">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="delete-special-program-btn p-2 rounded-md hover:bg-red-100 text-red-600" data-index="${index}" title="X√≥a ch∆∞∆°ng tr√¨nh">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </div>
            `;
    }).join('');
};
// ========== END: H√ÄM M·ªöI (v1.5) ==========


// Xu·∫•t kh·∫©u ƒë·ªëi t∆∞·ª£ng g·ªôp
export const uiAdmin = {
    renderUserStatsTable,
    renderCompetitionNameMappingTable,
    renderAdminHelpEditors,
    renderAdminPage,
    renderCompetitionConfigUI, // <<< TH√äM M·ªöI (v1.1)
    renderSpecialProgramConfigUI // <<< TH√äM M·ªöI (v1.5)
};
--- END FILE: ./ui-admin.js ---

--- START FILE: ./ui-competition.js ---
// Version 3.1 - Refactor: G·ª° b·ªè grid wrapper kh·ªèi renderCompetitionUI
// Version 2.9 - Simplify multi-brand competition table header
// MODULE: UI COMPETITION
// Ch·ª©a c√°c h√†m render giao di·ªán cho b√°o c√°o thi ƒëua ƒëa h√£ng, ƒëa nƒÉng.

import { appState } from './state.js';
import { uiComponents } from './ui-components.js';
import { config } from './config.js';

const uiCompetition = {
    /**
     * Render to√†n b·ªô giao di·ªán b√°o c√°o hi·ªáu qu·∫£ thi ƒëua m·ªõi.
     * @param {string} containerId - ID c·ªßa container ƒë·ªÉ render b√°o c√°o.
     * @param {Array} reportData - D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω t·ª´ services.calculateCompetitionFocusReport.
     */
    renderCompetitionUI(containerId, reportData) {
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!reportData || reportData.length === 0) {
            const isLk = containerId.includes('-lk');
            
            // === START REFACTOR 2 (B∆∞·ªõc 2e) ===
            // ƒê·ªçc t·ª´ global configs (Firestore) + local configs (LocalStorage)
            const allConfigs = [ ...appState.globalCompetitionConfigs, ...appState.localCompetitionConfigs ];
            // === END REFACTOR 2 ===

            const ycxData = isLk ? appState.ycxData : appState.realtimeYCXData;
            
            let errorMessage = '';
            // === START REFACTOR 2 (B∆∞·ªõc 2e) ===
            if (allConfigs.length === 0) {
            // === END REFACTOR 2 ===
                errorMessage = 'Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh thi ƒëua n√†o ƒë∆∞·ª£c khai b√°o trong "Thi·∫øt l·∫≠p m·ª•c ti√™u".';
            } else if (ycxData.length === 0) {
                // === START REFACTOR 2 (B∆∞·ªõc 2e) ===
                errorMessage = `ƒê√£ c√≥ ${allConfigs.length} ch∆∞∆°ng tr√¨nh thi ƒëua, nh∆∞ng b·∫°n ch∆∞a t·∫£i file d·ªØ li·ªáu b√°n h√†ng (${isLk ? 'YCX L≈©y k·∫ø' : 'Realtime'}) t∆∞∆°ng ·ª©ng ƒë·ªÉ t√≠nh to√°n.`;
                // === END REFACTOR 2 ===
            } else {
                // === START REFACTOR 2 (B∆∞·ªõc 2e) ===
                errorMessage = `ƒê√£ t√¨m th·∫•y ${allConfigs.length} ch∆∞∆°ng tr√¨nh thi ƒëua, nh∆∞ng kh√¥ng c√≥ doanh thu/s·ªë l∆∞·ª£ng n√†o kh·ªõp v·ªõi c√°c nh√≥m h√†ng ƒë√£ ch·ªçn trong file YCX. Vui l√≤ng ki·ªÉm tra l·∫°i s·ª± th·ªëng nh·∫•t v·ªÅ t√™n g·ªçi gi·ªØa c·∫•u h√¨nh thi ƒëua v√† d·ªØ li·ªáu b√°n h√†ng.`;
                // === END REFACTOR 2 ===
            }
            container.innerHTML = `<div class="p-4 bg-yellow-50 text-yellow-800 border border-yellow-200 rounded-lg italic">${errorMessage}</div>`;
            return;
        }

        // === START: THAY ƒê·ªîI V4.8 (G·ª° b·ªè grid wrapper) ===
        let finalHTML = ''; // B·∫Øt ƒë·∫ßu b·∫±ng chu·ªói r·ªóng
        reportData.forEach((competitionResult, index) => {
            if (competitionResult.employeeData.length === 0) return;
            finalHTML += this._renderFocusCompetitionTable(competitionResult, index);
        });
        // finalHTML += `</div>`; // X√≥a th·∫ª ƒë√≥ng
        container.innerHTML = finalHTML; // Render tr·ª±c ti·∫øp HTML c·ªßa c√°c th·∫ª
        // === END: THAY ƒê·ªîI V4.8 ===
    },

    /**
     * @private
     * Render b·∫£ng k·∫øt qu·∫£ chi ti·∫øt cho m·ªôt ch∆∞∆°ng tr√¨nh thi ƒëua (phi√™n b·∫£n m·ªõi, h·ªó tr·ª£ ƒëa h√£ng).
     */
    _renderFocusCompetitionTable(competitionResult, index) {
        const { competition, employeeData } = competitionResult;
        const sortStateKey = `focus_competition_${competition.type}_${index}`;
        const sortState = appState.sortState[sortStateKey] || { key: 'tyLeDT', direction: 'desc' };
        const { key, direction } = sortState;

        const targetValue = parseFloat(competition.target) / 100 || 0;
        const brands = competition.brands || [];

        const sortedData = [...employeeData].sort((a, b) => {
            const valA = a[key] || 0;
            const valB = b[key] || 0;
            return direction === 'asc' ? valA - valB : valB - a[key];
        });

        // T√≠nh to√°n t·ªïng c·ªông, bao g·ªìm c·∫£ chi ti·∫øt cho t·ª´ng h√£ng
        const totals = employeeData.reduce((acc, item) => {
            acc.baseCategoryQuantity += item.baseCategoryQuantity;
            acc.baseCategoryRevenue += item.baseCategoryRevenue;
            acc.targetBrandsQuantity += item.targetBrandsQuantity;
            acc.targetBrandsRevenue += item.targetBrandsRevenue;

            for (const brandName of brands) {
                if (!acc.performanceByBrand[brandName]) {
                    acc.performanceByBrand[brandName] = { quantity: 0, revenue: 0 };
                }
                const brandPerf = item.performanceByBrand[brandName];
                if (brandPerf) {
                    acc.performanceByBrand[brandName].quantity += brandPerf.quantity;
                    acc.performanceByBrand[brandName].revenue += brandPerf.revenue;
                }
            }
            return acc;
        }, { 
            baseCategoryQuantity: 0, 
            baseCategoryRevenue: 0,
            targetBrandsQuantity: 0,
            targetBrandsRevenue: 0,
            performanceByBrand: {}
        });

        totals.tyLeSL = totals.baseCategoryQuantity > 0 ? (totals.targetBrandsQuantity / totals.baseCategoryQuantity) : 0;
        totals.tyLeDT = totals.baseCategoryRevenue > 0 ? (totals.targetBrandsRevenue / totals.baseCategoryRevenue) : 0;
        
        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;
        
        let tableHTML = `
            <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col" data-capture-group="competition-${competition.id}">
                <div class="p-4 bg-gray-50 border-b-2 border-indigo-200">
                    <h3 class="text-lg font-bold text-indigo-800 uppercase">${competition.name}</h3>
                    <div class="mt-2 flex items-center gap-2">
                        <label for="target-input-${competition.id}" class="text-sm font-medium text-gray-700 flex-shrink-0">M·ª•c ti√™u khai th√°c (%):</label>
                        <input type="number" id="target-input-${competition.id}" 
                               class="competition-target-input w-24 p-1 border rounded-md text-sm" 
                               placeholder="VD: 50"
                               value="${competition.target || ''}"
                               data-competition-id="${competition.id}">
                    </div>
                </div>
                <div class="overflow-x-auto flex-grow">
                    <table class="min-w-full text-sm text-left text-gray-600 table-bordered table-striped" data-table-type="${sortStateKey}">
                        <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
                            <tr>
                                <th rowspan="2" class="${headerClass('hoTen')}" data-sort="hoTen">Nh√¢n vi√™n <span class="sort-indicator"></span></th>
                                ${brands.map(brand => `<th colspan="2" class="px-4 py-2 text-center header-group-5">${brand}</th>`).join('')}
                                <th colspan="2" class="px-4 py-2 text-center header-group-10">T·ªïng Nh√≥m h√†ng</th>
                                <th colspan="2" class="px-4 py-2 text-center header-group-6">T·ª∑ l·ªá khai th√°c</th>
                            </tr>
                            <tr>
                                ${brands.map(() => `<th class="px-2 py-2 text-right">SL</th><th class="px-2 py-2 text-right">DT</th>`).join('')}
                                <th class="${headerClass('baseCategoryQuantity')} text-right" data-sort="baseCategoryQuantity">SL <span class="sort-indicator"></span></th>
                                <th class="${headerClass('baseCategoryRevenue')} text-right" data-sort="baseCategoryRevenue">DT <span class="sort-indicator"></span></th>
                                <th class="${headerClass('tyLeSL')} text-right header-highlight" data-sort="tyLeSL">% SL <span class="sort-indicator"></span></th>
                                <th class="${headerClass('tyLeDT')} text-right header-highlight" data-sort="tyLeDT">% DT <span class="sort-indicator"></span></th>
                            </tr>
                        </thead>
                        <tbody>`;

        sortedData.forEach(item => {
            const tyLeSLClass = targetValue > 0 && item.tyLeSL < targetValue ? 'cell-performance is-below' : '';
            const tyLeDTClass = targetValue > 0 && item.tyLeDT < targetValue ? 'cell-performance is-below' : '';

            tableHTML += `<tr class="hover:bg-gray-50">
                <td class="px-4 py-2 font-semibold line-clamp-2">${uiComponents.getShortEmployeeName(item.hoTen, item.maNV)}</td>
                ${brands.map(brandName => {
                    const brandPerf = item.performanceByBrand[brandName] || { quantity: 0, revenue: 0 };
                    return `<td class="px-2 py-2 text-right font-bold">${uiComponents.formatNumberOrDash(brandPerf.quantity)}</td>
                            <td class="px-2 py-2 text-right font-bold">${uiComponents.formatRevenue(brandPerf.revenue)}</td>`;
                }).join('')}
                <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumberOrDash(item.baseCategoryQuantity)}</td>
                <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.baseCategoryRevenue)}</td>
                <td class="px-4 py-2 text-right font-bold ${tyLeSLClass}">${uiComponents.formatPercentage(item.tyLeSL)}</td>
                <td class="px-4 py-2 text-right font-bold ${tyLeDTClass}">${uiComponents.formatPercentage(item.tyLeDT)}</td>
            </tr>`;
        });

        tableHTML += `
                        </tbody>
                        <tfoot class="table-footer font-bold">
                            <tr>
                                <td class="px-4 py-2">T·ªïng</td>
                                ${brands.map(brandName => {
                                    const brandTotals = totals.performanceByBrand[brandName] || { quantity: 0, revenue: 0 };
                                    return `<td class="px-2 py-2 text-right">${uiComponents.formatNumberOrDash(brandTotals.quantity)}</td>
                                            <td class="px-2 py-2 text-right">${uiComponents.formatRevenue(brandTotals.revenue)}</td>`;
                                }).join('')}
                                <td class="px-4 py-2 text-right">${uiComponents.formatNumberOrDash(totals.baseCategoryQuantity)}</td>
                                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.baseCategoryRevenue)}</td>
                                <td class="px-4 py-2 text-right">${uiComponents.formatPercentage(totals.tyLeSL)}</td>
                                <td class="px-4 py-2 text-right">${uiComponents.formatPercentage(totals.tyLeDT)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>`;
        return tableHTML;
    }
};

export { uiCompetition };
--- END FILE: ./ui-competition.js ---

--- START FILE: ./ui-components.js ---
// Version 3.32 - Refactor: Remove HomePage functions (moved to ui-home.js) and renderCompetitionConfigUI (moved to ui-admin.js)
// Version 3.31 - Refactor: Remove admin and filter functions (moved to ui-admin.js and ui-filters.js)
// ... (c√°c phi√™n b·∫£n tr∆∞·ªõc gi·ªØ nguy√™n)
// MODULE: UI COMPONENTS
// Ch·ª©a c√°c h√†m UI chung, t√°i s·ª≠ d·ª•ng ƒë∆∞·ª£c tr√™n to√†n b·ªô ·ª©ng d·ª•ng.

import { appState } from './state.js';
import { services } from './services.js';
import { utils } from './utils.js';
import { settingsService } from './modules/settings.service.js';
import { ui } from './ui.js';
import { formatters } from './ui-formatters.js'; // (v3.26)
import { modalManager } from './ui-modal-manager.js'; // (v3.28)
import { notifications } from './ui-notifications.js'; // <<< TH√äM M·ªöI (v3.29)
import { debugTools } from './ui-debug.js'; // <<< TH√äM M·ªöI (v3.29)

export const uiComponents = {
    // === START: KH·ªêI H√ÄM ƒê√É B·ªä X√ìA (v3.31) ===
    // 5 h√†m (populateAllFilters, updateBrandFilterOptions, populateCompetitionFilters, 
    // populateCompetitionBrandFilter, populateWarehouseSelector)
    // ƒê√É B·ªä X√ìA kh·ªèi ƒë√¢y v√¨ ƒë√£ t·ªìn t·∫°i trong 'ui-filters.js'.
    // === END: KH·ªêI H√ÄM ƒê√É B·ªä X√ìA ===

    renderSettingsButton(idSuffix) {
        return `<button id="settings-btn-${idSuffix}" class="settings-trigger-btn" title="T√πy ch·ªânh hi·ªÉn th·ªã">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>`;
    },

    // === START: KH·ªêI H√ÄM ƒê√É B·ªä X√ìA (v3.32) ===
    // 1 h√†m (renderCompetitionConfigUI)
    // ƒê√É B·ªä X√ìA kh·ªèi ƒë√¢y v√¨ ƒë√£ chuy·ªÉn sang 'ui-admin.js'.
    // === END: KH·ªêI H√ÄM ƒê√É B·ªä X√ìA ===

    // === START: KH·ªêI H√ÄM ƒê√É B·ªä X√ìA (v3.31) ===
    // 2 h√†m (populateCompetitionFilters, populateCompetitionBrandFilter)
    // ƒê√É B·ªä X√ìA kh·ªèi ƒë√¢y v√¨ ƒë√£ t·ªìn t·∫°i trong 'ui-filters.js'.
    // === END: KH·ªêI H√ÄM ƒê√É B·ªä X√ìA ===

    populateComposerDetailTags(supermarketReport) {
        // ... (Gi·ªØ nguy√™n)
            const qdcContainer = document.getElementById('composer-qdc-tags-container');
            const nganhHangContainer = document.getElementById('composer-nganhhang-tags-container');
            if (!qdcContainer || !nganhHangContainer) return;

            qdcContainer.innerHTML = '<h5 class="composer__tag-group-title">Ch·ªçn Nh√≥m H√†ng QƒêC</h5>';
            nganhHangContainer.innerHTML = '<h5 class="composer__tag-group-title">Ch·ªçn Ng√†nh H√†ng Chi Ti·∫øt</h5>';

            const createTagButton = (tag, text) => {
                const button = document.createElement('button');
                button.className = 'composer__tag-btn';
                button.dataset.tag = tag;
                button.textContent = text;
                return button;
            };

            if (supermarketReport && supermarketReport.qdc) {
                    const qdcItems = Object.values(supermarketReport.qdc)
                    .filter(item => item.sl > 0)
                    .sort((a,b) => b.dtqd - a.dtqd);
                qdcItems.forEach(item => {
                    const tag = `[QDC_INFO_${item.name}]`;
                    qdcContainer.appendChild(createTagButton(tag, item.name));
                });
            }
            if (supermarketReport && supermarketReport.nganhHangChiTi·∫øt) {
                const nganhHangItems = Object.values(supermarketReport.nganhHangChiTiet)
                    .filter(item => item.quantity > 0)
                    .sort((a, b) => b.revenue - a.revenue)
                    .slice(0, 15);
                nganhHangItems.forEach(item => {
                    const cleanName = utils.cleanCategoryName(item.name);
                    const tag = `[NH_INFO_${cleanName}]`;
                    nganhHangContainer.appendChild(createTagButton(tag, cleanName));
                });
            }
    },
    
    // === START: KH·ªêI H√ÄM ƒê√É B·ªä X√ìA ===
    // (ƒê√£ chuy·ªÉn sang ui-reports.js)
    // === END: KH·ªêI H√ÄM ƒê√É B·ªä X√ìA ===

    // === START: KH·ªêI H√ÄM ƒê√É B·ªä X√ìA (v3.31) ===
    // 1 h√†m (populateWarehouseSelector)
    // ƒê√É B·ªä X√ìA kh·ªèi ƒë√¢y v√¨ ƒë√£ t·ªìn t·∫°i trong 'ui-filters.js'.
    // === END: KH·ªêI H√ÄM ƒê√É B·ªä X√ìA ===

    showProgressBar: (elementId) => { const el = document.getElementById(`progress-${elementId}`); if(el) el.classList.remove('hidden'); },
    hideProgressBar: (elementId) => { const el = document.getElementById(`progress-${elementId}`); if(el) el.classList.add('hidden'); },
    
    ...notifications, // (v3.29)

        updateFileStatus(uiId, fileName = '', statusText, statusType = 'default', showDownloadButton = false, metadata = null, dataType = '', warehouse = '') {
            const fileNameSpan = document.getElementById(`file-name-${uiId}`);
            const fileStatusSpan = document.getElementById(`file-status-${uiId}`);

            if (fileNameSpan) fileNameSpan.textContent = fileName || 'Ch∆∞a th√™m file';

            if (fileStatusSpan) {
                let finalStatusText = statusText;
                let timeAgo = '';
                let buttonHTML = '';
                let countText = '';

                if (metadata && metadata.updatedAt) {
                    const timestampDate = metadata.updatedAt.toDate ? metadata.updatedAt.toDate() : new Date(metadata.updatedAt);
                    if (!isNaN(timestampDate)) {
                        timeAgo = formatters.formatTimeAgo(timestampDate); // (v3.28)
                    }
                }

                if (statusType === 'success' && metadata) {
                    countText = metadata.rowCount ? `${formatters.formatNumber(metadata.rowCount)} d√≤ng` : ''; // (v3.28)
                    finalStatusText = `‚úì ƒê√£ ƒë·ªìng b·ªô cloud ${countText} ${timeAgo}`.trim();
                } else if (statusType === 'default' && showDownloadButton && metadata) {
                    finalStatusText = `C√≥ c·∫≠p nh·∫≠t m·ªõi t·ª´ ${metadata.updatedBy || 'ai ƒë√≥'} ${timeAgo}`;
                }

                if (showDownloadButton && dataType && warehouse) {
                    buttonHTML = `
                        <button
                            class="download-data-btn ml-2 px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200"
                            data-type="${dataType}"
                            data-warehouse="${warehouse}"
                            title="T·∫£i v√† x·ª≠ l√Ω phi√™n b·∫£n d·ªØ li·ªáu m·ªõi n√†y">
                            T·∫£i & X·ª≠ l√Ω
                        </button>
                    `;
                }

                fileStatusSpan.innerHTML = `<span class="data-input-group__status-text data-input-group__status-text--${statusType}">${finalStatusText}</span>${buttonHTML}`;
            }
        },
        updatePasteStatus(uiId, statusText, statusType = 'success', metadata = null, processedCount = 0) {
            const statusSpan = document.getElementById(uiId);
            if (statusSpan) {
                let finalStatusText = statusText;
                let timeAgo = '';
                let countText = '';

                if (metadata && metadata.updatedAt) {
                    const timestampDate = metadata.updatedAt.toDate ? metadata.updatedAt.toDate() : new Date(metadata.updatedAt);
                    if (!isNaN(timestampDate)) {
                        timeAgo = formatters.formatTimeAgo(timestampDate); // (v3.28)
                    }
                }

                if (statusType === 'success' && metadata) {
                    if ((uiId === 'status-thuongerp' || uiId === 'status-thuongerp-thangtruoc' || uiId === 'status-thiduanv') && processedCount > 0) {
                        countText = `${processedCount} nh√¢n vi√™n`;
                    } else if (uiId === 'status-luyke') {
                        countText = '';
                    }
                    
                    finalStatusText = `‚úì ƒê√£ ƒë·ªìng b·ªô cloud ${countText} ${timeAgo}`.trim();
                }

                statusSpan.textContent = finalStatusText;
                statusSpan.className = `data-input-group__status-text data-input-group__status-text--${statusType}`;
            }
        },
        togglePlaceholder: (sectionId, show) => {
            const placeholder = document.getElementById(`${sectionId}-placeholder`);
            const content = document.getElementById(`${sectionId}-content`);
            if (placeholder && content) {
                placeholder.classList.toggle('hidden', !show);
                content.classList.toggle('hidden', show);
            }
        },

    ...formatters, // (v3.26)
    ...modalManager, // (v3.28)

    handleSubTabClick(button) {
        const nav = button.closest('nav');
        if (!nav) return;
        const targetId = button.dataset.target;
        const contentContainer = document.getElementById(nav.dataset.contentContainer);
        if (!contentContainer) return;

        nav.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
        button.classList.add('active');
        contentContainer.querySelectorAll('.sub-tab-content').forEach(content => content.classList.toggle('hidden', content.id !== targetId));
    },
    toggleFilterSection(targetId) {
        const targetContainer = document.getElementById(targetId);
        const button = document.querySelector(`.toggle-filters-btn[data-target="${targetId}"]`);
        if (targetContainer && button) {
            targetContainer.classList.toggle('hidden');
            const isHidden = targetContainer.classList.contains('hidden');
            button.classList.toggle('active', !isHidden);
            const textSpan = button.querySelector('.text');
            if (textSpan) textSpan.textContent = isHidden ? 'Hi·ªán b·ªô l·ªçc n√¢ng cao' : '·∫®n b·ªô l·ªçc n√¢ng cao';
            const icon = button.querySelector('.icon');
            if(icon) icon.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(180deg)';
        }
    },
    toggleDebugTool(button) {
        const container = document.getElementById('debug-tool-container');
        if (container) {
                container.classList.toggle('hidden');
            button.textContent = container.classList.contains('hidden') ? 'Hi·ªÉn th·ªã C√¥ng c·ª• G·ª° l·ªói' : '·∫®n C√¥ng c·ª• G·ª° l·ªói';
        }
    },
    showHelpModal(helpId) {
        const titleEl = document.getElementById('help-modal-title');
        const contentEl = document.getElementById('help-modal-content');
        if (!titleEl || !contentEl) return;
        const title = `H∆∞·ªõng d·∫´n cho Tab ${helpId.charAt(0).toUpperCase() + helpId.slice(1)}`;
        const content = appState.helpContent[helpId] || "N·ªôi dung h∆∞·ªõng d·∫´n kh√¥ng c√≥ s·∫µn.";
        titleEl.textContent = title;
        contentEl.innerHTML = content.replace(/\n/g, '<br>');
        this.toggleModal('help-modal', true);
    },
    showComposerModal(sectionId) {
            this.toggleModal('composer-modal', true);
        const firstTextarea = document.querySelector('#composer-context-content textarea');
        firstTextarea?.focus();
    },
        insertComposerTag(textarea, tag) {
        if (!textarea) return;
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const textToInsert = tag || '';
        textarea.value = `${textarea.value.substring(0, start)}${textToInsert}${textarea.value.substring(end)}`;
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = start + textToInsert.length;
    },
    showPreviewAndCopy(processedText) {
        const previewContentEl = document.getElementById('preview-modal-content');
        if (!previewContentEl) return;
        previewContentEl.textContent = processedText;
        this.toggleModal('preview-modal', true);
    },
    copyFromPreview() {
        const contentEl = document.getElementById('preview-modal-content');
        if (!contentEl) return;
        const content = contentEl.textContent;
        navigator.clipboard.writeText(content)
                .then(() => {
                // S·ª≠ d·ª•ng ui.showNotification thay v√¨ uiComponents.showNotification
                ui.showNotification('ƒê√£ sao ch√©p n·ªôi dung!', 'success');
                ui.toggleModal('preview-modal', false);
                })
                .catch(err => {
                console.error('L·ªói sao ch√©p:', err);
                    // S·ª≠ d·ª•ng ui.showNotification
                    ui.showNotification('L·ªói khi sao ch√©p.', 'error');
                });
    },

    // === START: KH·ªêI H√ÄM ƒê√É B·ªä X√ìA (v3.31) ===
    // 1 h√†m (renderAdminHelpEditors)
    // ƒê√É B·ªä X√ìA kh·ªèi ƒë√¢y v√¨ ƒë√£ chuy·ªÉn sang 'ui-admin.js'.
    // === END: KH·ªêI H√ÄM ƒê√É B·ªä X√ìA ===

    // === START: KH·ªêI H√ÄM ƒê√É B·ªä X√ìA (v3.32) ===
    // 3 h√†m (renderHomePage, renderUpdateHistory, renderFeedbackSection)
    // ƒê√É B·ªä X√ìA kh·ªèi ƒë√¢y v√¨ ƒë√£ chuy·ªÉn sang 'ui-home.js'.
    // === END: KH·ªêI H√ÄM ƒê√É B·ªä X√ìA ===

    applyInterfaceSettings(settings) {
            const root = document.documentElement;
            if (settings.kpiCard1Bg) root.style.setProperty('--kpi-card-1-bg', settings.kpiCard1Bg);
            if (settings.kpiCard2Bg) root.style.setProperty('--kpi-card-2-bg', settings.kpiCard2Bg);
            if (settings.kpiCard3Bg) root.style.setProperty('--kpi-card-3-bg', settings.kpiCard3Bg);
            if (settings.kpiCard4Bg) root.style.setProperty('--kpi-card-4-bg', settings.kpiCard4Bg);
            if (settings.kpiCard5Bg) root.style.setProperty('--kpi-card-5-bg', settings.kpiCard5Bg);
            if (settings.kpiCard6Bg) root.style.setProperty('--kpi-card-6-bg', settings.kpiCard6Bg);
            if (settings.kpiCard7Bg) root.style.setProperty('--kpi-card-7-bg', settings.kpiCard7Bg);
            if (settings.kpiCard8Bg) root.style.setProperty('--kpi-card-8-bg', settings.kpiCard8Bg);
            if (settings.kpiTitleColor) root.style.setProperty('--kpi-title-color', settings.kpiTitleColor);
            if (settings.kpiMainColor) root.style.setProperty('--kpi-main-color', settings.kpiMainColor);
            if (settings.kpiSubColor) root.style.setProperty('--kpi-sub-color', settings.kpiSubColor);
        },

    ...debugTools, // (v3.29)

    // === START: KH·ªêI H√ÄM ƒê√É B·ªä X√ìA (v3.31) ===
    // 2 h√†m (renderUserStatsTable, renderCompetitionNameMappingTable)
    // ƒê√É B·ªä X√ìA kh·ªèi ƒë√¢y v√¨ ƒë√£ chuy·ªÉn sang 'ui-admin.js'.
    // === END: KH·ªêI H√ÄM ƒê√É B·ªä X√ìA ===
};
--- END FILE: ./ui-components.js ---

--- START FILE: ./ui-debug.js ---
// Version 1.0 - Initial extraction from ui-components
// MODULE: UI DEBUG TOOLS
// Ch·ª©a c√°c h√†m render c√°c b·∫£ng ch·∫©n ƒëo√°n v√† g·ª° l·ªói.

import { appState } from './state.js';

export const debugTools = {
    /**
     * Hi·ªÉn th·ªã k·∫øt qu·∫£ ch·∫©n ƒëo√°n cho m·ªôt file ƒë√£ t·∫£i l√™n.
     * @param {string} fileType - Lo·∫°i file (v√≠ d·ª•: 'ycx', 'danhsachnv').
     */
    displayDebugInfo(fileType) {
         const resultsContainer = document.getElementById('debug-results-container');
         if (!fileType) {
             if (resultsContainer) resultsContainer.innerHTML = '<p class="text-gray-500">Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c t·∫£i l√™n ƒë·ªÉ ki·ªÉm tra.</p>';
             return;
         }
         if (resultsContainer && resultsContainer.innerHTML.includes('Ch∆∞a c√≥ file n√†o')) resultsContainer.innerHTML = '';

         const debugData = appState.debugInfo[fileType];
         if (!debugData) return;

         const fileInputEl = document.querySelector(`#file-${fileType}`);
         const fileName = fileInputEl?.dataset.name || fileType;
         let tableHTML = `<div class="p-2 border rounded-md bg-white mb-4"><h4 class="font-bold text-gray-800 mb-2">${fileName}</h4><table class="min-w-full text-sm">
             <thead class="bg-gray-100"><tr><th class="px-2 py-1 text-left font-semibold text-gray-600">Y√™u c·∫ßu</th><th class="px-2 py-1 text-left font-semibold text-gray-600">C·ªôt t√¨m th·∫•y</th><th class="px-2 py-1 text-center font-semibold text-gray-600">Tr·∫°ng th√°i</th></tr></thead><tbody>`;
         (debugData.required || []).forEach(res => {
             const statusClass = res.status ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100';
             tableHTML += `<tr class="border-t"><td class="px-2 py-1 font-medium">${res.displayName}</td><td class="px-2 py-1 font-mono">${res.foundName}</td><td class="px-2 py-1 text-center font-bold ${statusClass}">${res.status ? 'OK' : 'L·ªñI'}</td></tr>`;
         });
         tableHTML += `</tbody></table>`;
         if (debugData.firstFiveMsnv && debugData.firstFiveMsnv.length > 0) {
             tableHTML += `<div class="mt-2 p-2 bg-gray-50 rounded"><p class="text-xs font-semibold">5 MSNV ƒë·∫ßu ti√™n ƒë·ªçc ƒë∆∞·ª£c:</p><ul class="text-xs font-mono list-disc list-inside">${debugData.firstFiveMsnv.map(msnv => `<li>"${msnv}"</li>`).join('')}</ul></div>`;
         }
         tableHTML += `</div>`;

         const existingEl = document.getElementById(`debug-table-${fileType}`);
         if (existingEl) {
              existingEl.innerHTML = tableHTML;
         } else if (resultsContainer) {
             const wrapper = document.createElement('div');
             wrapper.id = `debug-table-${fileType}`;
             wrapper.innerHTML = tableHTML;
             resultsContainer.appendChild(wrapper);
         }
     },

    /**
     * Hi·ªÉn th·ªã k·∫øt qu·∫£ ch·∫©n ƒëo√°n cho d·ªØ li·ªáu d√°n (paste).
     * @param {string} dataType - Lo·∫°i d·ªØ li·ªáu (v√≠ d·ª•: 'thiduanv-pasted').
     */
    displayPastedDebugInfo(dataType) {
         const container = document.getElementById('pasted-debug-results-container');
         if (!container) return;

         const debugData = appState.debugInfo[dataType];
         if (!debugData) {
             container.innerHTML = '';
             return;
         }

         let content = `<div class="p-2 border rounded-md bg-white mb-4">
            <h4 class="font-bold text-gray-800 mb-2">Ch·∫©n ƒëo√°n d·ªØ li·ªáu d√°n: ${dataType.replace('-pasted', '')}</h4>`;

         if (debugData.found && debugData.found.length > 0) {
             content += '<ul>';
             debugData.found.forEach(item => {
                 content += `<li class="text-sm ${item.status ? 'text-green-700' : 'text-red-700'}"><strong>${item.name}:</strong> ${item.value}</li>`;
             });
             content += '</ul>';
         }

         content += `<p class="text-xs italic mt-2"><strong>Tr·∫°ng th√°i x·ª≠ l√Ω:</strong> ${debugData.status}</p></div>`;
         container.innerHTML = content;
     },

    /**
     * Hi·ªÉn th·ªã b·∫£ng g·ª° l·ªói cho file Thi ƒêua V√πng.
     */
    displayThiDuaVungDebugInfo() {
        const resultsContainer = document.getElementById('debug-results-container');
        if (!resultsContainer) return;

        const renderDebugTable = (title, data) => {
             if (!data || data.length === 0) {
                 return `<div class="p-2 border rounded-md bg-white mb-4">
                      <h4 class="font-bold text-gray-800 mb-2">${title}</h4>
                      <p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.</p>
                  </div>`;
            }

             const headers = Object.keys(data[0]);
            let tableHTML = `<div class="p-2 border rounded-md bg-white mb-4">
                  <h4 class="font-bold text-gray-800 mb-2">${title}</h4>
                <div class="overflow-x-auto">
                     <table class="min-w-full text-xs">
                        <thead class="bg-gray-100">
                             <tr>${headers.map(h => `<th class="px-2 py-1 text-left font-semibold text-gray-600 whitespace-nowrap">${h}</th>`).join('')}</tr>
                        </thead>
                         <tbody>`;
            data.forEach(row => {
                tableHTML += `<tr class="border-t">`;
                headers.forEach(header => {
                    tableHTML += `<td class="px-2 py-1 font-mono">${row[header] !== undefined ? row[header] : ''}</td>`;
                });
                tableHTML += `</tr>`;
            });

            tableHTML += `</tbody></table></div></div>`;
            return tableHTML;
        };

        const tongRaw = appState.debugInfo?.thiDuaVungTongRaw?.slice(0, 10) || [];
        const chiTietRaw = appState.debugInfo?.thiDuaVungChiTietRaw?.slice(0, 10) || [];

        let finalHTML = renderDebugTable('Thi ƒêua V√πng - Sheet TONG (10 d√≤ng ƒë·∫ßu)', tongRaw);
        finalHTML += renderDebugTable('Thi ƒêua V√πng - Sheet CHITIET (10 d√≤ng ƒë·∫ßu)', chiTietRaw);

        const existingEl = document.getElementById('debug-table-thidua-vung');
        if (existingEl) {
            existingEl.innerHTML = finalHTML;
        } else {
            const wrapper = document.createElement('div');
            wrapper.id = `debug-table-thidua-vung`;
            wrapper.innerHTML = finalHTML;
            resultsContainer.appendChild(wrapper);
        }
    },

    /**
     * Hi·ªÉn th·ªã b·∫£ng g·ª° l·ªói cho file Thi ƒêua (d√πng ƒë·ªÉ ki·ªÉm tra logic l·ªçc).
     * @param {Array} debugResults - D·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω t·ª´ service.
     */
    renderCompetitionDebugReport(debugResults) {
         const container = document.getElementById('debug-competition-results');
        if (!container) return;

        if (!debugResults || debugResults.length === 0) {
             container.innerHTML = '<p class="text-gray-600">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch.</p>';
            return;
        }

        const validCount = debugResults.filter(r => r.isOverallValid).length;
        const totalCount = debugResults.length;
        const checkHeaders = ['HTX H·ª£p l·ªá', 'ƒê√£ thu', 'Ch∆∞a h·ªßy', 'Ch∆∞a tr·∫£', 'ƒê√£ xu·∫•t'];

        let tableHTML = `
            <div class="p-4 bg-white border rounded-lg">
                <h4 class="font-bold text-lg mb-2">K·∫øt qu·∫£ Ph√¢n t√≠ch File: <span class="text-green-600">${validCount}</span> / ${totalCount} d√≤ng h·ª£p l·ªá</h4>
                 <div class="overflow-x-auto max-h-[600px]">
                     <table class="min-w-full text-xs table-bordered competition-debug-table">
                         <thead class="bg-gray-100 sticky top-0">
                             <tr>
                                <th class="p-2">Ng∆∞·ªùi t·∫°o</th>
                                 <th class="p-2">Nh√≥m h√†ng</th>
                                 <th class="p-2">HT Xu·∫•t</th>
                                 <th class="p-2">TT Thu ti·ªÅn</th>
                                 <th class="p-2">TT H·ªßy</th>
                                <th class="p-2">TT Tr·∫£</th>
                                 <th class="p-2">TT Xu·∫•t</th>
                                 ${checkHeaders.map(h => `<th class="p-2">${h}</th>`).join('')}
                                 <th class="p-2">T·ªïng th·ªÉ</th>
                             </tr>
                         </thead>
                        <tbody>`;

        const renderCheck = (status) => `<td class="text-center font-bold text-lg">${status ? '<span class="text-green-500">‚úÖ</span>' : '<span class="text-red-500">‚ùå</span>'}</td>`;

        debugResults.forEach(result => {
            const rowClass = result.isOverallValid ? 'bg-green-50' : 'bg-red-50';
            const { rowData, checks, isOverallValid } = result;
             tableHTML += `
                <tr class="${rowClass}">
                     <td class="p-2">${rowData.nguoiTao || ''}</td>
                     <td class="p-2">${rowData.nhomHang || ''}</td>
                     <td class="p-2">${rowData.hinhThucXuat || ''}</td>
                     <td class="p-2">${rowData.trangThaiThuTien || ''}</td>
                    <td class="p-2">${rowData.trangThaiHuy || ''}</td>
                     <td class="p-2">${rowData.tinhTrangTra || ''}</td>
                    <td class="p-2">${rowData.trangThaiXuat || ''}</td>
                    ${renderCheck(checks.isDoanhThuHTX)}
                    ${renderCheck(checks.isThuTien)}
                    ${renderCheck(checks.isChuaHuy)}
                    ${renderCheck(checks.isChuaTra)}
                    ${renderCheck(checks.isDaXuat)}
                    ${renderCheck(isOverallValid)}
                </tr>
            `;
        });

        tableHTML += '</tbody></table></div></div>';
        container.innerHTML = tableHTML;
    },
};
--- END FILE: ./ui-debug.js ---

--- START FILE: ./ui-filters.js ---
// Version 1.0 - Initial extraction from ui-components
// MODULE: UI FILTERS
// Ch·ª©a c√°c h√†m li√™n quan ƒë·∫øn vi·ªác ƒëi·ªÅn d·ªØ li·ªáu (populate) v√†o c√°c b·ªô l·ªçc Choices.js v√† select.

import { appState } from './state.js';
import { settingsService } from './modules/settings.service.js';
import { utils } from './utils.js';

export const uiFilters = {
    /**
     * ƒêi·ªÅn d·ªØ li·ªáu v√†o t·∫•t c·∫£ c√°c b·ªô l·ªçc (Kho, B·ªô ph·∫≠n, Nh√¢n vi√™n) tr√™n c√°c tab.
     * ƒê∆∞·ª£c g·ªçi sau khi DSNV ƒë∆∞·ª£c t·∫£i.
     */
    populateAllFilters() {
        console.log("[ui-filters.js populateAllFilters] ƒêang ƒëi·ªÅn d·ªØ li·ªáu v√†o t·∫•t c·∫£ b·ªô l·ªçc...");
        if (!appState.danhSachNhanVien || appState.danhSachNhanVien.length === 0) {
            console.warn("[ui-filters.js populateAllFilters] DSNV tr·ªëng, kh√¥ng th·ªÉ ƒëi·ªÅn b·ªô l·ªçc.");
            return;
        }

        try {
            const uniqueWarehouses = [...new Set(appState.danhSachNhanVien.map(nv => nv.maKho).filter(Boolean))].sort();
            const uniqueDepartments = [...new Set(appState.danhSachNhanVien.map(nv => nv.boPhan).filter(Boolean))].sort();
            const allEmployees = [...appState.danhSachNhanVien].sort((a, b) => a.hoTen.localeCompare(b.hoTen));

            const warehouseOptions = [{ value: '', label: 'T·∫•t c·∫£ Kho', selected: true }]
                .concat(uniqueWarehouses.map(item => ({ value: item, label: item })));
            
            const departmentOptions = [{ value: '', label: 'T·∫•t c·∫£ B·ªô ph·∫≠n', selected: true }]
                .concat(uniqueDepartments.map(item => ({ value: item, label: item })));

            const employeeOptions = allEmployees.map(item => ({
                value: String(item.maNV),
                label: `${item.hoTen} - ${item.maNV} (${item.boPhan})`
            }));

            ['luyke', 'sknv', 'realtime'].forEach(prefix => {
                const whChoices = appState.choices[`${prefix}_warehouse`];
                if (whChoices) {
                    const currentVal = whChoices.getValue(true);
                    whChoices.clearStore();
                    whChoices.setChoices(warehouseOptions, 'value', 'label', true);
                    if (currentVal) whChoices.setValue([currentVal]);
                }
                
                const deptChoices = appState.choices[`${prefix}_department`];
                if (deptChoices) {
                    const currentVal = deptChoices.getValue(true);
                    deptChoices.clearStore();
                    deptChoices.setChoices(departmentOptions, 'value', 'label', true);
                    if (currentVal) deptChoices.setValue([currentVal]);
                }

                const empChoices = appState.choices[`${prefix}_employee`];
                if (empChoices) {
                    const currentVal = empChoices.getValue(true);
                    empChoices.clearStore();
                    empChoices.setChoices(employeeOptions, 'value', 'label', true);
                    if (currentVal) empChoices.setValue(currentVal);
                }
            });

            // === START: S·ª¨A L·ªñI (v3.27) - ƒêi·ªÅn d·ªØ li·ªáu cho Goal Settings Drawer ===
            try {
                const goalWarehouseOptions = uniqueWarehouses.map(item => ({ value: item, label: item }));
                
                const luykeGoalSelect = document.getElementById('luyke-goal-warehouse-select');
                if (luykeGoalSelect) {
                    luykeGoalSelect.innerHTML = goalWarehouseOptions.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
                }

                const rtGoalSelect = document.getElementById('rt-goal-warehouse-select');
                if (rtGoalSelect) {
                    rtGoalSelect.innerHTML = goalWarehouseOptions.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
                }
                
                // Sau khi ƒëi·ªÅn, g·ªçi h√†m load setting ƒë·ªÉ ch·ªçn ƒë√∫ng kho (n·∫øu c√≥)
                settingsService.loadAndApplyLuykeGoalSettings();
                settingsService.loadAndApplyRealtimeGoalSettings();

            } catch (goalError) {
                console.error("[ui-filters.js populateAllFilters] L·ªói khi ƒëi·ªÅn b·ªô l·ªçc cho Goal Drawer:", goalError);
            }
            // === END: S·ª¨A L·ªñI (v3.27) ===

            console.log("[ui-filters.js populateAllFilters] ƒê√£ ƒëi·ªÅn xong b·ªô l·ªçc.");
        } catch (error) {
            console.error("[ui-filters.js populateAllFilters] L·ªói nghi√™m tr·ªçng khi ƒëi·ªÅn b·ªô l·ªçc:", error);
        }
    },

    /**
     * C·∫≠p nh·∫≠t danh s√°ch 'H√£ng' d·ª±a tr√™n 'Ng√†nh h√†ng' ƒë√£ ch·ªçn trong tab Realtime.
     * @param {string} selectedCategory - Ng√†nh h√†ng ƒë√£ ch·ªçn.
     */
    updateBrandFilterOptions(selectedCategory) {
        const brandFilterEl = document.getElementById('realtime-brand-filter');
        const brandChoices = appState.choices['realtime_brand_filter']; 
        
        if (!brandFilterEl || !brandChoices) {
            console.warn("[updateBrandFilterOptions] L·ªói: Brand filter ho·∫∑c Choices instance ch∆∞a s·∫µn s√†ng.");
            return;
        }

        let availableBrands = [];
        if (selectedCategory) {
            // L·ªçc c√°c h√£ng d·ª±a tr√™n ng√†nh h√†ng ƒë√£ ch·ªçn trong d·ªØ li·ªáu realtime
            availableBrands = [...new Set(appState.realtimeYCXData
                .filter(row => utils.cleanCategoryName(row.nganhHang) === selectedCategory)
                .map(row => row.nhaSanXuat || 'H√£ng kh√°c')
                .filter(Boolean))
            ].sort();
        } else {
            // N·∫øu kh√¥ng ch·ªçn ng√†nh h√†ng, hi·ªÉn th·ªã t·∫•t c·∫£ h√£ng c√≥ trong d·ªØ li·ªáu realtime
            availableBrands = [...new Set(appState.realtimeYCXData
                .map(row => row.nhaSanXuat || 'H√£ng kh√°c')
                .filter(Boolean))
            ].sort();
        }

        // T·∫°o danh s√°ch options
        let brandOptions = [{ value: '', label: 'T·∫•t c·∫£ c√°c h√£ng', selected: true }];
        brandOptions = brandOptions.concat(availableBrands.map(brand => ({ value: brand, label: brand })));
        
        // L·∫•y gi√° tr·ªã hi·ªán t·∫°i ƒë·ªÉ c·ªë g·∫Øng b·∫£o to√†n l·ª±a ch·ªçn
        const currentValue = brandChoices.getValue(true);
        
        // C·∫≠p nh·∫≠t Choices.js
        brandChoices.clearStore();
        brandChoices.setChoices(brandOptions, 'value', 'label', true);
        
        // C·ªë g·∫Øng ƒë·∫∑t l·∫°i gi√° tr·ªã c≈© n·∫øu n√≥ v·∫´n t·ªìn t·∫°i trong danh s√°ch m·ªõi
        if (currentValue && availableBrands.includes(currentValue)) {
            brandChoices.setValue([currentValue]);
        } else {
             brandChoices.setValue(['']); // Reset v·ªÅ "T·∫•t c·∫£"
        }
    },

    populateCompetitionFilters() {
        // ... (Gi·ªØ nguy√™n)
        const groupSelectInstance = appState.choices['competition_group'];
        if (!groupSelectInstance) return;
        const uniqueGroups = [...new Set(appState.categoryStructure.map(item => utils.cleanCategoryName(item.nhomHang)).filter(Boolean))].sort();
        const groupOptions = uniqueGroups.map(group => ({ value: group, label: group }));
        groupSelectInstance.clearStore();
        groupSelectInstance.setChoices(groupOptions, 'value', 'label', true);
    },

    populateCompetitionBrandFilter() {
        // ... (Gi·ªØ nguy√™n)
        const brandSelectInstance = appState.choices['competition_brand'];
        if (!brandSelectInstance) return;
        const brands = appState.brandList || [];
        const brandOptions = brands.map(brand => ({ value: brand, label: brand }));
        brandSelectInstance.clearStore();
        brandSelectInstance.setChoices(brandOptions, 'value', 'label', true);
    },

    populateWarehouseSelector() {
        // ... (Gi·ªØ nguy√™n)
        const selector = document.getElementById('data-warehouse-selector');
        if (!selector) {
            console.error("Kh√¥ng t√¨m th·∫•y #data-warehouse-selector");
            return;
        }

        if (!appState.danhSachNhanVien || appState.danhSachNhanVien.length === 0) {
            selector.innerHTML = '<option value="">-- Vui l√≤ng t·∫£i Danh s√°ch Nh√¢n vi√™n --</option>';
            selector.disabled = true;
            console.log("populateWarehouseSelector: DSNV tr·ªëng.");
            return;
        }

        const uniqueWarehouses = [...new Set(appState.danhSachNhanVien.map(nv => String(nv.maKho).trim()).filter(Boolean))].sort();
        console.log("populateWarehouseSelector: C√°c kho t√¨m th·∫•y (d·∫°ng chu·ªói):", uniqueWarehouses);

        let optionsHTML = '<option value="">-- Ch·ªçn Kho --</option>';
        optionsHTML += uniqueWarehouses.map(kho => `<option value="${kho}">${kho}</option>`).join('');
        selector.innerHTML = optionsHTML;
        selector.disabled = false;

        let currentSelected = appState.selectedWarehouse ? String(appState.selectedWarehouse).trim() : null;
        if (!currentSelected) {
             const storedValue = localStorage.getItem('selectedWarehouse');
             currentSelected = storedValue ? String(storedValue).trim() : '';
        }
        console.log("populateWarehouseSelector: Kho ƒëang ch·ªçn (state/local, d·∫°ng chu·ªói):", currentSelected);
        if (currentSelected && uniqueWarehouses.includes(currentSelected)) {
            selector.value = currentSelected;
            if (appState.selectedWarehouse !== currentSelected) {
                 appState.selectedWarehouse = currentSelected;
                 console.log("populateWarehouseSelector: ƒê√£ c·∫≠p nh·∫≠t state.selectedWarehouse th√†nh:", currentSelected);
            }
            console.log("populateWarehouseSelector: ƒê√£ ch·ªçn kho:", selector.value);
        } else {
             if (currentSelected && !uniqueWarehouses.includes(currentSelected)) {
                 console.log(`populateWarehouseSelector: Kho ƒë√£ l∆∞u '${currentSelected}' kh√¥ng h·ª£p l·ªá (kh√¥ng c√≥ trong ${uniqueWarehouses.join(',')}), ƒëang reset.`);
                 appState.selectedWarehouse = null;
                 localStorage.removeItem('selectedWarehouse');
                 selector.value = "";
                 console.log("populateWarehouseSelector: Reset state v·ªÅ null v√† selector v·ªÅ '-- Ch·ªçn Kho --'.");
             } else if (!currentSelected) {
                 console.log("populateWarehouseSelector: Kh√¥ng c√≥ kho n√†o ƒë∆∞·ª£c l∆∞u.");
                 appState.selectedWarehouse = null;
                 selector.value = "";
                 console.log("populateWarehouseSelector: Reset state v·ªÅ null v√† selector v·ªÅ '-- Ch·ªçn Kho --'.");
             } else {
                 console.log(`populateWarehouseSelector: Kho '${currentSelected}' h·ª£p l·ªá ho·∫∑c kh√¥ng c√≥ g√¨ ƒë·ªÉ reset.`);
             }
        }
    },
};
--- END FILE: ./ui-filters.js ---

--- START FILE: ./ui-formatters.js ---
// Version 1.0 - Initial extraction from ui-components
// MODULE: UI FORMATTERS
// Ch·ª©a c√°c h√†m thu·∫ßn t√∫y ƒë·ªÉ ƒë·ªãnh d·∫°ng d·ªØ li·ªáu (t√°ch ra t·ª´ ui-components.js)
// Nh·ªØng h√†m n√†y kh√¥ng ph·ª• thu·ªôc v√†o DOM ho·∫∑c appState.

export const formatters = {
    /**
     * ƒê·ªãnh d·∫°ng s·ªë theo chu·∫©n Vi·ªát Nam.
     * @param {number} value - Gi√° tr·ªã s·ªë.
     * @param {number} decimals - S·ªë ch·ªØ s·ªë th·∫≠p ph√¢n.
     * @returns {string} - Chu·ªói ƒë√£ ƒë·ªãnh d·∫°ng.
     */
    formatNumber: (value, decimals = 0) => {
        if (isNaN(value) || value === null) return '0';
        return new Intl.NumberFormat('vi-VN', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(value);
    },

    /**
     * ƒê·ªãnh d·∫°ng doanh thu (chia cho 1 tri·ªáu) v√† tr·∫£ v·ªÅ chu·ªói.
     * @param {number} value - Gi√° tr·ªã doanh thu.
     * @param {number} decimals - S·ªë ch·ªØ s·ªë th·∫≠p ph√¢n.
     * @returns {string} - Chu·ªói ƒë√£ ƒë·ªãnh d·∫°ng (v√≠ d·ª•: '1.5' ho·∫∑c '-')
     */
    formatRevenue(value, decimals = 1) {
         if (!isFinite(value) || value === null || value === 0) return '-';
         const millions = value / 1000000;
         const roundedValue = parseFloat(millions.toFixed(decimals));
         if (roundedValue === 0 && millions !== 0) {
              return millions > 0 ? '> 0' : '< 0';
         }
         return new Intl.NumberFormat('vi-VN', {
             minimumFractionDigits: 0,
             maximumFractionDigits: decimals
         }).format(roundedValue);
     },

     /**
      * ƒê·ªãnh d·∫°ng s·ªë, tr·∫£ v·ªÅ '-' n·∫øu l√† 0.
      * @param {number} value - Gi√° tr·ªã s·ªë.
      * @param {number} decimals - S·ªë ch·ªØ s·ªë th·∫≠p ph√¢n.
      * @returns {string} - Chu·ªói ƒë√£ ƒë·ªãnh d·∫°ng (v√≠ d·ª•: '1.5' ho·∫∑c '-')
      */
     formatNumberOrDash: (value, decimals = 1) => {
         if (!isFinite(value) || value === null || value === 0) return '-';
          const roundedValue = parseFloat(value.toFixed(decimals));
          if (roundedValue === 0 && value !== 0) {
               return value > 0 ? '> 0' : '< 0';
          }
           if (roundedValue === 0) return '-';
          return new Intl.NumberFormat('vi-VN', {
              minimumFractionDigits: 0,
              maximumFractionDigits: decimals
          }).format(roundedValue);
      },

      /**
       * ƒê·ªãnh d·∫°ng s·ªë th√†nh ph·∫ßn trƒÉm (nh√¢n 100).
       * @param {number} value - Gi√° tr·ªã (v√≠ d·ª•: 0.25).
       * @param {number} decimals - S·ªë ch·ªØ s·ªë th·∫≠p ph√¢n.
       * @returns {string} - Chu·ªói ƒë√£ ƒë·ªãnh d·∫°ng (v√≠ d·ª•: '25%')
       */
     formatPercentage: (value, decimals = 0) => {
         if (!isFinite(value) || value === null) return '-';
          if (value === 0) return '-';
          const percentageValue = value * 100;
          const roundedValue = parseFloat(percentageValue.toFixed(decimals));
          if (roundedValue === 0 && percentageValue !== 0) {
             return percentageValue > 0 ? '> 0%' : '< 0%';
          }
         return new Intl.NumberFormat('vi-VN', {
             minimumFractionDigits: decimals,
              maximumFractionDigits: decimals
          }).format(roundedValue) + '%';
      },

    /**
     * Chuy·ªÉn ƒë·ªïi ƒë·ªëi t∆∞·ª£ng Date th√†nh chu·ªói "X [ph√∫t/gi·ªù/ng√†y] tr∆∞·ªõc".
     * @param {Date} date - ƒê·ªëi t∆∞·ª£ng Date.
     * @returns {string} - Chu·ªói th·ªùi gian t∆∞∆°ng ƒë·ªëi.
     */
    formatTimeAgo(date) {
         if (!date || !(date instanceof Date) || isNaN(date)) return '';
         const seconds = Math.floor((new Date() - date) / 1000);
         let interval = seconds / 31536000;
         if (interval > 1) return Math.floor(interval) + " nƒÉm tr∆∞·ªõc";
         interval = seconds / 2592000;
         if (interval > 1) return Math.floor(interval) + " th√°ng tr∆∞·ªõc";
         interval = seconds / 86400;
         if (interval > 1) return Math.floor(interval) + " ng√†y tr∆∞·ªõc";
         interval = seconds / 3600;
         if (interval > 1) return Math.floor(interval) + " gi·ªù tr∆∞·ªõc";
         interval = seconds / 60;
         if (interval > 1) return Math.floor(interval) + " ph√∫t tr∆∞·ªõc";
         return "v√†i gi√¢y tr∆∞·ªõc";
     },

    /**
     * L·∫•y t√™n r√∫t g·ªçn c·ªßa nh√¢n vi√™n (T√™n cu·ªëi + MSNV).
     * @param {string} hoTen - H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß.
     * @param {string} maNV - M√£ nh√¢n vi√™n.
     * @returns {string} - T√™n r√∫t g·ªçn (v√≠ d·ª•: "VƒÉn A - 12345")
     */
    getShortEmployeeName(hoTen, maNV) {
        if (!hoTen) return maNV || '';
        const nameParts = hoTen.split(' ').filter(p => p);
        let displayName = hoTen;
        if (nameParts.length > 2) {
            displayName = nameParts.slice(-2).join(' ');
        }
        return `${displayName} - ${maNV}`;
    },
};
--- END FILE: ./ui-formatters.js ---

--- START FILE: ./ui-home.js ---
// Version 1.1 - Fix renderUpdateHistory to support nested object notes
// MODULE: UI HOME
// Ch·ª©a c√°c h√†m render cho tab Trang ch·ªß.

import { appState } from './state.js';
import { formatters } from './ui-formatters.js';

/**
 * Render l·ªãch s·ª≠ c·∫≠p nh·∫≠t l√™n trang ch·ªß.
 * (ƒê√£ di chuy·ªÉn t·ª´ ui-components.js)
 * (V1.1 - ƒê√É S·ª¨A L·ªñI [object Object])
 */
const renderUpdateHistory = async () => {
    const container = document.getElementById('update-history-list');
    if (!container) return;
    try {
        const response = await fetch(`./changelog.json?v=${new Date().getTime()}`);
        if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ c·∫≠p nh·∫≠t.');
        const updateHistory = await response.json();

        // === START: LOGIC S·ª¨A L·ªñI (V1.1) ===
        // Logic render n√†y ƒë∆∞·ª£c ƒë·ªìng b·ªô t·ª´ main.js [cite: 567-572]
        container.innerHTML = updateHistory.map(item => {
            const notesHtml = item.notes.map(note => {
                // Ki·ªÉm tra xem 'note' l√† string hay object
                if (typeof note === 'object' && note !== null && note.title && Array.isArray(note.items)) {
                    // ƒê√¢y l√† m·ªôt m·ª•c l·ªìng c·∫•p
                    const subItemsHtml = note.items.map(subItem => 
                        // S·ª≠ d·ª•ng style 'list-style-type: "- "'
                        `<li class="ml-4" style="list-style-type: '- ';">${subItem}</li>`
                    ).join('');
                 
                    return `
                        <li class="mt-2 font-semibold text-gray-800">${note.title}
                            <ul class="font-normal text-gray-700 space-y-1 mt-1">
                                ${subItemsHtml}
                            </ul>
                        </li>
                    `;
                } else {
                    // ƒê√¢y l√† m·ªôt string b√¨nh th∆∞·ªùng
                    return `<li class="text-gray-700">${note}</li>`;
                }
            }).join('');
            // === END: LOGIC S·ª¨A L·ªñI ===

            return `
                <div class="bg-white rounded-xl shadow-md p-5 border border-gray-200">
                    <h4 class="font-bold text-blue-600 mb-2">Phi√™n b·∫£n ${item.version} (${item.date})</h4>
                    <ul class="list-disc list-inside text-gray-700 space-y-1 text-sm">
                        ${notesHtml}
                    </ul>
                </div>`;
        }).join('');
    } catch (error) {
        console.error("L·ªói khi render l·ªãch s·ª≠ c·∫≠p nh·∫≠t:", error);
        container.innerHTML = '<p class="text-red-500">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ c·∫≠p nh·∫≠t.</p>';
    }
};

/**
 * Render khu v·ª±c Feedback (So·∫°n th·∫£o v√† Danh s√°ch) l√™n trang ch·ªß.
 * (ƒê√£ di chuy·ªÉn t·ª´ ui-components.js)
 */
const renderFeedbackSection = () => {
    const composerContainer = document.getElementById('feedback-composer');
    const listContainer = document.getElementById('feedback-list');
    if (!composerContainer || !listContainer) return;

    composerContainer.innerHTML = `
            <h4 class="text-lg font-semibold text-gray-800 mb-3">G·ª≠i g√≥p √Ω c·ªßa b·∫°n</h4>
        <textarea id="feedback-textarea" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mb-3" rows="4" placeholder="Ch√∫ng t√¥i lu√¥n l·∫Øng nghe √Ω ki·∫øn c·ªßa b·∫°n ƒë·ªÉ c·∫£i thi·ªán c√¥ng c·ª• t·ªët h∆°n..."></textarea>
            <button id="submit-feedback-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">G·ª≠i g√≥p √Ω</button>
    `;

    if (!appState.feedbackList || appState.feedbackList.length === 0) {
        listContainer.innerHTML = '<p class="text-center text-gray-500 mt-4">Ch∆∞a c√≥ g√≥p √Ω n√†o.</p>';
        return;
    }

    listContainer.innerHTML = appState.feedbackList.map(item => {
        const userNameDisplay = item.user?.email || 'Ng∆∞·ªùi d√πng ·∫©n danh';
        return `
            <div class="feedback-item bg-white rounded-xl shadow-md p-5 border border-gray-200" data-id="${item.id}">
                <p class="text-gray-800">${item.content}</p>
                    <div class="text-xs text-gray-500 mt-3 flex justify-between items-center">
                        <span class="font-semibold">${userNameDisplay}</span>
                        <span>${formatters.formatTimeAgo(item.timestamp)}</span> 
                        ${appState.isAdmin ? `<button class="reply-btn text-blue-600 hover:underline">Tr·∫£ l·ªùi</button>` : ''}
                </div>
                <div class="ml-6 mt-4 space-y-3">
                        ${(item.replies || []).map(reply => `
                            <div class="bg-gray-100 rounded-lg p-3">
                            <p class="text-gray-700 text-sm">${reply.content}</p>
                                <div class="text-xs text-gray-500 mt-2">
                                    <strong>Admin</strong> - ${formatters.formatTimeAgo(reply.timestamp instanceof Date ? reply.timestamp : reply.timestamp?.toDate())} 
                                </div>
                        </div>`).join('')}
                </div>
                <div class="reply-form-container hidden ml-6 mt-4">
                        <textarea class="w-full p-2 border rounded-lg text-sm" rows="2" placeholder="Vi·∫øt c√¢u tr·∫£ l·ªùi..."></textarea>
                        <div class="flex justify-end gap-2 mt-2">
                        <button class="cancel-reply-btn text-sm text-gray-600 px-3 py-1 rounded-md hover:bg-gray-100">H·ªßy</button>
                            <button class="submit-reply-btn text-sm bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700">G·ª≠i</button>
                    </div>
                </div>
            </div>`;
    }).join('');
};

/**
 * H√†m render ch√≠nh cho Trang ch·ªß.
 * (ƒê√£ di chuy·ªÉn t·ª´ ui-components.js)
 */
const renderHomePage = () => {
    renderUpdateHistory();
    renderFeedbackSection();
};

// Xu·∫•t kh·∫©u ƒë·ªëi t∆∞·ª£ng g·ªôp
export const uiHome = {
    renderHomePage,
    renderUpdateHistory,
    renderFeedbackSection
};
--- END FILE: ./ui-home.js ---

--- START FILE: ./ui-luyke.js ---
// Version 2.19 - Add sorting to Luy Ke Efficiency table
// Version 2.18 - Remove dedicated capture button from employee detail view
// Version 2.11 - Critical Fix: Restore all missing functions and add renderLuykeEmployeeDetail
// MODULE: UI LUY KE
// Ch·ª©a c√°c h√†m render giao di·ªán cho tab "S·ª©c kh·ªèe Si√™u th·ªã (L≈©y k·∫ø)".

import { appState } from './state.js';
import { services } from './services.js';
import { utils } from './utils.js';
import { uiComponents } from './ui-components.js';
import { settingsService } from './modules/settings.service.js';
import { highlightService } from './modules/highlight.service.js';

export const uiLuyke = {
    // === C√ÅC H√ÄM M·ªû MODAL C√ÄI ƒê·∫∂T CHO T·ª™NG B·∫¢NG ===
    _showEfficiencySettingsModal() {
        const modal = document.getElementById('selection-modal');
        if (!modal) return;

        const allItemsConfig = settingsService.loadEfficiencyViewSettings();
        
        const listContainer = document.getElementById('selection-modal-list');
        listContainer.innerHTML = allItemsConfig.map(item => `
            <div class="selection-item">
                <input type="checkbox" id="select-item-lk-eff-${item.id}" value="${item.id}" ${item.visible ? 'checked' : ''}>
                <label for="select-item-lk-eff-${item.id}">${item.label}</label>
             </div>
        `).join('');

        document.getElementById('selection-modal-title').textContent = 'T√πy ch·ªânh hi·ªÉn th·ªã Hi·ªáu qu·∫£ khai th√°c';
        modal.dataset.settingType = 'efficiencyView';
        const searchInput = document.getElementById('selection-modal-search');
        if (searchInput) searchInput.value = '';
        
        uiComponents.toggleModal('selection-modal', true);
    },

    _showQdcSettingsModal(supermarketReport) {
        const modal = document.getElementById('selection-modal');
        if (!modal || !supermarketReport || !supermarketReport.qdc) return;

        const allItems = Object.values(supermarketReport.qdc).map(item => item.name).sort();
        const savedSettings = settingsService.loadQdcViewSettings(allItems);
        
        const listContainer = document.getElementById('selection-modal-list');
        listContainer.innerHTML = allItems.map(item => `
            <div class="selection-item">
                <input type="checkbox" id="select-item-lk-qdc-${item.replace(/[^a-zA-Z0-9]/g, '')}" value="${item}" ${savedSettings.includes(item) ? 'checked' : ''}>
                <label for="select-item-lk-qdc-${item.replace(/[^a-zA-Z0-9]/g, '')}">${item}</label>
            </div>
        `).join('');

        document.getElementById('selection-modal-title').textContent = 'T√πy ch·ªânh hi·ªÉn th·ªã Nh√≥m h√†ng QƒêC';
        modal.dataset.settingType = 'qdcView';
        const searchInput = document.getElementById('selection-modal-search');
        if (searchInput) searchInput.value = '';
        
        uiComponents.toggleModal('selection-modal', true);
    },

    _showCategorySettingsModal(supermarketReport) {
        const modal = document.getElementById('selection-modal');
        if (!modal || !supermarketReport || !supermarketReport.nganhHangChiTiet) return;

        const allItems = Object.keys(supermarketReport.nganhHangChiTiet).sort();
        const savedSettings = settingsService.loadCategoryViewSettings(allItems);
        
        const listContainer = document.getElementById('selection-modal-list');
        listContainer.innerHTML = allItems.map(item => `
            <div class="selection-item">
                <input type="checkbox" id="select-item-lk-cat-${item.replace(/[^a-zA-Z0-9]/g, '')}" value="${item}" ${savedSettings.includes(item) ? 'checked' : ''}>
                <label for="select-item-lk-cat-${item.replace(/[^a-zA-Z0-9]/g, '')}">${item}</label>
            </div>
        `).join('');

        document.getElementById('selection-modal-title').textContent = 'T√πy ch·ªânh hi·ªÉn th·ªã Ng√†nh h√†ng chi ti·∫øt';
        modal.dataset.settingType = 'categoryView';
        const searchInput = document.getElementById('selection-modal-search');
        if (searchInput) searchInput.value = '';
        
        uiComponents.toggleModal('selection-modal', true);
    },
    
    // === START: MODIFIED FUNCTION (TASK 1 & 3) ===
    /**
     * Render 2 bi·ªÉu ƒë·ªì th·ªëng k√™ theo ng√†y.
     * @param {Array} dailyStats - D·ªØ li·ªáu g·ªëc.
     * @param {number | 'all' | Array} filterParam - S·ªë ng√†y, 'all', ho·∫∑c m·∫£ng d·ªØ li·ªáu ƒë√£ l·ªçc.
     */
    _renderDailyCharts(dailyStats, filterParam = 7) {
        if (!dailyStats || dailyStats.length === 0) return;

        let filteredData;
        if (typeof filterParam === 'number') {
            filteredData = dailyStats.slice(-filterParam); // L·ªçc theo s·ªë ng√†y 
        } else if (filterParam === 'all') {
            filteredData = dailyStats; // L·∫•y t·∫•t c·∫£ 
        } else if (Array.isArray(filterParam)) {
            filteredData = filterParam; // S·ª≠ d·ª•ng m·∫£ng ƒë√£ l·ªçc (cho T√πy ch·ªçn) 
        } else {
            filteredData = dailyStats.slice(-7); // M·∫∑c ƒë·ªãnh 7 ng√†y 
        }

        const labels = filteredData.map(d => new Date(d.date).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' })); 
        const dtqdData = filteredData.map(d => d.convertedRevenue / 1000000); 
        const tlqdData = filteredData.map(d => (d.revenue > 0 ? (d.convertedRevenue / d.revenue) - 1 : 0)); 

        const chartOptions = (title) => ({
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }, 
                title: { display: false }, // T·∫Øt ti√™u ƒë·ªÅ m·∫∑c ƒë·ªãnh, v√¨ ƒë√£ c√≥ ti√™u ƒë·ªÅ card 
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const value = context.raw; 
                            if (title.includes('T·ª∑ l·ªá')) {
                                return `T·ª∑ l·ªá: ${uiComponents.formatPercentage(value)}`; 
                            }
                            return `DTQƒê: ${uiComponents.formatRevenue(value * 1000000)} Tr`; 
                        }
                    }
                },
                datalabels: {
                    anchor: 'end', 
                    align: 'end', 
                    formatter: (value) => {
                        if (title.includes('T·ª∑ l·ªá')) {
                            return uiComponents.formatPercentage(value); 
                        }
                        return uiComponents.formatRevenue(value * 1000000); 
                    },
                    color: '#4b5563', 
                    font: { weight: 'bold', size: 10 } 
                }
            },
            scales: {
                y: { 
                    beginAtZero: true, 
                    grace: '10%' // (Task 1) Th√™m 10% kho·∫£ng ƒë·ªám 
                }
            }
        });

        // Bi·ªÉu ƒë·ªì Doanh thu Quy ƒë·ªïi
        const dtqdCtx = document.getElementById('lk-daily-dtqd-chart')?.getContext('2d'); 
        if (dtqdCtx) {
            if (appState.charts['lk-daily-dtqd-chart']) {
                appState.charts['lk-daily-dtqd-chart'].destroy(); 
            }
            appState.charts['lk-daily-dtqd-chart'] = new Chart(dtqdCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh thu Qƒê', 
                        data: dtqdData, 
                        backgroundColor: '#3b82f6', 
                        borderRadius: 4, 
                    }]
                },
                options: chartOptions('Doanh thu Qƒê theo ng√†y (Tr)'), 
                plugins: [ChartDataLabels] 
            });
        }

        // Bi·ªÉu ƒë·ªì T·ª∑ l·ªá Quy ƒë·ªïi
        const tlqdCtx = document.getElementById('lk-daily-tlqd-chart')?.getContext('2d'); 
        if (tlqdCtx) {
            if (appState.charts['lk-daily-tlqd-chart']) {
                appState.charts['lk-daily-tlqd-chart'].destroy(); 
            }
            appState.charts['lk-daily-tlqd-chart'] = new Chart(tlqdCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'T·ª∑ l·ªá Qƒê', 
                        data: tlqdData, 
                        backgroundColor: '#16a34a', 
                        borderRadius: 4, 
                    }]
                },
                options: chartOptions('T·ª∑ l·ªá Qƒê theo ng√†y'), 
                plugins: [ChartDataLabels] 
            });
        }
    },
    // === END: MODIFIED FUNCTION ===

    // === START: NEW FUNCTION (TASK 3) ===
    /**
     * Render n·ªôi dung cho modal chi ti·∫øt kh√°ch h√†ng.
     * @param {Object} detailData - D·ªØ li·ªáu chi ti·∫øt c·ªßa nh√¢n vi√™n.
     */
    _renderCustomerDetailModalContent(detailData) {
        const { byCustomer, mucTieu } = detailData; 
        const conversionRateTarget = (mucTieu?.phanTramQD || 0) / 100; 
        const container = document.getElementById('customer-detail-list-container'); 
        if (!container) return; 

        if (!byCustomer || byCustomer.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500 mt-4 text-center">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o.</p>'; 
            return;
        }

        const renderAccordion = (data) => data.map((customer, index) => {
            const qdClass = customer.conversionRate >= conversionRateTarget ? 'qd-above-target' : 'qd-below-target'; 
        
            const productListHtml = customer.products.map(p => `
                <tr class="border-b last:border-b-0">
                    <td class="py-1 pr-2">${p.productName}</td>
                    <td class="py-1 px-2 text-right">SL: <strong>${p.quantity}</strong></td>
                    <td class="py-1 px-2 text-right">DT: <strong>${uiComponents.formatRevenue(p.realRevenue, 1)}</strong></td>
                    <td class="py-1 pl-2 text-right">DTQƒê: <strong>${uiComponents.formatRevenue(p.convertedRevenue, 1)}</strong></td>
                </tr>
            `).join(''); 
            
            const tableContent = `<table class="min-w-full text-xs product-list-table"><tbody>${productListHtml}</tbody></table>`; 
            
            const detailContent = customer.products.length > 8
                ? `<div class="product-list-scrollable">${tableContent}</div>` 
                : tableContent; 

            return `
             <details class="bg-white rounded-lg shadow-sm border border-gray-200 mb-2">
                <summary>
                    <span class="customer-name-small">${index + 1}. ${customer.name}</span>
                    <div class="order-metrics">
                         <span>SL: <strong>${customer.totalQuantity}</strong></span> 
                        <span>DT Th·ª±c: <strong class="text-gray-900">${uiComponents.formatRevenue(customer.totalRealRevenue, 1)} Tr</strong></span> 
                        <span>DTQƒê: <strong class="text-blue-600">${uiComponents.formatRevenue(customer.totalConvertedRevenue, 1)} Tr</strong></span> 
                        <span>%Qƒê: <strong class="${qdClass}">${uiComponents.formatPercentage(customer.conversionRate)}</strong></span> 
                    </div>
                    <span class="accordion-arrow">‚ñº</span> 
                </summary>
                <div class="border-t border-gray-200 p-3 bg-gray-50">
                    ${detailContent} 
                 </div>
            </details>
            `; 
        }).join('');

        container.innerHTML = renderAccordion(byCustomer);
    },
    // === END: NEW FUNCTION ===

    // === START: NEW FUNCTION (TASK 4) ===
    /**
     * Render n·ªôi dung cho modal chi ti·∫øt ch∆∞a xu·∫•t.
     * @param {Object} detailData - D·ªØ li·ªáu chi ti·∫øt c·ªßa nh√¢n vi√™n.
     */
    _renderUnexportedDetailModalContent(detailData) {
        const { unexportedDetails } = detailData; 
        const container = document.getElementById('unexported-detail-list-container'); 
        if (!container) return; 

        if (!unexportedDetails || unexportedDetails.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500 mt-4 text-center">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ch∆∞a xu·∫•t.</p>'; 
            return;
        }

        const renderAccordion = (data) => data.map((group, index) => {
            const productListHtml = group.products.map(p => `
                <tr class="border-b last:border-b-0">
                    <td class="py-1 pr-2">${p.name}</td>
                    <td class="py-1 px-2 text-right">SL: <strong>${p.sl}</strong></td> 
                    <td class="py-1 pl-2 text-right">DTQƒê: <strong>${uiComponents.formatRevenue(p.dtqd, 1)}</strong></td> 
                </tr>
            `).join('');
            
            const tableContent = `<table class="min-w-full text-xs product-list-table"><tbody>${productListHtml}</tbody></table>`; 
            
            const detailContent = group.products.length > 8
                ? `<div class="product-list-scrollable">${tableContent}</div>` 
                : tableContent; 

            return `
             <details class="bg-white rounded-lg shadow-sm border border-gray-200 mb-2">
                <summary>
                    <span class="customer-name-small">${index + 1}. ${group.name}</span> 
                    <div class="order-metrics">
                        <span>SL: <strong>${group.totalSL}</strong></span> 
                        <span>DTQƒê: <strong class="text-blue-600">${uiComponents.formatRevenue(group.totalDTQD, 1)} Tr</strong></span> 
                    </div>
                    <span class="accordion-arrow">‚ñº</span> 
                </summary>
                <div class="border-t border-gray-200 p-3 bg-gray-50">
                    ${detailContent} 
                 </div>
            </details>
            `; 
        }).join('');

        container.innerHTML = renderAccordion(unexportedDetails);
    },
    // === END: NEW FUNCTION ===

    // === START: MODIFIED FUNCTION (v2.17) ===
    renderLuykeEmployeeDetail(detailData, employeeData, detailContainerId) {
        const summaryContainer = document.getElementById('revenue-report-container-lk'); 
        const detailContainer = document.getElementById(detailContainerId); 

        if (!summaryContainer || !detailContainer) return; 

        summaryContainer.classList.add('hidden'); 
        detailContainer.classList.remove('hidden'); 
        
        if (!detailData || !employeeData) {
            detailContainer.innerHTML = `
                <div class="mb-4">
                     <button class="back-to-summary-btn text-blue-600 hover:underline font-semibold">‚Äπ Quay l·∫°i b·∫£ng t·ªïng h·ª£p</button>
                </div>
                <p class="text-red-500">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu chi ti·∫øt cho nh√¢n vi√™n ƒë√£ ch·ªçn.</p>
            `; 
            return;
        }

        // === START: (Task 3) Th√™m customFilteredDailyStats: null ===
        appState.currentEmployeeDetailData = { ...detailData, customFilteredDailyStats: null }; 
        // === END: (Task 3) ===

        const { summary, topProductGroups, categoryChartData, byCustomer, dailyStats, unexportedDetails } = detailData; 
        const { mucTieu } = employeeData; 
        const conversionRateTarget = (mucTieu?.phanTramQD || 0) / 100; 

        const renderKpiCards = () => {
             const conversionRateClass = summary.conversionRate >= conversionRateTarget ? 'is-positive' : 'is-negative'; 
            
             // (Task 3 & 4) Th√™m ID v√† class cursor-pointer
            return `
            <div class="rt-infographic-summary mb-6">
                <div class="rt-infographic-summary-card"><div class="label">T·ªïng DT Th·ª±c</div><div class="value">${uiComponents.formatRevenue(summary.totalRealRevenue, 1)}</div></div>
                <div class="rt-infographic-summary-card"><div class="label">T·ªïng DTQƒê</div><div class="value">${uiComponents.formatRevenue(summary.totalConvertedRevenue, 1)}</div></div> 
                <div class="rt-infographic-summary-card"><div class="label">T·ª∑ l·ªá Qƒê</div><div class="value ${conversionRateClass}">${uiComponents.formatPercentage(summary.conversionRate)}</div></div>
                
                <div id="lk-detail-unexported-trigger" class="rt-infographic-summary-card cursor-pointer hover:shadow-xl hover:bg-blue-50">
                    <div class="label">DT Ch∆∞a Xu·∫•t</div>
                    <div class="value">${uiComponents.formatRevenue(summary.unexportedRevenue, 1)}</div> 
                </div>
                
                <div id="lk-detail-customer-trigger" class="rt-infographic-summary-card cursor-pointer hover:shadow-xl hover:bg-blue-50">
                    <div class="label">T·ªïng ƒê∆°n H√†ng</div>
                    <div class="value">${summary.totalOrders}</div> 
                </div>

                <div class="rt-infographic-summary-card"><div class="label">SL ƒê∆°n B√°n K√®m</div><div class="value">${summary.bundledOrderCount}</div></div> 
            </div>
            `;
        };

        const renderTopGroupsAsProgressBars = () => {
            const top5Groups = topProductGroups.slice(0, 5); 
            if (!top5Groups || top5Groups.length === 0) return '<p class="text-sm text-gray-500">Kh√¥ng c√≥ doanh thu.</p>'; 
            
            const maxRevenue = top5Groups[0]?.realRevenue || 0; 
            
            return top5Groups.map(group => {
                const percentage = maxRevenue > 0 ? (group.realRevenue / maxRevenue) * 100 : 0; 
                return `
                <div class="luyke-detail-progress-item">
                    <div class="luyke-detail-progress-label">
                         <span class="font-semibold">${group.name}</span> 
                        <span class="text-xs">SL: ${uiComponents.formatNumber(group.quantity)} | %Qƒê: ${uiComponents.formatPercentage(group.conversionRate)}</span> 
                    </div>
                    <div class="rt-progress-bar-container">
                        <div class="rt-progress-bar" style="width: ${percentage}%;"></div> 
                     </div>
                    <div class="luyke-detail-progress-values">
                        <span>DT Th·ª±c: <strong>${uiComponents.formatRevenue(group.realRevenue)}</strong></span> 
                        <span>DTQƒê: <strong>${uiComponents.formatRevenue(group.convertedRevenue)}</strong></span> 
                    </div>
                 </div>
                `; 
            }).join(''); 
        };
        
        // === START: (Task 3) C·∫≠p nh·∫≠t HTML b·ªô l·ªçc ng√†y ===
        // === START: S·ª¨A L·ªñI (Lo·∫°i b·ªè n√∫t ch·ª•p ri√™ng) ===
        const headerHtml = `
            <div class="mb-4 flex justify-start items-center">
                <button class="back-to-summary-btn text-blue-600 hover:underline font-semibold">‚Äπ Quay l·∫°i b·∫£ng t·ªïng h·ª£p</button>
            </div>
            <div id="dtnv-lk-capture-area" class="preset-mobile-capture-area">
                <div class="p-4 mb-6 bg-white text-gray-800 rounded-lg shadow-lg border luyke-detail-header">
                    <h3>${employeeData.hoTen} - ${employeeData.maNV}</h3> 
                </div>
                
                <div>
                    ${renderKpiCards()}
                </div>

                <div id="lk-daily-chart-filters" class="flex items-center justify-center flex-wrap gap-2 mb-4"> 
                    <span class="text-sm font-medium">Xem theo:</span> 
                    <button id="lk-daily-filter-all" class="lk-daily-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-200" data-days="all">T·∫•t c·∫£</button> 
                    <button class="lk-daily-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-200" data-days="3">3 ng√†y</button> 
                    <button class="lk-daily-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-200" data-days="5">5 ng√†y</button> 
                    <button class="lk-daily-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-blue-600 text-white" data-days="7">7 ng√†y</button> 
                    <button class="lk-daily-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-200" data-days="10">10 ng√†y</button> 
                    <button id="lk-daily-filter-custom" class="lk-daily-filter-btn px-3 py-1 text-xs font-medium rounded-full bg-gray-200">T√πy ch·ªçn...</button> 
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6"> 
                    <div class="bg-white p-4 rounded-lg shadow-md border" style="height: 300px;">
                        <h4 class="text-md font-bold text-gray-700 mb-2 text-center">Doanh thu Qƒê theo ng√†y (Tr)</h4> 
                        <div class="relative h-full w-full" style="height: 250px;"><canvas id="lk-daily-dtqd-chart"></canvas></div> 
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md border" style="height: 300px;">
                        <h4 class="text-md font-bold text-gray-700 mb-2 text-center">T·ª∑ l·ªá Qƒê theo ng√†y</h4> 
                        <div class="relative h-full w-full" style="height: 250px;"><canvas id="lk-daily-tlqd-chart"></canvas></div> 
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6"> 
                    
                     <div class="bg-white p-4 rounded-lg shadow-md border">
                        <h4 class="text-md font-bold text-gray-700 border-b pb-2 mb-3">Top 5 Nh√≥m H√†ng Doanh Thu Cao</h4> 
                        <div class="space-y-3">
                            ${renderTopGroupsAsProgressBars()} 
                         </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow-md border">
                        <h4 class="text-md font-bold text-gray-700 mb-2">T·ª∑ Tr·ªçng Doanh Thu Ng√†nh H√†ng</h4> 
                         <div class="luyke-detail-chart-container">
                            <canvas id="luyke-employee-chart"></canvas> 
                        </div>
                    </div>
                </div>
            </div>`;
        // === END: S·ª¨A L·ªñI (Lo·∫°i b·ªè n√∫t ch·ª•p ri√™ng) ===

        detailContainer.innerHTML = headerHtml;

        // === START: (Task 3) C·∫≠p nh·∫≠t logic g·ªçi bi·ªÉu ƒë·ªì ===
        // (Task 1) G·ªçi h√†m render bi·ªÉu ƒë·ªì h√†ng ng√†y, ƒë·ªçc t·ª´ filter
        const activeFilterBtn = document.querySelector('#lk-daily-chart-filters .lk-daily-filter-btn.bg-blue-600'); 
        let filterParam = activeFilterBtn ? activeFilterBtn.dataset.days : '7'; 
        
        // Chuy·ªÉn ƒë·ªïi 'all' ho·∫∑c s·ªë
        if (filterParam === 'all') {
             filterParam = 'all'; 
        } else if (!isNaN(parseInt(filterParam, 10))) {
            filterParam = parseInt(filterParam, 10); 
        } else {
            // Tr∆∞·ªùng h·ª£p n√†y l√† n√∫t "T√πy ch·ªçn" ƒëang active, d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l·ªçc s·∫µn
            filterParam = appState.currentEmployeeDetailData.customFilteredDailyStats || dailyStats.slice(-7); 
        }
        
        uiLuyke._renderDailyCharts(dailyStats, filterParam); 
        // === END: (Task 3) C·∫≠p nh·∫≠t logic ===

        const ctx = document.getElementById('luyke-employee-chart')?.getContext('2d'); 
        if (ctx && categoryChartData && categoryChartData.length > 0) {
            if (appState.charts['luyke-employee-chart']) {
                 appState.charts['luyke-employee-chart'].destroy(); 
            }
            const sortedChartData = [...categoryChartData].sort((a,b) => b.revenue - a.revenue); 
            const topData = sortedChartData.slice(0, 10); 
            
            appState.charts['luyke-employee-chart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topData.map(d => d.name), 
                     datasets: [{
                        label: 'Doanh thu', 
                        data: topData.map(d => d.revenue / 1000000), 
                        // (Task 2) Th√™m nhi·ªÅu m√†u
                        backgroundColor: topData.map(() => utils.getRandomBrightColor()), 
                        borderRadius: 4, 
                     }]
                },
                options: {
                    indexAxis: 'x',
                    responsive: true, 
                    maintainAspectRatio: false, 
                     plugins: {
                        legend: { display: false }, 
                        tooltip: {
                            callbacks: {
                                 label: context => `${context.label}: ${uiComponents.formatRevenue(context.raw * 1000000)} Tr` 
                            }
                        },
                        datalabels: {
                             anchor: 'end', 
                            align: 'end', 
                            formatter: (value) => uiComponents.formatRevenue(value * 1000000), 
                            color: '#4b5563', 
                             font: { weight: 'bold', size: 10 } 
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grace: '10%' // (Task 1) Th√™m 10% kho·∫£ng ƒë·ªám 
                        } 
                     }
                },
                plugins: [ChartDataLabels] 
            });
        }
    },
    // === END: MODIFIED FUNCTION ===

    renderCompetitionSummaryCounter: (data) => {
        // === START: D·ªçn d·∫πp State (Task 3 & 4) ===
        appState.currentEmployeeDetailData = null; 
        // === END: D·ªçn d·∫πp State ===
        const summary = {
            total: data.length, 
            dat: data.filter(d => d.hoanThanhValue >= 100).length, 
            doanhThuCount: data.filter(d => d.type === 'doanhThu').length, 
            soLuongCount: data.filter(d => d.type === 'soLuong').length, 
        };
        
        const totalHtml = `<strong class="text-blue-600">${summary.total}</strong>`; 
        const datHtml = `<strong class="text-blue-600">${summary.dat}</strong>`; 
        const chuaDatHtml = `<strong class="text-red-600">${summary.total - summary.dat}</strong>`; 
        const dtHtml = `<strong class="text-blue-600">${summary.doanhThuCount}</strong>`; 
        const slHtml = `<strong class="text-blue-600">${summary.soLuongCount}</strong>`; 

        return `(<span class="font-normal text-gray-500">T·ªïng:</span> ${totalHtml}, 
                <span class="font-normal text-gray-500">ƒê·∫°t:</span> ${datHtml}, 
                <span class="font-normal text-gray-500">Ch∆∞a ƒë·∫°t:</span> ${chuaDatHtml}, 
                <span class="font-normal text-gray-500">DT:</span> ${dtHtml}, 
                <span class="font-normal text-gray-500">SL:</span> ${slHtml})`; 
    },
    
    // === START: MODIFIED FUNCTION (v2.15) ===
    displayHealthKpiTable: (pastedData, goals) => {
        // === START: D·ªçn d·∫πp State (Task 3 & 4) ===
        appState.currentEmployeeDetailData = null; 
        // === END: D·ªçn d·∫πp State ===
        const { mainKpis, comparisonData, dtDuKien, dtqdDuKien, luotKhachData } = pastedData; 
        
        const competitionSummary = { dat: 0, total: 0 }; 
        if (appState.competitionData && appState.competitionData.length > 0) {
            competitionSummary.total = appState.competitionData.length; 
            competitionSummary.dat = appState.competitionData.filter(d => (parseFloat(String(d.hoanThanh).replace('%','')) || 0) >= 100).length; 
        }

        if (!mainKpis || Object.keys(mainKpis).length === 0) {
            const supermarketReport = services.aggregateReport(appState.masterReportData.luyke); 
            const cardData = {
                dtThucLK: supermarketReport.doanhThu, 
                dtQdLK: supermarketReport.doanhThuQuyDoi, 
                phanTramQd: supermarketReport.doanhThu > 0 ? (supermarketReport.doanhThuQuyDoi / supermarketReport.doanhThu) - 1 : 0, 
                dtGop: supermarketReport.doanhThuTraGop, 
                phanTramGop: supermarketReport.doanhThu > 0 ? 
supermarketReport.doanhThuTraGop / supermarketReport.doanhThu : 0,
                dtThucDuKien: 0, // <-- S·ª¨A L·ªñI (v2.15) 
                dtQdDuKien: 0,   // <-- S·ª¨A L·ªñI (v2.15) 
                phanTramTargetQd: 0, 
                phanTramTargetThuc: 0, 
            };
            uiLuyke.renderLuykeKpiCards(cardData, comparisonData, luotKhachData, appState.masterReportData.luyke, goals, competitionSummary); 
            return;
        }
        
        const cleanValue = (str) => (typeof str === 'string' ? parseFloat(str.replace(/,|%/g, '')) : (typeof str === 'number' ? str : 0)); 
        
        const dtThucLK = cleanValue(mainKpis['Th·ª±c hi·ªán DT th·ª±c']) * 1000000; 
        const dtQdLK = cleanValue(mainKpis['Th·ª±c hi·ªán DTQƒê']) * 1000000; 
        const phanTramGopRaw = cleanValue(mainKpis['T·ª∑ Tr·ªçng Tr·∫£ G√≥p']); 
        const dtGop = dtThucLK * (phanTramGopRaw / 100); 
        const phanTramQd = dtThucLK > 0 ? (dtQdLK / dtThucLK) - 1 : 0; 
        const phanTramGop = dtThucLK > 0 ? dtGop / dtThucLK : 0; 
        
        const targetThuc = (parseFloat(goals.doanhThuThuc) || 0) * 1000000; 
        const phanTramTargetThuc = targetThuc > 0 ? (dtDuKien * 1000000) / targetThuc : 0; 
        const phanTramTargetQd = (cleanValue(mainKpis['% HT Target D·ª± Ki·∫øn (Qƒê)']) || 0) / 100; 

        const luykeCardData = { 
            dtThucLK, dtQdLK, dtGop, phanTramQd, phanTramGop, 
            phanTramTargetThuc, phanTramTargetQd,
            dtThucDuKien: dtDuKien * 1000000,
             dtQdDuKien: dtqdDuKien * 1000000,
        }; 
        
        uiLuyke.renderLuykeKpiCards(luykeCardData, comparisonData, luotKhachData, appState.masterReportData.luyke, goals, competitionSummary); 
    },
    // === END: MODIFIED FUNCTION ===

    displayCompetitionResultsFromLuyKe: (text, viewType = 'summary') => {
        // === START: D·ªçn d·∫πp State (Task 3 & 4) ===
        appState.currentEmployeeDetailData = null; 
        // === END: D·ªçn d·∫πp State ===
        const container = document.getElementById('luyke-competition-infographic-container'); 
        if (!container) return; 

        if (!text || !text.trim()) {
            container.innerHTML = '<p class="text-gray-500 font-bold col-span-2">Vui l√≤ng d√°n "Data l≈©y k·∫ø" ·ªü tab Data ƒë·ªÉ xem chi ti·∫øt.</p>'; 
            return;
        }

        appState.competitionData = services.parseCompetitionDataFromLuyKe(text); 
        
        const data = appState.competitionData.map(item => {
            const hoanThanhValue = (parseFloat(String(item.hoanThanh).replace('%', '')) || 0); 
            return { ...item, hoanThanhValue: hoanThanhValue }; 
        });

        if (data.length === 0) {
            container.innerHTML = '<p class="text-yellow-600 font-bold col-span-2">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu thi ƒëua trong vƒÉn b·∫£n ƒë√£ d√°n.</p>'; 
            return;
        }
        
        const summaryEl = document.getElementById('luyke-competition-summary'); 
        if (summaryEl) {
             summaryEl.innerHTML = uiLuyke.renderCompetitionSummaryCounter(data); 
        }
        
        container.innerHTML = uiLuyke.renderLuykeCompetitionInfographic(data, viewType); 
    },
    
    renderLuykeCompetitionInfographic(data, viewType) {
        
        const sortData = (items) => {
            return [...items].sort((a, b) => b.hoanThanhValue - a.hoanThanhValue); 
        };

        const renderRow = (items, title, titleClass) => {
            if (items.length === 0) return ''; 
    
            const today = new Date(); 
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate(); 
            const daysRemaining = Math.max(daysInMonth - today.getDate(), 1); 
            
            const sortedItems = sortData(items); 

            const achievedCount = items.filter(item => item.hoanThanhValue >= 100).length; 
            const unachievedCount = items.length - achievedCount; 
            
            const achievedHtml = `<strong class="text-blue-600">${achievedCount}</strong>`; 
            const unachievedHtml = `<strong class="text-red-600">${unachievedCount}</strong>`; 
            const counterText = `<span class="text-sm font-normal text-gray-700">(ƒê·∫°t: ${achievedHtml} / C·∫ßn n·ªó l·ª±c: ${unachievedHtml})</span>`; 
    
            const itemsHtml = sortedItems.map(item => {
                const hoanThanhValue = item.hoanThanhValue; 
                
                let dailyTarget = 0; 
                const targetRemaining = item.target - item.luyKe; 
                
                if (item.target > 0 && targetRemaining > 0 && daysRemaining > 0) {
                     dailyTarget = targetRemaining / daysRemaining; 
                }
                
                const targetClass = dailyTarget > 0 ? 'text-red-600' : 'text-green-600'; 
    
                return `
                    <div class="tdv-item-card">
                         <p class="tdv-item-card__title">${item.name}</p> 
                        <div class="tdv-progress-bar-container">
                            <div class="tdv-progress-bar ${hoanThanhValue >= 100 ? 'tdv-progress-bar--blue' : 'tdv-progress-bar--yellow'}" style="width: ${Math.min(hoanThanhValue, 100)}%;"></div> 
                             <span class="tdv-progress-bar__text">${uiComponents.formatPercentage(hoanThanhValue / 100)}</span> 
                        </div>
                        <div class="tdv-item-card__details">
                            <span>L≈©y k·∫ø: <strong>${uiComponents.formatNumberOrDash(item.luyKe)}</strong></span> 
                            <span>Target: <strong>${uiComponents.formatNumberOrDash(item.target)}</strong></span> 
                             <span class="font-bold ${targetClass}">M·ª•c ti√™u/ng√†y: <strong>${uiComponents.formatNumberOrDash(dailyTarget)}</strong></span> 
                        </div>
                    </div>
                `; 
            }).join('');
    
            return `
                <div class="tdv-row" data-capture-group="comp-row-${title.replace(/\s/g, '-')}" data-capture-columns="2">
                     <h3 class="tdv-row-title ${titleClass}">${title} ${counterText}</h3>
                    <div class="tdv-row-body grid grid-cols-2 gap-4">${itemsHtml}</div>
                </div>
            `; 
        };
    
        if (viewType === 'summary') {
            const dataDoanhThu = data.filter(d => d.type === 'doanhThu'); 
            const dataSoLuong = data.filter(d => d.type === 'soLuong'); 
            return `
                <div class="tdv-rows-container space-y-6">
                    ${renderRow(dataDoanhThu, 'Thi ƒêua Doanh Thu', 'tdv-row-title--prize')} 
                    ${renderRow(dataSoLuong, 'Thi ƒêua S·ªë L∆∞·ª£ng', 'tdv-row-title--soon-prize')} 
                </div>
            `;
        } else {
             const completed = data.filter(d => d.hoanThanhValue >= 100); 
            const pending = data.filter(d => d.hoanThanhValue < 100); 
            return `
                <div class="tdv-rows-container space-y-6">
                    ${renderRow(completed, 'C√°c Ch∆∞∆°ng Tr√¨nh ƒê√£ ƒê·∫°t M·ª•c Ti√™u', 'tdv-row-title--prize')} 
                    ${renderRow(pending, 'C√°c Ch∆∞∆°ng Tr√¨nh C·∫ßn N·ªó L·ª±c Th√™m', 'tdv-row-title--effort')} 
                </div>
             `;
        }
    },
    
    renderChuaXuatTable: (reportData) => {
        // === START: D·ªçn d·∫πp State (Task 3 & 4) ===
        appState.currentEmployeeDetailData = null; 
        // === END: D·ªçn d·∫πp State ===
        const container = document.getElementById('luyke-unexported-revenue-content'); 
        if (!container) return; 
        if (!reportData || reportData.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center font-bold">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ch∆∞a xu·∫•t.</p>'; 
            return;
        }

        const sortState = appState.sortState.luyke_chuaxuat || { key: 'doanhThuQuyDoi', direction: 'desc' }; 
        const { key, direction } = sortState; 
        const sortedData = [...reportData].sort((a, b) => { 
             const valA = a[key] || 0; const valB = b[key] || 0; 
            return direction === 'asc' ? valA - valB : valB - valA; 
        });

        const totals = reportData.reduce((acc, item) => {
            acc.soLuong += item.soLuong; 
            acc.doanhThuThuc += item.doanhThuThuc; 
            acc.doanhThuQuyDoi += item.doanhThuQuyDoi; 
            return acc; 
        }, { soLuong: 0, doanhThuThuc: 0, doanhThuQuyDoi: 0 }); 

        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`; 
        
        container.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full text-sm table-bordered table-striped" data-table-type="luyke_chuaxuat">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold"><tr>
                <th class="${headerClass('nganhHang')}" data-sort="nganhHang">Ng√†nh h√†ng</th>
                <th class="${headerClass('soLuong')} text-right" data-sort="soLuong">S·ªë l∆∞·ª£ng</th>
                <th class="${headerClass('doanhThuThuc')} text-right" data-sort="doanhThuThuc">Doanh thu th·ª±c</th>
                 <th class="${headerClass('doanhThuQuyDoi')} text-right" data-sort="doanhThuQuyDoi">Doanh thu Qƒê</th></tr>
            </thead>
            <tbody>${sortedData.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-semibold">${item.nganhHang}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumber(item.soLuong)}</td>
                     <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.doanhThuThuc)}</td> 
                    <td class="px-4 py-2 text-right font-bold text-blue-600">${uiComponents.formatRevenue(item.doanhThuQuyDoi)}</td> 
                </tr>`).join('')}
            </tbody>
            <tfoot class="table-footer font-bold"><tr>
                <td class="px-4 py-2">T·ªïng</td>
                 <td class="px-4 py-2 text-right">${uiComponents.formatNumber(totals.soLuong)}</td>
                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.doanhThuThuc)}</td> 
                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.doanhThuQuyDoi)}</td> 
            </tr></tfoot></table></div>`;
    },

    // === START: MODIFIED FUNCTION (v2.13) ===
    renderLuykeKpiCards: (luykeData, comparisonData, luotKhachData, masterReportDataLuyke, goals, competitionSummary) => {
        // === START: D·ªçn d·∫πp State (Task 3 & 4) ===
        appState.currentEmployeeDetailData = null; 
        // === END: D·ªçn d·∫πp State ===
        const { dtThucLK, dtQdLK, dtGop, phanTramQd, phanTramGop, phanTramTargetThuc, phanTramTargetQd, dtThucDuKien, dtQdDuKien } = luykeData; 

        document.getElementById('luyke-kpi-dt-thuc-main').textContent = uiComponents.formatNumber((dtThucLK || 0) / 1000000, 0); 
        document.getElementById('luyke-kpi-dt-thuc-sub1').innerHTML = `DK: <span class="font-bold">${uiComponents.formatNumber((dtThucDuKien || 0) / 1000000, 0)}</span> / Target: <span class="font-bold">${uiComponents.formatNumber(goals?.doanhThuThuc || 0)}</span>`; 

        document.getElementById('luyke-kpi-dt-qd-main').textContent = uiComponents.formatNumber((dtQdLK || 0) / 1000000, 0); 
        document.getElementById('luyke-kpi-dt-qd-sub1').innerHTML = `DK: <span class="font-bold">${uiComponents.formatNumber((dtQdDuKien || 0) / 1000000, 0)}</span> / Target: <span class="font-bold">${uiComponents.formatNumber(goals?.doanhThuQD || 0)}</span>`; 
        
        document.getElementById('luyke-kpi-ht-target-qd-main').textContent = uiComponents.formatPercentage(phanTramTargetQd || 0); 
        document.getElementById('luyke-kpi-ht-target-thuc-sub').innerHTML = `DT Th·ª±c: <span class="font-bold">${uiComponents.formatPercentage(phanTramTargetThuc || 0)}</span>`; 

        document.getElementById('luyke-kpi-tl-qd-main').textContent = uiComponents.formatPercentage(phanTramQd || 0); 
        document.getElementById('luyke-kpi-tl-qd-sub').innerHTML = `M·ª•c ti√™u: <span class="font-bold">${uiComponents.formatNumber(goals?.phanTramQD || 0)}%</span>`; 
        document.getElementById('luyke-kpi-dt-tc-main').textContent = uiComponents.formatNumber((dtGop || 0) / 1000000, 0); 
        document.getElementById('luyke-kpi-dt-tc-sub').innerHTML = `% th·ª±c tr·∫£ ch·∫≠m: <span class="font-bold">${uiComponents.formatPercentage(phanTramGop || 0)}</span>`; 
        
        const chuaXuatQuyDoi = masterReportDataLuyke.reduce((sum, item) => sum + (item.doanhThuQuyDoiChuaXuat || 0), 0); 
        
        // (Task 4) Th√™m ID v√† class v√†o th·∫ª DT Ch∆∞a Xu·∫•t
        const dtqdChuaXuatCard = document.getElementById('luyke-kpi-dtqd-chua-xuat-main')?.closest('.kpi-card'); 
        if (dtqdChuaXuatCard) {
            dtqdChuaXuatCard.id = 'lk-summary-unexported-trigger'; 
            dtqdChuaXuatCard.classList.add('cursor-pointer', 'hover:shadow-xl'); 
        }
        document.getElementById('luyke-kpi-dtqd-chua-xuat-main').textContent = uiComponents.formatNumber(chuaXuatQuyDoi / 1000000, 0); 
        
        const tyLeThiDuaDat = competitionSummary.total > 0 ? competitionSummary.dat / competitionSummary.total : 0; 
        document.getElementById('luyke-kpi-thidua-main').textContent = uiComponents.formatPercentage(tyLeThiDuaDat); 
        document.getElementById('luyke-kpi-thidua-sub').innerHTML = `<span class="font-bold">${competitionSummary.dat}/${competitionSummary.total}</span> Ng√†nh`; 

        const formatComparisonPercentage = (percentageString) => {
            if (!percentageString || typeof percentageString !== 'string') return 'N/A'; 
            const numericValue = parseFloat(percentageString.replace('%', '')); 
            if (isNaN(numericValue)) return 'N/A'; 
            return Math.round(numericValue) + '%'; 
        };
        const formattedDtPercentage = formatComparisonPercentage(comparisonData.percentage); 
        const formattedLkPercentage = formatComparisonPercentage(luotKhachData.percentage); 

        document.getElementById('luyke-kpi-dtck-main').textContent = formattedDtPercentage; 
        document.getElementById('luyke-kpi-dtck-sub').innerHTML = `Doanh thu: <span class="font-bold">${uiComponents.formatNumber(comparisonData.value || 0)} | ${formattedDtPercentage}</span>`; 
        document.getElementById('luyke-kpi-lkck-sub').innerHTML = `L∆∞·ª£t kh√°ch: <span class="font-bold">${uiComponents.formatNumber(luotKhachData.value || 0)} | ${formattedLkPercentage}</span>`; 
    },
    // === END: MODIFIED FUNCTION ===

    renderLuykeCategoryDetailsTable: (data, numDays) => {
        // === START: D·ªçn d·∫πp State (Task 3 & 4) ===
        appState.currentEmployeeDetailData = null; 
        // === END: D·ªçn d·∫πp State ===
        const container = document.getElementById('luyke-category-details-content'); 
        const cardHeader = container.previousElementSibling; 
        if (!container || !cardHeader || !data || !data.nganhHangChiTiet) { container.innerHTML = '<p class="text-gray-500 font-bold">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>'; return; } 
        
        const allItems = Object.keys(data.nganhHangChiTiet).sort(); 
        const visibleItems = settingsService.loadCategoryViewSettings(allItems); 
        
        if (Object.keys(data.nganhHangChiTiet).length === 0) {
            container.innerHTML = '<p class="text-gray-500 font-bold">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>'; return; 
        }

        const sortState = appState.sortState.luyke_nganhhang || { key: 'revenue', direction: 'desc' }; 
        const { key, direction } = sortState; 
        const sortedData = Object.entries(data.nganhHangChiTiet)
            .map(([name, values]) => ({ name, ...values })) 
            .filter(item => visibleItems.includes(item.name)) 
            .sort((a, b) => direction === 'asc' ? a[key] - b[key] : b[key] - a[key]); 

        const totals = sortedData.reduce((acc, item) => {
            acc.quantity += item.quantity; 
            acc.revenue += item.revenue; 
            return acc; 
        }, { quantity: 0, revenue: 0 }); 

        if (!cardHeader.querySelector('.settings-trigger-btn')) {
            cardHeader.classList.add('flex', 'items-center', 'justify-between'); 
            cardHeader.innerHTML = `<span>NG√ÄNH H√ÄNG CHI TI·∫æT</span>` + uiComponents.renderSettingsButton('lk-cat'); 
            setTimeout(() => {
                document.getElementById('settings-btn-lk-cat').addEventListener('click', () => { 
                    uiLuyke._showCategorySettingsModal(data); 
                });
            }, 0);
        }

        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`; 
        container.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full text-sm table-bordered table-striped" data-table-type="luyke_nganhhang">
             <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold"><tr>
                <th class="${headerClass('name')}" data-sort="name">Ng√†nh h√†ng</th>
                <th class="${headerClass('quantity')} text-right" data-sort="quantity">S·ªë l∆∞·ª£ng</th>
                <th class="${headerClass('revenue')} text-right" data-sort="revenue">Doanh thu</th>
                <th class="${headerClass('avgQuantity')} text-right" data-sort="avgQuantity">SL TB/ng√†y</th>
                <th class="${headerClass('avgPrice')} text-right" data-sort="avgPrice">ƒê∆°n gi√° TB</th></tr>
             </thead>
            <tbody>${sortedData.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-semibold">${item.name}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumber(item.quantity)}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.revenue)}</td> 
                     <td class="px-4 py-2 text-right font-bold text-blue-600">${uiComponents.formatNumberOrDash(item.quantity / numDays, 1)}</td> 
                    <td class="px-4 py-2 text-right font-bold text-green-600">${uiComponents.formatRevenue(item.donGia)}</td> 
                </tr>`).join('')}
            </tbody>
            <tfoot class="table-footer font-bold"><tr>
                <td class="px-4 py-2">T·ªïng</td>
                 <td class="px-4 py-2 text-right">${uiComponents.formatNumber(totals.quantity)}</td> 
                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.revenue)}</td> 
                <td colspan="2"></td>
            </tr></tfoot></table></div>`;
    },

    renderLuykeQdcTable: (data, numDays) => {
        // === START: D·ªçn d·∫πp State (Task 3 & 4) ===
        appState.currentEmployeeDetailData = null; 
        // === END: D·ªçn d·∫πp State ===
        const container = document.getElementById('luyke-qdc-content'); 
        const cardHeader = container.previousElementSibling; 
        if (!container || !cardHeader || !data || !data.qdc) { container.innerHTML = `<p class="text-gray-500 font-bold">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>`; return; } 
        
        const qdcData = Object.entries(data.qdc).map(([key, value]) => ({ id: key, ...value })); 
        const allItems = qdcData.map(item => item.name); 
        const visibleItems = settingsService.loadQdcViewSettings(allItems); 

        const sortState = appState.sortState.luyke_qdc || { key: 'dtqd', direction: 'desc' }; 
        const { key, direction } = sortState; 
        const sortedData = [...qdcData]
            .filter(item => visibleItems.includes(item.name)) 
            .sort((a,b) => direction === 'asc' ? a[key] - b[key] : b[key] - a[key]); 
        
        if (!cardHeader.querySelector('.settings-trigger-btn')) {
             cardHeader.classList.add('flex', 'items-center', 'justify-between'); 
            cardHeader.innerHTML = `<span>NH√ìM H√ÄNG QUY ƒê·ªîI CAO</span>` + uiComponents.renderSettingsButton('lk-qdc'); 
            setTimeout(() => {
                 document.getElementById('settings-btn-lk-qdc').addEventListener('click', () => { 
                    uiLuyke._showQdcSettingsModal(data); 
                });
            }, 0);
        }

        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`; 

        container.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full text-sm table-bordered table-striped" data-table-type="luyke_qdc">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold"><tr>
                <th class="${headerClass('name')}" data-sort="name">Nh√≥m h√†ng</th>
                <th class="${headerClass('sl')} text-right" data-sort="sl">SL</th>
                <th class="${headerClass('dtqd')} text-right" data-sort="dtqd">DTQƒê</th>
                <th class="${headerClass('avgSl')} text-right" data-sort="avgSl">SL TB/Ng√†y</th></tr>
            </thead>
            <tbody>${sortedData.map(item => `
                 <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-semibold">${item.name}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumber(item.sl)}</td> 
                    <td class="px-4 py-2 text-right font-bold text-blue-600">${uiComponents.formatRevenue(item.dtqd)}</td> 
                    <td class="px-4 py-2 text-right font-bold text-green-600">${uiComponents.formatNumber(item.sl / numDays, 1)}</td></tr>` 
                 ).join('')}
            </tbody></table></div>`;
    },
    
    renderLuykeEfficiencyTable: (data, goals) => {
        // === START: D·ªçn d·∫πp State (Task 3 & 4) ===
        appState.currentEmployeeDetailData = null; 
        // === END: D·ªçn d·∫πp State ===
        const container = document.getElementById('luyke-efficiency-content'); 
        const cardHeader = container.previousElementSibling; 

        if (!container || !cardHeader || !data || !goals) { 
            if(container) container.innerHTML = `<p class="text-gray-500 font-bold">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>`; 
            return; 
        }
        
        const allItemsConfig = settingsService.loadEfficiencyViewSettings(); 
        
        const goalKeyMap = {
            pctPhuKien: 'phanTramPhuKien', 
            pctGiaDung: 'phanTramGiaDung', 
            pctMLN: 'phanTramMLN', 
            pctSim: 'phanTramSim', 
            pctVAS: 'phanTramVAS', 
            pctBaoHiem: 'phanTramBaoHiem' 
        };

        const allItems = allItemsConfig
            .filter(item => item.id.startsWith('pct')) 
            .map(config => ({
                ...config, 
                value: data[config.id], 
                target: goals[goalKeyMap[config.id]] 
            }));
        
        // === START: THAY ƒê·ªîI ===
        // 1. Th√™m data-table-type
        // 2. Th√™m logic sortState
        // 3. Th√™m h√†m headerClass
        // 4. Th√™m class/data-sort v√†o <th>
        // 5. S·∫Øp x·∫øp allItems
        
        const sortStateKey = 'luyke_efficiency';
        const sortState = appState.sortState[sortStateKey] || { key: 'label', direction: 'asc' };
        const { key, direction } = sortState;
        
        // S·∫Øp x·∫øp d·ªØ li·ªáu
        const sortedItems = [...allItems].sort((a, b) => {
            let valA, valB;
            
            if (key === 'label') {
                valA = a.label || '';
                valB = b.label || '';
                return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            } else if (key === 'value') {
                valA = a.value || 0;
                valB = b.value || 0;
            } else { // key === 'target'
                valA = (a.target || 0) / 100;
                valB = (b.target || 0) / 100;
            }
            
            return direction === 'asc' ? valA - valB : valB - valA;
        });
        
        const createRow = (label, value, target) => {
            const isBelow = value < ((target || 0) / 100); 
            
            return `<tr class="border-t">
                <td class="px-4 py-2 font-semibold text-gray-800">${label}</td>
                <td class="px-4 py-2 text-right font-bold text-lg ${isBelow ? 'cell-performance is-below' : 'text-green-600'}">${uiComponents.formatPercentage(value || 0)}</td> 
                <td class="px-4 py-2 text-right text-gray-600">${target || 0}%</td> 
            </tr>`;
        };
        
        if (!cardHeader.querySelector('.settings-trigger-btn')) {
            cardHeader.classList.add('flex', 'items-center', 'justify-between'); 
            cardHeader.innerHTML = `<span>HI·ªÜU QU·∫¢ KHAI TH√ÅC SI√äU TH·ªä</span>` + uiComponents.renderSettingsButton('lk-eff'); 
            
            setTimeout(() => {
                document.getElementById('settings-btn-lk-eff').addEventListener('click', () => { 
                     uiLuyke._showEfficiencySettingsModal(); 
                });
            }, 0);
        }
        
        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`; 
        
        container.innerHTML = `
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm table-bordered" data-table-type="${sortStateKey}">
                    <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold"> 
                        <tr>
                             <th class="${headerClass('label')} text-left" data-sort="label">Ch·ªâ s·ªë <span class="sort-indicator"></span></th>
                            <th class="${headerClass('value')} text-right" data-sort="value">Th·ª±c hi·ªán <span class="sort-indicator"></span></th>
                             <th class="${headerClass('target')} text-right" data-sort="target">M·ª•c ti√™u <span class="sort-indicator"></span></th> 
                        </tr>
                     </thead>
                    <tbody>
                        ${sortedItems // D√πng sortedItems
                             .filter(item => item.visible) // L·ªçc theo c√†i ƒë·∫∑t hi·ªÉn th·ªã 
                            .map(item => createRow(item.label, item.value, item.target)) 
                            .join('')}
                    </tbody>
                </table>
             </div>`; 
        // === END: THAY ƒê·ªîI ===
    },

    updateLuykeSupermarketTitle: (warehouse, date) => {
        // === START: D·ªçn d·∫πp State (Task 3 & 4) ===
        appState.currentEmployeeDetailData = null; 
        // === END: D·ªçn d·∫πp State ===
        const titleEl = document.getElementById('luyke-supermarket-title'); 
        if (titleEl) titleEl.textContent = `B√°o c√°o l≈©y k·∫ø ${warehouse ? 'kho ' + warehouse : 'to√†n b·ªô'} - T√≠nh ƒë·∫øn ${date.toLocaleDateString('vi-VN')}`; 
    },
};
--- END FILE: ./ui-luyke.js ---

--- START FILE: ./ui-modal-manager.js ---
// Version 1.0 - Initial extraction from ui-components
// MODULE: UI MODAL MANAGER
// Ch·ª©a c√°c h√†m thu·∫ßn t√∫y ƒë·ªÉ qu·∫£n l√Ω tr·∫°ng th√°i hi·ªÉn th·ªã c·ªßa Modals v√† Drawers.

export const modalManager = {
    /**
     * B·∫≠t ho·∫∑c t·∫Øt m·ªôt modal.
     * @param {string} modalId - ID c·ªßa modal (v√≠ d·ª•: 'login-modal').
     * @param {boolean} show - True ƒë·ªÉ hi·ªán, false ƒë·ªÉ ·∫©n.
     */
    toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        modal.classList.toggle('hidden', !show);
    },

    /**
     * B·∫≠t ho·∫∑c t·∫Øt m·ªôt drawer (thanh c√†i ƒë·∫∑t b√™n).
     * @param {string} drawerId - ID c·ªßa drawer (v√≠ d·ª•: 'interface-drawer').
     * @param {boolean} show - True ƒë·ªÉ hi·ªán, false ƒë·ªÉ ·∫©n.
     */
    toggleDrawer(drawerId, show) {
        const drawer = document.getElementById(drawerId);
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('drawer-overlay');

        if (!drawer || !sidebar || !overlay) return;
        if (show) {
            drawer.classList.remove('hidden');
            setTimeout(() => {
                 drawer.classList.add('open');
                 sidebar.classList.add('menu-locked');
                 overlay.classList.remove('hidden');
            }, 10);
        } else {
            drawer.classList.remove('open');
            sidebar.classList.remove('menu-locked');
            overlay.classList.add('hidden');
            setTimeout(() => {
                 if (!drawer.classList.contains('open')) {
                     drawer.classList.add('hidden');
                 }
             }, 300);
        }
    },

    /**
     * ƒê√≥ng t·∫•t c·∫£ c√°c drawer ƒëang m·ªü.
     */
    closeAllDrawers() {
        // Ch√∫ng ta g·ªçi h√†m `toggleDrawer` n·ªôi b·ªô
        this.toggleDrawer('interface-drawer', false);
        this.toggleDrawer('goal-drawer', false);
    },
};
--- END FILE: ./ui-modal-manager.js ---

--- START FILE: ./ui-notifications.js ---
// Version 1.0 - Initial extraction from ui-components
// MODULE: UI NOTIFICATIONS
// Ch·ª©a c√°c h√†m hi·ªÉn th·ªã th√¥ng b√°o, pop-up v√† c·∫≠p nh·∫≠t b·ªô ƒë·∫øm.

import { formatters } from './ui-formatters.js';

export const notifications = {
    /**
     * Hi·ªÉn th·ªã m·ªôt th√¥ng b√°o pop-up ng·∫Øn.
     * @param {string} message - N·ªôi dung th√¥ng b√°o.
     * @param {string} type - 'success' ho·∫∑c 'error'.
     */
    showNotification: (message, type = 'success') => {
        const notification = document.getElementById('notification');
        if (!notification) return;
        notification.textContent = message;
        notification.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-md text-white z-[1200] opacity-0 transition-opacity duration-500 transform translate-y-10 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
        void notification.offsetWidth;
        notification.classList.remove('hidden', 'opacity-0', 'translate-y-10');
        notification.classList.add('opacity-100', 'translate-y-0');

        setTimeout(() => {
             notification.classList.remove('opacity-100', 'translate-y-0');
             notification.classList.add('opacity-0', 'translate-y-10');
             setTimeout(() => notification.classList.add('hidden'), 500);
        }, 3000);
    },

    /**
     * Hi·ªÉn th·ªã th√¥ng b√°o c·∫≠p nh·∫≠t phi√™n b·∫£n (n·∫øu c√≥).
     */
    showUpdateNotification() {
        const notification = document.getElementById('update-notification');
        if (notification) {
             notification.classList.remove('hidden');
             const button = notification.querySelector('button');
             if (button && !button.onclick) {
                button.onclick = () => window.location.reload();
             }
         }
    },

    /**
     * C·∫≠p nh·∫≠t c√°c ƒë·ªìng h·ªì ƒë·∫øm tr√™n trang ch·ªß.
     * @param {object} statsData - D·ªØ li·ªáu t·ª´ 'analytics/site_stats'.
     */
     updateUsageCounter: (statsData) => {
        const visitorCountEl = document.getElementById('visitor-count');
         const actionCountEl = document.getElementById('action-count');
         const userCountEl = document.getElementById('user-count');
         // S·ª≠ d·ª•ng formatters tr·ª±c ti·∫øp
         if (visitorCountEl) visitorCountEl.textContent = statsData?.pageLoads ? formatters.formatNumber(statsData.pageLoads) : '0';
         if (actionCountEl) actionCountEl.textContent = statsData?.actionsTaken ? formatters.formatNumber(statsData.actionsTaken) : '0';
         if (userCountEl) userCountEl.textContent = statsData?.totalUsers ? formatters.formatNumber(statsData.totalUsers) : '0';
     },
};
--- END FILE: ./ui-notifications.js ---

--- START FILE: ./ui-realtime.js ---
// Version 4.9 - Refactor: G·ª° b·ªè grid wrapper l·ªìng nhau, g·ªôp 2 b√°o c√°o v√†o 1 grid
// Version 4.6 - Add sorting to Efficiency and Category tables
// Version 4.5 - Refactor: Use ui facade instead of direct uiComponents/uiCompetition import (fixes crash)
// Version 4.4 - Refactor: Update report function calls from uiComponents to ui
// Version 4.3 - Fix 'this' context bug for modal popups
// MODULE: UI REALTIME
// Ch·ª©a TO√ÄN B·ªò logic v√† h√†m render giao di·ªán cho tab "Doanh thu Realtime".

import { appState } from './state.js';
import { ui } from './ui.js'; // V·∫´n c·∫ßn import ui ch√≠nh ƒë·ªÉ d√πng c√°c h√†m common
import { services } from './services.js';
import { settingsService } from './modules/settings.service.js';
import { highlightService } from './modules/highlight.service.js';
import { dragDroplisteners } from './event-listeners/listeners-dragdrop.js';
// <<< ƒê√É X√ìA (v4.5) >>> import { uiComponents } from './ui-components.js';
import { utils } from './utils.js'; // Import utils
// <<< ƒê√É X√ìA (v4.5) >>> import { uiCompetition } from './ui-competition.js';

export const uiRealtime = {
    render() {
        console.log("[CH·∫®N ƒêO√ÅN] B·∫Øt ƒë·∫ßu render() trong 'ui-realtime.js' (ƒë√£ g·ªôp)."); //

        if (appState.danhSachNhanVien.length === 0) {
            ui.togglePlaceholder('realtime-section', true); // <<< S·ª¨A (v4.5)
            return; //
        }
        ui.togglePlaceholder('realtime-section', false); // <<< S·ª¨A (v4.5)

        const selectedWarehouse = document.getElementById('realtime-filter-warehouse')?.value || ''; // Th√™m ? v√† || ''
        this.updateRealtimeSupermarketTitle(selectedWarehouse, new Date()); //

        const activeSubTabBtn = document.querySelector('#realtime-subtabs-nav .sub-tab-btn.active'); //
        const activeSubTabId = activeSubTabBtn ? activeSubTabBtn.dataset.target : 'subtab-realtime-sieu-thi'; //

        if (appState.realtimeYCXData.length === 0) {
                this.renderRealtimeKpiCards({}, { goals: {}, timing: {} }); //
                const catDetailEl = document.getElementById('realtime-category-details-content');
                if(catDetailEl) catDetailEl.innerHTML = '<p class="text-gray-500 font-bold">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p>'; //
                const efficiencyEl = document.getElementById('realtime-efficiency-content');
                if(efficiencyEl) efficiencyEl.innerHTML = '<p class="text-gray-500 font-bold">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p>'; //
                const qdcEl = document.getElementById('realtime-qdc-content');
                if(qdcEl) qdcEl.innerHTML = '<p class="text-gray-500 font-bold">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p>'; //
                const unexportedEl = document.getElementById('realtime-unexported-revenue-content');
                if(unexportedEl) unexportedEl.innerHTML = '<p class="text-gray-500 font-bold">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p>'; //
                const revenueReportEl = document.getElementById('realtime-revenue-report-container');
                if(revenueReportEl) revenueReportEl.innerHTML = ''; //
                const employeeDetailEl = document.getElementById('realtime-employee-detail-container');
                if(employeeDetailEl) employeeDetailEl.innerHTML = ''; //
                const brandReportEl = document.getElementById('realtime-brand-report-container');
                if(brandReportEl) brandReportEl.innerHTML = '<p class="text-gray-500">Vui l√≤ng t·∫£i file realtime v√† ch·ªçn b·ªô l·ªçc ƒë·ªÉ xem d·ªØ li·ªáu.</p>'; //
                const competitionRtEl = document.getElementById('competition-report-container-rt');
                if(competitionRtEl) competitionRtEl.innerHTML = '<p class="text-gray-500">Vui l√≤ng t·∫£i file realtime ƒë·ªÉ xem chi ti·∫øt.</p>'; //
            return; //
        };

        const deptEl = document.getElementById('realtime-filter-department');
        const selectedDept = deptEl ? deptEl.value : ''; //
        const selectedEmployees = appState.choices.realtime_employee ? appState.choices.realtime_employee.getValue(true) : []; //

        const settings = settingsService.getRealtimeGoalSettings(selectedWarehouse); //

        appState.masterReportData.realtime = services.generateMasterReportData(appState.realtimeYCXData, settings.goals, true); //

        let filteredReport = appState.masterReportData.realtime; //
        if (selectedWarehouse) filteredReport = filteredReport.filter(nv => nv.maKho == selectedWarehouse); //
        if (selectedDept) filteredReport = filteredReport.filter(nv => nv.boPhan === selectedDept); //
        if (selectedEmployees && selectedEmployees.length > 0) filteredReport = filteredReport.filter(nv => selectedEmployees.includes(String(nv.maNV))); //

        const visibleEmployees = new Set(filteredReport.map(nv => String(nv.maNV))); //
        const filteredRealtimeYCX = appState.realtimeYCXData.filter(row => { //
            const msnvMatch = String(row.nguoiTao || '').match(/(\d+)/); //
            return msnvMatch && visibleEmployees.has(msnvMatch[1].trim()); //
        });

        const detailInfo = appState.viewingDetailFor; //
        const isViewingDetail = detailInfo && detailInfo.sourceTab === 'dtnv-rt'; //
        if (activeSubTabId === 'subtab-realtime-nhan-vien') { //
            if (isViewingDetail) {
                this.handleEmployeeDetailChange(detailInfo.employeeId); //
            } else {
                // === S·ª¨A L·ªñI 1/3: G·ªçi t·ª´ `ui` thay v√¨ `uiComponents` ===
                ui.displayEmployeeRevenueReport(filteredReport, 'realtime-revenue-report-container', 'realtime_dt_nhanvien'); //
                this.handleEmployeeDetailChange(null); //
            }
        }

        const supermarketReport = services.aggregateReport(filteredReport, selectedWarehouse); //
        this.renderRealtimeKpiCards(supermarketReport, settings); //
        this.renderRealtimeCategoryDetailsTable(supermarketReport); //
        this.renderRealtimeEfficiencyTable(supermarketReport, settings.goals); //
        this.renderRealtimeQdcTable(supermarketReport); //
        const realtimeChuaXuatReport = services.generateRealtimeChuaXuatReport(filteredRealtimeYCX); //
        this.renderRealtimeChuaXuatTable(realtimeChuaXuatReport); //
        
        // === S·ª¨A L·ªñI 2/3: G·ªçi t·ª´ `ui` thay v√¨ `uiComponents` ===
        ui.displayEmployeeEfficiencyReport(filteredReport, 'realtime-efficiency-report-container', 'realtime_hieuqua_nhanvien'); //
        
        // === S·ª¨A L·ªñI 3/3: G·ªçi t·ª´ `ui` thay v√¨ `uiComponents` ===
        ui.displayCategoryRevenueReport(filteredReport, 'realtime-category-revenue-report-container', 'realtime'); //
        
        this.handleBrandFilterChange(); //

        // === START: THAY ƒê·ªîI V4.8 (G·ª° b·ªè wrapper, g·ªôp HTML) ===
        if (activeSubTabId === 'subtab-hieu-qua-thi-dua-realtime') {
            console.log("[ui-realtime.js render] Rendering 'Thi ƒëua NV Realtime' subtab...");
            const mainContainer = document.getElementById('competition-report-container-rt');
            if (!mainContainer) {
                console.error("[ui-realtime.js render] L·ªói: Kh√¥ng t√¨m th·∫•y #competition-report-container-rt");
                return;
            }

            // 1. T√≠nh to√°n B√°o c√°o SPƒêQ
            console.log("[ui-realtime.js render] Calculating 'Special Product' report...");
            const specialReportData = services.calculateSpecialProductReport(
                appState.realtimeYCXData, // S·ª≠ d·ª•ng full data realtime
                appState.globalSpecialPrograms
            );
            // Render SPƒêQ (H√†m n√†y tr·∫£ v·ªÅ chu·ªói HTML)
            const specialReportHtml = ui.renderSpecialProgramReport(null, specialReportData); //
            if (specialReportData.length > 0) {
                console.log("D·ªØ li·ªáu SPƒêQ (Realtime) ƒë√£ t√≠nh to√°n:", specialReportData);
            }

            // 2. T√≠nh to√°n B√°o c√°o Thi ƒëua T√πy ch·ªânh
            const allConfigs = [ ...appState.globalCompetitionConfigs, ...appState.localCompetitionConfigs ];
            const competitionReportData = services.calculateCompetitionFocusReport( 
                appState.realtimeYCXData,
                allConfigs // Truy·ªÅn danh s√°ch ƒë√£ g·ªôp
            );
            // Render Thi ƒëua T√πy ch·ªânh (H√†m n√†y render v√†o DOM, nh∆∞ng ch√∫ng ta s·∫Ω s·ª≠a n√≥)
            // T·∫°m th·ªùi, ch√∫ng ta t·∫°o 1 container ·∫£o ƒë·ªÉ l·∫•y HTML
            const tempCompetitionDiv = document.createElement('div');
            ui.renderCompetitionUI(tempCompetitionDiv, competitionReportData); //
            const competitionReportHtml = tempCompetitionDiv.innerHTML;

            // 3. G·ªôp HTML v√† ch√®n v√†o DOM
            // B·ªçc c·∫£ hai chu·ªói HTML trong m·ªôt grid 2 c·ªôt duy nh·∫•t
            mainContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${specialReportHtml}
                    ${competitionReportHtml}
                </div>
            `;
        }
        // === END: THAY ƒê·ªîI V4.8 ===

        highlightService.populateHighlightFilters('realtime', filteredRealtimeYCX, filteredReport); //
        highlightService.applyHighlights('realtime'); //

        if (!isViewingDetail) {
            const efficiencyReportContainer = document.getElementById('realtime-efficiency-report-container'); //
            if (efficiencyReportContainer) {
                dragDroplisteners.initializeForContainer('realtime-efficiency-report-container'); //
            }
        }
    },

    // *** START: H√ÄM B·ªä THI·∫æU ƒê√É ƒê∆Ø·ª¢C TH√äM ***
    populateRealtimeBrandCategoryFilter() {
        const categoryFilter = document.getElementById('realtime-brand-category-filter');
        if (!categoryFilter) return;

        // L·∫•y danh s√°ch ng√†nh h√†ng duy nh·∫•t t·ª´ d·ªØ li·ªáu realtime ƒë√£ t·∫£i
        const categories = [...new Set(appState.realtimeYCXData
            .map(row => utils.cleanCategoryName(row.nganhHang)) // Chu·∫©n h√≥a t√™n ng√†nh h√†ng
            .filter(Boolean)) // Lo·∫°i b·ªè c√°c gi√° tr·ªã r·ªóng/null
        ].sort(); // S·∫Øp x·∫øp theo alphabet

        // T·∫°o HTML cho c√°c options
        let html = '<option value="">T·∫•t c·∫£ ng√†nh h√†ng</option>'; // Option m·∫∑c ƒë·ªãnh
        html += categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');

        // C·∫≠p nh·∫≠t n·ªôi dung c·ªßa select box
        categoryFilter.innerHTML = html;
        categoryFilter.value = ''; // Reset v·ªÅ gi√° tr·ªã m·∫∑c ƒë·ªãnh

        // Sau khi c·∫≠p nh·∫≠t category, g·ªçi h√†m c·∫≠p nh·∫≠t brand ƒë·ªÉ ƒë·∫£m b·∫£o danh s√°ch h√£ng c≈©ng ƒë∆∞·ª£c c·∫≠p nh·∫≠t t∆∞∆°ng ·ª©ng
        this.handleBrandFilterChange();
    },
    // *** END: H√ÄM B·ªä THI·∫æU ƒê√É ƒê∆Ø·ª¢C TH√äM ***

    handleEmployeeDetailChange(employeeId) {
        const revenueContainer = document.getElementById('realtime-revenue-report-container'); //
        const detailContainer = document.getElementById('realtime-employee-detail-container'); //

        if (!revenueContainer || !detailContainer) return; //

        if (!employeeId) {
            revenueContainer.classList.remove('hidden'); //
            detailContainer.classList.add('hidden'); //
            detailContainer.innerHTML = ''; //
            return; //
        }

        revenueContainer.classList.add('hidden'); //
        detailContainer.classList.remove('hidden'); //

        const employeeInfo = appState.employeeMaNVMap.get(String(employeeId)); //
        const employeeName = employeeInfo ? ui.getShortEmployeeName(employeeInfo.hoTen, employeeInfo.maNV) : `NV ${employeeId}`; // <<< S·ª¨A (v4.5)
        const detailData = services.generateRealtimeEmployeeDetailReport(employeeId, appState.realtimeYCXData); //

        this.renderRealtimeEmployeeDetail(detailData, employeeName); //
    },

    handleBrandFilterChange() {
        const categoryFilter = document.getElementById('realtime-brand-category-filter'); //
        const brandFilter = document.getElementById('realtime-brand-filter'); //
        const activeDthangViewBtn = document.querySelector('#dthang-realtime-view-selector .view-switcher__btn.active'); //
        const dthangViewType = activeDthangViewBtn ? activeDthangViewBtn.dataset.view : 'brand'; //

        if (!categoryFilter || !brandFilter) return; //

        const selectedCategory = categoryFilter.value; //

        ui.updateBrandFilterOptions(selectedCategory); // <<< S·ª¨A (v4.5) - ƒê√ÇY L√Ä H√ÄM G√ÇY L·ªñI

        const selectedBrand = brandFilter.value; //
        const reportData = services.generateRealtimeBrandReport(appState.realtimeYCXData, selectedCategory, selectedBrand); //
        this.renderRealtimeBrandReport(reportData, dthangViewType); //
    },

    // === S·ª¨A L·ªñI: Chuy·ªÉn t·ª´ arrow function sang shorthand method ===
    updateRealtimeSupermarketTitle(warehouse, dateTime) {
        const titleEl = document.getElementById('realtime-supermarket-title'); //
        if(titleEl) titleEl.textContent = `B√°o c√°o Realtime ${warehouse ? 'kho ' + warehouse : 'to√†n b·ªô'} - ${dateTime.toLocaleTimeString('vi-VN')} ${dateTime.toLocaleDateString('vi-VN')}`; //
    },

    _showEfficiencySettingsModal() { //
        const modal = document.getElementById('selection-modal'); //
        if (!modal) return; //

        const allItemsConfig = settingsService.loadEfficiencyViewSettings(); //

        const listContainer = document.getElementById('selection-modal-list'); //
        if (!listContainer) return;
        listContainer.innerHTML = allItemsConfig.map(item => `
            <div class="selection-item">
                <input type="checkbox" id="select-item-rt-eff-${item.id}" value="${item.id}" ${item.visible ? 'checked' : ''}>
                <label for="select-item-rt-eff-${item.id}">${item.label}</label>
            </div>
        `).join(''); //

        const modalTitleEl = document.getElementById('selection-modal-title');
        if(modalTitleEl) modalTitleEl.textContent = 'T√πy ch·ªânh hi·ªÉn th·ªã Hi·ªáu qu·∫£ khai th√°c'; //
        modal.dataset.settingType = 'efficiencyView'; //
        const searchInput = document.getElementById('selection-modal-search'); //
        if (searchInput) searchInput.value = ''; //

        ui.toggleModal('selection-modal', true); // <<< S·ª¨A (v4.5)
    },

    _showQdcSettingsModal(supermarketReport) { //
        const modal = document.getElementById('selection-modal'); //
        if (!modal || !supermarketReport || !supermarketReport.qdc) return; //

        const allItems = Object.values(supermarketReport.qdc).map(item => item.name).sort(); //
        const savedSettings = settingsService.loadQdcViewSettings(allItems); //

        const listContainer = document.getElementById('selection-modal-list'); //
        if (!listContainer) return;
        listContainer.innerHTML = allItems.map(item => `
            <div class="selection-item">
                <input type="checkbox" id="select-item-rt-qdc-${item.replace(/[^a-zA-Z0-9]/g, '')}" value="${item}" ${savedSettings.includes(item) ? 'checked' : ''}>
                <label for="select-item-rt-qdc-${item.replace(/[^a-zA-Z0-9]/g, '')}">${item}</label>
            </div>
        `).join(''); //

        const modalTitleEl = document.getElementById('selection-modal-title');
        if(modalTitleEl) modalTitleEl.textContent = 'T√πy ch·ªânh hi·ªÉn th·ªã Nh√≥m h√†ng QƒêC'; //
        modal.dataset.settingType = 'qdcView'; //
        const searchInput = document.getElementById('selection-modal-search'); //
        if (searchInput) searchInput.value = ''; //

        ui.toggleModal('selection-modal', true); // <<< S·ª¨A (v4.5)
    },

    _showCategorySettingsModal(supermarketReport) { //
        const modal = document.getElementById('selection-modal'); //
        if (!modal || !supermarketReport || !supermarketReport.nganhHangChiTiet) return; //

        const allItems = Object.keys(supermarketReport.nganhHangChiTiet).sort(); //
        const savedSettings = settingsService.loadCategoryViewSettings(allItems); //

        const listContainer = document.getElementById('selection-modal-list'); //
        if (!listContainer) return;
        listContainer.innerHTML = allItems.map(item => `
            <div class="selection-item">
                <input type="checkbox" id="select-item-rt-cat-${item.replace(/[^a-zA-Z0-9]/g, '')}" value="${item}" ${savedSettings.includes(item) ? 'checked' : ''}>
                <label for="select-item-rt-cat-${item.replace(/[^a-zA-Z0-9]/g, '')}">${item}</label>
            </div>
        `).join(''); //

        const modalTitleEl = document.getElementById('selection-modal-title');
        if(modalTitleEl) modalTitleEl.textContent = 'T√πy ch·ªânh hi·ªÉn th·ªã Ng√†nh h√†ng chi ti·∫øt'; //
        modal.dataset.settingType = 'categoryView'; //
        const searchInput = document.getElementById('selection-modal-search'); //
        if (searchInput) searchInput.value = ''; //

        ui.toggleModal('selection-modal', true); // <<< S·ª¨A (v4.5)
    },

    // === S·ª¨A L·ªñI: Chuy·ªÉn t·ª´ arrow function sang shorthand method ===
    renderRealtimeKpiCards(data, settings) {
        const { doanhThu, doanhThuQuyDoi, doanhThuChuaXuat, doanhThuQuyDoiChuaXuat, doanhThuTraGop, hieuQuaQuyDoi, tyLeTraCham } = data; //
        const { goals: rtGoals } = settings; //

        const targetDTT = parseFloat(rtGoals?.doanhThuThuc) || 0; //
        const targetDTQD = parseFloat(rtGoals?.doanhThuQD) || 0; //

        const dtThucMainEl = document.getElementById('rt-kpi-dt-thuc-main');
        if(dtThucMainEl) dtThucMainEl.textContent = ui.formatNumber((doanhThu || 0) / 1000000, 1); // <<< S·ª¨A (v4.5)
        const dtThucSub1El = document.getElementById('rt-kpi-dt-thuc-sub1');
        if(dtThucSub1El) dtThucSub1El.innerHTML = `% HT: <span class="font-bold">${ui.formatPercentage(targetDTT > 0 ? ((doanhThu || 0) / 1000000) / targetDTT : 0)}</span> / Target ng√†y: <span class="font-bold">${ui.formatNumber(targetDTT || 0)}</span>`; // <<< S·ª¨A (v4.5)
        const dtThucSub2El = document.getElementById('rt-kpi-dt-thuc-sub2');
        if(dtThucSub2El) dtThucSub2El.innerHTML = `DT Ch∆∞a xu·∫•t: <span class="font-bold">${ui.formatNumber((doanhThuChuaXuat || 0) / 1000000, 1)}</span>`; // <<< S·ª¨A (v4.5)

        const dtQdMainEl = document.getElementById('rt-kpi-dt-qd-main');
        if(dtQdMainEl) dtQdMainEl.textContent = ui.formatNumber((doanhThuQuyDoi || 0) / 1000000, 1); // <<< S·ª¨A (v4.5)
        const dtQdSub1El = document.getElementById('rt-kpi-dt-qd-sub1');
        if(dtQdSub1El) dtQdSub1El.innerHTML = `% HT: <span class="font-bold">${ui.formatPercentage(targetDTQD > 0 ? ((doanhThuQuyDoi || 0) / 1000000) / targetDTQD : 0)}</span> / Target ng√†y: <span class="font-bold">${ui.formatNumber(targetDTQD || 0)}</span>`; // <<< S·ª¨A (v4.5)
        const dtQdSub2El = document.getElementById('rt-kpi-dt-qd-sub2');
        if(dtQdSub2El) dtQdSub2El.innerHTML = `DTQƒê Ch∆∞a xu·∫•t: <span class="font-bold">${ui.formatNumber((doanhThuQuyDoiChuaXuat || 0) / 1000000, 1)}</span>`; // <<< S·ª¨A (v4.5)

        const tlQdMainEl = document.getElementById('rt-kpi-tl-qd-main');
        if(tlQdMainEl) tlQdMainEl.textContent = ui.formatPercentage(hieuQuaQuyDoi); // <<< S·ª¨A (v4.5)
        const tlQdSubEl = document.getElementById('rt-kpi-tl-qd-sub');
        if(tlQdSubEl) tlQdSubEl.innerHTML = `M·ª•c ti√™u: <span class="font-bold">${ui.formatNumber(rtGoals?.phanTramQD || 0)}%</span>`; // <<< S·ª¨A (v4.5)

        const dtTcMainEl = document.getElementById('rt-kpi-dt-tc-main');
        if(dtTcMainEl) dtTcMainEl.textContent = ui.formatNumber((doanhThuTraGop || 0) / 1000000, 1); // <<< S·ª¨A (v4.5)
        const dtTcSubEl = document.getElementById('rt-kpi-dt-tc-sub');
        if(dtTcSubEl) dtTcSubEl.innerHTML = `% th·ª±c tr·∫£ ch·∫≠m: <span class="font-bold">${ui.formatPercentage(tyLeTraCham)}</span>`; // <<< S·ª¨A (v4.5)
    },

    // === S·ª¨A L·ªñI: Chuy·ªÉn t·ª´ arrow function sang shorthand method ===
    renderRealtimeChuaXuatTable(reportData) {
        const container = document.getElementById('realtime-unexported-revenue-content'); //
        if (!container) return; //
        if (!reportData || reportData.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center font-bold">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ch∆∞a xu·∫•t trong ng√†y.</p>'; //
            return; //
        }

        const sortState = appState.sortState.realtime_chuaxuat || { key: 'doanhThuQuyDoi', direction: 'desc' }; //
        const { key, direction } = sortState; //
        const sortedData = [...reportData].sort((a, b) => { //
            const valA = a[key] || 0; const valB = b[key] || 0; //
            return direction === 'asc' ? valA - valB : valB - valA; //
        });

        const totals = reportData.reduce((acc, item) => { //
            acc.soLuong += item.soLuong; //
            acc.doanhThuThuc += item.doanhThuThuc; //
            acc.doanhThuQuyDoi += item.doanhThuQuyDoi; //
            return acc; //
        }, { soLuong: 0, doanhThuThuc: 0, doanhThuQuyDoi: 0 }); //

        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`; //

        container.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full text-sm table-bordered table-striped" data-table-type="realtime_chuaxuat">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold"><tr>
                <th class="${headerClass('nganhHang')}" data-sort="nganhHang">Ng√†nh h√†ng</th>
                <th class="${headerClass('soLuong')} text-right" data-sort="soLuong">S·ªë l∆∞·ª£ng</th>
                <th class="${headerClass('doanhThuThuc')} text-right" data-sort="doanhThuThuc">Doanh thu th·ª±c</th>
                    <th class="${headerClass('doanhThuQuyDoi')} text-right" data-sort="doanhThuQuyDoi">Doanh thu Qƒê</th></tr>
            </thead>
            <tbody>${sortedData.map(item => `
                    <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-semibold">${item.nganhHang}</td>
                    <td class="px-4 py-2 text-right font-bold">${ui.formatNumber(item.soLuong)}</td>
                        <td class="px-4 py-2 text-right font-bold">${ui.formatRevenue(item.doanhThuThuc)}</td>
                    <td class="px-4 py-2 text-right font-bold text-blue-600">${ui.formatRevenue(item.doanhThuQuyDoi)}</td>
                    </tr>`).join('')}
            </tbody>
            <tfoot class="table-footer font-bold"><tr>
                <td class="px-4 py-2">T·ªïng</td>
                    <td class="px-4 py-2 text-right">${ui.formatNumber(totals.soLuong)}</td>
                <td class="px-4 py-2 text-right">${ui.formatRevenue(totals.doanhThuThuc)}</td>
                <td class="px-4 py-2 text-right">${ui.formatRevenue(totals.doanhThuQuyDoi)}</td>
                </tr></tfoot></table></div>`; // <<< S·ª¨A (v4.5)
    },

    // === S·ª¨A L·ªñI: Chuy·ªÉn t·ª´ arrow function sang shorthand method ===
    renderRealtimeCategoryDetailsTable(data) {
        const container = document.getElementById('realtime-category-details-content'); //
        const cardHeader = document.getElementById('realtime-category-title'); //
        if (!container || !cardHeader ||!data || !data.nganhHangChiTiet) { if(container) container.innerHTML = `<p class="text-gray-500 font-bold">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>`; return; } //

        const { nganhHangChiTiet } = data; //
        const allItems = Object.keys(nganhHangChiTiet).sort(); //
        const visibleItems = settingsService.loadCategoryViewSettings(allItems); //

        if (Object.keys(nganhHangChiTiet).length === 0) {
            container.innerHTML = '<p class="text-gray-500 font-bold">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>'; return; //
        }

        const sortState = appState.sortState.realtime_nganhhang || { key: 'revenue', direction: 'desc' }; //
        const { key, direction } = sortState; //

        // === START: THAY ƒê·ªîI (Th√™m data-sort cho avgQuantity, avgPrice) ===
        const sortedData = Object.entries(nganhHangChiTiet) //
            .map(([name, values]) => ({ name, ...values })) //
            .filter(item => visibleItems.includes(item.name)) // L·ªçc theo c√†i ƒë·∫∑t
            .sort((a, b) => b.revenue - a.revenue) //
            .slice(0, 15) //
            .sort((a, b) => {
                let valA, valB;
                if (key === 'avgPrice') {
                    valA = a.quantity > 0 ? a.revenue / a.quantity : 0;
                    valB = b.quantity > 0 ? b.revenue / b.quantity : 0;
                } else if (key === 'name') {
                    valA = a.name;
                    valB = b.name;
                    return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    valA = a[key] || 0;
                    valB = b[key] || 0;
                }
                return direction === 'asc' ? valA - valB : valB - valA;
            }); //

        if (!cardHeader.querySelector('.settings-trigger-btn')) {
                cardHeader.classList.add('flex', 'items-center', 'justify-between'); //
            cardHeader.innerHTML = `<span>NG√ÄNH H√ÄNG CHI TI·∫æT</span>` + ui.renderSettingsButton('rt-cat'); // <<< S·ª¨A (v4.5)
            setTimeout(() => { //
                const settingsBtn = document.getElementById('settings-btn-rt-cat');
                if(settingsBtn) settingsBtn.addEventListener('click', () => { //
                    this._showCategorySettingsModal(data); //
                });
            }, 0);
        }

        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`; //

        container.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full text-sm table-bordered table-striped" data-table-type="realtime_nganhhang">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold"><tr>
                <th class="${headerClass('name')}" data-sort="name">Ng√†nh h√†ng <span class="sort-indicator"></span></th>
                <th class="${headerClass('quantity')} text-right header-highlight" data-sort="quantity">SL <span class="sort-indicator"></span></th>
                <th class="${headerClass('revenue')} text-right header-highlight" data-sort="revenue">Doanh thu th·ª±c <span class="sort-indicator"></span></th>
                <th class="${headerClass('revenueQuyDoi')} text-right" data-sort="revenueQuyDoi">Doanh thu Qƒê <span class="sort-indicator"></span></th>
                <th class="${headerClass('avgPrice')} text-right" data-sort="avgPrice">ƒê∆°n gi√° TB <span class="sort-indicator"></span></th></tr>
            </thead>
            <tbody>${sortedData.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-semibold">${item.name}</td>
                    <td class="px-4 py-2 text-right font-bold">${ui.formatNumber(item.quantity)}</td>
                        <td class="px-4 py-2 text-right font-bold text-blue-600">${ui.formatRevenue(item.revenue)}</td>
                    <td class="px-4 py-2 text-right font-bold text-purple-600">${ui.formatRevenue(item.revenueQuyDoi)}</td>
                        <td class="px-4 py-2 text-right font-bold text-green-600">${ui.formatRevenue(item.donGia)}</td>
                </tr>`).join('')}
            </tbody></table></div>`; // <<< S·ª¨A (v4.5)
        // === END: THAY ƒê·ªîI ===
    },

    // === S·ª¨A L·ªñI: Chuy·ªÉn t·ª´ arrow function sang shorthand method ===
    renderRealtimeEfficiencyTable(data, goals) {
            const container = document.getElementById('realtime-efficiency-content'); //
        const cardHeader = document.getElementById('realtime-efficiency-title'); //

        if (!container || !cardHeader || !data || !goals) { //
            if (container) container.innerHTML = `<p class="text-gray-500 font-bold">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>`; //
            return; //
        }

        const allItemsConfig = settingsService.loadEfficiencyViewSettings(); //

        const goalKeyMap = {
            pctPhuKien: 'phanTramPhuKien', //
            pctGiaDung: 'phanTramGiaDung', //
            pctMLN: 'phanTramMLN', //
            pctSim: 'phanTramSim', //
            pctVAS: 'phanTramVAS', //
            pctBaoHiem: 'phanTramBaoHiem' //
        };

        const allItems = allItemsConfig //
            .filter(item => item.id.startsWith('pct')) //
            .map(config => ({ //
                ...config, //
                value: data[config.id], //
                    target: goals[goalKeyMap[config.id]] //
            }));

        // === START: THAY ƒê·ªîI (Th√™m logic S·∫Øp x·∫øp) ===
        const sortStateKey = 'realtime_efficiency';
        const sortState = appState.sortState[sortStateKey] || { key: 'label', direction: 'asc' };
        const { key, direction } = sortState;

        const sortedItems = [...allItems].sort((a, b) => {
            let valA, valB;
            if (key === 'label') {
                valA = a.label || '';
                valB = b.label || '';
                return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            } else if (key === 'value') {
                valA = a.value || 0;
                valB = b.value || 0;
            } else { // key === 'target'
                valA = (a.target || 0) / 100;
                valB = (b.target || 0) / 100;
            }
            return direction === 'asc' ? valA - valB : valB - valA;
        });

        const createRow = (label, value, target) => { //
            const isBelow = value < ((target || 0) / 100); //

            return `<tr class="border-t">
                <td class="px-4 py-2 font-semibold text-gray-800">${label}</td>
                <td class="px-4 py-2 text-right font-bold text-lg ${isBelow ? 'cell-performance is-below' : 'text-green-600'}">${ui.formatPercentage(value || 0)}</td>
                <td class="px-4 py-2 text-right text-gray-600">${target || 0}%</td>
            </tr>`; // <<< S·ª¨A (v4.5)
        };

        if (!cardHeader.querySelector('.settings-trigger-btn')) {
            cardHeader.classList.add('flex', 'items-center', 'justify-between'); //
            cardHeader.innerHTML = `<span>HI·ªÜU QU·∫¢ KHAI TH√ÅC</span>` + ui.renderSettingsButton('rt-eff'); // <<< S·ª¨A (v4.5)

            setTimeout(() => { //
                const settingsBtn = document.getElementById('settings-btn-rt-eff');
                if(settingsBtn) settingsBtn.addEventListener('click', () => { //
                    this._showEfficiencySettingsModal(); //
                });
            }, 0);
        }
        
        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`; 

        container.innerHTML = `
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm table-bordered" data-table-type="${sortStateKey}">
                    <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
                        <tr>
                                <th class="${headerClass('label')} text-left" data-sort="label">Ch·ªâ s·ªë <span class="sort-indicator"></span></th>
                            <th class="${headerClass('value')} text-right" data-sort="value">Th·ª±c hi·ªán <span class="sort-indicator"></span></th>
                                <th class="${headerClass('target')} text-right" data-sort="target">M·ª•c ti√™u <span class="sort-indicator"></span></th>
                        </tr>
                        </thead>
                    <tbody>
                        ${sortedItems // D√πng sortedItems
                                .filter(item => item.visible) // L·ªçc theo c√†i ƒë·∫∑t hi·ªÉn th·ªã
                            .map(item => createRow(item.label, item.value, item.target)) //
                            .join('')}
                    </tbody>
                </table>
                </div>`; //
        // === END: THAY ƒê·ªîI ===
    },

    // === S·ª¨A L·ªñI: Chuy·ªÉn t·ª´ arrow function sang shorthand method ===
    renderRealtimeQdcTable(data) {
        const container = document.getElementById('realtime-qdc-content'); //
        const cardHeader = document.getElementById('realtime-qdc-title'); //
        if (!container || !cardHeader || !data || !data.qdc) { if(container) container.innerHTML = `<p class="text-gray-500 font-bold">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>`; return; } //

        const qdcData = Object.entries(data.qdc).map(([key, value]) => ({ id: key, ...value })); //
        const allItems = qdcData.map(item => item.name); //
        const visibleItems = settingsService.loadQdcViewSettings(allItems); //

        const sortState = appState.sortState.realtime_qdc || { key: 'dtqd', direction: 'desc' }; //
        const { key, direction } = sortState; //
        const sortedData = [...qdcData] //
            .filter(item => visibleItems.includes(item.name)) // L·ªçc theo c√†i ƒë·∫∑t
            .sort((a,b) => direction === 'asc' ? a[key] - b[key] : b[key] - a[key]); //

        if (!cardHeader.querySelector('.settings-trigger-btn')) {
                cardHeader.classList.add('flex', 'items-center', 'justify-between'); //
            cardHeader.innerHTML = `<span>NH√ìM H√ÄNG QUY ƒê·ªîI CAO</span>` + ui.renderSettingsButton('rt-qdc'); // <<< S·ª¨A (v4.5)
            setTimeout(() => { //
                const settingsBtn = document.getElementById('settings-btn-rt-qdc');
                if(settingsBtn) settingsBtn.addEventListener('click', () => { //
                    this._showQdcSettingsModal(data); //
                });
            }, 0);
        }

        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`; //

        container.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full text-sm table-bordered table-striped" data-table-type="realtime_qdc">
            <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
                <tr><th class="${headerClass('name')}" data-sort="name">Nh√≥m h√†ng</th>
                <th class="${headerClass('sl')} text-right" data-sort="sl">S·ªë l∆∞·ª£ng</th>
                <th class="${headerClass('dtqd')} text-right" data-sort="dtqd">DTQƒê (Tr)</th>
                <th class="${headerClass('donGia')} text-right" data-sort="donGia">ƒê∆°n gi√° (Tr)</th>
                    </tr>
            </thead>
            <tbody>${sortedData.map(item => `
                    <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-semibold">${item.name}</td>
                    <td class="px-4 py-2 text-right font-bold">${ui.formatNumber(item.sl)}</td>
                    <td class="px-4 py-2 text-right font-bold text-blue-600">${ui.formatRevenue(item.dtqd)}</td>
                    <td class="px-4 py-2 text-right font-bold text-green-600">${ui.formatRevenue(item.donGia)}</td>
                </tr>`).join('')}
            </tbody></table></div>`; // <<< S·ª¨A (v4.5)
    },

    // === S·ª¨A L·ªñI: Chuy·ªÉn t·ª´ arrow function sang shorthand method ===
    renderRealtimeEmployeeDetail(detailData, employeeName, containerId = 'realtime-employee-detail-container') {
        const container = document.getElementById(containerId); //
        if (!container) return; //

        let headerHtml = ''; //
        const isMainContainer = containerId === 'realtime-employee-detail-container' || containerId.includes('luyke'); //

        if (isMainContainer) {
                headerHtml = `
                <div class="mb-4 flex justify-between items-center">
                    <button class="back-to-summary-btn text-blue-600 hover:underline font-semibold">‚Äπ Quay l·∫°i b·∫£ng t·ªïng h·ª£p</button>
                    <button id="capture-dtnv-rt-detail-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh chi ti·∫øt">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1v6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828-.828A2 2 0 0 1 3.172 4H2z"/><path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5zm0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7zM3 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z"/></svg>
                        <span>Ch·ª•p ·∫£nh</span>
                    </button>
                </div>
                `; //
        }

        if (!detailData) {
            container.innerHTML = headerHtml + `<div class="rt-infographic-container"><p class="text-center text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu doanh thu cho nh√¢n vi√™n ${employeeName}.</p></div>`; //
            return; //
        }

        const selectedWarehouse = document.getElementById('realtime-filter-warehouse')?.value || ''; //
        const { goals } = settingsService.getRealtimeGoalSettings(selectedWarehouse); //
        const { summary, byProductGroup, byCustomer } = detailData; //
        const totalRevenue = byProductGroup.reduce((sum, g) => sum + g.realRevenue, 0); //

        const renderProductGroupProgress = () => byProductGroup.map(group => { //
            const percentage = totalRevenue > 0 ? (group.realRevenue / totalRevenue) * 100 : 0; //
            return `<div class="rt-progress-bar-item">
                <div class="rt-progress-bar-label"><span>${group.name}</span><span>${ui.formatRevenue(group.realRevenue, 0)}</span></div>
                <div class="rt-progress-bar-container"><div class="rt-progress-bar" style="width: ${percentage}%;"></div></div>
            </div>`; // <<< S·ª¨A (v4.5)
        }).join(''); //

        const renderCustomerAccordion = () => byCustomer.map((customer, index) => `
            <div class="rt-customer-group">
                <details>
                        <summary class="rt-customer-header">
                        <span>${index + 1}. ${customer.name} (<span class="product-count">${customer.totalQuantity} s·∫£n ph·∫©m</span>)</span><span class="arrow">‚ñº</span>
                        </summary>
                    <div class="rt-customer-details">
                        <table class="w-full">
                            ${customer.products.map(p => `<tr><td>${p.productName}</td><td class="text-right font-semibold">${ui.formatNumber(p.realRevenue)}</td></tr>`).join('')}
                        </table>
                    </div>
                </details>
            </div>`).join(''); // <<< S·ª¨A (v4.5)

        const conversionRateTarget = (goals?.phanTramQD || 0) / 100; //
        const conversionRateClass = summary.conversionRate >= conversionRateTarget ? 'is-positive' : 'is-negative'; //

        const contentHtml = `
            <div id="dtnv-rt-capture-area">
                <div class="rt-infographic-container" data-capture-group="dtnv-infographic">
                    <div class="rt-infographic-header text-center">
                            <h3 class="employee-name">${employeeName}</h3>
                        <p class="employee-title">Chi ti·∫øt doanh thu</p>
                    </div>
                    <div class="rt-infographic-summary">
                        <div class="rt-infographic-summary-card"><div class="label">T·ªïng DT Th·ª±c</div><div class="value">${ui.formatRevenue(summary.totalRealRevenue, 1)}</div></div>
                            <div class="rt-infographic-summary-card"><div class="label">T·ªïng DTQƒê</div><div class="value">${ui.formatRevenue(summary.totalConvertedRevenue, 1)}</div></div>
                            <div class="rt-infographic-summary-card"><div class="label">T·ª∑ l·ªá Qƒê</div><div class="value ${conversionRateClass}">${ui.formatPercentage(summary.conversionRate)}</div></div>
                        <div class="rt-infographic-summary-card"><div class="label">DT Ch∆∞a Xu·∫•t</div><div class="value">${ui.formatRevenue(summary.unexportedRevenue, 1)}</div></div>
                        <div class="rt-infographic-summary-card"><div class="label">T·ªïng ƒê∆°n H√†ng</div><div class="value">${summary.totalOrders}</div></div>
                            <div class="rt-infographic-summary-card"><div class="label">SL ƒê∆°n B√°n K√®m</div><div class="value">${summary.bundledOrderCount}</div></div>
                        </div>
                    <div class="rt-infographic-grid">
                        <div class="rt-infographic-section"><h4>Nh√≥m h√†ng</h4>${renderProductGroupProgress()}</div>
                        <div class="rt-infographic-section"><h4>Chi ti·∫øt theo kh√°ch h√†ng</h4><div class="rt-customer-accordion">${renderCustomerAccordion()}</div></div>
                        </div>
                    </div>
            </div>`; // <<< S·ª¨A (v4.5)

        container.innerHTML = headerHtml + contentHtml; //
    },

    // === S·ª¨A L·ªñI: Chuy·ªÉn t·ª´ arrow function sang shorthand method ===
    renderRealtimeBrandReport(data, viewType = 'brand') {
        const container = document.getElementById('realtime-brand-report-container'); //
        if (!container) return; //
        const { byBrand, byEmployee } = data; //

        if (byBrand.length === 0 && byEmployee.length === 0) {
            container.innerHTML = '<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu cho b·ªô l·ªçc n√†y.</p>'; //
            return; //
        }

        const renderTable = (title, items, headers, rowRenderer, sortStateKey) => { //
                const sortState = appState.sortState[sortStateKey] || { key: 'revenue', direction: 'desc' }; //
            const { key, direction } = sortState; //
            const sortedItems = [...items].sort((a,b) => direction === 'asc' ? (a[key] - b[key]) : (b[key] - a[key])); //

            const headerClass = (sortKey) => `px-4 py-2 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`; //
            return `<div class="overflow-x-auto"><h4 class="text-lg font-semibold text-gray-700 mb-2">${title}</h4>
                <table class="min-w-full text-sm table-bordered table-striped" data-table-type="${sortStateKey}">
                        <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
                            <tr>${headers.map(h => `<th class="${headerClass(h.key)}" data-sort="${h.key}">${h.label}<span class="sort-indicator"></span></th>`).join('')}</tr>
                    </thead>
                    <tbody>${sortedItems.map(rowRenderer).join('')}</tbody>
                </table></div>`; //
        };

        const brandTable = renderTable('Th·ªëng k√™ theo h√£ng', byBrand, //
            [{label: 'H√£ng', key: 'name'}, {label: 'S·ªë l∆∞·ª£ng', key: 'quantity'}, {label: 'Doanh thu', key: 'revenue'}, {label: 'ƒê∆°n gi√° TB', key: 'avgPrice'}], //
            item => `<tr class="border-t">
                <td class="px-4 py-2 font-medium">${item.name}</td>
                <td class="px-4 py-2 text-right font-bold">${ui.formatNumber(item.quantity)}</td>
                <td class="px-4 py-2 text-right font-bold">${ui.formatRevenue(item.revenue)}</td>
                <td class="px-4 py-2 text-right font-bold">${ui.formatRevenue(item.avgPrice)}</td>
                </tr>`, 'realtime_brand' // <<< S·ª¨A (v4.5)
            );

        const employeeTable = renderTable('Th·ªëng k√™ theo nh√¢n vi√™n', byEmployee, //
            [{label: 'Nh√¢n vi√™n', key: 'name'}, {label: 'S·ªë l∆∞·ª£ng', key: 'quantity'}, {label: 'Doanh thu', key: 'revenue'}], //
            item => `<tr class="border-t">
                <td class="px-4 py-2 font-medium">${item.name}</td>
                <td class="px-4 py-2 text-right font-bold">${ui.formatNumber(item.quantity)}</td>
                <td classZ="px-4 py-2 text-right font-bold">${ui.formatRevenue(item.revenue)}</td>
            </tr>`, 'realtime_brand_employee' // <<< S·ª¨A (v4.5)
        );

        const brandTableHtml = `<div id="realtime-brand-table-container" class="${viewType !== 'brand' ? 'hidden' : ''}">${brandTable}</div>`; //
        const employeeTableHtml = `<div id="realtime-employee-table-container" class="${viewType !== 'employee' ? 'hidden' : ''}">${employeeTable}</div>`; //

        container.innerHTML = brandTableHtml + employeeTableHtml; //
    }
};
--- END FILE: ./ui-realtime.js ---

--- START FILE: ./ui-reports.js ---
// Version 1.4 - Flatten category table header (removes "CHI TI·∫æT SL" row)
// Version 1.3 - Fix layout bug (remove extra header row) and add sorting to sub-columns
// Version 1.2 - Remove stray comments from HTML template literals
// Version 1.1 - Fix capture logic to support vertical stitching
// Version 1.0 - Refactored from ui-components.js
// MODULE: UI REPORTS
// Ch·ªãu tr√°ch nhi·ªám t·∫°o HTML cho c√°c b·∫£ng b√°o c√°o d·ªØ li·ªáu ph·ª©c t·∫°p.

import { appState } from './state.js';
import { utils } from './utils.js';
import { formatters } from './ui-formatters.js';
import { settingsService } from './modules/settings.service.js';

export const uiReports = {
    /**
     * Hi·ªÉn th·ªã b√°o c√°o doanh thu nh√¢n vi√™n, nh√≥m theo b·ªô ph·∫≠n.
     */
    displayEmployeeRevenueReport: (reportData, containerId, sortStateKey) => {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = '';

        let detailContainerId;
        if (sortStateKey === 'doanhthu_lk') {
            detailContainerId = 'dtnv-lk-details-container';
        } else if (sortStateKey === 'realtime_dt_nhanvien') {
            detailContainerId = 'realtime-employee-detail-container';
        } else {
            detailContainerId = 'sknv-details-container';
        }

        const detailContainer = document.getElementById(detailContainerId);
        if (detailContainer) {
             detailContainer.innerHTML = '';
             detailContainer.classList.add('hidden');
        }
        container.classList.remove('hidden');

        if (!reportData || reportData.length === 0) {
             container.innerHTML = '<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu doanh thu cho l·ª±a ch·ªçn n√†y.</p>';
            return;
        }
        
        // *** START: S·ª¨A L·ªñI (v1.1) ***
        // X√≥a data-capture-group="1" v√† overflow-hidden
        let finalHTML = `<div class="bg-white rounded-xl shadow-md border border-gray-200">
             <div class="p-4 header-group-1 text-gray-800">
                 <h3 class="text-xl font-bold uppercase">Doanh thu nh√¢n vi√™n</h3>
                 <p class="text-sm italic text-gray-600">(ƒë∆°n v·ªã t√≠nh: Tri·ªáu ƒë·ªìng)</p>
             </div>`;

        const groupedByDept = {};
        reportData.forEach(item => {
            const dept = item.boPhan;
             if (!groupedByDept[dept]) groupedByDept[dept] = [];
             groupedByDept[dept].push(item);
        });

        const departmentOrder = utils.getSortedDepartmentList(reportData);
        departmentOrder.forEach(deptName => {
             if (groupedByDept[deptName]) {
                 finalHTML += uiReports.renderRevenueTableForDepartment(deptName, groupedByDept[deptName], sortStateKey);
            }
        });

        finalHTML += `</div>`;
        container.innerHTML = finalHTML;
    },

    /**
     * Render m·ªôt b·∫£ng doanh thu cho m·ªôt b·ªô ph·∫≠n c·ª• th·ªÉ.
     */
    renderRevenueTableForDepartment: (title, data, sortStateKey) => {
        const sortState = appState.sortState[sortStateKey] || { key: 'doanhThu', direction: 'desc' };
        const { key, direction } = sortState;
        const sortedData = [...data].sort((a, b) => {
             const valA = a[key] || 0; const valB = b[key] || 0;
             return direction === 'asc' ? valA - valB : valB - valA;
        });

        const totals = data.reduce((acc, item) => {
            acc.doanhThu += item.doanhThu || 0;
            acc.doanhThuQuyDoi += item.doanhThuQuyDoi || 0;
            acc.doanhThuTraGop += item.doanhThuTraGop || 0;
            acc.doanhThuChuaXuat += item.doanhThuChuaXuat || 0;
            return acc;
        }, { doanhThu: 0, doanhThuQuyDoi: 0, doanhThuTraGop: 0, doanhThuChuaXuat: 0 });

        totals.hieuQuaQuyDoi = totals.doanhThu > 0 ? (totals.doanhThuQuyDoi / totals.doanhThu) - 1 : 0;
        totals.tyLeTraCham = totals.doanhThu > 0 ? totals.doanhThuTraGop / totals.doanhThu : 0;

        let titleClass = '';
        if (title.includes('T∆∞ V·∫•n')) titleClass = 'department-header-tv';
        else if (title.includes('Kho')) titleClass = 'department-header-kho';
        else if (title.includes('Trang Tr√≠')) titleClass = 'department-header-tt';

        const isRealtime = sortStateKey === 'realtime_dt_nhanvien';
        const headerClasses = {
            hoTen: '',
            doanhThu: isRealtime ? 'header-group-4' : 'header-bg-blue',
             doanhThuQuyDoi: isRealtime ? 'header-group-4' : 'header-bg-blue',
            hieuQuaQuyDoi: isRealtime ? 'header-group-4' : 'header-bg-blue',
            doanhThuTraGop: isRealtime ? 'header-group-5' : 'header-bg-green',
            tyLeTraCham: isRealtime ? 'header-group-5' : 'header-bg-green',
            doanhThuChuaXuat: isRealtime ? 'header-group-6' : 'header-bg-yellow'
         };

        const headerClass = (sortKey) => `px-4 py-3 sortable ${headerClasses[sortKey] || ''} ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;

        // *** START: S·ª¨A L·ªñI (v1.1) ***
        // Th√™m data-capture-group="report-part"
        let tableHTML = `<div class="department-block" data-capture-group="report-part"><h4 class="text-lg font-bold p-4 border-b border-gray-200 ${titleClass}">${title}</h4><div class="overflow-x-auto"><table class="min-w-full text-sm text-left text-gray-600 table-bordered table-striped" data-table-type="${sortStateKey}" data-capture-columns="7">
             <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
                     <tr>
                             <th class="${headerClass('hoTen')}" data-sort="hoTen">Nh√¢n vi√™n <span class="sort-indicator"></span></th>
                             <th class="${headerClass('doanhThu')} text-right" data-sort="doanhThu">Doanh Thu <span class="sort-indicator"></span></th>
                             <th class="${headerClass('doanhThuQuyDoi')} text-right" data-sort="doanhThuQuyDoi">Doanh Thu Qƒê <span class="sort-indicator"></span></th>
                             <th class="${headerClass('hieuQuaQuyDoi')} text-right" data-sort="hieuQuaQuyDoi">% Qƒê <span class="sort-indicator"></span></th>
                             <th class="${headerClass('doanhThuTraGop')} text-right" data-sort="doanhThuTraGop">DT tr·∫£ ch·∫≠m <span class="sort-indicator"></span></th>
                             <th class="${headerClass('tyLeTraCham')} text-right" data-sort="tyLeTraCham">% tr·∫£ ch·∫≠m <span class="sort-indicator"></span></th>
                             <th class="${headerClass('doanhThuChuaXuat')} text-right" data-sort="doanhThuChuaXuat">DT Ch∆∞a Xu·∫•t <span class="sort-indicator"></span></th>
                      </tr>
                 </thead><tbody>`;
        sortedData.forEach(item => {
            const { mucTieu } = item;
             const qdClass = (mucTieu && item.hieuQuaQuyDoi < (mucTieu.phanTramQD / 100)) ? 'cell-performance is-below' : '';
             const tcClass = (mucTieu && item.tyLeTraCham < (mucTieu.phanTramTC / 100)) ? 'cell-performance is-below' : '';

            let sourceTab;
            if (sortStateKey === 'doanhthu_lk') sourceTab = 'dtnv-lk';
             else if (sortStateKey === 'realtime_dt_nhanvien') sourceTab = 'dtnv-rt';
            else sourceTab = 'sknv';

             tableHTML += `<tr class="interactive-row" data-employee-id="${item.maNV}" data-source-tab="${sourceTab}">
                    <td class="px-4 py-2 font-semibold line-clamp-2 employee-name-cell">
                        <a href="#">${formatters.getShortEmployeeName(item.hoTen, item.maNV)}</a>
                    </td>
                    <td class="px-4 py-2 text-right font-bold">${formatters.formatRevenue(item.doanhThu)}</td>
                    <td class="px-4 py-2 text-right font-bold">${formatters.formatRevenue(item.doanhThuQuyDoi)}</td>
                     <td class="px-4 py-2 text-right font-bold ${qdClass}">${formatters.formatPercentage(item.hieuQuaQuyDoi)}</td>
                    <td class="px-4 py-2 text-right font-bold">${formatters.formatRevenue(item.doanhThuTraGop)}</td>
                    <td class="px-4 py-2 text-right font-bold ${tcClass}">${formatters.formatPercentage(item.tyLeTraCham)}</td>
                    <td class="px-4 py-2 text-right font-bold">${formatters.formatRevenue(item.doanhThuChuaXuat)}</td></tr>`;
        });
         tableHTML += `</tbody><tfoot class="table-footer font-bold"><tr>
                      <td class="px-4 py-2">T·ªïng</td>
                     <td class="px-4 py-2 text-right">${formatters.formatRevenue(totals.doanhThu)}</td>
                     <td class="px-4 py-2 text-right">${formatters.formatRevenue(totals.doanhThuQuyDoi)}</td>
                   <td class="px-4 py-2 text-right">${formatters.formatPercentage(totals.hieuQuaQuyDoi)}</td>
                   <td class="px-4 py-2 text-right">${formatters.formatRevenue(totals.doanhThuTraGop)}</td>
                     <td class="px-4 py-2 text-right">${formatters.formatPercentage(totals.tyLeTraCham)}</td>
                     <td class="px-4 py-2 text-right">${formatters.formatRevenue(totals.doanhThuChuaXuat)}</td>
                  </tr></tfoot></table></div></div>`;
        return tableHTML;
    },

    /**
     * Hi·ªÉn th·ªã b√°o c√°o hi·ªáu qu·∫£ khai th√°c (ICT, CE, PK, GD, v.v.), nh√≥m theo b·ªô ph·∫≠n.
     */
    displayEmployeeEfficiencyReport: (reportData, containerId, sortStateKey) => {
         const container = document.getElementById(containerId);
         if (!container) return;
         if (!reportData || reportData.length === 0) {
             container.innerHTML = '<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªáu qu·∫£ cho l·ª±a ch·ªçn n√†y.</p>';
             return;
         }

         const columnSettings = settingsService.loadEfficiencyViewSettings();
         const visibleColumns = columnSettings.filter(c => c.visible);

         const columnTogglesHTML = `
            <div id="efficiency-column-toggles" class="p-3 border-b border-gray-200 flex flex-wrap items-center gap-x-2 gap-y-2">
                 <span class="text-sm font-semibold mr-2 text-gray-700 non-draggable">T√πy ch·ªânh c·ªôt:</span>
                  ${columnSettings.map(col => `
                     <button
                         class="column-toggle-btn draggable-tag flex items-center ${col.visible ? 'active' : ''}"
                         data-column-id="${col.id}">
                         <svg class="drag-handle-icon mr-2 cursor-grab" width="12" height="12" viewBox="0 0 10 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M4 2a1 1 0 10-2 0 1 1 0 002 0zM2 9a1 1 0 110-2 1 1 0 010 2zm0 5a1 1 0 110-2 1 1 0 010 2zm5-12a1 1 0 10-2 0 1 1 0 002 0zM7 9a1 1 0 110-2 1 1 0 010 2zm0 5a1 1 0 110-2 1 1 0 010 2z" fill="currentColor"></path></svg>
                         <span>${col.label}</span>
                     </button>
                 `).join('')}
             </div>
         `;

         let finalHTML = `<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
                          ${columnTogglesHTML}
                              <div data-capture-group="efficiency-table">
                                 <div class="p-4 header-group-3 text-gray-800">
                                     <h3 class="text-xl font-bold uppercase">HI·ªÜU QU·∫¢ KHAI TH√ÅC THEO NH√ÇN VI√äN</h3>
                                      <p class="text-sm italic text-gray-600">(ƒë∆°n v·ªã t√≠nh: Tri·ªáu ƒë·ªìng)</p>
                                 </div>`;

         const groupedByDept = {};
         reportData.forEach(item => {
             const dept = item.boPhan;
             if (!groupedByDept[dept]) groupedByDept[dept] = [];
             groupedByDept[dept].push(item);
         });

         const departmentOrder = utils.getSortedDepartmentList(reportData);

         departmentOrder.forEach(deptName => {
            if (groupedByDept[deptName]) {
                 finalHTML += uiReports.renderEfficiencyTableForDepartment(deptName, groupedByDept[deptName], sortStateKey, visibleColumns);
             }
         });

         finalHTML += `   </div>
                      </div>`;
         container.innerHTML = finalHTML;
    },

    /**
     * Render m·ªôt b·∫£ng hi·ªáu qu·∫£ khai th√°c cho m·ªôt b·ªô ph·∫≠n c·ª• th·ªÉ.
     */
    renderEfficiencyTableForDepartment: (title, data, sortStateKey, visibleColumns) => {
        const sortState = appState.sortState[sortStateKey] || { key: 'dtICT', direction: 'desc' };
        const { key, direction } = sortState;
        const sortedData = [...data].sort((a, b) => {
            const valA = a[key] || 0; const valB = b[key] || 0;
            return direction === 'asc' ? valA - valB : valB - valA;
        });

        const formatMap = {
            dtICT: (val) => formatters.formatRevenue(val),
            dtPhuKien: (val) => formatters.formatRevenue(val),
            dtCE: (val) => formatters.formatRevenue(val),
            dtGiaDung: (val) => formatters.formatRevenue(val),
            defaultPercent: (val) => formatters.formatPercentage(val)
        };

        const totals = data.reduce((acc, item) => {
             acc.dtICT += item.dtICT || 0;
             acc.dtPhuKien += item.dtPhuKien || 0;
             acc.dtCE += item.dtCE || 0;
             acc.dtGiaDung += item.dtGiaDung || 0;
             acc.dtMLN += item.dtMLN || 0;
             acc.slSmartphone += item.slSmartphone || 0;
             acc.slSimOnline += item.slSimOnline || 0;
             acc.slUDDD += item.slUDDD || 0;
             acc.slBaoHiemDenominator += item.slBaoHiemDenominator || 0;
             acc.slBaoHiemVAS += item.slBaoHiemVAS || 0;
             return acc;
        }, { dtICT: 0, dtPhuKien: 0, dtCE: 0, dtGiaDung: 0, dtMLN: 0, slSmartphone: 0, slSimOnline: 0, slUDDD: 0, slBaoHiemDenominator: 0, slBaoHiemVAS: 0 });

        totals.pctPhuKien = totals.dtICT > 0 ? totals.dtPhuKien / totals.dtICT : 0;
        totals.pctGiaDung = totals.dtCE > 0 ? totals.dtGiaDung / totals.dtCE : 0;
        totals.pctMLN = totals.dtCE > 0 ? totals.dtMLN / totals.dtCE : 0;
        totals.pctSim = totals.slSmartphone > 0 ? totals.slSimOnline / totals.slSmartphone : 0;
        totals.pctVAS = totals.slSmartphone > 0 ? totals.slUDDD / totals.slSmartphone : 0;
        totals.pctBaoHiem = totals.slBaoHiemDenominator > 0 ? totals.slBaoHiemVAS / totals.slBaoHiemDenominator : 0;

        let titleClass = '';
        if (title.includes('T∆∞ V·∫•n')) titleClass = 'department-header-tv';
        else if (title.includes('Kho')) titleClass = 'department-header-kho';
        else if (title.includes('Trang Tr√≠')) titleClass = 'department-header-tt';
        const allHeaders = {
            dtICT: { label: 'DT ICT', class: 'text-right header-group-10' },
            dtPhuKien: { label: 'DT Ph·ª• ki·ªán', class: 'text-right header-group-10' },
            pctPhuKien: { label: '% Ph·ª• ki·ªán', class: 'text-right header-group-10' },
            dtCE: { label: 'DT CE', class: 'text-right header-group-11' },
            dtGiaDung: { label: 'DT Gia d·ª•ng', class: 'text-right header-group-11' },
            pctGiaDung: { label: '% Gia d·ª•ng', class: 'text-right header-group-11' },
            pctMLN: { label: '% MLN', class: 'text-right header-group-12' },
            pctSim: { label: '% Sim', class: 'text-right header-group-12' },
            pctVAS: { label: '% VAS', class: 'text-right header-group-12' },
            pctBaoHiem: { label: '% B·∫£o hi·ªÉm', class: 'text-right header-group-12' }
        };

        const headerClass = (sortKey) => `px-4 py-3 sortable draggable-header ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;
        const captureColumnCount = 1 + visibleColumns.length;
        let tableHTML = `<div class="department-block" data-capture-group="report-part"><h4 class="text-lg font-bold p-4 border-b border-gray-200 ${titleClass}">${title}</h4><div class="overflow-x-auto"><table class="min-w-full text-sm text-left text-gray-600 table-bordered table-striped" data-table-type="${sortStateKey}" data-capture-columns="${captureColumnCount}">
            <thead class="text-xs text-slate-800 uppercase font-bold">
                 <tr>
                    <th class="${headerClass('hoTen')}" data-sort="hoTen">T√™n nh√¢n vi√™n <span class="sort-indicator"></span></th>
                     ${visibleColumns.map(col => `<th class="${headerClass(col.id)} ${allHeaders[col.id]?.class || ''}" data-sort="${col.id}">${allHeaders[col.id]?.label || col.id} <span class="sort-indicator"></span></th>`).join('')}
                 </tr>
            </thead><tbody>`;

        sortedData.forEach(item => {
             const { mucTieu } = item;
            const classMap = {
                 pctPhuKien: (mucTieu && item.pctPhuKien < (mucTieu.phanTramPhuKien / 100)) ? 'cell-performance is-below' : '',
                 pctGiaDung: (mucTieu && item.pctGiaDung < (mucTieu.phanTramGiaDung / 100)) ? 'cell-performance is-below' : '',
                 pctMLN: (mucTieu && item.pctMLN < (mucTieu.phanTramMLN / 100)) ? 'cell-performance is-below' : '',
                 pctSim: (mucTieu && item.pctSim < (mucTieu.phanTramSim / 100)) ? 'cell-performance is-below' : '',
                 pctVAS: (mucTieu && item.pctVAS < (mucTieu.phanTramVAS / 100)) ? 'cell-performance is-below' : '',
                 pctBaoHiem: (mucTieu && item.pctBaoHiem < (mucTieu.phanTramBaoHiem / 100)) ? 'cell-performance is-below' : ''
            };

             tableHTML += `<tr class="interactive-row" data-employee-id="${item.maNV}" data-source-tab="sknv">
                <td class="px-4 py-2 font-semibold line-clamp-2 employee-name-cell">
                     <a href="#">${formatters.getShortEmployeeName(item.hoTen, item.maNV)}</a>
                 </td>
                 ${visibleColumns.map(col => {
                    const value = item[col.id];
                    const className = classMap[col.id] || '';
                    const formatter = formatMap[col.id] || formatMap.defaultPercent;
                    return `<td class="px-4 py-2 text-right font-bold ${className}">${formatter(value)}</td>`;
                }).join('')}
            </tr>`;
        });

        tableHTML += `</tbody><tfoot class="table-footer font-bold">
            <tr>
                 <td class="px-4 py-2">T·ªïng</td>
                 ${visibleColumns.map(col => {
                     const value = totals[col.id];
                     const formatter = formatMap[col.id] || formatMap.defaultPercent;
                     return `<td class="px-4 py-2 text-right">${formatter(value)}</td>`;
                }).join('')}
            </tr>
        </tfoot></table></div></div>`;
        return tableHTML;
    },

    /**
     * Render b·∫£ng doanh thu chi ti·∫øt theo ng√†nh h√†ng (ICT, PK, GD, CE, BH).
     */
    renderCategoryTable(title, sortStateKey, reportData, mainRevenueKey, mainQuantityKey, subQuantityKeys, subQuantityLabels) {
        const sortState = appState.sortState[sortStateKey] || { key: mainRevenueKey, direction: 'desc' };
        const { key, direction } = sortState;

        const sortedData = [...reportData].sort((a, b) => {
            // === START: THAY ƒê·ªîI ===
            // Th√™m logic s·∫Øp x·∫øp cho c√°c c·ªôt con (subQuantityKeys)
            let valA, valB;
            if (key === 'hoTen') {
                valA = a.hoTen || '';
                valB = b.hoTen || '';
                return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            }
            // Ki·ªÉm tra xem key c√≥ ph·∫£i l√† m·ªôt trong c√°c subQuantityKeys kh√¥ng
            const subKeyIndex = subQuantityKeys.indexOf(key);
            if (subKeyIndex > -1) {
                valA = a[key] || 0;
                valB = b[key] || 0;
            } else {
                // S·∫Øp x·∫øp theo c√°c c·ªôt ch√≠nh (mainRevenueKey, mainQuantityKey)
                valA = a[key] || 0;
                valB = b[key] || 0;
            }
            return direction === 'asc' ? valA - valB : valB - valA;
            // === END: THAY ƒê·ªîI ===
        });

        const totals = reportData.reduce((acc, item) => {
             acc[mainRevenueKey] = (acc[mainRevenueKey] || 0) + (item[mainRevenueKey] || 0);
            acc[mainQuantityKey] = (acc[mainQuantityKey] || 0) + (item[mainQuantityKey] || 0);
             subQuantityKeys.forEach(subKey => {
                acc[subKey] = (acc[subKey] || 0) + (item[subKey] || 0);
            });
            return acc;
        }, {});

        const headerClass = (sortKey) => `px-2 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;
        const titleClass = {
            'ICT': 'category-header-ict',
            'PH·ª§ KI·ªÜN': 'category-header-phukien',
            'GIA D·ª§NG': 'category-header-giadung',
            'CE': 'category-header-ce',
             'B·∫¢O HI·ªÇM': 'category-header-baohiem',
        }[title] || 'bg-gray-200';

        // === START: THAY ƒê·ªîI (Th√™m data-sort v√† lo·∫°i b·ªè <tr> th·ª´a) ===
        const subHeaders = subQuantityLabels.map((label, index) => {
            const subKey = subQuantityKeys[index];
            return `<th class="${headerClass(subKey)} text-right" data-sort="${subKey}">${label} <span class="sort-indicator"></span></th>`;
        }).join('');
        // === END: THAY ƒê·ªîI ===

        const tableRows = [];
        sortedData.forEach(item => {
            if ((item[mainRevenueKey] || 0) > 0 || (item[mainQuantityKey] || 0) > 0) {
                 tableRows.push(`
                    <tr class="interactive-row" data-employee-id="${item.maNV}" data-source-tab="sknv">
                        <td class="px-2 py-2 font-semibold line-clamp-2 employee-name-cell">
                            <a href="#">${formatters.getShortEmployeeName(item.hoTen, item.maNV)}</a>
                        </td>
                         <td class="px-2 py-2 text-right font-bold">${formatters.formatRevenue(item[mainRevenueKey])}</td>
                         <td class="px-2 py-2 text-right font-bold">${formatters.formatNumberOrDash(item[mainQuantityKey])}</td>
                         ${subQuantityKeys.map(subKey => `<td class="px-2 py-2 text-right">${formatters.formatNumberOrDash(item[subKey])}</td>`).join('')}
                     </tr>
                `);
            }
        });

        if (tableRows.length === 0) {
             return `<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
                         <h4 class="text-lg font-bold p-3 border-b ${titleClass}">${title}</h4>
                         <p class="p-4 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu cho ng√†nh h√†ng n√†y.</p>
                     </div>`;
        }
        
        // === START: CH·ªàNH S·ª¨A (v1.4) - Lo·∫°i b·ªè rowspan v√† h√†ng 2 ===
        const html = `
            <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
                <h4 class="text-lg font-bold p-3 border-b ${titleClass}">${title}</h4>
                 <div class="overflow-x-auto">
                     <table class="min-w-full text-sm table-bordered table-striped" data-table-type="${sortStateKey}">
                         <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
                             <tr>
                                <th class="px-2 py-3 sortable" data-sort="hoTen">Nh√¢n vi√™n <span class="sort-indicator"></span></th>
                                 <th class="${headerClass(mainRevenueKey)} text-right" data-sort="${mainRevenueKey}">DT <span class="sort-indicator"></span></th>
                                <th class="${headerClass(mainQuantityKey)} text-right" data-sort="${mainQuantityKey}">T·ªïng SL <span class="sort-indicator"></span></th>
                                ${subHeaders}
                            </tr>
                         </thead>
                          <tbody>
                             ${tableRows.join('')}
                        </tbody>
                          <tfoot class="table-footer font-bold">
                            <tr>
                                <td class="px-2 py-2">T·ªïng</td>
                                 <td class="px-2 py-2 text-right">${formatters.formatRevenue(totals[mainRevenueKey] || 0)}</td>
                                 <td class="px-2 py-2 text-right">${formatters.formatNumberOrDash(totals[mainQuantityKey] || 0)}</td>
                                 ${subQuantityKeys.map(subKey => `<td class="px-2 py-2 text-right">${formatters.formatNumberOrDash(totals[subKey] || 0)}</td>`).join('')}
                             </tr>
                          </tfoot>
                     </table>
                </div>
            </div>`;
        // === END: CH·ªàNH S·ª¨A (v1.4) ===
        return html;
    },

    /**
     * Hi·ªÉn th·ªã nhi·ªÅu b·∫£ng doanh thu theo ng√†nh h√†ng.
     */
    displayCategoryRevenueReport(reportData, containerId, sortStatePrefix) {
         const container = document.getElementById(containerId);
         if (!container) return;

         const hasAnyData = reportData.some(item => (item.dtICT || 0) > 0 || (item.dtPhuKien || 0) > 0 || (item.dtGiaDung || 0) > 0 || (item.dtCE || 0) > 0 || (item.dtBaoHiem || 0) > 0);
         if (!hasAnyData) {
             container.innerHTML = '<p class="text-yellow-600 font-semibold">Kh√¥ng t√¨m th·∫•y doanh thu cho c√°c ng√†nh h√†ng ch√≠nh.</p>';
             return;
         }

         const htmlParts = [
             '<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">',
             `<div data-capture-group="1" data-capture-columns="6">${this.renderCategoryTable('ICT', `${sortStatePrefix}_ict`, reportData, 'dtICT', 'slICT', ['slDienThoai', 'slLaptop'], ['SL ƒêi·ªán tho·∫°i', 'SL Laptop'])}</div>`,
             `<div data-capture-group="1" data-capture-columns="6">${this.renderCategoryTable('PH·ª§ KI·ªÜN', `${sortStatePrefix}_phukien`, reportData, 'dtPhuKien', 'slPhuKien', ['slPinSDP', 'slCamera', 'slTaiNgheBLT'], ['SL Pin SDP', 'SL Camera', 'SL Tai nghe BLT'])}</div>`,
             `<div data-capture-group="2" data-capture-columns="6">${this.renderCategoryTable('GIA D·ª§NG', `${sortStatePrefix}_giadung`, reportData, 'dtGiaDung', 'slGiaDung', ['slNoiChien', 'slMLN', 'slRobotHB'], ['SL N·ªìi chi√™n', 'SL MLN', 'SL Robot HB'])}</div>`,
             `<div data-capture-group="2" data-capture-columns="6">${this.renderCategoryTable('CE', `${sortStatePrefix}_ce`, reportData, 'dtCE', 'slCE', ['slTivi', 'slTuLanh', 'slMayGiat', 'slMayLanh'], ['SL Tivi', 'SL T·ªß l·∫°nh', 'SL M√°y gi·∫∑t', 'SL M√°y l·∫°nh'])}</div>`,
             `<div class="lg:col-span-2" data-capture-group="3" data-capture-columns="7">${this.renderCategoryTable('B·∫¢O HI·ªÇM', `${sortStatePrefix}_baohiem`, reportData, 'dtBaoHiem', 'slBaoHiem', ['slBH1d1', 'slBHXM', 'slBHRV', 'slBHMR'], ['BH 1-1', 'BHXM', 'BHRV', 'BHMR'])}</div>`,
             '</div>'
         ];
         container.innerHTML = htmlParts.join('');
    },
};
--- END FILE: ./ui-reports.js ---

--- START FILE: ./ui-sknv.js ---
// Version 6.48 - Refactor: renderSpecialProgramReport returns HTML string instead of setting innerHTML
// Version 6.45 - (YC 3 Fix 2) Set capture preset on the PARENT container (#pasted-competition-detail-container)
// Ch·ª©a c√°c h√†m render giao di·ªán cho tab "S·ª©c kh·ªèe nh√¢n vi√™n"

import { appState } from './state.js';
import { services } from './services.js';
import { uiComponents } from './ui-components.js';
import { utils } from './utils.js';
import { settingsService } from './modules/settings.service.js'; // *** NEW (v6.23) ***
console.log("GEMINI CHECK: ƒêANG CH·∫†Y UI-SKNV.JS PHI√äN B·∫¢N 6.48");

export const uiSknv = {
    // === START: Y√äU C·∫¶U 4 (L∆∞u tr·ªØ TBT) ===
    _lastPastedAverages: {}, // Bi·∫øn t·∫°m ƒë·ªÉ l∆∞u TBT b·ªô ph·∫≠n cho view chi ti·∫øt
    // === END: Y√äU C·∫¶U 4 ===

    displayEmployeeIncomeReport: (reportData) => {
        console.log("[ui-sknv.js displayEmployeeIncomeReport] === Starting render ==="); // Log m·ªõi
        const container = document.getElementById('income-report-container');
        const placeholder = document.getElementById('income-report-placeholder');
        if (!container || !placeholder) {
           console.error("[ui-sknv.js displayEmployeeIncomeReport] Container or placeholder not found."); // Log m·ªõi
            return;
        }
        const hasIncomeData = reportData.some(item => (item.tongThuNhap || 0) > 0 || (item.gioCong || 0) > 0);
        console.log(`[ui-sknv.js displayEmployeeIncomeReport] Input reportData length: ${reportData?.length}, hasIncomeData: ${hasIncomeData}`); // Log m·ªõi

        if (!reportData || reportData.length === 0 || !hasIncomeData) {
            console.warn("[ui-sknv.js displayEmployeeIncomeReport] No valid income data, showing placeholder."); // Log m·ªõi
            placeholder.classList.remove('hidden'); container.innerHTML = ''; return;
        }
        placeholder.classList.add('hidden');

        // *** START: S·ª¨A L·ªñI (v6.31) - X√≥a 'overflow-hidden' ***
        let finalHTML = `<div class="bg-white rounded-xl shadow-md border border-gray-200"><div class="p-4 header-group-2 text-gray-800"><h3 class="text-xl font-bold uppercase">Thu nh·∫≠p nh√¢n vi√™n</h3><p class="text-sm italic text-gray-600">(ƒë∆°n v·ªã t√≠nh: Tri·ªáu ƒë·ªìng)</p></div>`;
        // *** END: S·ª¨A L·ªñI (v6.31) ***

        const groupedByDept = {};
        reportData.forEach(item => {
             const dept = item.boPhan;
            if (!groupedByDept[dept]) groupedByDept[dept] = [];
            groupedByDept[dept].push(item);
        });
        const departmentOrder = utils.getSortedDepartmentList(reportData);
        console.log("[ui-sknv.js displayEmployeeIncomeReport] Department order:", departmentOrder); // Log m·ªõi

        departmentOrder.forEach(deptName => {
            if (groupedByDept[deptName]) {
                 console.log(`[ui-sknv.js displayEmployeeIncomeReport] Rendering table for department: ${deptName}`); // Log m·ªõi
                 finalHTML += uiSknv.renderIncomeTableForDepartment(deptName, groupedByDept[deptName]);
            }
        });

        finalHTML += `</div>`;
        container.innerHTML = finalHTML;
        console.log("[ui-sknv.js displayEmployeeIncomeReport] === Render complete ==="); // Log m·ªõi
    },

    renderIncomeTableForDepartment: (title, data) => {
        console.log(`[ui-sknv.js renderIncomeTableForDepartment] Rendering for: ${title}, Data length: ${data?.length}`); // Log m·ªõi
        const sortState = appState.sortState.thunhap || { key: 'tongThuNhap', direction: 'desc' };
        const { key, direction } = sortState;
        const sortedData = [...data].sort((a, b) => {
            const valA = a[key] || 0; const valB = b[key] || 0;
            return direction === 'asc' ? valA - valB : valB - valA;
        });

        const totals = data.reduce((acc, item) => {
            acc.gioCong += item.gioCong || 0; // Ensure NaN safety
             acc.thuongNong += item.thuongNong || 0;
            acc.thuongERP += item.thuongERP || 0;
            acc.tongThuNhap += item.tongThuNhap || 0;
            acc.thuNhapDuKien += item.thuNhapDuKien || 0;
            acc.thuNhapThangTruoc += item.thuNhapThangTruoc || 0;
            acc.chenhLechThuNhap += item.chenhLechThuNhap || 0;
            return acc;
        }, { gioCong: 0, thuongNong: 0, thuongERP: 0, tongThuNhap: 0, thuNhapDuKien: 0, thuNhapThangTruoc: 0, chenhLechThuNhap: 0 });
        console.log(`[ui-sknv.js renderIncomeTableForDepartment] Calculated totals for ${title}:`, totals); // Log m·ªõi

        const averageProjectedIncome = data.length > 0 ? totals.thuNhapDuKien / data.length : 0;
        let titleClass = '';
        if (title.includes('T∆∞ V·∫•n')) titleClass = 'department-header-tv';
        else if (title.includes('Kho')) titleClass = 'department-header-kho';
        else if (title.includes('Trang Tr√≠')) titleClass = 'department-header-tt';

        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;
        
        // *** Y√äU C·∫¶U 3 (v6.28): Th√™m 'w-full' ƒë·ªÉ b·∫£ng co gi√£n 100% ***
        // *** START: S·ª¨A L·ªñI (v6.31) - Th√™m data-capture-group="report-part" ***
        let tableHTML = `<div class="department-block" data-capture-group="report-part"><h4 class="text-lg font-bold p-4 border-b border-gray-200 ${titleClass}">${title} <span class="text-sm font-normal text-gray-500">(Thu nh·∫≠p DK TB: ${uiComponents.formatRevenue(averageProjectedIncome)})</span></h4><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-600 table-bordered table-striped" data-table-type="thunhap" data-capture-columns="6">
          <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
                <tr>
                    <th class="${headerClass('hoTen')}" data-sort="hoTen">H·ªç T√™n <span class="sort-indicator"></span></th>
                    <th class="${headerClass('gioCong')} text-right" data-sort="gioCong">Gi·ªù c√¥ng <span class="sort-indicator"></span></th>
                     <th class="${headerClass('tongThuNhap')} text-right" data-sort="tongThuNhap">T·ªïng thu nh·∫≠p <span class="sort-indicator"></span></th>
                    <th class="${headerClass('thuNhapDuKien')} text-right" data-sort="thuNhapDuKien">Thu nh·∫≠p DK <span class="sort-indicator"></span></th>
                    <th class="${headerClass('thuNhapThangTruoc')} text-right" data-sort="thuNhapThangTruoc">Th√°ng tr∆∞·ªõc <span class="sort-indicator"></span></th>
                    <th class="${headerClass('chenhLechThuNhap')} text-right" data-sort="chenhLechThuNhap">+/- Th√°ng tr∆∞·ªõc <span class="sort-indicator"></span></th>
                 </tr>
                 </thead><tbody>`;
        sortedData.forEach(nv => {
            const incomeDkCellClass = nv.thuNhapDuKien < averageProjectedIncome ? 'cell-performance is-below' : '';
             const incomeDiffClass = (nv.chenhLechThuNhap || 0) < 0 ? 'income-negative' : 'income-positive'; // Handle undefined/NaN

            tableHTML += `<tr class="interactive-row" data-employee-id="${nv.maNV}" data-source-tab="sknv">
                    <td class="px-4 py-2 font-semibold line-clamp-2 employee-name-cell">
                        <a href="#">${uiComponents.getShortEmployeeName(nv.hoTen, nv.maNV)}</a>
                    </td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumberOrDash(nv.gioCong)}</td>
                    <td class="px-4 py-2 text-right font-bold text-blue-600">${uiComponents.formatRevenue(nv.tongThuNhap)}</td>
                    <td class="px-4 py-2 text-right font-bold text-green-600 ${incomeDkCellClass}">${uiComponents.formatRevenue(nv.thuNhapDuKien)}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(nv.thuNhapThangTruoc)}</td>
                    <td class="px-4 py-2 text-right font-bold ${incomeDiffClass}">${uiComponents.formatRevenue(nv.chenhLechThuNhap)}</td>
                </tr>`;
        });
        tableHTML += `</tbody><tfoot class="table-footer font-bold">
            <tr>
                <td class="px-4 py-2">T·ªïng</td>
                <td class="px-4 py-2 text-right">${uiComponents.formatNumberOrDash(totals.gioCong)}</td>
                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.tongThuNhap)}</td>
                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.thuNhapDuKien)}</td>
                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.thuNhapThangTruoc)}</td>
                <td class="px-4 py-2 text-right">${uiComponents.formatRevenue(totals.chenhLechThuNhap)}</td>
             </tr>
        </tfoot></table></div></div>`;
        return tableHTML;
    },

    displaySknvReport: (filteredReport, forceDetail = false) => {
        // === START: DEBUG (v6.16) ===
        console.log(`%c[DEBUG displaySknvReport] === B·∫Øt ƒë·∫ßu render ===`, "color: blue; font-weight: bold;");
        console.log(`[DEBUG displaySknvReport] Force detail: ${forceDetail}`);
        // === END: DEBUG ===
        const summaryContainer = document.getElementById('sknv-summary-container');
        const detailsContainer = document.getElementById('sknv-details-container');
        if (!summaryContainer || !detailsContainer) {
            console.error("[ui-sknv.js displaySknvReport] Summary or details container not found."); // Log m·ªõi
            return;
        }

        const isViewingDetail = appState.viewingDetailFor && appState.viewingDetailFor.sourceTab === 'sknv';
        const shouldShowDetail = forceDetail || isViewingDetail;
        // === START: DEBUG (v6.16) ===
        console.log(`[DEBUG displaySknvReport] isViewingDetail (t·ª´ appState): ${isViewingDetail}`);
        console.log(`[DEBUG displaySknvReport] shouldShowDetail (k·∫øt qu·∫£): ${shouldShowDetail}`);
        // === END: DEBUG ===

        summaryContainer.classList.toggle('hidden', shouldShowDetail);
        detailsContainer.classList.toggle('hidden', !shouldShowDetail);

        if (shouldShowDetail) {
            const employeeId = appState.viewingDetailFor.employeeId;
            console.log(`[DEBUG displaySknvReport] ƒêang t√¨m data cho NV ID: ${employeeId}`); // Log m·ªõi
            const employeeData = appState.masterReportData.sknv.find(nv => String(nv.maNV).trim() === String(employeeId).trim());
            if(employeeData) {
              console.log(`[DEBUG displaySknvReport] ƒê√£ t√¨m th·∫•y data NV. G·ªçi renderSknvDetailForEmployee.`); // Log m·ªõi
                uiSknv.renderSknvDetailForEmployee(employeeData, filteredReport);
            } else {
                 console.warn(`[DEBUG displaySknvReport] KH√îNG T√åM TH·∫§Y data cho NV ID: ${employeeId}`); // Log m·ªõi
                 detailsContainer.innerHTML = `
                    <div class="mb-4">
                        <button class="back-to-summary-btn text-blue-600 hover:underline font-semibold">‚Äπ Quay l·∫°i b·∫£ng t·ªïng h·ª£p</button>
                     </div>
                    <p class="text-red-500">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu chi ti·∫øt cho nh√¢n vi√™n ƒë√£ ch·ªçn.</p>`;
            }
        } else {
            console.log("[DEBUG displaySknvReport] G·ªçi displaySknvSummaryReport."); // Log m·ªõi
            uiSknv.displaySknvSummaryReport(filteredReport);
        }
        console.log("%c[DEBUG displaySknvReport] === Render k·∫øt th√∫c ===", "color: blue; font-weight: bold;"); // Log m·ªõi
    },
    
    _createDetailMetricGrid(title, colorClass, icon, data) {
        // === START: THAY ƒê·ªîI ===
        const sortStateKey = `sknv_detail_${title.toLowerCase().replace(/[^a-z]/g, '')}`;
        const sortState = appState.sortState[sortStateKey] || { key: 'label', direction: 'asc' };
        const { key, direction } = sortState;

        const sortedData = [...data].sort((a, b) => {
            let valA, valB;
            if (key === 'label') {
                valA = a.label || '';
                valB = b.label || '';
                return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            } else if (key === 'value') {
                valA = a.rawValue;
                valB = b.rawValue;
            } else { // key === 'average'
                valA = a.rawAverage;
                valB = b.rawAverage;
            }
            return direction === 'asc' ? (valA || 0) - (valB || 0) : (valB || 0) - (valA || 0);
        });

        const headerClass = (sortKey) => `px-2 py-1 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;

        let itemsHtml = `
            <table class="w-full text-sm sknv-detail-metric-table" data-table-type="${sortStateKey}">
                <thead>
                    <tr class="border-b border-gray-300">
                        <th class="${headerClass('label')} text-left" data-sort="label">Ch·ªâ s·ªë <span class="sort-indicator"></span></th>
                        <th class="${headerClass('value')} text-right" data-sort="value">Th·ª±c hi·ªán <span class="sort-indicator"></span></th>
                        <th class="${headerClass('average')} text-right" data-sort="average">Trung b√¨nh <span class="sort-indicator"></span></th>
                        <th class="px-2 py-1 text-right">ƒê√°nh gi√°</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        sortedData.forEach(row => {
            const evaluation = uiSknv.getSknvEvaluation(row.rawValue, row.rawAverage, row.higherIsBetter);
            itemsHtml += `
                <tr classclass="border-t border-gray-100">
                    <td class="px-2 py-2 font-semibold text-gray-700 text-left">${row.label}</td>
                    <td class="px-2 py-2 font-bold text-gray-900 text-right ${row.valueClass || ''}">${row.value}</td>
                    <td class="px-2 py-2 text-gray-600 text-right">${row.average}</td>
                    <td class="px-2 py-2 text-right">
                        <span class="evaluation-badge ${evaluation.class}">${evaluation.text}</span>
                    </td>
                </tr>
            `;
        });

        itemsHtml += `</tbody></table>`;
        // === END: THAY ƒê·ªîI ===
    
        return `
            <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
                <div class="sknv-detail-card-header ${colorClass}">
                    <i data-feather="${icon}" class="header-icon"></i>
                    <h4 class="text-lg font-bold">${title}</h4>
                </div>
                <div class="overflow-x-auto">
                    ${itemsHtml}
                </div>
            </div>
        `;
    },

    
    renderSknvDetailForEmployee(employeeData, filteredReport) {
        console.log("[ui-sknv.js renderSknvDetailForEmployee] === Starting render ==="); // Log m·ªõi
        const detailsContainer = document.getElementById('sknv-details-container');
        if (!detailsContainer) {
            console.error("[ui-sknv.js renderSknvDetailForEmployee] Details container not found."); // Log m·ªõi
            return;
        }

        if (!employeeData) {
            console.warn("[ui-sknv.js renderSknvDetailForEmployee] No employee data provided."); // Log m·ªõi
            detailsContainer.innerHTML = `
                <div class="mb-4">
                    <button class="back-to-summary-btn text-blue-600 hover:underline font-semibold">‚Äπ Quay l·∫°i b·∫£ng t·ªïng h·ª£p</button>
                </div>
                <p class="text-red-500">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho nh√¢n vi√™n ƒë√£ ch·ªçn.</p>`;
            return;
        }
        console.log("[ui-sknv.js renderSknvDetailForEmployee] Employee data:", employeeData); // Log m·ªõi

        const departmentAverages = services.calculateDepartmentAverages(employeeData.boPhan, filteredReport);
        console.log("[ui-sknv.js renderSknvDetailForEmployee] Department averages:", departmentAverages); // Log m·ªõi

        const evaluationCounts = {
            doanhthu: { above: 0, total: 7 },
            nangsuat: { above: 0, total: 7 },
            hieuqua: { above: 0, total: 6 },
            dongia: { above: 0, total: 7 },
            qdc: { above: 0, total: 0 } // *** Y√äU C·∫¶U 3 (v6.26): V√¥ hi·ªáu h√≥a QƒêC ***
        };

        const countEvaluation = (group, value, avgValue, higherIsBetter = true) => {
            // *** Y√äU C·∫¶U 3 (v6.26): NgƒÉn QƒêC ƒë·∫øm ƒëi·ªÉm ***
            if (group === 'qdc') return;
            
            if (!isFinite(value) || avgValue === undefined || !isFinite(avgValue)) return;
            let isAbove = higherIsBetter ? (value >= avgValue) : (value <= avgValue);
            if (isAbove) { evaluationCounts[group].above++; }
        };
        
        const { mucTieu } = employeeData;

        // --- T·∫°o d·ªØ li·ªáu cho c√°c grid (Gi·ªØ nguy√™n logic t·∫°o m·∫£ng doanhThuData, nangSuatData, hieuQuaData, donGiaData) ---
        const doanhThuData = [
            { label: 'Doanh thu th·ª±c', value: uiComponents.formatRevenue(employeeData.doanhThu), average: uiComponents.formatRevenue(departmentAverages.doanhThu || 0), rawValue: employeeData.doanhThu, rawAverage: departmentAverages.doanhThu },
             { label: 'Doanh thu quy ƒë·ªïi', value: uiComponents.formatRevenue(employeeData.doanhThuQuyDoi), average: uiComponents.formatRevenue(departmentAverages.doanhThuQuyDoi || 0), rawValue: employeeData.doanhThuQuyDoi, rawAverage: departmentAverages.doanhThuQuyDoi },
            { label: '% Quy ƒë·ªïi', value: uiComponents.formatPercentage(employeeData.hieuQuaQuyDoi), valueClass: (mucTieu && employeeData.hieuQuaQuyDoi < (mucTieu.phanTramQD / 100)) ? 'cell-performance is-below' : '', average: uiComponents.formatPercentage(departmentAverages.hieuQuaQuyDoi), rawValue: employeeData.hieuQuaQuyDoi, rawAverage: departmentAverages.hieuQuaQuyDoi },
            { label: 'Doanh thu CE', value: uiComponents.formatRevenue(employeeData.dtCE), average: uiComponents.formatRevenue(departmentAverages.dtCE || 0), rawValue: employeeData.dtCE, rawAverage: departmentAverages.dtCE },
            { label: 'Doanh thu ICT', value: uiComponents.formatRevenue(employeeData.dtICT), average: uiComponents.formatRevenue(departmentAverages.dtICT || 0), rawValue: employeeData.dtICT, rawAverage: departmentAverages.dtICT },
            { label: 'Doanh thu tr·∫£ ch·∫≠m', value: uiComponents.formatRevenue(employeeData.doanhThuTraGop), average: uiComponents.formatRevenue(departmentAverages.doanhThuTraGop || 0), rawValue: employeeData.doanhThuTraGop, rawAverage: departmentAverages.doanhThuTraGop },
            { label: '% Tr·∫£ ch·∫≠m', value: uiComponents.formatPercentage(employeeData.tyLeTraCham), valueClass: (mucTieu && employeeData.tyLeTraCham < (mucTieu.phanTramTC / 100)) ? 'cell-performance is-below' : '', average: uiComponents.formatPercentage(departmentAverages.tyLeTraCham), rawValue: employeeData.tyLeTraCham, rawAverage: departmentAverages.tyLeTraCham }
        ];
        doanhThuData.forEach(d => countEvaluation('doanhthu', d.rawValue, d.rawAverage));

        const nangSuatData = [
            { label: 'Th∆∞·ªüng n√≥ng', value: uiComponents.formatRevenue(employeeData.thuongNong), average: uiComponents.formatRevenue(departmentAverages.thuongNong || 0), rawValue: employeeData.thuongNong, rawAverage: departmentAverages.thuongNong },
            { label: 'Th∆∞·ªüng ERP', value: uiComponents.formatRevenue(employeeData.thuongERP), average: uiComponents.formatRevenue(departmentAverages.thuongERP || 0), rawValue: employeeData.thuongERP, rawAverage: departmentAverages.thuongERP },
            { label: 'Thu nh·∫≠p l≈©y k·∫ø', value: uiComponents.formatRevenue(employeeData.tongThuNhap), average: uiComponents.formatRevenue(departmentAverages.tongThuNhap || 0), rawValue: employeeData.tongThuNhap, rawAverage: departmentAverages.tongThuNhap },
            { label: 'Thu nh·∫≠p d·ª± ki·∫øn', value: uiComponents.formatRevenue(employeeData.thuNhapDuKien), average: uiComponents.formatRevenue(departmentAverages.thuNhapDuKien || 0), rawValue: employeeData.thuNhapDuKien, rawAverage: departmentAverages.thuNhapDuKien },
            { label: 'Gi·ªù c√¥ng', value: uiComponents.formatNumberOrDash(employeeData.gioCong), average: uiComponents.formatNumberOrDash(departmentAverages.gioCong), rawValue: employeeData.gioCong, rawAverage: departmentAverages.gioCong },
            { label: 'Thu nh·∫≠p/GC', value: uiComponents.formatNumberOrDash(employeeData.gioCong > 0 ? employeeData.tongThuNhap / employeeData.gioCong : 0), average: uiComponents.formatNumberOrDash((departmentAverages.gioCong || 0) > 0 ? (departmentAverages.tongThuNhap || 0) / departmentAverages.gioCong : 0), rawValue: employeeData.gioCong > 0 ? employeeData.tongThuNhap / employeeData.gioCong : 0, rawAverage: (departmentAverages.gioCong || 0) > 0 ? (departmentAverages.tongThuNhap || 0) / departmentAverages.gioCong : 0 },
            { label: 'Doanh thu Qƒê/GC', value: uiComponents.formatRevenue(employeeData.gioCong > 0 ? employeeData.doanhThuQuyDoi / employeeData.gioCong : 0), average: uiComponents.formatRevenue((departmentAverages.gioCong || 0) > 0 ? (departmentAverages.doanhThuQuyDoi || 0) / departmentAverages.gioCong : 0), rawValue: employeeData.gioCong > 0 ? employeeData.doanhThuQuyDoi / employeeData.gioCong : 0, rawAverage: (departmentAverages.gioCong || 0) > 0 ? (departmentAverages.doanhThuQuyDoi || 0) / departmentAverages.gioCong : 0 }
        ];
        nangSuatData.forEach(d => countEvaluation('nangsuat', d.rawValue, d.rawAverage));

        const hieuQuaData = [
             { label: '% PK', value: uiComponents.formatPercentage(employeeData.pctPhuKien), valueClass: (mucTieu && employeeData.pctPhuKien < (mucTieu.phanTramPhuKien / 100)) ? 'cell-performance is-below' : '', average: uiComponents.formatPercentage(departmentAverages.pctPhuKien), rawValue: employeeData.pctPhuKien, rawAverage: departmentAverages.pctPhuKien },
            { label: '% Gia d·ª•ng', value: uiComponents.formatPercentage(employeeData.pctGiaDung), valueClass: (mucTieu && employeeData.pctGiaDung < (mucTieu.phanTramGiaDung / 100)) ? 'cell-performance is-below' : '', average: uiComponents.formatPercentage(departmentAverages.pctGiaDung), rawValue: employeeData.pctGiaDung, rawAverage: departmentAverages.pctGiaDung },
            { label: '% MLN', value: uiComponents.formatPercentage(employeeData.pctMLN), valueClass: (mucTieu && employeeData.pctMLN < (mucTieu.phanTramMLN / 100)) ? 'cell-performance is-below' : '', average: uiComponents.formatPercentage(departmentAverages.pctMLN), rawValue: employeeData.pctMLN, rawAverage: departmentAverages.pctMLN },
            { label: '% Sim', value: uiComponents.formatPercentage(employeeData.pctSim), valueClass: (mucTieu && employeeData.pctSim < (mucTieu.phanTramSim / 100)) ? 'cell-performance is-below' : '', average: uiComponents.formatPercentage(departmentAverages.pctSim), rawValue: employeeData.pctSim, rawAverage: departmentAverages.pctSim },
            { label: '% VAS', value: uiComponents.formatPercentage(employeeData.pctVAS), valueClass: (mucTieu && employeeData.pctVAS < (mucTieu.phanTramVAS / 100)) ? 'cell-performance is-below' : '', average: uiComponents.formatPercentage(departmentAverages.pctVAS), rawValue: employeeData.pctVAS, rawAverage: departmentAverages.pctVAS },
            { label: '% B·∫£o hi·ªÉm', value: uiComponents.formatPercentage(employeeData.pctBaoHiem), valueClass: (mucTieu && employeeData.pctBaoHiem < (mucTieu.phanTramBaoHiem / 100)) ? 'cell-performance is-below' : '', average: uiComponents.formatPercentage(departmentAverages.pctBaoHiem), rawValue: employeeData.pctBaoHiem, rawAverage: departmentAverages.pctBaoHiem },
        ];
        hieuQuaData.forEach(d => countEvaluation('hieuqua', d.rawValue, d.rawAverage));

        const donGiaData = [
            { label: 'ƒê∆°n gi√° TB', value: uiComponents.formatRevenue(employeeData.donGiaTrungBinh), average: uiComponents.formatRevenue(departmentAverages.donGiaTrungBinh), rawValue: employeeData.donGiaTrungBinh, rawAverage: departmentAverages.donGiaTrungBinh },
            { label: 'ƒê∆°n gi√° Tivi', value: uiComponents.formatRevenue(employeeData.donGiaTivi), average: uiComponents.formatRevenue(departmentAverages.donGiaTivi), rawValue: employeeData.donGiaTivi, rawAverage: departmentAverages.donGiaTivi },
            { label: 'ƒê∆°n gi√° T·ªß l·∫°nh', value: uiComponents.formatRevenue(employeeData.donGiaTuLanh), average: uiComponents.formatRevenue(departmentAverages.donGiaTuLanh), rawValue: employeeData.donGiaTuLanh, rawAverage: departmentAverages.donGiaTuLanh },
             { label: 'ƒê∆°n gi√° M√°y gi·∫∑t', value: uiComponents.formatRevenue(employeeData.donGiaMayGiat), average: uiComponents.formatRevenue(departmentAverages.donGiaMayGiat), rawValue: employeeData.donGiaMayGiat, rawAverage: departmentAverages.donGiaMayGiat },
            { label: 'ƒê∆°n gi√° M√°y l·∫°nh', value: uiComponents.formatRevenue(employeeData.donGiaMayLanh), average: uiComponents.formatRevenue(departmentAverages.donGiaMayLanh), rawValue: employeeData.donGiaMayLanh, rawAverage: departmentAverages.donGiaMayLanh },
            { label: 'ƒê∆°n gi√° ƒêi·ªán tho·∫°i', value: uiComponents.formatRevenue(employeeData.donGiaDienThoai), average: uiComponents.formatRevenue(departmentAverages.donGiaDienThoai), rawValue: employeeData.donGiaDienThoai, rawAverage: departmentAverages.donGiaDienThoai },
            { label: 'ƒê∆°n gi√° Laptop', value: uiComponents.formatRevenue(employeeData.donGiaLaptop), average: uiComponents.formatRevenue(departmentAverages.donGiaLaptop), rawValue: employeeData.donGiaLaptop, rawAverage: departmentAverages.donGiaLaptop },
        ];
        donGiaData.forEach(d => countEvaluation('dongia', d.rawValue, d.rawAverage));
        
        // *** Y√äU C·∫¶U 3 (v6.26): B·ªè QƒêC kh·ªèi t·ªïng ***
        const totalAbove = evaluationCounts.doanhthu.above + evaluationCounts.nangsuat.above + evaluationCounts.hieuqua.above + evaluationCounts.dongia.above; // + evaluationCounts.qdc.above;
        const totalCriteria = evaluationCounts.doanhthu.total + evaluationCounts.nangsuat.total + evaluationCounts.hieuqua.total + evaluationCounts.dongia.total; // + evaluationCounts.qdc.total;
        console.log(`[ui-sknv.js renderSknvDetail] Evaluation Counts (QDC B·ªé QUA):`, evaluationCounts, `Total Above: ${totalAbove}, Total Criteria: ${totalCriteria}`); // Log m·ªõi
      
        console.log("[ui-sknv.js renderSknvDetail] Generating HTML..."); // Log m·ªõi
        detailsContainer.innerHTML = `
            <div class="mb-4 flex justify-between items-center">
                <button class="back-to-summary-btn text-blue-600 hover:underline font-semibold">‚Äπ Quay l·∫°i b·∫£ng t·ªïng h·ª£p</button>
                <button id="capture-sknv-detail-btn" class="action-btn action-btn--capture" title="Ch·ª•p ·∫£nh chi ti·∫øt">
                    <i data-feather="camera"></i>
                    <span>Ch·ª•p ·∫£nh</span>
                </button>
             </div>
            <div id="sknv-detail-capture-area">
                <div class="sknv-detail-header-card" data-capture-group="1">
                    <div class="sknv-card__avatar sknv-detail-avatar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>
                    <div class="sknv-detail-info">
                         <p class="name">${employeeData.hoTen} - ${employeeData.maNV}</p>
                         <p class="department">${employeeData.boPhan}</p>
                        <p class="kpi-summary">Ch·ªâ s·ªë tr√™n TB: <span class="text-green-600 font-bold">${totalAbove}</span> / T·ªïng: <span class="font-bold">${totalCriteria}</span></p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6" data-capture-layout="grid">
                    <div class="space-y-6" data-capture-group="1">
                         ${this._createDetailMetricGrid('Doanh thu', 'sknv-header-blue', 'trending-up', doanhThuData)}
                        ${this._createDetailMetricGrid('Hi·ªáu qu·∫£ khai th√°c', 'sknv-header-orange', 'award', hieuQuaData)}
                    </div>
                    <div class="space-y-6" data-capture-group="1">
                         ${this._createDetailMetricGrid('NƒÉng su·∫•t', 'sknv-header-green', 'dollar-sign', nangSuatData)}
                        ${this._createDetailMetricGrid('ƒê∆°n gi√°', 'sknv-header-yellow', 'tag', donGiaData)}
                     </div>
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6" data-capture-layout="grid">
                        <div data-capture-group="1" class="overflow-x-auto">${uiSknv.renderSknvQdcTable(employeeData, departmentAverages)}</div>
                        <div data-capture-group="1" class="overflow-x-auto">${uiSknv.renderSknvNganhHangTable(employeeData)}</div>
                    </div>
                     </div>
            </div>`;
            feather.replace();
        console.log("[ui-sknv.js renderSknvDetail] === Render complete ==="); // Log m·ªõi
    },
    
    displaySknvSummaryReport: (reportData) => {
        console.log("[ui-sknv.js displaySknvSummaryReport] === Starting render ==="); // Log m·ªõi
        const container = document.getElementById('sknv-summary-container');
        if (!container) {
            console.error("[ui-sknv.js displaySknvSummaryReport] Summary container not found."); // Log m·ªõi
            return;
        }

        if (!reportData || reportData.length === 0) {
            console.warn("[ui-sknv.js displaySknvSummaryReport] No report data provided."); // Log m·ªõi
            container.innerHTML = '<p class="text-gray-500 font-bold p-4">Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªáu su·∫•t ƒë·ªÉ hi·ªÉn th·ªã.</p>';
            return;
        }
        console.log(`[ui-sknv.js displaySknvSummaryReport] Input reportData length: ${reportData.length}`); // Log m·ªõi

        
        const summarizedData = reportData.map(employee => {
            const departmentAverages = services.calculateDepartmentAverages(employee.boPhan, reportData);
            const counts = {
                doanhthu: { above: 0, total: 7 },
                nangsuat: { above: 0, total: 7 },
                hieuqua: { above: 0, total: 6 },
                dongia: { above: 0, total: 7 },
                qdc: { above: 0, total: 0 } // *** Y√äU C·∫¶U 3 (v6.26): V√¥ hi·ªáu h√≥a QƒêC ***
            };
            const check = (group, value, avg, higherIsBetter = true) => {
                // *** Y√äU C·∫¶U 3 (v6.26): NgƒÉn QƒêC ƒë·∫øm ƒëi·ªÉm ***
                if (group === 'qdc') return;

                if (!isFinite(value) || avg === undefined || !isFinite(avg)) return;
                if (higherIsBetter ? (value >= avg) : (value <= avg)) counts[group].above++;
            };
            check('doanhthu', employee.doanhThu, departmentAverages.doanhThu);
            check('doanhthu', employee.doanhThuQuyDoi, departmentAverages.doanhThuQuyDoi);
            check('doanhthu', employee.hieuQuaQuyDoi, departmentAverages.hieuQuaQuyDoi);
            check('doanhthu', employee.dtCE, departmentAverages.dtCE);
            check('doanhthu', employee.dtICT, departmentAverages.dtICT);
            check('doanhthu', employee.doanhThuTraGop, departmentAverages.doanhThuTraGop);
            check('doanhthu', employee.tyLeTraCham, departmentAverages.tyLeTraCham);
            check('nangsuat', employee.tongThuNhap, departmentAverages.tongThuNhap);
            check('nangsuat', employee.thuNhapDuKien, departmentAverages.thuNhapDuKien);
            check('nangsuat', employee.gioCong, departmentAverages.gioCong);
            check('nangsuat', employee.gioCong > 0 ? employee.tongThuNhap / employee.gioCong : 0, departmentAverages.gioCong > 0 ? departmentAverages.tongThuNhap / departmentAverages.gioCong : 0);
            check('nangsuat', employee.gioCong > 0 ? employee.doanhThuQuyDoi / employee.gioCong : 0, departmentAverages.gioCong > 0 ? departmentAverages.doanhThuQuyDoi / departmentAverages.gioCong : 0);
            check('nangsuat', employee.thuongNong, departmentAverages.thuongNong);
            check('nangsuat', employee.thuongERP, departmentAverages.thuongERP);
            check('hieuqua', employee.pctPhuKien, departmentAverages.pctPhuKien);
            check('hieuqua', employee.pctGiaDung, departmentAverages.pctGiaDung);
            check('hieuqua', employee.pctMLN, departmentAverages.pctMLN);
            check('hieuqua', employee.pctSim, departmentAverages.pctSim);
            check('hieuqua', employee.pctVAS, departmentAverages.pctVAS);
            check('hieuqua', employee.pctBaoHiem, departmentAverages.pctBaoHiem);
            check('dongia', employee.donGiaTrungBinh, departmentAverages.donGiaTrungBinh);
            check('dongia', employee.donGiaTivi, departmentAverages.donGiaTivi);
            check('dongia', employee.donGiaTuLanh, departmentAverages.donGiaTuLanh);
            check('dongia', employee.donGiaMayGiat, departmentAverages.donGiaMayGiat);
            check('dongia', employee.donGiaMayLanh, departmentAverages.donGiaMayLanh);
            check('dongia', employee.donGiaDienThoai, departmentAverages.donGiaDienThoai);
            check('dongia', employee.donGiaLaptop, departmentAverages.donGiaLaptop);
            
            // Logic QƒêC c≈© v·∫´n ch·∫°y nh∆∞ng h√†m check() ·ªü tr√™n s·∫Ω ch·∫∑n n√≥ ƒë·∫øm ƒëi·ªÉm
            if(employee.qdc && departmentAverages.qdc) {
                for (const key in employee.qdc) {
                    if(departmentAverages.qdc[key] && employee.qdc[key].dtqd > 0) {
                        counts.qdc.total++; // V·∫´n ƒë·∫øm total ƒë·ªÉ logic c≈© kh√¥ng l·ªói, nh∆∞ng ƒëi·ªÉm above lu√¥n l√† 0
                        check('qdc', employee.qdc[key].dtqd, departmentAverages.qdc[key].dtqd);
                    }
                }
            }
            // *** Y√äU C·∫¶U 3 (v6.26): B·ªè QƒêC kh·ªèi t·ªïng ***
            const totalAbove = counts.doanhthu.above + counts.nangsuat.above + counts.hieuqua.above + counts.dongia.above; // + counts.qdc.above;
            const totalCriteria = counts.doanhthu.total + counts.nangsuat.total + counts.hieuqua.total + counts.dongia.total; // + counts.qdc.total;
            return { ...employee, summary: counts, totalAbove, totalCriteria };
        });
        console.log(`[ui-sknv.js displaySknvSummaryReport] Summarized data generated. First item:`, summarizedData[0]); // Log m·ªõi

        const subKpiGroups = [ 
            { key: 'doanhthu', label: 'Doanh Thu', icon: 'trending-up' },
            { key: 'nangsuat', label: 'NƒÉng Su·∫•t', icon: 'dollar-sign' },
            { key: 'hieuqua', label: 'Hi·ªáu Qu·∫£', icon: 'award' },
            { key: 'dongia', label: 'ƒê∆°n Gi√°', icon: 'tag' },
            // { key: 'qdc', label: 'QƒêC', icon: 'star' } // *** Y√äU C·∫¶U 3 (v6.26): B·ªè QƒêC kh·ªèi th·∫ª ***
        ];
        
        const groupedByDept = {}; 
        summarizedData.forEach(item => { 
            const dept = item.boPhan; 
            if (!groupedByDept[dept]) groupedByDept[dept] = []; 
            groupedByDept[dept].push(item);
        });

        const departmentOrder = utils.getSortedDepartmentList(reportData); 
        console.log("[ui-sknv.js displaySknvSummaryReport] Department order:", departmentOrder); // Log m·ªõi

        let finalCardsHtml = ''; 
        const gold_medal_svg = `<span class="medal-container"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="gold-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#FFDF00;stop-opacity:1" /><stop offset="100%" style="stop-color:#FFB800;stop-opacity:1" /></linearGradient><filter id="shadow" x="-20%" y="-20%" width="140%" height="140%"><feGaussianBlur in="SourceAlpha" stdDeviation="3"/><feOffset dx="2" dy="2" result="offsetblur"/><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/><circle cx="50" cy="45" r="38" fill="#BDBDBD"/><circle cx="50" cy="45" r="35" fill="url(#gold-grad)"/><circle cx="50" cy="45" r="28" fill="#FFC107" stroke="#FFFFFF" stroke-width="2"/><text x="50" y="52" font-family="Arial, sans-serif" font-size="28" font-weight="bold" fill="white" text-anchor="middle">1</text><path d="M 68 25 l 3 -6 l 3 6 l 6 3 l -6 3 l -3 6 l -3 -6 l -6 -3 Z" fill="white" opacity="0.8"/><path d="M 30 55 l 2 -4 l 2 4 l 4 2 l -4 2 l -2 4 l -2 -4 l -4 -2 Z" fill="white" opacity="0.5"/></svg></span>`;
        const silver_medal_svg = `<span class="medal-container"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="silver-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#F5F5F5;stop-opacity:1" /><stop offset="100%" style="stop-color:#B0BEC5;stop-opacity:1" /></linearGradient></defs><path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/><circle cx="50" cy="45" r="38" fill="#78909C"/><circle cx="50" cy="45" r="35" fill="url(#silver-grad)"/><circle cx="50" cy="45" r="28" fill="#B0BEC5" stroke="#FFFFFF" stroke-width="2"/><text x="50" y="52" font-family="Arial, sans-serif" font-size="28" font-weight="bold" fill="white" text-anchor="middle">2</text><path d="M 68 25 l 3 -6 l 3 6 l 6 3 l -6 3 l -3 6 l -3 -6 l -6 -3 Z" fill="white" opacity="0.8"/></svg></span>`;
        const bronze_medal_svg = `<span class="medal-container"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="bronze-grad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#FFCC80;stop-opacity:1" /><stop offset="100%" style="stop-color:#D84315;stop-opacity:1" /></linearGradient></defs><path d="M 20 75 L 35 95 L 35 75 L 50 90 L 65 75 L 65 95 L 80 75 L 50 85 Z" fill="#E53935"/><circle cx="50" cy="45" r="38" fill="#A1887F"/><circle cx="50" cy="45" r="35" fill="url(#bronze-grad)"/><circle cx="50" cy="45" r="28" fill="#D84315" stroke="#FFFFFF" stroke-width="2"/><text x="50" y="52" font-family="Arial, sans-serif" font-size="28" font-weight="bold" fill="white" text-anchor="middle">3</text><path d="M 68 25 l 3 -6 l 3 6 l 6 3 l -6 3 l -3 6 l -3 -6 l -6 -3 Z" fill="white" opacity="0.8"/></svg></span>`;
        
        departmentOrder.forEach(deptName => { 
            if (groupedByDept[deptName] && groupedByDept[deptName].length > 0) { 
                console.log(`[ui-sknv.js displaySknvSummaryReport] Rendering department group: ${deptName}`); 
                const sortedDeptEmployees = [...groupedByDept[deptName]].sort((a, b) => (b.totalAbove || 0) - (a.totalAbove || 0)); 

                // *** START: S·ª¨A L·ªñI (v6.31) - Th√™m data-capture-group="report-part" ***
                finalCardsHtml += `<div class="sknv-department-group" data-capture-group="report-part">`;
                // *** END: S·ª¨A L·ªñI (v6.31) ***
                
                // *** Y√äU C·∫¶U 1 (v6.28): B·ªè icon c·ªù ***
                finalCardsHtml += `<h4 class="sknv-department-header ${deptName.includes('T∆∞ V·∫•n - ƒêM') ? 'sknv-department-header--priority' : ''}">${deptName}</h4>`;
                finalCardsHtml += `<div class="sknv-summary-grid">`;

                sortedDeptEmployees.forEach((item, index) => { 
                    const performancePercentage = item.totalCriteria > 0 ? (item.totalAbove / item.totalCriteria) : 0; 
                    const performanceColorClass = performancePercentage >= 0.7 ? 'sknv-card-kpi-strong' : performancePercentage >= 0.4 ? 'sknv-card-kpi-medium' : 'sknv-card-kpi-weak'; 

                    // *** Y√äU C·∫¶U 2 (v6.30): Logic m·ªõi cho Huy ch∆∞∆°ng / V√≤ng tr√≤n x√°m ***
                    let medalHtml = '';
                    let avatarClass = 'sknv-card__avatar'; // Class m·∫∑c ƒë·ªãnh
                    const avatarContent = `<span class="sknv-card__avatar-rank">${index + 1}</span>`; // S·ªë lu√¥n lu√¥n c√≥

                    if (index === 0) {
                        medalHtml = gold_medal_svg;
                    } else if (index === 1) {
                        medalHtml = silver_medal_svg;
                    } else if (index === 2) {
                        medalHtml = bronze_medal_svg;
                    } else {
                        // H·∫°ng 4+
                        avatarClass += ' sknv-card__avatar--standard'; // Th√™m class ƒë·ªÉ CSS ƒë·ªïi th√†nh v√≤ng x√°m
                    }
                    // *** H·∫øt Logic v6.30 ***

                    const subKpisHtml = subKpiGroups.map(group => { 
                        if (!item.summary || !item.summary[group.key] || item.summary[group.key].total === 0) return '';
                        const subKpiPerf = item.summary[group.key].total > 0 ? item.summary[group.key].above / item.summary[group.key].total : 0;
                        const subKpiColorClass = subKpiPerf >= 0.7 ? 'strong' : subKpiPerf >= 0.4 ? 'medium' : 'weak';
                        const valueColorClass = subKpiPerf >= 0.5 ? 'text-blue-600' : 'text-red-600';

                        return `
                            <div class="sknv-card__sub-kpi-item ${subKpiColorClass}">
                                <div class="sknv-card__sub-kpi-header">
                                    <i data-feather="${group.icon}"></i>
                                    <span class="label">${group.label}</span>
                                </div>
                                <span class="value ${valueColorClass}">${item.summary[group.key].above}/${item.summary[group.key].total}</span>
                             </div>
                        `;
                    }).join(''); 
                    

                    finalCardsHtml += `
                        <div class="sknv-card interactive-row" data-employee-id="${item.maNV}" data-source-tab="sknv">
                            ${medalHtml}
                            <div class="sknv-card__header">
                                 <div class="${avatarClass}">
                                    ${avatarContent}
                                 </div>
                                <div class="sknv-card__info">
                                     <p class="name">${uiComponents.getShortEmployeeName(item.hoTen, item.maNV)}</p>
                                     <p class="id">${item.boPhan}</p>
                                </div>
                            </div>
                            <div class="sknv-card__main-kpi ${performanceColorClass}">
                                <span class="value">${item.totalAbove}</span>
                                <span class="total">/ ${item.totalCriteria}</span>
                                <span class="label">Ch·ªâ s·ªë tr√™n TB</span>
                            </div>
                            <div class="sknv-card__sub-kpi-grid">
                                 ${subKpisHtml}
                            </div>
                        </div>`; 
                });
                finalCardsHtml += `</div></div>`; 
            }
        });
        
        // *** START: S·ª¨A L·ªñI (v6.31) - X√≥a 'data-capture-group="1"' ***
        container.innerHTML = finalCardsHtml;
        // *** END: S·ª¨A L·ªñI (v6.31) ***

        if (typeof feather !== 'undefined') {
            feather.replace();
        }
        console.log("[ui-sknv.js displaySknvSummaryReport] === Render complete ==="); 
    },
    
    getSknvEvaluation: (value, avgValue, higherIsBetter = true) => {
        if (!isFinite(value) || avgValue === undefined || !isFinite(avgValue)) return { text: '-', class: '' };
        const isAbove = higherIsBetter ? (value >= avgValue) : (value <= avgValue);
        return {
            text: isAbove ? 'Tr√™n TB' : 'D∆∞·ªõi TB',
            // *** Y√äU C·∫¶U 2 (v6.26): S·ª≠a class m√†u v√†ng b·ªã l·ªói ***
            class: isAbove ? 'text-green-600' : 'text-yellow-600' // S·ª≠a t·ª´ 'text-yellow-6Doanhthu'
        };
    },
    
    renderSknvNganhHangTable(employeeData) {
        console.log("[ui-sknv.js renderSknvNganhHangTable] Starting render..."); 
        const { doanhThuTheoNganhHang } = employeeData;
        const sortState = appState.sortState.sknv_nganhhang_chitiet || { key: 'revenue', direction: 'desc' };
        const { key, direction } = sortState;
        
        const dataArray = Object.entries(doanhThuTheoNganhHang || {}) 
             .map(([name, values]) => ({ name, ...values }))
             .filter(item => (item.revenue || 0) > 0);
        console.log(`[ui-sknv.js renderSknvNganhHangTable] Data array length: ${dataArray.length}`); 

        if (dataArray.length === 0) return '<div class="bg-white rounded-xl shadow-md border border-gray-200 p-4"><div class="sknv-detail-card-header sknv-header-purple"><i data-feather="list" class="header-icon"></i><h4 class="text-lg font-bold">Doanh thu theo Ng√†nh h√†ng</h4></div><p class="p-4 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</p></div>';

        const sortedData = [...dataArray].sort((a,b) => direction === 'asc' ? (a[key] || 0) - (b[key] || 0) : (b[key] || 0) - (a[key] || 0)); 
        const headerClass = (sortKey) => `px-4 py-2 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;

        // *** Y√äU C·∫¶U 4 (v6.26): Th√™m w-full v√†o table ***
        return `<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden"><div class="sknv-detail-card-header sknv-header-purple"><i data-feather="list" class="header-icon"></i><h4 class="text-lg font-bold">Doanh thu theo Ng√†nh h√†ng</h4></div><div class="overflow-x-auto" style="max-height: 400px;"><table class="w-full text-sm table-bordered table-striped" data-table-type="sknv_nganhhang_chitiet">
            <thead class="sknv-subtable-header"><tr>
                <th class="${headerClass('name')}" data-sort="name">Ng√†nh h√†ng</th>
                <th class="${headerClass('quantity')} text-right" data-sort="quantity">SL</th>
                <th class="${headerClass('revenue')} text-right" data-sort="revenue">Doanh thu</th>
                 <th class="${headerClass('revenueQuyDoi')} text-right" data-sort="revenueQuyDoi">DTQƒê</th>
            </tr></thead>
            <tbody>${sortedData.map(item => `
                <tr class="border-t">
                    <td class="px-4 py-2 font-medium">${item.name}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumberOrDash(item.quantity)}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.revenue, 0)}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.revenueQuyDoi, 0)}</td>
                </tr>`).join('')}
            </tbody></table></div></div>`;
    },

    renderSknvQdcTable(employeeData, departmentAverages, countCallback, evaluationCounts) {
        console.log("[ui-sknv.js renderSknvQdcTable] Starting render..."); 
        const qdcData = employeeData.qdc;
        const avgQdcData = departmentAverages.qdc;

        if (!qdcData) { 
             console.warn("[ui-sknv.js renderSknvQdcTable] Employee QDC data is missing.");
             // evaluationCounts.qdc.total = 0; // ƒê√£ v√¥ hi·ªáu h√≥a ·ªü h√†m g·ªçi
             return '<div class="bg-white rounded-xl shadow-md border border-gray-200 p-4"><div class="sknv-detail-card-header sknv-header-indigo"><i data-feather="star" class="header-icon"></i><h4 class="text-lg font-bold">Nh√≥m h√†ng Quy ƒë·ªïi cao</h4></div><p class="p-4 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</p></div>';
        }

        const sortState = appState.sortState.sknv_qdc || { key: 'dtqd', direction: 'desc' };
        const { key, direction } = sortState;
        const sortedData = Object.entries(qdcData)
            .map(([id, values]) => ({ id, ...values }))
             .filter(item => (item.sl || 0) > 0) 
            .sort((a,b) => direction === 'asc' ? (a[key] || 0) - (b[key] || 0) : (b[key] || 0) - (a[key] || 0));
        console.log(`[ui-sknv.js renderSknvQdcTable] Sorted QDC data length: ${sortedData.length}`); 

        if (sortedData.length === 0) {
            // evaluationCounts.qdc.total = 0; // ƒê√£ v√¥ hi·ªáu h√≥a ·ªü h√†m g·ªçi
            return '<div class="bg-white rounded-xl shadow-md border border-gray-200 p-4"><div class="sknv-detail-card-header sknv-header-indigo"><i data-feather="star" class="header-icon"></i><h4 class="text-lg font-bold">Nh√≥m h√†ng Quy ƒë·ªïi cao</h4></div><p class="p-4 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</p></div>';
        }

        // evaluationCounts.qdc.total = 0; // ƒê√£ v√¥ hi·ªáu h√≥a ·ªü h√†m g·ªçi

        const headerClass = (sortKey) => `px-4 py-2 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;

        // *** Y√äU C·∫¶U 4 (v6.26): Th√™m w-full v√†o table ***
        // *** Y√äU C·∫¶U 2 (v6.26): B·ªè c·ªôt "ƒê√°nh gi√°" ***
        return `<div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden"><div class="sknv-detail-card-header sknv-header-indigo"><i data-feather="star" class="header-icon"></i><h4 class="text-lg font-bold">Nh√≥m h√†ng Quy ƒë·ªïi cao</h4></div><div class="overflow-x-auto" style="max-height: 400px;"><table class="w-full text-sm table-bordered table-striped" data-table-type="sknv_qdc">
             <thead class="sknv-subtable-header"><tr>
                <th class="${headerClass('name')}" data-sort="name">Nh√≥m h√†ng</th>
                <th class="${headerClass('sl')} text-right" data-sort="sl">SL</th>
                <th class="${headerClass('dtqd')} text-right" data-sort="dtqd">DTQƒê (Tr)</th>
            </tr></thead>
            <tbody>${sortedData.map(item => {
                // const avgValue = avgQdcData?.[item.id]?.dtqd;
                // const evaluation = uiSknv.getSknvEvaluation(item.dtqd, avgValue);
                // countCallback('qdc', item.dtqd, avgValue); // ƒê√£ v√¥ hi·ªáu h√≥a ·ªü h√†m g·ªçi
                return `<tr class="border-t">
                    <td class="px-4 py-2 font-medium">${item.name}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatNumberOrDash(item.sl)}</td>
                    <td class="px-4 py-2 text-right font-bold">${uiComponents.formatRevenue(item.dtqd)}</td>
                </tr>`}).join('')}
            </tbody></table></div></div>`;
    },

    // *** START: MODIFIED FUNCTION (v6.36) ***
    renderPastedCompetitionReport(reportData) {
        console.log(`%c[DEBUG renderPastedCompetitionReport] === B·∫Øt ƒë·∫ßu render (v6.36) ===`, "color: blue; font-weight: bold;");
        
        const container = document.getElementById('pasted-competition-report-container');
        if (!container) {
            console.error("[ui-sknv.js] Container '#pasted-competition-report-container' not found.");
            return;
        }

        // === START: THAY ƒê·ªîI (v6.45) ===
        // X√≥a preset c·ªßa view chi ti·∫øt (n·∫øu c√≥) ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n khi quay l·∫°i
        const detailContainer = document.getElementById('pasted-competition-detail-container');
        if (detailContainer) {
            delete detailContainer.dataset.capturePreset;
            console.log("[ui-sknv.js renderPastedCompetitionReport] ƒê√£ x√≥a capture preset kh·ªèi view chi ti·∫øt.");
        }
        // === END: THAY ƒê·ªîI (v6.45) ===

        const columnSettings = settingsService.loadPastedCompetitionViewSettings();
        const dragIconSVG = `<svg class="drag-handle-icon mr-2 cursor-grab" width="12" height="12" viewBox="0 0 10 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M4 2a1 1 0 10-2 0 1 1 0 002 0zM2 9a1 1 0 110-2 1 1 0 010 2zm0 5a1 1 0 110-2 1 1 0 010 2zm5-12a1 1 0 10-2 0 1 1 0 002 0zM7 9a1 1 0 110-2 1 1 0 010 2zm0 5a1 1 0 110-2 1 1 0 010 2z" fill="currentColor"></path></svg>`;

        if (!reportData || reportData.length === 0) {
            const placeholderToggles = columnSettings.length > 0 
                ? columnSettings.map(col => `
                    <div 
                        class="column-toggle-btn draggable-tag pasted-comp-toggle-btn ${col.visible ? 'active' : ''}" 
                        data-column-ten-goc="${col.tenGoc}"
                        title="${col.tenGoc} (${col.loaiSoLieu})">
                        ${dragIconSVG} <span>${col.label}</span>
                    </div>
                `).join('')
                : '<span class="text-sm text-gray-500">D√°n d·ªØ li·ªáu ƒë·ªÉ th·∫•y c√°c c·ªôt...</span>';
                
            container.innerHTML = `
                <div id="pasted-competition-column-toggles">
                    <span class="non-draggable">HI·ªÇN TH·ªä C·ªòT:</span>
                    ${placeholderToggles}
                </div>
                <div data-capture-group="pasted-competition">
                    <p class="text-gray-500 p-4">Kh√¥ng c√≥ d·ªØ li·ªáu thi ƒëua nh√¢n vi√™n. Vui l√≤ng d√°n d·ªØ li·ªáu ·ªü tab "C·∫≠p nh·∫≠t d·ªØ li·ªáu" v√† ƒë·∫£m b·∫£o b·ªô l·ªçc kh√¥ng qu√° h·∫πp.</p>
                </div>`;
            return;
        }
        
        const visibleColumns = columnSettings.filter(col => col.visible);
        
        let togglesHTML = `<div id="pasted-competition-column-toggles">
            <span class="non-draggable">HI·ªÇN TH·ªä C·ªòT:</span>
            ${columnSettings.map(col => `
                <div 
                    class="column-toggle-btn draggable-tag pasted-comp-toggle-btn ${col.visible ? 'active' : ''}"
                    data-column-ten-goc="${col.tenGoc}" 
                    title="${col.tenGoc} (${col.loaiSoLieu})">
                    ${dragIconSVG} <span>${col.label}</span>
                </div>
            `).join('')}
        </div>`;
        
        let finalHTML = ``; 

        const groupedByDept = {};
        reportData.forEach(item => {
            const dept = item.boPhan || 'Ch∆∞a ph√¢n lo·∫°i';
            if (!groupedByDept[dept]) groupedByDept[dept] = [];
            groupedByDept[dept].push(item);
        });

        const departmentOrder = utils.getSortedDepartmentList(reportData);
        const sortStateKey = 'sknv_thidua_pasted';
        
        const deptAverages = {}; 
        departmentOrder.forEach(deptName => {
            const deptData = groupedByDept[deptName];
            const deptAvg = {};
            columnSettings.forEach(col => {
                let total = 0;
                let count = 0;
                deptData.forEach(emp => {
                    const compData = emp.competitions.find(c => c.tenGoc === col.tenGoc);
                    const giaTri = compData?.giaTri || 0;
                    if (giaTri > 0) { 
                        total += giaTri;
                        count++;
                    }
                });
                deptAvg[col.tenGoc] = count > 0 ? total / count : 0;
            });
            deptAverages[deptName] = deptAvg;
        });
        
        uiSknv._lastPastedAverages = deptAverages;
        
        departmentOrder.forEach(deptName => {
            if (groupedByDept[deptName]) {
                const deptData = groupedByDept[deptName];
                
                const sortState = appState.sortState[sortStateKey] || { key: 'hoTen', direction: 'asc' };
                const { key, direction } = sortState;
                
                const sortedData = [...deptData].sort((a, b) => {
                    let valA, valB;
                    if (key.startsWith('comp_')) {
                        const sortCol = columnSettings.find(c => c.id === key);
                        if (!sortCol) return 0; 
                        valA = a.competitions.find(c => c.tenGoc === sortCol.tenGoc)?.giaTri || 0;
                        valB = b.competitions.find(c => c.tenGoc === sortCol.tenGoc)?.giaTri || 0;
                        return direction === 'asc' ? valA - valB : valB - valA;
                        
                    } else if (key === 'totalScore') {
                        const avgScores = deptAverages[deptName];
                        let scoreA = 0;
                        a.competitions.forEach(comp => {
                            if (avgScores[comp.tenGoc] > 0 && comp.giaTri >= avgScores[comp.tenGoc]) {
                                scoreA++;
                            }
                        });
                        let scoreB = 0;
                        b.competitions.forEach(comp => {
                            if (avgScores[comp.tenGoc] > 0 && comp.giaTri >= avgScores[comp.tenGoc]) {
                                scoreB++;
                            }
                        });
                        valA = scoreA;
                        valB = scoreB;
                        return direction === 'asc' ? valA - valB : valB - valA;
                        
                    } else { // S·∫Øp x·∫øp theo 'hoTen'
                        valA = a[key] || ''; 
                        valB = b[key] || '';
                        return direction === 'asc' 
                            ? valA.localeCompare(valB)
                            : valB.localeCompare(valA);
                    }
                });

                let titleClass = '';
                 if (deptName.includes('T∆∞ V·∫•n')) titleClass = 'department-header-tv';
                else if (deptName.includes('Kho')) titleClass = 'department-header-kho';
                else if (deptName.includes('Trang Tr√≠')) titleClass = 'department-header-tt';

                const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;

                finalHTML += `<div class="department-block">
                    <h4 class="text-lg font-bold p-4 border-b border-gray-200 ${titleClass}">${deptName}</h4>
                    <div class="overflow-x-auto sknv-pasted-competition-scroller"> 
                    
                    <table class="text-sm text-left text-gray-600 table-bordered table-striped" data-table-type="${sortStateKey}" data-capture-columns="${2 + visibleColumns.length}">
                         <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
                            <tr>
                                <th class="${headerClass('hoTen')} sticky-col sticky-col-1" data-sort="hoTen" style="min-width: 150px; white-space: nowrap;">Nh√¢n vi√™n <span class="sort-indicator"></span></th>
                                <th class="${headerClass('totalScore')} sticky-col sticky-col-2 text-center" data-sort="totalScore" style="min-width: 80px;">T·ªïng ƒë·∫°t <span class="sort-indicator"></span></th>
                                ${visibleColumns.map((header, index) => `
                                    <th class="${headerClass(header.id)} text-center header-group-${index % 12 + 1}" 
                                         data-sort="${header.id}"
                                         title="${header.tenGoc} (${header.loaiSoLieu})">
                                        ${header.label}
                                        <span class="sort-indicator"></span>
                                    </th>
                                `).join('')}
                                </tr>
                            </thead>
                        <tbody>`;

                const deptTotals = new Map();
                const validEmployeeCount = new Map();
                visibleColumns.forEach(col => {
                    deptTotals.set(col.tenGoc, 0);
                    validEmployeeCount.set(col.tenGoc, 0);
                });

                sortedData.forEach(item => {
                    let totalScore = 0;
                    const deptAvg = deptAverages[item.boPhan] || {};
                    item.competitions.forEach(comp => {
                        const avg = deptAvg[comp.tenGoc];
                        if (avg > 0 && comp.giaTri >= avg) {
                            totalScore++;
                        }
                    });
                    
                    finalHTML += `<tr class="interactive-row hover:bg-gray-50" data-employee-id="${item.maNV}" data-source-tab="sknv-thidua-pasted">
                        <td class="px-4 py-2 font-semibold whitespace-nowrap sticky-col sticky-col-1 employee-name-cell">
                            <a href="#">${uiComponents.getShortEmployeeName(item.hoTen, item.maNV)}</a>
                        </td>
                         <td class="px-2 py-2 text-center font-bold text-green-600 sticky-col sticky-col-2">${totalScore}</td>
                        ${visibleColumns.map(col => {
                             const compData = item.competitions.find(c => c.tenGoc === col.tenGoc);
                             const giaTri = compData?.giaTri || 0;
                             let formattedValue = '-';
                            
                            if (giaTri !== 0) {
                                formattedValue = uiComponents.formatNumber(giaTri, 0);
                                deptTotals.set(col.tenGoc, deptTotals.get(col.tenGoc) + giaTri);
                                validEmployeeCount.set(col.tenGoc, validEmployeeCount.get(col.tenGoc) + 1);
                            }
                 
                            const avg = deptAverages[item.boPhan]?.[col.tenGoc] || 0;
                            let cellClass = (col.loaiSoLieu === 'SLLK') ? 'text-right font-bold' : 'text-right font-bold text-blue-600';
                            if (avg > 0 && giaTri < avg) {
                                cellClass += ' cell-performance is-below';
                            }
                            return `<td class="${cellClass} px-2 py-2">${formattedValue}</td>`;
                        }).join('')}
                    </tr>`;
                });

                finalHTML += `</tbody>
                     <tfoot class="table-footer font-bold">
                        <tr class="bg-gray-100">
                            <td class="px-4 py-2 text-left sticky-col sticky-col-1">T·ªïng</td>
                            <td class="px-2 py-2 sticky-col sticky-col-2"></td> ${visibleColumns.map(col => {
                                const total = deptTotals.get(col.tenGoc) || 0;
                                const formattedTotal = total === 0 ? '-' : uiComponents.formatNumber(total, 0);
                                return `<td class="px-2 py-2 text-right">${formattedTotal}</td>`;
                            }).join('')}
                        </tr>
                        <tr class="bg-gray-100">
                            <td class="px-4 py-2 text-left sticky-col sticky-col-1">Trung B√¨nh</td>
                            <td class="px-2 py-2 sticky-col sticky-col-2"></td> ${visibleColumns.map(col => {
                                const total = deptTotals.get(col.tenGoc) || 0;
                                const count = validEmployeeCount.get(col.tenGoc) || 0;
                                const avg = count > 0 ? total / count : 0;
                                const formattedAvg = avg === 0 ? '-' : uiComponents.formatNumber(avg, 0);
                                return `<td class="px-2 py-2 text-right">${formattedAvg}</td>`;
                            }).join('')}
                        </tr>
                    </tfoot>
                </table></div></div>`; 
            }
        });

        container.innerHTML = `
            ${togglesHTML} 
            <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden" data-capture-group="pasted-competition">
                ${finalHTML}
            </div>`;
        
        setTimeout(() => {
            const tableEl = container.querySelector('table');
            const tableContainer = container.querySelector('.sknv-pasted-competition-scroller');
            const parentContainer = document.getElementById('pasted-competition-report-container');
            const mainContentEl = document.getElementById('main-content');

            if (tableEl && tableContainer && parentContainer && mainContentEl) {
                console.log(`%c[DEBUG renderPastedCompetitionReport] K√≠ch th∆∞·ªõc sau render (v6.25):`, "color: #00008B; font-weight: bold;");
                console.log(`  > 1. B·∫£ng (<table>): scrollWidth: ${tableEl.scrollWidth}px`);
                console.log(`  > 2. Container Cu·ªôn (.sknv-pasted-competition-scroller): clientWidth: ${tableContainer.clientWidth}px`);
                console.log(`  > 3. Container B√°o C√°o (#pasted-competition-report-container): clientWidth: ${parentContainer.clientWidth}px`);
                console.log(`  > 4. Main Content (#main-content): clientWidth: ${mainContentEl.clientWidth}px`);
                console.log(`%c[DEBUG renderPastedCompetitionReport] CH·∫®N ƒêO√ÅN (v6.25):`, "color: #00008B; font-weight: bold;");
                if (tableEl.scrollWidth > tableContainer.clientWidth) {
                    console.log(`%c  > T·ªêT: B·∫£ng (1) r·ªông h∆°n Container Cu·ªôn (2). Thanh tr∆∞·ª£t N√äN xu·∫•t hi·ªán.`, "color: green;");
                } else {
                    console.log(`%c  > L·ªñI: B·∫£ng (1) KH√îNG r·ªông h∆°n Container Cu·ªôn (2). Thanh tr∆∞·ª£t s·∫Ω KH√îNG xu·∫•t hi·ªán.`, "color: red; font-weight: bold;");
                }
                if (tableContainer.clientWidth >= mainContentEl.clientWidth) {
                     console.log(`%c  > L·ªñI: Container Cu·ªôn (2) ƒëang r·ªông b·∫±ng ho·∫∑c h∆°n Main Content (4).`, "color: red; font-weight: bold;");
                } else {
                     console.log(`%c  > T·ªêT: Container Cu·ªôn (2) h·∫πp h∆°n Main Content (4).`, "color: green;");
                }
            } else {
                console.error("[DEBUG] Kh√¥ng t√¨m th·∫•y m·ªôt trong c√°c ph·∫ßn t·ª≠ ch·∫©n ƒëo√°n.");
            }
        }, 0);
    },
    // *** END: MODIFIED FUNCTION (v6.36) ***

    // === START: PHI√äN B·∫¢N M·ªöI v6.39 (Thay th·∫ø v6.38) ===
    /**
     * Render giao di·ªán chi ti·∫øt (infographic) cho m·ªôt nh√¢n vi√™n trong tab "Thi ƒëua NV LK".
     * @param {Object} employeeData - ƒê·ªëi t∆∞·ª£ng d·ªØ li·ªáu c·ªßa nh√¢n vi√™n t·ª´ appState.pastedThiDuaReportData.
     * @param {Object} allDeptAverages - ƒê·ªëi t∆∞·ª£ng ch·ª©a TBT c·ªßa t·∫•t c·∫£ b·ªô ph·∫≠n (uiSknv._lastPastedAverages).
     */
    renderPastedCompetitionDetail(employeeData, allDeptAverages) {
        const container = document.getElementById('pasted-competition-detail-container');
        if (!container) {
            console.error("[ui-sknv.js] Container '#pasted-competition-detail-container' not found.");
            return;
        }

        // === START: THAY ƒê·ªîI (v6.45) ===
        // G√°n preset v√†o container cha, ƒë·ªÉ capture service c√≥ th·ªÉ ƒë·ªçc ƒë∆∞·ª£c
        container.dataset.capturePreset = 'mobile-portrait';
        console.log("[ui-sknv.js renderPastedCompetitionDetail] ƒê√£ g√°n 'mobile-portrait' preset v√†o container cha.");
        // === END: THAY ƒê·ªîI (v6.45) ===

        if (!employeeData || !allDeptAverages) {
            container.innerHTML = `
                <div class="mb-4">
                    <button class="back-to-summary-btn text-blue-600 hover:underline font-semibold">‚Äπ Quay l·∫°i b·∫£ng t·ªïng h·ª£p</button>
                </div>
                <p class="text-red-500">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu chi ti·∫øt cho nh√¢n vi√™n ho·∫∑c d·ªØ li·ªáu TBT b·ªô ph·∫≠n.</p>`;
            return;
        }

        const employeeInfo = appState.employeeMaNVMap.get(String(employeeData.maNV));
        const hoTen = employeeInfo?.hoTen || employeeData.hoTen;
        const boPhan = employeeInfo?.boPhan || employeeData.boPhan;
        const deptAvg = allDeptAverages[boPhan] || {};

        const nhomDat = [];
        const nhomGanDat = [];
        const nhomCanCoGang = [];
        let totalCriteria = 0; // Ch·ªâ ƒë·∫øm c√°c ng√†nh h√†ng c√≥ TBT > 0

        employeeData.competitions.forEach(comp => {
            const avg = deptAvg[comp.tenGoc] || 0;
            const giaTri = comp.giaTri || 0;
            const chenhLech = giaTri - avg;
            const percentOfAvg = (avg > 0) ? (giaTri / avg) : (giaTri > 0 ? Infinity : 0);

            const cardData = {
                name: comp.tenNganhHang,
                originalName: comp.tenGoc,
                value: giaTri,
                average: avg,
                diff: chenhLech,
                // T√≠nh % thanh ti·∫øn ƒë·ªô: n·∫øu ƒë·∫°t th√¨ 100%, n·∫øu ch∆∞a ƒë·∫°t th√¨ (giaTri / avg * 100)
                progressPercent: (avg > 0) ? Math.min((giaTri / avg) * 100, 100) : (giaTri > 0 ? 100 : 0)
            };

            if (avg > 0) {
                totalCriteria++; // Ch·ªâ ƒë·∫øm n·∫øu c√≥ m·ª•c ti√™u (TB > 0)
                if (percentOfAvg >= 1.0) {
                    nhomDat.push(cardData);
                } else if (percentOfAvg >= 0.7) {
                    nhomGanDat.push(cardData);
                } else {
                    nhomCanCoGang.push(cardData);
                }
            } else if (giaTri > 0) {
                // Kh√¥ng c√≥ TBT, nh∆∞ng c√≥ b√°n -> coi nh∆∞ "ƒê·∫°t" (Ghi nh·∫≠n)
                cardData.progressPercent = 100; // Thanh ƒë·∫ßy 
                nhomDat.push(cardData);
            } else {
                // Kh√¥ng TBT, kh√¥ng b√°n -> Nh√≥m "C·∫ßn c·ªë g·∫Øng"
                nhomCanCoGang.push(cardData);
            }
        });

        // S·∫Øp x·∫øp n·ªôi b·ªô c√°c nh√≥m theo ch√™nh l·ªách (cao -> th·∫•p)
        const sortInternal = (a, b) => b.diff - a.diff;
        nhomDat.sort(sortInternal);
        nhomGanDat.sort(sortInternal);
        nhomCanCoGang.sort(sortInternal);

        const totalDat = nhomDat.length;
        const totalGanDat = nhomGanDat.length;
        const totalCanCoGang = nhomCanCoGang.length;
        
        // T·ª∑ l·ªá ƒë·∫°t ch·ªâ t√≠nh tr√™n c√°c ng√†nh c√≥ TBT > 0
        const tyLeDat = totalCriteria > 0 ? (nhomDat.filter(item => item.average > 0).length / totalCriteria) : 0;
        
        // === START: THAY ƒê·ªîI (v6.39) - Y√™u c·∫ßu 2 ===
        // S·ª≠a logic g√°n class m√†u. D√πng is-positive/is-negative thay v√¨ tailwind class
        // v√† s·ª≠a logic th√†nh > 0.5 (tr√™n 50%)
        const tyLeDatClass = tyLeDat > 0.5 ? 'is-positive' : 'is-negative';
        // === END: THAY ƒê·ªîI (v6.39) ===

        // === START: THAY ƒê·ªîI (v6.42) - Y√™u c·∫ßu 2 & 4 ===
        // Render c√°c th·∫ª KPI t√≥m t·∫Øt
        // ƒê·ªïi md:grid-cols-3 -> md:grid-cols-4
        // S·∫Øp x·∫øp l·∫°i: ƒê·∫°t, T·ª∑ l·ªá, G·∫ßn ƒê·∫°t, C·∫ßn C·ªë G·∫Øng
        // Th√™m class m√†u ƒë·ªông: is-dat, is-gan-dat, is-can-co-gang
        const kpiHtml = `
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-6">
                <div class="rt-infographic-summary-card text-center">
                    <div class="label">Ng√†nh h√†ng ƒê·∫°t</div>
                    <div class="value is-dat">
                         ${totalDat} <span class="text-2xl text-gray-400">/ ${employeeData.competitions.length}</span>
                    </div>
                </div>
                <div class="rt-infographic-summary-card text-center">
                    <div class="label">T·ª∑ l·ªá ƒë·∫°t (tr√™n nh√≥m c√≥ TB)</div>
                    <div class="value ${tyLeDatClass}">
                         ${uiComponents.formatPercentage(tyLeDat)}
                    </div>
                </div>
                <div class="rt-infographic-summary-card text-center">
                    <div class="label">Ng√†nh h√†ng G·∫ßn ƒê·∫°t (>=70%)</div>
                    <div class="value is-gan-dat">${totalGanDat}</div>
                </div>
                <div class="rt-infographic-summary-card text-center">
                    <div class="label">Ng√†nh h√†ng C·∫ßn C·ªë G·∫Øng</div>
                    <div class="value is-can-co-gang">${totalCanCoGang}</div>
                </div>
            </div>
        `;
        // === END: THAY ƒê·ªîI (v6.42) ===

        // === START: THAY ƒê·ªîI (v6.38) - Y√™u c·∫ßu 3 ===
        // Render 3 "L√†n ƒë∆∞·ªùng" (h√†ng) ri√™ng bi·ªát
        const columnsHtml = `
            <div class="mt-6 space-y-6">
                
                <div class="sknv-thidua-lane bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
                    <div class="sknv-thidua-column-header header-blue">
                        <i data-feather="check-circle"></i>
                        <h4>Nh√≥m ƒê·∫°t (${totalDat})</h4>
                    </div>
                    <div class="sknv-thidua-horizontal-content">
                        ${nhomDat.length > 0 ? nhomDat.map(item => this._renderThiduaItemCard(item, 'bg-blue-500')).join('') : '<p class="empty-col-msg">Kh√¥ng c√≥ ng√†nh h√†ng n√†o.</p>'}
                    </div>
                </div>

                <div class="sknv-thidua-lane bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
                    <div class="sknv-thidua-column-header header-yellow">
                        <i data-feather="alert-triangle"></i>
                        <h4>Nh√≥m G·∫ßn ƒê·∫°t (${totalGanDat})</h4>
                    </div>
                    <div class="sknv-thidua-horizontal-content">
                        ${nhomGanDat.length > 0 ? nhomGanDat.map(item => this._renderThiduaItemCard(item, 'bg-yellow-500')).join('') : '<p class="empty-col-msg">Kh√¥ng c√≥ ng√†nh h√†ng n√†o.</p>'}
                    </div>
                </div>

                <div class="sknv-thidua-lane bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
                    <div class="sknv-thidua-column-header header-red">
                        <i data-feather="x-circle"></i>
                        <h4>Nh√≥m C·∫ßn C·ªë G·∫Øng (${totalCanCoGang})</h4>
                    </div>
                    <div class="sknv-thidua-horizontal-content">
                        ${nhomCanCoGang.length > 0 ? nhomCanCoGang.map(item => this._renderThiduaItemCard(item, 'bg-red-500')).join('') : '<p class="empty-col-msg">Kh√¥ng c√≥ ng√†nh h√†ng n√†o.</p>'}
                    </div>
                </div>

            </div>
        `;
        // === END: THAY ƒê·ªîI (v6.38) ===

        // Render to√†n b·ªô
        container.innerHTML = `
            <div class="mb-4 flex justify-between items-center">
                <button class="back-to-summary-btn text-blue-600 hover:underline font-semibold">‚Äπ Quay l·∫°i b·∫£ng t·ªïng h·ª£p</button>
            </div>
            
            <div id="sknv-thidua-detail-capture-area" class="max-w-7xl mx-auto"> 
            <div class="sknv-detail-header-card bg-purple-50 border-purple-200 border-t-purple-500">
                <div class="sknv-card__avatar sknv-detail-avatar bg-purple-200">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="text-purple-800"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>
                    <div class="sknv-detail-info">
                        <p class="name text-purple-800">${hoTen} - ${employeeData.maNV}</p>
                        <p class="department text-gray-700">${boPhan}</p>
                    </div>
                </div>

                ${kpiHtml}

                ${columnsHtml}
                
            </div>
        `;
        
        feather.replace();
    },
    // === END: PHI√äN B·∫¢N M·ªöI v6.39 ===

    // === START: H√ÄM HELPER M·ªöI (v6.37) ===
    /**
     * @private
     * Render m·ªôt th·∫ª ng√†nh h√†ng cho giao di·ªán infographic chi ti·∫øt.
     * @param {Object} item - D·ªØ li·ªáu c·ªßa m·ªôt ng√†nh h√†ng.
     * @param {string} colorClass - Class m√†u cho thanh ti·∫øn ƒë·ªô (v√≠ d·ª•: 'bg-blue-500').
     */
    _renderThiduaItemCard(item, colorClass) {
        const diffClass = item.diff > 0 ? 'text-green-600' : (item.diff < 0 ? 'text-red-600' : 'text-gray-500');
        const diffSign = item.diff > 0 ? '+' : '';
        
        // Ch·ªâ hi·ªÉn th·ªã ch√™nh l·ªách n·∫øu c√≥ TB
        let diffText = (item.average > 0) 
            ? `${diffSign}${uiComponents.formatNumberOrDash(item.diff, 1)}` 
            : '-';
        
        // Tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát: Ghi nh·∫≠n (C√≥ b√°n nh∆∞ng kh√¥ng c√≥ TB)
        if (item.average === 0 && item.value > 0) {
            diffText = 'Ghi nh·∫≠n';
        }

        return `
        <div class="sknv-thidua-item-card">
            <p class="item-card-title" title="${item.originalName}">${item.name}</p>
            <div class="item-card-progress-bar-container">
                <div class="item-card-progress-bar ${colorClass}" style="width: ${item.progressPercent}%;"></div>
            </div>
            <div class="item-card-metrics">
                <span>Th·ª±c hi·ªán: <strong>${uiComponents.formatNumberOrDash(item.value, 1)}</strong></span>
                <span>TB B·ªô ph·∫≠n: <strong>${uiComponents.formatNumberOrDash(item.average, 1)}</strong></span>
                <span class="${diffClass}">Ch√™nh l·ªách: <strong>${diffText}</strong></span>
            </div>
        </div>
        `;
    }
    // === END: H√ÄM HELPER M·ªöI (v6.37) ===

    // ========== START: H√ÄM M·ªöI (v4.4) ==========
    , // Th√™m d·∫•u ph·∫©y
    /**
     * Render b√°o c√°o S·∫£n Ph·∫©m ƒê·∫∑c Quy·ªÅn (SPƒêQ).
     * @param {HTMLElement} container - Container ƒë·ªÉ render (spContainer).
     * @param {Array} reportData - D·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω t·ª´ services.calculateSpecialProductReport.
     */
    renderSpecialProgramReport(container, reportData) {
        // === START: THAY ƒê·ªîI V4.8 (G·ª° b·ªè container, return HTML) ===
        if (!reportData || reportData.length === 0) {
            // V·∫´n render th√¥ng b√°o l·ªói v√†o container, nh∆∞ng return chu·ªói r·ªóng
            // (Ho·∫∑c, ch√∫ng ta c√≥ th·ªÉ return chu·ªói HTML th√¥ng b√°o l·ªói)
            if (container) { // Ki·ªÉm tra container ph√≤ng tr∆∞·ªùng h·ª£p n√≥ b·ªã g·ª° b·ªè ·ªü file kh√°c
                container.innerHTML = '<div class="p-4 bg-yellow-50 text-yellow-800 border border-yellow-200 rounded-lg italic">ƒê√£ c√≥ ch∆∞∆°ng tr√¨nh SP ƒê·∫∑c Quy·ªÅn ƒë∆∞·ª£c thi·∫øt l·∫≠p, nh∆∞ng ch∆∞a ph√°t sinh doanh s·ªë cho c√°c nh√≥m h√†ng n√†y.</div>';
            }
            return ''; // Tr·∫£ v·ªÅ chu·ªói r·ªóng
        }

        let finalHTML = ''; // Kh√¥ng b·ªçc trong grid
        reportData.forEach((programResult, index) => {
            if (programResult.employeeData.length === 0) return;
            finalHTML += this._renderSingleSpecialProgramTable(programResult, index);
        });
        
        if (container) {
             container.innerHTML = ''; // X√≥a n·ªôi dung c≈© (n·∫øu c√≥)
        }
        return finalHTML; // Tr·∫£ v·ªÅ chu·ªói HTML
        // === END: THAY ƒê·ªîI V4.8 ===
    },

    /**
     * @private
     * Render m·ªôt b·∫£ng chi ti·∫øt cho m·ªôt ch∆∞∆°ng tr√¨nh SPƒêQ.
     */
    _renderSingleSpecialProgramTable(programResult, index) {
        const { program, employeeData } = programResult;
        const sortStateKey = `sknv_spdq_${program.id || index}`;
        const sortState = appState.sortState[sortStateKey] || { key: 'tyLeSL', direction: 'desc' };
        const { key, direction } = sortState;

        const sortedData = [...employeeData].sort((a, b) => {
            const valA = a[key] || 0;
            const valB = b[key] || 0;
            return direction === 'asc' ? valA - valB : valB - valA;
        });

        // T√≠nh t·ªïng
        const totals = employeeData.reduce((acc, item) => {
            acc.slDacQuyen += item.slDacQuyen;
            acc.slNhomHang += item.slNhomHang;
            acc.dtDacQuyen += item.dtDacQuyen;
            acc.dtNhomHang += item.dtNhomHang;
            return acc;
        }, { slDacQuyen: 0, slNhomHang: 0, dtDacQuyen: 0, dtNhomHang: 0 });

        totals.tyLeSL = totals.slNhomHang > 0 ? (totals.slDacQuyen / totals.slNhomHang) : 0;
        totals.tyLeDT = totals.dtNhomHang > 0 ? (totals.dtDacQuyen / totals.dtNhomHang) : 0;
        
        const headerClass = (sortKey) => `px-4 py-3 sortable ${key === sortKey ? (direction === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}`;
        
        return `
            <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col" data-capture-group="special-program-${program.id}">
                <div class="p-4 bg-green-50 border-b-2 border-green-200">
                    <h3 class="text-lg font-bold text-green-800 uppercase">${program.name}</h3>
                    <p class="text-xs text-green-700 font-medium">Nh√≥m h√†ng: ${program.groups.join(', ')}</p>
                </div>
                <div class="overflow-x-auto flex-grow">
                    <table class="min-w-full text-sm text-left text-gray-600 table-bordered table-striped" data-table-type="${sortStateKey}">
                        <thead class="text-xs text-slate-800 uppercase bg-slate-200 font-bold">
                            <tr>
                                <th rowspan="2" class="${headerClass('hoTen')}" data-sort="hoTen">Nh√¢n vi√™n <span class="sort-indicator"></span></th>
                                <th colspan="3" class="px-4 py-2 text-center header-group-1">S·ªë L∆∞·ª£ng</th>
                                <th colspan="3" class="px-4 py-2 text-center header-group-2">Doanh Thu (Tr)</th>
                            </tr>
                            <tr>
                                <th class="${headerClass('slDacQuyen')} text-right" data-sort="slDacQuyen">SL SPƒêQ <span class="sort-indicator"></span></th>
                                <th class="${headerClass('slNhomHang')} text-right" data-sort="slNhomHang">SL Nh√≥m <span class="sort-indicator"></span></th>
                                <th class="${headerClass('tyLeSL')} text-right header-highlight" data-sort="tyLeSL">% SL <span class="sort-indicator"></span></th>
                                <th class="${headerClass('dtDacQuyen')} text-right" data-sort="dtDacQuyen">DT SPƒêQ <span class="sort-indicator"></span></th>
                                <th class="${headerClass('dtNhomHang')} text-right" data-sort="dtNhomHang">DT Nh√≥m <span class="sort-indicator"></span></th>
                                <th class="${headerClass('tyLeDT')} text-right header-highlight" data-sort="tyLeDT">% DT <span class="sort-indicator"></span></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedData.map(item => this._renderSpecialProgramRow(item)).join('')}
                        </tbody>
                        <tfoot class="table-footer font-bold">
                            ${this._renderSpecialProgramRow(totals, true)}
                        </tfoot>
                    </table>
                </div>
            </div>`;
    },

    /**
     * @private
     * Render m·ªôt d√≤ng (ho·∫∑c footer) cho b·∫£ng SPƒêQ.
     */
    _renderSpecialProgramRow(item, isFooter = false) {
        const name = isFooter ? 'T·ªïng' : uiComponents.getShortEmployeeName(item.hoTen, item.maNV);
        const cellTag = isFooter ? 'td' : 'td'; // V·∫´n d√πng td cho footer
        const rowClass = isFooter ? '' : 'class="interactive-row hover:bg-gray-50"'; // Th√™m row class

        return `
            <tr ${rowClass}>
                <${cellTag} class="px-4 py-2 font-semibold ${isFooter ? '' : 'line-clamp-2'}">${name}</${cellTag}>
                <${cellTag} class="px-2 py-2 text-right font-bold">${uiComponents.formatNumberOrDash(item.slDacQuyen)}</${cellTag}>
                <${cellTag} class="px-2 py-2 text-right font-bold">${uiComponents.formatNumberOrDash(item.slNhomHang)}</${cellTag}>
                <${cellTag} class="px-2 py-2 text-right font-bold ${item.tyLeSL === 0 ? '' : 'text-blue-600'}">${uiComponents.formatPercentage(item.tyLeSL)}</${cellTag}>
                <${cellTag} class="px-2 py-2 text-right font-bold">${uiComponents.formatRevenue(item.dtDacQuyen)}</${cellTag}>
                <${cellTag} class="px-2 py-2 text-right font-bold">${uiComponents.formatRevenue(item.dtNhomHang)}</${cellTag}>
                <${cellTag} class="px-2 py-2 text-right font-bold ${item.tyLeDT === 0 ? '' : 'text-green-600'}">${uiComponents.formatPercentage(item.tyLeDT)}</${cellTag}>
            </tr>
        `;
    }
    // ========== END: H√ÄM M·ªöI (v4.4) ==========
};
--- END FILE: ./ui-sknv.js ---

--- START FILE: ./ui-thidua-vung.js ---
// Version 1.7 - Fix syntax error (remove semicolon after arrow function)
// Version 1.6 - Add conditional coloring for 'T·ª∑ l·ªá ƒë·∫°t' summary value
// Version 1.5 - Display 'Lay Top' data and finalize UI
// MODULE: UI THI ƒêUA V√ôNG
// Ch·ª©a c√°c h√†m render giao di·ªán cho tab "Thi ƒëua v√πng".

import { uiComponents } from './ui-components.js';

export const uiThiDuaVung = {
    renderThiDuaVungInfographic(reportData) {
        const container = document.getElementById('thidua-vung-infographic-container');
        if (!container) return;
        if (!reportData) {
            container.innerHTML = `<div class="placeholder-message">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho si√™u th·ªã ƒë√£ ch·ªçn.</div>`;
            return;
        }

        const { summary, coGiai, sapCoGiai, tiemNang, canCoGangNhieu } = reportData;

        // --- Helper function to find correct key regardless of case ---
        const findKey = (item, keyword) => {
            if (!item) return keyword; // Return keyword if item is null/undefined
            // Find the key in the item that includes the keyword (case-insensitive)
            return Object.keys(item).find(k => k.trim().toLowerCase().includes(keyword.toLowerCase())) || keyword; // Return keyword if no match found
        } // <<< *** ƒê√É X√ìA D·∫§U ; ·ªû ƒê√ÇY ***

        // Find the first item with data to reliably get keys
        const firstItem = coGiai[0] || sapCoGiai[0] || tiemNang[0] || canCoGangNhieu[0];
        const keyMap = {
            sieuThi: findKey(summary, 'si√™u th·ªã'),
            tongThuongTamTinh: findKey(summary, 't·ªïng th∆∞·ªüng t·∫°m t·ªânh'),
            slThiDua: findKey(summary, 'sl nh thi ƒëua'),
            slDat: findKey(summary, 'sl nh >100%'),
            tyLeDat: findKey(summary, 't·ª∑ l·ªá nh ƒë·∫°t >100%'),
            slCoGiai: findKey(summary, 'sl nh d·ª± ki·∫øn ƒë·∫°t gi·∫£i'),
            nganhHang: findKey(firstItem, 'ng√†nh h√†ng'),
            phanTramDuKien: findKey(firstItem, '% d·ª± ki·∫øn'),
            duKienVuot: findKey(firstItem, 'd·ª± ki·∫øn d.thu'),
            hangVuotTroi: findKey(firstItem, 'h·∫°ng v∆∞·ª£t tr·ªôi'),
            hangTarget: findKey(firstItem, 'h·∫°ng % target'),
            tongThuong: findKey(firstItem, 't·ªïng th∆∞·ªüng'),
            hangCoGiaiKenh: 'hangCoGiaiKenh' // S·ª≠ d·ª•ng key ƒë√£ ƒë∆∞·ª£c chu·∫©n h√≥a trong services.js
        };

        const renderCoGiaiItem = (item) => `
            <div class="tdv-item-card">
                <p class="tdv-item-card__title">${item[keyMap.nganhHang]}</p>
                <div class="tdv-progress-bar-container">
                    <div class="tdv-progress-bar tdv-progress-bar--blue" style="width: ${Math.min(item[keyMap.phanTramDuKien] * 100, 100)}%;"></div>
                    <span class="tdv-progress-bar__text">${uiComponents.formatPercentage(item[keyMap.phanTramDuKien])}</span>
                </div>
                <div class="tdv-item-card__details">
                    <span>V∆∞·ª£t: <strong>${uiComponents.formatNumber(item[keyMap.duKienVuot])}</strong></span>
                    <span>H·∫°ng DT/SL: <strong>${item[keyMap.hangVuotTroi]}</strong></span>
                    <span>H·∫°ng %: <strong>${item[keyMap.hangTarget]}</strong></span>
                    <span class="tdv-item-card__prize">Th∆∞·ªüng: <strong>${uiComponents.formatNumber(item[keyMap.tongThuong])}</strong></span>
                </div>
            </div>
        `;

        const renderSapCoGiaiItem = (item) => `
            <div class="tdv-item-card">
                <p class="tdv-item-card__title">${item[keyMap.nganhHang]}</p>
                <div class="tdv-progress-bar-container">
                    <div class="tdv-progress-bar tdv-progress-bar--yellow" style="width: ${Math.min(item[keyMap.phanTramDuKien] * 100, 100)}%;"></div>
                    <span class="tdv-progress-bar__text">${uiComponents.formatPercentage(item[keyMap.phanTramDuKien])}</span>
                </div>
                <div class="tdv-item-card__details">
                    <span>C√°ch gi·∫£i: <strong>${item.khoangCach} h·∫°ng</strong></span>
                    <span>H·∫°ng DT/SL: <strong>${item[keyMap.hangVuotTroi]}</strong></span>
                    <span>H·∫°ng %: <strong>${item[keyMap.hangTarget]}</strong></span>
                    <span class="tdv-item-card__prize">Th∆∞·ªüng DK: <strong>${uiComponents.formatNumber(item.thuongTiemNang)}</strong></span>
                </div>
            </div>
        `;

        const renderNeedsEffortRow = (potentialItems, majorItems) => {
            let html = `<div class="tdv-row">
                <h3 class="tdv-row-title tdv-row-title--effort">Nh√≥m c√≤n l·∫°i (${potentialItems.length + majorItems.length})</h3>
                <div class="tdv-row-body tdv-row-body--effort">`;

            if (potentialItems.length > 0) {
                html += `<div class="tdv-effort-subgroup">
                    <h4 class="tdv-effort-subgroup__title tdv-effort-subgroup__title--potential">Ti·ªÅm nƒÉng (c√°ch 21-40 h·∫°ng)</h4>
                    <div class="tdv-effort-list">${potentialItems.map(item => `<div class="tdv-effort-item">${item[keyMap.nganhHang]} (c√°ch ${item.khoangCach})</div>`).join('')}</div>
                </div>`;
            }

            if (majorItems.length > 0) {
                 html += `<div class="tdv-effort-subgroup">
                    <h4 class="tdv-effort-subgroup__title tdv-effort-subgroup__title--major">C·∫ßn c·ªë g·∫Øng nhi·ªÅu</h4>
                    <div class="tdv-effort-list">${majorItems.map(item => `<div class="tdv-effort-item">${item[keyMap.nganhHang]}</div>`).join('')}</div>
                </div>`;
            }

            if (potentialItems.length === 0 && majorItems.length === 0) {
                html += '<p class="text-xs text-gray-500">Kh√¥ng c√≥.</p>';
            }

            html += `</div></div>`;
            return html;
        };

        const totalSoonPrize = sapCoGiai.reduce((sum, item) => sum + (item.thuongTiemNang || 0), 0);
        const soonPrizeTitleText = totalSoonPrize > 0 ? ` - DK: ${uiComponents.formatNumber(totalSoonPrize)}ƒë` : '';

        // *** START: Th√™m logic x√°c ƒë·ªãnh class m√†u cho T·ª∑ l·ªá ƒë·∫°t ***
        const tyLeDatValue = summary[keyMap.tyLeDat] || 0; // L·∫•y gi√° tr·ªã t·ª∑ l·ªá
        const tyLeDatClass = tyLeDatValue >= 0.6 ? 'tdv-tyledat-high' : 'tdv-tyledat-low'; // X√°c ƒë·ªãnh class
        // *** END: Th√™m logic ***

        const html = `
            <div class="tdv-infographic-card">
                <div class="tdv-header">
                    <h2 class="tdv-supermarket-name">${summary[keyMap.sieuThi]}</h2>
                    <div class="tdv-total-prize-container">
                        <span class="tdv-total-prize-label">T·ªïng th∆∞·ªüng t·∫°m t√≠nh:</span>
                        <span class="tdv-total-prize-value">${uiComponents.formatNumber(summary[keyMap.tongThuongTamTinh])}ƒë</span>
                    </div>
                </div>

                <div class="tdv-summary-grid">
                    <div class="tdv-summary-item">
                        <span class="tdv-summary-value">${uiComponents.formatNumber(summary[keyMap.slThiDua])}</span>
                        <span class="tdv-summary-label">Ng√†nh thi ƒëua</span>
                    </div>
                    <div class="tdv-summary-item">
                        <span class="tdv-summary-value">${uiComponents.formatNumber(summary[keyMap.slDat])}</span>
                        <span class="tdv-summary-label">Ng√†nh >100%</span>
                    </div>
                    <div class="tdv-summary-item">
                 
                        <span class="tdv-summary-value ${tyLeDatClass}">${uiComponents.formatPercentage(tyLeDatValue)}</span>
                    
                        <span class="tdv-summary-label">T·ª∑ l·ªá ƒë·∫°t</span>
                    </div>
                     <div class="tdv-summary-item">
                        <span class="tdv-summary-value">${uiComponents.formatNumber(summary[keyMap.slCoGiai])}</span>
                        <span class="tdv-summary-label">Ng√†nh d·ª± ki·∫øn c√≥ gi·∫£i</span>
                    </div>
                    <div class="tdv-summary-item">
                        <span class="tdv-summary-value">${uiComponents.formatNumber(summary[keyMap.hangCoGiaiKenh])}</span>
                        <span class="tdv-summary-label">H·∫°ng c√≥ gi·∫£i (K√™nh)</span>
                    </div>
                </div>

                <div class="tdv-rows-container">
                    <div class="tdv-row">
                        <h3 class="tdv-row-title tdv-row-title--prize">Ng√†nh h√†ng c√≥ gi·∫£i (${coGiai.length})</h3>
                        <div class="tdv-row-body">${coGiai.map(renderCoGiaiItem).join('') || '<p class="text-xs text-gray-500">Kh√¥ng c√≥.</p>'}</div>
                    </div>

                    <div class="tdv-row">
                        <h3 class="tdv-row-title tdv-row-title--soon-prize">S·∫Øp c√≥ gi·∫£i (${sapCoGiai.length})<span class="tdv-row-subtitle">${soonPrizeTitleText}</span></h3>
                        <div class="tdv-row-body">${sapCoGiai.map(renderSapCoGiaiItem).join('') || '<p class="text-xs text-gray-500">Kh√¥ng c√≥.</p>'}</div>
                    </div>

                    ${renderNeedsEffortRow(tiemNang, canCoGangNhieu)}
                </div>
            </div>
        `;

        container.innerHTML = html;
    }
};
--- END FILE: ./ui-thidua-vung.js ---

--- START FILE: ./ui.js ---
// Version 3.13 - Fix circular dependency by removing uiRealtime from facade
// Version 3.12 - Refactor: Import and merge ui-home.js
// Version 3.11 - Refactor: Move admin functions to ui-admin.js, import ui-filters.js
// MODULE: UI FACADE (M·∫∑t ti·ªÅn Giao di·ªán)

import { uiComponents } from './ui-components.js';
import { uiLuyke } from './ui-luyke.js';
import { uiSknv } from './ui-sknv.js';
// import { uiRealtime } from './ui-realtime.js'; // <- ƒê√É X√ìA IMPORT N√ÄY
import { uiThiDuaVung } from './ui-thidua-vung.js';
import { uiCompetition } from './ui-competition.js';
import { uiReports } from './ui-reports.js';
import { uiFilters } from './ui-filters.js'; 
import { uiAdmin } from './ui-admin.js';
import { uiHome } from './ui-home.js'; // <<< TH√äM M·ªöI (T·ª´ B∆∞·ªõc 1 d·ªçn d·∫πp cu·ªëi)

// G·ªôp t·∫•t c·∫£ c√°c h√†m t·ª´ c√°c module con v√†o m·ªôt ƒë·ªëi t∆∞·ª£ng 'ui' duy nh·∫•t.
const ui = {
    ...uiComponents,
    ...uiLuyke, 
    ...uiSknv,
    // ...uiRealtime, // <-- ƒê√É X√ìA D√íNG N√ÄY ƒê·ªÇ PH√Å V·ª† V√íNG L·∫∂P
    ...uiThiDuaVung,
    ...uiCompetition,
    ...uiReports,
    ...uiFilters, 
    ...uiAdmin,  
    ...uiHome, // <<< TH√äM M·ªöI
};

// Xu·∫•t kh·∫©u ƒë·ªëi t∆∞·ª£ng 'ui' ƒë√£ ƒë∆∞·ª£c h·ª£p nh·∫•t.
export { ui };
--- END FILE: ./ui.js ---

--- START FILE: ./utils.js ---
// Version 3.3 - Make department sorting more robust
// MODULE: UTILITIES
// Ch·ª©a c√°c h√†m ti·ªán √≠ch chung kh√¥ng thu·ªôc v·ªÅ logic hay giao di·ªán c·ª• th·ªÉ.
import { ui } from './ui.js';

export const utils = {
    getRandomBrightColor() {
        const colors = [
            '#ef4444', // red-500
            '#f97316', // orange-500
            '#eab308', // yellow-500
            '#84cc16', // lime-500
            '#22c55e', // green-500
            '#10b981', // emerald-500
            '#14b8a6', // teal-500
            '#06b6d4', // cyan-500
            '#3b82f6', // blue-500
            '#8b5cf6', // violet-500
            '#d946ef', // fuchsia-500
            '#ec4899', // pink-500
        ];
        return colors[Math.floor(Math.random() * colors.length)];
    },

    cleanCategoryName(name) {
        if (!name || typeof name !== 'string') return '';
        // B·ªè m√£ s·ªë, kho·∫£ng tr·∫Øng th·ª´a, v√† vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu m·ªói t·ª´.
        return name
            .replace(/^\d+\s*-\s*/, '')
            .trim()
            .replace(/\s+/g, ' ')
            .toLowerCase()
            .split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    },

    exportTableToExcel(activeTabContent, fileName) {
        if (!activeTabContent) {
            ui.showNotification('Kh√¥ng t√¨m th·∫•y tab ƒëang ho·∫°t ƒë·ªông ƒë·ªÉ xu·∫•t.', 'error');
            return;
        }
        let table = activeTabContent.querySelector('.department-block table, #sknv-summary-container table, #luyke-competition-content table, table');
        if (!table) {
            ui.showNotification('Kh√¥ng t√¨m th·∫•y b·∫£ng d·ªØ li·ªáu trong tab n√†y ƒë·ªÉ xu·∫•t.', 'error');
            return;
        }
        try {
            const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
            XLSX.writeFile(wb, `${fileName}.xlsx`);
            ui.showNotification(`ƒê√£ xu·∫•t file ${fileName}.xlsx th√†nh c√¥ng!`, 'success');
        } catch (e) {
            console.error('L·ªói xu·∫•t Excel:', e);
            ui.showNotification('C√≥ l·ªói x·∫£y ra khi xu·∫•t file Excel.', 'error');
        }
    },

    // <<< START: UPDATED FUNCTION >>>
    getSortedDepartmentList(reportData) {
        const allDepts = [...new Set(reportData.map(item => item.boPhan).filter(Boolean))];

        allDepts.sort((a, b) => {
            const aIsPriority = a.includes('T∆∞ V·∫•n - ƒêM');
            const bIsPriority = b.includes('T∆∞ V·∫•n - ƒêM');

            if (aIsPriority && !bIsPriority) {
                return -1; // a comes first
            }
            if (!aIsPriority && bIsPriority) {
                return 1; // b comes first
            }
            // If both are priority or both are not, sort alphabetically
            return a.localeCompare(b);
        });

        return allDepts;
    },
    // <<< END: UPDATED FUNCTION >>>
};
--- END FILE: ./utils.js ---

